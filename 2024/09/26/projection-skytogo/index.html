<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="zoe">


    <meta name="subtitle" content="liberté">




<title>SkyToGo | ZOE&#39;s site</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    
    <script src="/js/jquery-3.7.0.min.js"></script>
    
    <script src="/js/mathjax2.7.5.js"></script>
    



    
    
        
    


<!-- 搜索的部分 -->



    <script>
    // function searchToggle() {
    //     const width = $(document.body).width()
    //     if(width > 479) {
    //         return;
    //     }
    //     const search = $('.search');
    //     const searchForm = $('.form-search')

    //     if(!search.hasClass("mobile-search")) {
    //         search.addClass("mobile-search");
    //     } else {
    //         search.removeClass("mobile-search");
    //     } 
    // }

    function searchToggle() {
        const width = $(document.body).width()
        if(width > 479) {
            return;
        }
        const search = $('.search');
        const searchForm = $('.form-search');
        const menuToggle = $('.menu-toggle');
        const title = $('.navbar-header-title ');

        if(!search.hasClass("mobile-search")) {
            search.addClass("mobile-search");
            menuToggle.addClass("open-search")
            title.addClass("mobile-title-hidden")
        } else {
            search.removeClass("mobile-search");
            menuToggle.removeClass("open-search")
            // title.css({visibility: 'visible'})
            title.removeClass("mobile-title-hidden")
        } 
    }



    function search(searchInputEl, formEl, flag) {
        const path = "/" + "search.json"; // 可以在public 下查看这个search.json
        $(formEl).submit(function(e){
            e.preventDefault();
            let target = null
            if(searchInputEl == null) {
                const screenWidth = $(document.body).width();
                target = screenWidth > 479 ? $('#pc-search-input') : $('#mobile-search-input');
                console.log(target);
            } else {
                target = $(searchInputEl)
            }

            if(!flag && target.val() === '') {
                return ;
            }

            $("#u-search").fadeIn(500, function() {
                $("body > .wrapper").addClass("modal-active");

                $.ajax({
                    url: path,
                    dataType: "json",
                    beforeSend: function (xhr) {
                        $input = target.val();
                        $(".form-input").val($input);
                        const loadingBar = $('.search-loading-bar') 
                        loadingBar.css({
                            width:'100%',
                            display: 'block'
                        });
                    },
                    success: function( datas ) {
                        console.log(datas);
                        const $resultPanel = $(".modal-body")[0];
                        let str = `<ul class="modal-results">`;
                        var keywords = $(".form-input").val().trim().toLowerCase().split(/[\s\-]+/);
                        $resultPanel.innerHTML = "";
                        let hasResult = false
                        let text = `<div class="no-result">找不到与关键词相关的内容....</div>`;

                        if ($(".form-input").val().trim().length <= 0) {
                            // 没有结果
                            $resultPanel.innerHTML = text;
                            return;
                        }
                        datas.forEach(function (data, index) {
                            var isMatch = true;
                            if (!data.title || data.title.trim() === '') {
                                data.title = "Untitled";
                            }
                            var data_title = data.title.trim().toLowerCase();
                            var data_content = data.content && data.content.trim().replace(/<[^>]+>/g, "").toLowerCase() || '';
                            var data_url = data.url;
                            var index_title = -1;
                            var index_content = -1;
                            var first_occur = -1;
                            // only match artiles with not empty contents
                            if (data_content !== '') {
                                keywords.forEach(function (keyword, i) {
                                    index_title = data_title.indexOf(keyword);
                                    index_content = data_content.indexOf(keyword);

                                    if (index_title < 0 && index_content < 0) {
                                        isMatch = false;
                                    } else {
                                        hasResult = true
                                        if (index_content < 0) {
                                            index_content = 0;
                                        }
                                        if (i == 0) {
                                            first_occur = index_content;
                                        }
                                    }
                                });
                            } else {
                                isMatch = false;
                            }
                            // show search results
                            if (isMatch) {
                                str += `<li class='result-item'><a href='${data_url}' class='result-item-detail'> <span class="title">${data_title}</span>`;
                                var content = data.content.trim().replace(/<[^>]+>/g, "");
                                if (first_occur >= 0) {
                                    // cut out 200 characters
                                    var start = first_occur - 40;
                                    var end = first_occur + 160;

                                    if (start < 0) {
                                        start = 0;
                                    }

                                    if (start == 0) {
                                        end = 200;
                                    }

                                    if (end > content.length) {
                                        end = content.length;
                                    }

                                    var match_content = content.substring(start, end);

                                    // highlight all keywords
                                    keywords.forEach(function (keyword) {
                                        var regS = new RegExp(keyword, "gi");
                                        match_content = match_content.replace(regS, `<em class="search-keyword">${keyword}</em>`);
                                    });

                                    str += `<span class="content"> ${match_content} ...</span></a>`;
                                }
                                str += "</li>";
                            }
                        });
                        str += "</ul>";
                        if(hasResult) {
                            $resultPanel.innerHTML = str;
                        } else {
                            $resultPanel.innerHTML = text;
                        }

                    },
                    complete: function() {
                        setTimeout(() => {
                                const loadingBar = $('.search-loading-bar') 
                                loadingBar.css({
                                    width:'0%',
                                    display: 'none'
                                });
                        }, 300)
                    }
                });
            })

        });
    }

    $(document).ready(function() {
        $('.modal-close').click(function () { 
            $("#u-search").fadeOut();
            $("body > .wrapper").removeClass("modal-active")
        })

        $('.modal-overlay').click(function() {
            $("#u-search").fadeOut();
            $("body > .wrapper").removeClass("modal-active")
        })
        search(null, ".form-search", false)
        search("#u-search-modal-form .form-input", ".u-search-modal-form", true)
    })
</script>

<meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                // pagebody.classList.add('dark-theme');
                // mobile
                // document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <!-- <div class="navbar-header header-logo"><a href="/">ZOE&#39;s site</a></div> -->
            <div class="navbar-header header-logo"><a href="/"><i class="iconfont icon-zhuye" style="font-size: 1em;"></i>ZOE&#39;s site</a></div>
            <div class="menu navbar-right">
                <!-- 这里表示的是pc端搜索框 -->
                
                
    <div class="search ">
        <!-- <div class="search-btn" onClick="searchToggle()">
            <img src="/image/search.png" class="search-btn-img" />
        </div> -->
        <form class="form-search">
            <input class="input" placeholder="search" autocomplete="on" id="pc-search-input"/>
        </form>
    </div>

                
                <a class="menu-item" target="_blank" rel="noopener" href="https://github.com/ZoeBezos">Github</a>
                
                <a class="menu-item" target="_blank" rel="noopener" href="https://www.linkedin.com/in/zoe-bezos/">Linkedin</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <!-- <label for="switch_default" class="toggleBtn"></label> -->
            </div>
        </div>
    </nav>
    
    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">ZOE&#39;s site</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="navbar-mobile-right">
                    
                    
    <div class="search ">
        <!-- <div class="search-btn" onClick="searchToggle()">
            <img src="/image/search.png" class="search-btn-img" />
        </div> -->
        <form class="form-search">
            <input class="input" placeholder="search" autocomplete="on" id="mobile-search-input"/>
        </form>
    </div>

                    <!-- <div class="menu-toggle" onclick="mobileBtn()">&#9776; menu</div> -->
                </div>
    
            </div>
            <div class="menu" id="mobile-menu">
                
                <a class="menu-item" target="_blank" rel="noopener" href="https://github.com/ZoeBezos">Github</a>
                
                <a class="menu-item" target="_blank" rel="noopener" href="https://www.linkedin.com/in/zoe-bezos/">Linkedin</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>

    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">SkyToGo</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">zoe</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">September 26, 2024&nbsp;&nbsp;0:08:21</a>
                        </span>
                    
                    

                        <span class="post-category">                        
                            Category:                        
                                                    
                            <a href="/categories/projection/">projection</a>
                            
                        </span>

                    

                    
                        
                        <span class="post-count">                        
                            Words:                        
                            <a href="">62.6k</a>                         
                        </span>
                        
                    
                                                                        
                    
                        
                        <span class="post-count">                        
                            Time:                        
                            <a href="">273min</a>                         
                        </span>
                        
                    
                        
                </div>
            
        </header>

        <div class="post-content">
            <blockquote>
<p> 项目GitHub地址：<a target="_blank" rel="noopener" href="https://github.com/ZoeBezos/sky-take-out">ZoeBezos/sky-take-out (github.com)</a></p>
</blockquote>
<h1><span id="cang-qiong-wai-mai-day01">苍穹外卖-day01</span></h1><h2><span id="ke-cheng-nei-rong">课程内容</span></h2><ul>
<li>软件开发整体介绍</li>
<li>苍穹外卖项目介绍</li>
<li>开发环境搭建</li>
<li>导入接口文档</li>
<li>Swagger</li>
</ul>
<p><strong>项目整体效果展示：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221106160753928.png" alt="image-20221106160753928" style="zoom:67%;">

<p>​																		        管理端-外卖商家使用</p>
<img src="/2024/09/26/projection-skytogo/image-20221106160905554.png" alt="image-20221106160905554" style="zoom:67%;">

<p>​																			    用户端-点餐用户使用</p>
<p>当我们完成该项目的学习，可以培养以下能力：</p>
<img src="/2024/09/26/projection-skytogo/image-20221106161507973.png" alt="image-20221106161507973" style="zoom:67%;">

<h2><span id="1-ruan-jian-kai-fa-zheng-ti-jie-shao">1. 软件开发整体介绍</span></h2><p>作为一名软件开发工程师,我们需要了解在软件开发过程中的开发流程， 以及软件开发过程中涉及到的岗位角色，角色的分工、职责， 并了解软件开发中涉及到的三种软件环境。那么这一小节，我们将从 软件开发流程、角色分工、软件环境 三个方面整体介绍一下软件开发。</p>
<h3><span id="1-1-ruan-jian-kai-fa-liu-cheng">1.1 软件开发流程</span></h3><img src="/2024/09/26/projection-skytogo/image-20221106162815172.png" alt="image-20221106162815172" style="zoom:80%;">



<p><strong>1). 第1阶段: 需求分析</strong></p>
<p>完成需求规格说明书、产品原型编写。  </p>
<p>需求规格说明书， 一般来说就是使用 Word 文档来描述当前项目的各个组成部分，如：系统定义、应用环境、功能规格、性能需求等，都会在文档中描述。<strong>例如：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221106163758703.png" alt="image-20221106163758703" style="zoom: 50%;">

<p>产品原型，一般是通过网页(html)的形式展示当前的页面展示什么样的数据, 页面的布局是什么样子的，点击某个菜单，打开什么页面，点击某个按钮，出现什么效果，都可以通过产品原型看到。 <strong>例如：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221106163925031.png" alt="image-20221106163925031" style="zoom:50%;">





<p><strong>2). 第2阶段: 设计</strong></p>
<p>设计的内容包含 UI设计、数据库设计、接口设计。</p>
<p>UI设计：用户界面的设计，主要设计项目的页面效果，小到一个按钮，大到一个页面布局，还有人机交互逻辑的体现。<strong>例如：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221106165303946.png" alt="image-20221106165303946" style="zoom:50%;">

<p>数据库设计：需要设计当前项目中涉及到哪些数据库，每一个数据库里面包含哪些表，这些表结构之间的关系是什么样的，表结构中包含哪些字段。<strong>例如：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221106165554917.png" alt="image-20221106165554917" style="zoom:50%;">

<p>接口设计：通过分析原型图，首先，粗粒度地分析每个页面有多少接口，然后，再细粒度地分析每个接口的传入参数，返回值参数，同时明确接口路径及请求方式。<strong>例如：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221106171538880.png" alt="image-20221106171538880" style="zoom:50%;">



<p><strong>3). 第3阶段: 编码</strong></p>
<p>编写项目代码、并完成单元测试。</p>
<p>项目代码编写：作为软件开发工程师，我们需要对项目的模块功能分析后，进行编码实现。</p>
<p>单元测试：编码实现完毕后，进行单元测试，单元测试通过后再进入到下一阶段。<strong>例如：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221106175351594.png" alt="image-20221106175351594" style="zoom:50%;">





<p><strong>4). 第4阶段: 测试</strong></p>
<p>在该阶段中主要由测试人员, 对部署在测试环境的项目进行功能测试, 并出具测试报告。</p>
<p><strong>5). 第5阶段: 上线运维</strong></p>
<p>在项目上线之前， 会由运维人员准备服务器上的软件环境安装、配置， 配置完毕后， 再将我们开发好的项目，部署在服务器上运行。</p>
<h3><span id="1-2-jiao-se-fen-gong">1.2 角色分工</span></h3><p>在对整个软件开发流程熟悉后， 我们还有必要了解一下在整个软件开发流程中涉及到的岗位角色，以及各个角色的职责分工。</p>
<p><img src="/2024/09/26/projection-skytogo/image-20210725234015404.png" alt="image-20210725234015404"></p>
<table>
<thead>
<tr>
<th align="left">岗位/角色</th>
<th>对应阶段</th>
<th align="left">职责/分工</th>
</tr>
</thead>
<tbody><tr>
<td align="left">项目经理</td>
<td>全阶段</td>
<td align="left">对整个项目负责，任务分配、把控进度</td>
</tr>
<tr>
<td align="left">产品经理</td>
<td>需求分析</td>
<td align="left">进行需求调研，输出需求调研文档、产品原型等</td>
</tr>
<tr>
<td align="left">UI设计师</td>
<td>设计</td>
<td align="left">根据产品原型输出界面效果图</td>
</tr>
<tr>
<td align="left">架构师</td>
<td>设计</td>
<td align="left">项目整体架构设计、技术选型等</td>
</tr>
<tr>
<td align="left"><font color="red">开发工程师</font></td>
<td><font color="red">编码</font></td>
<td align="left"><font color="red">功能代码实现</font></td>
</tr>
<tr>
<td align="left">测试工程师</td>
<td>测试</td>
<td align="left">编写测试用例，输出测试报告</td>
</tr>
<tr>
<td align="left">运维工程师</td>
<td>上线运维</td>
<td align="left">软件环境搭建、项目上线</td>
</tr>
</tbody></table>
<p>上述我们讲解的角色分工, 是在一个项目组中比较标准的角色分工, 但是在实际的项目中, 有一些项目组由于人员配置紧张, 可能并没有专门的架构师或测试人员, 这个时候可能需要有项目经理或者程序员兼任。</p>
<h3><span id="1-3-ruan-jian-huan-jing">1.3 软件环境</span></h3><p>作为软件开发工程师，在编码的过程中就不可避免地会接触多种软件环境，我们主要来分析在工作中经常遇到的三套环境， 分别是: 开发环境、测试环境、生产环境。 接下来，我们分别介绍一下这三套环境的作用和特点。</p>
<p><strong>1). 开发环境(development)</strong></p>
<p>我们作为软件开发人员，在开发阶段使用的环境，就是开发环境，一般外部用户无法访问。</p>
<p>比如，我们在开发中使用的MySQL数据库和其他的一些常用软件，我们可以安装在本地， 也可以安装在一台专门的服务器中， 这些应用软件仅仅在软件开发过程中使用， 项目测试、上线时，我们不会使用这套环境了，这个环境就是开发环境。</p>
<p><strong>2). 测试环境(testing)</strong></p>
<p>当软件开发工程师，将项目的功能模块开发完毕，并且单元测试通过后，就需要将项目部署到测试服务器上，让测试人员对项目进行测试。那这台测试服务器就是专门给测试人员使用的环境， 也就是测试环境，用于项目测试，一般外部用户无法访问。</p>
<p><strong>3). 生产环境(production)</strong></p>
<p>当项目开发完毕，并且由测试人员测试通过之后，就可以上线项目，将项目部署到线上环境，并正式对外提供服务，这个线上环境也称之为生产环境。</p>
<p>​			        <strong>开发环境</strong>                                                         <strong>测试环境</strong>                                                <strong>生产环境</strong></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221106182912829.png" alt="image-20221106182912829"></p>
<p>首先，会在开发环境中进行项目开发，往往开发环境大多数都是本地的电脑环境和局域网内的环境，当开发完毕后，然后会把项目部署到测试环境，测试环境一般是一台独立测试服务器的环境，项目测试通过后，最终把项目部署到生产环境，生产环境可以是机房或者云服务器等线上环境。</p>
<h2><span id="2-cang-qiong-wai-mai-xiang-mu-jie-shao">2. 苍穹外卖项目介绍</span></h2><p>在开发苍穹外卖这个项目之前，我们需要全方位的来介绍一下当前我们学习的这个项目。接下来，我们将从项目简介、产品原型、技术选型三个方面来介绍苍穹外卖这个项目。</p>
<h3><span id="2-1-xiang-mu-jie-shao">2.1 项目介绍</span></h3><p>本项目（苍穹外卖）是专门为餐饮企业（餐厅、饭店）定制的一款软件产品，包括 系统管理后台 和 小程序端应用 两部分。其中系统管理后台主要提供给餐饮企业内部员工使用，可以对餐厅的分类、菜品、套餐、订单、员工等进行管理维护，对餐厅的各类数据进行统计，同时也可进行来单语音播报功能。小程序端主要提供给消费者使用，可以在线浏览菜品、添加购物车、下单、支付、催单等。</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221106185252326.png" alt="image-20221106185252326"></p>
<p>接下来，通过功能架构图来展示<strong>管理端</strong>和<strong>用户端</strong>的具体业务功能模块。</p>
<img src="/2024/09/26/projection-skytogo/image-20221106194424735.png" alt="image-20221106194424735" style="zoom: 67%;">

<p><strong>1). 管理端功能</strong></p>
<p>员工登录/退出 , 员工信息管理 , 分类管理 , 菜品管理 , 套餐管理 , 菜品口味管理 , 订单管理 ，数据统计，来单提醒。</p>
<p><strong>2). 用户端功能</strong></p>
<p> 微信登录 , 收件人地址管理 , 用户历史订单查询 , 菜品规格查询 , 购物车功能 , 下单 , 支付、分类及菜品浏览。</p>
<h3><span id="2-2-chan-pin-yuan-xing">2.2 产品原型</span></h3><p><strong>产品原型</strong>，用于展示项目的业务功能，一般由产品经理进行设计。</p>
<blockquote>
<p><strong><font color="red">注意事项：</font></strong> 产品原型主要用于展示项目的功能，并不是最终的页面效果。</p>
</blockquote>
<p>在课程资料的产品原型文件夹下,提供了两份产品原型。</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221106195023552.png" alt="image-20221106195023552"> </p>
<p><strong>管理端原型图：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221106195259858.png" alt="image-20221106195259858" style="zoom:50%;">

<p><strong>用户端原型图：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221106195354556.png" alt="image-20221106195354556" style="zoom:50%;">

<p><strong>1). 管理端</strong></p>
<p>餐饮企业内部员工使用。 主要功能有: </p>
<table>
<thead>
<tr>
<th>模块</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>登录/退出</td>
<td>内部员工必须登录后,才可以访问系统管理后台</td>
</tr>
<tr>
<td>员工管理</td>
<td>管理员可以在系统后台对员工信息进行管理，包含查询、新增、编辑、禁用等功能</td>
</tr>
<tr>
<td>分类管理</td>
<td>主要对当前餐厅经营的 菜品分类 或 套餐分类 进行管理维护， 包含查询、新增、修改、删除等功能</td>
</tr>
<tr>
<td>菜品管理</td>
<td>主要维护各个分类下的菜品信息，包含查询、新增、修改、删除、启售、停售等功能</td>
</tr>
<tr>
<td>套餐管理</td>
<td>主要维护当前餐厅中的套餐信息，包含查询、新增、修改、删除、启售、停售等功能</td>
</tr>
<tr>
<td>订单管理</td>
<td>主要维护用户在移动端下的订单信息，包含查询、取消、派送、完成，以及订单报表下载等功能</td>
</tr>
<tr>
<td>数据统计</td>
<td>主要完成对餐厅的各类数据统计，如营业额、用户数量、订单等</td>
</tr>
</tbody></table>
<p><strong>2). 用户端</strong></p>
<p>移动端应用主要提供给消费者使用。主要功能有:</p>
<table>
<thead>
<tr>
<th>模块</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>登录/退出</td>
<td>用户需要通过微信授权后登录使用小程序进行点餐</td>
</tr>
<tr>
<td>点餐-菜单</td>
<td>在点餐界面需要展示出菜品分类/套餐分类, 并根据当前选择的分类加载其中的菜品信息, 供用户查询选择</td>
</tr>
<tr>
<td>点餐-购物车</td>
<td>用户选中的菜品就会加入用户的购物车, 主要包含 查询购物车、加入购物车、删除购物车、清空购物车等功能</td>
</tr>
<tr>
<td>订单支付</td>
<td>用户选完菜品/套餐后, 可以对购物车菜品进行结算支付, 这时就需要进行订单的支付</td>
</tr>
<tr>
<td>个人信息</td>
<td>在个人中心页面中会展示当前用户的基本信息, 用户可以管理收货地址, 也可以查询历史订单数据</td>
</tr>
</tbody></table>
<h3><span id="2-3-ji-zhu-xuan-xing">2.3 技术选型</span></h3><p>关于本项目的技术选型, 我们将会从 用户层、网关层、应用层、数据层 这几个方面进行介绍，主要用于展示项目中使用到的技术框架和中间件等。</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221106185646994.png" alt="image-20221106185646994"></p>
<p><strong>1). 用户层</strong></p>
<p>本项目中在构建系统管理后台的前端页面，我们会用到H5、Vue.js、ElementUI、apache echarts(展示图表)等技术。而在构建移动端应用时，我们会使用到微信小程序。</p>
<p><strong>2). 网关层</strong></p>
<p>Nginx是一个服务器，主要用来作为Http服务器，部署静态资源，访问性能高。在Nginx中还有两个比较重要的作用： 反向代理和负载均衡， 在进行项目部署时，要实现Tomcat的负载均衡，就可以通过Nginx来实现。</p>
<p><strong>3). 应用层</strong></p>
<p>SpringBoot： 快速构建Spring项目, 采用 “约定优于配置” 的思想, 简化Spring项目的配置开发。</p>
<p>SpringMVC：SpringMVC是spring框架的一个模块，springmvc和spring无需通过中间整合层进行整合，可以无缝集成。</p>
<p>Spring Task:  由Spring提供的定时任务框架。</p>
<p>httpclient:  主要实现了对http请求的发送。</p>
<p>Spring Cache:  由Spring提供的数据缓存框架</p>
<p>JWT:  用于对应用程序上的用户进行身份验证的标记。</p>
<p>阿里云OSS:  对象存储服务，在项目中主要存储文件，如图片等。</p>
<p>Swagger： 可以自动的帮助开发人员生成接口文档，并对接口进行测试。</p>
<p>POI:  封装了对Excel表格的常用操作。</p>
<p>WebSocket: 一种通信网络协议，使客户端和服务器之间的数据交换更加简单，用于项目的来单、催单功能实现。</p>
<p><strong>4). 数据层</strong></p>
<p>MySQL： 关系型数据库, 本项目的核心业务数据都会采用MySQL进行存储。</p>
<p>Redis： 基于key-value格式存储的内存数据库, 访问速度快, 经常使用它做缓存。</p>
<p>Mybatis： 本项目持久层将会使用Mybatis开发。</p>
<p>pagehelper:  分页插件。</p>
<p>spring data redis:  简化java代码操作Redis的API。</p>
<p><strong>5). 工具</strong></p>
<p>git: 版本控制工具, 在团队协作中, 使用该工具对项目中的代码进行管理。</p>
<p>maven: 项目构建工具。</p>
<p>junit：单元测试工具，开发人员功能实现完毕后，需要通过junit对功能进行单元测试。</p>
<p>postman:  接口测工具，模拟用户发起的各类HTTP请求，获取对应的响应结果。</p>
<h2><span id="3-kai-fa-huan-jing-da-jian">3. 开发环境搭建</span></h2><img src="/2024/09/26/projection-skytogo/image-20221106200821282.png" alt="image-20221106200821282" style="zoom: 67%;">

<p>开发环境搭建主要包含<strong>前端环境</strong>和<strong>后端环境</strong>两部分。作为服务端开发工程师， 我们课程学习的重心应该放在后端的业务代码上， 前端的页面我们只需要导入资料中的nginx， 前端页面的代码我们只需要能看懂即可。</p>
<h3><span id="3-1-qian-duan-huan-jing-da-jian">3.1 前端环境搭建</span></h3><p><strong>1). 前端工程基于 nginx</strong> </p>
<p>从资料中找到前端运行环境的nginx，移动到<strong>非中文目录</strong>下。</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221106202239828.png" alt="image-20221106202239828"></p>
<p><strong>sky</strong>目录中存放了管理端的前端资源，具体如下：</p>
<img src="/2024/09/26/projection-skytogo/image-20221106202517738.png" alt="image-20221106202517738" style="zoom:50%;">

<p><strong>2). 启动nginx，访问测试</strong> </p>
<p>双击 nginx.exe 即可启动 nginx 服务，访问端口号为 80</p>
<p><a target="_blank" rel="noopener" href="http://localhost/">http://localhost:80</a></p>
<img src="/2024/09/26/projection-skytogo/image-20221106202720190.png" alt="image-20221106202720190" style="zoom:50%;">

<h3><span id="3-2-hou-duan-huan-jing-da-jian">3.2 后端环境搭建</span></h3><h4><span id="3-2-1-shou-xi-xiang-mu-jie-gou">3.2.1 熟悉项目结构</span></h4><p>后端工程基于 maven 进行项目构建，并且进行分模块开发。</p>
<p><strong>1). 从当天资料中找到后端初始工程：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221107092342140.png" alt="image-20221107092342140" style="zoom:67%;">

<p><strong>2). 用 IDEA 打开初始工程，了解项目的整体结构：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221107092540194.png" alt="image-20221107092540194" style="zoom: 50%;">

<p>对工程的每个模块作用说明：</p>
<table>
<thead>
<tr>
<th><strong>序号</strong></th>
<th><strong>名称</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>sky-take-out</td>
<td>maven父工程，统一管理依赖版本，聚合其他子模块</td>
</tr>
<tr>
<td>2</td>
<td>sky-common</td>
<td>子模块，存放公共类，例如：工具类、常量类、异常类等</td>
</tr>
<tr>
<td>3</td>
<td>sky-pojo</td>
<td>子模块，存放实体类、VO、DTO等</td>
</tr>
<tr>
<td>4</td>
<td>sky-server</td>
<td>子模块，后端服务，存放配置文件、Controller、Service、Mapper等</td>
</tr>
</tbody></table>
<p>对项目整体结构了解后，接下来我们详细分析上述的每个子模块：</p>
<ul>
<li><p><strong>sky-common:</strong> 模块中存放的是一些公共类，可以供其他模块使用</p>
 <img src="/2024/09/26/projection-skytogo/image-20221107093606590.png" alt="image-20221107093606590" style="zoom: 50%;">

 

<p> 分析sky-common模块的每个包的作用：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>constant</td>
<td>存放相关常量类</td>
</tr>
<tr>
<td>context</td>
<td>存放上下文类</td>
</tr>
<tr>
<td>enumeration</td>
<td>项目的枚举类存储</td>
</tr>
<tr>
<td>exception</td>
<td>存放自定义异常类</td>
</tr>
<tr>
<td>json</td>
<td>处理json转换的类</td>
</tr>
<tr>
<td>properties</td>
<td>存放SpringBoot相关的配置属性类</td>
</tr>
<tr>
<td>result</td>
<td>返回结果类的封装</td>
</tr>
<tr>
<td>utils</td>
<td>常用工具类</td>
</tr>
</tbody></table>
</li>
<li><p><strong>sky-pojo:</strong> 模块中存放的是一些 entity、DTO、VO</p>
 <img src="/2024/09/26/projection-skytogo/image-20221107094611987.png" alt="image-20221107094611987" style="zoom: 50%;">

<p> 分析sky-pojo模块的每个包的作用：</p>
<table>
<thead>
<tr>
<th><strong>名称</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Entity</td>
<td>实体，通常和数据库中的表对应</td>
</tr>
<tr>
<td>DTO</td>
<td>数据传输对象，通常用于程序中各层之间传递数据</td>
</tr>
<tr>
<td>VO</td>
<td>视图对象，为前端展示数据提供的对象</td>
</tr>
<tr>
<td>POJO</td>
<td>普通Java对象，只有属性和对应的getter和setter</td>
</tr>
</tbody></table>
</li>
<li><p><strong>sky-server:</strong> 模块中存放的是 配置文件、配置类、拦截器、controller、service、mapper、启动类等</p>
 <img src="/2024/09/26/projection-skytogo/image-20221107094852361.png" alt="image-20221107094852361" style="zoom:50%;">

<p> 分析sky-server模块的每个包的作用：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>config</td>
<td>存放配置类</td>
</tr>
<tr>
<td>controller</td>
<td>存放controller类</td>
</tr>
<tr>
<td>interceptor</td>
<td>存放拦截器类</td>
</tr>
<tr>
<td>mapper</td>
<td>存放mapper接口</td>
</tr>
<tr>
<td>service</td>
<td>存放service类</td>
</tr>
<tr>
<td>SkyApplication</td>
<td>启动类</td>
</tr>
</tbody></table>
</li>
</ul>
<h4><span id="3-2-2-git-ban-ben-kong-zhi">3.2.2 Git版本控制</span></h4><p>使用Git进行项目代码的版本控制，具体操作：</p>
<p><strong>1). 创建Git本地仓库</strong></p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221107164030050.png" alt="image-20221107164030050" style="zoom:50%;"><img src="/2024/09/26/projection-skytogo/image-20221107135640100.png" alt="image-20221107135640100" style="zoom:50%;"></p>
<p>当Idea中出现：</p>
<img src="/2024/09/26/projection-skytogo/image-20221107135819662.png" alt="image-20221107135819662" style="zoom:67%;">

<p>说明本地仓库创建成功。</p>
<p><strong>2). 创建Git远程仓库</strong></p>
<p>访问<a target="_blank" rel="noopener" href="https://gitee.com/%EF%BC%8C%E6%96%B0%E5%BB%BA%E4%BB%93%E5%BA%93">https://gitee.com/，新建仓库</a></p>
<img src="/2024/09/26/projection-skytogo/image-20221107140517031.png" alt="image-20221107140517031" style="zoom:50%;">

<p>点击 创建 </p>
<img src="/2024/09/26/projection-skytogo/image-20221107140834161.png" alt="image-20221107140834161" style="zoom:50%;">



<p><strong>3). 将本地文件推送到Git远程仓库</strong></p>
<ol>
<li><p><strong>提交文件至本地仓库</strong></p>
<p>忽略以下类型文件</p>
<img src="/2024/09/26/projection-skytogo/image-20221107164324396.png" alt="image-20221107164324396" style="zoom:50%;">

<p>开始提交</p>
<img src="/2024/09/26/projection-skytogo/image-20221107164654572.png" alt="image-20221107164654572" style="zoom:50%;">

<p>中间出现：点击commit</p>
<img src="/2024/09/26/projection-skytogo/image-20221107164813643.png" alt="image-20221107164813643" style="zoom:50%;">
</li>
<li><p><strong>添加Git远程仓库地址</strong></p>
<p>复制远程地址：</p>
<img src="/2024/09/26/projection-skytogo/image-20221107141339343.png" alt="image-20221107141339343" style="zoom:50%;">

<p>添加地址：</p>
<img src="/2024/09/26/projection-skytogo/image-20221107141634614.png" alt="image-20221107141634614" style="zoom:50%;">

<img src="/2024/09/26/projection-skytogo/image-20221107141813693.png" alt="image-20221107141813693" style="zoom:50%;">
</li>
<li><p><strong>推送</strong></p>
</li>
</ol>
<img src="/2024/09/26/projection-skytogo/image-20221107141934132.png" alt="image-20221107141934132" style="zoom:50%;">

<p>成功推送至远程仓库</p>
<img src="/2024/09/26/projection-skytogo/image-20221107165149915.png" alt="image-20221107165149915" style="zoom:50%;">



<h4><span id="3-2-3-shu-ju-ku-huan-jing-da-jian">3.2.3 数据库环境搭建</span></h4><ol>
<li><strong>从资料中找到sky.sql</strong></li>
</ol>
<img src="/2024/09/26/projection-skytogo/image-20221107101030138.png" alt="image-20221107101030138" style="zoom: 67%;">

<p>直接打开sky.sql文件</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221107101238205.png" alt="image-20221107101238205"></p>
<p>通过该sql文件直接可创建数据库，所以不需要提前创建数据库，直接导入该文件执行即可。</p>
<ol start="2">
<li><strong>执行sky.sql文件</strong></li>
</ol>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221107102152285.png" alt="image-20221107102152285" style="zoom:50%;"><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221107102416034.png" alt="image-20221107102416034" style="zoom:50%;"><img src="/2024/09/26/projection-skytogo/image-20221107104738200.png" alt="image-20221107104738200" style="zoom:50%;"></p>
<p>执行完成后，共创建出11张表</p>
<img src="/2024/09/26/projection-skytogo/image-20221107105103816.png" alt="image-20221107105103816" style="zoom: 80%;">

<p>每张表的说明：</p>
<table>
<thead>
<tr>
<th><strong>序号</strong></th>
<th><strong>表名</strong></th>
<th><strong>中文名</strong></th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>employee</td>
<td>员工表</td>
</tr>
<tr>
<td>2</td>
<td>category</td>
<td>分类表</td>
</tr>
<tr>
<td>3</td>
<td>dish</td>
<td>菜品表</td>
</tr>
<tr>
<td>4</td>
<td>dish_flavor</td>
<td>菜品口味表</td>
</tr>
<tr>
<td>5</td>
<td>setmeal</td>
<td>套餐表</td>
</tr>
<tr>
<td>6</td>
<td>setmeal_dish</td>
<td>套餐菜品关系表</td>
</tr>
<tr>
<td>7</td>
<td>user</td>
<td>用户表</td>
</tr>
<tr>
<td>8</td>
<td>address_book</td>
<td>地址表</td>
</tr>
<tr>
<td>9</td>
<td>shopping_cart</td>
<td>购物车表</td>
</tr>
<tr>
<td>10</td>
<td>orders</td>
<td>订单表</td>
</tr>
<tr>
<td>11</td>
<td>order_detail</td>
<td>订单明细表</td>
</tr>
</tbody></table>
<p>我们目前先简单了解大概有哪些表, 每张表存储什么数据, 有一个印象。对于具体的表结构, 以及表结构中的字段, 可以参考资料中的<strong>《数据库设计文档》</strong>，同时在讲解具体的功能开发时, 我们也会再详细介绍。</p>
<img src="/2024/09/26/projection-skytogo/image-20221107142344642.png" alt="image-20221107142344642" style="zoom:67%;">



<h4><span id="3-2-4-qian-hou-duan-lian-diao">3.2.4 前后端联调</span></h4><p>后端的初始工程中已经实现了<strong>登录</strong>功能，直接进行前后端联调测试即可</p>
<p>实现思路：</p>
<img src="/2024/09/26/projection-skytogo/image-20221107110539832.png" alt="image-20221107110539832" style="zoom:67%;">

<p><strong>1.Controller层</strong></p>
<p>在sky-server模块中，com.sky.controller.admin.EmployeeController</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> employeeLoginDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping("/login")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;EmployeeLoginVO&gt; <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> EmployeeLoginDTO employeeLoginDTO)</span> {</span><br><span class="line">        log.info(<span class="string">"员工登录：{}"</span>, employeeLoginDTO);</span><br><span class="line">		<span class="comment">//调用service方法查询数据库</span></span><br><span class="line">        <span class="type">Employee</span> <span class="variable">employee</span> <span class="operator">=</span> employeeService.login(employeeLoginDTO);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//登录成功后，生成jwt令牌</span></span><br><span class="line">        Map&lt;String, Object&gt; claims = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        claims.put(JwtClaimsConstant.EMP_ID, employee.getId());</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> JwtUtil.createJWT(</span><br><span class="line">                jwtProperties.getAdminSecretKey(),</span><br><span class="line">                jwtProperties.getAdminTtl(),</span><br><span class="line">                claims);</span><br><span class="line"></span><br><span class="line">        <span class="type">EmployeeLoginVO</span> <span class="variable">employeeLoginVO</span> <span class="operator">=</span> EmployeeLoginVO.builder()</span><br><span class="line">                .id(employee.getId())</span><br><span class="line">                .userName(employee.getUsername())</span><br><span class="line">                .name(employee.getName())</span><br><span class="line">                .token(token)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success(employeeLoginVO);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p><strong>2.Service层</strong></p>
<p>在sky-server模块中，com.sky.service.impl.EmployeeServiceImpl</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 员工登录</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> employeeLoginDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Employee <span class="title function_">login</span><span class="params">(EmployeeLoginDTO employeeLoginDTO)</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> employeeLoginDTO.getUsername();</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> employeeLoginDTO.getPassword();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1、根据用户名查询数据库中的数据</span></span><br><span class="line">        <span class="type">Employee</span> <span class="variable">employee</span> <span class="operator">=</span> employeeMapper.getByUsername(username);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、处理各种异常情况（用户名不存在、密码不对、账号被锁定）</span></span><br><span class="line">        <span class="keyword">if</span> (employee == <span class="literal">null</span>) {</span><br><span class="line">            <span class="comment">//账号不存在</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AccountNotFoundException</span>(MessageConstant.ACCOUNT_NOT_FOUND);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//密码比对</span></span><br><span class="line">        <span class="keyword">if</span> (!password.equals(employee.getPassword())) {</span><br><span class="line">            <span class="comment">//密码错误</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PasswordErrorException</span>(MessageConstant.PASSWORD_ERROR);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (employee.getStatus() == StatusConstant.DISABLE) {</span><br><span class="line">            <span class="comment">//账号被锁定</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AccountLockedException</span>(MessageConstant.ACCOUNT_LOCKED);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3、返回实体对象</span></span><br><span class="line">        <span class="keyword">return</span> employee;</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p><strong>3.Mapper层</strong></p>
<p>在sky-server模块中，com.sky.mapper.EmployeeMapper</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Employee;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EmployeeMapper</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据用户名查询员工</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Select("select * from employee where username = #{username}")</span></span><br><span class="line">    Employee <span class="title function_">getByUsername</span><span class="params">(String username)</span>;</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>注：可以通过断点调试跟踪后端程序的执行过程</p>
<h4><span id="3-2-5-nginx-fan-xiang-dai-li-he-fu-zai-jun-heng">3.2.5 nginx反向代理和负载均衡</span></h4><p>对登录功能测试完毕后，接下来，我们思考一个问题：<strong>前端发送的请求，是如何请求到后端服务的？</strong></p>
<p>前端请求地址：<a target="_blank" rel="noopener" href="http://localhost/api/employee/login">http://localhost/api/employee/login</a></p>
<p>后端接口地址：<a target="_blank" rel="noopener" href="http://localhost:8080/admin/employee/login">http://localhost:8080/admin/employee/login</a></p>
<p>​              <strong>前端请求地址</strong>                                                                                       <strong>后端接口地址</strong></p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221107151607921.png" alt="image-20221107151607921" style="zoom:50%;">                                  <img src="/2024/09/26/projection-skytogo/image-20221107151623005.png" alt="image-20221107151623005" style="zoom: 33%;"></p>
<p>很明显，两个地址不一致，那是如何请求到后端服务的呢？</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221107152041371.png" alt="image-20221107152041371"></p>
<p><strong>1). nginx反向代理</strong></p>
<p><strong>nginx 反向代理</strong>，就是将前端发送的动态请求由 nginx 转发到后端服务器</p>
<img src="/2024/09/26/projection-skytogo/image-20221107152112092.png" alt="image-20221107152112092" style="zoom:67%;">

<p>那为什么不直接通过浏览器直接请求后台服务端，需要通过nginx反向代理呢？</p>
<p><strong>nginx 反向代理的好处：</strong></p>
<ul>
<li><p>提高访问速度</p>
<p> 因为nginx本身可以进行缓存，如果访问的同一接口，并且做了数据缓存，nginx就直接可把数据返回，不需要真正地访问服务端，从而提高访问速度。</p>
</li>
<li><p>进行负载均衡</p>
<p> 所谓负载均衡,就是把大量的请求按照我们指定的方式均衡的分配给集群中的每台服务器。</p>
</li>
<li><p>保证后端服务安全</p>
<p> 因为一般后台服务地址不会暴露，所以使用浏览器不能直接访问，可以把nginx作为请求访问的入口，请求到达nginx后转发到具体的服务中，从而保证后端服务的安全。</p>
</li>
</ul>
<img src="/2024/09/26/projection-skytogo/image-20221107153808368.png" alt="image-20221107153808368" style="zoom:67%;">

<p><strong>nginx 反向代理的配置方式：</strong></p>
<figure class="highlight nginx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server{</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line">    </span><br><span class="line">    <span class="section">location</span> /api/{</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://localhost:8080/admin/; <span class="comment">#反向代理</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>proxy_pass：</strong>该指令是用来设置代理服务器的地址，可以是主机名称，IP地址加端口号等形式。</p>
<p>如上代码的含义是：监听80端口号， 然后当我们访问 <a target="_blank" rel="noopener" href="http://localhost/..%E8%BF%99%E6%A0%B7%E7%9A%84%E6%8E%A5%E5%8F%A3%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%AE%83%E4%BC%9A%E9%80%9A%E8%BF%87">http://localhost:80/api/../..这样的接口的时候，它会通过</a> location /api/ {} 这样的反向代理到 <a target="_blank" rel="noopener" href="http://localhost:8080/admin/%E4%B8%8A%E6%9D%A5%E3%80%82">http://localhost:8080/admin/上来。</a></p>
<p>接下来，进到nginx-1.20.2\conf，打开nginx配置</p>
<figure class="highlight nginx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 反向代理,处理管理端发送的请求</span></span><br><span class="line"><span class="section">location</span> /api/ {</span><br><span class="line">	<span class="attribute">proxy_pass</span>   http://localhost:8080/admin/;</span><br><span class="line">    <span class="comment">#proxy_pass   http://webservers/admin/;</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>当在访问<a target="_blank" rel="noopener" href="http://localhost/api/employee/login%EF%BC%8Cnginx%E6%8E%A5%E6%94%B6%E5%88%B0%E8%AF%B7%E6%B1%82%E5%90%8E%E8%BD%AC%E5%88%B0http://localhost:8080/admin/%EF%BC%8C%E6%95%85%E6%9C%80%E7%BB%88%E7%9A%84%E8%AF%B7%E6%B1%82%E5%9C%B0%E5%9D%80%E4%B8%BAhttp://localhost:8080/admin/employee/login%EF%BC%8C%E5%92%8C%E5%90%8E%E5%8F%B0%E6%9C%8D%E5%8A%A1%E7%9A%84%E8%AE%BF%E9%97%AE%E5%9C%B0%E5%9D%80%E4%B8%80%E8%87%B4%E3%80%82">http://localhost/api/employee/login，nginx接收到请求后转到http://localhost:8080/admin/，故最终的请求地址为http://localhost:8080/admin/employee/login，和后台服务的访问地址一致。</a></p>
<p><strong>2). nginx 负载均衡</strong></p>
<p>当如果服务以集群的方式进行部署时，那nginx在转发请求到服务器时就需要做相应的负载均衡。其实，负载均衡从本质上来说也是基于反向代理来实现的，最终都是转发请求。</p>
<p><strong>nginx 负载均衡的配置方式：</strong></p>
<figure class="highlight nginx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> webservers{</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.100.128:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.100.129:8080</span>;</span><br><span class="line">}</span><br><span class="line">server{</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line">    </span><br><span class="line">    <span class="section">location</span> /api/{</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://webservers/admin;<span class="comment">#负载均衡</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>upstream：</strong>如果代理服务器是一组服务器的话，我们可以使用upstream指令配置后端服务器组。</p>
<p>如上代码的含义是：监听80端口号， 然后当我们访问 <a target="_blank" rel="noopener" href="http://localhost/..%E8%BF%99%E6%A0%B7%E7%9A%84%E6%8E%A5%E5%8F%A3%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%AE%83%E4%BC%9A%E9%80%9A%E8%BF%87">http://localhost:80/api/../..这样的接口的时候，它会通过</a> location /api/ {} 这样的反向代理到 <a target="_blank" rel="noopener" href="http://webservers/admin%EF%BC%8C%E6%A0%B9%E6%8D%AEwebservers%E5%90%8D%E7%A7%B0%E6%89%BE%E5%88%B0%E4%B8%80%E7%BB%84%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%8C%E6%A0%B9%E6%8D%AE%E8%AE%BE%E7%BD%AE%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5(%E9%BB%98%E8%AE%A4%E6%98%AF%E8%BD%AE%E8%AF%A2)%E8%BD%AC%E5%8F%91%E5%88%B0%E5%85%B7%E4%BD%93%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8%E3%80%82">http://webservers/admin，根据webservers名称找到一组服务器，根据设置的负载均衡策略(默认是轮询)转发到具体的服务器。</a></p>
<p><strong>注：</strong>upstream后面的名称可自定义，但要上下保持一致。</p>
<p><strong>nginx 负载均衡策略：</strong></p>
<table>
<thead>
<tr>
<th><strong>名称</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>轮询</td>
<td>默认方式</td>
</tr>
<tr>
<td>weight</td>
<td>权重方式，默认为1，权重越高，被分配的客户端请求就越多</td>
</tr>
<tr>
<td>ip_hash</td>
<td>依据ip分配方式，这样每个访客可以固定访问一个后端服务</td>
</tr>
<tr>
<td>least_conn</td>
<td>依据最少连接方式，把请求优先分配给连接数少的后端服务</td>
</tr>
<tr>
<td>url_hash</td>
<td>依据url分配方式，这样相同的url会被分配到同一个后端服务</td>
</tr>
<tr>
<td>fair</td>
<td>依据响应时间方式，响应时间短的服务将会被优先分配</td>
</tr>
</tbody></table>
<p>具体配置方式：</p>
<p><strong>轮询：</strong></p>
<figure class="highlight nginx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> webservers{</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.100.128:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.100.129:8080</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>weight:</strong></p>
<figure class="highlight nginx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> webservers{</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.100.128:8080</span> weight=<span class="number">90</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.100.129:8080</span> weight=<span class="number">10</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>ip_hash:</strong></p>
<figure class="highlight nginx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> webservers{</span><br><span class="line">    ip_hash;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.100.128:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.100.129:8080</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>least_conn:</strong></p>
<figure class="highlight nginx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> webservers{</span><br><span class="line">    least_conn;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.100.128:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.100.129:8080</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>url_hash:</strong></p>
<figure class="highlight nginx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> webservers{</span><br><span class="line">    <span class="attribute">hash</span> &amp;request_uri;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.100.128:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.100.129:8080</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>fair:</strong></p>
<figure class="highlight nginx"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> webservers{</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.100.128:8080</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.100.129:8080</span>;</span><br><span class="line">    fair;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-3-wan-shan-deng-lu-gong-neng">3.3 完善登录功能</span></h3><p><strong>问题：</strong>员工表中的密码是明文存储，安全性太低。</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221107160529803.png" alt="image-20221107160529803"></p>
<p><strong>解决思路：</strong></p>
<ol>
<li><p>将密码加密后存储，提高安全性</p>
<img src="/2024/09/26/projection-skytogo/image-20221107161918913.png" alt="image-20221107161918913" style="zoom:50%;">
</li>
<li><p>使用MD5加密方式对明文密码加密</p>
<img src="/2024/09/26/projection-skytogo/image-20221107160739680.png" alt="image-20221107160739680" style="zoom:50%;"></li>
</ol>
<p><strong>实现步骤：</strong></p>
<ol>
<li><p>修改数据库中明文密码，改为MD5加密后的密文</p>
<p>打开employee表，修改密码</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221107161446710.png" alt="image-20221107161446710"></p>
</li>
<li><p>修改Java代码，前端提交的密码进行MD5加密后再跟数据库中密码比对</p>
<p>打开EmployeeServiceImpl.java，修改比对密码</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 员工登录</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> employeeLoginDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Employee <span class="title function_">login</span><span class="params">(EmployeeLoginDTO employeeLoginDTO)</span> {</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1、根据用户名查询数据库中的数据</span></span><br><span class="line">       </span><br><span class="line">        <span class="comment">//2、处理各种异常情况（用户名不存在、密码不对、账号被锁定）</span></span><br><span class="line">        <span class="comment">//.......</span></span><br><span class="line">        <span class="comment">//密码比对</span></span><br><span class="line">        <span class="comment">// TODO 后期需要进行md5加密，然后再进行比对</span></span><br><span class="line">        password = DigestUtils.md5DigestAsHex(password.getBytes());</span><br><span class="line">        <span class="keyword">if</span> (!password.equals(employee.getPassword())) {</span><br><span class="line">            <span class="comment">//密码错误</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PasswordErrorException</span>(MessageConstant.PASSWORD_ERROR);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//........</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//3、返回实体对象</span></span><br><span class="line">        <span class="keyword">return</span> employee;</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
<h2><span id="4-dao-ru-jie-kou-wen-dang">4. 导入接口文档</span></h2><p>接下来，就要进入到项目的业务开发了，而我们的开发方式就是基本当前企业主流的前后端分离开发方式，那么这种方式就要求我们之前需要先将接口定义好，这样前后端人员才能并行开发，所以，这个章节就需要将接口文档导入到管理平台，为我们后面业务开发做好准备。其实，在真实的企业开发中，接口设计过程其实是一个非常漫长的过程，可能需要多次开会讨论调整，甚至在开发的过程中才会发现某些接口定义还需要再调整，这种情况其实是非常常见的，但是由于项目时间原因，所以选择一次性导入所有的接口，在开发业务功能过程当中，也会带着大家一起来分析一下对应的接口是怎么确定下来的，为什么要这样定义，从而培养同学们的接口设计能力。</p>
<h3><span id="4-1-qian-hou-duan-fen-chi-kai-fa-liu-cheng">4.1 前后端分离开发流程</span></h3><img src="/2024/09/26/projection-skytogo/image-20221107181446913.png" alt="image-20221107181446913" style="zoom:67%;">

<p>第一步：定义接口，确定接口的路径、请求方式、传入参数、返回参数。</p>
<p>第二步：前端开发人员和后端开发人员并行开发，同时，也可自测。</p>
<p>第三步：前后端人员进行连调测试。</p>
<p>第四步：提交给测试人员进行最终测试。</p>
<h3><span id="4-2-cao-zuo-bu-zou">4.2 操作步骤</span></h3><p>将课程资料中提供的项目接口导入YApi。访问地址：<a target="_blank" rel="noopener" href="http://yapi.smart-xwork.cn/">http://yapi.smart-xwork.cn/</a></p>
<p><strong>1). 从资料中找到项目接口文件</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221107184823104.png" alt="image-20221107184823104" style="zoom:80%;">

<p><strong>2). 导入到YApi平台</strong></p>
<p>在YApi平台创建出两个项目</p>
<img src="/2024/09/26/projection-skytogo/image-20221107185304117.png" alt="image-20221107185304117" style="zoom: 50%;">

<p>选择苍穹外卖-管理端接口.json导入</p>
<img src="/2024/09/26/projection-skytogo/image-20221107185630516.png" alt="image-20221107185630516" style="zoom:50%;">

<p>导入成功</p>
<img src="/2024/09/26/projection-skytogo/image-20221107185742061.png" alt="image-20221107185742061" style="zoom:50%;">



<p>另一个用户端json文件也执行相同操作。</p>
<h2><span id="5-swagger">5. Swagger</span></h2><h3><span id="5-1-jie-shao">5.1 介绍</span></h3><p>Swagger 是一个规范和完整的框架，用于生成、描述、调用和可视化 RESTful 风格的 Web 服务(<a target="_blank" rel="noopener" href="https://swagger.io/">https://swagger.io/</a>)。 它的主要作用是：</p>
<ol>
<li><p>使得前后端分离开发更加方便，有利于团队协作</p>
</li>
<li><p>接口的文档在线自动生成，降低后端开发人员编写接口文档的负担</p>
</li>
<li><p>功能测试 </p>
<p>Spring已经将Swagger纳入自身的标准，建立了Spring-swagger项目，现在叫Springfox。通过在项目中引入Springfox ，即可非常简单快捷的使用Swagger。</p>
</li>
</ol>
<p>knife4j是为Java MVC框架集成Swagger生成Api文档的增强解决方案,前身是swagger-bootstrap-ui,取名kni4j是希望它能像一把匕首一样小巧,轻量,并且功能强悍!</p>
<p>目前，一般都使用knife4j框架。</p>
<h3><span id="5-2-shi-yong-bu-zou">5.2 使用步骤</span></h3><ol>
<li><p>导入 knife4j 的maven坐标</p>
<p>在pom.xml中添加依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>knife4j-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>在配置类中加入 knife4j 相关配置</p>
<p>WebMvcConfiguration.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过knife4j生成接口文档</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Docket <span class="title function_">docket</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">ApiInfo</span> <span class="variable">apiInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApiInfoBuilder</span>()</span><br><span class="line">                .title(<span class="string">"苍穹外卖项目接口文档"</span>)</span><br><span class="line">                .version(<span class="string">"2.0"</span>)</span><br><span class="line">                .description(<span class="string">"苍穹外卖项目接口文档"</span>)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="type">Docket</span> <span class="variable">docket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Docket</span>(DocumentationType.SWAGGER_2)</span><br><span class="line">                .apiInfo(apiInfo)</span><br><span class="line">                .select()</span><br><span class="line">                .apis(RequestHandlerSelectors.basePackage(<span class="string">"com.sky.controller"</span>))</span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">return</span> docket;</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>


</li>
<li><p>设置静态资源映射，否则接口文档页面无法访问</p>
<p>WebMvcConfiguration.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置静态资源映射</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> {</span><br><span class="line">        registry.addResourceHandler(<span class="string">"/doc.html"</span>).addResourceLocations(<span class="string">"classpath:/META-INF/resources/"</span>);</span><br><span class="line">        registry.addResourceHandler(<span class="string">"/webjars/**"</span>).addResourceLocations(<span class="string">"classpath:/META-INF/resources/webjars/"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>访问测试</p>
<p>接口文档访问路径为 <a href="http://ip:port/doc.html">http://ip:port/doc.html</a> —&gt; <a target="_blank" rel="noopener" href="http://localhost:8080/doc.html">http://localhost:8080/doc.html</a></p>
<img src="/2024/09/26/projection-skytogo/image-20221107173033632.png" alt="image-20221107173033632" style="zoom:50%;">

<p>接口测试:测试登录功能</p>
<img src="/2024/09/26/projection-skytogo/image-20221107173137506.png" alt="image-20221107173137506" style="zoom:50%;"></li>
</ol>
<p><strong>思考：</strong>通过 Swagger 就可以生成接口文档，那么我们就不需要 Yapi 了？</p>
<p>1、Yapi 是设计阶段使用的工具，管理和维护接口</p>
<p>2、Swagger 在开发阶段使用的框架，帮助后端开发人员做后端的接口测试</p>
<h3><span id="5-3-chang-yong-zhu-jie">5.3 常用注解</span></h3><p>通过注解可以控制生成的接口文档，使接口文档拥有更好的可读性，常用注解如下：</p>
<table>
<thead>
<tr>
<th><strong>注解</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>@Api</td>
<td>用在类上，例如Controller，表示对类的说明</td>
</tr>
<tr>
<td>@ApiModel</td>
<td>用在类上，例如entity、DTO、VO</td>
</tr>
<tr>
<td>@ApiModelProperty</td>
<td>用在属性上，描述属性信息</td>
</tr>
<tr>
<td>@ApiOperation</td>
<td>用在方法上，例如Controller的方法，说明方法的用途、作用</td>
</tr>
</tbody></table>
<p>接下来，使用上述注解，生成可读性更好的接口文档</p>
<p>在sky-pojo模块中</p>
<p>EmployeeLoginDTO.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(description = "员工登录时传递的数据模型")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmployeeLoginDTO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty("用户名")</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty("密码")</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>EmployeeLoginVo.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModel;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@ApiModel(description = "员工登录返回的数据格式")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmployeeLoginVO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty("主键值")</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty("用户名")</span></span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty("姓名")</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty("jwt令牌")</span></span><br><span class="line">    <span class="keyword">private</span> String token;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在sky-server模块中</p>
<p>EmployeeController.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.constant.JwtClaimsConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeLoginDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Employee;</span><br><span class="line"><span class="keyword">import</span> com.sky.properties.JwtProperties;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.EmployeeService;</span><br><span class="line"><span class="keyword">import</span> com.sky.utils.JwtUtil;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.EmployeeLoginVO;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 员工管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/admin/employee")</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = "员工相关接口")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmployeeController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmployeeService employeeService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtProperties jwtProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> employeeLoginDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping("/login")</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = "员工登录")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;EmployeeLoginVO&gt; <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> EmployeeLoginDTO employeeLoginDTO)</span> 	{</span><br><span class="line">        <span class="comment">//..............</span></span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 退出</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping("/logout")</span></span><br><span class="line">    <span class="meta">@ApiOperation("员工退出")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">logout</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>启动服务：访问<a target="_blank" rel="noopener" href="http://localhost:8080/doc.html">http://localhost:8080/doc.html</a></p>
<img src="/2024/09/26/projection-skytogo/image-20221107175649468.png" alt="image-20221107175649468" style="zoom:50%;">

<h1><span id="cang-qiong-wai-mai-day02">苍穹外卖-day02</span></h1><h2><span id="ke-cheng-nei-rong">课程内容</span></h2><ul>
<li>新增员工</li>
<li>员工分页查询</li>
<li>启用禁用员工账号</li>
<li>编辑员工</li>
<li>导入分类模块功能代码</li>
</ul>
<p><strong>功能实现：</strong>员工管理、菜品分类管理。</p>
<p><strong>员工管理效果：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221112172846316.png" alt="image-20221112172846316" style="zoom:50%;"> 



<p><strong>菜品分类管理效果：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221112172925354.png" alt="image-20221112172925354" style="zoom:50%;"> 



<h2><span id="1-xin-zeng-yuan-gong">1. 新增员工</span></h2><h3><span id="1-1-xu-qiu-fen-xi-he-she-ji">1.1 需求分析和设计</span></h3><h4><span id="1-1-1-chan-pin-yuan-xing">1.1.1 产品原型</span></h4><p>一般在做需求分析时，往往都是对照着产品原型进行分析，因为产品原型比较直观，便于我们理解业务。</p>
<p>后台系统中可以管理员工信息，通过新增员工来添加后台系统用户。</p>
<p><strong>新增员工原型：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221111161120975.png" alt="image-20221111161120975" style="zoom: 50%;"> 



<p>当填写完表单信息, 点击”保存”按钮后, 会提交该表单的数据到服务端, 在服务端中需要接受数据, 然后将数据保存至数据库中。</p>
<p><strong>注意事项：</strong></p>
<ol>
<li>账号必须是唯一的</li>
<li>手机号为合法的11位手机号码</li>
<li>身份证号为合法的18位身份证号码</li>
<li>密码默认为123456</li>
</ol>
<h4><span id="1-1-2-jie-kou-she-ji">1.1.2 接口设计</span></h4><p>找到资料–&gt;项目接口文档–&gt;苍穹外卖-管理端接口.html</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221111162912753.png" alt="image-20221111162912753" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221111162930483.png" alt="image-20221111162930483" style="zoom:50%;"></p>
<p>明确新增员工接口的<strong>请求路径、请求方式、请求参数、返回数据</strong>。</p>
<p>本项目约定：</p>
<ul>
<li><strong>管理端</strong>发出的请求，统一使用**/admin**作为前缀。</li>
<li><strong>用户端</strong>发出的请求，统一使用**/user**作为前缀。</li>
</ul>
<h4><span id="1-1-3-biao-she-ji">1.1.3 表设计</span></h4><p>新增员工，其实就是将我们新增页面录入的员工数据插入到employee表。</p>
<p><strong>employee表结构：</strong></p>
<table>
<thead>
<tr>
<th><strong>字段名</strong></th>
<th><strong>数据类型</strong></th>
<th><strong>说明</strong></th>
<th><strong>备注</strong></th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>bigint</td>
<td>主键</td>
<td>自增</td>
</tr>
<tr>
<td>name</td>
<td>varchar(32)</td>
<td>姓名</td>
<td></td>
</tr>
<tr>
<td>username</td>
<td>varchar(32)</td>
<td>用户名</td>
<td>唯一</td>
</tr>
<tr>
<td>password</td>
<td>varchar(64)</td>
<td>密码</td>
<td></td>
</tr>
<tr>
<td>phone</td>
<td>varchar(11)</td>
<td>手机号</td>
<td></td>
</tr>
<tr>
<td>sex</td>
<td>varchar(2)</td>
<td>性别</td>
<td></td>
</tr>
<tr>
<td>id_number</td>
<td>varchar(18)</td>
<td>身份证号</td>
<td></td>
</tr>
<tr>
<td>status</td>
<td>Int</td>
<td>账号状态</td>
<td>1正常 0锁定</td>
</tr>
<tr>
<td>create_time</td>
<td>Datetime</td>
<td>创建时间</td>
<td></td>
</tr>
<tr>
<td>update_time</td>
<td>datetime</td>
<td>最后修改时间</td>
<td></td>
</tr>
<tr>
<td>create_user</td>
<td>bigint</td>
<td>创建人id</td>
<td></td>
</tr>
<tr>
<td>update_user</td>
<td>bigint</td>
<td>最后修改人id</td>
<td></td>
</tr>
</tbody></table>
<p>其中，employee表中的status字段已经设置了默认值1，表示状态正常。</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221111180159188.png" alt="image-20221111180159188">  </p>
<h3><span id="1-2-dai-ma-kai-fa">1.2 代码开发</span></h3><h4><span id="1-2-1-she-ji-dto-lei">1.2.1 设计DTO类</span></h4><p><strong>根据新增员工接口设计对应的DTO</strong></p>
<p>前端传递参数列表：</p>
<img src="/2024/09/26/projection-skytogo/image-20221111164002448.png" alt="image-20221111164002448" style="zoom:50%;"> 

<p><strong>思考：</strong>是否可以使用对应的实体类来接收呢？</p>
<img src="/2024/09/26/projection-skytogo/image-20221111164453341.png" alt="image-20221111164453341" style="zoom:50%;"> 

<p><strong>注意：</strong>当前端提交的数据和实体类中对应的属性差别比较大时，建议使用DTO来封装数据</p>
<p>由于上述传入参数和实体类有较大差别，所以自定义DTO类。</p>
<p>进入sky-pojo模块，在com.sky.dto包下，已定义EmployeeDTO</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmployeeDTO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String idNumber;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="1-2-2-controller-ceng">1.2.2 Controller层</span></h4><p> <strong>EmployeeController中创建新增员工方法</strong></p>
<p>进入到sky-server模块中，在com.sky.controller.admin包下，在EmployeeController中创建新增员工方法，接收前端提交的参数。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 新增员工</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> employeeDTO</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@PostMapping</span></span><br><span class="line">   <span class="meta">@ApiOperation("新增员工")</span></span><br><span class="line">   <span class="keyword">public</span> Result <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> EmployeeDTO employeeDTO)</span>{</span><br><span class="line">       log.info(<span class="string">"新增员工：{}"</span>,employeeDTO);</span><br><span class="line">       employeeService.save(employeeDTO);<span class="comment">//该方法后续步骤会定义</span></span><br><span class="line">       <span class="keyword">return</span> Result.success();</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<p><strong>注：</strong>Result类定义了后端统一返回结果格式。</p>
<p>进入sky-common模块，在com.sky.result包下定义了Result.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.result;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 后端统一返回结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Result</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer code; <span class="comment">//编码：1成功，0和其它数字为失败</span></span><br><span class="line">    <span class="keyword">private</span> String msg; <span class="comment">//错误信息</span></span><br><span class="line">    <span class="keyword">private</span> T data; <span class="comment">//数据</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="title function_">success</span><span class="params">()</span> {</span><br><span class="line">        Result&lt;T&gt; result = <span class="keyword">new</span> <span class="title class_">Result</span>&lt;T&gt;();</span><br><span class="line">        result.code = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="title function_">success</span><span class="params">(T object)</span> {</span><br><span class="line">        Result&lt;T&gt; result = <span class="keyword">new</span> <span class="title class_">Result</span>&lt;T&gt;();</span><br><span class="line">        result.data = object;</span><br><span class="line">        result.code = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="title function_">error</span><span class="params">(String msg)</span> {</span><br><span class="line">        <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Result</span>();</span><br><span class="line">        result.msg = msg;</span><br><span class="line">        result.code = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="1-2-3-service-ceng-jie-kou">1.2.3 Service层接口</span></h4><p><strong>在EmployeeService接口中声明新增员工方法</strong></p>
<p>进入到sky-server模块中,com.sky.server.EmployeeService</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 新增员工</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> employeeDTO</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(EmployeeDTO employeeDTO)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="1-2-4-service-ceng-shi-xian-lei">1.2.4 Service层实现类</span></h4><p><strong>在EmployeeServiceImpl中实现新增员工方法</strong></p>
<p>com.sky.server.impl.EmployeeServiceImpl中创建方法</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 新增员工</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> employeeDTO</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(EmployeeDTO employeeDTO)</span> {</span><br><span class="line">       <span class="type">Employee</span> <span class="variable">employee</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Employee</span>();</span><br><span class="line"></span><br><span class="line">       <span class="comment">//对象属性拷贝</span></span><br><span class="line">       BeanUtils.copyProperties(employeeDTO, employee);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//设置账号的状态，默认正常状态 1表示正常 0表示锁定</span></span><br><span class="line">       employee.setStatus(StatusConstant.ENABLE);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//设置密码，默认密码123456</span></span><br><span class="line">       employee.setPassword(DigestUtils.md5DigestAsHex(PasswordConstant.DEFAULT_PASSWORD.getBytes()));</span><br><span class="line"></span><br><span class="line">       <span class="comment">//设置当前记录的创建时间和修改时间</span></span><br><span class="line">       employee.setCreateTime(LocalDateTime.now());</span><br><span class="line">       employee.setUpdateTime(LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">       <span class="comment">//设置当前记录创建人id和修改人id</span></span><br><span class="line">       employee.setCreateUser(<span class="number">10L</span>);<span class="comment">//目前写个假数据，后期修改</span></span><br><span class="line">       employee.setUpdateUser(<span class="number">10L</span>);</span><br><span class="line"></span><br><span class="line">       employeeMapper.insert(employee);<span class="comment">//后续步骤定义</span></span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<p>在sky-common模块com.sky.constants包下已定义StatusConstant.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.constant;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 状态常量，启用或者禁用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StatusConstant</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">//启用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">ENABLE</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//禁用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">DISABLE</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="1-2-5-mapper-ceng">1.2.5 Mapper层</span></h4><p><strong>在EmployeeMapper中声明insert方法</strong></p>
<p>com.sky.EmployeeMapper中添加方法</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 插入员工数据</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> employee</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Insert("insert into employee (name, username, password, phone, sex, id_number, create_time, update_time, create_user, update_user,status) " +</span></span><br><span class="line"><span class="meta">           "values " +</span></span><br><span class="line"><span class="meta">           "(#{name},#{username},#{password},#{phone},#{sex},#{idNumber},#{createTime},#{updateTime},#{createUser},#{updateUser},#{status})")</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(Employee employee)</span>;</span><br></pre></td></tr></tbody></table></figure>



<p>在application.yml中已开启驼峰命名，故id_number和idNumber可对应。</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="comment">#开启驼峰命名</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="1-3-gong-neng-ce-shi">1.3 功能测试</span></h3><p>代码已经发开发完毕，对新增员工功能进行测试。</p>
<p><strong>功能测试实现方式：</strong></p>
<ul>
<li>通过接口文档测试</li>
<li>通前后端联调测试</li>
</ul>
<p>接下来我们使用上述两种方式分别测试。</p>
<h4><span id="1-3-1-jie-kou-wen-dang-ce-shi">1.3.1 接口文档测试</span></h4><p><strong>启动服务：</strong>访问<a target="_blank" rel="noopener" href="http://localhost:8080/doc.html%EF%BC%8C%E8%BF%9B%E5%85%A5%E6%96%B0%E5%A2%9E%E5%91%98%E5%B7%A5%E6%8E%A5%E5%8F%A3">http://localhost:8080/doc.html，进入新增员工接口</a></p>
<img src="/2024/09/26/projection-skytogo/image-20221111184934153.png" alt="image-20221111184934153" style="zoom:50%;">   

<p>json数据：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"id"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"idNumber"</span><span class="punctuation">:</span> <span class="string">"111222333444555666"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"xiaozhi"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"phone"</span><span class="punctuation">:</span> <span class="string">"13812344321"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"sex"</span><span class="punctuation">:</span> <span class="string">"1"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"username"</span><span class="punctuation">:</span> <span class="string">"小智"</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>响应码：401 报错</p>
<p><strong>通过断点调试：</strong>进入到JwtTokenAdminInterceptor拦截器</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 校验jwt</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> handler</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">      <span class="comment">//判断当前拦截到的是Controller的方法还是其他资源</span></span><br><span class="line">      <span class="keyword">if</span> (!(handler <span class="keyword">instanceof</span> HandlerMethod)) {</span><br><span class="line">          <span class="comment">//当前拦截到的不是动态方法，直接放行</span></span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">//1、从请求头中获取令牌 jwtProperties.getAdminTokenName()获取为token</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(jwtProperties.getAdminTokenName());</span><br><span class="line"></span><br><span class="line">      <span class="comment">//2、校验令牌</span></span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">          log.info(<span class="string">"jwt校验:{}"</span>, token);</span><br><span class="line">          <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> JwtUtil.parseJWT(jwtProperties.getAdminSecretKey(), token);</span><br><span class="line">          <span class="type">Long</span> <span class="variable">empId</span> <span class="operator">=</span> Long.valueOf(claims.get(JwtClaimsConstant.EMP_ID).toString());</span><br><span class="line">          log.info(<span class="string">"当前员工id："</span>, empId);</span><br><span class="line">          <span class="comment">//3、通过，放行</span></span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      } <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line">          <span class="comment">//4、不通过，响应401状态码</span></span><br><span class="line">          response.setStatus(<span class="number">401</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      }</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure>

<p><strong>报错原因：</strong>由于JWT令牌校验失败，导致EmployeeController的save方法没有被调用</p>
<p><strong>解决方法：</strong>调用员工登录接口获得一个合法的JWT令牌</p>
<p>使用admin用户登录获取令牌</p>
<img src="/2024/09/26/projection-skytogo/image-20221111185649636.png" alt="image-20221111185649636" style="zoom: 50%;"> 

<p><strong>添加令牌：</strong></p>
<p>将合法的JWT令牌添加到全局参数中</p>
<p>文档管理–&gt;全局参数设置–&gt;添加参数</p>
<img src="/2024/09/26/projection-skytogo/image-20221111185901726.png" alt="image-20221111185901726" style="zoom: 50%;"> 

<p><strong>接口测试：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221111190132481.png" alt="image-20221111190132481" style="zoom:50%;"> 

<p>其中，请求头部含有JWT令牌</p>
<img src="/2024/09/26/projection-skytogo/image-20221111190248268.png" alt="image-20221111190248268" style="zoom:50%;"> 

<p><strong>查看employee表：</strong></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221111191624908.png" alt="image-20221111191624908"></p>
<p>测试成功。</p>
<h4><span id="1-3-2-qian-hou-duan-lian-diao-ce-shi">1.3.2 前后端联调测试</span></h4><p>启动nginx,访问 <a target="_blank" rel="noopener" href="http://localhost/">http://localhost</a></p>
<p>登录–&gt;员工管理–&gt;添加员工</p>
<img src="/2024/09/26/projection-skytogo/image-20221111192339271.png" alt="image-20221111192339271" style="zoom:50%;"> 

<p>保存后，查看employee表</p>
<img src="/2024/09/26/projection-skytogo/image-20221111192446950.png" alt="image-20221111192446950"> 

<p>测试成功。</p>
<p><strong>注意：</strong>由于开发阶段前端和后端是并行开发的，后端完成某个功能后，此时前端对应的功能可能还没有开发完成，<br>导致无法进行前后端联调测试。所以在开发阶段，后端测试主要以接口文档测试为主。</p>
<h3><span id="1-4-dai-ma-wan-shan">1.4 代码完善</span></h3><p>目前，程序存在的问题主要有两个：</p>
<ul>
<li>录入的用户名已存，抛出的异常后没有处理</li>
<li>新增员工时，创建人id和修改人id设置为固定值</li>
</ul>
<p>接下来，我们对上述两个问题依次进行分析和解决。</p>
<h4><span id="1-4-1-wen-ti-yi">1.4.1 问题一</span></h4><p><strong>描述：</strong>录入的用户名已存，抛出的异常后没有处理</p>
<p><strong>分析：</strong></p>
<p>新增username=zhangsan的用户，若employee表中之前已存在。</p>
<img src="/2024/09/26/projection-skytogo/image-20221111193700895.png" alt="image-20221111193700895" style="zoom: 50%;"> 

<p>后台报错信息：</p>
<img src="/2024/09/26/projection-skytogo/image-20221111194049620.png" alt="image-20221111194049620" style="zoom:80%;"> 

<p>查看employee表结构：</p>
<img src="/2024/09/26/projection-skytogo/image-20221111194131787.png" alt="image-20221111194131787" style="zoom:50%;"> 

<p>发现，username已经添加了唯一约束，不能重复。</p>
<p><strong>解决：</strong></p>
<p>通过全局异常处理器来处理。</p>
<p>进入到sky-server模块，com.sky.hander包下，GlobalExceptionHandler.java添加方法</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 处理SQL异常</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ex</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@ExceptionHandler</span></span><br><span class="line">   <span class="keyword">public</span> Result <span class="title function_">exceptionHandler</span><span class="params">(SQLIntegrityConstraintViolationException ex)</span>{</span><br><span class="line">       <span class="comment">//Duplicate entry 'zhangsan' for key 'employee.idx_username'</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> ex.getMessage();</span><br><span class="line">       <span class="keyword">if</span>(message.contains(<span class="string">"Duplicate entry"</span>)){</span><br><span class="line">           String[] split = message.split(<span class="string">" "</span>);</span><br><span class="line">           <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> split[<span class="number">2</span>];</span><br><span class="line">           <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> username + MessageConstant.ALREADY_EXISTS;</span><br><span class="line">           <span class="keyword">return</span> Result.error(msg);</span><br><span class="line">       }<span class="keyword">else</span>{</span><br><span class="line">           <span class="keyword">return</span> Result.error(MessageConstant.UNKNOWN_ERROR);</span><br><span class="line">       }</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<p>进入到sky-common模块，在MessageConstant.java添加</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ALREADY_EXISTS</span> <span class="operator">=</span> <span class="string">"已存在"</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>再次，接口测试：</p>
<img src="/2024/09/26/projection-skytogo/image-20221111195521095.png" alt="image-20221111195521095" style="zoom:50%;"> 



<h4><span id="1-4-2-wen-ti-er">1.4.2 问题二</span></h4><p><strong>描述</strong>：新增员工时，创建人id和修改人id设置为固定值</p>
<p><strong>分析：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 新增员工</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> employeeDTO</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(EmployeeDTO employeeDTO)</span> {</span><br><span class="line">       <span class="type">Employee</span> <span class="variable">employee</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Employee</span>();</span><br><span class="line">       <span class="comment">//................</span></span><br><span class="line">       <span class="comment">//////////当前设置的id为固定值10//////////</span></span><br><span class="line">       employee.setCreateUser(<span class="number">10L</span>);</span><br><span class="line">       employee.setUpdateUser(<span class="number">10L</span>);</span><br><span class="line">       <span class="comment">//////////////////////////////////////</span></span><br><span class="line">       <span class="comment">//.................................</span></span><br><span class="line"></span><br><span class="line">       employeeMapper.insert(employee);<span class="comment">//后续步骤定义</span></span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<p><strong>解决：</strong></p>
<p>通过某种方式动态获取当前登录员工的id。</p>
<img src="/2024/09/26/projection-skytogo/image-20221111201922482.png" alt="image-20221111201922482" style="zoom:50%;"> 

<p>员工登录成功后会生成JWT令牌并响应给前端：</p>
<p>在sky-server模块</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.admin;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 员工管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/admin/employee")</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = "员工相关接口")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmployeeController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmployeeService employeeService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtProperties jwtProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> employeeLoginDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping("/login")</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = "员工登录")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;EmployeeLoginVO&gt; <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> EmployeeLoginDTO employeeLoginDTO)</span> {</span><br><span class="line">        <span class="comment">//.........</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//登录成功后，生成jwt令牌</span></span><br><span class="line">        Map&lt;String, Object&gt; claims = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        claims.put(JwtClaimsConstant.EMP_ID, employee.getId());</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> JwtUtil.createJWT(</span><br><span class="line">                jwtProperties.getAdminSecretKey(),</span><br><span class="line">                jwtProperties.getAdminTtl(),</span><br><span class="line">                claims);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//............</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success(employeeLoginVO);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>后续请求中，前端会携带JWT令牌，通过JWT令牌可以解析出当前登录员工id：</p>
<p>JwtTokenAdminInterceptor.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * jwt令牌校验的拦截器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtTokenAdminInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtProperties jwtProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 校验jwt</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">       </span><br><span class="line">		<span class="comment">//..............</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//1、从请求头中获取令牌</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(jwtProperties.getAdminTokenName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、校验令牌</span></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            log.info(<span class="string">"jwt校验:{}"</span>, token);</span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> JwtUtil.parseJWT(jwtProperties.getAdminSecretKey(), token);</span><br><span class="line">            <span class="type">Long</span> <span class="variable">empId</span> <span class="operator">=</span> Long.valueOf(claims.get(JwtClaimsConstant.EMP_ID).toString());</span><br><span class="line">            log.info(<span class="string">"当前员工id："</span>, empId);</span><br><span class="line">            <span class="comment">//3、通过，放行</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        } <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line">            <span class="comment">//4、不通过，响应401状态码</span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>思考：</strong>解析出登录员工id后，如何传递给Service的save方法？</p>
<p>通过ThreadLocal进行传递。</p>
<h4><span id="1-4-3-threadlocal">1.4.3 ThreadLocal</span></h4><p><strong>介绍：</strong></p>
<p>ThreadLocal 并不是一个Thread，而是Thread的局部变量。<br>ThreadLocal为每个线程提供单独一份存储空间，具有线程隔离的效果，只有在线程内才能获取到对应的值，线程外则不能访问。</p>
<p><strong>常用方法：</strong></p>
<ul>
<li>public void set(T value) 	设置当前线程的线程局部变量的值</li>
<li>public T get() 		返回当前线程所对应的线程局部变量的值</li>
<li>public void remove()        移除当前线程的线程局部变量</li>
</ul>
<p>对ThreadLocal有了一定认识后，接下来继续解决<strong>问题二</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221111212349365.png" alt="image-20221111212349365" style="zoom:67%;"> 

<p>初始工程中已经封装了 ThreadLocal 操作的工具类：</p>
<p>在sky-common模块</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.context;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseContext</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadLocal&lt;Long&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setCurrentId</span><span class="params">(Long id)</span> {</span><br><span class="line">        threadLocal.set(id);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title function_">getCurrentId</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> threadLocal.get();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">removeCurrentId</span><span class="params">()</span> {</span><br><span class="line">        threadLocal.remove();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在拦截器中解析出当前登录员工id，并放入线程局部变量中：</p>
<p>在sky-server模块中，拦截器：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * jwt令牌校验的拦截器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtTokenAdminInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtProperties jwtProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 校验jwt</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        </span><br><span class="line">		<span class="comment">//.............................</span></span><br><span class="line">       </span><br><span class="line">        <span class="comment">//2、校验令牌</span></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">//.................</span></span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> JwtUtil.parseJWT(jwtProperties.getAdminSecretKey(), token);</span><br><span class="line">            <span class="type">Long</span> <span class="variable">empId</span> <span class="operator">=</span> Long.valueOf(claims.get(JwtClaimsConstant.EMP_ID).toString());</span><br><span class="line">            log.info(<span class="string">"当前员工id："</span>, empId);</span><br><span class="line">            <span class="comment">/////将用户id存储到ThreadLocal////////</span></span><br><span class="line">            BaseContext.setCurrentId(empId);</span><br><span class="line">            <span class="comment">////////////////////////////////////</span></span><br><span class="line">            <span class="comment">//3、通过，放行</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        } <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line">            <span class="comment">//......................</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在Service中获取线程局部变量中的值：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 新增员工</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> employeeDTO</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(EmployeeDTO employeeDTO)</span> {</span><br><span class="line">       <span class="comment">//.............................</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">//设置当前记录创建人id和修改人id</span></span><br><span class="line">       employee.setCreateUser(BaseContext.getCurrentId());<span class="comment">//目前写个假数据，后期修改</span></span><br><span class="line">       employee.setUpdateUser(BaseContext.getCurrentId());</span><br><span class="line"></span><br><span class="line">       employeeMapper.insert(employee);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<p>测试：使用admin(id=1)用户登录后添加一条记录</p>
<img src="/2024/09/26/projection-skytogo/image-20221111214044510.png" alt="image-20221111214044510" style="zoom:50%;"> 

<p>查看employee表记录</p>
<img src="/2024/09/26/projection-skytogo/image-20221111214354053.png" alt="image-20221111214354053" style="zoom:50%;"> 



<h3><span id="1-5-dai-ma-ti-jiao">1.5 代码提交</span></h3><p>点击提交：</p>
<img src="/2024/09/26/projection-skytogo/image-20221112092139583.png" alt="image-20221112092139583" style="zoom: 50%;"> 

<p>提交过程中，出现提示：</p>
<img src="/2024/09/26/projection-skytogo/image-20221112092239578.png" alt="image-20221112092239578" style="zoom:50%;"> 

<p>继续push:</p>
<img src="/2024/09/26/projection-skytogo/image-20221112092332837.png" alt="image-20221112092332837" style="zoom:50%;"> 

<p>推送成功：</p>
<img src="/2024/09/26/projection-skytogo/image-20221112092427252.png" alt="image-20221112092427252" style="zoom: 80%;"> 



<h2><span id="2-yuan-gong-fen-ye-cha-xun">2. 员工分页查询</span></h2><h3><span id="2-1-xu-qiu-fen-xi-he-she-ji">2.1 需求分析和设计</span></h3><h4><span id="2-1-1-chan-pin-yuan-xing">2.1.1 产品原型</span></h4><p>系统中的员工很多的时候，如果在一个页面中全部展示出来会显得比较乱，不便于查看，所以一般的系统中都会以分页的方式来展示列表数据。而在我们的分页查询页面中, 除了分页条件以外，还有一个查询条件 “员工姓名”。</p>
<p><strong>查询员工原型：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221111215309289.png" alt="image-20221111215309289" style="zoom:67%;"> 

<p><strong>业务规则</strong>：</p>
<ul>
<li>根据页码展示员工信息</li>
<li>每页展示10条数据</li>
<li>分页查询时可以根据需要，输入员工姓名进行查询</li>
</ul>
<h4><span id="2-1-2-jie-kou-she-ji">2.1.2 接口设计</span></h4><p>找到资料–&gt;项目接口文档–&gt;苍穹外卖-管理端接口.html</p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221111220031113.png" alt="image-20221111220031113" style="zoom:50%;"><img src="/2024/09/26/projection-skytogo/image-20221111220041965.png" alt="image-20221111220041965" style="zoom:50%;"></p>
<p><strong>注意事项：</strong></p>
<ul>
<li>请求参数类型为Query，不是json格式提交，在路径后直接拼接。/admin/employee/page?name=zhangsan</li>
<li>返回数据中records数组中使用Employee实体类对属性进行封装。</li>
</ul>
<h3><span id="2-2-dai-ma-kai-fa">2.2 代码开发</span></h3><h4><span id="2-2-1-she-ji-dto-lei">2.2.1 设计DTO类</span></h4><p>根据请求参数进行封装，在sky-pojo模块中</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmployeePageQueryDTO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">//员工姓名</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//页码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> page;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每页显示记录数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> pageSize;</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-2-2-feng-zhuang-pageresult">2.2.2 封装PageResult</span></h4><p>后面所有的分页查询，统一都封装为PageResult对象。</p>
<p>在sky-common模块</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.result;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 封装分页查询结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageResult</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> total; <span class="comment">//总记录数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List records; <span class="comment">//当前页数据集合</span></span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>员工信息分页查询后端返回的对象类型为: Result<pageresult></pageresult></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.result;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 后端统一返回结果</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Result</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer code; <span class="comment">//编码：1成功，0和其它数字为失败</span></span><br><span class="line">    <span class="keyword">private</span> String msg; <span class="comment">//错误信息</span></span><br><span class="line">    <span class="keyword">private</span> T data; <span class="comment">//数据</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="title function_">success</span><span class="params">()</span> {</span><br><span class="line">        Result&lt;T&gt; result = <span class="keyword">new</span> <span class="title class_">Result</span>&lt;T&gt;();</span><br><span class="line">        result.code = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="title function_">success</span><span class="params">(T object)</span> {</span><br><span class="line">        Result&lt;T&gt; result = <span class="keyword">new</span> <span class="title class_">Result</span>&lt;T&gt;();</span><br><span class="line">        result.data = object;</span><br><span class="line">        result.code = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="title function_">error</span><span class="params">(String msg)</span> {</span><br><span class="line">        <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Result</span>();</span><br><span class="line">        result.msg = msg;</span><br><span class="line">        result.code = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-2-3-controller-ceng">2.2.3 Controller层</span></h4><p>在sky-server模块中，com.sky.controller.admin.EmployeeController中添加分页查询方法。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 员工分页查询</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> employeePageQueryDTO</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@GetMapping("/page")</span></span><br><span class="line">   <span class="meta">@ApiOperation("员工分页查询")</span></span><br><span class="line">   <span class="keyword">public</span> Result&lt;PageResult&gt; <span class="title function_">page</span><span class="params">(EmployeePageQueryDTO employeePageQueryDTO)</span>{</span><br><span class="line">       log.info(<span class="string">"员工分页查询，参数为：{}"</span>, employeePageQueryDTO);</span><br><span class="line">       <span class="type">PageResult</span> <span class="variable">pageResult</span> <span class="operator">=</span> employeeService.pageQuery(employeePageQueryDTO);<span class="comment">//后续定义</span></span><br><span class="line">       <span class="keyword">return</span> Result.success(pageResult);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-2-4-service-ceng-jie-kou">2.2.4 Service层接口</span></h4><p>在EmployeeService接口中声明pageQuery方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 分页查询</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> employeePageQueryDTO</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   PageResult <span class="title function_">pageQuery</span><span class="params">(EmployeePageQueryDTO employeePageQueryDTO)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-2-5-service-ceng-shi-xian-lei">2.2.5 Service层实现类</span></h4><p>在EmployeeServiceImpl中实现pageQuery方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 分页查询</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> employeePageQueryDTO</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> PageResult <span class="title function_">pageQuery</span><span class="params">(EmployeePageQueryDTO employeePageQueryDTO)</span> {</span><br><span class="line">       <span class="comment">// select * from employee limit 0,10</span></span><br><span class="line">       <span class="comment">//开始分页查询</span></span><br><span class="line">       PageHelper.startPage(employeePageQueryDTO.getPage(), employeePageQueryDTO.getPageSize());</span><br><span class="line"></span><br><span class="line">       Page&lt;Employee&gt; page = employeeMapper.pageQuery(employeePageQueryDTO);<span class="comment">//后续定义</span></span><br><span class="line"></span><br><span class="line">       <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> page.getTotal();</span><br><span class="line">       List&lt;Employee&gt; records = page.getResult();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageResult</span>(total, records);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<p><strong>注意：</strong>此处使用 mybatis 的分页插件 PageHelper 来简化分页代码的开发。底层基于 mybatis 的拦截器实现。</p>
<p>故在pom.xml文中添加依赖(初始工程已添加)</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>${pagehelper}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-2-6-mapper-ceng">2.2.6 Mapper层</span></h4><p>在 EmployeeMapper 中声明 pageQuery 方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 分页查询</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> employeePageQueryDTO</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   Page&lt;Employee&gt; <span class="title function_">pageQuery</span><span class="params">(EmployeePageQueryDTO employeePageQueryDTO)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>在 src/main/resources/mapper/EmployeeMapper.xml 中编写SQL：</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&lt;</span><span class="keyword">select</span> id<span class="operator">=</span>"pageQuery" resultType<span class="operator">=</span>"com.sky.entity.Employee"<span class="operator">&gt;</span></span><br><span class="line">        <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employee</span><br><span class="line">        <span class="operator">&lt;</span><span class="keyword">where</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span>if test<span class="operator">=</span>"name != null and name != ''"<span class="operator">&gt;</span></span><br><span class="line">                <span class="keyword">and</span> name <span class="keyword">like</span> concat(<span class="string">'%'</span>,#{name},<span class="string">'%'</span>)</span><br><span class="line">            <span class="operator">&lt;</span><span class="operator">/</span>if<span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="operator">/</span><span class="keyword">where</span><span class="operator">&gt;</span></span><br><span class="line">        <span class="keyword">order</span> <span class="keyword">by</span> create_time <span class="keyword">desc</span></span><br><span class="line">    <span class="operator">&lt;</span><span class="operator">/</span><span class="keyword">select</span><span class="operator">&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-3-gong-neng-ce-shi">2.3 功能测试</span></h3><p>可以通过接口文档进行测试，也可以进行前后端联调测试。</p>
<p>接下来使用两种方式分别测试：</p>
<h4><span id="2-3-1-jie-kou-wen-dang-ce-shi">2.3.1 接口文档测试</span></h4><p><strong>重启服务：</strong>访问<a target="_blank" rel="noopener" href="http://localhost:8080/doc.html%EF%BC%8C%E8%BF%9B%E5%85%A5%E5%91%98%E5%B7%A5%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2">http://localhost:8080/doc.html，进入员工分页查询</a></p>
<img src="/2024/09/26/projection-skytogo/image-20221112101848657.png" alt="image-20221112101848657" style="zoom:67%;"> 

<p><strong>响应结果：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221112101946022.png" alt="image-20221112101946022" style="zoom:50%;"> 



<h4><span id="2-3-2-qian-hou-duan-lian-diao-ce-shi">2.3.2 前后端联调测试</span></h4><p><strong>点击员工管理</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221112102441810.png" alt="image-20221112102441810" style="zoom:50%;">  



<p><strong>输入员工姓名为zhangsan</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221112102540938.png" alt="image-20221112102540938" style="zoom:50%;"> 

<p>不难发现，<strong>最后操作时间格式</strong>不清晰，在<strong>代码完善</strong>中解决。</p>
<img src="/2024/09/26/projection-skytogo/image-20221112102745437.png" alt="image-20221112102745437" style="zoom:50%;"> 



<h3><span id="2-4-dai-ma-wan-shan">2.4 代码完善</span></h3><p><strong>问题描述：</strong>操作时间字段显示有问题。</p>
<img src="/2024/09/26/projection-skytogo/image-20221112103235539.png" alt="image-20221112103235539" style="zoom:50%;"> 



<p><strong>解决方式：</strong></p>
<p><strong>1).  方式一</strong></p>
<p>在属性上加上注解，对日期进行格式化</p>
<img src="/2024/09/26/projection-skytogo/image-20221112103501581.png" alt="image-20221112103501581" style="zoom:67%;"> 

<p>但这种方式，需要在每个时间属性上都要加上该注解，使用较麻烦，不能全局处理。</p>
<p><strong>2).  方式二（推荐 )</strong></p>
<p>在WebMvcConfiguration中扩展SpringMVC的消息转换器，统一对日期类型进行格式处理</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 扩展Spring MVC框架的消息转化器</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> converters</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">extendMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> {</span><br><span class="line">       log.info(<span class="string">"扩展消息转换器..."</span>);</span><br><span class="line">       <span class="comment">//创建一个消息转换器对象</span></span><br><span class="line">       <span class="type">MappingJackson2HttpMessageConverter</span> <span class="variable">converter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>();</span><br><span class="line">       <span class="comment">//需要为消息转换器设置一个对象转换器，对象转换器可以将Java对象序列化为json数据</span></span><br><span class="line">       converter.setObjectMapper(<span class="keyword">new</span> <span class="title class_">JacksonObjectMapper</span>());</span><br><span class="line">       <span class="comment">//将自己的消息转化器加入容器中</span></span><br><span class="line">       converters.add(<span class="number">0</span>,converter);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<p>添加后，再次测试</p>
<img src="/2024/09/26/projection-skytogo/image-20221112104305608.png" alt="image-20221112104305608" style="zoom:67%;"> 

<p>时间格式定义，sky-common模块中</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.json;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JacksonObjectMapper</span> <span class="keyword">extends</span> <span class="title class_">ObjectMapper</span> {</span><br><span class="line"></span><br><span class="line">	<span class="comment">//.......</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_DATE_TIME_FORMAT</span> <span class="operator">=</span> <span class="string">"yyyy-MM-dd HH:mm"</span>;</span><br><span class="line">    <span class="comment">//.......</span></span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3><span id="2-5-dai-ma-ti-jiao">2.5 代码提交</span></h3><img src="/2024/09/26/projection-skytogo/image-20221112105011214.png" alt="image-20221112105011214" style="zoom:50%;"> 

<p>后续步骤和新增员工代码提交一致，不再赘述。</p>
<h2><span id="3-qi-yong-jin-yong-yuan-gong-zhang-hao">3. 启用禁用员工账号</span></h2><h3><span id="3-1-xu-qiu-fen-xi-yu-she-ji">3.1 需求分析与设计</span></h3><h4><span id="3-1-1-chan-pin-yuan-xing">3.1.1 产品原型</span></h4><p>在员工管理列表页面，可以对某个员工账号进行启用或者禁用操作。账号禁用的员工不能登录系统，启用后的员工可以正常登录。如果某个员工账号状态为正常，则按钮显示为 “禁用”，如果员工账号状态为已禁用，则按钮显示为”启用”。</p>
<p><strong>启禁用员工原型：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221112112359233.png" alt="image-20221112112359233" style="zoom:67%;"> 

<p><strong>业务规则：</strong></p>
<ul>
<li>可以对状态为“启用” 的员工账号进行“禁用”操作</li>
<li>可以对状态为“禁用”的员工账号进行“启用”操作</li>
<li>状态为“禁用”的员工账号不能登录系统</li>
</ul>
<h4><span id="3-1-2-jie-kou-she-ji">3.1.2 接口设计</span></h4><p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221112112728333.png" alt="image-20221112112728333" style="zoom:50%;"><img src="/2024/09/26/projection-skytogo/image-20221112112739680.png" alt="image-20221112112739680" style="zoom:50%;"></p>
<p>1). 路径参数携带状态值。</p>
<p>2). 同时，把id传递过去，明确对哪个用户进行操作。</p>
<p>3). 返回数据code状态是必须，其它是非必须。</p>
<h3><span id="3-2-dai-ma-kai-fa">3.2 代码开发</span></h3><h4><span id="3-2-1-controller-ceng">3.2.1 Controller层</span></h4><p>在sky-server模块中，根据接口设计中的请求参数形式对应的在 EmployeeController 中创建启用禁用员工账号的方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 启用禁用员工账号</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@PostMapping("/status/{status}")</span></span><br><span class="line">   <span class="meta">@ApiOperation("启用禁用员工账号")</span></span><br><span class="line">   <span class="keyword">public</span> Result <span class="title function_">startOrStop</span><span class="params">(<span class="meta">@PathVariable</span> Integer status,Long id)</span>{</span><br><span class="line">       log.info(<span class="string">"启用禁用员工账号：{},{}"</span>,status,id);</span><br><span class="line">       employeeService.startOrStop(status,id);<span class="comment">//后绪步骤定义</span></span><br><span class="line">       <span class="keyword">return</span> Result.success();</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-2-2-service-ceng-jie-kou">3.2.2 Service层接口</span></h4><p>在 EmployeeService 接口中声明启用禁用员工账号的业务方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 启用禁用员工账号</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">startOrStop</span><span class="params">(Integer status, Long id)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-2-3-service-ceng-shi-xian-lei">3.2.3 Service层实现类</span></h4><p>在 EmployeeServiceImpl 中实现启用禁用员工账号的业务方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 启用禁用员工账号</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startOrStop</span><span class="params">(Integer status, Long id)</span> {</span><br><span class="line">       <span class="type">Employee</span> <span class="variable">employee</span> <span class="operator">=</span> Employee.builder()</span><br><span class="line">               .status(status)</span><br><span class="line">               .id(id)</span><br><span class="line">               .build();</span><br><span class="line"></span><br><span class="line">       employeeMapper.update(employee);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-2-4-mapper-ceng">3.2.4 Mapper层</span></h4><p>在 EmployeeMapper 接口中声明 update 方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据主键动态修改属性</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> employee</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Employee employee)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>在 EmployeeMapper.xml 中编写SQL：</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&lt;</span><span class="keyword">update</span> id<span class="operator">=</span>"update" parameterType<span class="operator">=</span>"Employee"<span class="operator">&gt;</span></span><br><span class="line">        <span class="keyword">update</span> employee</span><br><span class="line">        <span class="operator">&lt;</span><span class="keyword">set</span><span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span>if test<span class="operator">=</span>"name != null"<span class="operator">&gt;</span>name <span class="operator">=</span> #{name},<span class="operator">&lt;</span><span class="operator">/</span>if<span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span>if test<span class="operator">=</span>"username != null"<span class="operator">&gt;</span>username <span class="operator">=</span> #{username},<span class="operator">&lt;</span><span class="operator">/</span>if<span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span>if test<span class="operator">=</span>"password != null"<span class="operator">&gt;</span>password <span class="operator">=</span> #{password},<span class="operator">&lt;</span><span class="operator">/</span>if<span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span>if test<span class="operator">=</span>"phone != null"<span class="operator">&gt;</span>phone <span class="operator">=</span> #{phone},<span class="operator">&lt;</span><span class="operator">/</span>if<span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span>if test<span class="operator">=</span>"sex != null"<span class="operator">&gt;</span>sex <span class="operator">=</span> #{sex},<span class="operator">&lt;</span><span class="operator">/</span>if<span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span>if test<span class="operator">=</span>"idNumber != null"<span class="operator">&gt;</span>id_Number <span class="operator">=</span> #{idNumber},<span class="operator">&lt;</span><span class="operator">/</span>if<span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span>if test<span class="operator">=</span>"updateTime != null"<span class="operator">&gt;</span>update_Time <span class="operator">=</span> #{updateTime},<span class="operator">&lt;</span><span class="operator">/</span>if<span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span>if test<span class="operator">=</span>"updateUser != null"<span class="operator">&gt;</span>update_User <span class="operator">=</span> #{updateUser},<span class="operator">&lt;</span><span class="operator">/</span>if<span class="operator">&gt;</span></span><br><span class="line">            <span class="operator">&lt;</span>if test<span class="operator">=</span>"status != null"<span class="operator">&gt;</span>status <span class="operator">=</span> #{status},<span class="operator">&lt;</span><span class="operator">/</span>if<span class="operator">&gt;</span></span><br><span class="line">        <span class="operator">&lt;</span><span class="operator">/</span><span class="keyword">set</span><span class="operator">&gt;</span></span><br><span class="line">        <span class="keyword">where</span> id <span class="operator">=</span> #{id}</span><br><span class="line">    <span class="operator">&lt;</span><span class="operator">/</span><span class="keyword">update</span><span class="operator">&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-3-gong-neng-ce-shi">3.3 功能测试</span></h3><h4><span id="3-3-1-jie-kou-wen-dang-ce-shi">3.3.1 接口文档测试</span></h4><p><strong>测试前，</strong>查询employee表中员工账号状态</p>
<img src="/2024/09/26/projection-skytogo/image-20221112143142457.png" alt="image-20221112143142457" style="zoom:67%;"> 

<p><strong>开始测试</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221112143316357.png" alt="image-20221112143316357" style="zoom:50%;"> 

<p><strong>测试完毕后</strong>，再次查询员工账号状态</p>
<img src="/2024/09/26/projection-skytogo/image-20221112143428676.png" alt="image-20221112143428676" style="zoom: 67%;"> 



<h4><span id="3-3-2-qian-hou-duan-lian-diao-ce-shi">3.3.2 前后端联调测试</span></h4><p><strong>测试前：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221112143552246.png" alt="image-20221112143552246" style="zoom: 33%;"> 

<p><strong>点击启用:</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221112143655318.png" alt="image-20221112143655318" style="zoom:33%;"> 



<h3><span id="3-4-dai-ma-ti-jiao">3.4 代码提交</span></h3><img src="/2024/09/26/projection-skytogo/image-20221112143827631.png" alt="image-20221112143827631" style="zoom:50%;"> 

<p>后续步骤和上述功能代码提交一致，不再赘述。</p>
<h2><span id="4-bian-ji-yuan-gong">4. 编辑员工</span></h2><h3><span id="4-1-xu-qiu-fen-xi-yu-she-ji">4.1 需求分析与设计</span></h3><h4><span id="4-1-1-chan-pin-yuan-xing">4.1.1 产品原型</span></h4><p>在员工管理列表页面点击 “编辑” 按钮，跳转到编辑页面，在编辑页面回显员工信息并进行修改，最后点击 “保存” 按钮完成编辑操作。</p>
<p><strong>员工列表原型：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221112144731759.png" alt="image-20221112144731759" style="zoom: 67%;"> 

<p><strong>修改页面原型</strong>：</p>
<p>注：点击修改时，数据应该正常回显到修改页面。</p>
<img src="/2024/09/26/projection-skytogo/image-20221112144842825.png" alt="image-20221112144842825" style="zoom: 67%;"> 



<h4><span id="4-1-2-jie-kou-she-ji">4.1.2 接口设计</span></h4><p>根据上述原型图分析，编辑员工功能涉及到两个接口：</p>
<ul>
<li>根据id查询员工信息</li>
<li>编辑员工信息</li>
</ul>
<p><strong>1). 根据id查询员工信息</strong></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221112145607939.png" alt="image-20221112145607939" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221112145619775.png" alt="image-20221112145619775" style="zoom:50%;"></p>
<p><strong>2). 编辑员工信息</strong></p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221112145643769.png" alt="image-20221112145643769" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/image-20221112145659035.png" alt="image-20221112145659035" style="zoom:50%;"></p>
<p><strong>注:因为是修改功能，请求方式可设置为PUT。</strong></p>
<h3><span id="4-2-dai-ma-kai-fa">4.2 代码开发</span></h3><h4><span id="4-2-1-hui-xian-yuan-gong-xin-xi-gong-neng">4.2.1 回显员工信息功能</span></h4><p><strong>1). Controller层</strong></p>
<p>在 EmployeeController 中创建 getById 方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据id查询员工信息</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@GetMapping("/{id}")</span></span><br><span class="line">   <span class="meta">@ApiOperation("根据id查询员工信息")</span></span><br><span class="line">   <span class="keyword">public</span> Result&lt;Employee&gt; <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span>{</span><br><span class="line">       <span class="type">Employee</span> <span class="variable">employee</span> <span class="operator">=</span> employeeService.getById(id);</span><br><span class="line">       <span class="keyword">return</span> Result.success(employee);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<p><strong>2). Service层接口</strong></p>
<p>在 EmployeeService 接口中声明 getById 方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据id查询员工</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Employee <span class="title function_">getById</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></tbody></table></figure>



<p><strong>3). Service层实现类</strong></p>
<p>在 EmployeeServiceImpl 中实现 getById 方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 根据id查询员工</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> Employee <span class="title function_">getById</span><span class="params">(Long id)</span> {</span><br><span class="line">      <span class="type">Employee</span> <span class="variable">employee</span> <span class="operator">=</span> employeeMapper.getById(id);</span><br><span class="line">      employee.setPassword(<span class="string">"****"</span>);</span><br><span class="line">      <span class="keyword">return</span> employee;</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure>



<p><strong>4). Mapper层</strong></p>
<p>在 EmployeeMapper 接口中声明 getById 方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据id查询员工信息</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Select("select * from employee where id = #{id}")</span></span><br><span class="line">   Employee <span class="title function_">getById</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="4-2-2-xiu-gai-yuan-gong-xin-xi-gong-neng">4.2.2 修改员工信息功能</span></h4><p><strong>1). Controller层</strong></p>
<p>在 EmployeeController 中创建 update 方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 编辑员工信息</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> employeeDTO</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@PutMapping</span></span><br><span class="line">   <span class="meta">@ApiOperation("编辑员工信息")</span></span><br><span class="line">   <span class="keyword">public</span> Result <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> EmployeeDTO employeeDTO)</span>{</span><br><span class="line">       log.info(<span class="string">"编辑员工信息：{}"</span>, employeeDTO);</span><br><span class="line">       employeeService.update(employeeDTO);</span><br><span class="line">       <span class="keyword">return</span> Result.success();</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<p><strong>2). Service层接口</strong></p>
<p>在 EmployeeService 接口中声明 update 方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 编辑员工信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> employeeDTO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">update</span><span class="params">(EmployeeDTO employeeDTO)</span>;</span><br></pre></td></tr></tbody></table></figure>



<p><strong>3). Service层实现类</strong></p>
<p>在 EmployeeServiceImpl 中实现 update 方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 编辑员工信息</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> employeeDTO</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(EmployeeDTO employeeDTO)</span> {</span><br><span class="line">      <span class="type">Employee</span> <span class="variable">employee</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Employee</span>();</span><br><span class="line">      BeanUtils.copyProperties(employeeDTO, employee);</span><br><span class="line"></span><br><span class="line">      employee.setUpdateTime(LocalDateTime.now());</span><br><span class="line">      employee.setUpdateUser(BaseContext.getCurrentId());</span><br><span class="line"></span><br><span class="line">      employeeMapper.update(employee);</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure>

<p>在实现<strong>启用禁用员工账号</strong>功能时，已实现employeeMapper.update(employee)，在此不需写Mapper层代码。</p>
<h3><span id="4-3-gong-neng-ce-shi">4.3 功能测试</span></h3><h4><span id="4-3-1-jie-kou-wen-dang-ce-shi">4.3.1 接口文档测试</span></h4><p>分别测试<strong>根据id查询员工信息</strong>和<strong>编辑员工信息</strong>两个接口</p>
<p><strong>1). 根据id查询员工信息</strong></p>
<p>查询employee表中的数据，以id=4的记录为例</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221112154253995.png" alt="image-20221112154253995"></p>
<p>开始测试</p>
<img src="/2024/09/26/projection-skytogo/image-20221112154411245.png" alt="image-20221112154411245" style="zoom:50%;"> 

<p>获取到了id=4的相关员工信息</p>
<p><strong>2). 编辑员工信息</strong></p>
<p>修改id=4的员工信息，<strong>name</strong>由<strong>zhangsan</strong>改为<strong>张三丰</strong>，<strong>username</strong>由<strong>张三</strong>改为<strong>zhangsanfeng</strong>。</p>
 <img src="/2024/09/26/projection-skytogo/image-20221112155001414.png" alt="image-20221112155001414" style="zoom:50%;"> 

<p>查看employee表数据</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221112155029547.png" alt="image-20221112155029547"></p>
<h4><span id="4-3-2-qian-hou-duan-lian-diao-ce-shi">4.3.2 前后端联调测试</span></h4><p>进入到员工列表查询</p>
<img src="/2024/09/26/projection-skytogo/image-20221112155206712.png" alt="image-20221112155206712" style="zoom:50%;"> 

<p>对员工姓名为杰克的员工数据修改，点击修改，数据已回显</p>
<img src="/2024/09/26/projection-skytogo/image-20221112155430652.png" alt="image-20221112155430652" style="zoom:50%;"> 

<p>修改后，点击保存</p>
<img src="/2024/09/26/projection-skytogo/image-20221112155559298.png" alt="image-20221112155559298" style="zoom:50%;"> 

<h3><span id="4-4-dai-ma-ti-jiao">4.4 代码提交</span></h3><img src="/2024/09/26/projection-skytogo/image-20221112155735984.png" alt="image-20221112155735984" style="zoom:50%;"> 

<p>后续步骤和上述功能代码提交一致，不再赘述。</p>
<h2><span id="5-dao-ru-fen-lei-mo-kuai-gong-neng-dai-ma">5. 导入分类模块功能代码</span></h2><h3><span id="5-1-xu-qiu-fen-xi-yu-she-ji">5.1 需求分析与设计</span></h3><h4><span id="5-1-1-chan-pin-yuan-xing">5.1.1 产品原型</span></h4><p>后台系统中可以管理分类信息，分类包括两种类型，分别是 <strong>菜品分类</strong> 和 <strong>套餐分类</strong> 。</p>
<p>先来分析<strong>菜品分类</strong>相关功能。</p>
<p><strong>新增菜品分类：</strong>当我们在后台系统中添加菜品时需要选择一个菜品分类，在移动端也会按照菜品分类来展示对应的菜品。</p>
<p><strong>菜品分类分页查询：</strong>系统中的分类很多的时候，如果在一个页面中全部展示出来会显得比较乱，不便于查看，所以一般的系统中都会以分页的方式来展示列表数据。</p>
<p><strong>根据id删除菜品分类：</strong>在分类管理列表页面，可以对某个分类进行删除操作。需要注意的是当分类关联了菜品或者套餐时，此分类不允许删除。</p>
<p><strong>修改菜品分类：</strong>在分类管理列表页面点击修改按钮，弹出修改窗口，在修改窗口回显分类信息并进行修改，最后点击确定按钮完成修改操作。</p>
<p><strong>启用禁用菜品分类：</strong>在分类管理列表页面，可以对某个分类进行启用或者禁用操作。</p>
<p><strong>分类类型查询：</strong>当点击分类类型下拉框时，从数据库中查询所有的菜品分类数据进行展示。</p>
<p><strong>分类管理原型：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221112160907419.png" alt="image-20221112160907419" style="zoom:50%;"> 

<p><strong>业务规则：</strong></p>
<ul>
<li>分类名称必须是唯一的</li>
<li>分类按照类型可以分为菜品分类和套餐分类</li>
<li>新添加的分类状态默认为“禁用”</li>
</ul>
<h4><span id="5-1-2-jie-kou-she-ji">5.1.2 接口设计</span></h4><p>根据上述原型图分析，菜品分类模块共涉及6个接口。</p>
<ul>
<li>新增分类</li>
<li>分类分页查询</li>
<li>根据id删除分类</li>
<li>修改分类</li>
<li>启用禁用分类</li>
<li>根据类型查询分类</li>
</ul>
<p>接下来，详细地分析每个接口。</p>
<p>找到资料–&gt;项目接口文档–&gt;苍穹外卖-管理端接口.html</p>
<p><strong>1). 新增分类</strong></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221112163011291.png" alt="image-20221112163011291" style="zoom: 67%;"> <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221112163044547.png" alt="image-20221112163044547" style="zoom:67%;"></p>
<p><strong>2). 分类分页查询</strong></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221112163209383.png" alt="image-20221112163209383" style="zoom:50%;"><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221112163233212.png" alt="image-20221112163233212" style="zoom:50%;"></p>
<p><strong>3). 根据id删除分类</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221112163323554.png" alt="image-20221112163323554" style="zoom:50%;"> 

<p><strong>4). 修改分类</strong></p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221112163424457.png" alt="image-20221112163424457" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/image-20221112163445296.png" alt="image-20221112163445296" style="zoom:50%;"></p>
<p><strong>5). 启用禁用分类</strong></p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221112163557247.png" alt="image-20221112163557247" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/image-20221112163622896.png" alt="image-20221112163622896" style="zoom:50%;"></p>
<p><strong>6). 根据类型查询分类</strong></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221112163806318.png" alt="image-20221112163806318" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221112163839168.png" alt="image-20221112163839168" style="zoom:50%;"></p>
<h4><span id="5-1-3-biao-she-ji">5.1.3 表设计</span></h4><p><strong>category表结构：</strong></p>
<table>
<thead>
<tr>
<th><strong>字段名</strong></th>
<th><strong>数据类型</strong></th>
<th><strong>说明</strong></th>
<th><strong>备注</strong></th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>bigint</td>
<td>主键</td>
<td>自增</td>
</tr>
<tr>
<td>name</td>
<td>varchar(32)</td>
<td>分类名称</td>
<td>唯一</td>
</tr>
<tr>
<td>type</td>
<td>int</td>
<td>分类类型</td>
<td>1菜品分类 2套餐分类</td>
</tr>
<tr>
<td>sort</td>
<td>int</td>
<td>排序字段</td>
<td>用于分类数据的排序</td>
</tr>
<tr>
<td>status</td>
<td>int</td>
<td>状态</td>
<td>1启用 0禁用</td>
</tr>
<tr>
<td>create_time</td>
<td>datetime</td>
<td>创建时间</td>
<td></td>
</tr>
<tr>
<td>update_time</td>
<td>datetime</td>
<td>最后修改时间</td>
<td></td>
</tr>
<tr>
<td>create_user</td>
<td>bigint</td>
<td>创建人id</td>
<td></td>
</tr>
<tr>
<td>update_user</td>
<td>bigint</td>
<td>最后修改人id</td>
<td></td>
</tr>
</tbody></table>
<h3><span id="5-2-dai-ma-dao-ru">5.2 代码导入</span></h3><p>导入资料中的分类管理模块功能代码即可</p>
<img src="/2024/09/26/projection-skytogo/image-20221112164259732.png" alt="image-20221112164259732" style="zoom:50%;"> 

<p>可按照mapper–&gt;service–&gt;controller依次导入，这样代码不会显示相应的报错。</p>
<p>进入到sky-server模块中</p>
<h4><span id="5-2-1-mapper-ceng">5.2.1 Mapper层</span></h4><p><strong>DishMapper.java</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DishMapper</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据分类id查询菜品数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> categoryId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Select("select count(id) from dish where category_id = #{categoryId}")</span></span><br><span class="line">    Integer <span class="title function_">countByCategoryId</span><span class="params">(Long categoryId)</span>;</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p><strong>SetmealMapper.java</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SetmealMapper</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据分类id查询套餐的数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Select("select count(id) from setmeal where category_id = #{categoryId}")</span></span><br><span class="line">    Integer <span class="title function_">countByCategoryId</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>CategoryMapper.java</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.CategoryPageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Category;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Delete;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Insert;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CategoryMapper</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> category</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Insert("insert into category(type, name, sort, status, create_time, update_time, create_user, update_user)" +</span></span><br><span class="line"><span class="meta">            " VALUES" +</span></span><br><span class="line"><span class="meta">            " (#{type}, #{name}, #{sort}, #{status}, #{createTime}, #{updateTime}, #{createUser}, #{updateUser})")</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(Category category)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分页查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> categoryPageQueryDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Page&lt;Category&gt; <span class="title function_">pageQuery</span><span class="params">(CategoryPageQueryDTO categoryPageQueryDTO)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id删除分类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Delete("delete from category where id = #{id}")</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteById</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id修改分类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> category</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Category category)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据类型查询分类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;Category&gt; <span class="title function_">list</span><span class="params">(Integer type)</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>CategoryMapper.xml</strong>,进入到resources/mapper目录下</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span></span><br><span class="line"><span class="meta">        <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.sky.mapper.CategoryMapper"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"pageQuery"</span> <span class="attr">resultType</span>=<span class="string">"com.sky.entity.Category"</span>&gt;</span></span><br><span class="line">        select * from category</span><br><span class="line">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"name != null and name != ''"</span>&gt;</span></span><br><span class="line">                and name like concat('%',#{name},'%')</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"type != null"</span>&gt;</span></span><br><span class="line">                and type = #{type}</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">        order by sort asc , create_time desc</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"update"</span> <span class="attr">parameterType</span>=<span class="string">"Category"</span>&gt;</span></span><br><span class="line">        update category</span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"type != null"</span>&gt;</span></span><br><span class="line">                type = #{type},</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"name != null"</span>&gt;</span></span><br><span class="line">                name = #{name},</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"sort != null"</span>&gt;</span></span><br><span class="line">                sort = #{sort},</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"status != null"</span>&gt;</span></span><br><span class="line">                status = #{status},</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"updateTime != null"</span>&gt;</span></span><br><span class="line">                update_time = #{updateTime},</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"updateUser != null"</span>&gt;</span></span><br><span class="line">                update_user = #{updateUser}</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"list"</span> <span class="attr">resultType</span>=<span class="string">"Category"</span>&gt;</span></span><br><span class="line">        select * from category</span><br><span class="line">        where status = 1</span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"type != null"</span>&gt;</span></span><br><span class="line">            and type = #{type}</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        order by sort asc,create_time desc</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="5-2-2-service-ceng">5.2.2 Service层</span></h4><p><strong>CategoryService.java</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.dto.CategoryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.CategoryPageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Category;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.PageResult;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CategoryService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增分类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> categoryDTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(CategoryDTO categoryDTO)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分页查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> categoryPageQueryDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    PageResult <span class="title function_">pageQuery</span><span class="params">(CategoryPageQueryDTO categoryPageQueryDTO)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id删除分类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteById</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改分类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> categoryDTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(CategoryDTO categoryDTO)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启用、禁用分类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">startOrStop</span><span class="params">(Integer status, Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据类型查询分类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;Category&gt; <span class="title function_">list</span><span class="params">(Integer type)</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p><strong>EmployeeServiceImpl.java</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.Page;</span><br><span class="line"><span class="keyword">import</span> com.github.pagehelper.PageHelper;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.MessageConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.PasswordConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.StatusConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.context.BaseContext;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeeLoginDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.EmployeePageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Employee;</span><br><span class="line"><span class="keyword">import</span> com.sky.exception.AccountLockedException;</span><br><span class="line"><span class="keyword">import</span> com.sky.exception.AccountNotFoundException;</span><br><span class="line"><span class="keyword">import</span> com.sky.exception.PasswordErrorException;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.EmployeeMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.EmployeeService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.DigestUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmployeeServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">EmployeeService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmployeeMapper employeeMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 员工登录</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> employeeLoginDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Employee <span class="title function_">login</span><span class="params">(EmployeeLoginDTO employeeLoginDTO)</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> employeeLoginDTO.getUsername();</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> employeeLoginDTO.getPassword();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1、根据用户名查询数据库中的数据</span></span><br><span class="line">        <span class="type">Employee</span> <span class="variable">employee</span> <span class="operator">=</span> employeeMapper.getByUsername(username);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、处理各种异常情况（用户名不存在、密码不对、账号被锁定）</span></span><br><span class="line">        <span class="keyword">if</span> (employee == <span class="literal">null</span>) {</span><br><span class="line">            <span class="comment">//账号不存在</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AccountNotFoundException</span>(MessageConstant.ACCOUNT_NOT_FOUND);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//密码比对</span></span><br><span class="line">        <span class="comment">// TODO 后期需要进行md5加密，然后再进行比对</span></span><br><span class="line">        password = DigestUtils.md5DigestAsHex(password.getBytes());</span><br><span class="line">        <span class="keyword">if</span> (!password.equals(employee.getPassword())) {</span><br><span class="line">            <span class="comment">//密码错误</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PasswordErrorException</span>(MessageConstant.PASSWORD_ERROR);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (employee.getStatus() == StatusConstant.DISABLE) {</span><br><span class="line">            <span class="comment">//账号被锁定</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AccountLockedException</span>(MessageConstant.ACCOUNT_LOCKED);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3、返回实体对象</span></span><br><span class="line">        <span class="keyword">return</span> employee;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增员工</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> employeeDTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(EmployeeDTO employeeDTO)</span> {</span><br><span class="line">        <span class="type">Employee</span> <span class="variable">employee</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Employee</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//对象属性拷贝</span></span><br><span class="line">        BeanUtils.copyProperties(employeeDTO, employee);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置账号的状态，默认正常状态 1表示正常 0表示锁定</span></span><br><span class="line">        employee.setStatus(StatusConstant.ENABLE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置密码，默认密码123456</span></span><br><span class="line">        employee.setPassword(DigestUtils.md5DigestAsHex(PasswordConstant.DEFAULT_PASSWORD.getBytes()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置当前记录的创建时间和修改时间</span></span><br><span class="line">        employee.setCreateTime(LocalDateTime.now());</span><br><span class="line">        employee.setUpdateTime(LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置当前记录创建人id和修改人id</span></span><br><span class="line">        employee.setCreateUser(BaseContext.getCurrentId());<span class="comment">//目前写个假数据，后期修改</span></span><br><span class="line">        employee.setUpdateUser(BaseContext.getCurrentId());</span><br><span class="line"></span><br><span class="line">        employeeMapper.insert(employee);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分页查询</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> employeePageQueryDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> PageResult <span class="title function_">pageQuery</span><span class="params">(EmployeePageQueryDTO employeePageQueryDTO)</span> {</span><br><span class="line">        <span class="comment">// select * from employee limit 0,10</span></span><br><span class="line">        <span class="comment">//开始分页查询</span></span><br><span class="line">        PageHelper.startPage(employeePageQueryDTO.getPage(), employeePageQueryDTO.getPageSize());</span><br><span class="line"></span><br><span class="line">        Page&lt;Employee&gt; page = employeeMapper.pageQuery(employeePageQueryDTO);</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> page.getTotal();</span><br><span class="line">        List&lt;Employee&gt; records = page.getResult();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageResult</span>(total, records);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启用禁用员工账号</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startOrStop</span><span class="params">(Integer status, Long id)</span> {</span><br><span class="line">        <span class="type">Employee</span> <span class="variable">employee</span> <span class="operator">=</span> Employee.builder()</span><br><span class="line">                .status(status)</span><br><span class="line">                .id(id)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        employeeMapper.update(employee);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询员工</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Employee <span class="title function_">getById</span><span class="params">(Long id)</span> {</span><br><span class="line">        <span class="type">Employee</span> <span class="variable">employee</span> <span class="operator">=</span> employeeMapper.getById(id);</span><br><span class="line">        employee.setPassword(<span class="string">"****"</span>);</span><br><span class="line">        <span class="keyword">return</span> employee;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 编辑员工信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> employeeDTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(EmployeeDTO employeeDTO)</span> {</span><br><span class="line">        <span class="type">Employee</span> <span class="variable">employee</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Employee</span>();</span><br><span class="line">        BeanUtils.copyProperties(employeeDTO, employee);</span><br><span class="line"></span><br><span class="line">        employee.setUpdateTime(LocalDateTime.now());</span><br><span class="line">        employee.setUpdateUser(BaseContext.getCurrentId());</span><br><span class="line"></span><br><span class="line">        employeeMapper.update(employee);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="5-2-3-controller-ceng">5.2.3 Controller层</span></h4><p><strong>CategoryController.java</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.dto.CategoryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.CategoryPageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Category;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.CategoryService;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 分类管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/admin/category")</span></span><br><span class="line"><span class="meta">@Api(tags = "分类相关接口")</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CategoryController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CategoryService categoryService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增分类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> categoryDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="meta">@ApiOperation("新增分类")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> CategoryDTO categoryDTO)</span>{</span><br><span class="line">        log.info(<span class="string">"新增分类：{}"</span>, categoryDTO);</span><br><span class="line">        categoryService.save(categoryDTO);</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分类分页查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> categoryPageQueryDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping("/page")</span></span><br><span class="line">    <span class="meta">@ApiOperation("分类分页查询")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;PageResult&gt; <span class="title function_">page</span><span class="params">(CategoryPageQueryDTO categoryPageQueryDTO)</span>{</span><br><span class="line">        log.info(<span class="string">"分页查询：{}"</span>, categoryPageQueryDTO);</span><br><span class="line">        <span class="type">PageResult</span> <span class="variable">pageResult</span> <span class="operator">=</span> categoryService.pageQuery(categoryPageQueryDTO);</span><br><span class="line">        <span class="keyword">return</span> Result.success(pageResult);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除分类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@DeleteMapping</span></span><br><span class="line">    <span class="meta">@ApiOperation("删除分类")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">deleteById</span><span class="params">(Long id)</span>{</span><br><span class="line">        log.info(<span class="string">"删除分类：{}"</span>, id);</span><br><span class="line">        categoryService.deleteById(id);</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改分类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> categoryDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PutMapping</span></span><br><span class="line">    <span class="meta">@ApiOperation("修改分类")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> CategoryDTO categoryDTO)</span>{</span><br><span class="line">        categoryService.update(categoryDTO);</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启用、禁用分类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping("/status/{status}")</span></span><br><span class="line">    <span class="meta">@ApiOperation("启用禁用分类")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">startOrStop</span><span class="params">(<span class="meta">@PathVariable("status")</span> Integer status, Long id)</span>{</span><br><span class="line">        categoryService.startOrStop(status,id);</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据类型查询分类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping("/list")</span></span><br><span class="line">    <span class="meta">@ApiOperation("根据类型查询分类")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;List&lt;Category&gt;&gt; <span class="title function_">list</span><span class="params">(Integer type)</span>{</span><br><span class="line">        List&lt;Category&gt; list = categoryService.list(type);</span><br><span class="line">        <span class="keyword">return</span> Result.success(list);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>全部导入完毕后，进行编译</p>
<img src="/2024/09/26/projection-skytogo/image-20221112170742400.png" alt="image-20221112170742400" style="zoom:50%;"> 

<h3><span id="5-3-gong-neng-ce-shi">5.3 功能测试</span></h3><p>重启服务，访问<a href="http://localhost:80,进入分类管理">http://localhost:80,进入分类管理</a></p>
<p><strong>分页查询：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221112171252992.png" alt="image-20221112171252992" style="zoom:50%;"> 

<p><strong>分类类型：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221112171402210.png" alt="image-20221112171402210" style="zoom:50%;"> 

<p><strong>启用禁用：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221112171604991.png" alt="image-20221112171604991" style="zoom:50%;"> 

<p>点击禁用</p>
<img src="/2024/09/26/projection-skytogo/image-20221112171700774.png" alt="image-20221112171700774" style="zoom:50%;"> 

<p><strong>修改：</strong></p>
<p>回显</p>
<img src="/2024/09/26/projection-skytogo/image-20221112172117834.png" alt="image-20221112172117834" style="zoom:50%;">  

<p>修改后</p>
<img src="/2024/09/26/projection-skytogo/image-20221112172150709.png" alt="image-20221112172150709" style="zoom:50%;">

<p><strong>新增：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221112172356093.png" alt="image-20221112172356093" style="zoom:50%;"> 

<p>点击确定，查询列表</p>
<img src="/2024/09/26/projection-skytogo/image-20221112172439370.png" alt="image-20221112172439370" style="zoom:50%;"> 

<p><strong>删除：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221112172525216.png" alt="image-20221112172525216" style="zoom:50%;"> 

<p>删除后，查询分类列表</p>
<img src="/2024/09/26/projection-skytogo/image-20221112172611754.png" alt="image-20221112172611754" style="zoom:50%;"> 

<p>删除成功</p>
<h3><span id="5-4-dai-ma-ti-jiao">5.4 代码提交</span></h3><img src="/2024/09/26/projection-skytogo/image-20221112173205048.png" alt="image-20221112173205048" style="zoom:50%;"> 

<p>后续步骤和上述功能代码提交一致，不再赘述。</p>
<h1><span id="cang-qiong-wai-mai-day03">苍穹外卖-day03</span></h1><h2><span id="ke-cheng-nei-rong">课程内容</span></h2><ul>
<li>公共字段自动填充</li>
<li>新增菜品</li>
<li>菜品分页查询</li>
<li>删除菜品</li>
<li>修改菜品</li>
</ul>
<p><strong>功能实现：</strong>菜品管理</p>
<p><strong>菜品管理效果图：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221121142133307.png" alt="image-20221121142133307" style="zoom:50%;"> 





<h2><span id="1-gong-gong-zi-duan-zi-dong-tian-chong">1. 公共字段自动填充</span></h2><h3><span id="1-1-wen-ti-fen-xi">1.1 问题分析</span></h3><p>在上一章节我们已经完成了后台系统的<strong>员工管理功能</strong>和<strong>菜品分类功能</strong>的开发，在<strong>新增员工</strong>或者<strong>新增菜品分类</strong>时需要设置创建时间、创建人、修改时间、修改人等字段，在<strong>编辑员工</strong>或者<strong>编辑菜品分类</strong>时需要设置修改时间、修改人等字段。这些字段属于公共字段，也就是也就是在我们的系统中很多表中都会有这些字段，如下：</p>
<table>
<thead>
<tr>
<th><strong>序号</strong></th>
<th><strong>字段名</strong></th>
<th><strong>含义</strong></th>
<th><strong>数据类型</strong></th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>create_time</td>
<td>创建时间</td>
<td>datetime</td>
</tr>
<tr>
<td>2</td>
<td>create_user</td>
<td>创建人id</td>
<td>bigint</td>
</tr>
<tr>
<td>3</td>
<td>update_time</td>
<td>修改时间</td>
<td>datetime</td>
</tr>
<tr>
<td>4</td>
<td>update_user</td>
<td>修改人id</td>
<td>bigint</td>
</tr>
</tbody></table>
<p>而针对于这些字段，我们的赋值方式为： </p>
<p>1). 在新增数据时, 将createTime、updateTime 设置为当前时间, createUser、updateUser设置为当前登录用户ID。</p>
<p>2). 在更新数据时, 将updateTime 设置为当前时间, updateUser设置为当前登录用户ID。</p>
<p>目前,在我们的项目中处理这些字段都是在每一个业务方法中进行赋值操作,如下:</p>
<p><strong>新增员工方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 新增员工</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> employeeDTO</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(EmployeeDTO employeeDTO)</span> {</span><br><span class="line">       <span class="comment">//.......................</span></span><br><span class="line">	<span class="comment">//////////////////////////////////////////</span></span><br><span class="line">       <span class="comment">//设置当前记录的创建时间和修改时间</span></span><br><span class="line">       employee.setCreateTime(LocalDateTime.now());</span><br><span class="line">       employee.setUpdateTime(LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">       <span class="comment">//设置当前记录创建人id和修改人id</span></span><br><span class="line">       employee.setCreateUser(BaseContext.getCurrentId());<span class="comment">//目前写个假数据，后期修改</span></span><br><span class="line">       employee.setUpdateUser(BaseContext.getCurrentId());</span><br><span class="line">	<span class="comment">///////////////////////////////////////////////</span></span><br><span class="line">       employeeMapper.insert(employee);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<p><strong>编辑员工方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 编辑员工信息</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> employeeDTO</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(EmployeeDTO employeeDTO)</span> {</span><br><span class="line">      <span class="comment">//........................................</span></span><br><span class="line">   <span class="comment">///////////////////////////////////////////////</span></span><br><span class="line">       employee.setUpdateTime(LocalDateTime.now());</span><br><span class="line">       employee.setUpdateUser(BaseContext.getCurrentId());</span><br><span class="line">      <span class="comment">///////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">       employeeMapper.update(employee);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<p><strong>新增菜品分类方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 新增分类</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> categoryDTO</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(CategoryDTO categoryDTO)</span> {</span><br><span class="line">      <span class="comment">//....................................</span></span><br><span class="line">      <span class="comment">//////////////////////////////////////////</span></span><br><span class="line">       <span class="comment">//设置创建时间、修改时间、创建人、修改人</span></span><br><span class="line">       category.setCreateTime(LocalDateTime.now());</span><br><span class="line">       category.setUpdateTime(LocalDateTime.now());</span><br><span class="line">       category.setCreateUser(BaseContext.getCurrentId());</span><br><span class="line">       category.setUpdateUser(BaseContext.getCurrentId());</span><br><span class="line">       <span class="comment">///////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">       categoryMapper.insert(category);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<p><strong>修改菜品分类方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 修改分类</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> categoryDTO</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(CategoryDTO categoryDTO)</span> {</span><br><span class="line">       <span class="comment">//....................................</span></span><br><span class="line">       </span><br><span class="line">	<span class="comment">//////////////////////////////////////////////</span></span><br><span class="line">       <span class="comment">//设置修改时间、修改人</span></span><br><span class="line">       category.setUpdateTime(LocalDateTime.now());</span><br><span class="line">       category.setUpdateUser(BaseContext.getCurrentId());</span><br><span class="line">       <span class="comment">//////////////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">       categoryMapper.update(category);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<p>如果都按照上述的操作方式来处理这些公共字段, 需要在每一个业务方法中进行操作, 编码相对冗余、繁琐，那能不能对于这些公共字段在某个地方统一处理，来简化开发呢？</p>
<p><strong>答案是可以的，我们使用AOP切面编程，实现功能增强，来完成公共字段自动填充功能。</strong></p>
<h3><span id="1-2-shi-xian-si-lu">1.2 实现思路</span></h3><p>在实现公共字段自动填充，也就是在插入或者更新的时候为指定字段赋予指定的值，使用它的好处就是可以统一对这些字段进行处理，避免了重复代码。在上述的问题分析中，我们提到有四个公共字段，需要在新增/更新中进行赋值操作, 具体情况如下: </p>
<table>
<thead>
<tr>
<th><strong>序号</strong></th>
<th><strong>字段名</strong></th>
<th><strong>含义</strong></th>
<th><strong>数据类型</strong></th>
<th><strong>操作类型</strong></th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>create_time</td>
<td>创建时间</td>
<td>datetime</td>
<td>insert</td>
</tr>
<tr>
<td>2</td>
<td>create_user</td>
<td>创建人id</td>
<td>bigint</td>
<td>insert</td>
</tr>
<tr>
<td>3</td>
<td>update_time</td>
<td>修改时间</td>
<td>datetime</td>
<td>insert、update</td>
</tr>
<tr>
<td>4</td>
<td>update_user</td>
<td>修改人id</td>
<td>bigint</td>
<td>insert、update</td>
</tr>
</tbody></table>
<p><strong>实现步骤：</strong></p>
<p>1). 自定义注解 AutoFill，用于标识需要进行公共字段自动填充的方法</p>
<p>2). 自定义切面类 AutoFillAspect，统一拦截加入了 AutoFill 注解的方法，通过反射为公共字段赋值</p>
<p>3). 在 Mapper 的方法上加入 AutoFill 注解</p>
<p>若要实现上述步骤，需掌握以下知识(之前课程内容都学过)</p>
<p><strong>技术点：</strong>枚举、注解、AOP、反射</p>
<h3><span id="1-3-dai-ma-kai-fa">1.3 代码开发</span></h3><p>按照上一小节分析的实现步骤依次实现，共三步。</p>
<h4><span id="1-3-1-bu-zou-yi">1.3.1 步骤一</span></h4><p><strong>自定义注解 AutoFill</strong>              </p>
<p>进入到sky-server模块，创建com.sky.annotation包。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.enumeration.OperationType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义注解，用于标识某个方法需要进行功能字段自动填充处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AutoFill {</span><br><span class="line">    <span class="comment">//数据库操作类型：UPDATE INSERT</span></span><br><span class="line">    OperationType <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>其中OperationType已在sky-common模块中定义</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.enumeration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 数据库操作类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">OperationType</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    UPDATE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    INSERT</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="1-3-2-bu-zou-er">1.3.2 步骤二</span></h4><p><strong>自定义切面 AutoFillAspect</strong></p>
<p>在sky-server模块，创建com.sky.aspect包。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.aspect;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义切面，实现公共字段自动填充处理逻辑</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AutoFillAspect</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 切入点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut("execution(* com.sky.mapper.*.*(..)) &amp;&amp; @annotation(com.sky.annotation.AutoFill)")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">autoFillPointCut</span><span class="params">()</span>{}</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 前置通知，在通知中进行公共字段的赋值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Before("autoFillPointCut()")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">autoFill</span><span class="params">(JoinPoint joinPoint)</span>{</span><br><span class="line">        <span class="comment">/////////////////////重要////////////////////////////////////</span></span><br><span class="line">        <span class="comment">//可先进行调试，是否能进入该方法 提前在mapper方法添加AutoFill注解</span></span><br><span class="line">        log.info(<span class="string">"开始进行公共字段自动填充..."</span>);</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>完善自定义切面 AutoFillAspect 的 autoFill 方法</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.aspect;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.annotation.AutoFill;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.AutoFillConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.context.BaseContext;</span><br><span class="line"><span class="keyword">import</span> com.sky.enumeration.OperationType;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.JoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.reflect.MethodSignature;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义切面，实现公共字段自动填充处理逻辑</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AutoFillAspect</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 切入点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut("execution(* com.sky.mapper.*.*(..)) &amp;&amp; @annotation(com.sky.annotation.AutoFill)")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">autoFillPointCut</span><span class="params">()</span>{}</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 前置通知，在通知中进行公共字段的赋值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Before("autoFillPointCut()")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">autoFill</span><span class="params">(JoinPoint joinPoint)</span>{</span><br><span class="line">        log.info(<span class="string">"开始进行公共字段自动填充..."</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取到当前被拦截的方法上的数据库操作类型</span></span><br><span class="line">        <span class="type">MethodSignature</span> <span class="variable">signature</span> <span class="operator">=</span> (MethodSignature) joinPoint.getSignature();<span class="comment">//方法签名对象</span></span><br><span class="line">        <span class="type">AutoFill</span> <span class="variable">autoFill</span> <span class="operator">=</span> signature.getMethod().getAnnotation(AutoFill.class);<span class="comment">//获得方法上的注解对象</span></span><br><span class="line">        <span class="type">OperationType</span> <span class="variable">operationType</span> <span class="operator">=</span> autoFill.value();<span class="comment">//获得数据库操作类型</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取到当前被拦截的方法的参数--实体对象</span></span><br><span class="line">        Object[] args = joinPoint.getArgs();</span><br><span class="line">        <span class="keyword">if</span>(args == <span class="literal">null</span> || args.length == <span class="number">0</span>){</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">entity</span> <span class="operator">=</span> args[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">//准备赋值的数据</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">        <span class="type">Long</span> <span class="variable">currentId</span> <span class="operator">=</span> BaseContext.getCurrentId();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//根据当前不同的操作类型，为对应的属性通过反射来赋值</span></span><br><span class="line">        <span class="keyword">if</span>(operationType == OperationType.INSERT){</span><br><span class="line">            <span class="comment">//为4个公共字段赋值</span></span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="type">Method</span> <span class="variable">setCreateTime</span> <span class="operator">=</span> entity.getClass().getDeclaredMethod(AutoFillConstant.SET_CREATE_TIME, LocalDateTime.class);</span><br><span class="line">                <span class="type">Method</span> <span class="variable">setCreateUser</span> <span class="operator">=</span> entity.getClass().getDeclaredMethod(AutoFillConstant.SET_CREATE_USER, Long.class);</span><br><span class="line">                <span class="type">Method</span> <span class="variable">setUpdateTime</span> <span class="operator">=</span> entity.getClass().getDeclaredMethod(AutoFillConstant.SET_UPDATE_TIME, LocalDateTime.class);</span><br><span class="line">                <span class="type">Method</span> <span class="variable">setUpdateUser</span> <span class="operator">=</span> entity.getClass().getDeclaredMethod(AutoFillConstant.SET_UPDATE_USER, Long.class);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//通过反射为对象属性赋值</span></span><br><span class="line">                setCreateTime.invoke(entity,now);</span><br><span class="line">                setCreateUser.invoke(entity,currentId);</span><br><span class="line">                setUpdateTime.invoke(entity,now);</span><br><span class="line">                setUpdateUser.invoke(entity,currentId);</span><br><span class="line">            } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">        }<span class="keyword">else</span> <span class="keyword">if</span>(operationType == OperationType.UPDATE){</span><br><span class="line">            <span class="comment">//为2个公共字段赋值</span></span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="type">Method</span> <span class="variable">setUpdateTime</span> <span class="operator">=</span> entity.getClass().getDeclaredMethod(AutoFillConstant.SET_UPDATE_TIME, LocalDateTime.class);</span><br><span class="line">                <span class="type">Method</span> <span class="variable">setUpdateUser</span> <span class="operator">=</span> entity.getClass().getDeclaredMethod(AutoFillConstant.SET_UPDATE_USER, Long.class);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//通过反射为对象属性赋值</span></span><br><span class="line">                setUpdateTime.invoke(entity,now);</span><br><span class="line">                setUpdateUser.invoke(entity,currentId);</span><br><span class="line">            } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="1-3-3-bu-zou-san">1.3.3 步骤三</span></h4><p><strong>在Mapper接口的方法上加入 AutoFill 注解</strong></p>
<p>以<strong>CategoryMapper</strong>为例，分别在新增和修改方法添加@AutoFill()注解，也需要<strong>EmployeeMapper</strong>做相同操作</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CategoryMapper</span> {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> category</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Insert("insert into category(type, name, sort, status, create_time, update_time, create_user, update_user)" +</span></span><br><span class="line"><span class="meta">            " VALUES" +</span></span><br><span class="line"><span class="meta">            " (#{type}, #{name}, #{sort}, #{status}, #{createTime}, #{updateTime}, #{createUser}, #{updateUser})")</span></span><br><span class="line">    <span class="meta">@AutoFill(value = OperationType.INSERT)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(Category category)</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id修改分类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> category</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@AutoFill(value = OperationType.UPDATE)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Category category)</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>同时</strong>，将业务层为公共字段赋值的代码注释掉。</p>
<p>1). 将员工管理的新增和编辑方法中的公共字段赋值的代码注释。</p>
<p>2). 将菜品分类管理的新增和修改方法中的公共字段赋值的代码注释。</p>
<h3><span id="1-4-gong-neng-ce-shi">1.4 功能测试</span></h3><p>以<strong>新增菜品分类</strong>为例，进行测试</p>
<p><strong>启动项目和Nginx</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221121154642757.png" alt="image-20221121154642757" style="zoom:50%;"> 

<p><strong>查看控制台</strong></p>
<p>通过观察控制台输出的SQL来确定公共字段填充是否完成</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221121154841887.png" alt="image-20221121154841887"></p>
<p><strong>查看表</strong></p>
<p>category表中数据</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221121155104152.png" alt="image-20221121155104152"></p>
<p>其中create_time,update_time,create_user,update_user字段都已完成自动填充。</p>
<p>由于使用admin(id=1)用户登录进行菜品添加操作,故create_user,update_user都为1.</p>
<h3><span id="1-5-dai-ma-ti-jiao">1.5 代码提交</span></h3><p><strong>点击提交：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221121155718603.png" alt="image-20221121155718603" style="zoom:50%;"> 



<p><strong>提交过程中</strong>，出现提示：</p>
<img src="/2024/09/26/projection-skytogo/image-20221121155824695.png" alt="image-20221121155824695" style="zoom:50%;"> 



<p><strong>继续push:</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221121160002324.png" alt="image-20221121160002324" style="zoom:50%;"> 

<p><strong>推送成功：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221121160037460.png" alt="image-20221121160037460" style="zoom: 67%;"> 



<h2><span id="2-xin-zeng-cai-pin">2. 新增菜品</span></h2><h3><span id="2-1-xu-qiu-fen-xi-yu-she-ji">2.1 需求分析与设计</span></h3><h4><span id="2-1-1-chan-pin-yuan-xing">2.1.1 产品原型</span></h4><p>后台系统中可以管理菜品信息，通过 <strong>新增功能</strong>来添加一个新的菜品，在添加菜品时需要选择当前菜品所属的菜品分类，并且需要上传菜品图片。</p>
<p><strong>新增菜品原型：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221121164131337.png" alt="image-20221121164131337" style="zoom: 50%;"> 

<p>当填写完表单信息, 点击”保存”按钮后, 会提交该表单的数据到服务端, 在服务端中需要接受数据, 然后将数据保存至数据库中。</p>
<p><strong>业务规则：</strong></p>
<ul>
<li>菜品名称必须是唯一的</li>
<li>菜品必须属于某个分类下，不能单独存在</li>
<li>新增菜品时可以根据情况选择菜品的口味</li>
<li>每个菜品必须对应一张图片</li>
</ul>
<h4><span id="2-1-2-jie-kou-she-ji">2.1.2 接口设计</span></h4><p>根据上述原型图先<strong>粗粒度</strong>设计接口，共包含3个接口。</p>
<p><strong>接口设计：</strong></p>
<ul>
<li>根据类型查询分类（已完成）</li>
<li>文件上传</li>
<li>新增菜品</li>
</ul>
<p>接下来<strong>细粒度</strong>分析每个接口，明确每个接口的请求方式、请求路径、传入参数和返回值。</p>
<p><strong>1. 根据类型查询分类</strong></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221121165033612.png" alt="image-20221121165033612" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221121165043619.png" alt="image-20221121165043619" style="zoom:50%;"></p>
<p><strong>2. 文件上传</strong></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221121165201319.png" alt="image-20221121165201319" style="zoom:50%;"><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221121165215634.png" alt="image-20221121165215634" style="zoom:50%;"></p>
<p><strong>3. 新增菜品</strong></p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221121165254961.png" alt="image-20221121165254961" style="zoom: 50%;"><img src="/2024/09/26/projection-skytogo/image-20221121165308394.png" alt="image-20221121165308394" style="zoom: 50%;"><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221121165322687.png" alt="image-20221121165322687" style="zoom: 50%;"></p>
<h4><span id="2-1-3-biao-she-ji">2.1.3 表设计</span></h4><p>通过原型图进行分析：</p>
<img src="/2024/09/26/projection-skytogo/image-20221121165917874.png" alt="image-20221121165917874" style="zoom:50%;"> 

<p>新增菜品，其实就是将新增页面录入的菜品信息插入到dish表，如果添加了口味做法，还需要向dish_flavor表插入数据。所以在新增菜品时，涉及到两个表：</p>
<table>
<thead>
<tr>
<th>表名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>dish</td>
<td>菜品表</td>
</tr>
<tr>
<td>dish_flavor</td>
<td>菜品口味表</td>
</tr>
</tbody></table>
<p><strong>1). 菜品表:dish</strong></p>
<table>
<thead>
<tr>
<th><strong>字段名</strong></th>
<th><strong>数据类型</strong></th>
<th><strong>说明</strong></th>
<th><strong>备注</strong></th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>bigint</td>
<td>主键</td>
<td>自增</td>
</tr>
<tr>
<td>name</td>
<td>varchar(32)</td>
<td>菜品名称</td>
<td>唯一</td>
</tr>
<tr>
<td>category_id</td>
<td>bigint</td>
<td>分类id</td>
<td>逻辑外键</td>
</tr>
<tr>
<td>price</td>
<td>decimal(10,2)</td>
<td>菜品价格</td>
<td></td>
</tr>
<tr>
<td>image</td>
<td>varchar(255)</td>
<td>图片路径</td>
<td></td>
</tr>
<tr>
<td>description</td>
<td>varchar(255)</td>
<td>菜品描述</td>
<td></td>
</tr>
<tr>
<td>status</td>
<td>int</td>
<td>售卖状态</td>
<td>1起售 0停售</td>
</tr>
<tr>
<td>create_time</td>
<td>datetime</td>
<td>创建时间</td>
<td></td>
</tr>
<tr>
<td>update_time</td>
<td>datetime</td>
<td>最后修改时间</td>
<td></td>
</tr>
<tr>
<td>create_user</td>
<td>bigint</td>
<td>创建人id</td>
<td></td>
</tr>
<tr>
<td>update_user</td>
<td>bigint</td>
<td>最后修改人id</td>
<td></td>
</tr>
</tbody></table>
<p><strong>2). 菜品口味表:dish_flavor</strong></p>
<table>
<thead>
<tr>
<th><strong>字段名</strong></th>
<th><strong>数据类型</strong></th>
<th><strong>说明</strong></th>
<th><strong>备注</strong></th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>bigint</td>
<td>主键</td>
<td>自增</td>
</tr>
<tr>
<td>dish_id</td>
<td>bigint</td>
<td>菜品id</td>
<td>逻辑外键</td>
</tr>
<tr>
<td>name</td>
<td>varchar(32)</td>
<td>口味名称</td>
<td></td>
</tr>
<tr>
<td>value</td>
<td>varchar(255)</td>
<td>口味值</td>
<td></td>
</tr>
</tbody></table>
<h3><span id="2-2-dai-ma-kai-fa">2.2 代码开发</span></h3><h4><span id="2-2-1-wen-jian-shang-chuan-shi-xian">2.2.1 文件上传实现</span></h4><p>因为在新增菜品时，需要上传菜品对应的图片(文件)，包括后绪其它功能也会使用到文件上传，故要实现通用的文件上传接口。</p>
<p>文件上传，是指将本地图片、视频、音频等文件上传到服务器上，可以供其他用户浏览或下载的过程。文件上传在项目中应用非常广泛，我们经常发抖音、发朋友圈都用到了文件上传功能。</p>
<p>实现文件上传服务，需要有存储的支持，那么我们的解决方案将以下几种：</p>
<ol>
<li>直接将图片保存到服务的硬盘（springmvc中的文件上传）<ol>
<li>优点：开发便捷，成本低</li>
<li>缺点：扩容困难</li>
</ol>
</li>
<li>使用分布式文件系统进行存储<ol>
<li>优点：容易实现扩容</li>
<li>缺点：开发复杂度稍大（有成熟的产品可以使用，比如：FastDFS,MinIO）</li>
</ol>
</li>
<li>使用第三方的存储服务（例如OSS）<ol>
<li>优点：开发简单，拥有强大功能，免维护</li>
<li>缺点：付费</li>
</ol>
</li>
</ol>
<p>在本项目选用阿里云的OSS服务进行文件存储。（前面课程已学习过阿里云OSS,不再赘述）</p>
<img src="/2024/09/26/projection-skytogo/image-20221121174942235.png" alt="image-20221121174942235" style="zoom:67%;"> 

<p><strong>实现步骤：</strong></p>
<p><strong>1). 定义OSS相关配置</strong></p>
<p>在sky-server模块</p>
<p>application-dev.yml</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sky:</span></span><br><span class="line">  <span class="attr">alioss:</span></span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">oss-cn-hangzhou.aliyuncs.com</span></span><br><span class="line">    <span class="attr">access-key-id:</span> <span class="string">LTAI5tPeFLzsPPT8gG3LPW64</span></span><br><span class="line">    <span class="attr">access-key-secret:</span> <span class="string">U6k1brOZ8gaOIXv3nXbulGTUzy6Pd7</span></span><br><span class="line">    <span class="attr">bucket-name:</span> <span class="string">sky-take-out</span></span><br></pre></td></tr></tbody></table></figure>

<p>application.yml</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span>    <span class="comment">#设置环境</span></span><br><span class="line"><span class="attr">sky:</span></span><br><span class="line">  <span class="attr">alioss:</span></span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">${sky.alioss.endpoint}</span></span><br><span class="line">    <span class="attr">access-key-id:</span> <span class="string">${sky.alioss.access-key-id}</span></span><br><span class="line">    <span class="attr">access-key-secret:</span> <span class="string">${sky.alioss.access-key-secret}</span></span><br><span class="line">    <span class="attr">bucket-name:</span> <span class="string">${sky.alioss.bucket-name}</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>



<p><strong>2). 读取OSS配置</strong></p>
<p>在sky-common模块中，已定义</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = "sky.alioss")</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AliOssProperties</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String endpoint;</span><br><span class="line">    <span class="keyword">private</span> String accessKeyId;</span><br><span class="line">    <span class="keyword">private</span> String accessKeySecret;</span><br><span class="line">    <span class="keyword">private</span> String bucketName;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p><strong>3). 生成OSS工具类对象</strong></p>
<p>在sky-server模块</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.properties.AliOssProperties;</span><br><span class="line"><span class="keyword">import</span> com.sky.utils.AliOssUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置类，用于创建AliOssUtil对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OssConfiguration</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> AliOssUtil <span class="title function_">aliOssUtil</span><span class="params">(AliOssProperties aliOssProperties)</span>{</span><br><span class="line">        log.info(<span class="string">"开始创建阿里云文件上传工具类对象：{}"</span>,aliOssProperties);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AliOssUtil</span>(aliOssProperties.getEndpoint(),</span><br><span class="line">                aliOssProperties.getAccessKeyId(),</span><br><span class="line">                aliOssProperties.getAccessKeySecret(),</span><br><span class="line">                aliOssProperties.getBucketName());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>其中，AliOssUtil.java已在sky-common模块中定义</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.ClientException;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.OSS;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.OSSClientBuilder;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.OSSException;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AliOssUtil</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String endpoint;</span><br><span class="line">    <span class="keyword">private</span> String accessKeyId;</span><br><span class="line">    <span class="keyword">private</span> String accessKeySecret;</span><br><span class="line">    <span class="keyword">private</span> String bucketName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bytes</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">upload</span><span class="params">(<span class="type">byte</span>[] bytes, String objectName)</span> {</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建OSSClient实例。</span></span><br><span class="line">        <span class="type">OSS</span> <span class="variable">ossClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OSSClientBuilder</span>().build(endpoint, accessKeyId, accessKeySecret);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 创建PutObject请求。</span></span><br><span class="line">            ossClient.putObject(bucketName, objectName, <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes));</span><br><span class="line">        } <span class="keyword">catch</span> (OSSException oe) {</span><br><span class="line">            System.out.println(<span class="string">"Caught an OSSException, which means your request made it to OSS, "</span></span><br><span class="line">                    + <span class="string">"but was rejected with an error response for some reason."</span>);</span><br><span class="line">            System.out.println(<span class="string">"Error Message:"</span> + oe.getErrorMessage());</span><br><span class="line">            System.out.println(<span class="string">"Error Code:"</span> + oe.getErrorCode());</span><br><span class="line">            System.out.println(<span class="string">"Request ID:"</span> + oe.getRequestId());</span><br><span class="line">            System.out.println(<span class="string">"Host ID:"</span> + oe.getHostId());</span><br><span class="line">        } <span class="keyword">catch</span> (ClientException ce) {</span><br><span class="line">            System.out.println(<span class="string">"Caught an ClientException, which means the client encountered "</span></span><br><span class="line">                    + <span class="string">"a serious internal problem while trying to communicate with OSS, "</span></span><br><span class="line">                    + <span class="string">"such as not being able to access the network."</span>);</span><br><span class="line">            System.out.println(<span class="string">"Error Message:"</span> + ce.getMessage());</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            <span class="keyword">if</span> (ossClient != <span class="literal">null</span>) {</span><br><span class="line">                ossClient.shutdown();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//文件访问路径规则 https://BucketName.Endpoint/ObjectName</span></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">"https://"</span>);</span><br><span class="line">        stringBuilder</span><br><span class="line">                .append(bucketName)</span><br><span class="line">                .append(<span class="string">"."</span>)</span><br><span class="line">                .append(endpoint)</span><br><span class="line">                .append(<span class="string">"/"</span>)</span><br><span class="line">                .append(objectName);</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"文件上传到:{}"</span>, stringBuilder.toString());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> stringBuilder.toString();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p><strong>4). 定义文件上传接口</strong></p>
<p>在sky-server模块中定义接口</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.constant.MessageConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.utils.AliOssUtil;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通用接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/admin/common")</span></span><br><span class="line"><span class="meta">@Api(tags = "通用接口")</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AliOssUtil aliOssUtil;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件上传</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping("/upload")</span></span><br><span class="line">    <span class="meta">@ApiOperation("文件上传")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">upload</span><span class="params">(MultipartFile file)</span>{</span><br><span class="line">        log.info(<span class="string">"文件上传：{}"</span>,file);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">//原始文件名</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">originalFilename</span> <span class="operator">=</span> file.getOriginalFilename();</span><br><span class="line">            <span class="comment">//截取原始文件名的后缀   dfdfdf.png</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">extension</span> <span class="operator">=</span> originalFilename.substring(originalFilename.lastIndexOf(<span class="string">"."</span>));</span><br><span class="line">            <span class="comment">//构造新文件名称</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">objectName</span> <span class="operator">=</span> UUID.randomUUID().toString() + extension;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//文件的请求路径</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> aliOssUtil.upload(file.getBytes(), objectName);</span><br><span class="line">            <span class="keyword">return</span> Result.success(filePath);</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            log.error(<span class="string">"文件上传失败：{}"</span>, e);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.error(MessageConstant.UPLOAD_FAILED);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-2-2-xin-zeng-cai-pin-shi-xian">2.2.2 新增菜品实现</span></h4><p><strong>1). 设计DTO类</strong></p>
<p>在sky-pojo模块中</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.entity.DishFlavor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DishDTO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">//菜品名称</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">//菜品分类id</span></span><br><span class="line">    <span class="keyword">private</span> Long categoryId;</span><br><span class="line">    <span class="comment">//菜品价格</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;</span><br><span class="line">    <span class="comment">//图片</span></span><br><span class="line">    <span class="keyword">private</span> String image;</span><br><span class="line">    <span class="comment">//描述信息</span></span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line">    <span class="comment">//0 停售 1 起售</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    <span class="comment">//口味</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;DishFlavor&gt; flavors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p><strong>2). Controller层</strong></p>
<p>进入到sky-server模块</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishPageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Dish;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.DishService;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.DishVO;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 菜品管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/admin/dish")</span></span><br><span class="line"><span class="meta">@Api(tags = "菜品相关接口")</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DishController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishService dishService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增菜品</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dishDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="meta">@ApiOperation("新增菜品")</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> DishDTO dishDTO)</span> {</span><br><span class="line">        log.info(<span class="string">"新增菜品：{}"</span>, dishDTO);</span><br><span class="line">        dishService.saveWithFlavor(dishDTO);<span class="comment">//后绪步骤开发</span></span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p><strong>3). Service层接口</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.dto.DishDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Dish;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DishService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增菜品和对应的口味</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dishDTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveWithFlavor</span><span class="params">(DishDTO dishDTO)</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p><strong>4). Service层实现类</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DishServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">DishService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishMapper dishMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishFlavorMapper dishFlavorMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增菜品和对应的口味</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dishDTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveWithFlavor</span><span class="params">(DishDTO dishDTO)</span> {</span><br><span class="line"></span><br><span class="line">        <span class="type">Dish</span> <span class="variable">dish</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dish</span>();</span><br><span class="line">        BeanUtils.copyProperties(dishDTO, dish);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//向菜品表插入1条数据</span></span><br><span class="line">        dishMapper.insert(dish);<span class="comment">//后绪步骤实现</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取insert语句生成的主键值</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">dishId</span> <span class="operator">=</span> dish.getId();</span><br><span class="line"></span><br><span class="line">        List&lt;DishFlavor&gt; flavors = dishDTO.getFlavors();</span><br><span class="line">        <span class="keyword">if</span> (flavors != <span class="literal">null</span> &amp;&amp; flavors.size() &gt; <span class="number">0</span>) {</span><br><span class="line">            flavors.forEach(dishFlavor -&gt; {</span><br><span class="line">                dishFlavor.setDishId(dishId);</span><br><span class="line">            });</span><br><span class="line">            <span class="comment">//向口味表插入n条数据</span></span><br><span class="line">            dishFlavorMapper.insertBatch(flavors);<span class="comment">//后绪步骤实现</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p><strong>5). Mapper层</strong></p>
<p>DishMapper.java中添加</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 插入菜品数据</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> dish</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@AutoFill(value = OperationType.INSERT)</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(Dish dish)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p>在/resources/mapper中创建DishMapper.xml</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span></span><br><span class="line"><span class="meta">        <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.sky.mapper.DishMapper"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insert"</span> <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span>&gt;</span></span><br><span class="line">        insert into dish (name, category_id, price, image, description, create_time, update_time, create_user,update_user, status)</span><br><span class="line">        values (#{name}, #{categoryId}, #{price}, #{image}, #{description}, #{createTime}, #{updateTime}, #{createUser}, #{updateUser}, #{status})</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>DishFlavorMapper.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.entity.DishFlavor;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DishFlavorMapper</span> {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量插入口味数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> flavors</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insertBatch</span><span class="params">(List&lt;DishFlavor&gt; flavors)</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在/resources/mapper中创建DishFlavorMapper.xml</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span></span><br><span class="line"><span class="meta">        <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.sky.mapper.DishFlavorMapper"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertBatch"</span>&gt;</span></span><br><span class="line">        insert into dish_flavor (dish_id, name, value) VALUES</span><br><span class="line">        <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">"flavors"</span> <span class="attr">item</span>=<span class="string">"df"</span> <span class="attr">separator</span>=<span class="string">","</span>&gt;</span></span><br><span class="line">            (#{df.dishId},#{df.name},#{df.value})</span><br><span class="line">        <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-3-gong-neng-ce-shi">2.3 功能测试</span></h3><p>进入到菜品管理—&gt;新建菜品</p>
<img src="/2024/09/26/projection-skytogo/image-20221121195440804.png" alt="image-20221121195440804" style="zoom:50%;"> 

<p>由于没有实现菜品查询功能，所以保存后，暂且在表中查看添加的数据。</p>
<p>dish表：</p>
<img src="/2024/09/26/projection-skytogo/image-20221121195737692.png" alt="image-20221121195737692" style="zoom:50%;"> 

<p>dish_flavor表：</p>
<img src="/2024/09/26/projection-skytogo/image-20221121195902555.png" alt="image-20221121195902555" style="zoom:50%;"> 

<p>测试成功。</p>
<h3><span id="2-4-dai-ma-ti-jiao">2.4代码提交</span></h3><img src="/2024/09/26/projection-skytogo/image-20221121200332933.png" alt="image-20221121200332933" style="zoom:50%;">  

<p>后续步骤和上述功能代码提交一致，不再赘述。</p>
<h2><span id="3-cai-pin-fen-ye-cha-xun">3. 菜品分页查询</span></h2><h3><span id="3-1-xu-qiu-fen-xi-he-she-ji">3.1 需求分析和设计</span></h3><h4><span id="3-1-1-chan-pin-yuan-xing">3.1.1 产品原型</span></h4><p>系统中的菜品数据很多的时候，如果在一个页面中全部展示出来会显得比较乱，不便于查看，所以一般的系统中都会以分页的方式来展示列表数据。</p>
<p><strong>菜品分页原型：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221121201552489.png" alt="image-20221121201552489" style="zoom: 67%;"> 

<p>在菜品列表展示时，除了菜品的基本信息(名称、售价、售卖状态、最后操作时间)外，还有两个字段略微特殊，第一个是图片字段 ，我们从数据库查询出来的仅仅是图片的名字，图片要想在表格中回显展示出来，就需要下载这个图片。第二个是菜品分类，这里展示的是分类名称，而不是分类ID，此时我们就需要根据菜品的分类ID，去分类表中查询分类信息，然后在页面展示。</p>
<p><strong>业务规则：</strong></p>
<ul>
<li>根据页码展示菜品信息</li>
<li>每页展示10条数据</li>
<li>分页查询时可以根据需要输入菜品名称、菜品分类、菜品状态进行查询</li>
</ul>
<h4><span id="3-1-2-jie-kou-she-ji">3.1.2 接口设计</span></h4><p>根据上述原型图，设计出相应的接口。</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221121202019258.png" alt="image-20221121202019258" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221121202033284.png" alt="image-20221121202033284" style="zoom:50%;"></p>
<h3><span id="3-2-dai-ma-kai-fa">3.2 代码开发</span></h3><h4><span id="3-2-1-she-ji-dto-lei">3.2.1 设计DTO类</span></h4><p><strong>根据菜品分页查询接口定义设计对应的DTO：</strong></p>
<p>在sky-pojo模块中，已定义</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DishPageQueryDTO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> page;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> pageSize;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer categoryId; <span class="comment">//分类id</span></span><br><span class="line">    <span class="keyword">private</span> Integer status; <span class="comment">//状态 0表示禁用 1表示启用</span></span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-2-2-she-ji-vo-lei">3.2.2 设计VO类</span></h4><p><strong>根据菜品分页查询接口定义设计对应的VO：</strong></p>
<p>在sky-pojo模块中，已定义</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.entity.DishFlavor;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DishVO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">//菜品名称</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">//菜品分类id</span></span><br><span class="line">    <span class="keyword">private</span> Long categoryId;</span><br><span class="line">    <span class="comment">//菜品价格</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;</span><br><span class="line">    <span class="comment">//图片</span></span><br><span class="line">    <span class="keyword">private</span> String image;</span><br><span class="line">    <span class="comment">//描述信息</span></span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line">    <span class="comment">//0 停售 1 起售</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    <span class="comment">//更新时间</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updateTime;</span><br><span class="line">    <span class="comment">//分类名称</span></span><br><span class="line">    <span class="keyword">private</span> String categoryName;</span><br><span class="line">    <span class="comment">//菜品关联的口味</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;DishFlavor&gt; flavors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-2-3-controller-ceng">3.2.3 Controller层</span></h4><p><strong>根据接口定义创建DishController的page分页查询方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 菜品分页查询</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> dishPageQueryDTO</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@GetMapping("/page")</span></span><br><span class="line">   <span class="meta">@ApiOperation("菜品分页查询")</span></span><br><span class="line">   <span class="keyword">public</span> Result&lt;PageResult&gt; <span class="title function_">page</span><span class="params">(DishPageQueryDTO dishPageQueryDTO)</span> {</span><br><span class="line">       log.info(<span class="string">"菜品分页查询:{}"</span>, dishPageQueryDTO);</span><br><span class="line">       <span class="type">PageResult</span> <span class="variable">pageResult</span> <span class="operator">=</span> dishService.pageQuery(dishPageQueryDTO);<span class="comment">//后绪步骤定义</span></span><br><span class="line">       <span class="keyword">return</span> Result.success(pageResult);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-2-4-service-ceng-jie-kou">3.2.4 Service层接口</span></h4><p><strong>在 DishService 中扩展分页查询方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 菜品分页查询</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> dishPageQueryDTO</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   PageResult <span class="title function_">pageQuery</span><span class="params">(DishPageQueryDTO dishPageQueryDTO)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-2-5-service-ceng-shi-xian-lei">3.2.5 Service层实现类</span></h4><p><strong>在 DishServiceImpl 中实现分页查询方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 菜品分页查询</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> dishPageQueryDTO</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> PageResult <span class="title function_">pageQuery</span><span class="params">(DishPageQueryDTO dishPageQueryDTO)</span> {</span><br><span class="line">       PageHelper.startPage(dishPageQueryDTO.getPage(), dishPageQueryDTO.getPageSize());</span><br><span class="line">       Page&lt;DishVO&gt; page = dishMapper.pageQuery(dishPageQueryDTO);<span class="comment">//后绪步骤实现</span></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageResult</span>(page.getTotal(), page.getResult());</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-2-6-mapper-ceng">3.2.6 Mapper层</span></h4><p><strong>在 DishMapper 接口中声明 pageQuery 方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 菜品分页查询</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> dishPageQueryDTO</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   Page&lt;DishVO&gt; <span class="title function_">pageQuery</span><span class="params">(DishPageQueryDTO dishPageQueryDTO)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>在 DishMapper.xml 中编写SQL：</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"pageQuery"</span> <span class="attr">resultType</span>=<span class="string">"com.sky.vo.DishVO"</span>&gt;</span></span><br><span class="line">        select d.* , c.name as categoryName from dish d left outer join category c on d.category_id = c.id</span><br><span class="line">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"name != null"</span>&gt;</span></span><br><span class="line">                and d.name like concat('%',#{name},'%')</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"categoryId != null"</span>&gt;</span></span><br><span class="line">                and d.category_id = #{categoryId}</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"status != null"</span>&gt;</span></span><br><span class="line">                and d.status = #{status}</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">        order by d.create_time desc</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-3-gong-neng-ce-shi">3.3 功能测试</span></h3><h4><span id="3-3-1-jie-kou-wen-dang-ce-shi">3.3.1 接口文档测试</span></h4><p><strong>启动服务：</strong>访问<a target="_blank" rel="noopener" href="http://localhost:8080/doc.html%EF%BC%8C%E8%BF%9B%E5%85%A5%E8%8F%9C%E5%93%81%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E6%8E%A5%E5%8F%A3">http://localhost:8080/doc.html，进入菜品分页查询接口</a></p>
<p><strong>注意：</strong>使用admin用户登录重新获取token，防止token失效。</p>
<img src="/2024/09/26/projection-skytogo/image-20221121210252403.png" alt="image-20221121210252403" style="zoom:50%;">  

<p><strong>点击发送：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221121210333489.png" alt="image-20221121210333489" style="zoom: 67%;"> 



<h4><span id="3-3-2-qian-hou-duan-lian-diao-ce-shi">3.3.2 前后端联调测试</span></h4><p>启动nginx,访问 <a target="_blank" rel="noopener" href="http://localhost/">http://localhost</a></p>
<p><strong>点击菜品管理</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221121210500188.png" alt="image-20221121210500188" style="zoom:50%;"> 

<p>数据成功查出。</p>
<h2><span id="4-shan-chu-cai-pin">4. 删除菜品</span></h2><h3><span id="4-1-xu-qiu-fen-xi-he-she-ji">4.1 需求分析和设计</span></h3><h4><span id="4-1-1-chan-pin-yuan-xing">4.1.1 产品原型</span></h4><p>在菜品列表页面，每个菜品后面对应的操作分别为<strong>修改</strong>、<strong>删除</strong>、<strong>停售</strong>，可通过删除功能完成对菜品及相关的数据进行删除。</p>
<p><strong>删除菜品原型：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221121211236356.png" alt="image-20221121211236356" style="zoom:67%;"> 



<p><strong>业务规则：</strong></p>
<ul>
<li>可以一次删除一个菜品，也可以批量删除菜品</li>
<li>起售中的菜品不能删除</li>
<li>被套餐关联的菜品不能删除</li>
<li>删除菜品后，关联的口味数据也需要删除掉</li>
</ul>
<h4><span id="4-1-2-jie-kou-she-ji">4.1.2 接口设计</span></h4><p>根据上述原型图，设计出相应的接口。</p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221121211801121.png" alt="image-20221121211801121" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/image-20221121211814429.png" alt="image-20221121211814429" style="zoom:50%;"></p>
<p><strong>注意：</strong>删除一个菜品和批量删除菜品共用一个接口，故ids可包含多个菜品id,之间用逗号分隔。</p>
<h4><span id="4-1-3-biao-she-ji">4.1.3 表设计</span></h4><p>在进行删除菜品操作时，会涉及到以下三张表。</p>
<img src="/2024/09/26/projection-skytogo/image-20221121212436851.png" alt="image-20221121212436851" style="zoom:50%;"> 

<p><strong>注意事项：</strong></p>
<ul>
<li>在dish表中删除菜品基本数据时，同时，也要把关联在dish_flavor表中的数据一块删除。</li>
<li>setmeal_dish表为菜品和套餐关联的中间表。</li>
<li>若删除的菜品数据关联着某个套餐，此时，删除失败。</li>
<li>若要删除套餐关联的菜品数据，先解除两者关联，再对菜品进行删除。</li>
</ul>
<h3><span id="4-2-dai-ma-kai-fa">4.2 代码开发</span></h3><h4><span id="4-1-2-controller-ceng">4.1.2 Controller层</span></h4><p><strong>根据删除菜品的接口定义在DishController中创建方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 菜品批量删除</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ids</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@DeleteMapping</span></span><br><span class="line">   <span class="meta">@ApiOperation("菜品批量删除")</span></span><br><span class="line">   <span class="keyword">public</span> Result <span class="title function_">delete</span><span class="params">(<span class="meta">@RequestParam</span> List&lt;Long&gt; ids)</span> {</span><br><span class="line">       log.info(<span class="string">"菜品批量删除：{}"</span>, ids);</span><br><span class="line">       dishService.deleteBatch(ids);<span class="comment">//后绪步骤实现</span></span><br><span class="line">       <span class="keyword">return</span> Result.success();</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="4-2-2-service-ceng-jie-kou">4.2.2 Service层接口</span></h4><p><strong>在DishService接口中声明deleteBatch方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 菜品批量删除</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ids</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">deleteBatch</span><span class="params">(List&lt;Long&gt; ids)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="4-2-3-service-ceng-shi-xian-lei">4.2.3 Service层实现类</span></h4><p><strong>在DishServiceImpl中实现deleteBatch方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> SetmealDishMapper setmealDishMapper;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 菜品批量删除</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ids</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Transactional</span><span class="comment">//事务</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteBatch</span><span class="params">(List&lt;Long&gt; ids)</span> {</span><br><span class="line">       <span class="comment">//判断当前菜品是否能够删除---是否存在起售中的菜品？？</span></span><br><span class="line">       <span class="keyword">for</span> (Long id : ids) {</span><br><span class="line">           <span class="type">Dish</span> <span class="variable">dish</span> <span class="operator">=</span> dishMapper.getById(id);<span class="comment">//后绪步骤实现</span></span><br><span class="line">           <span class="keyword">if</span> (dish.getStatus() == StatusConstant.ENABLE) {</span><br><span class="line">               <span class="comment">//当前菜品处于起售中，不能删除</span></span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DeletionNotAllowedException</span>(MessageConstant.DISH_ON_SALE);</span><br><span class="line">           }</span><br><span class="line">       }</span><br><span class="line"></span><br><span class="line">       <span class="comment">//判断当前菜品是否能够删除---是否被套餐关联了？？</span></span><br><span class="line">       List&lt;Long&gt; setmealIds = setmealDishMapper.getSetmealIdsByDishIds(ids);</span><br><span class="line">       <span class="keyword">if</span> (setmealIds != <span class="literal">null</span> &amp;&amp; setmealIds.size() &gt; <span class="number">0</span>) {</span><br><span class="line">           <span class="comment">//当前菜品被套餐关联了，不能删除</span></span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DeletionNotAllowedException</span>(MessageConstant.DISH_BE_RELATED_BY_SETMEAL);</span><br><span class="line">       }</span><br><span class="line"></span><br><span class="line">       <span class="comment">//删除菜品表中的菜品数据</span></span><br><span class="line">       <span class="keyword">for</span> (Long id : ids) {</span><br><span class="line">           dishMapper.deleteById(id);<span class="comment">//后绪步骤实现</span></span><br><span class="line">           <span class="comment">//删除菜品关联的口味数据</span></span><br><span class="line">           dishFlavorMapper.deleteByDishId(id);<span class="comment">//后绪步骤实现</span></span><br><span class="line">       }</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="4-2-4-mapper-ceng">4.2.4 Mapper层</span></h4><p><strong>在DishMapper中声明getById方法，并配置SQL：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据主键查询菜品</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Select("select * from dish where id = #{id}")</span></span><br><span class="line">   Dish <span class="title function_">getById</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>创建SetmealDishMapper，声明getSetmealIdsByDishIds方法，并在xml文件中编写SQL：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.entity.SetmealDish;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Delete;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SetmealDishMapper</span> {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据菜品id查询对应的套餐id</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dishIds</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//select setmeal_id from setmeal_dish where dish_id in (1,2,3,4)</span></span><br><span class="line">    List&lt;Long&gt; <span class="title function_">getSetmealIdsByDishIds</span><span class="params">(List&lt;Long&gt; dishIds)</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>SetmealDishMapper.xml</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span></span><br><span class="line"><span class="meta">        <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.sky.mapper.SetmealDishMapper"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getSetmealIdsByDishIds"</span> <span class="attr">resultType</span>=<span class="string">"java.lang.Long"</span>&gt;</span></span><br><span class="line">        select setmeal_id from setmeal_dish where dish_id in</span><br><span class="line">        <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">"dishIds"</span> <span class="attr">item</span>=<span class="string">"dishId"</span> <span class="attr">separator</span>=<span class="string">","</span> <span class="attr">open</span>=<span class="string">"("</span> <span class="attr">close</span>=<span class="string">")"</span>&gt;</span></span><br><span class="line">            #{dishId}</span><br><span class="line">        <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>在DishMapper.java中声明deleteById方法并配置SQL：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据主键删除菜品数据</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Delete("delete from dish where id = #{id}")</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">deleteById</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>在DishFlavorMapper中声明deleteByDishId方法并配置SQL：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据菜品id删除对应的口味数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dishId</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Delete("delete from dish_flavor where dish_id = #{dishId}")</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">deleteByDishId</span><span class="params">(Long dishId)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-3-gong-neng-ce-shi">4.3 功能测试</span></h3><p>既可以通过Swagger接口文档进行测试，也可以通过前后端联调测试，接下来，我们直接使用<strong>前后端联调测试</strong>。</p>
<p>进入到菜品列表查询页面</p>
<img src="/2024/09/26/projection-skytogo/image-20221122125332084.png" alt="image-20221122125332084" style="zoom:50%;"> 

<p>对测试菜品进行删除操作</p>
<img src="/2024/09/26/projection-skytogo/image-20221122125625014.png" alt="image-20221122125625014" style="zoom:50%;"> 

<p>同时，进到dish表和dish_flavor两个表查看<strong>测试菜品</strong>的相关数据都已被成功删除。</p>
<p>再次，删除状态为启售的菜品</p>
<img src="/2024/09/26/projection-skytogo/image-20221122125841464.png" alt="image-20221122125841464" style="zoom:50%;"> 

<p>点击批量删除</p>
<img src="/2024/09/26/projection-skytogo/image-20221122130016566.png" alt="image-20221122130016566" style="zoom:50%;"> 

<p>删除失败，因为起售中的菜品不能删除。</p>
<h3><span id="4-4-dai-ma-ti-jiao">4.4 代码提交</span></h3><img src="/2024/09/26/projection-skytogo/image-20221122130426605.png" alt="image-20221122130426605" style="zoom:50%;"> 

<p>后续步骤和上述功能代码提交一致，不再赘述。</p>
<h2><span id="5-xiu-gai-cai-pin">5. 修改菜品</span></h2><h3><span id="5-1-xu-qiu-fen-xi-he-she-ji">5.1 需求分析和设计</span></h3><h4><span id="5-1-1-chan-pin-yuan-xing">5.1.1 产品原型</span></h4><p>在菜品管理列表页面点击修改按钮，跳转到修改菜品页面，在修改页面回显菜品相关信息并进行修改，最后点击保存按钮完成修改操作。</p>
<p><strong>修改菜品原型：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221122130837173.png" alt="image-20221122130837173" style="zoom:50%;"> 



<h4><span id="5-1-2-jie-kou-she-ji">5.1.2 接口设计</span></h4><p>通过对上述原型图进行分析，该页面共涉及4个接口。</p>
<p><strong>接口：</strong></p>
<ul>
<li>根据id查询菜品</li>
<li>根据类型查询分类(已实现)</li>
<li>文件上传(已实现)</li>
<li>修改菜品</li>
</ul>
<p>我们只需要实现<strong>根据id查询菜品</strong>和<strong>修改菜品</strong>两个接口，接下来，我们来重点分析这两个接口。</p>
<p><strong>1). 根据id查询菜品</strong></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221122131733147.png" alt="image-20221122131733147" style="zoom:50%;"><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221122131743509.png" alt="image-20221122131743509" style="zoom:50%;"></p>
<p><strong>2). 修改菜品</strong></p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221122131837393.png" alt="image-20221122131837393" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/image-20221122131847583.png" alt="image-20221122131847583" style="zoom:50%;"></p>
<img src="/2024/09/26/projection-skytogo/image-20221122131914533.png" alt="image-20221122131914533" style="zoom:50%;"> 

<p><strong>注:因为是修改功能，请求方式可设置为PUT。</strong></p>
<h3><span id="5-2-dai-ma-kai-fa">5.2 代码开发</span></h3><h4><span id="5-2-1-gen-ju-id-cha-xun-cai-pin-shi-xian">5.2.1 根据id查询菜品实现</span></h4><p><strong>1). Controller层</strong></p>
<p><strong>根据id查询菜品的接口定义在DishController中创建方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据id查询菜品</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/{id}")</span></span><br><span class="line"><span class="meta">@ApiOperation("根据id查询菜品")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;DishVO&gt; <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> {</span><br><span class="line">    log.info(<span class="string">"根据id查询菜品：{}"</span>, id);</span><br><span class="line">    <span class="type">DishVO</span> <span class="variable">dishVO</span> <span class="operator">=</span> dishService.getByIdWithFlavor(id);<span class="comment">//后绪步骤实现</span></span><br><span class="line">    <span class="keyword">return</span> Result.success(dishVO);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p><strong>2). Service层接口</strong></p>
<p><strong>在DishService接口中声明getByIdWithFlavor方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据id查询菜品和对应的口味数据</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   DishVO <span class="title function_">getByIdWithFlavor</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></tbody></table></figure>



<p><strong>3). Service层实现类</strong></p>
<p><strong>在DishServiceImpl中实现getByIdWithFlavor方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据id查询菜品和对应的口味数据</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> DishVO <span class="title function_">getByIdWithFlavor</span><span class="params">(Long id)</span> {</span><br><span class="line">       <span class="comment">//根据id查询菜品数据</span></span><br><span class="line">       <span class="type">Dish</span> <span class="variable">dish</span> <span class="operator">=</span> dishMapper.getById(id);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//根据菜品id查询口味数据</span></span><br><span class="line">       List&lt;DishFlavor&gt; dishFlavors = dishFlavorMapper.getByDishId(id);<span class="comment">//后绪步骤实现</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">//将查询到的数据封装到VO</span></span><br><span class="line">       <span class="type">DishVO</span> <span class="variable">dishVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DishVO</span>();</span><br><span class="line">       BeanUtils.copyProperties(dish, dishVO);</span><br><span class="line">       dishVO.setFlavors(dishFlavors);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> dishVO;</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<p><strong>4). Mapper层</strong></p>
<p><strong>在DishFlavorMapper中声明getByDishId方法，并配置SQL：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据菜品id查询对应的口味数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dishId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Select("select * from dish_flavor where dish_id = #{dishId}")</span></span><br><span class="line">List&lt;DishFlavor&gt; <span class="title function_">getByDishId</span><span class="params">(Long dishId)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="5-2-1-xiu-gai-cai-pin-shi-xian">5.2.1 修改菜品实现</span></h4><p><strong>1). Controller层</strong></p>
<p><strong>根据修改菜品的接口定义在DishController中创建方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 修改菜品</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> dishDTO</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@PutMapping</span></span><br><span class="line">   <span class="meta">@ApiOperation("修改菜品")</span></span><br><span class="line">   <span class="keyword">public</span> Result <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> DishDTO dishDTO)</span> {</span><br><span class="line">       log.info(<span class="string">"修改菜品：{}"</span>, dishDTO);</span><br><span class="line">       dishService.updateWithFlavor(dishDTO);</span><br><span class="line">       <span class="keyword">return</span> Result.success();</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<p><strong>2). Service层接口</strong></p>
<p><strong>在DishService接口中声明updateWithFlavor方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据id修改菜品基本信息和对应的口味信息</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> dishDTO</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">updateWithFlavor</span><span class="params">(DishDTO dishDTO)</span>;</span><br></pre></td></tr></tbody></table></figure>



<p><strong>3). Service层实现类</strong></p>
<p><strong>在DishServiceImpl中实现updateWithFlavor方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据id修改菜品基本信息和对应的口味信息</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> dishDTO</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateWithFlavor</span><span class="params">(DishDTO dishDTO)</span> {</span><br><span class="line">       <span class="type">Dish</span> <span class="variable">dish</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dish</span>();</span><br><span class="line">       BeanUtils.copyProperties(dishDTO, dish);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//修改菜品表基本信息</span></span><br><span class="line">       dishMapper.update(dish);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//删除原有的口味数据</span></span><br><span class="line">       dishFlavorMapper.deleteByDishId(dishDTO.getId());</span><br><span class="line"></span><br><span class="line">       <span class="comment">//重新插入口味数据</span></span><br><span class="line">       List&lt;DishFlavor&gt; flavors = dishDTO.getFlavors();</span><br><span class="line">       <span class="keyword">if</span> (flavors != <span class="literal">null</span> &amp;&amp; flavors.size() &gt; <span class="number">0</span>) {</span><br><span class="line">           flavors.forEach(dishFlavor -&gt; {</span><br><span class="line">               dishFlavor.setDishId(dishDTO.getId());</span><br><span class="line">           });</span><br><span class="line">           <span class="comment">//向口味表插入n条数据</span></span><br><span class="line">           dishFlavorMapper.insertBatch(flavors);</span><br><span class="line">       }</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<p><strong>4). Mapper层</strong></p>
<p><strong>在DishMapper中，声明update方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据id动态修改菜品数据</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> dish</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@AutoFill(value = OperationType.UPDATE)</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Dish dish)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>并在DishMapper.xml文件中编写SQL:</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"update"</span>&gt;</span></span><br><span class="line">        update dish</span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"name != null"</span>&gt;</span>name = #{name},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"categoryId != null"</span>&gt;</span>category_id = #{categoryId},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"price != null"</span>&gt;</span>price = #{price},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"image != null"</span>&gt;</span>image = #{image},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"description != null"</span>&gt;</span>description = #{description},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"status != null"</span>&gt;</span>status = #{status},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"updateTime != null"</span>&gt;</span>update_time = #{updateTime},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"updateUser != null"</span>&gt;</span>update_user = #{updateUser},<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        where id = #{id}</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="5-3-gong-neng-ce-shi">5.3 功能测试</span></h3><p>本次测试直接通过<strong>前后端联调测试</strong> ，可使用Debug方式启动项目，观察运行中步骤。</p>
<p>进入菜品列表查询页面，对第一个菜品的价格进行修改</p>
<img src="/2024/09/26/projection-skytogo/image-20221122141233080.png" alt="image-20221122141233080" style="zoom:50%;"> 

<p>点击修改，回显成功</p>
<img src="/2024/09/26/projection-skytogo/image-20221122141348677.png" alt="image-20221122141348677" style="zoom:50%;"> 

<p>菜品价格修改后，点击保存</p>
<img src="/2024/09/26/projection-skytogo/image-20221122141456498.png" alt="image-20221122141456498" style="zoom:50%;"> 

<p>修改成功</p>
<h3><span id="5-4-dai-ma-ti-jiao">5.4 代码提交</span></h3><img src="/2024/09/26/projection-skytogo/image-20221122141554380.png" alt="image-20221122141554380" style="zoom:50%;"> 

<p>后续步骤和上述功能代码提交一致，不再赘述。</p>
<h1><span id="cang-qiong-wai-mai-day04">苍穹外卖-day04</span></h1><h2><span id="1-xin-zeng-tao-can">1. 新增套餐</span></h2><h3><span id="1-1-xu-qiu-fen-xi-he-she-ji">1.1 需求分析和设计</span></h3><p>产品原型：</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221018135930842.png" alt="image-20221018135930842"></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221018140833345.png" alt="image-20221018140833345"></p>
<p>业务规则：</p>
<ul>
<li>套餐名称唯一</li>
<li>套餐必须属于某个分类</li>
<li>套餐必须包含菜品</li>
<li>名称、分类、价格、图片为必填项</li>
<li>添加菜品窗口需要根据分类类型来展示菜品</li>
<li>新增的套餐默认为停售状态</li>
</ul>
<p>接口设计（共涉及到4个接口）：</p>
<ul>
<li>根据类型查询分类（已完成）</li>
<li>根据分类id查询菜品</li>
<li>图片上传（已完成）</li>
<li>新增套餐</li>
</ul>
<p><img src="/2024/09/26/projection-skytogo/image-20221018141521068.png" alt="image-20221018141521068"></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221018141606787.png" alt="image-20221018141606787"></p>
<p>数据库设计：</p>
<p>setmeal表为套餐表，用于存储套餐的信息。具体表结构如下：</p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>数据类型</th>
<th>说明</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>bigint</td>
<td>主键</td>
<td>自增</td>
</tr>
<tr>
<td>name</td>
<td>varchar(32)</td>
<td>套餐名称</td>
<td>唯一</td>
</tr>
<tr>
<td>category_id</td>
<td>bigint</td>
<td>分类id</td>
<td>逻辑外键</td>
</tr>
<tr>
<td>price</td>
<td>decimal(10,2)</td>
<td>套餐价格</td>
<td></td>
</tr>
<tr>
<td>image</td>
<td>varchar(255)</td>
<td>图片路径</td>
<td></td>
</tr>
<tr>
<td>description</td>
<td>varchar(255)</td>
<td>套餐描述</td>
<td></td>
</tr>
<tr>
<td>status</td>
<td>int</td>
<td>售卖状态</td>
<td>1起售 0停售</td>
</tr>
<tr>
<td>create_time</td>
<td>datetime</td>
<td>创建时间</td>
<td></td>
</tr>
<tr>
<td>update_time</td>
<td>datetime</td>
<td>最后修改时间</td>
<td></td>
</tr>
<tr>
<td>create_user</td>
<td>bigint</td>
<td>创建人id</td>
<td></td>
</tr>
<tr>
<td>update_user</td>
<td>bigint</td>
<td>最后修改人id</td>
<td></td>
</tr>
</tbody></table>
<p>setmeal_dish表为套餐菜品关系表，用于存储套餐和菜品的关联关系。具体表结构如下：</p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>数据类型</th>
<th>说明</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>bigint</td>
<td>主键</td>
<td>自增</td>
</tr>
<tr>
<td>setmeal_id</td>
<td>bigint</td>
<td>套餐id</td>
<td>逻辑外键</td>
</tr>
<tr>
<td>dish_id</td>
<td>bigint</td>
<td>菜品id</td>
<td>逻辑外键</td>
</tr>
<tr>
<td>name</td>
<td>varchar(32)</td>
<td>菜品名称</td>
<td>冗余字段</td>
</tr>
<tr>
<td>price</td>
<td>decimal(10,2)</td>
<td>菜品单价</td>
<td>冗余字段</td>
</tr>
<tr>
<td>copies</td>
<td>int</td>
<td>菜品份数</td>
<td></td>
</tr>
</tbody></table>
<h3><span id="1-2-dai-ma-shi-xian">1.2 代码实现</span></h3><h4><span id="1-2-1-dishcontroller">1.2.1 DishController</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据分类id查询菜品</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> categoryId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@GetMapping("/list")</span></span><br><span class="line"><span class="meta">@ApiOperation("根据分类id查询菜品")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;List&lt;Dish&gt;&gt; <span class="title function_">list</span><span class="params">(Long categoryId)</span>{</span><br><span class="line">    List&lt;Dish&gt; list = dishService.list(categoryId);</span><br><span class="line">    <span class="keyword">return</span> Result.success(list);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-2-dishservice">1.2.2 DishService</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据分类id查询菜品</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> categoryId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">List&lt;Dish&gt; <span class="title function_">list</span><span class="params">(Long categoryId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-3-dishserviceimpl">1.2.3 DishServiceImpl</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据分类id查询菜品</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> categoryId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Dish&gt; <span class="title function_">list</span><span class="params">(Long categoryId)</span> {</span><br><span class="line">    <span class="type">Dish</span> <span class="variable">dish</span> <span class="operator">=</span> Dish.builder()</span><br><span class="line">        .categoryId(categoryId)</span><br><span class="line">        .status(StatusConstant.ENABLE)</span><br><span class="line">        .build();</span><br><span class="line">    <span class="keyword">return</span> dishMapper.list(dish);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-4-dishmapper">1.2.4 DishMapper</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 动态条件查询菜品</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dish</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">List&lt;Dish&gt; <span class="title function_">list</span><span class="params">(Dish dish)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-5-dishmapper-xml">1.2.5 DishMapper.xml</span></h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"list"</span> <span class="attr">resultType</span>=<span class="string">"Dish"</span> <span class="attr">parameterType</span>=<span class="string">"Dish"</span>&gt;</span></span><br><span class="line">    select * from dish</span><br><span class="line">    <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"name != null"</span>&gt;</span></span><br><span class="line">            and name like concat('%',#{name},'%')</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"categoryId != null"</span>&gt;</span></span><br><span class="line">            and category_id = #{categoryId}</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"status != null"</span>&gt;</span></span><br><span class="line">            and status = #{status}</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">    order by create_time desc</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-6-setmealcontroller">1.2.6 SetmealController</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 套餐管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/admin/setmeal")</span></span><br><span class="line"><span class="meta">@Api(tags = "套餐相关接口")</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SetmealController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SetmealService setmealService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增套餐</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="meta">@ApiOperation("新增套餐")</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> SetmealDTO setmealDTO)</span> {</span><br><span class="line">        setmealService.saveWithDish(setmealDTO);</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-7-setmealservice">1.2.7 SetmealService</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SetmealService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增套餐，同时需要保存套餐和菜品的关联关系</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealDTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">saveWithDish</span><span class="params">(SetmealDTO setmealDTO)</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-8-setmealserviceimpl">1.2.8 SetmealServiceImpl</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 套餐业务实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SetmealServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">SetmealService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SetmealMapper setmealMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SetmealDishMapper setmealDishMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishMapper dishMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增套餐，同时需要保存套餐和菜品的关联关系</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealDTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveWithDish</span><span class="params">(SetmealDTO setmealDTO)</span> {</span><br><span class="line">        <span class="type">Setmeal</span> <span class="variable">setmeal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Setmeal</span>();</span><br><span class="line">        BeanUtils.copyProperties(setmealDTO, setmeal);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//向套餐表插入数据</span></span><br><span class="line">        setmealMapper.insert(setmeal);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取生成的套餐id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">setmealId</span> <span class="operator">=</span> setmeal.getId();</span><br><span class="line"></span><br><span class="line">        List&lt;SetmealDish&gt; setmealDishes = setmealDTO.getSetmealDishes();</span><br><span class="line">        setmealDishes.forEach(setmealDish -&gt; {</span><br><span class="line">            setmealDish.setSetmealId(setmealId);</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        <span class="comment">//保存套餐和菜品的关联关系</span></span><br><span class="line">        setmealDishMapper.insertBatch(setmealDishes);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-9-setmealmapper">1.2.9 SetmealMapper</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增套餐</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmeal</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@AutoFill(OperationType.INSERT)</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(Setmeal setmeal)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-10-setmealmapper-xml">1.2.10 SetmealMapper.xml</span></h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insert"</span> <span class="attr">parameterType</span>=<span class="string">"Setmeal"</span> <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span>&gt;</span></span><br><span class="line">    insert into setmeal</span><br><span class="line">    (category_id, name, price, status, description, image, create_time, update_time, create_user, update_user)</span><br><span class="line">    values (#{categoryId}, #{name}, #{price}, #{status}, #{description}, #{image}, #{createTime}, #{updateTime},</span><br><span class="line">    #{createUser}, #{updateUser})</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-11-setmealdishmapper">1.2.11 SetmealDishMapper</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量保存套餐和菜品的关联关系</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealDishes</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">insertBatch</span><span class="params">(List&lt;SetmealDish&gt; setmealDishes)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-12-setmealdishmapper-xml">1.2.12 SetmealDishMapper.xml</span></h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertBatch"</span> <span class="attr">parameterType</span>=<span class="string">"list"</span>&gt;</span></span><br><span class="line">    insert into setmeal_dish</span><br><span class="line">    (setmeal_id,dish_id,name,price,copies)</span><br><span class="line">    values</span><br><span class="line">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">"setmealDishes"</span> <span class="attr">item</span>=<span class="string">"sd"</span> <span class="attr">separator</span>=<span class="string">","</span>&gt;</span></span><br><span class="line">        (#{sd.setmealId},#{sd.dishId},#{sd.name},#{sd.price},#{sd.copies})</span><br><span class="line">    <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3><span id="1-3-gong-neng-ce-shi">1.3 功能测试</span></h3><p>略</p>
<h2><span id="2-tao-can-fen-ye-cha-xun">2. 套餐分页查询</span></h2><h3><span id="2-1-xu-qiu-fen-xi-he-she-ji">2.1 需求分析和设计</span></h3><p>产品原型：</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221018152429246.png" alt="image-20221018152429246"></p>
<p>业务规则：</p>
<ul>
<li>根据页码进行分页展示</li>
<li>每页展示10条数据</li>
<li>可以根据需要，按照套餐名称、分类、售卖状态进行查询</li>
</ul>
<p>接口设计：</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221018152731141.png" alt="image-20221018152731141"></p>
<h3><span id="2-2-dai-ma-shi-xian">2.2 代码实现</span></h3><h4><span id="2-2-1-setmealcontroller">2.2.1 SetmealController</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分页查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealPageQueryDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@GetMapping("/page")</span></span><br><span class="line"><span class="meta">@ApiOperation("分页查询")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;PageResult&gt; <span class="title function_">page</span><span class="params">(SetmealPageQueryDTO setmealPageQueryDTO)</span> {</span><br><span class="line">    <span class="type">PageResult</span> <span class="variable">pageResult</span> <span class="operator">=</span> setmealService.pageQuery(setmealPageQueryDTO);</span><br><span class="line">    <span class="keyword">return</span> Result.success(pageResult);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-2-2-setmealservice">2.2.2 SetmealService</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分页查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealPageQueryDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">PageResult <span class="title function_">pageQuery</span><span class="params">(SetmealPageQueryDTO setmealPageQueryDTO)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-2-3-setmealserviceimpl">2.2.3 SetmealServiceImpl</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分页查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealPageQueryDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> PageResult <span class="title function_">pageQuery</span><span class="params">(SetmealPageQueryDTO setmealPageQueryDTO)</span> {</span><br><span class="line">    <span class="type">int</span> <span class="variable">pageNum</span> <span class="operator">=</span> setmealPageQueryDTO.getPage();</span><br><span class="line">    <span class="type">int</span> <span class="variable">pageSize</span> <span class="operator">=</span> setmealPageQueryDTO.getPageSize();</span><br><span class="line"></span><br><span class="line">    PageHelper.startPage(pageNum, pageSize);</span><br><span class="line">    Page&lt;SetmealVO&gt; page = setmealMapper.pageQuery(setmealPageQueryDTO);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageResult</span>(page.getTotal(), page.getResult());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-2-4-setmealmapper">2.2.4 SetmealMapper</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分页查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealPageQueryDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">Page&lt;SetmealVO&gt; <span class="title function_">pageQuery</span><span class="params">(SetmealPageQueryDTO setmealPageQueryDTO)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-2-5-setmealmapper-xml">2.2.5 SetmealMapper.xml</span></h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"pageQuery"</span> <span class="attr">resultType</span>=<span class="string">"com.sky.vo.SetmealVO"</span>&gt;</span></span><br><span class="line">    select</span><br><span class="line">    	s.*,c.name categoryName</span><br><span class="line">    from</span><br><span class="line">    	setmeal s</span><br><span class="line">    left join</span><br><span class="line">    	category c</span><br><span class="line">    on</span><br><span class="line">    	s.category_id = c.id</span><br><span class="line">    <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"name != null"</span>&gt;</span></span><br><span class="line">            and s.name like concat('%',#{name},'%')</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"status != null"</span>&gt;</span></span><br><span class="line">            and s.status = #{status}</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"categoryId != null"</span>&gt;</span></span><br><span class="line">            and s.category_id = #{categoryId}</span><br><span class="line">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">    order by s.create_time desc</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3><span id="2-3-gong-neng-ce-shi">2.3 功能测试</span></h3><p>略</p>
<h2><span id="3-shan-chu-tao-can">3. 删除套餐</span></h2><h3><span id="3-1-xu-qiu-fen-xi-he-she-ji">3.1 需求分析和设计</span></h3><p>产品原型：</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221018153756531.png" alt="image-20221018153756531"></p>
<p>业务规则：</p>
<ul>
<li>可以一次删除一个套餐，也可以批量删除套餐</li>
<li>起售中的套餐不能删除</li>
</ul>
<p>接口设计：</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221018154541067.png" alt="image-20221018154541067"></p>
<h3><span id="3-2-dai-ma-shi-xian">3.2 代码实现</span></h3><h4><span id="3-2-1-setmealcontroller">3.2.1 SetmealController</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量删除套餐</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ids</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@DeleteMapping</span></span><br><span class="line"><span class="meta">@ApiOperation("批量删除套餐")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">delete</span><span class="params">(<span class="meta">@RequestParam</span> List&lt;Long&gt; ids)</span>{</span><br><span class="line">    setmealService.deleteBatch(ids);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="3-2-2-setmealservice">3.2.2 SetmealService</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量删除套餐</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ids</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">deleteBatch</span><span class="params">(List&lt;Long&gt; ids)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="3-2-3-setmealserviceimpl">3.2.3 SetmealServiceImpl</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量删除套餐</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ids</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteBatch</span><span class="params">(List&lt;Long&gt; ids)</span> {</span><br><span class="line">    ids.forEach(id -&gt; {</span><br><span class="line">        <span class="type">Setmeal</span> <span class="variable">setmeal</span> <span class="operator">=</span> setmealMapper.getById(id);</span><br><span class="line">        <span class="keyword">if</span>(StatusConstant.ENABLE == setmeal.getStatus()){</span><br><span class="line">            <span class="comment">//起售中的套餐不能删除</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DeletionNotAllowedException</span>(MessageConstant.SETMEAL_ON_SALE);</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    ids.forEach(setmealId -&gt; {</span><br><span class="line">        <span class="comment">//删除套餐表中的数据</span></span><br><span class="line">        setmealMapper.deleteById(setmealId);</span><br><span class="line">        <span class="comment">//删除套餐菜品关系表中的数据</span></span><br><span class="line">        setmealDishMapper.deleteBySetmealId(setmealId);</span><br><span class="line">    });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="3-2-4-setmealmapper">3.2.4 SetmealMapper</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询套餐</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Select("select * from setmeal where id = #{id}")</span></span><br><span class="line">Setmeal <span class="title function_">getById</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id删除套餐</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealId</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Delete("delete from setmeal where id = #{id}")</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">deleteById</span><span class="params">(Long setmealId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="3-2-5-setmealdishmapper">3.2.5 SetmealDishMapper</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据套餐id删除套餐和菜品的关联关系</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealId</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Delete("delete from setmeal_dish where setmeal_id = #{setmealId}")</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">deleteBySetmealId</span><span class="params">(Long setmealId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h3><span id="3-3-gong-neng-ce-shi">3.3 功能测试</span></h3><p>略</p>
<h2><span id="4-xiu-gai-tao-can">4. 修改套餐</span></h2><h3><span id="4-1-xu-qiu-fen-xi-he-she-ji">4.1 需求分析和设计</span></h3><p>产品原型：</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221018160214225.png" alt="image-20221018160214225"></p>
<p>接口设计（共涉及到5个接口）：</p>
<ul>
<li>根据id查询套餐</li>
<li>根据类型查询分类（已完成）</li>
<li>根据分类id查询菜品（已完成）</li>
<li>图片上传（已完成）</li>
<li>修改套餐</li>
</ul>
<p><img src="/2024/09/26/projection-skytogo/image-20221018160915177.png" alt="image-20221018160915177"></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221018160949864.png" alt="image-20221018160949864"></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221018161046352.png" alt="image-20221018161046352"></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221018161117780.png" alt="image-20221018161117780"></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221018161139861.png" alt="image-20221018161139861"></p>
<h3><span id="4-2-dai-ma-shi-xian">4.2 代码实现</span></h3><h4><span id="4-2-1-setmealcontroller">4.2.1 SetmealController</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询套餐，用于修改页面回显数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@GetMapping("/{id}")</span></span><br><span class="line"><span class="meta">@ApiOperation("根据id查询套餐")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;SetmealVO&gt; <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> {</span><br><span class="line">    <span class="type">SetmealVO</span> <span class="variable">setmealVO</span> <span class="operator">=</span> setmealService.getByIdWithDish(id);</span><br><span class="line">    <span class="keyword">return</span> Result.success(setmealVO);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改套餐</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@PutMapping</span></span><br><span class="line"><span class="meta">@ApiOperation("修改套餐")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> SetmealDTO setmealDTO)</span> {</span><br><span class="line">    setmealService.update(setmealDTO);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-2-2-setmealservice">4.2.2 SetmealService</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询套餐和关联的菜品数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">SetmealVO <span class="title function_">getByIdWithDish</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改套餐</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealDTO</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">update</span><span class="params">(SetmealDTO setmealDTO)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-2-3-setmealserviceimpl">4.2.3 SetmealServiceImpl</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询套餐和套餐菜品关系</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> SetmealVO <span class="title function_">getByIdWithDish</span><span class="params">(Long id)</span> {</span><br><span class="line">    <span class="type">Setmeal</span> <span class="variable">setmeal</span> <span class="operator">=</span> setmealMapper.getById(id);</span><br><span class="line">    List&lt;SetmealDish&gt; setmealDishes = setmealDishMapper.getBySetmealId(id);</span><br><span class="line"></span><br><span class="line">    <span class="type">SetmealVO</span> <span class="variable">setmealVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SetmealVO</span>();</span><br><span class="line">    BeanUtils.copyProperties(setmeal, setmealVO);</span><br><span class="line">    setmealVO.setSetmealDishes(setmealDishes);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> setmealVO;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改套餐</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealDTO</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(SetmealDTO setmealDTO)</span> {</span><br><span class="line">    <span class="type">Setmeal</span> <span class="variable">setmeal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Setmeal</span>();</span><br><span class="line">    BeanUtils.copyProperties(setmealDTO, setmeal);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1、修改套餐表，执行update</span></span><br><span class="line">    setmealMapper.update(setmeal);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//套餐id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">setmealId</span> <span class="operator">=</span> setmealDTO.getId();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、删除套餐和菜品的关联关系，操作setmeal_dish表，执行delete</span></span><br><span class="line">    setmealDishMapper.deleteBySetmealId(setmealId);</span><br><span class="line"></span><br><span class="line">    List&lt;SetmealDish&gt; setmealDishes = setmealDTO.getSetmealDishes();</span><br><span class="line">    setmealDishes.forEach(setmealDish -&gt; {</span><br><span class="line">        setmealDish.setSetmealId(setmealId);</span><br><span class="line">    });</span><br><span class="line">    <span class="comment">//3、重新插入套餐和菜品的关联关系，操作setmeal_dish表，执行insert</span></span><br><span class="line">    setmealDishMapper.insertBatch(setmealDishes);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-2-4-setmealdishmapper">4.2.4 SetmealDishMapper</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据套餐id查询套餐和菜品的关联关系</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> setmealId</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Select("select * from setmeal_dish where setmeal_id = #{setmealId}")</span></span><br><span class="line">   List&lt;SetmealDish&gt; <span class="title function_">getBySetmealId</span><span class="params">(Long setmealId)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-3-gong-neng-ce-shi">4.3 功能测试</span></h3><p>略</p>
<h2><span id="5-qi-shou-ting-shou-tao-can">5. 起售停售套餐</span></h2><h3><span id="5-1-xu-qiu-fen-xi-he-she-ji">5.1 需求分析和设计</span></h3><p>产品原型：</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221018163720881.png" alt="image-20221018163720881"></p>
<p>业务规则：</p>
<ul>
<li>可以对状态为起售的套餐进行停售操作，可以对状态为停售的套餐进行起售操作</li>
<li>起售的套餐可以展示在用户端，停售的套餐不能展示在用户端</li>
<li>起售套餐时，如果套餐内包含停售的菜品，则不能起售</li>
</ul>
<p>接口设计：</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221018165055208.png" alt="image-20221018165055208"></p>
<h3><span id="5-2-dai-ma-shi-xian">5.2 代码实现</span></h3><h4><span id="5-2-1-setmealcontroller">5.2.1 SetmealController</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 套餐起售停售</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@PostMapping("/status/{status}")</span></span><br><span class="line"><span class="meta">@ApiOperation("套餐起售停售")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">startOrStop</span><span class="params">(<span class="meta">@PathVariable</span> Integer status, Long id)</span> {</span><br><span class="line">    setmealService.startOrStop(status, id);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="5-2-2-setmealservice">5.2.2 SetmealService</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 套餐起售、停售</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">startOrStop</span><span class="params">(Integer status, Long id)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="5-2-3-setmealserviceimpl">5.2.3 SetmealServiceImpl</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 套餐起售、停售</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startOrStop</span><span class="params">(Integer status, Long id)</span> {</span><br><span class="line">    <span class="comment">//起售套餐时，判断套餐内是否有停售菜品，有停售菜品提示"套餐内包含未启售菜品，无法启售"</span></span><br><span class="line">    <span class="keyword">if</span>(status == StatusConstant.ENABLE){</span><br><span class="line">        <span class="comment">//select a.* from dish a left join setmeal_dish b on a.id = b.dish_id where b.setmeal_id = ?</span></span><br><span class="line">        List&lt;Dish&gt; dishList = dishMapper.getBySetmealId(id);</span><br><span class="line">        <span class="keyword">if</span>(dishList != <span class="literal">null</span> &amp;&amp; dishList.size() &gt; <span class="number">0</span>){</span><br><span class="line">            dishList.forEach(dish -&gt; {</span><br><span class="line">                <span class="keyword">if</span>(StatusConstant.DISABLE == dish.getStatus()){</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SetmealEnableFailedException</span>(MessageConstant.SETMEAL_ENABLE_FAILED);</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">Setmeal</span> <span class="variable">setmeal</span> <span class="operator">=</span> Setmeal.builder()</span><br><span class="line">        .id(id)</span><br><span class="line">        .status(status)</span><br><span class="line">        .build();</span><br><span class="line">    setmealMapper.update(setmeal);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="5-2-4-dishmapper">5.2.4 DishMapper</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据套餐id查询菜品</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmealId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Select("select a.* from dish a left join setmeal_dish b on a.id = b.dish_id where b.setmeal_id = #{setmealId}")</span></span><br><span class="line">List&lt;Dish&gt; <span class="title function_">getBySetmealId</span><span class="params">(Long setmealId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h3><span id="5-3-gong-neng-ce-shi">5.3 功能测试</span></h3><p>略</p>
<h1><span id="cang-qiong-wai-mai-day05">苍穹外卖-day05</span></h1><h2><span id="ke-cheng-nei-rong">课程内容</span></h2><ul>
<li>Redis入门</li>
<li>Redis数据类型</li>
<li>Redis常用命令</li>
<li>在Java中操作Redis</li>
<li>店铺营业状态设置</li>
</ul>
<p>功能实现：<strong>营业状态设置</strong></p>
<p><strong>效果图：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221130223019209.png" alt="image-20221130223019209" style="zoom:50%;"> 

<p>选择<strong>营业中</strong>，客户可在小程序端下单：</p>
<img src="/2024/09/26/projection-skytogo/image-20221130223113561.png" alt="image-20221130223113561" style="zoom:50%;"> 

<p>选择<strong>打烊中</strong>，客户无法在小程序端下单：</p>
<img src="/2024/09/26/projection-skytogo/image-20221130223205032.png" alt="image-20221130223205032" style="zoom:50%;"> 





<h2><span id="1-redis-ru-men">1. Redis入门</span></h2><h3><span id="1-1-redis-jian-jie">1.1 Redis简介</span></h3><p>Redis是一个基于<strong>内存</strong>的key-value结构数据库。Redis 是互联网技术领域使用最为广泛的<strong>存储中间件</strong>。</p>
<p><strong>官网：</strong><a target="_blank" rel="noopener" href="https://redis.io/">https://redis.io</a><br><strong>中文网：</strong><a target="_blank" rel="noopener" href="https://www.redis.net.cn/">https://www.redis.net.cn/</a></p>
<p><strong>key-value结构存储：</strong></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221130173459174.png" alt="image-20221130173459174"> </p>
<p><strong>主要特点：</strong></p>
<ul>
<li>基于内存存储，读写性能高  </li>
<li>适合存储热点数据（热点商品、资讯、新闻）</li>
<li>企业应用广泛</li>
</ul>
<p>Redis是用C语言开发的一个开源的高性能键值对(key-value)数据库，官方提供的数据是可以达到100000+的QPS（每秒内查询次数）。它存储的value类型比较丰富，也被称为结构化的NoSql数据库。</p>
<p>NoSql（Not Only SQL），不仅仅是SQL，泛指<strong>非关系型数据库</strong>。NoSql数据库并不是要取代关系型数据库，而是关系型数据库的补充。</p>
<p><strong>关系型数据库(RDBMS)：</strong></p>
<ul>
<li>Mysql</li>
<li>Oracle</li>
<li>DB2</li>
<li>SQLServer</li>
</ul>
<p><strong>非关系型数据库(NoSql)：</strong></p>
<ul>
<li>Redis</li>
<li>Mongo db</li>
<li>MemCached</li>
</ul>
<h3><span id="1-2-redis-xia-zai-yu-an-zhuang">1.2 Redis下载与安装</span></h3><h4><span id="1-2-1-redis-xia-zai">1.2.1 Redis下载</span></h4><p>Redis安装包分为windows版和Linux版：</p>
<ul>
<li>Windows版下载地址：<a target="_blank" rel="noopener" href="https://github.com/microsoftarchive/redis/releases">https://github.com/microsoftarchive/redis/releases</a></li>
<li>Linux版下载地址： <a target="_blank" rel="noopener" href="https://download.redis.io/releases/">https://download.redis.io/releases/</a></li>
</ul>
<p>资料中已提供好的安装包：</p>
<p><img src="/2024/09/26/projection-skytogo/image-20210927092053283.png" alt="image-20210927092053283"> </p>
<h4><span id="1-2-2-redis-an-zhuang">1.2.2 Redis安装</span></h4><p><strong>1）在Windows中安装Redis(项目中使用)</strong></p>
<p>Redis的Windows版属于绿色软件，直接解压即可使用，解压后目录结构如下：</p>
<img src="/2024/09/26/projection-skytogo/image-20221130180657152.png" alt="image-20221130180657152" style="zoom:50%;"> 



<p><strong>2）在Linux中安装Redis(简单了解)</strong></p>
<p>在Linux系统安装Redis步骤：</p>
<ol>
<li>将Redis安装包上传到Linux</li>
<li>解压安装包，命令：tar -zxvf redis-4.0.0.tar.gz -C /usr/local</li>
<li>安装Redis的依赖环境gcc，命令：yum install gcc-c++</li>
<li>进入/usr/local/redis-4.0.0，进行编译，命令：make</li>
<li>进入redis的src目录进行安装，命令：make install</li>
</ol>
<p>安装后重点文件说明：</p>
<ul>
<li>/usr/local/redis-4.0.0/src/redis-server：Redis服务启动脚本</li>
<li>/usr/local/redis-4.0.0/src/redis-cli：Redis客户端脚本</li>
<li>/usr/local/redis-4.0.0/redis.conf：Redis配置文件</li>
</ul>
<h3><span id="1-3-redis-fu-wu-qi-dong-yu-ting-zhi">1.3 Redis服务启动与停止</span></h3><p>以window版Redis进行演示：</p>
<h4><span id="1-3-1-fu-wu-qi-dong-ming-ling">1.3.1 服务启动命令</span></h4><p><strong>redis-server.exe redis.windows.conf</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221130181950351.png" alt="image-20221130181950351" style="zoom:50%;"> 

<p>Redis服务默认端口号为 <strong>6379</strong> ，通过快捷键<strong>Ctrl + C</strong> 即可停止Redis服务</p>
<p>当Redis服务启动成功后，可通过客户端进行连接。</p>
<h4><span id="1-3-2-ke-hu-duan-lian-jie-ming-ling">1.3.2 客户端连接命令</span></h4><p><strong>redis-cli.exe</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221130182207020.png" alt="image-20221130182207020" style="zoom:50%;"> 

<p>通过redis-cli.exe命令默认连接的是本地的redis服务，并且使用默认6379端口。也可以通过指定如下参数连接：</p>
<ul>
<li>-h ip地址</li>
<li>-p 端口号</li>
<li>-a 密码（如果需要）</li>
</ul>
<h4><span id="1-3-3-xiu-gai-redis-pei-zhi-wen-jian">1.3.3 修改Redis配置文件</span></h4><p>设置Redis服务密码，修改redis.windows.conf</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requirepass 123456</span><br></pre></td></tr></tbody></table></figure>

<p><strong>注意：</strong></p>
<ul>
<li>修改密码后需要重启Redis服务才能生效</li>
<li>Redis配置文件中 # 表示注释</li>
</ul>
<p>重启Redis后，再次连接Redis时，需加上密码，否则连接失败。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli.exe -h localhost -p 6379 -a 123456</span><br></pre></td></tr></tbody></table></figure>

<img src="/2024/09/26/projection-skytogo/image-20221130183253539.png" alt="image-20221130183253539" style="zoom:50%;"> 

<p>此时，-h 和 -p 参数可省略不写。</p>
<h4><span id="1-3-4-redis-ke-hu-duan-tu-xing-gong-ju">1.3.4 Redis客户端图形工具</span></h4><p>默认提供的客户端连接工具界面不太友好，同时操作也较为麻烦，接下来，引入一个Redis客户端图形工具。</p>
<p>在当天资料中已提供安装包，直接安装即可。</p>
<img src="/2024/09/26/projection-skytogo/image-20221130183746355.png" alt="image-20221130183746355" style="zoom:50%;"> 

<p>安装完毕后，直接双击启动</p>
<p><strong>新建连接</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221130192210418.png" alt="image-20221130192210418" style="zoom: 33%;">  

<p><strong>连接成功</strong> </p>
<img src="/2024/09/26/projection-skytogo/image-20221130192310916.png" alt="image-20221130192310916" style="zoom: 33%;">  





<h2><span id="2-redis-shu-ju-lei-xing">2. Redis数据类型</span></h2><h3><span id="2-1-wu-chong-chang-yong-shu-ju-lei-xing-jie-shao">2.1 五种常用数据类型介绍</span></h3><p>Redis存储的是key-value结构的数据，其中key是字符串类型，value有5种常用的数据类型：</p>
<ul>
<li>字符串 string</li>
<li>哈希 hash</li>
<li>列表 list</li>
<li>集合 set</li>
<li>有序集合 sorted set / zset</li>
</ul>
<h3><span id="2-2-ge-chong-shu-ju-lei-xing-te-dian">2.2 各种数据类型特点</span></h3><img src="/2024/09/26/projection-skytogo/image-20221130190150749.png" alt="image-20221130190150749" style="zoom:50%;"> 

<p><strong>解释说明：</strong></p>
<ul>
<li>字符串(string)：普通字符串，Redis中最简单的数据类型</li>
<li>哈希(hash)：也叫散列，类似于Java中的HashMap结构</li>
<li>列表(list)：按照插入顺序排序，可以有重复元素，类似于Java中的LinkedList</li>
<li>集合(set)：无序集合，没有重复元素，类似于Java中的HashSet</li>
<li>有序集合(sorted set/zset)：集合中每个元素关联一个分数(score)，根据分数升序排序，没有重复元素</li>
</ul>
<h2><span id="3-redis-chang-yong-ming-ling">3. Redis常用命令</span></h2><h3><span id="3-1-zi-fu-chuan-cao-zuo-ming-ling">3.1 字符串操作命令</span></h3><p>Redis 中字符串类型常用命令：</p>
<ul>
<li><strong>SET</strong> key value 					         设置指定key的值</li>
<li><strong>GET</strong> key                                        获取指定key的值</li>
<li><strong>SETEX</strong> key seconds value         设置指定key的值，并将 key 的过期时间设为 seconds 秒</li>
<li><strong>SETNX</strong> key value                        只有在 key    不存在时设置 key 的值</li>
</ul>
<p>更多命令可以参考Redis中文网：<a target="_blank" rel="noopener" href="https://www.redis.net.cn/">https://www.redis.net.cn</a></p>
<h3><span id="3-2-ha-xi-cao-zuo-ming-ling">3.2 哈希操作命令</span></h3><p>Redis hash 是一个string类型的 field 和 value 的映射表，hash特别适合用于存储对象，常用命令：</p>
<ul>
<li><strong>HSET</strong> key field value             将哈希表 key 中的字段 field 的值设为 value</li>
<li><strong>HGET</strong> key field                       获取存储在哈希表中指定字段的值</li>
<li><strong>HDEL</strong> key field                       删除存储在哈希表中的指定字段</li>
<li><strong>HKEYS</strong> key                              获取哈希表中所有字段</li>
<li><strong>HVALS</strong> key                              获取哈希表中所有值</li>
</ul>
<img src="/2024/09/26/projection-skytogo/image-20221130193121969.png" alt="image-20221130193121969" style="zoom: 67%;"> 



<h3><span id="3-3-lie-biao-cao-zuo-ming-ling">3.3 列表操作命令</span></h3><p>Redis 列表是简单的字符串列表，按照插入顺序排序，常用命令：</p>
<ul>
<li><strong>LPUSH</strong> key value1 [value2]         将一个或多个值插入到列表头部</li>
<li><strong>LRANGE</strong> key start stop                获取列表指定范围内的元素</li>
<li><strong>RPOP</strong> key                                       移除并获取列表最后一个元素</li>
<li><strong>LLEN</strong> key                                        获取列表长度</li>
<li><strong>BRPOP</strong> key1 [key2 ] timeout       移出并获取列表的最后一个元素， 如果列表没有元素会阻塞列表直到等待超    时或发现可弹出元素为止</li>
</ul>
<img src="/2024/09/26/projection-skytogo/image-20221130193332666.png" alt="image-20221130193332666" style="zoom: 67%;"> 



<h3><span id="3-4-ji-he-cao-zuo-ming-ling">3.4 集合操作命令</span></h3><p>Redis set 是string类型的无序集合。集合成员是唯一的，这就意味着集合中不能出现重复的数据，常用命令：</p>
<ul>
<li><strong>SADD</strong> key member1 [member2]            向集合添加一个或多个成员</li>
<li><strong>SMEMBERS</strong> key                                         返回集合中的所有成员</li>
<li><strong>SCARD</strong> key                                                  获取集合的成员数</li>
<li><strong>SINTER</strong> key1 [key2]                                   返回给定所有集合的交集</li>
<li><strong>SUNION</strong> key1 [key2]                                 返回所有给定集合的并集</li>
<li><strong>SREM</strong> key member1 [member2]            移除集合中一个或多个成员</li>
</ul>
<img src="/2024/09/26/projection-skytogo/image-20221130193532735.png" alt="image-20221130193532735" style="zoom: 67%;"> 



<h3><span id="3-5-you-xu-ji-he-cao-zuo-ming-ling">3.5 有序集合操作命令</span></h3><p>Redis有序集合是string类型元素的集合，且不允许有重复成员。每个元素都会关联一个double类型的分数。常用命令：</p>
<p>常用命令：</p>
<ul>
<li><strong>ZADD</strong> key score1 member1 [score2 member2]     向有序集合添加一个或多个成员</li>
<li><strong>ZRANGE</strong> key start stop [WITHSCORES]                     通过索引区间返回有序集合中指定区间内的成员</li>
<li><strong>ZINCRBY</strong> key increment member                              有序集合中对指定成员的分数加上增量 increment</li>
<li><strong>ZREM</strong> key member [member …]                                移除有序集合中的一个或多个成员</li>
</ul>
<img src="/2024/09/26/projection-skytogo/image-20221130193951036.png" alt="image-20221130193951036" style="zoom: 67%;"> 



<h3><span id="3-6-tong-yong-ming-ling">3.6 通用命令</span></h3><p>Redis的通用命令是不分数据类型的，都可以使用的命令：</p>
<ul>
<li>KEYS pattern 		查找所有符合给定模式( pattern)的 key </li>
<li>EXISTS key 		检查给定 key 是否存在</li>
<li>TYPE key 		返回 key 所储存的值的类型</li>
<li>DEL key 		该命令用于在 key 存在是删除 key</li>
</ul>
<h2><span id="4-zai-java-zhong-cao-zuo-redis">4.在Java中操作Redis</span></h2><h3><span id="4-1-redis-de-java-ke-hu-duan">4.1 Redis的Java客户端</span></h3><p>前面我们讲解了Redis的常用命令，这些命令是我们操作Redis的基础，那么我们在java程序中应该如何操作Redis呢？这就需要使用Redis的Java客户端，就如同我们使用JDBC操作MySQL数据库一样。</p>
<p>Redis 的 Java 客户端很多，常用的几种：</p>
<ul>
<li>Jedis</li>
<li>Lettuce</li>
<li>Spring Data Redis</li>
</ul>
<p>Spring 对 Redis 客户端进行了整合，提供了 Spring Data Redis，在Spring Boot项目中还提供了对应的Starter，即 spring-boot-starter-data-redis。</p>
<p>我们重点学习<strong>Spring Data Redis</strong>。</p>
<h3><span id="4-2-spring-data-redis-shi-yong-fang-shi">4.2 Spring Data Redis使用方式</span></h3><h4><span id="4-2-1-jie-shao">4.2.1 介绍</span></h4><p>Spring Data Redis 是 Spring 的一部分，提供了在 Spring 应用中通过简单的配置就可以访问 Redis 服务，对 Redis 底层开发包进行了高度封装。在 Spring 项目中，可以使用Spring Data Redis来简化 Redis 操作。</p>
<p>网址：<a target="_blank" rel="noopener" href="https://spring.io/projects/spring-data-redis">https://spring.io/projects/spring-data-redis</a></p>
<img src="/2024/09/26/projection-skytogo/image-20210927143741458.png" alt="image-20210927143741458" style="zoom: 33%;"> 

<p>Spring Boot提供了对应的Starter，maven坐标：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>Spring Data Redis中提供了一个高度封装的类：<strong>RedisTemplate</strong>，对相关api进行了归类封装,将同一类型操作封装为operation接口，具体分类如下：</p>
<ul>
<li>ValueOperations：string数据操作</li>
<li>SetOperations：set类型数据操作</li>
<li>ZSetOperations：zset类型数据操作</li>
<li>HashOperations：hash类型的数据操作</li>
<li>ListOperations：list类型的数据操作</li>
</ul>
<h4><span id="4-2-2-huan-jing-da-jian">4.2.2 环境搭建</span></h4><p>进入到sky-server模块</p>
<p><strong>1). 导入Spring Data Redis的maven坐标(已完成)</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<p><strong>2). 配置Redis数据源</strong></p>
<p>在application-dev.yml中添加</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sky:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">10</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>解释说明：</strong></p>
<p>database:指定使用Redis的哪个数据库，Redis服务启动后默认有16个数据库，编号分别是从0到15。</p>
<p>可以通过修改Redis配置文件来指定数据库的数量。</p>
<p>在application.yml中添加读取application-dev.yml中的相关Redis配置</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">${sky.redis.host}</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">${sky.redis.port}</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">${sky.redis.password}</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">${sky.redis.database}</span></span><br></pre></td></tr></tbody></table></figure>



<p><strong>3). 编写配置类，创建RedisTemplate对象</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfiguration</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span>{</span><br><span class="line">        log.info(<span class="string">"开始创建redis模板对象..."</span>);</span><br><span class="line">        <span class="type">RedisTemplate</span> <span class="variable">redisTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>();</span><br><span class="line">        <span class="comment">//设置redis的连接工厂对象</span></span><br><span class="line">        redisTemplate.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        <span class="comment">//设置redis key的序列化器</span></span><br><span class="line">        redisTemplate.setKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>解释说明：</strong></p>
<p>当前配置类不是必须的，因为 Spring Boot 框架会自动装配 RedisTemplate 对象，但是默认的key序列化器为</p>
<p>JdkSerializationRedisSerializer，导致我们存到Redis中后的数据和原始数据有差别，故设置为</p>
<p>StringRedisSerializer序列化器。</p>
<p><strong>4). 通过RedisTemplate对象操作Redis</strong></p>
<p>在test下新建测试类</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringDataRedisTest</span> {</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRedisTemplate</span><span class="params">()</span>{</span><br><span class="line">        System.out.println(redisTemplate);</span><br><span class="line">        <span class="comment">//string数据操作</span></span><br><span class="line">        <span class="type">ValueOperations</span> <span class="variable">valueOperations</span> <span class="operator">=</span> redisTemplate.opsForValue();</span><br><span class="line">        <span class="comment">//hash类型的数据操作</span></span><br><span class="line">        <span class="type">HashOperations</span> <span class="variable">hashOperations</span> <span class="operator">=</span> redisTemplate.opsForHash();</span><br><span class="line">        <span class="comment">//list类型的数据操作</span></span><br><span class="line">        <span class="type">ListOperations</span> <span class="variable">listOperations</span> <span class="operator">=</span> redisTemplate.opsForList();</span><br><span class="line">        <span class="comment">//set类型数据操作</span></span><br><span class="line">        <span class="type">SetOperations</span> <span class="variable">setOperations</span> <span class="operator">=</span> redisTemplate.opsForSet();</span><br><span class="line">        <span class="comment">//zset类型数据操作</span></span><br><span class="line">        <span class="type">ZSetOperations</span> <span class="variable">zSetOperations</span> <span class="operator">=</span> redisTemplate.opsForZSet();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>测试：</p>
<img src="/2024/09/26/projection-skytogo/image-20221130205351403.png" alt="image-20221130205351403" style="zoom:50%;"> 

<p>说明RedisTemplate对象注入成功，并且通过该RedisTemplate对象获取操作5种数据类型相关对象。</p>
<p>上述环境搭建完毕后，接下来，我们就来具体对常见5种数据类型进行操作。</p>
<h4><span id="4-2-3-cao-zuo-chang-jian-lei-xing-shu-ju">4.2.3 操作常见类型数据</span></h4><p><strong>1). 操作字符串类型数据</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 操作字符串类型的数据</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testString</span><span class="params">()</span>{</span><br><span class="line">       <span class="comment">// set get setex setnx</span></span><br><span class="line">       redisTemplate.opsForValue().set(<span class="string">"name"</span>,<span class="string">"小明"</span>);</span><br><span class="line">       <span class="type">String</span> <span class="variable">city</span> <span class="operator">=</span> (String) redisTemplate.opsForValue().get(<span class="string">"name"</span>);</span><br><span class="line">       System.out.println(city);</span><br><span class="line">       redisTemplate.opsForValue().set(<span class="string">"code"</span>,<span class="string">"1234"</span>,<span class="number">3</span>, TimeUnit.MINUTES);</span><br><span class="line">       redisTemplate.opsForValue().setIfAbsent(<span class="string">"lock"</span>,<span class="string">"1"</span>);</span><br><span class="line">       redisTemplate.opsForValue().setIfAbsent(<span class="string">"lock"</span>,<span class="string">"2"</span>);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<p><strong>2). 操作哈希类型数据</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 操作哈希类型的数据</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testHash</span><span class="params">()</span>{</span><br><span class="line">       <span class="comment">//hset hget hdel hkeys hvals</span></span><br><span class="line">       <span class="type">HashOperations</span> <span class="variable">hashOperations</span> <span class="operator">=</span> redisTemplate.opsForHash();</span><br><span class="line"></span><br><span class="line">       hashOperations.put(<span class="string">"100"</span>,<span class="string">"name"</span>,<span class="string">"tom"</span>);</span><br><span class="line">       hashOperations.put(<span class="string">"100"</span>,<span class="string">"age"</span>,<span class="string">"20"</span>);</span><br><span class="line"></span><br><span class="line">       <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) hashOperations.get(<span class="string">"100"</span>, <span class="string">"name"</span>);</span><br><span class="line">       System.out.println(name);</span><br><span class="line"></span><br><span class="line">       <span class="type">Set</span> <span class="variable">keys</span> <span class="operator">=</span> hashOperations.keys(<span class="string">"100"</span>);</span><br><span class="line">       System.out.println(keys);</span><br><span class="line"></span><br><span class="line">       <span class="type">List</span> <span class="variable">values</span> <span class="operator">=</span> hashOperations.values(<span class="string">"100"</span>);</span><br><span class="line">       System.out.println(values);</span><br><span class="line"></span><br><span class="line">       hashOperations.delete(<span class="string">"100"</span>,<span class="string">"age"</span>);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<p><strong>3). 操作列表类型数据</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 操作列表类型的数据</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testList</span><span class="params">()</span>{</span><br><span class="line">       <span class="comment">//lpush lrange rpop llen</span></span><br><span class="line">       <span class="type">ListOperations</span> <span class="variable">listOperations</span> <span class="operator">=</span> redisTemplate.opsForList();</span><br><span class="line"></span><br><span class="line">       listOperations.leftPushAll(<span class="string">"mylist"</span>,<span class="string">"a"</span>,<span class="string">"b"</span>,<span class="string">"c"</span>);</span><br><span class="line">       listOperations.leftPush(<span class="string">"mylist"</span>,<span class="string">"d"</span>);</span><br><span class="line"></span><br><span class="line">       <span class="type">List</span> <span class="variable">mylist</span> <span class="operator">=</span> listOperations.range(<span class="string">"mylist"</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">       System.out.println(mylist);</span><br><span class="line"></span><br><span class="line">       listOperations.rightPop(<span class="string">"mylist"</span>);</span><br><span class="line"></span><br><span class="line">       <span class="type">Long</span> <span class="variable">size</span> <span class="operator">=</span> listOperations.size(<span class="string">"mylist"</span>);</span><br><span class="line">       System.out.println(size);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<p><strong>4). 操作集合类型数据</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 操作集合类型的数据</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSet</span><span class="params">()</span>{</span><br><span class="line">       <span class="comment">//sadd smembers scard sinter sunion srem</span></span><br><span class="line">       <span class="type">SetOperations</span> <span class="variable">setOperations</span> <span class="operator">=</span> redisTemplate.opsForSet();</span><br><span class="line"></span><br><span class="line">       setOperations.add(<span class="string">"set1"</span>,<span class="string">"a"</span>,<span class="string">"b"</span>,<span class="string">"c"</span>,<span class="string">"d"</span>);</span><br><span class="line">       setOperations.add(<span class="string">"set2"</span>,<span class="string">"a"</span>,<span class="string">"b"</span>,<span class="string">"x"</span>,<span class="string">"y"</span>);</span><br><span class="line"></span><br><span class="line">       <span class="type">Set</span> <span class="variable">members</span> <span class="operator">=</span> setOperations.members(<span class="string">"set1"</span>);</span><br><span class="line">       System.out.println(members);</span><br><span class="line"></span><br><span class="line">       <span class="type">Long</span> <span class="variable">size</span> <span class="operator">=</span> setOperations.size(<span class="string">"set1"</span>);</span><br><span class="line">       System.out.println(size);</span><br><span class="line"></span><br><span class="line">       <span class="type">Set</span> <span class="variable">intersect</span> <span class="operator">=</span> setOperations.intersect(<span class="string">"set1"</span>, <span class="string">"set2"</span>);</span><br><span class="line">       System.out.println(intersect);</span><br><span class="line"></span><br><span class="line">       <span class="type">Set</span> <span class="variable">union</span> <span class="operator">=</span> setOperations.union(<span class="string">"set1"</span>, <span class="string">"set2"</span>);</span><br><span class="line">       System.out.println(union);</span><br><span class="line"></span><br><span class="line">       setOperations.remove(<span class="string">"set1"</span>,<span class="string">"a"</span>,<span class="string">"b"</span>);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<p><strong>5). 操作有序集合类型数据</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 操作有序集合类型的数据</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testZset</span><span class="params">()</span>{</span><br><span class="line">       <span class="comment">//zadd zrange zincrby zrem</span></span><br><span class="line">       <span class="type">ZSetOperations</span> <span class="variable">zSetOperations</span> <span class="operator">=</span> redisTemplate.opsForZSet();</span><br><span class="line"></span><br><span class="line">       zSetOperations.add(<span class="string">"zset1"</span>,<span class="string">"a"</span>,<span class="number">10</span>);</span><br><span class="line">       zSetOperations.add(<span class="string">"zset1"</span>,<span class="string">"b"</span>,<span class="number">12</span>);</span><br><span class="line">       zSetOperations.add(<span class="string">"zset1"</span>,<span class="string">"c"</span>,<span class="number">9</span>);</span><br><span class="line"></span><br><span class="line">       <span class="type">Set</span> <span class="variable">zset1</span> <span class="operator">=</span> zSetOperations.range(<span class="string">"zset1"</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">       System.out.println(zset1);</span><br><span class="line"></span><br><span class="line">       zSetOperations.incrementScore(<span class="string">"zset1"</span>,<span class="string">"c"</span>,<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">       zSetOperations.remove(<span class="string">"zset1"</span>,<span class="string">"a"</span>,<span class="string">"b"</span>);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<p><strong>6). 通用命令操作</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 通用命令操作</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCommon</span><span class="params">()</span>{</span><br><span class="line">       <span class="comment">//keys exists type del</span></span><br><span class="line">       <span class="type">Set</span> <span class="variable">keys</span> <span class="operator">=</span> redisTemplate.keys(<span class="string">"*"</span>);</span><br><span class="line">       System.out.println(keys);</span><br><span class="line"></span><br><span class="line">       <span class="type">Boolean</span> <span class="variable">name</span> <span class="operator">=</span> redisTemplate.hasKey(<span class="string">"name"</span>);</span><br><span class="line">       <span class="type">Boolean</span> <span class="variable">set1</span> <span class="operator">=</span> redisTemplate.hasKey(<span class="string">"set1"</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">for</span> (Object key : keys) {</span><br><span class="line">           <span class="type">DataType</span> <span class="variable">type</span> <span class="operator">=</span> redisTemplate.type(key);</span><br><span class="line">           System.out.println(type.name());</span><br><span class="line">       }</span><br><span class="line"></span><br><span class="line">       redisTemplate.delete(<span class="string">"mylist"</span>);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="5-dian-pu-ying-ye-zhuang-tai-she-zhi">5. 店铺营业状态设置</span></h2><h3><span id="5-1-xu-qiu-fen-xi-he-she-ji">5.1 需求分析和设计</span></h3><h4><span id="5-1-1-chan-pin-yuan-xing">5.1.1 产品原型</span></h4><p>进到苍穹外卖后台，显示餐厅的营业状态，营业状态分为<strong>营业中</strong>和<strong>打烊中</strong>，若当前餐厅处于营业状态，自动接收任何订单，客户可在小程序进行下单操作；若当前餐厅处于打烊状态，不接受任何订单，客户便无法在小程序进行下单操作。</p>
<img src="/2024/09/26/projection-skytogo/image-20221130212134915.png" alt="image-20221130212134915" style="zoom:50%;"> 

<p>点击<strong>营业状态</strong>按钮时，弹出更改营业状态</p>
<img src="/2024/09/26/projection-skytogo/image-20221130213550300.png" alt="image-20221130213550300" style="zoom:50%;"> 

<p>选择营业，设置餐厅为<strong>营业中</strong>状态</p>
<p>选择打烊，设置餐厅为<strong>打烊中</strong>状态</p>
<p><strong>状态说明：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221130213947179.png" alt="image-20221130213947179" style="zoom: 67%;"> 



<h4><span id="5-1-2-jie-kou-she-ji">5.1.2 接口设计</span></h4><p>根据上述原型图设计接口，共包含3个接口。</p>
<p><strong>接口设计：</strong></p>
<ul>
<li>设置营业状态</li>
<li>管理端查询营业状态</li>
<li>用户端查询营业状态</li>
</ul>
<p><strong>注：</strong>从技术层面分析，其实管理端和用户端查询营业状态时，可通过一个接口去实现即可。因为营业状态是一致的。但是，本项目约定：</p>
<ul>
<li><strong>管理端</strong>发出的请求，统一使用/admin作为前缀。</li>
<li><strong>用户端</strong>发出的请求，统一使用/user作为前缀。</li>
</ul>
<p>因为访问路径不一致，故分为两个接口实现。</p>
<p><strong>1). 设置营业状态</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221130215725802.png" alt="image-20221130215725802" style="zoom:50%;"> 



<p><strong>2). 管理端营业状态</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221130215814021.png" alt="image-20221130215814021" style="zoom:50%;"> 



<p><strong>3). 用户端营业状态</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221130215836785.png" alt="image-20221130215836785" style="zoom:50%;"> 



<h4><span id="5-1-3-ying-ye-zhuang-tai-cun-chu-fang-shi">5.1.3 营业状态存储方式</span></h4><p>虽然，可以通过一张表来存储营业状态数据，但整个表中只有一个字段，所以意义不大。</p>
<p>营业状态数据存储方式：基于Redis的字符串来进行存储</p>
<img src="/2024/09/26/projection-skytogo/image-20221130220037713.png" alt="image-20221130220037713" style="zoom:50%;"> 

<p><strong>约定：</strong>1表示营业 0表示打烊</p>
<h3><span id="5-2-dai-ma-kai-fa">5.2 代码开发</span></h3><h4><span id="5-2-1-she-zhi-ying-ye-zhuang-tai">5.2.1 设置营业状态</span></h4><p>在sky-server模块中，创建ShopController.java</p>
<p><strong>根据接口定义创建ShopController的setStatus设置营业状态方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PutMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController("adminShopController")</span></span><br><span class="line"><span class="meta">@RequestMapping("/admin/shop")</span></span><br><span class="line"><span class="meta">@Api(tags = "店铺相关接口")</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShopController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY</span> <span class="operator">=</span> <span class="string">"SHOP_STATUS"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置店铺的营业状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PutMapping("/{status}")</span></span><br><span class="line">    <span class="meta">@ApiOperation("设置店铺的营业状态")</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">setStatus</span><span class="params">(<span class="meta">@PathVariable</span> Integer status)</span>{</span><br><span class="line">        log.info(<span class="string">"设置店铺的营业状态为：{}"</span>,status == <span class="number">1</span> ? <span class="string">"营业中"</span> : <span class="string">"打烊中"</span>);</span><br><span class="line">        redisTemplate.opsForValue().set(KEY,status);</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="5-2-2-guan-li-duan-cha-xun-ying-ye-zhuang-tai">5.2.2 管理端查询营业状态</span></h4><p><strong>根据接口定义创建ShopController的getStatus查询营业状态方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取店铺的营业状态</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@GetMapping("/status")</span></span><br><span class="line">   <span class="meta">@ApiOperation("获取店铺的营业状态")</span></span><br><span class="line">   <span class="keyword">public</span> Result&lt;Integer&gt; <span class="title function_">getStatus</span><span class="params">()</span>{</span><br><span class="line">       <span class="type">Integer</span> <span class="variable">status</span> <span class="operator">=</span> (Integer) redisTemplate.opsForValue().get(KEY);</span><br><span class="line">       log.info(<span class="string">"获取到店铺的营业状态为：{}"</span>,status == <span class="number">1</span> ? <span class="string">"营业中"</span> : <span class="string">"打烊中"</span>);</span><br><span class="line">       <span class="keyword">return</span> Result.success(status);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="5-2-3-yong-hu-duan-cha-xun-ying-ye-zhuang-tai">5.2.3 用户端查询营业状态</span></h4><p>创建com.sky.controller.user包，在该包下创建ShopController.java</p>
<p><strong>根据接口定义创建ShopController的getStatus查询营业状态方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController("userShopController")</span></span><br><span class="line"><span class="meta">@RequestMapping("/user/shop")</span></span><br><span class="line"><span class="meta">@Api(tags = "店铺相关接口")</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShopController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KEY</span> <span class="operator">=</span> <span class="string">"SHOP_STATUS"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取店铺的营业状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping("/status")</span></span><br><span class="line">    <span class="meta">@ApiOperation("获取店铺的营业状态")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Integer&gt; <span class="title function_">getStatus</span><span class="params">()</span>{</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">status</span> <span class="operator">=</span> (Integer) redisTemplate.opsForValue().get(KEY);</span><br><span class="line">        log.info(<span class="string">"获取到店铺的营业状态为：{}"</span>,status == <span class="number">1</span> ? <span class="string">"营业中"</span> : <span class="string">"打烊中"</span>);</span><br><span class="line">        <span class="keyword">return</span> Result.success(status);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="5-3-gong-neng-ce-shi">5.3 功能测试</span></h3><h4><span id="5-3-1-jie-kou-wen-dang-ce-shi">5.3.1 接口文档测试</span></h4><p><strong>启动服务：</strong>访问<a target="_blank" rel="noopener" href="http://localhost:8080/doc.html%EF%BC%8C%E6%89%93%E5%BC%80%E5%BA%97%E9%93%BA%E7%9B%B8%E5%85%B3%E6%8E%A5%E5%8F%A3">http://localhost:8080/doc.html，打开店铺相关接口</a></p>
<p><strong>注意：</strong>使用admin用户登录重新获取token，防止token失效。</p>
<p><strong>设置营业状态：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221201175251351.png" alt="image-20221201175251351" style="zoom:50%;"> 

<p>点击发送</p>
<img src="/2024/09/26/projection-skytogo/image-20221201175428279.png" alt="image-20221201175428279" style="zoom:50%;"> 

<p>查看Idea控制台日志</p>
<img src="/2024/09/26/projection-skytogo/image-20221201175511626.png" alt="image-20221201175511626" style="zoom:50%;"> 

<p>查看Redis中数据</p>
<img src="/2024/09/26/projection-skytogo/image-20221201175634896.png" alt="image-20221201175634896" style="zoom:50%;"> 



<p><strong>管理端查询营业状态：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221201175807978.png" alt="image-20221201175807978" style="zoom:50%;"> 



<p><strong>用户端查询营业状态：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221201175917397.png" alt="image-20221201175917397" style="zoom:50%;"> 



<h4><span id="5-3-2-jie-kou-fen-zu-zhan-shi">5.3.2 接口分组展示</span></h4><p>在上述接口文档测试中，管理端和用户端的接口放在一起，不方便区分。</p>
<img src="/2024/09/26/projection-skytogo/image-20221201181927458.png" alt="image-20221201181927458" style="zoom:50%;"> 

<p>接下来，我们要实现管理端和用户端接口进行区分。</p>
<p>在WebMvcConfiguration.java中，分别扫描”com.sky.controller.admin”和”com.sky.controller.user”这两个包。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> Docket <span class="title function_">docket1</span><span class="params">()</span>{</span><br><span class="line">       log.info(<span class="string">"准备生成接口文档..."</span>);</span><br><span class="line">       <span class="type">ApiInfo</span> <span class="variable">apiInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApiInfoBuilder</span>()</span><br><span class="line">               .title(<span class="string">"苍穹外卖项目接口文档"</span>)</span><br><span class="line">               .version(<span class="string">"2.0"</span>)</span><br><span class="line">               .description(<span class="string">"苍穹外卖项目接口文档"</span>)</span><br><span class="line">               .build();</span><br><span class="line"></span><br><span class="line">       <span class="type">Docket</span> <span class="variable">docket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Docket</span>(DocumentationType.SWAGGER_2)</span><br><span class="line">               .groupName(<span class="string">"管理端接口"</span>)</span><br><span class="line">               .apiInfo(apiInfo)</span><br><span class="line">               .select()</span><br><span class="line">               <span class="comment">//指定生成接口需要扫描的包</span></span><br><span class="line">               .apis(RequestHandlerSelectors.basePackage(<span class="string">"com.sky.controller.admin"</span>))</span><br><span class="line">               .paths(PathSelectors.any())</span><br><span class="line">               .build();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> docket;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> Docket <span class="title function_">docket2</span><span class="params">()</span>{</span><br><span class="line">       log.info(<span class="string">"准备生成接口文档..."</span>);</span><br><span class="line">       <span class="type">ApiInfo</span> <span class="variable">apiInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApiInfoBuilder</span>()</span><br><span class="line">               .title(<span class="string">"苍穹外卖项目接口文档"</span>)</span><br><span class="line">               .version(<span class="string">"2.0"</span>)</span><br><span class="line">               .description(<span class="string">"苍穹外卖项目接口文档"</span>)</span><br><span class="line">               .build();</span><br><span class="line"></span><br><span class="line">       <span class="type">Docket</span> <span class="variable">docket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Docket</span>(DocumentationType.SWAGGER_2)</span><br><span class="line">               .groupName(<span class="string">"用户端接口"</span>)</span><br><span class="line">               .apiInfo(apiInfo)</span><br><span class="line">               .select()</span><br><span class="line">               <span class="comment">//指定生成接口需要扫描的包</span></span><br><span class="line">               .apis(RequestHandlerSelectors.basePackage(<span class="string">"com.sky.controller.user"</span>))</span><br><span class="line">               .paths(PathSelectors.any())</span><br><span class="line">               .build();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> docket;</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<p>重启服务器，再次访问接口文档，可进行选择<strong>用户端接口</strong>或者<strong>管理端接口</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221201182658244.png" alt="image-20221201182658244" style="zoom:50%;"> 



<h4><span id="5-3-3-qian-hou-duan-lian-diao-ce-shi">5.3.3 前后端联调测试</span></h4><p>启动nginx,访问 <a target="_blank" rel="noopener" href="http://localhost/">http://localhost</a></p>
<p>进入后台，状态为<strong>营业中</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221201180353062.png" alt="image-20221201180353062" style="zoom:50%;"> 

<p>点击<strong>营业状态设置</strong>，修改状态为<strong>打烊中</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221201180529842.png" alt="image-20221201180529842" style="zoom:50%;"> 

<p>再次查看状态，状态已为<strong>打烊中</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221201180639063.png" alt="image-20221201180639063" style="zoom:50%;"> 



<h3><span id="5-4-dai-ma-ti-jiao">5.4 代码提交</span></h3><p><strong>点击提交：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221201183950557.png" alt="image-20221201183950557" style="zoom:50%;"> 

<p><strong>提交过程中</strong>，出现提示：</p>
<img src="/2024/09/26/projection-skytogo/image-20221201190245361.png" alt="image-20221201190245361" style="zoom:50%;">  

<p><strong>继续push:</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221201190329431.png" alt="image-20221201190329431" style="zoom:50%;"> 

<p><strong>推送成功：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221201190404588.png" alt="image-20221201190404588" style="zoom: 67%;"> 

<h1><span id="cang-qiong-wai-mai-day06">苍穹外卖-day06</span></h1><h2><span id="ke-cheng-nei-rong">课程内容</span></h2><ul>
<li>HttpClient</li>
<li>微信小程序开发</li>
<li>微信登录</li>
<li>导入商品浏览功能代码</li>
</ul>
<p>功能实现：<strong>微信登录</strong>、<strong>商品浏览</strong></p>
<p><strong>微信登录效果图：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221203184545847.png" alt="image-20221203184545847" style="zoom:50%;"> 



<p><strong>商品浏览效果图：</strong></p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221203184623026.png" alt="image-20221203184623026" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/image-20221203184638043.png" alt="image-20221203184638043" style="zoom:50%;"> </p>
<h2><span id="1-httpclient">1. HttpClient</span></h2><h3><span id="1-1-jie-shao">1.1 介绍</span></h3><p>HttpClient 是Apache Jakarta Common 下的子项目，可以用来提供高效的、最新的、功能丰富的支持 HTTP 协议的客户端编程工具包，并且它支持 HTTP 协议最新的版本和建议。</p>
<img src="/2024/09/26/projection-skytogo/image-20221203185003231.png" alt="image-20221203185003231" style="zoom:50%;"> 

<p><strong>HttpClient作用：</strong></p>
<ul>
<li>发送HTTP请求</li>
<li>接收响应数据</li>
</ul>
<p><img src="/2024/09/26/projection-skytogo/image-20221203185149985.png" alt="image-20221203185149985" style="zoom:33%;">  为什么要在Java程序中发送Http请求？有哪些应用场景呢？</p>
<p><strong>HttpClient应用场景：</strong></p>
<p>当我们在使用扫描支付、查看地图、获取验证码、查看天气等功能时</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221203185536013.png" alt="image-20221203185536013" style="zoom: 50%;">  <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221203185557674.png" alt="image-20221203185557674" style="zoom:50%;">   <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221203185614509.png" alt="image-20221203185614509" style="zoom:50%;">   <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221203185632934.png" alt="image-20221203185632934" style="zoom:50%;"> </p>
<p>其实，应用程序本身并未实现这些功能，都是在应用程序里访问提供这些功能的服务，访问这些服务需要发送HTTP请求，并且接收响应数据，可通过HttpClient来实现。</p>
<img src="/2024/09/26/projection-skytogo/image-20221203185427462.png" alt="image-20221203185427462" style="zoom:50%;"> 

<p><strong>HttpClient的maven坐标：</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>4.5.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>HttpClient的核心API：</strong></p>
<ul>
<li>HttpClient：Http客户端对象类型，使用该类型对象可发起Http请求。</li>
<li>HttpClients：可认为是构建器，可创建HttpClient对象。</li>
<li>CloseableHttpClient：实现类，实现了HttpClient接口。</li>
<li>HttpGet：Get方式请求类型。</li>
<li>HttpPost：Post方式请求类型。</li>
</ul>
<p><strong>HttpClient发送请求步骤：</strong></p>
<ul>
<li>创建HttpClient对象</li>
<li>创建Http请求对象</li>
<li>调用HttpClient的execute方法发送请求</li>
</ul>
<h3><span id="1-2-ru-men-an-li">1.2 入门案例</span></h3><p>对HttpClient编程工具包有了一定了解后，那么，我们使用HttpClient在Java程序当中来构造Http的请求，并且把请求发送出去，接下来，就通过入门案例分别发送<strong>GET请求</strong>和<strong>POST请求</strong>，具体来学习一下它的使用方法。</p>
<h4><span id="1-2-1-get-fang-shi-qing-qiu">1.2.1 GET方式请求</span></h4><p>正常来说，首先，应该导入HttpClient相关的坐标，但在项目中，就算不导入，也可以使用相关的API。</p>
<p>因为在项目中已经引入了aliyun-sdk-oss坐标：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.aliyun.oss<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aliyun-sdk-oss<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>上述依赖的底层已经包含了HttpClient相关依赖。</p>
<img src="/2024/09/26/projection-skytogo/image-20221203194852825.png" alt="image-20221203194852825" style="zoom:50%;"> 

<p>故选择导入或者不导入均可。</p>
<p>进入到sky-server模块，编写测试代码，发送GET请求。</p>
<p><strong>实现步骤：</strong></p>
<ol>
<li>创建HttpClient对象</li>
<li>创建请求对象</li>
<li>发送请求，接受响应结果</li>
<li>解析结果</li>
<li>关闭资源</li>
</ol>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.CloseableHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.HttpGet;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.CloseableHttpClient;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.HttpClients;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.util.EntityUtils;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpClientTest</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试通过httpclient发送GET方式的请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGET</span><span class="params">()</span> <span class="keyword">throws</span> Exception{</span><br><span class="line">        <span class="comment">//创建httpclient对象</span></span><br><span class="line">        <span class="type">CloseableHttpClient</span> <span class="variable">httpClient</span> <span class="operator">=</span> HttpClients.createDefault();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建请求对象</span></span><br><span class="line">        <span class="type">HttpGet</span> <span class="variable">httpGet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpGet</span>(<span class="string">"http://localhost:8080/user/shop/status"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//发送请求，接受响应结果</span></span><br><span class="line">        <span class="type">CloseableHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> httpClient.execute(httpGet);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取服务端返回的状态码</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">statusCode</span> <span class="operator">=</span> response.getStatusLine().getStatusCode();</span><br><span class="line">        System.out.println(<span class="string">"服务端返回的状态码为："</span> + statusCode);</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpEntity</span> <span class="variable">entity</span> <span class="operator">=</span> response.getEntity();</span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> EntityUtils.toString(entity);</span><br><span class="line">        System.out.println(<span class="string">"服务端返回的数据为："</span> + body);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//关闭资源</span></span><br><span class="line">        response.close();</span><br><span class="line">        httpClient.close();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在访问<a target="_blank" rel="noopener" href="http://localhost:8080/user/shop/status%E8%AF%B7%E6%B1%82%E6%97%B6%EF%BC%8C%E9%9C%80%E8%A6%81%E6%8F%90%E5%89%8D%E5%90%AF%E5%8A%A8%E9%A1%B9%E7%9B%AE%E3%80%82">http://localhost:8080/user/shop/status请求时，需要提前启动项目。</a></p>
<p><strong>测试结果：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221203195917572.png" alt="image-20221203195917572" style="zoom:50%;"> 



<h4><span id="1-2-2-post-fang-shi-qing-qiu">1.2.2 POST方式请求</span></h4><p>在HttpClientTest中添加POST方式请求方法，相比GET请求来说，POST请求若携带参数需要封装请求体对象，并将该对象设置在请求对象中。</p>
<p><strong>实现步骤：</strong></p>
<ol>
<li>创建HttpClient对象</li>
<li>创建请求对象</li>
<li>发送请求，接收响应结果</li>
<li>解析响应结果</li>
<li>关闭资源</li>
</ol>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 测试通过httpclient发送POST方式的请求</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPOST</span><span class="params">()</span> <span class="keyword">throws</span> Exception{</span><br><span class="line">       <span class="comment">// 创建httpclient对象</span></span><br><span class="line">       <span class="type">CloseableHttpClient</span> <span class="variable">httpClient</span> <span class="operator">=</span> HttpClients.createDefault();</span><br><span class="line"></span><br><span class="line">       <span class="comment">//创建请求对象</span></span><br><span class="line">       <span class="type">HttpPost</span> <span class="variable">httpPost</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpPost</span>(<span class="string">"http://localhost:8080/admin/employee/login"</span>);</span><br><span class="line"></span><br><span class="line">       <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">       jsonObject.put(<span class="string">"username"</span>,<span class="string">"admin"</span>);</span><br><span class="line">       jsonObject.put(<span class="string">"password"</span>,<span class="string">"123456"</span>);</span><br><span class="line"></span><br><span class="line">       <span class="type">StringEntity</span> <span class="variable">entity</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringEntity</span>(jsonObject.toString());</span><br><span class="line">       <span class="comment">//指定请求编码方式</span></span><br><span class="line">       entity.setContentEncoding(<span class="string">"utf-8"</span>);</span><br><span class="line">       <span class="comment">//数据格式</span></span><br><span class="line">       entity.setContentType(<span class="string">"application/json"</span>);</span><br><span class="line">       httpPost.setEntity(entity);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//发送请求</span></span><br><span class="line">       <span class="type">CloseableHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> httpClient.execute(httpPost);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//解析返回结果</span></span><br><span class="line">       <span class="type">int</span> <span class="variable">statusCode</span> <span class="operator">=</span> response.getStatusLine().getStatusCode();</span><br><span class="line">       System.out.println(<span class="string">"响应码为："</span> + statusCode);</span><br><span class="line"></span><br><span class="line">       <span class="type">HttpEntity</span> <span class="variable">entity1</span> <span class="operator">=</span> response.getEntity();</span><br><span class="line">       <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> EntityUtils.toString(entity1);</span><br><span class="line">       System.out.println(<span class="string">"响应数据为："</span> + body);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//关闭资源</span></span><br><span class="line">       response.close();</span><br><span class="line">       httpClient.close();</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<p><strong>测试结果：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221203201023925.png" alt="image-20221203201023925" style="zoom:50%;"> 



<h2><span id="2-wei-xin-xiao-cheng-xu-kai-fa">2. 微信小程序开发</span></h2><h3><span id="2-1-jie-shao">2.1 介绍</span></h3><p>小程序是一种新的开放能力，开发者可以快速地开发一个小程序。可以在微信内被便捷地获取和传播，同时具有出色的使用体验。</p>
<img src="/2024/09/26/projection-skytogo/image-20221203204712437.png" alt="image-20221203204712437" style="zoom:50%;"> 

<p><strong>官方网址：</strong><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/cgi-bin/wx?token=&amp;lang=zh_CN">https://mp.weixin.qq.com/cgi-bin/wx?token=&amp;lang=zh_CN</a></p>
<img src="/2024/09/26/projection-skytogo/image-20221203205305487.png" alt="image-20221203205305487" style="zoom:50%;"> 

<p>小程序主要运行微信内部，可通过上述网站来整体了解微信小程序的开发。</p>
<p><strong>首先，</strong>在进行小程序开发时，需要先去注册一个小程序，在注册的时候，它实际上又分成了不同的注册的主体。我们可以以个人的身份来注册一个小程序，当然，也可以以企业政府、媒体或者其他组织的方式来注册小程序。那么，不同的主体注册小程序，最终开放的权限也是不一样的。比如以个人身份来注册小程序，是无法开通支付权限的。若要提供支付功能，必须是企业、政府或者其它组织等。所以，不同的主体注册小程序后，可开发的功能是不一样的。</p>
<img src="/2024/09/26/projection-skytogo/image-20221203210640473.png" alt="image-20221203210640473" style="zoom:50%;"> 



<p><strong>然后，</strong>微信小程序我们提供的一些开发的支持，实际上微信的官方是提供了一系列的工具来帮助开发者快速的接入<br>并且完成小程序的开发，提供了完善的开发文档，并且专门提供了一个开发者工具，还提供了相应的设计指南，同时也提供了一些小程序体验DEMO，可以快速的体验小程序实现的功能。</p>
<img src="/2024/09/26/projection-skytogo/image-20221203211226920.png" alt="image-20221203211226920" style="zoom:50%;"> 

<p><strong>最后，</strong>开发完一个小程序要上线，也给我们提供了详细地接入流程。</p>
<img src="/2024/09/26/projection-skytogo/image-20221203211535565.png" alt="image-20221203211535565" style="zoom:50%;"> 



<h3><span id="2-2-zhun-bei-gong-zuo">2.2 准备工作</span></h3><p>开发微信小程序之前需要做如下准备工作：</p>
<ul>
<li>注册小程序</li>
<li>完善小程序信息</li>
<li>下载开发者工具</li>
</ul>
<p><strong>1). 注册小程序</strong></p>
<p>注册地址：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/wxopen/waregister?action=step1">https://mp.weixin.qq.com/wxopen/waregister?action=step1</a></p>
<img src="/2024/09/26/projection-skytogo/image-20221203212348111.png" alt="image-20221203212348111" style="zoom: 50%;"> 



<p><strong>2). 完善小程序信息</strong></p>
<p>登录小程序后台：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/">https://mp.weixin.qq.com/</a></p>
<p>两种登录方式选其一即可</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221203212454040.png" alt="image-20221203212454040" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221203212508081.png" alt="image-20221203212508081" style="zoom:50%;"> </p>
<p>完善小程序信息、小程序类目</p>
<img src="/2024/09/26/projection-skytogo/image-20221203212615981.png" alt="image-20221203212615981" style="zoom:50%;"> 

<p>查看小程序的 AppID</p>
<img src="/2024/09/26/projection-skytogo/image-20221203212702993.png" alt="image-20221203212702993" style="zoom:50%;"> 



<p><strong>3). 下载开发者工具</strong></p>
<p>资料中已提供，无需下载，熟悉下载步骤即可。</p>
<p>下载地址： <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/devtools/stable.html">https://developers.weixin.qq.com/miniprogram/dev/devtools/stable.html</a></p>
<img src="/2024/09/26/projection-skytogo/image-20221203212836364.png" alt="image-20221203212836364" style="zoom:50%;"> 

<p>扫描登录开发者工具</p>
<img src="/2024/09/26/projection-skytogo/image-20221203212954956.png" alt="image-20221203212954956" style="zoom:50%;"> 

<p>创建小程序项目</p>
<img src="/2024/09/26/projection-skytogo/image-20221203213042020.png" alt="image-20221203213042020" style="zoom:50%;"> 

<p>熟悉开发者工具布局</p>
<img src="/2024/09/26/projection-skytogo/image-20221203213108317.png" alt="image-20221203213108317" style="zoom:50%;"> 

<p>设置不校验合法域名</p>
<img src="/2024/09/26/projection-skytogo/image-20221203213212370.png" alt="image-20221203213212370" style="zoom:50%;"> 

<p><strong>注：</strong>开发阶段，小程序发出请求到后端的Tomcat服务器，若不勾选，请求发送失败。</p>
<h3><span id="2-3-ru-men-an-li">2.3 入门案例</span></h3><p>实际上，小程序的开发本质上属于前端开发，主要使用JavaScript开发，咱们现在的定位主要还是在后端，所以，对于小程序开发简单了解即可。</p>
<h4><span id="2-3-1-xiao-cheng-xu-mu-lu-jie-gou">2.3.1 小程序目录结构</span></h4><p>小程序包含一个描述整体程序的 app 和多个描述各自页面的 page。一个小程序主体部分由三个文件组成，必须放在项目的根目录，如下：</p>
<img src="/2024/09/26/projection-skytogo/image-20221203220557676.png" alt="image-20221203220557676" style="zoom:50%;"> 

<p><strong>文件说明：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221203220635867.png" alt="image-20221203220635867" style="zoom:50%;"> 

<p><strong>app.js：</strong>必须存在，主要存放小程序的逻辑代码</p>
<p><strong>app.json：</strong>必须存在，小程序配置文件，主要存放小程序的公共配置</p>
<p><strong>app.wxss:</strong>  非必须存在，主要存放小程序公共样式表，类似于前端的CSS样式</p>
<p>对小程序主体三个文件了解后，其实一个小程序又有多个页面。比如说，有商品浏览页面、购物车的页面、订单支付的页面、商品的详情页面等等。那这些页面会放在哪呢？<br>会存放在pages目录。</p>
<p>每个小程序页面主要由四个文件组成：</p>
<img src="/2024/09/26/projection-skytogo/image-20221203220826893.png" alt="image-20221203220826893" style="zoom:50%;"> 

<p><strong>文件说明：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221203220839187.png" alt="image-20221203220839187" style="zoom:50%;"> 

<p><strong>js文件：</strong>必须存在，存放页面业务逻辑代码，编写的js代码。</p>
<p><strong>wxml文件：</strong>必须存在，存放页面结构，主要是做页面布局，页面效果展示的，类似于HTML页面。</p>
<p><strong>json文件：</strong>非必须，存放页面相关的配置。</p>
<p><strong>wxss文件：</strong>非必须，存放页面样式表，相当于CSS文件。</p>
<h4><span id="2-3-2-bian-xie-he-bian-yi-xiao-cheng-xu">2.3.2 编写和编译小程序</span></h4><p><strong>1). 编写</strong></p>
<p>进入到index.wxml，编写页面布局</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span>&nbsp;<span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">&nbsp;&nbsp;<span class="tag">&lt;<span class="name">view</span>&gt;</span>{{msg}}<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"> &nbsp;&nbsp;<span class="tag">&lt;<span class="name">view</span>&gt;</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;<span class="name">button</span>&nbsp;<span class="attr">type</span>=<span class="string">"default"</span>&nbsp;<span class="attr">bindtap</span>=<span class="string">"getUserInfo"</span>&gt;</span>获取用户信息<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;<span class="name">image</span>&nbsp;<span class="attr">style</span>=<span class="string">"width:&nbsp;100px;height:&nbsp;100px;"</span>&nbsp;<span class="attr">src</span>=<span class="string">"{{avatarUrl}}"</span>&gt;</span><span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;{{nickName}}</span><br><span class="line">&nbsp;&nbsp;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"> &nbsp;&nbsp;<span class="tag">&lt;<span class="name">view</span>&gt;</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;<span class="name">button</span>&nbsp;<span class="attr">type</span>=<span class="string">"primary"</span>&nbsp;<span class="attr">bindtap</span>=<span class="string">"wxlogin"</span>&gt;</span>微信登录<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;授权码：{{code}}</span><br><span class="line">&nbsp;&nbsp;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"> &nbsp;&nbsp;<span class="tag">&lt;<span class="name">view</span>&gt;</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;<span class="name">button</span>&nbsp;<span class="attr">type</span>=<span class="string">"warn"</span>&nbsp;<span class="attr">bindtap</span>=<span class="string">"sendRequest"</span>&gt;</span>发送请求<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;响应结果：{{result}}</span><br><span class="line">&nbsp;&nbsp;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>进入到index.js，编写业务逻辑代码</p>
<figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Page</span>({</span><br><span class="line">&nbsp;&nbsp;<span class="attr">data</span>:{</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="attr">msg</span>:<span class="string">'hello&nbsp;world'</span>,</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="attr">avatarUrl</span>:<span class="string">''</span>,</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="attr">nickName</span>:<span class="string">''</span>,</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="attr">code</span>:<span class="string">''</span>,</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;<span class="attr">result</span>:<span class="string">''</span></span><br><span class="line">&nbsp;&nbsp;},</span><br><span class="line">&nbsp;&nbsp;<span class="attr">getUserInfo</span>:<span class="keyword">function</span>(<span class="params"></span>){</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;wx.<span class="title function_">getUserProfile</span>({</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="attr">desc</span>:&nbsp;<span class="string">'获取用户信息'</span>,</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="attr">success</span>:<span class="function">(<span class="params">res</span>)&nbsp;=&gt;</span>&nbsp;{</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable language_">this</span>.<span class="title function_">setData</span>({</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="attr">avatarUrl</span>:res.<span class="property">userInfo</span>.<span class="property">avatarUrl</span>,</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="attr">nickName</span>:res.<span class="property">userInfo</span>.<span class="property">nickName</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;})</span><br><span class="line">&nbsp;&nbsp;},</span><br><span class="line">&nbsp;&nbsp;<span class="attr">wxlogin</span>:<span class="keyword">function</span>(<span class="params"></span>){</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;wx.<span class="title function_">login</span>({</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="attr">success</span>:&nbsp;<span class="function">(<span class="params">res</span>)&nbsp;=&gt;</span>&nbsp;{</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"授权码："</span>+res.<span class="property">code</span>)</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable language_">this</span>.<span class="title function_">setData</span>({</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="attr">code</span>:res.<span class="property">code</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;})</span><br><span class="line">&nbsp;&nbsp;},</span><br><span class="line">&nbsp;&nbsp;<span class="attr">sendRequest</span>:<span class="keyword">function</span>(<span class="params"></span>){</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;wx.<span class="title function_">request</span>({</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="attr">url</span>:&nbsp;<span class="string">'http://localhost:8080/user/shop/status'</span>,</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="attr">method</span>:<span class="string">'GET'</span>,</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="attr">success</span>:<span class="function">(<span class="params">res</span>)&nbsp;=&gt;</span>&nbsp;{</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"响应结果："</span>&nbsp;+&nbsp;res.<span class="property">data</span>.<span class="property">data</span>)</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="variable language_">this</span>.<span class="title function_">setData</span>({</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="attr">result</span>:res.<span class="property">data</span>.<span class="property">data</span></span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br><span class="line">&nbsp;&nbsp;&nbsp;&nbsp;})</span><br><span class="line">&nbsp;&nbsp;}})</span><br></pre></td></tr></tbody></table></figure>



<p><strong>2). 编译</strong></p>
<p>点击编译按钮</p>
<img src="/2024/09/26/projection-skytogo/image-20221204181233015.png" alt="image-20221204181233015" style="zoom:50%;"> 



<p><strong>3). 运行效果</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221204181606927.png" alt="image-20221204181606927" style="zoom:50%;"> 



<p>点击<strong>获取用户信息</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221204182056440.png" alt="image-20221204182056440" style="zoom: 67%;"> 



<p>点击<strong>微信登录</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221204182238762.png" alt="image-20221204182238762" style="zoom: 67%;"> 



<p>点击<strong>发送请求</strong></p>
<p>因为请求<a target="_blank" rel="noopener" href="http://localhost:8080/user/shop/status%EF%BC%8C%E5%85%88%E8%A6%81%E5%90%AF%E5%8A%A8%E5%90%8E%E5%8F%B0%E9%A1%B9%E7%9B%AE%E3%80%82">http://localhost:8080/user/shop/status，先要启动后台项目。</a></p>
<img src="/2024/09/26/projection-skytogo/image-20221204192519728.png" alt="image-20221204192519728" style="zoom: 67%;"> 

<p><strong>注：</strong>设置不校验合法域名，若不勾选，请求发送失败。</p>
<h4><span id="2-3-3-fa-bu-xiao-cheng-xu">2.3.3 发布小程序</span></h4><p>小程序的代码都已经开发完毕，要将小程序发布上线，让所有的用户都能使用到这个小程序。</p>
<p>点击上传按钮：</p>
<img src="/2024/09/26/projection-skytogo/image-20221204225355015.png" alt="image-20221204225355015" style="zoom:50%;"> 

<p>指定版本号：</p>
<img src="/2024/09/26/projection-skytogo/image-20221204225502698.png" alt="image-20221204225502698" style="zoom:50%;"> 

<p>上传成功：</p>
<img src="/2024/09/26/projection-skytogo/image-20221204225557820.png" alt="image-20221204225557820" style="zoom:50%;"> 

<p>把代码上传到微信服务器就表示小程序已经发布了吗？<br><strong>其实并不是。</strong>当前小程序版本只是一个开发版本。</p>
<p>进到微信公众平台，打开版本管理页面。</p>
<img src="/2024/09/26/projection-skytogo/image-20221204230231476.png" alt="image-20221204230231476" style="zoom:50%;"> 

<p>需提交审核，变成审核版本，审核通过后，进行发布，变成线上版本。</p>
<p>一旦成为线上版本，这就说明小程序就已经发布上线了，微信用户就可以在微信里面去搜索和使用这个小程序了。</p>
<h2><span id="3-wei-xin-deng-lu">3. 微信登录</span></h2><h3><span id="3-1-dao-ru-xiao-cheng-xu-dai-ma">3.1 导入小程序代码</span></h3><p>开发微信小程序，本质上是属于前端的开发，我们的重点其实还是后端代码开发。所以，小程序的代码已经提供好了，直接导入到微信开发者工具当中，直接来使用就可以了。</p>
<p><strong>1). 找到资料</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221204205429798.png" alt="image-20221204205429798" style="zoom: 67%;"> 



<p><strong>2). 导入代码</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221204205631809.png" alt="image-20221204205631809" style="zoom:50%;"> 

<p>AppID：使用自己的AppID</p>
<img src="/2024/09/26/projection-skytogo/image-20221204210011364.png" alt="image-20221204210011364" style="zoom:50%;"> 



<p><strong>3). 查看项目结构</strong></p>
<p>主体的文件:app.js app.json app.wxss<br>项目的页面比较多，主要存放在pages目录。</p>
<img src="/2024/09/26/projection-skytogo/image-20221204210739195.png" alt="image-20221204210739195" style="zoom:50%;"> 



<p><strong>4). 修改配置</strong></p>
<p>因为小程序要请求后端服务，需要修改为自己后端服务的ip地址和端口号(默认不需要修改)</p>
<p>common–&gt;vendor.js–&gt;搜索(ctrl+f)–&gt;baseUri</p>
<img src="/2024/09/26/projection-skytogo/image-20221204211239035.png" alt="image-20221204211239035" style="zoom:50%;"> 



<h3><span id="3-2-wei-xin-deng-lu-liu-cheng">3.2 微信登录流程</span></h3><p>微信登录：<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html">https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html</a></p>
<p><strong>流程图：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221204211800753.png" alt="image-20221204211800753" style="zoom:50%;"> 



<p><strong>步骤分析：</strong></p>
<ol>
<li>小程序端，调用wx.login()获取code，就是授权码。</li>
<li>小程序端，调用wx.request()发送请求并携带code，请求开发者服务器(自己编写的后端服务)。</li>
<li>开发者服务端，通过HttpClient向微信接口服务发送请求，并携带appId+appsecret+code三个参数。</li>
<li>开发者服务端，接收微信接口服务返回的数据，session_key+opendId等。opendId是微信用户的唯一标识。</li>
<li>开发者服务端，自定义登录态，生成令牌(token)和openid等数据返回给小程序端，方便后绪请求身份校验。</li>
<li>小程序端，收到自定义登录态，存储storage。</li>
<li>小程序端，后绪通过wx.request()发起业务请求时，携带token。</li>
<li>开发者服务端，收到请求后，通过携带的token，解析当前登录用户的id。</li>
<li>开发者服务端，身份校验通过后，继续相关的业务逻辑处理，最终返回业务数据。</li>
</ol>
<p>接下来，我们使用Postman进行测试。</p>
<p><strong>说明：</strong></p>
<ol>
<li>调用 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html">wx.login()</a> 获取 <strong>临时登录凭证code</strong> ，并回传到开发者服务器。</li>
<li>调用 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/login/auth.code2Session.html">auth.code2Session</a> 接口，换取 <strong>用户唯一标识 OpenID</strong> 、 用户在微信开放平台帐号下的<strong>唯一标识UnionID</strong>（若当前小程序已绑定到微信开放平台帐号） 和 <strong>会话密钥 session_key</strong>。</li>
</ol>
<p>之后开发者服务器可以根据用户标识来生成自定义登录态，用于后续业务逻辑中前后端交互时识别用户身份。</p>
<p><strong>实现步骤：</strong></p>
<p><strong>1). 获取授权码</strong></p>
<p>点击确定按钮，获取授权码，每个授权码只能使用一次，每次测试，需重新获取。</p>
<img src="/2024/09/26/projection-skytogo/image-20221204222008130.png" alt="image-20221204222008130" style="zoom:50%;"> 



<p><strong>2). 明确请求接口</strong></p>
<p>请求方式、请求路径、请求参数</p>
<img src="/2024/09/26/projection-skytogo/image-20221204222434054.png" alt="image-20221204222434054" style="zoom:50%;"> 



<p><strong>3). 发送请求</strong></p>
<p>获取session_key和openid</p>
<img src="/2024/09/26/projection-skytogo/image-20221204223956568.png" alt="image-20221204223956568" style="zoom:50%;"> 

<p>若出现code been used错误提示，说明授权码已被使用过，请重新获取</p>
<img src="/2024/09/26/projection-skytogo/image-20221204224130409.png" alt="image-20221204224130409" style="zoom:50%;"> 

 

<h3><span id="3-3-xu-qiu-fen-xi-he-she-ji">3.3 需求分析和设计</span></h3><h4><span id="3-3-1-chan-pin-yuan-xing">3.3.1 产品原型</span></h4><p>用户进入到小程序的时候，微信授权登录之后才能点餐。需要获取当前微信用户的相关信息，比如昵称、头像等，这样才能够进入到小程序进行下单操作。是基于微信登录来实现小程序的登录功能，没有采用传统账户密码登录的方式。若第一次使用小程序来点餐，就是一个新用户，需要把这个新的用户保存到数据库当中完成自动注册。</p>
<p><strong>登录功能原型图：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221205173711304.png" alt="image-20221205173711304" style="zoom:50%;"> 



<p><strong>业务规则：</strong></p>
<ul>
<li>基于微信登录实现小程序的登录功能</li>
<li>如果是新用户需要自动完成注册</li>
</ul>
<h4><span id="3-3-2-jie-kou-she-ji">3.3.2 接口设计</span></h4><p>通过微信登录的流程，如果要完成微信登录的话，最终就要获得微信用户的openid。在小程序端获取授权码后，向后端服务发送请求，并携带授权码，这样后端服务在收到授权码后，就可以去请求微信接口服务。最终，后端向小程序返回openid和token等数据。</p>
<p>基于上述的登录流程，就可以设计出该接口的<strong>请求参数</strong>和<strong>返回数据</strong>。</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221205175429394.png" alt="image-20221205175429394" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221205175441256.png" alt="image-20221205175441256" style="zoom:50%;"></p>
<p><strong>说明：</strong>请求路径/user/user/login,第一个user代表用户端，第二个user代表用户模块。</p>
<h4><span id="3-3-3-biao-she-ji">3.3.3 表设计</span></h4><p>当用户第一次使用小程序时，会完成自动注册，把用户信息存储到<strong>user</strong>表中。</p>
<table>
<thead>
<tr>
<th><strong>字段名</strong></th>
<th><strong>数据类型</strong></th>
<th><strong>说明</strong></th>
<th><strong>备注</strong></th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>bigint</td>
<td>主键</td>
<td>自增</td>
</tr>
<tr>
<td>openid</td>
<td>varchar(45)</td>
<td>微信用户的唯一标识</td>
<td></td>
</tr>
<tr>
<td>name</td>
<td>varchar(32)</td>
<td>用户姓名</td>
<td></td>
</tr>
<tr>
<td>phone</td>
<td>varchar(11)</td>
<td>手机号</td>
<td></td>
</tr>
<tr>
<td>sex</td>
<td>varchar(2)</td>
<td>性别</td>
<td></td>
</tr>
<tr>
<td>id_number</td>
<td>varchar(18)</td>
<td>身份证号</td>
<td></td>
</tr>
<tr>
<td>avatar</td>
<td>varchar(500)</td>
<td>微信用户头像路径</td>
<td></td>
</tr>
<tr>
<td>create_time</td>
<td>datetime</td>
<td>注册时间</td>
<td></td>
</tr>
</tbody></table>
<p><strong>说明：</strong>手机号字段比较特殊，个人身份注册的小程序没有权限获取到微信用户的手机号。如果是以企业的资质<br>注册的小程序就能够拿到微信用户的手机号。</p>
<h3><span id="3-4-dai-ma-kai-fa">3.4 代码开发</span></h3><h4><span id="3-4-1-ding-yi-xiang-guan-pei-zhi">3.4.1 定义相关配置</span></h4><p><strong>配置微信登录所需配置项：</strong></p>
<p>application-dev.yml</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sky:</span></span><br><span class="line">  <span class="attr">wechat:</span></span><br><span class="line">    <span class="attr">appid:</span> <span class="string">wxffb3637a228223b8</span></span><br><span class="line">    <span class="attr">secret:</span> <span class="string">84311df9199ecacdf4f12d27b6b9522d</span></span><br></pre></td></tr></tbody></table></figure>

<p>application.yml</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sky:</span></span><br><span class="line">  <span class="attr">wechat:</span></span><br><span class="line">    <span class="attr">appid:</span> <span class="string">${sky.wechat.appid}</span></span><br><span class="line">    <span class="attr">secret:</span> <span class="string">${sky.wechat.secret}</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>配置为微信用户生成jwt令牌时使用的配置项：</strong></p>
<p>application.yml</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sky:</span></span><br><span class="line">  <span class="attr">jwt:</span></span><br><span class="line">    <span class="comment"># 设置jwt签名加密时使用的秘钥</span></span><br><span class="line">    <span class="attr">admin-secret-key:</span> <span class="string">itcast</span></span><br><span class="line">    <span class="comment"># 设置jwt过期时间</span></span><br><span class="line">    <span class="attr">admin-ttl:</span> <span class="number">7200000</span></span><br><span class="line">    <span class="comment"># 设置前端传递过来的令牌名称</span></span><br><span class="line">    <span class="attr">admin-token-name:</span> <span class="string">token</span></span><br><span class="line">    <span class="attr">user-secret-key:</span> <span class="string">itheima</span></span><br><span class="line">    <span class="attr">user-ttl:</span> <span class="number">7200000</span></span><br><span class="line">    <span class="attr">user-token-name:</span> <span class="string">authentication</span></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-4-2-dto-she-ji">3.4.2 DTO设计</span></h4><p><strong>根据传入参数设计DTO类：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221205183625049.png" alt="image-20221205183625049" style="zoom:50%;"> 

<p>在sky-pojo模块，UserLoginDTO.java已定义</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * C端用户登录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserLoginDTO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-4-3-vo-she-ji">3.4.3 VO设计</span></h4><p><strong>根据返回数据设计VO类：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221205183923272.png" alt="image-20221205183923272" style="zoom:50%;"> 

<p>在sky-pojo模块，UserLoginVO.java已定义</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserLoginVO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String openid;</span><br><span class="line">    <span class="keyword">private</span> String token;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-4-4-controller-ceng">3.4.4 Controller层</span></h4><p><strong>根据接口定义创建UserController的login方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.constant.JwtClaimsConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.UserLoginDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.User;</span><br><span class="line"><span class="keyword">import</span> com.sky.properties.JwtProperties;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.UserService;</span><br><span class="line"><span class="keyword">import</span> com.sky.utils.JwtUtil;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.UserLoginVO;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/user/user")</span></span><br><span class="line"><span class="meta">@Api(tags = "C端用户相关接口")</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtProperties jwtProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 微信登录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userLoginDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping("/login")</span></span><br><span class="line">    <span class="meta">@ApiOperation("微信登录")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;UserLoginVO&gt; <span class="title function_">login</span><span class="params">(<span class="meta">@RequestBody</span> UserLoginDTO userLoginDTO)</span>{</span><br><span class="line">        log.info(<span class="string">"微信用户登录：{}"</span>,userLoginDTO.getCode());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//微信登录</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.wxLogin(userLoginDTO);<span class="comment">//后绪步骤实现</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//为微信用户生成jwt令牌</span></span><br><span class="line">        Map&lt;String, Object&gt; claims = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        claims.put(JwtClaimsConstant.USER_ID,user.getId());</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> JwtUtil.createJWT(jwtProperties.getUserSecretKey(), jwtProperties.getUserTtl(), claims);</span><br><span class="line"></span><br><span class="line">        <span class="type">UserLoginVO</span> <span class="variable">userLoginVO</span> <span class="operator">=</span> UserLoginVO.builder()</span><br><span class="line">                .id(user.getId())</span><br><span class="line">                .openid(user.getOpenid())</span><br><span class="line">                .token(token)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">return</span> Result.success(userLoginVO);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>其中，JwtClaimsConstant.USER_ID常量已定义。</p>
<h4><span id="3-4-5-service-ceng-jie-kou">3.4.5 Service层接口</span></h4><p><strong>创建UserService接口：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.dto.UserLoginDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 微信登录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userLoginDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    User <span class="title function_">wxLogin</span><span class="params">(UserLoginDTO userLoginDTO)</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-4-6-service-ceng-shi-xian-lei">3.4.6 Service层实现类</span></h4><p><strong>创建UserServiceImpl实现类：</strong>实现获取微信用户的openid和微信登录功能</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.sky.constant.MessageConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.UserLoginDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.User;</span><br><span class="line"><span class="keyword">import</span> com.sky.exception.LoginFailedException;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.properties.WeChatProperties;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.UserService;</span><br><span class="line"><span class="keyword">import</span> com.sky.utils.HttpClientUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">//微信服务接口地址</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">WX_LOGIN</span> <span class="operator">=</span> <span class="string">"https://api.weixin.qq.com/sns/jscode2session"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WeChatProperties weChatProperties;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 微信登录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userLoginDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">wxLogin</span><span class="params">(UserLoginDTO userLoginDTO)</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">openid</span> <span class="operator">=</span> getOpenid(userLoginDTO.getCode());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断openid是否为空，如果为空表示登录失败，抛出业务异常</span></span><br><span class="line">        <span class="keyword">if</span>(openid == <span class="literal">null</span>){</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LoginFailedException</span>(MessageConstant.LOGIN_FAILED);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断当前用户是否为新用户</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.getByOpenid(openid);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果是新用户，自动完成注册</span></span><br><span class="line">        <span class="keyword">if</span>(user == <span class="literal">null</span>){</span><br><span class="line">            user = User.builder()</span><br><span class="line">                    .openid(openid)</span><br><span class="line">                    .createTime(LocalDateTime.now())</span><br><span class="line">                    .build();</span><br><span class="line">            userMapper.insert(user);<span class="comment">//后绪步骤实现</span></span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回这个用户对象</span></span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 调用微信接口服务，获取微信用户的openid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getOpenid</span><span class="params">(String code)</span>{</span><br><span class="line">        <span class="comment">//调用微信接口服务，获得当前微信用户的openid</span></span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"appid"</span>,weChatProperties.getAppid());</span><br><span class="line">        map.put(<span class="string">"secret"</span>,weChatProperties.getSecret());</span><br><span class="line">        map.put(<span class="string">"js_code"</span>,code);</span><br><span class="line">        map.put(<span class="string">"grant_type"</span>,<span class="string">"authorization_code"</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> HttpClientUtil.doGet(WX_LOGIN, map);</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSON.parseObject(json);</span><br><span class="line">        <span class="type">String</span> <span class="variable">openid</span> <span class="operator">=</span> jsonObject.getString(<span class="string">"openid"</span>);</span><br><span class="line">        <span class="keyword">return</span> openid;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-4-7-mapper-ceng">3.4.7 Mapper层</span></h4><p><strong>创建UserMapper接口：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.entity.User;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据openid查询用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> openid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Select("select * from user where openid = #{openid}")</span></span><br><span class="line">    User <span class="title function_">getByOpenid</span><span class="params">(String openid)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(User user)</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>创建UserMapper.xml映射文件：</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span></span><br><span class="line"><span class="meta">        <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.sky.mapper.UserMapper"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insert"</span> <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span>&gt;</span></span><br><span class="line">        insert into user (openid, name, phone, sex, id_number, avatar, create_time)</span><br><span class="line">        values (#{openid}, #{name}, #{phone}, #{sex}, #{idNumber}, #{avatar}, #{createTime})</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-4-8-bian-xie-lan-jie-qi">3.4.8 编写拦截器</span></h4><p><strong>编写拦截器JwtTokenUserInterceptor：</strong>统一拦截用户端发送的请求并进行jwt校验</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.constant.JwtClaimsConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.context.BaseContext;</span><br><span class="line"><span class="keyword">import</span> com.sky.properties.JwtProperties;</span><br><span class="line"><span class="keyword">import</span> com.sky.utils.JwtUtil;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.method.HandlerMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * jwt令牌校验的拦截器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtTokenUserInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtProperties jwtProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 校验jwt</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="comment">//判断当前拦截到的是Controller的方法还是其他资源</span></span><br><span class="line">        <span class="keyword">if</span> (!(handler <span class="keyword">instanceof</span> HandlerMethod)) {</span><br><span class="line">            <span class="comment">//当前拦截到的不是动态方法，直接放行</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1、从请求头中获取令牌</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(jwtProperties.getUserTokenName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、校验令牌</span></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            log.info(<span class="string">"jwt校验:{}"</span>, token);</span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> JwtUtil.parseJWT(jwtProperties.getUserSecretKey(), token);</span><br><span class="line">            <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> Long.valueOf(claims.get(JwtClaimsConstant.USER_ID).toString());</span><br><span class="line">            log.info(<span class="string">"当前用户的id："</span>, userId);</span><br><span class="line">            BaseContext.setCurrentId(userId);</span><br><span class="line">            <span class="comment">//3、通过，放行</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        } <span class="keyword">catch</span> (Exception ex) {</span><br><span class="line">            <span class="comment">//4、不通过，响应401状态码</span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>在WebMvcConfiguration配置类中注册拦截器：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> JwtTokenUserInterceptor jwtTokenUserInterceptor;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 注册自定义拦截器</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> registry</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> {</span><br><span class="line">       log.info(<span class="string">"开始注册自定义拦截器..."</span>);</span><br><span class="line">       <span class="comment">//.........</span></span><br><span class="line"></span><br><span class="line">       registry.addInterceptor(jwtTokenUserInterceptor)</span><br><span class="line">               .addPathPatterns(<span class="string">"/user/**"</span>)</span><br><span class="line">               .excludePathPatterns(<span class="string">"/user/user/login"</span>)</span><br><span class="line">               .excludePathPatterns(<span class="string">"/user/shop/status"</span>);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-5-gong-neng-ce-shi">3.5 功能测试</span></h3><p>重新编译小程序，进行登录，获取到openid和token数据</p>
<img src="/2024/09/26/projection-skytogo/image-20221205192506490.png" alt="image-20221205192506490" style="zoom:50%;"> 

<p>查看后台日志</p>
<img src="/2024/09/26/projection-skytogo/image-20221205192943394.png" alt="image-20221205192943394" style="zoom:67%;">  

<p>查看数据库user表，第一次登录，会自动注册</p>
<img src="/2024/09/26/projection-skytogo/image-20221205193018421.png" alt="image-20221205193018421" style="zoom: 67%;">  



<h2><span id="4-dao-ru-shang-pin-liu-lan-gong-neng-dai-ma">4. 导入商品浏览功能代码</span></h2><h3><span id="4-1-xu-qiu-fen-xi-he-she-ji">4.1 需求分析和设计</span></h3><h4><span id="4-1-1-chan-pin-yuan-xing">4.1.1 产品原型</span></h4><p>用户登录成功后跳转到系统首页，在首页需要根据分类来展示菜品和套餐。如果菜品设置了口味信息，需要展示<img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20210812205330291.png" alt="image-20210812205330291" style="zoom: 80%;">按钮，否则显示<img src="/2024/09/26/projection-skytogo/image-20210812205346846.png" alt="image-20210812205346846" style="zoom:80%;">按钮。</p>
<p>​         <strong>菜品列表效果图</strong>                                                   <strong>菜品口味效果图</strong></p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221205193821129.png" alt="image-20221205193821129" style="zoom: 50%;">                               <img src="/2024/09/26/projection-skytogo/image-20221205193846867.png" alt="image-20221205193846867" style="zoom:50%;"> </p>
<p>​         <strong>套餐列表效果图</strong>                                                   <strong>套餐详情效果图</strong></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221205193859016.png" alt="image-20221205193859016" style="zoom:50%;">                               <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221205193911476.png" alt="image-20221205193911476" style="zoom:50%;"> </p>
<h4><span id="4-1-2-jie-kou-she-ji">4.1.2 接口设计</span></h4><p>根据上述原型图先<strong>粗粒度</strong>设计接口，共包含4个接口。</p>
<p><strong>接口设计：</strong></p>
<ul>
<li>查询分类</li>
<li>根据分类id查询菜品</li>
<li>根据分类id查询套餐</li>
<li>根据套餐id查询包含的菜品</li>
</ul>
<p>接下来<strong>细粒度</strong>分析每个接口，明确每个接口的请求方式、请求路径、传入参数和返回值。</p>
<p><strong>1). 查询分类</strong></p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221205200235328.png" alt="image-20221205200235328" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/image-20221205200246588.png" alt="image-20221205200246588" style="zoom:50%;"></p>
<p><strong>2). 根据分类id查询菜品</strong></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221205200319686.png" alt="image-20221205200319686" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221205200335214.png" alt="image-20221205200335214" style="zoom:50%;"></p>
<p><strong>3). 根据分类id查询套餐</strong></p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221205200415135.png" alt="image-20221205200415135" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/image-20221205200425607.png" alt="image-20221205200425607" style="zoom:50%;"></p>
<p><strong>4). 根据套餐id查询包含的菜品</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221205200537591.png" alt="image-20221205200537591" style="zoom:50%;"> 



<h3><span id="4-2-dai-ma-dao-ru">4.2 代码导入</span></h3><p>导入资料中的商品浏览功能代码即可</p>
<img src="/2024/09/26/projection-skytogo/image-20221205201043358.png" alt="image-20221205201043358" style="zoom:50%;"> 

<p>可按照mapper–&gt;service–&gt;controller依次导入，这样代码不会显示相应的报错。</p>
<p>进入到sky-server模块中</p>
<h4><span id="4-2-1-mapper-ceng">4.2.1 Mapper层</span></h4><p><strong>在SetmealMapper.java中添加list和getDishItemBySetmealId两个方法</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 动态条件查询套餐</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> setmeal</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   List&lt;Setmeal&gt; <span class="title function_">list</span><span class="params">(Setmeal setmeal)</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据套餐id查询菜品选项</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> setmealId</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Select("select sd.name, sd.copies, d.image, d.description " +</span></span><br><span class="line"><span class="meta">           "from setmeal_dish sd left join dish d on sd.dish_id = d.id " +</span></span><br><span class="line"><span class="meta">           "where sd.setmeal_id = #{setmealId}")</span></span><br><span class="line">   List&lt;DishItemVO&gt; <span class="title function_">getDishItemBySetmealId</span><span class="params">(Long setmealId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>创建SetmealMapper.xml文件</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span></span><br><span class="line"><span class="meta">        <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.sky.mapper.SetmealMapper"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"list"</span> <span class="attr">parameterType</span>=<span class="string">"Setmeal"</span> <span class="attr">resultType</span>=<span class="string">"Setmeal"</span>&gt;</span></span><br><span class="line">        select * from setmeal</span><br><span class="line">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"name != null"</span>&gt;</span></span><br><span class="line">                and name like concat('%',#{name},'%')</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"categoryId != null"</span>&gt;</span></span><br><span class="line">                and category_id = #{categoryId}</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"status != null"</span>&gt;</span></span><br><span class="line">                and status = #{status}</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="4-2-2-service-ceng">4.2.2 Service层</span></h4><p><strong>创建SetmealService.java</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.dto.SetmealDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.SetmealPageQueryDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Setmeal;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.DishItemVO;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.SetmealVO;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SetmealService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 条件查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmeal</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;Setmeal&gt; <span class="title function_">list</span><span class="params">(Setmeal setmeal)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询菜品选项</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;DishItemVO&gt; <span class="title function_">getDishItemById</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>创建SetmealServiceImpl.java</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Setmeal;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.DishMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.SetmealDishMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.SetmealMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.SetmealService;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.DishItemVO;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 套餐业务实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SetmealServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">SetmealService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SetmealMapper setmealMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SetmealDishMapper setmealDishMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishMapper dishMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 条件查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> setmeal</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Setmeal&gt; <span class="title function_">list</span><span class="params">(Setmeal setmeal)</span> {</span><br><span class="line">        List&lt;Setmeal&gt; list = setmealMapper.list(setmeal);</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询菜品选项</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;DishItemVO&gt; <span class="title function_">getDishItemById</span><span class="params">(Long id)</span> {</span><br><span class="line">        <span class="keyword">return</span> setmealMapper.getDishItemBySetmealId(id);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>在DishService.java中添加listWithFlavor方法定义</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 条件查询菜品和口味</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> dish</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   List&lt;DishVO&gt; <span class="title function_">listWithFlavor</span><span class="params">(Dish dish)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>在DishServiceImpl.java中实现listWithFlavor方法</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 条件查询菜品和口味</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> dish</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> List&lt;DishVO&gt; <span class="title function_">listWithFlavor</span><span class="params">(Dish dish)</span> {</span><br><span class="line">       List&lt;Dish&gt; dishList = dishMapper.list(dish);</span><br><span class="line"></span><br><span class="line">       List&lt;DishVO&gt; dishVOList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">for</span> (Dish d : dishList) {</span><br><span class="line">           <span class="type">DishVO</span> <span class="variable">dishVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DishVO</span>();</span><br><span class="line">           BeanUtils.copyProperties(d,dishVO);</span><br><span class="line"></span><br><span class="line">           <span class="comment">//根据菜品id查询对应的口味</span></span><br><span class="line">           List&lt;DishFlavor&gt; flavors = dishFlavorMapper.getByDishId(d.getId());</span><br><span class="line"></span><br><span class="line">           dishVO.setFlavors(flavors);</span><br><span class="line">           dishVOList.add(dishVO);</span><br><span class="line">       }</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> dishVOList;</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="4-2-3-controller-ceng">4.2.3 Controller层</span></h4><p><strong>创建DishController.java</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.constant.StatusConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Dish;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.DishService;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.DishVO;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController("userDishController")</span></span><br><span class="line"><span class="meta">@RequestMapping("/user/dish")</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = "C端-菜品浏览接口")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DishController</span> {</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishService dishService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据分类id查询菜品</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> categoryId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping("/list")</span></span><br><span class="line">    <span class="meta">@ApiOperation("根据分类id查询菜品")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;List&lt;DishVO&gt;&gt; <span class="title function_">list</span><span class="params">(Long categoryId)</span> {</span><br><span class="line">        <span class="type">Dish</span> <span class="variable">dish</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dish</span>();</span><br><span class="line">        dish.setCategoryId(categoryId);</span><br><span class="line">        dish.setStatus(StatusConstant.ENABLE);<span class="comment">//查询起售中的菜品</span></span><br><span class="line"></span><br><span class="line">        List&lt;DishVO&gt; list = dishService.listWithFlavor(dish);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success(list);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>创建CategoryController.java</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Category;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.CategoryService;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController("userCategoryController")</span></span><br><span class="line"><span class="meta">@RequestMapping("/user/category")</span></span><br><span class="line"><span class="meta">@Api(tags = "C端-分类接口")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CategoryController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CategoryService categoryService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询分类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping("/list")</span></span><br><span class="line">    <span class="meta">@ApiOperation("查询分类")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;List&lt;Category&gt;&gt; <span class="title function_">list</span><span class="params">(Integer type)</span> {</span><br><span class="line">        List&lt;Category&gt; list = categoryService.list(type);</span><br><span class="line">        <span class="keyword">return</span> Result.success(list);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>创建SetmealController.java</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.constant.StatusConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Setmeal;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.SetmealService;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.DishItemVO;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController("userSetmealController")</span></span><br><span class="line"><span class="meta">@RequestMapping("/user/setmeal")</span></span><br><span class="line"><span class="meta">@Api(tags = "C端-套餐浏览接口")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SetmealController</span> {</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SetmealService setmealService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 条件查询</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> categoryId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping("/list")</span></span><br><span class="line">    <span class="meta">@ApiOperation("根据分类id查询套餐")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;List&lt;Setmeal&gt;&gt; <span class="title function_">list</span><span class="params">(Long categoryId)</span> {</span><br><span class="line">        <span class="type">Setmeal</span> <span class="variable">setmeal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Setmeal</span>();</span><br><span class="line">        setmeal.setCategoryId(categoryId);</span><br><span class="line">        setmeal.setStatus(StatusConstant.ENABLE);</span><br><span class="line"></span><br><span class="line">        List&lt;Setmeal&gt; list = setmealService.list(setmeal);</span><br><span class="line">        <span class="keyword">return</span> Result.success(list);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据套餐id查询包含的菜品列表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping("/dish/{id}")</span></span><br><span class="line">    <span class="meta">@ApiOperation("根据套餐id查询包含的菜品列表")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;List&lt;DishItemVO&gt;&gt; <span class="title function_">dishList</span><span class="params">(<span class="meta">@PathVariable("id")</span> Long id)</span> {</span><br><span class="line">        List&lt;DishItemVO&gt; list = setmealService.getDishItemById(id);</span><br><span class="line">        <span class="keyword">return</span> Result.success(list);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-3-gong-neng-ce-shi">4.3 功能测试</span></h3><p>重启服务器、重新编译小程序</p>
<p>微信登录进入首页</p>
<p><strong>菜品和套餐分类查询：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221205205634465.png" alt="image-20221205205634465" style="zoom:50%;"> 

<p><strong>具体分类下的菜品查询：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221205205935019.png" alt="image-20221205205935019" style="zoom:50%;"> 

<p><strong>菜品口味查询：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221205210121546.png" alt="image-20221205210121546" style="zoom:50%;"> 



<h3><span id="4-4-dai-ma-ti-jiao">4.4 代码提交</span></h3><img src="/2024/09/26/projection-skytogo/image-20221205210421016.png" alt="image-20221205210421016" style="zoom:50%;"> 

<p>后续步骤和其它功能代码提交一致，不再赘述。</p>
<h1><span id="cang-qiong-wai-mai-day07">苍穹外卖-day07</span></h1><h2><span id="ke-cheng-nei-rong">课程内容</span></h2><ul>
<li>缓存菜品</li>
<li>缓存套餐</li>
<li>添加购物车</li>
<li>查看购物车</li>
<li>清空购物车</li>
</ul>
<p>功能实现：<strong>缓存商品</strong>、<strong>购物车</strong></p>
<p><strong>效果图：</strong></p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221208175444066.png" alt="image-20221208175444066" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/image-20221208175454987.png" alt="image-20221208175454987" style="zoom:50%;"><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221208175533325.png" alt="image-20221208175533325" style="zoom:50%;"></p>
<h2><span id="1-huan-cun-cai-pin">1. 缓存菜品</span></h2><h3><span id="1-1-wen-ti-shuo-ming">1.1 问题说明</span></h3><p>用户端小程序展示的菜品数据都是通过查询数据库获得，如果用户端访问量比较大，数据库访问压力随之增大。</p>
<img src="/2024/09/26/projection-skytogo/image-20221208180228667.png" alt="image-20221208180228667" style="zoom:80%;"> 

<p><strong>结果：</strong>系统响应慢、用户体验差</p>
<h3><span id="1-2-shi-xian-si-lu">1.2 实现思路</span></h3><p>通过Redis来缓存菜品数据，减少数据库查询操作。</p>
<img src="/2024/09/26/projection-skytogo/image-20221208180818572.png" alt="image-20221208180818572" style="zoom:80%;"> 

<p><strong>缓存逻辑分析：</strong></p>
<ul>
<li>每个分类下的菜品保存一份缓存数据</li>
<li>数据库中菜品数据有变更时清理缓存数据</li>
</ul>
<img src="/2024/09/26/projection-skytogo/image-20221208181007639.png" alt="image-20221208181007639" style="zoom:67%;"> 



<h3><span id="1-3-dai-ma-kai-fa">1.3 代码开发</span></h3><p><strong>修改用户端接口 DishController 的 list 方法，加入缓存处理逻辑：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据分类id查询菜品</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> categoryId</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@GetMapping("/list")</span></span><br><span class="line">   <span class="meta">@ApiOperation("根据分类id查询菜品")</span></span><br><span class="line">   <span class="keyword">public</span> Result&lt;List&lt;DishVO&gt;&gt; <span class="title function_">list</span><span class="params">(Long categoryId)</span> {</span><br><span class="line"></span><br><span class="line">       <span class="comment">//构造redis中的key，规则：dish_分类id</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">"dish_"</span> + categoryId;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//查询redis中是否存在菜品数据</span></span><br><span class="line">       List&lt;DishVO&gt; list = (List&lt;DishVO&gt;) redisTemplate.opsForValue().get(key);</span><br><span class="line">       <span class="keyword">if</span>(list != <span class="literal">null</span> &amp;&amp; list.size() &gt; <span class="number">0</span>){</span><br><span class="line">           <span class="comment">//如果存在，直接返回，无须查询数据库</span></span><br><span class="line">           <span class="keyword">return</span> Result.success(list);</span><br><span class="line">       }</span><br><span class="line">	<span class="comment">////////////////////////////////////////////////////////</span></span><br><span class="line">       <span class="type">Dish</span> <span class="variable">dish</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dish</span>();</span><br><span class="line">       dish.setCategoryId(categoryId);</span><br><span class="line">       dish.setStatus(StatusConstant.ENABLE);<span class="comment">//查询起售中的菜品</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">//如果不存在，查询数据库，将查询到的数据放入redis中</span></span><br><span class="line">       list = dishService.listWithFlavor(dish);</span><br><span class="line">       <span class="comment">////////////////////////////////////////////////////////</span></span><br><span class="line">       redisTemplate.opsForValue().set(key, list);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> Result.success(list);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<p>为了保证<strong>数据库</strong>和<strong>Redis</strong>中的数据保持一致，修改<strong>管理端接口 DishController</strong> 的相关方法，加入清理缓存逻辑。</p>
<p>需要改造的方法：</p>
<ul>
<li>新增菜品</li>
<li>修改菜品</li>
<li>批量删除菜品</li>
<li>起售、停售菜品</li>
</ul>
<p><strong>抽取清理缓存的方法：</strong></p>
<p>在管理端DishController中添加</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 清理缓存数据</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> pattern</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cleanCache</span><span class="params">(String pattern)</span>{</span><br><span class="line">       <span class="type">Set</span> <span class="variable">keys</span> <span class="operator">=</span> redisTemplate.keys(pattern);</span><br><span class="line">       redisTemplate.delete(keys);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<p><strong>调用清理缓存的方法，保证数据一致性：</strong></p>
<p><strong>1). 新增菜品优化</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 新增菜品</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> dishDTO</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@PostMapping</span></span><br><span class="line">   <span class="meta">@ApiOperation("新增菜品")</span></span><br><span class="line">   <span class="keyword">public</span> Result <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> DishDTO dishDTO)</span> {</span><br><span class="line">       log.info(<span class="string">"新增菜品：{}"</span>, dishDTO);</span><br><span class="line">       dishService.saveWithFlavor(dishDTO);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//清理缓存数据</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">"dish_"</span> + dishDTO.getCategoryId();</span><br><span class="line">       cleanCache(key);</span><br><span class="line">       <span class="keyword">return</span> Result.success();</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<p><strong>2). 菜品批量删除优化</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 菜品批量删除</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ids</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@DeleteMapping</span></span><br><span class="line">   <span class="meta">@ApiOperation("菜品批量删除")</span></span><br><span class="line">   <span class="keyword">public</span> Result <span class="title function_">delete</span><span class="params">(<span class="meta">@RequestParam</span> List&lt;Long&gt; ids)</span> {</span><br><span class="line">       log.info(<span class="string">"菜品批量删除：{}"</span>, ids);</span><br><span class="line">       dishService.deleteBatch(ids);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//将所有的菜品缓存数据清理掉，所有以dish_开头的key</span></span><br><span class="line">       cleanCache(<span class="string">"dish_*"</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> Result.success();</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<p><strong>3). 修改菜品优化</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 修改菜品</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> dishDTO</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@PutMapping</span></span><br><span class="line">   <span class="meta">@ApiOperation("修改菜品")</span></span><br><span class="line">   <span class="keyword">public</span> Result <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> DishDTO dishDTO)</span> {</span><br><span class="line">       log.info(<span class="string">"修改菜品：{}"</span>, dishDTO);</span><br><span class="line">       dishService.updateWithFlavor(dishDTO);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//将所有的菜品缓存数据清理掉，所有以dish_开头的key</span></span><br><span class="line">       cleanCache(<span class="string">"dish_*"</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> Result.success();</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<p><strong>4). 菜品起售停售优化</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 菜品起售停售</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@PostMapping("/status/{status}")</span></span><br><span class="line">   <span class="meta">@ApiOperation("菜品起售停售")</span></span><br><span class="line">   <span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">startOrStop</span><span class="params">(<span class="meta">@PathVariable</span> Integer status, Long id)</span> {</span><br><span class="line">       dishService.startOrStop(status, id);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//将所有的菜品缓存数据清理掉，所有以dish_开头的key</span></span><br><span class="line">       cleanCache(<span class="string">"dish_*"</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> Result.success();</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="1-4-gong-neng-ce-shi">1.4 功能测试</span></h3><p>可以通过如下方式进行测试：</p>
<ul>
<li>查看控制台sql</li>
<li>前后端联调</li>
<li>查看Redis中的缓存数据</li>
</ul>
<p>以<strong>加入缓存</strong>、<strong>菜品修改</strong>两个功能测试为例，通过前后端联调方式，查看控制台sql的打印和Redis中的缓存数据变化。</p>
<p><strong>1). 加入缓存</strong></p>
<p>当第一次查询某个分类的菜品时，会从数据为中进行查询，同时将查询的结果存储到Redis中，在后绪的访问，若查询相同分类的菜品时，直接从Redis缓存中查询，不再查询数据库。</p>
<p><strong>登录小程序：</strong>选择蜀味牛蛙(id=17)</p>
<img src="/2024/09/26/projection-skytogo/image-20221210174656770.png" alt="image-20221210174656770" style="zoom:50%;"> 

<p><strong>查看控制台sql：</strong>有查询语句，说明是从数据库中进行查询</p>
<img src="/2024/09/26/projection-skytogo/image-20221210174839028.png" alt="image-20221210174839028" style="zoom:50%;"> 

<p><strong>查看Redis中的缓存数据：</strong>说明缓存成功</p>
<img src="/2024/09/26/projection-skytogo/image-20221210175055282.png" alt="image-20221210175055282" style="zoom:50%;"> 

<p><strong>再次访问：</strong>选择蜀味牛蛙(id=17)</p>
<img src="/2024/09/26/projection-skytogo/image-20221210175438411.png" alt="image-20221210175438411" style="zoom:50%;"> 

<p>说明是从Redis中查询的数据。</p>
<p><strong>2). 菜品修改</strong></p>
<p>当在后台修改菜品数据时，为了保证Redis缓存中的数据和数据库中的数据时刻保持一致，当修改后，需要清空对应的缓存数据。用户再次访问时，还是先从数据库中查询，同时再把查询的结果存储到Redis中，这样，就能保证缓存和数据库的数据保持一致。</p>
<p><strong>进入后台：</strong>修改蜀味牛蛙分类下的任意一个菜品，当前分类的菜品数据已在Redis中缓存</p>
<img src="/2024/09/26/projection-skytogo/image-20221210180624453.png" alt="image-20221210180624453" style="zoom:50%;"> 

<p><strong>修改：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221210180900924.png" alt="image-20221210180900924" style="zoom:50%;"> 

<p><strong>查看Redis中的缓存数据：</strong>说明修改时，已清空缓存</p>
<img src="/2024/09/26/projection-skytogo/image-20221210181142408.png" alt="image-20221210181142408" style="zoom:50%;"> 

<p>用户再次访问同一个菜品分类时，需要先查询数据库，再把结果同步到Redis中，保证了两者数据一致性。</p>
<p>其它功能测试步骤基本一致，自已测试即可。</p>
<h3><span id="1-5-dai-ma-ti-jiao">1.5 代码提交</span></h3><img src="/2024/09/26/projection-skytogo/image-20221210202804407.png" alt="image-20221210202804407" style="zoom:50%;"> 

<p>后续步骤和其它功能代码提交一致，不再赘述。</p>
<h2><span id="2-huan-cun-tao-can">2. 缓存套餐</span></h2><h3><span id="2-1-spring-cache">2.1 Spring Cache</span></h3><h4><span id="2-1-1-jie-shao">2.1.1 介绍</span></h4><p>Spring Cache 是一个框架，实现了基于注解的缓存功能，只需要简单地加一个注解，就能实现缓存功能。</p>
<p>Spring Cache 提供了一层抽象，底层可以切换不同的缓存实现，例如：</p>
<ul>
<li>EHCache</li>
<li>Caffeine</li>
<li>Redis(常用)</li>
</ul>
<p><strong>起步依赖：</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  		            		       	 <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-1-2-chang-yong-zhu-jie">2.1.2 常用注解</span></h4><p>在SpringCache中提供了很多缓存操作的注解，常见的是以下的几个：</p>
<table>
<thead>
<tr>
<th><strong>注解</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>@EnableCaching</td>
<td>开启缓存注解功能，通常加在启动类上</td>
</tr>
<tr>
<td>@Cacheable</td>
<td>在方法执行前先查询缓存中是否有数据，如果有数据，则直接返回缓存数据；如果没有缓存数据，调用方法并将方法返回值放到缓存中</td>
</tr>
<tr>
<td>@CachePut</td>
<td>将方法的返回值放到缓存中</td>
</tr>
<tr>
<td>@CacheEvict</td>
<td>将一条或多条数据从缓存中删除</td>
</tr>
</tbody></table>
<p>在spring boot项目中，使用缓存技术只需在项目中导入相关缓存技术的依赖包，并在启动类上使用@EnableCaching开启缓存支持即可。</p>
<p>例如，使用Redis作为缓存技术，只需要导入Spring data Redis的maven坐标即可。</p>
<h4><span id="2-1-3-ru-men-an-li">2.1.3 入门案例</span></h4><p><strong>1). 环境准备</strong></p>
<p>**导入基础工程:**底层已使用Redis缓存实现</p>
<p>基础环境的代码，在我们今天的资料中已经准备好了， 大家只需要将这个工程导入进来就可以了。导入进来的工程结构如下： </p>
<img src="/2024/09/26/projection-skytogo/image-20221210183942040.png" alt="image-20221210183942040" style="zoom:50%;"> 

<p><strong>数据库准备:</strong></p>
<p>创建名为spring_cache_demo数据库，将springcachedemo.sql脚本直接导入数据库中。</p>
<img src="/2024/09/26/projection-skytogo/image-20221210184346304.png" alt="image-20221210184346304" style="zoom:80%;"> 

<p><strong>引导类上加@EnableCaching:</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.EnableCaching;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableCaching</span><span class="comment">//开启缓存注解功能</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheDemoApplication</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        SpringApplication.run(CacheDemoApplication.class,args);</span><br><span class="line">        log.info(<span class="string">"项目启动成功..."</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p><strong>2). @CachePut注解</strong></p>
<p><strong>@CachePut 说明：</strong> </p>
<p>​	作用: 将方法返回值，放入缓存</p>
<p>​	value: 缓存的名称, 每个缓存名称下面可以有很多key</p>
<p>​	key: 缓存的key  ———-&gt; 支持Spring的表达式语言SPEL语法</p>
<p><strong>在save方法上加注解@CachePut</strong></p>
<p>当前UserController的save方法是用来保存用户信息的，我们希望在该用户信息保存到数据库的同时，也往缓存中缓存一份数据，我们可以在save方法上加上注解 @CachePut，用法如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* CachePut：将方法返回值放入缓存</span></span><br><span class="line"><span class="comment">* value：缓存的名称，每个缓存名称下面可以有多个key</span></span><br><span class="line"><span class="comment">* key：缓存的key</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line">   <span class="meta">@CachePut(value = "userCache", key = "#user.id")</span><span class="comment">//key的生成：userCache::1</span></span><br><span class="line">   <span class="keyword">public</span> User <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span>{</span><br><span class="line">       userMapper.insert(user);</span><br><span class="line">       <span class="keyword">return</span> user;</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<p><strong>说明：</strong>key的写法如下</p>
<p>#user.id : #user指的是方法形参的名称, id指的是user的id属性 , 也就是使用user的id属性作为key ;</p>
<p>#result.id : #result代表方法返回值，该表达式 代表以返回对象的id属性作为key ；</p>
<p>#p0.id：#p0指的是方法中的第一个参数，id指的是第一个参数的id属性,也就是使用第一个参数的id属性作为key ;</p>
<p>#a0.id：#a0指的是方法中的第一个参数，id指的是第一个参数的id属性,也就是使用第一个参数的id属性作为key ;</p>
<p>#root.args[0].id:#root.args[0]指的是方法中的第一个参数，id指的是第一个参数的id属性,也就是使用第一个参数</p>
<p>的id属性作为key ;</p>
<p><strong>启动服务,通过swagger接口文档测试，访问UserController的save()方法</strong></p>
<p>因为id是自增，所以不需要设置id属性</p>
 <img src="/2024/09/26/projection-skytogo/image-20221210191702887.png" alt="image-20221210191702887" style="zoom:50%;"> 

<p><strong>查看user表中的数据</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221210192325931.png" alt="image-20221210192325931" style="zoom: 67%;"> 

<p><strong>查看Redis中的数据</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221210192418204.png" alt="image-20221210192418204" style="zoom:50%;"> 



<p><strong>3). @Cacheable注解</strong></p>
<p><strong>@Cacheable 说明:</strong></p>
<p>​	作用: 在方法执行前，spring先查看缓存中是否有数据，如果有数据，则直接返回缓存数据；若没有数据，调用方法并将方法返回值放到缓存中</p>
<p>​	value: 缓存的名称，每个缓存名称下面可以有多个key</p>
<p>​	key: 缓存的key  ———-&gt; 支持Spring的表达式语言SPEL语法</p>
<p> <strong>在getById上加注解@Cacheable</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Cacheable：在方法执行前spring先查看缓存中是否有数据，如果有数据，则直接返回缓存数据；若没有数据，	  *调用方法并将方法返回值放到缓存中</span></span><br><span class="line"><span class="comment">* value：缓存的名称，每个缓存名称下面可以有多个key</span></span><br><span class="line"><span class="comment">* key：缓存的key</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@GetMapping</span></span><br><span class="line">   <span class="meta">@Cacheable(cacheNames = "userCache",key="#id")</span></span><br><span class="line">   <span class="keyword">public</span> User <span class="title function_">getById</span><span class="params">(Long id)</span>{</span><br><span class="line">       <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.getById(id);</span><br><span class="line">       <span class="keyword">return</span> user;</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<p><strong>重启服务,通过swagger接口文档测试，访问UserController的getById()方法</strong></p>
<p>第一次访问，会请求我们controller的方法，查询数据库。后面再查询相同的id，就直接从Redis中查询数据，不用再查询数据库了，就说明缓存生效了。</p>
<p>提前在redis中手动删除掉id=1的用户数据</p>
<img src="/2024/09/26/projection-skytogo/image-20221210193834150.png" alt="image-20221210193834150" style="zoom:50%;"> 

<p><strong>查看控制台sql语句：</strong>说明从数据库查询的用户数据</p>
<img src="/2024/09/26/projection-skytogo/image-20221210193948896.png" alt="image-20221210193948896" style="zoom: 67%;"> 

<p><strong>查看Redis中的缓存数据：</strong>说明已成功缓存</p>
<img src="/2024/09/26/projection-skytogo/image-20221210194112334.png" alt="image-20221210194112334" style="zoom:50%;"> 

<p>再次查询相同id的数据时，直接从redis中直接获取，不再查询数据库。</p>
<p><strong>4). @CacheEvict注解</strong></p>
<p><strong>@CacheEvict 说明：</strong> </p>
<p>​	作用: 清理指定缓存</p>
<p>​	value: 缓存的名称，每个缓存名称下面可以有多个key</p>
<p>​	key: 缓存的key  ———-&gt; 支持Spring的表达式语言SPEL语法</p>
<p><strong>在 delete 方法上加注解@CacheEvict</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DeleteMapping</span></span><br><span class="line">   <span class="meta">@CacheEvict(cacheNames = "userCache",key = "#id")</span><span class="comment">//删除某个key对应的缓存数据</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteById</span><span class="params">(Long id)</span>{</span><br><span class="line">       userMapper.deleteById(id);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line"><span class="meta">@DeleteMapping("/delAll")</span></span><br><span class="line">   <span class="meta">@CacheEvict(cacheNames = "userCache",allEntries = true)</span><span class="comment">//删除userCache下所有的缓存数据</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteAll</span><span class="params">()</span>{</span><br><span class="line">       userMapper.deleteAll();</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<p><strong>重启服务,通过swagger接口文档测试，访问UserController的deleteAll()方法</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221210195254874.png" alt="image-20221210195254874" style="zoom:50%;"> 

<p><strong>查看user表：</strong>数据清空</p>
<img src="/2024/09/26/projection-skytogo/image-20221210195332101.png" alt="image-20221210195332101" style="zoom:80%;"> 

<p><strong>查询Redis缓存数据</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221210195500014.png" alt="image-20221210195500014" style="zoom:50%;"> 



<h3><span id="2-2-shi-xian-si-lu">2.2 实现思路</span></h3><p><strong>实现步骤：</strong></p>
<p>1). 导入Spring Cache和Redis相关maven坐标</p>
<p>2). 在启动类上加入@EnableCaching注解，开启缓存注解功能</p>
<p>3). 在用户端接口SetmealController的 list 方法上加入@Cacheable注解</p>
<p>4). 在管理端接口SetmealController的 save、delete、update、startOrStop等方法上加入CacheEvict注解</p>
<h3><span id="2-3-dai-ma-kai-fa">2.3 代码开发</span></h3><p>按照上述实现步骤：</p>
<p><strong>1). 导入Spring Cache和Redis相关maven坐标(已实现)</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<p><strong>2). 在启动类上加入@EnableCaching注解，开启缓存注解功能</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.EnableCaching;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span> <span class="comment">//开启注解方式的事务管理</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SkyApplication</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        SpringApplication.run(SkyApplication.class, args);</span><br><span class="line">        log.info(<span class="string">"server started"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p><strong>3). 在用户端接口SetmealController的 list 方法上加入@Cacheable注解</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 条件查询</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> categoryId</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@GetMapping("/list")</span></span><br><span class="line">   <span class="meta">@ApiOperation("根据分类id查询套餐")</span></span><br><span class="line">   <span class="meta">@Cacheable(cacheNames = "setmealCache",key = "#categoryId")</span> <span class="comment">//key: setmealCache::100</span></span><br><span class="line">   <span class="keyword">public</span> Result&lt;List&lt;Setmeal&gt;&gt; <span class="title function_">list</span><span class="params">(Long categoryId)</span> {</span><br><span class="line">       <span class="type">Setmeal</span> <span class="variable">setmeal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Setmeal</span>();</span><br><span class="line">       setmeal.setCategoryId(categoryId);</span><br><span class="line">       setmeal.setStatus(StatusConstant.ENABLE);</span><br><span class="line"></span><br><span class="line">       List&lt;Setmeal&gt; list = setmealService.list(setmeal);</span><br><span class="line">       <span class="keyword">return</span> Result.success(list);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<p><strong>4). 在管理端接口SetmealController的 save、delete、update、startOrStop等方法上加入CacheEvict注解</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 新增套餐</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> setmealDTO</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@PostMapping</span></span><br><span class="line">   <span class="meta">@ApiOperation("新增套餐")</span></span><br><span class="line">   <span class="meta">@CacheEvict(cacheNames = "setmealCache",key = "#setmealDTO.categoryId")</span><span class="comment">//key: setmealCache::100</span></span><br><span class="line">   <span class="keyword">public</span> Result <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> SetmealDTO setmealDTO)</span> {</span><br><span class="line">       setmealService.saveWithDish(setmealDTO);</span><br><span class="line">       <span class="keyword">return</span> Result.success();</span><br><span class="line">   }</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 批量删除套餐</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ids</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@DeleteMapping</span></span><br><span class="line">   <span class="meta">@ApiOperation("批量删除套餐")</span></span><br><span class="line">   <span class="meta">@CacheEvict(cacheNames = "setmealCache",allEntries = true)</span></span><br><span class="line">   <span class="keyword">public</span> Result <span class="title function_">delete</span><span class="params">(<span class="meta">@RequestParam</span> List&lt;Long&gt; ids)</span> {</span><br><span class="line">       setmealService.deleteBatch(ids);</span><br><span class="line">       <span class="keyword">return</span> Result.success();</span><br><span class="line">   }</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 修改套餐</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> setmealDTO</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@PutMapping</span></span><br><span class="line">   <span class="meta">@ApiOperation("修改套餐")</span></span><br><span class="line">   <span class="meta">@CacheEvict(cacheNames = "setmealCache",allEntries = true)</span></span><br><span class="line">   <span class="keyword">public</span> Result <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> SetmealDTO setmealDTO)</span> {</span><br><span class="line">       setmealService.update(setmealDTO);</span><br><span class="line">       <span class="keyword">return</span> Result.success();</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 套餐起售停售</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@PostMapping("/status/{status}")</span></span><br><span class="line">   <span class="meta">@ApiOperation("套餐起售停售")</span></span><br><span class="line">   <span class="meta">@CacheEvict(cacheNames = "setmealCache",allEntries = true)</span></span><br><span class="line">   <span class="keyword">public</span> Result <span class="title function_">startOrStop</span><span class="params">(<span class="meta">@PathVariable</span> Integer status, Long id)</span> {</span><br><span class="line">       setmealService.startOrStop(status, id);</span><br><span class="line">       <span class="keyword">return</span> Result.success();</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-4-gong-neng-ce-shi">2.4 功能测试</span></h3><p>通过前后端联调方式来进行测试，同时观察redis中缓存的套餐数据。和<strong>缓存菜品</strong>功能测试基本一致，不再赘述。</p>
<h3><span id="2-5-dai-ma-ti-jiao">2.5 代码提交</span></h3><img src="/2024/09/26/projection-skytogo/image-20221210203035708.png" alt="image-20221210203035708" style="zoom:50%;"> 

<p>后续步骤和其它功能代码提交一致，不再赘述。</p>
<h2><span id="3-tian-jia-gou-wu-che">3. 添加购物车</span></h2><h3><span id="3-1-xu-qiu-fen-xi-he-she-ji">3.1 需求分析和设计</span></h3><h4><span id="3-1-1-chan-pin-yuan-xing">3.1.1 产品原型</span></h4><p>用户可以将菜品或者套餐添加到购物车。对于菜品来说，如果设置了口味信息，则需要选择规格后才能加入购物车;对于套餐来说，可以直接点击<img src="/2024/09/26/projection-skytogo/image-20210813181916235.png" alt="image-20210813181916235" style="zoom: 67%;">将当前套餐加入购物车。在购物车中可以修改菜品和套餐的数量，也可以清空购物车。</p>
<p><strong>效果图：</strong></p>
 <img src="/2024/09/26/projection-skytogo/image-20221210203822817.png" alt="image-20221210203822817" style="zoom:50%;"> 



<h4><span id="3-1-2-jie-kou-she-ji">3.1.2 接口设计</span></h4><p>通过上述原型图，设计出对应的添加购物车接口。</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221208184342490.png" alt="image-20221208184342490" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221208184354291.png" alt="image-20221208184354291" style="zoom:50%;"></p>
<p><strong>说明：</strong>添加购物车时，有可能添加菜品，也有可能添加套餐。故传入参数要么是菜品id，要么是套餐id。</p>
<h4><span id="3-1-3-biao-she-ji">3.1.3 表设计</span></h4><p>用户的购物车数据，也是需要保存在数据库中的，购物车对应的数据表为shopping_cart表，具体表结构如下：</p>
<table>
<thead>
<tr>
<th><strong>字段名</strong></th>
<th><strong>数据类型</strong></th>
<th><strong>说明</strong></th>
<th><strong>备注</strong></th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>bigint</td>
<td>主键</td>
<td>自增</td>
</tr>
<tr>
<td>name</td>
<td>varchar(32)</td>
<td>商品名称</td>
<td>冗余字段</td>
</tr>
<tr>
<td>image</td>
<td>varchar(255)</td>
<td>商品图片路径</td>
<td>冗余字段</td>
</tr>
<tr>
<td>user_id</td>
<td>bigint</td>
<td>用户id</td>
<td>逻辑外键</td>
</tr>
<tr>
<td>dish_id</td>
<td>bigint</td>
<td>菜品id</td>
<td>逻辑外键</td>
</tr>
<tr>
<td>setmeal_id</td>
<td>bigint</td>
<td>套餐id</td>
<td>逻辑外键</td>
</tr>
<tr>
<td>dish_flavor</td>
<td>varchar(50)</td>
<td>菜品口味</td>
<td></td>
</tr>
<tr>
<td>number</td>
<td>int</td>
<td>商品数量</td>
<td></td>
</tr>
<tr>
<td>amount</td>
<td>decimal(10,2)</td>
<td>商品单价</td>
<td>冗余字段</td>
</tr>
<tr>
<td>create_time</td>
<td>datetime</td>
<td>创建时间</td>
<td></td>
</tr>
</tbody></table>
<p><strong>说明：</strong> </p>
<ul>
<li>购物车数据是关联用户的，在表结构中，我们需要记录，每一个用户的购物车数据是哪些</li>
<li>菜品列表展示出来的既有套餐，又有菜品，如果用户选择的是套餐，就保存套餐ID(setmeal_id)，如果用户选择的是菜品，就保存菜品ID(dish_id)</li>
<li>对同一个菜品/套餐，如果选择多份不需要添加多条记录，增加数量number即可</li>
</ul>
<h3><span id="3-2-dai-ma-kai-fa">3.2 代码开发</span></h3><h4><span id="3-2-1-dto-she-ji">3.2.1 DTO设计</span></h4><p><strong>根据添加购物车接口的参数设计DTO：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221208184938195.png" alt="image-20221208184938195" style="zoom:50%;"> 

<p>在sky-pojo模块，ShoppingCartDTO.java已定义</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShoppingCartDTO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long dishId;</span><br><span class="line">    <span class="keyword">private</span> Long setmealId;</span><br><span class="line">    <span class="keyword">private</span> String dishFlavor;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-2-2-controller-ceng">3.2.2 Controller层</span></h4><p><strong>根据添加购物车接口创建ShoppingCartController：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.user;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.dto.ShoppingCartDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 购物车</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/user/shoppingCart")</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = "C端-购物车接口")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShoppingCartController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ShoppingCartService shoppingCartService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加购物车</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shoppingCartDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping("/add")</span></span><br><span class="line">    <span class="meta">@ApiOperation("添加购物车")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> ShoppingCartDTO shoppingCartDTO)</span>{</span><br><span class="line">        log.info(<span class="string">"添加购物车：{}"</span>, shoppingCartDTO);</span><br><span class="line">        shoppingCartService.addShoppingCart(shoppingCartDTO);<span class="comment">//后绪步骤实现</span></span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-2-3-service-ceng-jie-kou">3.2.3 Service层接口</span></h4><p><strong>创建ShoppingCartService接口：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.dto.ShoppingCartDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.ShoppingCart;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ShoppingCartService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加购物车</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shoppingCartDTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addShoppingCart</span><span class="params">(ShoppingCartDTO shoppingCartDTO)</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-2-4-service-ceng-shi-xian-lei">3.2.4 Service层实现类</span></h4><p><strong>创建ShoppingCartServiceImpl实现类，并实现add方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.context.BaseContext;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.ShoppingCartDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Dish;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Setmeal;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.ShoppingCart;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.DishMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.SetmealMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.ShoppingCartService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShoppingCartServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ShoppingCartService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ShoppingCartMapper shoppingCartMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishMapper dishMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SetmealMapper setmealMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加购物车</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shoppingCartDTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addShoppingCart</span><span class="params">(ShoppingCartDTO shoppingCartDTO)</span> {</span><br><span class="line">        <span class="type">ShoppingCart</span> <span class="variable">shoppingCart</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShoppingCart</span>();</span><br><span class="line">        BeanUtils.copyProperties(shoppingCartDTO, shoppingCart);</span><br><span class="line">        <span class="comment">//只能查询自己的购物车数据</span></span><br><span class="line">        shoppingCart.setUserId(BaseContext.getCurrentId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断当前商品是否在购物车中</span></span><br><span class="line">        List&lt;ShoppingCart&gt; shoppingCartList = shoppingCartMapper.list(shoppingCart);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (shoppingCartList != <span class="literal">null</span> &amp;&amp; shoppingCartList.size() == <span class="number">1</span>) {</span><br><span class="line">            <span class="comment">//如果已经存在，就更新数量，数量加1</span></span><br><span class="line">            shoppingCart = shoppingCartList.get(<span class="number">0</span>);</span><br><span class="line">            shoppingCart.setNumber(shoppingCart.getNumber() + <span class="number">1</span>);</span><br><span class="line">            shoppingCartMapper.updateNumberById(shoppingCart);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">//如果不存在，插入数据，数量就是1</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//判断当前添加到购物车的是菜品还是套餐</span></span><br><span class="line">            <span class="type">Long</span> <span class="variable">dishId</span> <span class="operator">=</span> shoppingCartDTO.getDishId();</span><br><span class="line">            <span class="keyword">if</span> (dishId != <span class="literal">null</span>) {</span><br><span class="line">                <span class="comment">//添加到购物车的是菜品</span></span><br><span class="line">                <span class="type">Dish</span> <span class="variable">dish</span> <span class="operator">=</span> dishMapper.getById(dishId);</span><br><span class="line">                shoppingCart.setName(dish.getName());</span><br><span class="line">                shoppingCart.setImage(dish.getImage());</span><br><span class="line">                shoppingCart.setAmount(dish.getPrice());</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">//添加到购物车的是套餐</span></span><br><span class="line">                <span class="type">Setmeal</span> <span class="variable">setmeal</span> <span class="operator">=</span> setmealMapper.getById(shoppingCartDTO.getSetmealId());</span><br><span class="line">                shoppingCart.setName(setmeal.getName());</span><br><span class="line">                shoppingCart.setImage(setmeal.getImage());</span><br><span class="line">                shoppingCart.setAmount(setmeal.getPrice());</span><br><span class="line">            }</span><br><span class="line">            shoppingCart.setNumber(<span class="number">1</span>);</span><br><span class="line">            shoppingCart.setCreateTime(LocalDateTime.now());</span><br><span class="line">            shoppingCartMapper.insert(shoppingCart);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-2-5-mapper-ceng">3.2.5 Mapper层</span></h4><p><strong>创建ShoppingCartMapper接口:</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.entity.ShoppingCart;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Delete;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Insert;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Update;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ShoppingCartMapper</span> {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 条件查询</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shoppingCart</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;ShoppingCart&gt; <span class="title function_">list</span><span class="params">(ShoppingCart shoppingCart)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新商品数量</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shoppingCart</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Update("update shopping_cart set number = #{number} where id = #{id}")</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">updateNumberById</span><span class="params">(ShoppingCart shoppingCart)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入购物车数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shoppingCart</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Insert("insert into shopping_cart (name, user_id, dish_id, setmeal_id, dish_flavor, number, amount, image, create_time) " +</span></span><br><span class="line"><span class="meta">            " values (#{name},#{userId},#{dishId},#{setmealId},#{dishFlavor},#{number},#{amount},#{image},#{createTime})")</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(ShoppingCart shoppingCart)</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>创建ShoppingCartMapper.xml：</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.sky.mapper.ShoppingCartMapper"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"list"</span> <span class="attr">parameterType</span>=<span class="string">"ShoppingCart"</span> <span class="attr">resultType</span>=<span class="string">"ShoppingCart"</span>&gt;</span></span><br><span class="line">        select * from shopping_cart</span><br><span class="line">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"userId != null"</span>&gt;</span></span><br><span class="line">                and user_id = #{userId}</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"dishId != null"</span>&gt;</span></span><br><span class="line">                and dish_id = #{dishId}</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"setmealId != null"</span>&gt;</span></span><br><span class="line">                and setmeal_id = #{setmealId}</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"dishFlavor != null"</span>&gt;</span></span><br><span class="line">                and dish_flavor = #{dishFlavor}</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">        order by create_time desc</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-3-gong-neng-ce-shi">3.3 功能测试</span></h3><p>进入小程序，添加菜品</p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221210210338094.png" alt="image-20221210210338094" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/image-20221210210409954.png" alt="image-20221210210409954" style="zoom:50%;"></p>
<p>加入购物车，查询数据库</p>
<img src="/2024/09/26/projection-skytogo/image-20221210210643308.png" alt="image-20221210210643308" style="zoom:80%;"> 

<p>因为现在没有实现查看购物车功能，所以只能在表中进行查看。</p>
<p>在前后联调时，后台可通断点方式启动，查看运行的每一步。</p>
<h3><span id="3-4-dai-ma-ti-jiao">3.4 代码提交</span></h3><img src="/2024/09/26/projection-skytogo/image-20221210211145602.png" alt="image-20221210211145602" style="zoom:50%;"> 

<p>后续步骤和其它功能代码提交一致，不再赘述。</p>
<h2><span id="4-cha-kan-gou-wu-che">4. 查看购物车</span></h2><h3><span id="4-1-xu-qiu-fen-xi-he-she-ji">4.1 需求分析和设计</span></h3><h4><span id="4-1-1-chan-pin-yuan-xing">4.1.1 产品原型</span></h4><p>当用户添加完菜品和套餐后，可进入到购物车中，查看购物中的菜品和套餐。</p>
<img src="/2024/09/26/projection-skytogo/image-20221208190038058.png" alt="image-20221208190038058" style="zoom:50%;"> 



<h4><span id="4-1-2-jie-kou-she-ji">4.1.2 接口设计</span></h4><p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221208190052467.png" alt="image-20221208190052467" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/image-20221208190102904.png" alt="image-20221208190102904" style="zoom:50%;"></p>
<h3><span id="4-2-dai-ma-kai-fa">4.2 代码开发</span></h3><h4><span id="4-2-1-controller-ceng">4.2.1 Controller层</span></h4><p><strong>在ShoppingCartController中创建查看购物车的方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 查看购物车</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@GetMapping("/list")</span></span><br><span class="line">   <span class="meta">@ApiOperation("查看购物车")</span></span><br><span class="line">   <span class="keyword">public</span> Result&lt;List&lt;ShoppingCart&gt;&gt; <span class="title function_">list</span><span class="params">()</span>{</span><br><span class="line">       <span class="keyword">return</span> Result.success(shoppingCartService.showShoppingCart());</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="4-2-2-service-ceng-jie-kou">4.2.2 Service层接口</span></h4><p><strong>在ShoppingCartService接口中声明查看购物车的方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 查看购物车</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   List&lt;ShoppingCart&gt; <span class="title function_">showShoppingCart</span><span class="params">()</span>;</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="4-2-3-service-ceng-shi-xian-lei">4.2.3 Service层实现类</span></h4><p><strong>在ShoppingCartServiceImpl中实现查看购物车的方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 查看购物车</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> List&lt;ShoppingCart&gt; <span class="title function_">showShoppingCart</span><span class="params">()</span> {</span><br><span class="line">       <span class="keyword">return</span> shoppingCartMapper.list(ShoppingCart.</span><br><span class="line">                                      builder().</span><br><span class="line">                                      userId(BaseContext.getCurrentId()).</span><br><span class="line">                                      build());</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-3-gong-neng-ce-shi">4.3 功能测试</span></h3><p>当进入小程序时，就会发起查看购物车的请求</p>
<img src="/2024/09/26/projection-skytogo/image-20221210213347557.png" alt="image-20221210213347557" style="zoom:50%;"> 

<p>点击购物车图标</p>
<img src="/2024/09/26/projection-skytogo/image-20221210213438878.png" alt="image-20221210213438878" style="zoom:50%;"> 

<p>测试成功。</p>
<h3><span id="4-4-dai-ma-ti-jiao">4.4 代码提交</span></h3><img src="/2024/09/26/projection-skytogo/image-20221210213555667.png" alt="image-20221210213555667" style="zoom:50%;"> 

<p>后续步骤和其它功能代码提交一致，不再赘述。</p>
<h2><span id="5-qing-kong-gou-wu-che">5. 清空购物车</span></h2><h3><span id="5-1-xu-qiu-fen-xi-he-she-ji">5.1 需求分析和设计</span></h3><h4><span id="5-1-1-chan-pin-yuan-xing">5.1.1 产品原型</span></h4><p>当点击清空按钮时，会把购物车中的数据全部清空。</p>
<img src="/2024/09/26/projection-skytogo/image-20221210213703715.png" alt="image-20221210213703715" style="zoom:50%;"> 



<h4><span id="5-1-2-jie-kou-she-ji">5.1.2 接口设计</span></h4><img src="/2024/09/26/projection-skytogo/image-20221208191606894.png" alt="image-20221208191606894" style="zoom:50%;"> 



<h3><span id="5-2-dai-ma-kai-fa">5.2 代码开发</span></h3><h4><span id="5-2-1-controller-ceng">5.2.1 Controller层</span></h4><p><strong>在ShoppingCartController中创建清空购物车的方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 清空购物车商品</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@DeleteMapping("/clean")</span></span><br><span class="line">   <span class="meta">@ApiOperation("清空购物车商品")</span></span><br><span class="line">   <span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">clean</span><span class="params">()</span>{</span><br><span class="line">       shoppingCartService.cleanShoppingCart();</span><br><span class="line">       <span class="keyword">return</span> Result.success();</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="5-2-2-service-ceng-jie-kou">5.2.2 Service层接口</span></h4><p><strong>在ShoppingCartService接口中声明清空购物车的方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 清空购物车商品</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">cleanShoppingCart</span><span class="params">()</span>;</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="5-2-3-service-ceng-shi-xian-lei">5.2.3 Service层实现类</span></h4><p><strong>在ShoppingCartServiceImpl中实现清空购物车的方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 清空购物车商品</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cleanShoppingCart</span><span class="params">()</span> {</span><br><span class="line">       shoppingCartMapper.deleteByUserId(BaseContext.getCurrentId());</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="5-2-4-mapper-ceng">5.2.4 Mapper层</span></h4><p><strong>在ShoppingCartMapper接口中创建删除购物车数据的方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据用户id删除购物车数据</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Delete("delete from shopping_cart where user_id = #{userId}")</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">deleteByUserId</span><span class="params">(Long userId)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="5-3-gong-neng-ce-shi">5.3 功能测试</span></h3><p>进入到购物车页面</p>
<img src="/2024/09/26/projection-skytogo/image-20221210214710863.png" alt="image-20221210214710863" style="zoom:50%;"> 

<p>点击清空</p>
<img src="/2024/09/26/projection-skytogo/image-20221210214914092.png" alt="image-20221210214914092" style="zoom:50%;"> 

<p>查看数据库中的数据</p>
<img src="/2024/09/26/projection-skytogo/image-20221210214950261.png" alt="image-20221210214950261" style="zoom:80%;"> 

<p>说明当前用户的购物车数据已全部删除。</p>
<h3><span id="5-4-dai-ma-ti-jiao">5.4 代码提交</span></h3><img src="/2024/09/26/projection-skytogo/image-20221210215130746.png" alt="image-20221210215130746" style="zoom:50%;"> 

<p>后续步骤和其它功能代码提交一致，不再赘述。</p>
<h1><span id="cang-qiong-wai-mai-day08">苍穹外卖-day08</span></h1><h2><span id="ke-cheng-nei-rong">课程内容</span></h2><ul>
<li>导入地址簿功能代码</li>
<li>用户下单</li>
<li>订单支付</li>
</ul>
<p>功能实现：<strong>用户下单</strong>、<strong>订单支付</strong></p>
<p><strong>用户下单效果图：</strong></p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221214181127718.png" alt="image-20221214181127718" style="zoom:50%;">    <img src="/2024/09/26/projection-skytogo/image-20221214181140570.png" alt="image-20221214181140570" style="zoom:50%;">     </p>
<p><strong>订单支付效果图：</strong></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221214181221426.png" alt="image-20221214181221426" style="zoom:50%;">    <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221214181234208.png" alt="image-20221214181234208" style="zoom:50%;">    <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221214181301304.png" alt="image-20221214181301304" style="zoom:50%;"></p>
<h2><span id="1-dao-ru-di-zhi-bo-gong-neng-dai-ma">1. 导入地址簿功能代码</span></h2><h3><span id="1-1-xu-qiu-fen-xi-he-she-ji">1.1 需求分析和设计</span></h3><h4><span id="1-1-1-chan-pin-yuan-xing">1.1.1 产品原型</span></h4><p>地址簿，指的是消费者用户的地址信息，用户登录成功后可以维护自己的地址信息。同一个用户可以有多个地址信息，但是只能有一个<strong>默认地址</strong>。</p>
<p><strong>效果图：</strong></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221214183615228.png" alt="image-20221214183615228" style="zoom:50%;">      <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221214183626673.png" alt="image-20221214183626673" style="zoom:50%;">       <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221214183859446.png" alt="image-20221214183859446" style="zoom:50%;"> </p>
<p>对于地址簿管理，我们需要实现以下几个功能： </p>
<ul>
<li>查询地址列表</li>
<li>新增地址</li>
<li>修改地址</li>
<li>删除地址</li>
<li>设置默认地址</li>
<li>查询默认地址</li>
</ul>
<h4><span id="1-1-2-jie-kou-she-ji">1.1.2 接口设计</span></h4><p>根据上述原型图先<strong>粗粒度</strong>设计接口，共包含7个接口。</p>
<p><strong>接口设计：</strong></p>
<ul>
<li>新增地址</li>
<li>查询登录用户所有地址</li>
<li>查询默认地址</li>
<li>根据id修改地址</li>
<li>根据id删除地址</li>
<li>根据id查询地址</li>
<li>设置默认地址</li>
</ul>
<p>接下来<strong>细粒度</strong>分析每个接口，明确每个接口的请求方式、请求路径、传入参数和返回值。</p>
<p><strong>1). 新增地址</strong></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221214185000982.png" alt="image-20221214185000982" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221214185013172.png" alt="image-20221214185013172" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221214185028575.png" alt="image-20221214185028575" style="zoom:50%;"> </p>
<p><strong>2). 查询登录用户所有地址</strong></p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221214185112802.png" alt="image-20221214185112802" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/image-20221214185124296.png" alt="image-20221214185124296" style="zoom:50%;"> </p>
<p><strong>3). 查询默认地址</strong></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221214185209235.png" alt="image-20221214185209235" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221214185221421.png" alt="image-20221214185221421" style="zoom:50%;"> </p>
<p><strong>4). 修改地址</strong></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221214185309798.png" alt="image-20221214185309798" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221214185321203.png" alt="image-20221214185321203" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221214185334356.png" alt="image-20221214185334356" style="zoom:50%;"> </p>
<p><strong>5). 根据id删除地址</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221214185443519.png" alt="image-20221214185443519" style="zoom:50%;"> 



<p><strong>6). 根据id查询地址</strong></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221214185534450.png" alt="image-20221214185534450" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221214185545692.png" alt="image-20221214185545692" style="zoom:50%;"> </p>
<p><strong>7). 设置默认地址</strong></p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221214185622092.png" alt="image-20221214185622092" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/image-20221214185631755.png" alt="image-20221214185631755" style="zoom:50%;"> </p>
<h4><span id="1-1-3-biao-she-ji">1.1.3 表设计</span></h4><p>用户的地址信息会存储在address_book表，即地址簿表中。具体表结构如下：</p>
<table>
<thead>
<tr>
<th><strong>字段名</strong></th>
<th><strong>数据类型</strong></th>
<th><strong>说明</strong></th>
<th><strong>备注</strong></th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>bigint</td>
<td>主键</td>
<td>自增</td>
</tr>
<tr>
<td>user_id</td>
<td>bigint</td>
<td>用户id</td>
<td>逻辑外键</td>
</tr>
<tr>
<td>consignee</td>
<td>varchar(50)</td>
<td>收货人</td>
<td></td>
</tr>
<tr>
<td>sex</td>
<td>varchar(2)</td>
<td>性别</td>
<td></td>
</tr>
<tr>
<td>phone</td>
<td>varchar(11)</td>
<td>手机号</td>
<td></td>
</tr>
<tr>
<td>province_code</td>
<td>varchar(12)</td>
<td>省份编码</td>
<td></td>
</tr>
<tr>
<td>province_name</td>
<td>varchar(32)</td>
<td>省份名称</td>
<td></td>
</tr>
<tr>
<td>city_code</td>
<td>varchar(12)</td>
<td>城市编码</td>
<td></td>
</tr>
<tr>
<td>city_name</td>
<td>varchar(32)</td>
<td>城市名称</td>
<td></td>
</tr>
<tr>
<td>district_code</td>
<td>varchar(12)</td>
<td>区县编码</td>
<td></td>
</tr>
<tr>
<td>district_name</td>
<td>varchar(32)</td>
<td>区县名称</td>
<td></td>
</tr>
<tr>
<td>detail</td>
<td>varchar(200)</td>
<td>详细地址信息</td>
<td>具体到门牌号</td>
</tr>
<tr>
<td>label</td>
<td>varchar(100)</td>
<td>标签</td>
<td>公司、家、学校</td>
</tr>
<tr>
<td>is_default</td>
<td>tinyint(1)</td>
<td>是否默认地址</td>
<td>1是 0否</td>
</tr>
</tbody></table>
<p>这里面有一个字段is_default，实际上我们在设置默认地址时，只需要更新这个字段就可以了。</p>
<h3><span id="1-2-dai-ma-dao-ru">1.2 代码导入</span></h3><p>对于这一类的单表的增删改查，我们已经写过很多了，基本的开发思路都是一样的，那么本小节的用户地址簿管理的增删改查功能，我们就不再一一实现了，基本的代码我们都已经提供了，直接导入进来，做一个测试即可。</p>
<p>导入课程资料中的地址簿模块功能代码：</p>
<img src="/2024/09/26/projection-skytogo/image-20221214190135741.png" alt="image-20221214190135741" style="zoom:50%;"> 

<p>进入到sky-server模块中</p>
<h4><span id="1-2-1-mapper-ceng">1.2.1 Mapper层</span></h4><p><strong>创建AddressBookMapper.java</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.entity.AddressBook;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.*;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AddressBookMapper</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 条件查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> addressBook</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    List&lt;AddressBook&gt; <span class="title function_">list</span><span class="params">(AddressBook addressBook)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> addressBook</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Insert("insert into address_book" +</span></span><br><span class="line"><span class="meta">            "        (user_id, consignee, phone, sex, province_code, province_name, city_code, city_name, district_code," +</span></span><br><span class="line"><span class="meta">            "         district_name, detail, label, is_default)" +</span></span><br><span class="line"><span class="meta">            "        values (#{userId}, #{consignee}, #{phone}, #{sex}, #{provinceCode}, #{provinceName}, #{cityCode}, #{cityName}," +</span></span><br><span class="line"><span class="meta">            "                #{districtCode}, #{districtName}, #{detail}, #{label}, #{isDefault})")</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(AddressBook addressBook)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Select("select * from address_book where id = #{id}")</span></span><br><span class="line">    AddressBook <span class="title function_">getById</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id修改</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> addressBook</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(AddressBook addressBook)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据 用户id修改 是否默认地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> addressBook</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Update("update address_book set is_default = #{isDefault} where user_id = #{userId}")</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">updateIsDefaultByUserId</span><span class="params">(AddressBook addressBook)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id删除地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Delete("delete from address_book where id = #{id}")</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteById</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>创建AddressBookMapper.xml</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.sky.mapper.AddressBookMapper"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"list"</span> <span class="attr">parameterType</span>=<span class="string">"AddressBook"</span> <span class="attr">resultType</span>=<span class="string">"AddressBook"</span>&gt;</span></span><br><span class="line">        select * from address_book</span><br><span class="line">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"userId != null"</span>&gt;</span></span><br><span class="line">                and user_id = #{userId}</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"phone != null"</span>&gt;</span></span><br><span class="line">                and phone = #{phone}</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"isDefault != null"</span>&gt;</span></span><br><span class="line">                and is_default = #{isDefault}</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"update"</span> <span class="attr">parameterType</span>=<span class="string">"addressBook"</span>&gt;</span></span><br><span class="line">        update address_book</span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"consignee != null"</span>&gt;</span></span><br><span class="line">                consignee = #{consignee},</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"sex != null"</span>&gt;</span></span><br><span class="line">                sex = #{sex},</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"phone != null"</span>&gt;</span></span><br><span class="line">                phone = #{phone},</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"detail != null"</span>&gt;</span></span><br><span class="line">                detail = #{detail},</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"label != null"</span>&gt;</span></span><br><span class="line">                label = #{label},</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"isDefault != null"</span>&gt;</span></span><br><span class="line">                is_default = #{isDefault},</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        where id = #{id}</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="1-2-2-service-ceng">1.2.2 Service层</span></h4><p><strong>创建AddressBookService.java</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.entity.AddressBook;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AddressBookService</span> {</span><br><span class="line"></span><br><span class="line">    List&lt;AddressBook&gt; <span class="title function_">list</span><span class="params">(AddressBook addressBook)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(AddressBook addressBook)</span>;</span><br><span class="line"></span><br><span class="line">    AddressBook <span class="title function_">getById</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(AddressBook addressBook)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setDefault</span><span class="params">(AddressBook addressBook)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">deleteById</span><span class="params">(Long id)</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>创建AddressBookServiceImpl.java</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.context.BaseContext;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.AddressBook;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.AddressBookMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.AddressBookService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddressBookServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AddressBookService</span> {</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AddressBookMapper addressBookMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 条件查询</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> addressBook</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;AddressBook&gt; <span class="title function_">list</span><span class="params">(AddressBook addressBook)</span> {</span><br><span class="line">        <span class="keyword">return</span> addressBookMapper.list(addressBook);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增地址</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> addressBook</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(AddressBook addressBook)</span> {</span><br><span class="line">        addressBook.setUserId(BaseContext.getCurrentId());</span><br><span class="line">        addressBook.setIsDefault(<span class="number">0</span>);</span><br><span class="line">        addressBookMapper.insert(addressBook);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> AddressBook <span class="title function_">getById</span><span class="params">(Long id)</span> {</span><br><span class="line">        <span class="type">AddressBook</span> <span class="variable">addressBook</span> <span class="operator">=</span> addressBookMapper.getById(id);</span><br><span class="line">        <span class="keyword">return</span> addressBook;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id修改地址</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> addressBook</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(AddressBook addressBook)</span> {</span><br><span class="line">        addressBookMapper.update(addressBook);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置默认地址</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> addressBook</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDefault</span><span class="params">(AddressBook addressBook)</span> {</span><br><span class="line">        <span class="comment">//1、将当前用户的所有地址修改为非默认地址 update address_book set is_default = ? where user_id = ?</span></span><br><span class="line">        addressBook.setIsDefault(<span class="number">0</span>);</span><br><span class="line">        addressBook.setUserId(BaseContext.getCurrentId());</span><br><span class="line">        addressBookMapper.updateIsDefaultByUserId(addressBook);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、将当前地址改为默认地址 update address_book set is_default = ? where id = ?</span></span><br><span class="line">        addressBook.setIsDefault(<span class="number">1</span>);</span><br><span class="line">        addressBookMapper.update(addressBook);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id删除地址</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteById</span><span class="params">(Long id)</span> {</span><br><span class="line">        addressBookMapper.deleteById(id);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="1-2-3-controller-ceng">1.2.3 Controller层</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.context.BaseContext;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.AddressBook;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.AddressBookService;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/user/addressBook")</span></span><br><span class="line"><span class="meta">@Api(tags = "C端地址簿接口")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddressBookController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AddressBookService addressBookService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询当前登录用户的所有地址信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping("/list")</span></span><br><span class="line">    <span class="meta">@ApiOperation("查询当前登录用户的所有地址信息")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;List&lt;AddressBook&gt;&gt; <span class="title function_">list</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">AddressBook</span> <span class="variable">addressBook</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AddressBook</span>();</span><br><span class="line">        addressBook.setUserId(BaseContext.getCurrentId());</span><br><span class="line">        List&lt;AddressBook&gt; list = addressBookService.list(addressBook);</span><br><span class="line">        <span class="keyword">return</span> Result.success(list);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增地址</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> addressBook</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="meta">@ApiOperation("新增地址")</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">save</span><span class="params">(<span class="meta">@RequestBody</span> AddressBook addressBook)</span> {</span><br><span class="line">        addressBookService.save(addressBook);</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("/{id}")</span></span><br><span class="line">    <span class="meta">@ApiOperation("根据id查询地址")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;AddressBook&gt; <span class="title function_">getById</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> {</span><br><span class="line">        <span class="type">AddressBook</span> <span class="variable">addressBook</span> <span class="operator">=</span> addressBookService.getById(id);</span><br><span class="line">        <span class="keyword">return</span> Result.success(addressBook);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id修改地址</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> addressBook</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PutMapping</span></span><br><span class="line">    <span class="meta">@ApiOperation("根据id修改地址")</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">update</span><span class="params">(<span class="meta">@RequestBody</span> AddressBook addressBook)</span> {</span><br><span class="line">        addressBookService.update(addressBook);</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置默认地址</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> addressBook</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PutMapping("/default")</span></span><br><span class="line">    <span class="meta">@ApiOperation("设置默认地址")</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">setDefault</span><span class="params">(<span class="meta">@RequestBody</span> AddressBook addressBook)</span> {</span><br><span class="line">        addressBookService.setDefault(addressBook);</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id删除地址</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@DeleteMapping</span></span><br><span class="line">    <span class="meta">@ApiOperation("根据id删除地址")</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">deleteById</span><span class="params">(Long id)</span> {</span><br><span class="line">        addressBookService.deleteById(id);</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询默认地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping("default")</span></span><br><span class="line">    <span class="meta">@ApiOperation("查询默认地址")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;AddressBook&gt; <span class="title function_">getDefault</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">//SQL:select * from address_book where user_id = ? and is_default = 1</span></span><br><span class="line">        <span class="type">AddressBook</span> <span class="variable">addressBook</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AddressBook</span>();</span><br><span class="line">        addressBook.setIsDefault(<span class="number">1</span>);</span><br><span class="line">        addressBook.setUserId(BaseContext.getCurrentId());</span><br><span class="line">        List&lt;AddressBook&gt; list = addressBookService.list(addressBook);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (list != <span class="literal">null</span> &amp;&amp; list.size() == <span class="number">1</span>) {</span><br><span class="line">            <span class="keyword">return</span> Result.success(list.get(<span class="number">0</span>));</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.error(<span class="string">"没有查询到默认地址"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="1-3-gong-neng-ce-shi">1.3 功能测试</span></h3><p>可以通过如下方式进行测试：</p>
<ul>
<li>查看控制台sql和数据库中的数据变化</li>
<li>Swagger接口文档测试</li>
<li>前后端联调</li>
</ul>
<p>我们直接使用<strong>前后端联调</strong>测试：</p>
<p>启动后台服务，编译小程序</p>
<p>登录进入首页–&gt;进入个人中心–&gt;进入地址管理</p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221214192141197.png" alt="image-20221214192141197" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221214192446868.png" alt="image-20221214192446868" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/image-20221214192610374.png" alt="image-20221214192610374" style="zoom:50%;"> </p>
<p><strong>1). 新增收货地址</strong></p>
<p><strong>添加两条收货地址：</strong></p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221214193135164.png" alt="image-20221214193135164" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/image-20221214193314440.png" alt="image-20221214193314440" style="zoom:50%;"> </p>
<p><strong>查看收货地址：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221214193437578.png" alt="image-20221214193437578" style="zoom:50%;"> 



<p><strong>查看数据库：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221214193552879.png" alt="image-20221214193552879" style="zoom:80%;"> 



<p><strong>2). 设置默认收货地址</strong></p>
<p><strong>设置默认地址：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221214193714137.png" alt="image-20221214193714137" style="zoom:50%;"> 

<p><strong>查看数据库：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221214193829043.png" alt="image-20221214193829043" style="zoom:80%;"> 



<p><strong>3). 删除收货地址</strong></p>
<p><strong>进行编辑：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221214194051783.png" alt="image-20221214194051783" style="zoom:50%;"> 

<p><strong>删除地址：</strong></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221214194126920.png" alt="image-20221214194126920" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221214194227711.png" alt="image-20221214194227711" style="zoom:50%;"></p>
<p><strong>查看数据库：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221214194251343.png" alt="image-20221214194251343" style="zoom:80%;"> 



<h3><span id="1-4-dai-ma-ti-jiao">1.4 代码提交</span></h3><img src="/2024/09/26/projection-skytogo/image-20221214204411614.png" alt="image-20221214204411614" style="zoom:50%;"> 

<p>后续步骤和其它功能代码提交一致，不再赘述。</p>
<h2><span id="2-yong-hu-xia-dan">2. 用户下单</span></h2><h3><span id="2-1-xu-qiu-fen-xi-he-she-ji">2.1 需求分析和设计</span></h3><h4><span id="2-1-1-chan-pin-yuan-xing">2.1.1 产品原型</span></h4><p><strong>用户下单业务说明：</strong><br>在电商系统中，用户是通过下单的方式通知商家，用户已经购买了商品，需要商家进行备货和发货。<br>用户下单后会产生订单相关数据，订单数据需要能够体现如下信息：</p>
<img src="/2024/09/26/projection-skytogo/image-20221214195633802.png" alt="image-20221214195633802" style="zoom:50%;"> 

<p>用户将菜品或者套餐加入购物车后，可以点击购物车中的 “去结算” 按钮，页面跳转到订单确认页面，点击 “去支付” 按钮则完成下单操作。</p>
<p><strong>用户点餐业务流程(效果图)：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221214195913467.png" alt="image-20221214195913467" style="zoom:80%;"> 





<h4><span id="2-1-2-jie-kou-she-ji">2.1.2 接口设计</span></h4><p><strong>接口分析：</strong></p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221214200913654.png" alt="image-20221214200913654" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/image-20221214200959943.png" alt="image-20221214200959943" style="zoom:50%;"> </p>
<p><strong>接口设计：</strong></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221214201211364.png" alt="image-20221214201211364" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221214201220993.png" alt="image-20221214201220993" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221214201236107.png" alt="image-20221214201236107" style="zoom:50%;"> </p>
<h4><span id="2-1-3-biao-she-ji">2.1.3 表设计</span></h4><p>用户下单业务对应的数据表为orders表和order_detail表(一对多关系,一个订单关联多个订单明细)：</p>
<table>
<thead>
<tr>
<th>表名</th>
<th>含义</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>orders</td>
<td>订单表</td>
<td>主要存储订单的基本信息(如: 订单号、状态、金额、支付方式、下单用户、收件地址等)</td>
</tr>
<tr>
<td>order_detail</td>
<td>订单明细表</td>
<td>主要存储订单详情信息(如: 该订单关联的套餐及菜品的信息)</td>
</tr>
</tbody></table>
<p>具体的表结构如下: </p>
<p><strong>1). orders订单表</strong></p>
<table>
<thead>
<tr>
<th><strong>字段名</strong></th>
<th><strong>数据类型</strong></th>
<th><strong>说明</strong></th>
<th><strong>备注</strong></th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>bigint</td>
<td>主键</td>
<td>自增</td>
</tr>
<tr>
<td>number</td>
<td>varchar(50)</td>
<td>订单号</td>
<td></td>
</tr>
<tr>
<td>status</td>
<td>int</td>
<td>订单状态</td>
<td>1待付款 2待接单 3已接单 4派送中 5已完成 6已取消</td>
</tr>
<tr>
<td>user_id</td>
<td>bigint</td>
<td>用户id</td>
<td>逻辑外键</td>
</tr>
<tr>
<td>address_book_id</td>
<td>bigint</td>
<td>地址id</td>
<td>逻辑外键</td>
</tr>
<tr>
<td>order_time</td>
<td>datetime</td>
<td>下单时间</td>
<td></td>
</tr>
<tr>
<td>checkout_time</td>
<td>datetime</td>
<td>付款时间</td>
<td></td>
</tr>
<tr>
<td>pay_method</td>
<td>int</td>
<td>支付方式</td>
<td>1微信支付 2支付宝支付</td>
</tr>
<tr>
<td>pay_status</td>
<td>tinyint</td>
<td>支付状态</td>
<td>0未支付 1已支付 2退款</td>
</tr>
<tr>
<td>amount</td>
<td>decimal(10,2)</td>
<td>订单金额</td>
<td></td>
</tr>
<tr>
<td>remark</td>
<td>varchar(100)</td>
<td>备注信息</td>
<td></td>
</tr>
<tr>
<td>phone</td>
<td>varchar(11)</td>
<td>手机号</td>
<td>冗余字段</td>
</tr>
<tr>
<td>address</td>
<td>varchar(255)</td>
<td>详细地址信息</td>
<td>冗余字段</td>
</tr>
<tr>
<td>consignee</td>
<td>varchar(32)</td>
<td>收货人</td>
<td>冗余字段</td>
</tr>
<tr>
<td>cancel_reason</td>
<td>varchar(255)</td>
<td>订单取消原因</td>
<td></td>
</tr>
<tr>
<td>rejection_reason</td>
<td>varchar(255)</td>
<td>拒单原因</td>
<td></td>
</tr>
<tr>
<td>cancel_time</td>
<td>datetime</td>
<td>订单取消时间</td>
<td></td>
</tr>
<tr>
<td>estimated_delivery_time</td>
<td>datetime</td>
<td>预计送达时间</td>
<td></td>
</tr>
<tr>
<td>delivery_status</td>
<td>tinyint</td>
<td>配送状态</td>
<td>1立即送出 0选择具体时间</td>
</tr>
<tr>
<td>delivery_time</td>
<td>datetime</td>
<td>送达时间</td>
<td></td>
</tr>
<tr>
<td>pack_amount</td>
<td>int</td>
<td>打包费</td>
<td></td>
</tr>
<tr>
<td>tableware_number</td>
<td>int</td>
<td>餐具数量</td>
<td></td>
</tr>
<tr>
<td>tableware_status</td>
<td>tinyint</td>
<td>餐具数量状态</td>
<td>1按餐量提供 0选择具体数量</td>
</tr>
</tbody></table>
<p><strong>2). order_detail订单明细表</strong></p>
<table>
<thead>
<tr>
<th><strong>字段名</strong></th>
<th><strong>数据类型</strong></th>
<th><strong>说明</strong></th>
<th><strong>备注</strong></th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>bigint</td>
<td>主键</td>
<td>自增</td>
</tr>
<tr>
<td>name</td>
<td>varchar(32)</td>
<td>商品名称</td>
<td>冗余字段</td>
</tr>
<tr>
<td>image</td>
<td>varchar(255)</td>
<td>商品图片路径</td>
<td>冗余字段</td>
</tr>
<tr>
<td>order_id</td>
<td>bigint</td>
<td>订单id</td>
<td>逻辑外键</td>
</tr>
<tr>
<td>dish_id</td>
<td>bigint</td>
<td>菜品id</td>
<td>逻辑外键</td>
</tr>
<tr>
<td>setmeal_id</td>
<td>bigint</td>
<td>套餐id</td>
<td>逻辑外键</td>
</tr>
<tr>
<td>dish_flavor</td>
<td>varchar(50)</td>
<td>菜品口味</td>
<td></td>
</tr>
<tr>
<td>number</td>
<td>int</td>
<td>商品数量</td>
<td></td>
</tr>
<tr>
<td>amount</td>
<td>decimal(10,2)</td>
<td>商品单价</td>
<td></td>
</tr>
</tbody></table>
<p><strong>说明：</strong>用户提交订单时，需要往订单表orders中插入一条记录，并且需要往order_detail中插入一条或多条记录。</p>
<h3><span id="2-2-dai-ma-kai-fa">2.2 代码开发</span></h3><h4><span id="2-2-1-dto-she-ji">2.2.1 DTO设计</span></h4><p><strong>根据用户下单接口的参数设计DTO：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221214203913803.png" alt="image-20221214203913803" style="zoom:50%;"> 

<p>在sky-pojo模块，OrdersSubmitDTO.java已定义</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonFormat;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrdersSubmitDTO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line">    <span class="comment">//地址簿id</span></span><br><span class="line">    <span class="keyword">private</span> Long addressBookId;</span><br><span class="line">    <span class="comment">//付款方式</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> payMethod;</span><br><span class="line">    <span class="comment">//备注</span></span><br><span class="line">    <span class="keyword">private</span> String remark;</span><br><span class="line">    <span class="comment">//预计送达时间</span></span><br><span class="line">    <span class="meta">@JsonFormat(shape = JsonFormat.Shape.STRING, pattern = "yyyy-MM-dd HH:mm:ss")</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime estimatedDeliveryTime;</span><br><span class="line">    <span class="comment">//配送状态  1立即送出  0选择具体时间</span></span><br><span class="line">    <span class="keyword">private</span> Integer deliveryStatus;</span><br><span class="line">    <span class="comment">//餐具数量</span></span><br><span class="line">    <span class="keyword">private</span> Integer tablewareNumber;</span><br><span class="line">    <span class="comment">//餐具数量状态  1按餐量提供  0选择具体数量</span></span><br><span class="line">    <span class="keyword">private</span> Integer tablewareStatus;</span><br><span class="line">    <span class="comment">//打包费</span></span><br><span class="line">    <span class="keyword">private</span> Integer packAmount;</span><br><span class="line">    <span class="comment">//总金额</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal amount;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-2-2-vo-she-ji">2.2.2 VO设计</span></h4><p><strong>根据用户下单接口的返回结果设计VO：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221214204113316.png" alt="image-20221214204113316" style="zoom:50%;"> 

<p>在sky-pojo模块，OrderSubmitVO.java已定义</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderSubmitVO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line">    <span class="comment">//订单id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="comment">//订单号</span></span><br><span class="line">    <span class="keyword">private</span> String orderNumber;</span><br><span class="line">    <span class="comment">//订单金额</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal orderAmount;</span><br><span class="line">    <span class="comment">//下单时间</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime orderTime;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-2-3-controller-ceng">2.2.3 Controller层</span></h4><p><strong>创建OrderController并提供用户下单方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.dto.OrdersPaymentDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.dto.OrdersSubmitDTO;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.OrderPaymentVO;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.OrderSubmitVO;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.OrderVO;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 订单</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController("userOrderController")</span></span><br><span class="line"><span class="meta">@RequestMapping("/user/order")</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = "C端-订单接口")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户下单</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ordersSubmitDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping("/submit")</span></span><br><span class="line">    <span class="meta">@ApiOperation("用户下单")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;OrderSubmitVO&gt; <span class="title function_">submit</span><span class="params">(<span class="meta">@RequestBody</span> OrdersSubmitDTO ordersSubmitDTO)</span> {</span><br><span class="line">        log.info(<span class="string">"用户下单：{}"</span>, ordersSubmitDTO);</span><br><span class="line">        <span class="type">OrderSubmitVO</span> <span class="variable">orderSubmitVO</span> <span class="operator">=</span> orderService.submitOrder(ordersSubmitDTO);</span><br><span class="line">        <span class="keyword">return</span> Result.success(orderSubmitVO);</span><br><span class="line">    } </span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-2-4-service-ceng-jie-kou">2.2.4 Service层接口</span></h4><p><strong>创建OrderService接口，并声明用户下单方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.dto.*;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.OrderSubmitVO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户下单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ordersSubmitDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    OrderSubmitVO <span class="title function_">submitOrder</span><span class="params">(OrdersSubmitDTO ordersSubmitDTO)</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-2-5-service-ceng-shi-xian-lei">2.2.5 Service层实现类</span></h4><p><strong>创建OrderServiceImpl实现OrderService接口：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 订单</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> {</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderMapper orderMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderDetailMapper orderDetailMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ShoppingCartMapper shoppingCartMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AddressBookMapper addressBookMapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户下单</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ordersSubmitDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> OrderSubmitVO <span class="title function_">submitOrder</span><span class="params">(OrdersSubmitDTO ordersSubmitDTO)</span> {</span><br><span class="line">        <span class="comment">//异常情况的处理（收货地址为空、超出配送范围、购物车为空）</span></span><br><span class="line">        <span class="type">AddressBook</span> <span class="variable">addressBook</span> <span class="operator">=</span> addressBookMapper.getById(ordersSubmitDTO.getAddressBookId());</span><br><span class="line">        <span class="keyword">if</span> (addressBook == <span class="literal">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AddressBookBusinessException</span>(MessageConstant.ADDRESS_BOOK_IS_NULL);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> BaseContext.getCurrentId();</span><br><span class="line">        <span class="type">ShoppingCart</span> <span class="variable">shoppingCart</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShoppingCart</span>();</span><br><span class="line">        shoppingCart.setUserId(userId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询当前用户的购物车数据</span></span><br><span class="line">        List&lt;ShoppingCart&gt; shoppingCartList = shoppingCartMapper.list(shoppingCart);</span><br><span class="line">        <span class="keyword">if</span> (shoppingCartList == <span class="literal">null</span> || shoppingCartList.size() == <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ShoppingCartBusinessException</span>(MessageConstant.SHOPPING_CART_IS_NULL);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//构造订单数据</span></span><br><span class="line">        <span class="type">Orders</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Orders</span>();</span><br><span class="line">        BeanUtils.copyProperties(ordersSubmitDTO,order);</span><br><span class="line">        order.setPhone(addressBook.getPhone());</span><br><span class="line">        order.setAddress(addressBook.getDetail());</span><br><span class="line">        order.setConsignee(addressBook.getConsignee());</span><br><span class="line">        order.setNumber(String.valueOf(System.currentTimeMillis()));</span><br><span class="line">        order.setUserId(userId);</span><br><span class="line">        order.setStatus(Orders.PENDING_PAYMENT);</span><br><span class="line">        order.setPayStatus(Orders.UN_PAID);</span><br><span class="line">        order.setOrderTime(LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//向订单表插入1条数据</span></span><br><span class="line">        orderMapper.insert(order);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//订单明细数据</span></span><br><span class="line">        List&lt;OrderDetail&gt; orderDetailList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (ShoppingCart cart : shoppingCartList) {</span><br><span class="line">            <span class="type">OrderDetail</span> <span class="variable">orderDetail</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderDetail</span>();</span><br><span class="line">            BeanUtils.copyProperties(cart, orderDetail);</span><br><span class="line">            orderDetail.setOrderId(order.getId());</span><br><span class="line">            orderDetailList.add(orderDetail);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//向明细表插入n条数据</span></span><br><span class="line">        orderDetailMapper.insertBatch(orderDetailList);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//清理购物车中的数据</span></span><br><span class="line">        shoppingCartMapper.deleteByUserId(userId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//封装返回结果</span></span><br><span class="line">        <span class="type">OrderSubmitVO</span> <span class="variable">orderSubmitVO</span> <span class="operator">=</span> OrderSubmitVO.builder()</span><br><span class="line">                .id(order.getId())</span><br><span class="line">                .orderNumber(order.getNumber())</span><br><span class="line">                .orderAmount(order.getAmount())</span><br><span class="line">                .orderTime(order.getOrderTime())</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> orderSubmitVO;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-2-6-mapper-ceng">2.2.6 Mapper层</span></h4><p><strong>创建OrderMapper接口和对应的xml映射文件：</strong></p>
<p>OrderMapper.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderMapper</span> {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插入订单数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> order</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(Orders order)</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>OrderMapper.xml</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.sky.mapper.OrderMapper"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insert"</span> <span class="attr">parameterType</span>=<span class="string">"Orders"</span> <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span>&gt;</span></span><br><span class="line">        insert into orders</span><br><span class="line">        (number, status, user_id, address_book_id, order_time, checkout_time, pay_method, pay_status, amount, remark,</span><br><span class="line">         phone, address, consignee, estimated_delivery_time, delivery_status, pack_amount, tableware_number,</span><br><span class="line">         tableware_status)</span><br><span class="line">        values (#{number}, #{status}, #{userId}, #{addressBookId}, #{orderTime}, #{checkoutTime}, #{payMethod},</span><br><span class="line">                #{payStatus}, #{amount}, #{remark}, #{phone}, #{address}, #{consignee},</span><br><span class="line">                #{estimatedDeliveryTime}, #{deliveryStatus}, #{packAmount}, #{tablewareNumber}, #{tablewareStatus})</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p><strong>创建OrderDetailMapper接口和对应的xml映射文件：</strong></p>
<p>OrderDetailMapper.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.entity.OrderDetail;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderDetailMapper</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量插入订单明细数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderDetails</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insertBatch</span><span class="params">(List&lt;OrderDetail&gt; orderDetails)</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>OrderDetailMapper.xml</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.sky.mapper.OrderDetailMapper"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertBatch"</span> <span class="attr">parameterType</span>=<span class="string">"list"</span>&gt;</span></span><br><span class="line">        insert into order_detail</span><br><span class="line">        (name, order_id, dish_id, setmeal_id, dish_flavor, number, amount, image)</span><br><span class="line">        values</span><br><span class="line">        <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">"orderDetails"</span> <span class="attr">item</span>=<span class="string">"od"</span> <span class="attr">separator</span>=<span class="string">","</span>&gt;</span></span><br><span class="line">            (#{od.name},#{od.orderId},#{od.dishId},#{od.setmealId},#{od.dishFlavor},</span><br><span class="line">             #{od.number},#{od.amount},#{od.image})</span><br><span class="line">        <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-3-gong-neng-ce-shi">2.3 功能测试</span></h3><p>登录小程序，完成下单操作</p>
<p>下单操作时，同时会删除购物车中的数据</p>
<img src="/2024/09/26/projection-skytogo/image-20221214214128415.png" alt="image-20221214214128415" style="zoom:50%;"> 

<p><strong>查看shopping_cart表：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221214214642428.png" alt="image-20221214214642428" style="zoom: 80%;"> 

<p><strong>去结算–&gt;去支付</strong></p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221214214808218.png" alt="image-20221214214808218" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/image-20221214214852362.png" alt="image-20221214214852362" style="zoom:50%;"> </p>
<p><strong>查看orders表：</strong></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221214215116451.png" alt="image-20221214215116451"></p>
<p><strong>查看order_detail表：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221214215250553.png" alt="image-20221214215250553" style="zoom:80%;"> 

<p><strong>同时，购物车表中数据删除：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221214215428516.png" alt="image-20221214215428516" style="zoom:80%;"> 



<h3><span id="2-4-dai-ma-ti-jiao">2.4 代码提交</span></h3><img src="/2024/09/26/projection-skytogo/image-20221214215650664.png" alt="image-20221214215650664" style="zoom:50%;"> 

<p>后续步骤和其它功能代码提交一致，不再赘述。</p>
<h2><span id="3-ding-dan-zhi-fu">3. 订单支付</span></h2><h3><span id="3-1-wei-xin-zhi-fu-jie-shao">3.1 微信支付介绍</span></h3><p>前面的课程已经实现了用户下单，那接下来就是订单支付，就是完成付款功能。支付大家应该都不陌生了，在现实生活中经常购买商品并且使用支付功能来付款，在付款的时候可能使用比较多的就是微信支付和支付宝支付了。在苍穹外卖项目中，选择的就是<strong>微信支付</strong>这种支付方式。</p>
<p>要实现微信支付就需要注册微信支付的一个商户号，这个商户号是必须要有一家企业并且有正规的营业执照。只有具备了这些资质之后，才可以去注册商户号，才能开通支付权限。</p>
<p>个人不具备这种资质，所以我们在学习微信支付时，最重要的是了解微信支付的流程，并且能够阅读微信官方提供的接口文档，能够和第三方支付平台对接起来就可以了。</p>
<p><strong>微信支付产品：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221214223302651.png" alt="image-20221214223302651" style="zoom:50%;"> 

<p>本项目选择<strong>小程序支付</strong></p>
<p>参考：<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/static/product/product_index.shtml">https://pay.weixin.qq.com/static/product/product_index.shtml</a></p>
<p><strong>微信支付接入流程：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221214223509246.png" alt="image-20221214223509246" style="zoom:50%;"> 



<p><strong>微信小程序支付时序图：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221214223910840.png" alt="image-20221214223910840" style="zoom:50%;"> 



<p><strong>微信支付相关接口：</strong></p>
<p><strong>JSAPI下单：</strong>商户系统调用该接口在微信支付服务后台生成预支付交易单(对应时序图的第5步)</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221214224409174.png" alt="image-20221214224409174"></p>
<p><strong>微信小程序调起支付：</strong>通过JSAPI下单接口获取到发起支付的必要参数prepay_id，然后使用微信支付提供的小程序方法调起小程序支付(对应时序图的第10步)</p>
<img src="/2024/09/26/projection-skytogo/image-20221214224551220.png" alt="image-20221214224551220" style="zoom:50%;"> 



<h3><span id="3-2-wei-xin-zhi-fu-zhun-bei-gong-zuo">3.2 微信支付准备工作</span></h3><h4><span id="3-2-1-ru-he-bao-zheng-shu-ju-an-quan">3.2.1 如何保证数据安全？</span></h4><p>完成微信支付有两个关键的步骤：</p>
<p><strong>第一个</strong>就是需要在商户系统当中调用微信后台的一个下单接口，就是生成预支付交易单。</p>
<p><strong>第二个</strong>就是支付成功之后微信后台会给推送消息。</p>
<p>这两个接口数据的安全性，要求其实是非常高的。</p>
<p><strong>解决：</strong>微信提供的方式就是对数据进行加密、解密、签名多种方式。要完成数据加密解密，需要提前准备相应的一些文件，其实就是一些证书。</p>
<p><strong>获取微信支付平台证书、商户私钥文件：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221214234038395.png" alt="image-20221214234038395" style="zoom:50%;"> 

<p>在后绪程序开发过程中，就会使用到这两个文件，需要提前把这两个文件准备好。</p>
<h4><span id="3-2-2-ru-he-diao-yong-dao-shang-hu-xi-tong">3.2.2 如何调用到商户系统？</span></h4><p>微信后台会调用到商户系统给推送支付的结果，在这里我们就会遇到一个问题，就是微信后台怎么就能调用到我们这个商户系统呢？因为这个调用过程，其实本质上也是一个HTTP请求。</p>
<p>目前，商户系统它的ip地址就是当前自己电脑的ip地址，只是一个局域网内的ip地址，微信后台无法调用到。</p>
<p><strong>解决：</strong>内网穿透。通过<strong>cpolar软件</strong>可以获得一个临时域名，而这个临时域名是一个公网ip，这样，微信后台就可以请求到商户系统了。</p>
<p><strong>cpolar软件的使用：</strong></p>
<p><strong>1). 下载与安装</strong></p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://dashboard.cpolar.com/get-started">https://dashboard.cpolar.com/get-started</a></p>
<img src="/2024/09/26/projection-skytogo/image-20221215184407217.png" alt="image-20221215184407217" style="zoom:50%;"> 

<p>在资料中已提供，可无需下载。</p>
<img src="/2024/09/26/projection-skytogo/image-20221215184446260.png" alt="image-20221215184446260" style="zoom:80%;"> 

<p>安装过程中，一直下一步即可，不再演示。</p>
<p><strong>2). cpolar指定authtoken</strong></p>
<p>复制authtoken：</p>
<img src="/2024/09/26/projection-skytogo/image-20221215184746092.png" alt="image-20221215184746092" style="zoom:50%;"> 

<p>执行命令：</p>
<img src="/2024/09/26/projection-skytogo/image-20221215185152869.png" alt="image-20221215185152869" style="zoom:50%;"> 



<p><strong>3). 获取临时域名</strong></p>
<p>执行命令：</p>
<img src="/2024/09/26/projection-skytogo/image-20221215185749163.png" alt="image-20221215185749163" style="zoom:50%;"> 

<p>获取域名：</p>
<img src="/2024/09/26/projection-skytogo/image-20221215185833157.png" alt="image-20221215185833157" style="zoom:50%;"> 



<p><strong>4). 验证临时域名有效性</strong></p>
<p><strong>访问接口文档</strong></p>
<p>使用localhost:8080访问</p>
<img src="/2024/09/26/projection-skytogo/image-20221215190440717.png" alt="image-20221215190440717" style="zoom:50%;"> 

<p>使用临时域名访问</p>
<img src="/2024/09/26/projection-skytogo/image-20221215190525166.png" alt="image-20221215190525166" style="zoom:50%;"> 

<p>证明临时域名生效。</p>
<h3><span id="3-3-dai-ma-dao-ru">3.3 代码导入</span></h3><p>导入资料中的微信支付功能代码即可</p>
<img src="/2024/09/26/projection-skytogo/image-20221215192120424.png" alt="image-20221215192120424" style="zoom:50%;"> 

<h4><span id="3-3-1-wei-xin-zhi-fu-xiang-guan-pei-zhi">3.3.1 微信支付相关配置</span></h4><p>application-dev.yml</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sky:</span></span><br><span class="line">  <span class="attr">wechat:</span></span><br><span class="line">    <span class="attr">appid:</span> <span class="string">wxcd2e39f677fd30ba</span></span><br><span class="line">    <span class="attr">secret:</span> <span class="string">84fbfdf5ea288f0c432d829599083637</span></span><br><span class="line">    <span class="attr">mchid :</span> <span class="number">1561414331</span></span><br><span class="line">    <span class="attr">mchSerialNo:</span> <span class="string">4B3B3DC35414AD50B1B755BAF8DE9CC7CF407606</span></span><br><span class="line">    <span class="attr">privateKeyFilePath:</span> <span class="string">D:\apiclient_key.pem</span></span><br><span class="line">    <span class="attr">apiV3Key:</span> <span class="string">CZBK51236435wxpay435434323FFDuv3</span></span><br><span class="line">    <span class="attr">weChatPayCertFilePath:</span> <span class="string">D:\wechatpay_166D96F876F45C7D07CE98952A96EC980368ACFC.pem</span></span><br><span class="line">    <span class="attr">notifyUrl:</span> <span class="string">https://www.weixin.qq.com/wxpay/pay.php</span></span><br><span class="line">    <span class="attr">refundNotifyUrl:</span> <span class="string">https://www.weixin.qq.com/wxpay/pay.php</span></span><br></pre></td></tr></tbody></table></figure>

<p>application.yml</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sky:</span></span><br><span class="line">  <span class="attr">wechat:</span></span><br><span class="line">    <span class="attr">appid:</span> <span class="string">${sky.wechat.appid}</span></span><br><span class="line">    <span class="attr">secret:</span> <span class="string">${sky.wechat.secret}</span></span><br><span class="line">    <span class="attr">mchid :</span> <span class="string">${sky.wechat.mchid}</span></span><br><span class="line">    <span class="attr">mchSerialNo:</span> <span class="string">${sky.wechat.mchSerialNo}</span></span><br><span class="line">    <span class="attr">privateKeyFilePath:</span> <span class="string">${sky.wechat.privateKeyFilePath}</span></span><br><span class="line">    <span class="attr">apiV3Key:</span> <span class="string">${sky.wechat.apiV3Key}</span></span><br><span class="line">    <span class="attr">weChatPayCertFilePath:</span> <span class="string">${sky.wechat.weChatPayCertFilePath}</span></span><br><span class="line">    <span class="attr">notifyUrl:</span> <span class="string">${sky.wechat.notifyUrl}</span></span><br><span class="line">    <span class="attr">refundNotifyUrl:</span> <span class="string">${sky.wechat.refundNotifyUrl}</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>WeChatProperties.java：读取配置(已定义)</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = "sky.wechat")</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeChatProperties</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String appid; <span class="comment">//小程序的appid</span></span><br><span class="line">    <span class="keyword">private</span> String secret; <span class="comment">//小程序的秘钥</span></span><br><span class="line">    <span class="keyword">private</span> String mchid; <span class="comment">//商户号</span></span><br><span class="line">    <span class="keyword">private</span> String mchSerialNo; <span class="comment">//商户API证书的证书序列号</span></span><br><span class="line">    <span class="keyword">private</span> String privateKeyFilePath; <span class="comment">//商户私钥文件</span></span><br><span class="line">    <span class="keyword">private</span> String apiV3Key; <span class="comment">//证书解密的密钥</span></span><br><span class="line">    <span class="keyword">private</span> String weChatPayCertFilePath; <span class="comment">//平台证书</span></span><br><span class="line">    <span class="keyword">private</span> String notifyUrl; <span class="comment">//支付成功的回调地址</span></span><br><span class="line">    <span class="keyword">private</span> String refundNotifyUrl; <span class="comment">//退款成功的回调地址</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-3-2-mapper-ceng">3.3.2 Mapper层</span></h4><p><strong>在OrderMapper.java中添加getByNumberAndUserId和update两个方法</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据订单号和用户id查询订单</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> orderNumber</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Select("select * from orders where number = #{orderNumber} and user_id= #{userId}")</span></span><br><span class="line">   Orders <span class="title function_">getByNumberAndUserId</span><span class="params">(String orderNumber, Long userId)</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 修改订单信息</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> orders</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Orders orders)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>在OrderMapper.xml中添加</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"update"</span> <span class="attr">parameterType</span>=<span class="string">"com.sky.entity.Orders"</span>&gt;</span></span><br><span class="line">        update orders</span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"cancelReason != null and cancelReason!='' "</span>&gt;</span></span><br><span class="line">                cancel_reason=#{cancelReason},</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"rejectionReason != null and rejectionReason!='' "</span>&gt;</span></span><br><span class="line">                rejection_reason=#{rejectionReason},</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"cancelTime != null"</span>&gt;</span></span><br><span class="line">                cancel_time=#{cancelTime},</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"payStatus != null"</span>&gt;</span></span><br><span class="line">                pay_status=#{payStatus},</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"payMethod != null"</span>&gt;</span></span><br><span class="line">                pay_method=#{payMethod},</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"checkoutTime != null"</span>&gt;</span></span><br><span class="line">                checkout_time=#{checkoutTime},</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"status != null"</span>&gt;</span></span><br><span class="line">                status = #{status},</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"deliveryTime != null"</span>&gt;</span></span><br><span class="line">                delivery_time = #{deliveryTime}</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        where id = #{id}</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-3-3-service-ceng">3.3.3 Service层</span></h4><p><strong>在OrderService.java中添加payment和paySuccess两个方法定义</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 订单支付</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ordersPaymentDTO</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   OrderPaymentVO <span class="title function_">payment</span><span class="params">(OrdersPaymentDTO ordersPaymentDTO)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 支付成功，修改订单状态</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> outTradeNo</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">paySuccess</span><span class="params">(String outTradeNo)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>在OrderServiceImpl.java中实现payment和paySuccess两个方法</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> WeChatPayUtil weChatPayUtil;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 订单支付</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ordersPaymentDTO</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> OrderPaymentVO <span class="title function_">payment</span><span class="params">(OrdersPaymentDTO ordersPaymentDTO)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">       <span class="comment">// 当前登录用户id</span></span><br><span class="line">       <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> BaseContext.getCurrentId();</span><br><span class="line">       <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.getById(userId);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//调用微信支付接口，生成预支付交易单</span></span><br><span class="line">       <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> weChatPayUtil.pay(</span><br><span class="line">               ordersPaymentDTO.getOrderNumber(), <span class="comment">//商户订单号</span></span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0.01</span>), <span class="comment">//支付金额，单位 元</span></span><br><span class="line">               <span class="string">"苍穹外卖订单"</span>, <span class="comment">//商品描述</span></span><br><span class="line">               user.getOpenid() <span class="comment">//微信用户的openid</span></span><br><span class="line">       );</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (jsonObject.getString(<span class="string">"code"</span>) != <span class="literal">null</span> &amp;&amp; jsonObject.getString(<span class="string">"code"</span>).equals(<span class="string">"ORDERPAID"</span>)) {</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(<span class="string">"该订单已支付"</span>);</span><br><span class="line">       }</span><br><span class="line"></span><br><span class="line">       <span class="type">OrderPaymentVO</span> <span class="variable">vo</span> <span class="operator">=</span> jsonObject.toJavaObject(OrderPaymentVO.class);</span><br><span class="line">       vo.setPackageStr(jsonObject.getString(<span class="string">"package"</span>));</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> vo;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 支付成功，修改订单状态</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> outTradeNo</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">paySuccess</span><span class="params">(String outTradeNo)</span> {</span><br><span class="line">       <span class="comment">// 当前登录用户id</span></span><br><span class="line">       <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> BaseContext.getCurrentId();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 根据订单号查询当前用户的订单</span></span><br><span class="line">       <span class="type">Orders</span> <span class="variable">ordersDB</span> <span class="operator">=</span> orderMapper.getByNumberAndUserId(outTradeNo, userId);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 根据订单id更新订单的状态、支付方式、支付状态、结账时间</span></span><br><span class="line">       <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> Orders.builder()</span><br><span class="line">               .id(ordersDB.getId())</span><br><span class="line">               .status(Orders.TO_BE_CONFIRMED)</span><br><span class="line">               .payStatus(Orders.PAID)</span><br><span class="line">               .checkoutTime(LocalDateTime.now())</span><br><span class="line">               .build();</span><br><span class="line"></span><br><span class="line">       orderMapper.update(orders);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-3-4-controller-ceng">3.3.4 Controller层</span></h4><p><strong>在OrderController.java中添加payment方法</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 订单支付</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> ordersPaymentDTO</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@PutMapping("/payment")</span></span><br><span class="line">  <span class="meta">@ApiOperation("订单支付")</span></span><br><span class="line">  <span class="keyword">public</span> Result&lt;OrderPaymentVO&gt; <span class="title function_">payment</span><span class="params">(<span class="meta">@RequestBody</span> OrdersPaymentDTO ordersPaymentDTO)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">      log.info(<span class="string">"订单支付：{}"</span>, ordersPaymentDTO);</span><br><span class="line">      <span class="type">OrderPaymentVO</span> <span class="variable">orderPaymentVO</span> <span class="operator">=</span> orderService.payment(ordersPaymentDTO);</span><br><span class="line">      log.info(<span class="string">"生成预支付交易单：{}"</span>, orderPaymentVO);</span><br><span class="line">      <span class="keyword">return</span> Result.success(orderPaymentVO);</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure>

<p>PayNotifyController.java</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.notify;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.druid.support.json.JSONUtils;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.sky.annotation.IgnoreToken;</span><br><span class="line"><span class="keyword">import</span> com.sky.properties.WeChatProperties;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> com.wechat.pay.contrib.apache.httpclient.util.AesUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.entity.ContentType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 支付回调相关接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/notify")</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PayNotifyController</span> {</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WeChatProperties weChatProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 支付成功回调</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping("/paySuccess")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">paySuccessNotify</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="comment">//读取数据</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> readData(request);</span><br><span class="line">        log.info(<span class="string">"支付成功回调：{}"</span>, body);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//数据解密</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">plainText</span> <span class="operator">=</span> decryptData(body);</span><br><span class="line">        log.info(<span class="string">"解密后的文本：{}"</span>, plainText);</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSON.parseObject(plainText);</span><br><span class="line">        <span class="type">String</span> <span class="variable">outTradeNo</span> <span class="operator">=</span> jsonObject.getString(<span class="string">"out_trade_no"</span>);<span class="comment">//商户平台订单号</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">transactionId</span> <span class="operator">=</span> jsonObject.getString(<span class="string">"transaction_id"</span>);<span class="comment">//微信支付交易号</span></span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"商户平台订单号：{}"</span>, outTradeNo);</span><br><span class="line">        log.info(<span class="string">"微信支付交易号：{}"</span>, transactionId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//业务处理，修改订单状态、来单提醒</span></span><br><span class="line">        orderService.paySuccess(outTradeNo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//给微信响应</span></span><br><span class="line">        responseToWeixin(response);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">readData</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> request.getReader();</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) {</span><br><span class="line">            <span class="keyword">if</span> (result.length() &gt; <span class="number">0</span>) {</span><br><span class="line">                result.append(<span class="string">"\n"</span>);</span><br><span class="line">            }</span><br><span class="line">            result.append(line);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> result.toString();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据解密</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> body</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">decryptData</span><span class="params">(String body)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">resultObject</span> <span class="operator">=</span> JSON.parseObject(body);</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">resource</span> <span class="operator">=</span> resultObject.getJSONObject(<span class="string">"resource"</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">ciphertext</span> <span class="operator">=</span> resource.getString(<span class="string">"ciphertext"</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">nonce</span> <span class="operator">=</span> resource.getString(<span class="string">"nonce"</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">associatedData</span> <span class="operator">=</span> resource.getString(<span class="string">"associated_data"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">AesUtil</span> <span class="variable">aesUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AesUtil</span>(weChatProperties.getApiV3Key().getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        <span class="comment">//密文解密</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">plainText</span> <span class="operator">=</span> aesUtil.decryptToString(associatedData.getBytes(StandardCharsets.UTF_8),</span><br><span class="line">                nonce.getBytes(StandardCharsets.UTF_8),</span><br><span class="line">                ciphertext);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> plainText;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 给微信响应</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">responseToWeixin</span><span class="params">(HttpServletResponse response)</span> <span class="keyword">throws</span> Exception{</span><br><span class="line">        response.setStatus(<span class="number">200</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"code"</span>, <span class="string">"SUCCESS"</span>);</span><br><span class="line">        map.put(<span class="string">"message"</span>, <span class="string">"SUCCESS"</span>);</span><br><span class="line">        response.setHeader(<span class="string">"Content-type"</span>, ContentType.APPLICATION_JSON.toString());</span><br><span class="line">        response.getOutputStream().write(JSONUtils.toJSONString(map).getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        response.flushBuffer();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-4-gong-neng-ce-shi">3.4 功能测试</span></h3><p>测试过程中，可通过断点方式查看后台每一步执行情况。</p>
<p><strong>下单：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221215205122716.png" alt="image-20221215205122716" style="zoom: 80%;"> 

<p><strong>去支付：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221215205308701.png" alt="image-20221215205308701" style="zoom:80%;"> 

<p><strong>确认支付：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221215205434552.png" alt="image-20221215205434552" style="zoom:80%;"> 

<p>进行扫码支付即可。</p>
<h3><span id="3-5-dai-ma-ti-jiao">3.5 代码提交</span></h3><img src="/2024/09/26/projection-skytogo/image-20221215205746248.png" alt="image-20221215205746248" style="zoom:50%;"> 

<p> 后续步骤和其它功能代码提交一致，不再赘述。</p>
<h1><span id="cang-qiong-wai-mai-day09">苍穹外卖-day09</span></h1><h2><span id="yong-hu-duan-li-shi-ding-dan-mo-kuai">用户端历史订单模块</span></h2><h2><span id="1-cha-xun-li-shi-ding-dan">1. 查询历史订单</span></h2><h3><span id="1-1-xu-qiu-fen-xi-he-she-ji">1.1 需求分析和设计</span></h3><p>产品原型：</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221128092537535.png" alt="image-20221128092537535"></p>
<p>业务规则</p>
<ul>
<li>分页查询历史订单</li>
<li>可以根据订单状态查询</li>
<li>展示订单数据时，需要展示的数据包括：下单时间、订单状态、订单金额、订单明细（商品名称、图片）</li>
</ul>
<p>接口设计：参见接口文档</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221128103222657.png" alt="image-20221128103222657"></p>
<h3><span id="1-2-dai-ma-shi-xian">1.2 代码实现</span></h3><h4><span id="1-2-1-user-ordercontroller">1.2.1 user/OrderController</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 历史订单查询</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> page</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pageSize</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> status   订单状态 1待付款 2待接单 3已接单 4派送中 5已完成 6已取消</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/historyOrders")</span></span><br><span class="line"><span class="meta">@ApiOperation("历史订单查询")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;PageResult&gt; <span class="title function_">page</span><span class="params">(<span class="type">int</span> page, <span class="type">int</span> pageSize, Integer status)</span> {</span><br><span class="line">    <span class="type">PageResult</span> <span class="variable">pageResult</span> <span class="operator">=</span> orderService.pageQuery4User(page, pageSize, status);</span><br><span class="line">    <span class="keyword">return</span> Result.success(pageResult);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-2-orderservice">1.2.2 OrderService</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户端订单分页查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> page</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pageSize</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PageResult <span class="title function_">pageQuery4User</span><span class="params">(<span class="type">int</span> page, <span class="type">int</span> pageSize, Integer status)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-3-orderserviceimpl">1.2.3 OrderServiceImpl</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户端订单分页查询</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pageNum</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pageSize</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> PageResult <span class="title function_">pageQuery4User</span><span class="params">(<span class="type">int</span> pageNum, <span class="type">int</span> pageSize, Integer status)</span> {</span><br><span class="line">        <span class="comment">// 设置分页</span></span><br><span class="line">        PageHelper.startPage(pageNum, pageSize);</span><br><span class="line"></span><br><span class="line">        <span class="type">OrdersPageQueryDTO</span> <span class="variable">ordersPageQueryDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrdersPageQueryDTO</span>();</span><br><span class="line">        ordersPageQueryDTO.setUserId(BaseContext.getCurrentId());</span><br><span class="line">        ordersPageQueryDTO.setStatus(status);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 分页条件查询</span></span><br><span class="line">        Page&lt;Orders&gt; page = orderMapper.pageQuery(ordersPageQueryDTO);</span><br><span class="line"></span><br><span class="line">        List&lt;OrderVO&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询出订单明细，并封装入OrderVO进行响应</span></span><br><span class="line">        <span class="keyword">if</span> (page != <span class="literal">null</span> &amp;&amp; page.getTotal() &gt; <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">for</span> (Orders orders : page) {</span><br><span class="line">                <span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> orders.getId();<span class="comment">// 订单id</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 查询订单明细</span></span><br><span class="line">                List&lt;OrderDetail&gt; orderDetails = orderDetailMapper.getByOrderId(orderId);</span><br><span class="line"></span><br><span class="line">                <span class="type">OrderVO</span> <span class="variable">orderVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderVO</span>();</span><br><span class="line">                BeanUtils.copyProperties(orders, orderVO);</span><br><span class="line">                orderVO.setOrderDetailList(orderDetails);</span><br><span class="line"></span><br><span class="line">                list.add(orderVO);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageResult</span>(page.getTotal(), list);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-4-ordermapper">1.2.4 OrderMapper</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 分页条件查询并按下单时间排序</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ordersPageQueryDTO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Page&lt;Orders&gt; <span class="title function_">pageQuery</span><span class="params">(OrdersPageQueryDTO ordersPageQueryDTO)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-5-ordermapper-xml">1.2.5 OrderMapper.xml</span></h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"pageQuery"</span> <span class="attr">resultType</span>=<span class="string">"Orders"</span>&gt;</span></span><br><span class="line">       select * from orders</span><br><span class="line">       <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"number != null and number!=''"</span>&gt;</span></span><br><span class="line">               and number like concat('%',#{number},'%')</span><br><span class="line">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"phone != null and phone!=''"</span>&gt;</span></span><br><span class="line">               and phone like concat('%',#{phone},'%')</span><br><span class="line">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"userId != null"</span>&gt;</span></span><br><span class="line">               and user_id = #{userId}</span><br><span class="line">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"status != null"</span>&gt;</span></span><br><span class="line">               and status = #{status}</span><br><span class="line">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"beginTime != null"</span>&gt;</span></span><br><span class="line">               and order_time <span class="symbol">&amp;gt;</span>= #{beginTime}</span><br><span class="line">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"endTime != null"</span>&gt;</span></span><br><span class="line">               and order_time <span class="symbol">&amp;lt;</span>= #{endTime}</span><br><span class="line">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line">       order by order_time desc</span><br><span class="line">   <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-6-orderdetailmapper">1.2.6 OrderDetailMapper</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据订单id查询订单明细</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Select("select * from order_detail where order_id = #{orderId}")</span></span><br><span class="line">List&lt;OrderDetail&gt; <span class="title function_">getByOrderId</span><span class="params">(Long orderId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h3><span id="1-3-gong-neng-ce-shi">1.3 功能测试</span></h3><p>略</p>
<h2><span id="2-cha-xun-ding-dan-xiang-qing">2. 查询订单详情</span></h2><h3><span id="2-1-xu-qiu-fen-xi-he-she-ji">2.1 需求分析和设计</span></h3><p>产品原型：</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221128102144294.png" alt="image-20221128102144294"></p>
<p>接口设计：参见接口文档</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221128142142811.png" alt="image-20221128142142811"></p>
<h3><span id="2-2-dai-ma-shi-xian">2.2 代码实现</span></h3><h4><span id="2-2-1-user-ordercontroller">2.2.1 user/OrderController</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询订单详情</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/orderDetail/{id}")</span></span><br><span class="line"><span class="meta">@ApiOperation("查询订单详情")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderVO&gt; <span class="title function_">details</span><span class="params">(<span class="meta">@PathVariable("id")</span> Long id)</span> {</span><br><span class="line">    <span class="type">OrderVO</span> <span class="variable">orderVO</span> <span class="operator">=</span> orderService.details(id);</span><br><span class="line">    <span class="keyword">return</span> Result.success(orderVO);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-2-2-orderservice">2.2.2 OrderService</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询订单详情</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">OrderVO <span class="title function_">details</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-2-3-orderserviceimpl">2.2.3 OrderServiceImpl</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询订单详情</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> OrderVO <span class="title function_">details</span><span class="params">(Long id)</span> {</span><br><span class="line">    <span class="comment">// 根据id查询订单</span></span><br><span class="line">    <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> orderMapper.getById(id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询该订单对应的菜品/套餐明细</span></span><br><span class="line">    List&lt;OrderDetail&gt; orderDetailList = orderDetailMapper.getByOrderId(orders.getId());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将该订单及其详情封装到OrderVO并返回</span></span><br><span class="line">    <span class="type">OrderVO</span> <span class="variable">orderVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderVO</span>();</span><br><span class="line">    BeanUtils.copyProperties(orders, orderVO);</span><br><span class="line">    orderVO.setOrderDetailList(orderDetailList);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> orderVO;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-2-4-ordermapper">2.2.4 OrderMapper</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据id查询订单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Select("select * from orders where id=#{id}")</span></span><br><span class="line">Orders <span class="title function_">getById</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h3><span id="2-3-gong-neng-ce-shi">2.3 功能测试</span></h3><p>略</p>
<h2><span id="3-qu-xiao-ding-dan">3. 取消订单</span></h2><h3><span id="3-1-xu-qiu-fen-xi-he-she-ji">3.1 需求分析和设计</span></h3><p>产品原型：</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221128145444268.png" alt="image-20221128145444268"></p>
<p>业务规则：</p>
<ul>
<li>待支付和待接单状态下，用户可直接取消订单</li>
<li>商家已接单状态下，用户取消订单需电话沟通商家</li>
<li>派送中状态下，用户取消订单需电话沟通商家</li>
<li>如果在待接单状态下取消订单，需要给用户退款</li>
<li>取消订单后需要将订单状态修改为“已取消”</li>
</ul>
<p>接口设计：参见接口文档</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221128164410852.png" alt="image-20221128164410852"></p>
<h3><span id="3-2-dai-ma-shi-xian">3.2 代码实现</span></h3><h4><span id="3-2-1-user-ordercontroller">3.2.1 user/OrderController</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户取消订单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PutMapping("/cancel/{id}")</span></span><br><span class="line"><span class="meta">@ApiOperation("取消订单")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">cancel</span><span class="params">(<span class="meta">@PathVariable("id")</span> Long id)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    orderService.userCancelById(id);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="3-2-2-orderservice">3.2.2 OrderService</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户取消订单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">userCancelById</span><span class="params">(Long id)</span> <span class="keyword">throws</span> Exception;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="3-2-3-orderserviceimpl">3.2.3 OrderServiceImpl</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 用户取消订单</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userCancelById</span><span class="params">(Long id)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">       <span class="comment">// 根据id查询订单</span></span><br><span class="line">       <span class="type">Orders</span> <span class="variable">ordersDB</span> <span class="operator">=</span> orderMapper.getById(id);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 校验订单是否存在</span></span><br><span class="line">       <span class="keyword">if</span> (ordersDB == <span class="literal">null</span>) {</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(MessageConstant.ORDER_NOT_FOUND);</span><br><span class="line">       }</span><br><span class="line"></span><br><span class="line">       <span class="comment">//订单状态 1待付款 2待接单 3已接单 4派送中 5已完成 6已取消</span></span><br><span class="line">       <span class="keyword">if</span> (ordersDB.getStatus() &gt; <span class="number">2</span>) {</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(MessageConstant.ORDER_STATUS_ERROR);</span><br><span class="line">       }</span><br><span class="line"></span><br><span class="line">       <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Orders</span>();</span><br><span class="line">       orders.setId(ordersDB.getId());</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 订单处于待接单状态下取消，需要进行退款</span></span><br><span class="line">       <span class="keyword">if</span> (ordersDB.getStatus().equals(Orders.TO_BE_CONFIRMED)) {</span><br><span class="line">           <span class="comment">//调用微信支付退款接口</span></span><br><span class="line">           weChatPayUtil.refund(</span><br><span class="line">                   ordersDB.getNumber(), <span class="comment">//商户订单号</span></span><br><span class="line">                   ordersDB.getNumber(), <span class="comment">//商户退款单号</span></span><br><span class="line">                   <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0.01</span>),<span class="comment">//退款金额，单位 元</span></span><br><span class="line">                   <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0.01</span>));<span class="comment">//原订单金额</span></span><br><span class="line"></span><br><span class="line">           <span class="comment">//支付状态修改为 退款</span></span><br><span class="line">           orders.setPayStatus(Orders.REFUND);</span><br><span class="line">       }</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 更新订单状态、取消原因、取消时间</span></span><br><span class="line">       orders.setStatus(Orders.CANCELLED);</span><br><span class="line">       orders.setCancelReason(<span class="string">"用户取消"</span>);</span><br><span class="line">       orders.setCancelTime(LocalDateTime.now());</span><br><span class="line">       orderMapper.update(orders);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<h3><span id="3-3-gong-neng-ce-shi">3.3 功能测试</span></h3><p>略</p>
<h2><span id="4-zai-lai-yi-dan">4. 再来一单</span></h2><h3><span id="4-1-xu-qiu-fen-xi-he-she-ji">4.1 需求分析和设计</span></h3><p>产品原型：</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221128173238656.png" alt="image-20221128173238656"></p>
<p>接口设计：参见接口文档</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221128173350467.png" alt="image-20221128173350467"></p>
<p>业务规则：</p>
<ul>
<li>再来一单就是将原订单中的商品重新加入到购物车中</li>
</ul>
<h3><span id="4-2-dai-ma-shi-xian">4.2 代码实现</span></h3><h4><span id="4-2-1-user-ordercontroller">4.2.1 user/OrderController</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 再来一单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping("/repetition/{id}")</span></span><br><span class="line"><span class="meta">@ApiOperation("再来一单")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">repetition</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> {</span><br><span class="line">    orderService.repetition(id);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-2-2-orderservice">4.2.2 OrderService</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 再来一单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">repetition</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-2-3-orderserviceimpl">4.2.3 OrderServiceImpl</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 再来一单</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">repetition</span><span class="params">(Long id)</span> {</span><br><span class="line">       <span class="comment">// 查询当前用户id</span></span><br><span class="line">       <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> BaseContext.getCurrentId();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 根据订单id查询当前订单详情</span></span><br><span class="line">       List&lt;OrderDetail&gt; orderDetailList = orderDetailMapper.getByOrderId(id);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 将订单详情对象转换为购物车对象</span></span><br><span class="line">       List&lt;ShoppingCart&gt; shoppingCartList = orderDetailList.stream().map(x -&gt; {</span><br><span class="line">           <span class="type">ShoppingCart</span> <span class="variable">shoppingCart</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShoppingCart</span>();</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 将原订单详情里面的菜品信息重新复制到购物车对象中</span></span><br><span class="line">           BeanUtils.copyProperties(x, shoppingCart, <span class="string">"id"</span>);</span><br><span class="line">           shoppingCart.setUserId(userId);</span><br><span class="line">           shoppingCart.setCreateTime(LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> shoppingCart;</span><br><span class="line">       }).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 将购物车对象批量添加到数据库</span></span><br><span class="line">       shoppingCartMapper.insertBatch(shoppingCartList);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-2-4-shoppingcartmapper">4.2.4 ShoppingCartMapper</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 批量插入购物车数据</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> shoppingCartList</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">insertBatch</span><span class="params">(List&lt;ShoppingCart&gt; shoppingCartList)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-2-5-shoppingcartmapper-xml">4.2.5 ShoppingCartMapper.xml</span></h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertBatch"</span> <span class="attr">parameterType</span>=<span class="string">"list"</span>&gt;</span></span><br><span class="line">        insert into shopping_cart</span><br><span class="line">        (name, image, user_id, dish_id, setmeal_id, dish_flavor, number, amount, create_time)</span><br><span class="line">        values</span><br><span class="line">        <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">"shoppingCartList"</span> <span class="attr">item</span>=<span class="string">"sc"</span> <span class="attr">separator</span>=<span class="string">","</span>&gt;</span></span><br><span class="line">            (#{sc.name},#{sc.image},#{sc.userId},#{sc.dishId},#{sc.setmealId},#{sc.dishFlavor},#{sc.number},#{sc.amount},#{sc.createTime})</span><br><span class="line">        <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h3><span id="4-3-gong-neng-ce-shi">4.3 功能测试</span></h3><p>略</p>
<h2><span id="shang-jia-duan-ding-dan-guan-li-mo-kuai">商家端订单管理模块</span></h2><h2><span id="1-ding-dan-sou-suo">1. 订单搜索</span></h2><h3><span id="1-1-xu-qiu-fen-xi-he-she-ji">1.1 需求分析和设计</span></h3><p>产品原型：</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221129092023177.png" alt="image-20221129092023177"></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221129114035570.png" alt="image-20221129114035570"></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221129114054664.png" alt="image-20221129114054664"></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221129114116492.png" alt="image-20221129114116492"></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221129114132956.png" alt="image-20221129114132956"></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221129114151055.png" alt="image-20221129114151055"></p>
<p>业务规则：</p>
<ul>
<li>输入订单号/手机号进行搜索，支持模糊搜索</li>
<li>根据订单状态进行筛选</li>
<li>下单时间进行时间筛选</li>
<li>搜索内容为空，提示未找到相关订单</li>
<li>搜索结果页，展示包含搜索关键词的内容</li>
<li>分页展示搜索到的订单数据</li>
</ul>
<p>接口设计：参见接口文档</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221129092552620.png" alt="image-20221129092552620"></p>
<h3><span id="1-2-dai-ma-shi-xian">1.2 代码实现</span></h3><h4><span id="1-2-1-admin-ordercontroller">1.2.1 admin/OrderController</span></h4><p>在admin包下创建OrderController</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 订单管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController("adminOrderController")</span></span><br><span class="line"><span class="meta">@RequestMapping("/admin/order")</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = "订单管理接口")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单搜索</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ordersPageQueryDTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping("/conditionSearch")</span></span><br><span class="line">    <span class="meta">@ApiOperation("订单搜索")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;PageResult&gt; <span class="title function_">conditionSearch</span><span class="params">(OrdersPageQueryDTO ordersPageQueryDTO)</span> {</span><br><span class="line">        <span class="type">PageResult</span> <span class="variable">pageResult</span> <span class="operator">=</span> orderService.conditionSearch(ordersPageQueryDTO);</span><br><span class="line">        <span class="keyword">return</span> Result.success(pageResult);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-2-orderservice">1.2.2 OrderService</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 条件搜索订单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ordersPageQueryDTO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PageResult <span class="title function_">conditionSearch</span><span class="params">(OrdersPageQueryDTO ordersPageQueryDTO)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-3-orderserviceimpl">1.2.3 OrderServiceImpl</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 订单搜索</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ordersPageQueryDTO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> PageResult <span class="title function_">conditionSearch</span><span class="params">(OrdersPageQueryDTO ordersPageQueryDTO)</span> {</span><br><span class="line">    PageHelper.startPage(ordersPageQueryDTO.getPage(), ordersPageQueryDTO.getPageSize());</span><br><span class="line"></span><br><span class="line">    Page&lt;Orders&gt; page = orderMapper.pageQuery(ordersPageQueryDTO);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 部分订单状态，需要额外返回订单菜品信息，将Orders转化为OrderVO</span></span><br><span class="line">    List&lt;OrderVO&gt; orderVOList = getOrderVOList(page);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageResult</span>(page.getTotal(), orderVOList);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> List&lt;OrderVO&gt; <span class="title function_">getOrderVOList</span><span class="params">(Page&lt;Orders&gt; page)</span> {</span><br><span class="line">    <span class="comment">// 需要返回订单菜品信息，自定义OrderVO响应结果</span></span><br><span class="line">    List&lt;OrderVO&gt; orderVOList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    List&lt;Orders&gt; ordersList = page.getResult();</span><br><span class="line">    <span class="keyword">if</span> (!CollectionUtils.isEmpty(ordersList)) {</span><br><span class="line">        <span class="keyword">for</span> (Orders orders : ordersList) {</span><br><span class="line">            <span class="comment">// 将共同字段复制到OrderVO</span></span><br><span class="line">            <span class="type">OrderVO</span> <span class="variable">orderVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderVO</span>();</span><br><span class="line">            BeanUtils.copyProperties(orders, orderVO);</span><br><span class="line">            <span class="type">String</span> <span class="variable">orderDishes</span> <span class="operator">=</span> getOrderDishesStr(orders);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将订单菜品信息封装到orderVO中，并添加到orderVOList</span></span><br><span class="line">            orderVO.setOrderDishes(orderDishes);</span><br><span class="line">            orderVOList.add(orderVO);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> orderVOList;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据订单id获取菜品信息字符串</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orders</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">getOrderDishesStr</span><span class="params">(Orders orders)</span> {</span><br><span class="line">    <span class="comment">// 查询订单菜品详情信息（订单中的菜品和数量）</span></span><br><span class="line">    List&lt;OrderDetail&gt; orderDetailList = orderDetailMapper.getByOrderId(orders.getId());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将每一条订单菜品信息拼接为字符串（格式：宫保鸡丁*3；）</span></span><br><span class="line">    List&lt;String&gt; orderDishList = orderDetailList.stream().map(x -&gt; {</span><br><span class="line">        <span class="type">String</span> <span class="variable">orderDish</span> <span class="operator">=</span> x.getName() + <span class="string">"*"</span> + x.getNumber() + <span class="string">";"</span>;</span><br><span class="line">        <span class="keyword">return</span> orderDish;</span><br><span class="line">    }).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将该订单对应的所有菜品信息拼接在一起</span></span><br><span class="line">    <span class="keyword">return</span> String.join(<span class="string">""</span>, orderDishList);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3><span id="1-3-gong-neng-ce-shi">1.3 功能测试</span></h3><p>略</p>
<h2><span id="2-ge-ge-zhuang-tai-de-ding-dan-shu-liang-tong-ji">2. 各个状态的订单数量统计</span></h2><h3><span id="2-1-xu-qiu-fen-xi-he-she-ji">2.1 需求分析和设计</span></h3><p>产品原型：</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221129095804419.png" alt="image-20221129095804419"></p>
<p>接口设计：参见接口文档</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221129095912896.png" alt="image-20221129095912896"></p>
<h3><span id="2-2-dai-ma-shi-xian">2.2 代码实现</span></h3><h4><span id="2-2-1-admin-ordercontroller">2.2.1 admin/OrderController</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 各个状态的订单数量统计</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/statistics")</span></span><br><span class="line"><span class="meta">@ApiOperation("各个状态的订单数量统计")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderStatisticsVO&gt; <span class="title function_">statistics</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">OrderStatisticsVO</span> <span class="variable">orderStatisticsVO</span> <span class="operator">=</span> orderService.statistics();</span><br><span class="line">    <span class="keyword">return</span> Result.success(orderStatisticsVO);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-2-2-orderservice">2.2.2 OrderService</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 各个状态的订单数量统计</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">OrderStatisticsVO <span class="title function_">statistics</span><span class="params">()</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-2-3-orderserviceimpl">2.2.3 OrderServiceImpl</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 各个状态的订单数量统计</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> OrderStatisticsVO <span class="title function_">statistics</span><span class="params">()</span> {</span><br><span class="line">    <span class="comment">// 根据状态，分别查询出待接单、待派送、派送中的订单数量</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">toBeConfirmed</span> <span class="operator">=</span> orderMapper.countStatus(Orders.TO_BE_CONFIRMED);</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">confirmed</span> <span class="operator">=</span> orderMapper.countStatus(Orders.CONFIRMED);</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">deliveryInProgress</span> <span class="operator">=</span> orderMapper.countStatus(Orders.DELIVERY_IN_PROGRESS);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将查询出的数据封装到orderStatisticsVO中响应</span></span><br><span class="line">    <span class="type">OrderStatisticsVO</span> <span class="variable">orderStatisticsVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderStatisticsVO</span>();</span><br><span class="line">    orderStatisticsVO.setToBeConfirmed(toBeConfirmed);</span><br><span class="line">    orderStatisticsVO.setConfirmed(confirmed);</span><br><span class="line">    orderStatisticsVO.setDeliveryInProgress(deliveryInProgress);</span><br><span class="line">    <span class="keyword">return</span> orderStatisticsVO;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-2-4-ordermapper">2.2.4 OrderMapper</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据状态统计订单数量</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Select("select count(id) from orders where status = #{status}")</span></span><br><span class="line">Integer <span class="title function_">countStatus</span><span class="params">(Integer status)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-3-gong-neng-ce-shi">2.3 功能测试</span></h3><p>略</p>
<h2><span id="3-cha-xun-ding-dan-xiang-qing">3. 查询订单详情</span></h2><h3><span id="3-1-xu-qiu-fen-xi-he-she-ji">3.1 需求分析和设计</span></h3><p>产品原型：</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221129101712084.png" alt="image-20221129101712084"></p>
<p>业务规则：</p>
<ul>
<li>订单详情页面需要展示订单基本信息（状态、订单号、下单时间、收货人、电话、收货地址、金额等）</li>
<li>订单详情页面需要展示订单明细数据（商品名称、数量、单价）</li>
</ul>
<p>接口设计：参见接口文档</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221129101035374.png" alt="image-20221129101035374"></p>
<h3><span id="3-2-dai-ma-shi-xian">3.2 代码实现</span></h3><h4><span id="3-2-1-admin-ordercontroller">3.2.1 admin/OrderController</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 订单详情</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/details/{id}")</span></span><br><span class="line"><span class="meta">@ApiOperation("查询订单详情")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderVO&gt; <span class="title function_">details</span><span class="params">(<span class="meta">@PathVariable("id")</span> Long id)</span> {</span><br><span class="line">    <span class="type">OrderVO</span> <span class="variable">orderVO</span> <span class="operator">=</span> orderService.details(id);</span><br><span class="line">    <span class="keyword">return</span> Result.success(orderVO);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3><span id="3-3-gong-neng-ce-shi">3.3 功能测试</span></h3><p>略</p>
<h2><span id="4-jie-dan">4. 接单</span></h2><h3><span id="4-1-xu-qiu-fen-xi-he-she-ji">4.1 需求分析和设计</span></h3><p>产品原型：</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221129105142623.png" alt="image-20221129105142623"></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221129105116285.png" alt="image-20221129105116285"></p>
<p>业务规则：</p>
<ul>
<li>商家接单其实就是将订单的状态修改为“已接单”</li>
</ul>
<p>接口设计：参见接口文档</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221129105313172.png" alt="image-20221129105313172"></p>
<h3><span id="4-2-dai-ma-shi-xian">4.2 代码实现</span></h3><h4><span id="4-2-1-admin-ordercontroller">4.2.1 admin/OrderController</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 接单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PutMapping("/confirm")</span></span><br><span class="line"><span class="meta">@ApiOperation("接单")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">confirm</span><span class="params">(<span class="meta">@RequestBody</span> OrdersConfirmDTO ordersConfirmDTO)</span> {</span><br><span class="line">    orderService.confirm(ordersConfirmDTO);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-2-2-orderservice">4.2.2 OrderService</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 接单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ordersConfirmDTO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(OrdersConfirmDTO ordersConfirmDTO)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-2-3-orderserviceimpl">4.2.3 OrderServiceImpl</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 接单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ordersConfirmDTO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(OrdersConfirmDTO ordersConfirmDTO)</span> {</span><br><span class="line">    <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> Orders.builder()</span><br><span class="line">            .id(ordersConfirmDTO.getId())</span><br><span class="line">            .status(Orders.CONFIRMED)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    orderMapper.update(orders);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-3-gong-neng-ce-shi">4.3 功能测试</span></h3><p>略</p>
<h2><span id="5-ju-dan">5. 拒单</span></h2><h3><span id="5-1-xu-qiu-fen-xi-he-she-ji">5.1 需求分析和设计</span></h3><p>产品原型：</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221129110358976.png" alt="image-20221129110358976"></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221129110428390.png" alt="image-20221129110428390"></p>
<p>业务规则：</p>
<ul>
<li>商家拒单其实就是将订单状态修改为“已取消”</li>
<li>只有订单处于“待接单”状态时可以执行拒单操作</li>
<li>商家拒单时需要指定拒单原因</li>
<li>商家拒单时，如果用户已经完成了支付，需要为用户退款</li>
</ul>
<p>接口设计：参见接口文档</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221129110725031.png" alt="image-20221129110725031"></p>
<h3><span id="5-2-dai-ma-shi-xian">5.2 代码实现</span></h3><h4><span id="5-2-1-admin-ordercontroller">5.2.1 admin/OrderController</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拒单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PutMapping("/rejection")</span></span><br><span class="line"><span class="meta">@ApiOperation("拒单")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">rejection</span><span class="params">(<span class="meta">@RequestBody</span> OrdersRejectionDTO ordersRejectionDTO)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    orderService.rejection(ordersRejectionDTO);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="5-2-2-orderservice">5.2.2 OrderService</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拒单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ordersRejectionDTO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">rejection</span><span class="params">(OrdersRejectionDTO ordersRejectionDTO)</span> <span class="keyword">throws</span> Exception;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="5-2-3-orderserviceimpl">5.2.3 OrderServiceImpl</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 拒单</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ordersRejectionDTO</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rejection</span><span class="params">(OrdersRejectionDTO ordersRejectionDTO)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">       <span class="comment">// 根据id查询订单</span></span><br><span class="line">       <span class="type">Orders</span> <span class="variable">ordersDB</span> <span class="operator">=</span> orderMapper.getById(ordersRejectionDTO.getId());</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 订单只有存在且状态为2（待接单）才可以拒单</span></span><br><span class="line">       <span class="keyword">if</span> (ordersDB == <span class="literal">null</span> || !ordersDB.getStatus().equals(Orders.TO_BE_CONFIRMED)) {</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(MessageConstant.ORDER_STATUS_ERROR);</span><br><span class="line">       }</span><br><span class="line"></span><br><span class="line">       <span class="comment">//支付状态</span></span><br><span class="line">       <span class="type">Integer</span> <span class="variable">payStatus</span> <span class="operator">=</span> ordersDB.getPayStatus();</span><br><span class="line">       <span class="keyword">if</span> (payStatus == Orders.PAID) {</span><br><span class="line">           <span class="comment">//用户已支付，需要退款</span></span><br><span class="line">           <span class="type">String</span> <span class="variable">refund</span> <span class="operator">=</span> weChatPayUtil.refund(</span><br><span class="line">                   ordersDB.getNumber(),</span><br><span class="line">                   ordersDB.getNumber(),</span><br><span class="line">                   <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0.01</span>),</span><br><span class="line">                   <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0.01</span>));</span><br><span class="line">           log.info(<span class="string">"申请退款：{}"</span>, refund);</span><br><span class="line">       }</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 拒单需要退款，根据订单id更新订单状态、拒单原因、取消时间</span></span><br><span class="line">       <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Orders</span>();</span><br><span class="line">       orders.setId(ordersDB.getId());</span><br><span class="line">       orders.setStatus(Orders.CANCELLED);</span><br><span class="line">       orders.setRejectionReason(ordersRejectionDTO.getRejectionReason());</span><br><span class="line">       orders.setCancelTime(LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">       orderMapper.update(orders);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<h3><span id="5-3-gong-neng-ce-shi">5.3 功能测试</span></h3><p>略</p>
<h2><span id="6-qu-xiao-ding-dan">6. 取消订单</span></h2><h3><span id="6-1-xu-qiu-fen-xi-he-she-ji">6.1 需求分析和设计</span></h3><p>产品原型：</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221129111402099.png" alt="image-20221129111402099"></p>
<p>业务规则：</p>
<ul>
<li>取消订单其实就是将订单状态修改为“已取消”</li>
<li>商家取消订单时需要指定取消原因</li>
<li>商家取消订单时，如果用户已经完成了支付，需要为用户退款</li>
</ul>
<p>接口设计：参见接口文档</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221129112201836.png" alt="image-20221129112201836"></p>
<h3><span id="6-2-dai-ma-shi-xian">6.2 代码实现</span></h3><h4><span id="6-2-1-admin-ordercontroller">6.2.1 admin/OrderController</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 取消订单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PutMapping("/cancel")</span></span><br><span class="line"><span class="meta">@ApiOperation("取消订单")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">cancel</span><span class="params">(<span class="meta">@RequestBody</span> OrdersCancelDTO ordersCancelDTO)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    orderService.cancel(ordersCancelDTO);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="6-2-2-orderservice">6.2.2 OrderService</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 商家取消订单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ordersCancelDTO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">(OrdersCancelDTO ordersCancelDTO)</span> <span class="keyword">throws</span> Exception;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="6-2-3-orderserviceimpl">6.2.3 OrderServiceImpl</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 取消订单</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ordersCancelDTO</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">(OrdersCancelDTO ordersCancelDTO)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">       <span class="comment">// 根据id查询订单</span></span><br><span class="line">       <span class="type">Orders</span> <span class="variable">ordersDB</span> <span class="operator">=</span> orderMapper.getById(ordersCancelDTO.getId());</span><br><span class="line"></span><br><span class="line">       <span class="comment">//支付状态</span></span><br><span class="line">       <span class="type">Integer</span> <span class="variable">payStatus</span> <span class="operator">=</span> ordersDB.getPayStatus();</span><br><span class="line">       <span class="keyword">if</span> (payStatus == <span class="number">1</span>) {</span><br><span class="line">           <span class="comment">//用户已支付，需要退款</span></span><br><span class="line">           <span class="type">String</span> <span class="variable">refund</span> <span class="operator">=</span> weChatPayUtil.refund(</span><br><span class="line">                   ordersDB.getNumber(),</span><br><span class="line">                   ordersDB.getNumber(),</span><br><span class="line">                   <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0.01</span>),</span><br><span class="line">                   <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0.01</span>));</span><br><span class="line">           log.info(<span class="string">"申请退款：{}"</span>, refund);</span><br><span class="line">       }</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 管理端取消订单需要退款，根据订单id更新订单状态、取消原因、取消时间</span></span><br><span class="line">       <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Orders</span>();</span><br><span class="line">       orders.setId(ordersCancelDTO.getId());</span><br><span class="line">       orders.setStatus(Orders.CANCELLED);</span><br><span class="line">       orders.setCancelReason(ordersCancelDTO.getCancelReason());</span><br><span class="line">       orders.setCancelTime(LocalDateTime.now());</span><br><span class="line">       orderMapper.update(orders);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<h3><span id="6-3-gong-neng-ce-shi">6.3 功能测试</span></h3><p>略</p>
<h2><span id="7-pai-song-ding-dan">7. 派送订单</span></h2><h3><span id="7-1-xu-qiu-fen-xi-he-she-ji">7.1 需求分析和设计</span></h3><p>产品原型：</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221129113257201.png" alt="image-20221129113257201"></p>
<p>业务规则：</p>
<ul>
<li>派送订单其实就是将订单状态修改为“派送中”</li>
<li>只有状态为“待派送”的订单可以执行派送订单操作</li>
</ul>
<p>接口设计：参见接口文档</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221129113449124.png" alt="image-20221129113449124"></p>
<h3><span id="7-2-dai-ma-shi-xian">7.2 代码实现</span></h3><h4><span id="7-2-1-admin-ordercontroller">7.2.1 admin/OrderController</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 派送订单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PutMapping("/delivery/{id}")</span></span><br><span class="line"><span class="meta">@ApiOperation("派送订单")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">delivery</span><span class="params">(<span class="meta">@PathVariable("id")</span> Long id)</span> {</span><br><span class="line">    orderService.delivery(id);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="7-2-2-orderservice">7.2.2 OrderService</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 派送订单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">delivery</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="7-2-3-orderserviceimpl">7.2.3 OrderServiceImpl</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 派送订单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delivery</span><span class="params">(Long id)</span> {</span><br><span class="line">    <span class="comment">// 根据id查询订单</span></span><br><span class="line">    <span class="type">Orders</span> <span class="variable">ordersDB</span> <span class="operator">=</span> orderMapper.getById(id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 校验订单是否存在，并且状态为3</span></span><br><span class="line">    <span class="keyword">if</span> (ordersDB == <span class="literal">null</span> || !ordersDB.getStatus().equals(Orders.CONFIRMED)) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(MessageConstant.ORDER_STATUS_ERROR);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Orders</span>();</span><br><span class="line">    orders.setId(ordersDB.getId());</span><br><span class="line">    <span class="comment">// 更新订单状态,状态转为派送中</span></span><br><span class="line">    orders.setStatus(Orders.DELIVERY_IN_PROGRESS);</span><br><span class="line"></span><br><span class="line">    orderMapper.update(orders);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3><span id="7-3-gong-neng-ce-shi">7.3 功能测试</span></h3><p>略</p>
<h2><span id="8-wan-cheng-ding-dan">8. 完成订单</span></h2><h3><span id="8-1-xu-qiu-fen-xi-he-she-ji">8.1 需求分析和设计</span></h3><p>产品原型：</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221129112554051.png" alt="image-20221129112554051"></p>
<p>业务规则：</p>
<ul>
<li>完成订单其实就是将订单状态修改为“已完成”</li>
<li>只有状态为“派送中”的订单可以执行订单完成操作</li>
</ul>
<p>接口设计：参见接口文档</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221129113622784.png" alt="image-20221129113622784"></p>
<h3><span id="8-2-dai-ma-shi-xian">8.2 代码实现</span></h3><h4><span id="8-2-1-admin-ordercontroller">8.2.1 admin/OrderController</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 完成订单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PutMapping("/complete/{id}")</span></span><br><span class="line"><span class="meta">@ApiOperation("完成订单")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">complete</span><span class="params">(<span class="meta">@PathVariable("id")</span> Long id)</span> {</span><br><span class="line">    orderService.complete(id);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="8-2-2-orderservice">8.2.2 OrderService</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 完成订单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">complete</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="8-2-3-orderserviceimpl">8.2.3 OrderServiceImpl</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 完成订单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">complete</span><span class="params">(Long id)</span> {</span><br><span class="line">    <span class="comment">// 根据id查询订单</span></span><br><span class="line">    <span class="type">Orders</span> <span class="variable">ordersDB</span> <span class="operator">=</span> orderMapper.getById(id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 校验订单是否存在，并且状态为4</span></span><br><span class="line">    <span class="keyword">if</span> (ordersDB == <span class="literal">null</span> || !ordersDB.getStatus().equals(Orders.DELIVERY_IN_PROGRESS)) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(MessageConstant.ORDER_STATUS_ERROR);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Orders</span>();</span><br><span class="line">    orders.setId(ordersDB.getId());</span><br><span class="line">    <span class="comment">// 更新订单状态,状态转为完成</span></span><br><span class="line">    orders.setStatus(Orders.COMPLETED);</span><br><span class="line">    orders.setDeliveryTime(LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">    orderMapper.update(orders);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3><span id="8-3-gong-neng-ce-shi">8.3 功能测试</span></h3><p>略</p>
<h2><span id="xiao-yan-shou-huo-di-zhi-shi-fou-chao-chu-pei-song-fan-wei">校验收货地址是否超出配送范围</span></h2><h2><span id="1-huan-jing-zhun-bei">1. 环境准备</span></h2><p>注册账号：<a target="_blank" rel="noopener" href="https://passport.baidu.com/v2/?reg&amp;tt=1671699340600&amp;overseas=&amp;gid=CF954C2-A3D2-417F-9FE6-B0F249ED7E33&amp;tpl=pp&amp;u=https://lbsyun.baidu.com/index.php?title=%E9%A6%96%E9%A1%B5">https://passport.baidu.com/v2/?reg&amp;tt=1671699340600&amp;overseas=&amp;gid=CF954C2-A3D2-417F-9FE6-B0F249ED7E33&amp;tpl=pp&amp;u=https%3A%2F%2Flbsyun.baidu.com%2Findex.php%3Ftitle%3D%E9%A6%96%E9%A1%B5</a></p>
<p>登录百度地图开放平台：<a target="_blank" rel="noopener" href="https://lbsyun.baidu.com/">https://lbsyun.baidu.com/</a></p>
<p>进入控制台，创建应用，获取AK：</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221222170049729.png" alt="image-20221222170049729"></p>
<p><img src="/2024/09/26/projection-skytogo/image-20221222170256927.png" alt="image-20221222170256927"></p>
<p>相关接口:</p>
<p><a target="_blank" rel="noopener" href="https://lbsyun.baidu.com/index.php?title=webapi/guide/webservice-geocoding">https://lbsyun.baidu.com/index.php?title=webapi/guide/webservice-geocoding</a></p>
<p><a target="_blank" rel="noopener" href="https://lbsyun.baidu.com/index.php?title=webapi/directionlite-v1">https://lbsyun.baidu.com/index.php?title=webapi/directionlite-v1</a></p>
<h2><span id="2-dai-ma-kai-fa">2. 代码开发</span></h2><h3><span id="2-1-application-yml">2.1 application.yml</span></h3><p>配置外卖商家店铺地址和百度地图的AK：</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221222170819582.png" alt="image-20221222170819582"></p>
<h3><span id="2-2-orderserviceimpl">2.2 OrderServiceImpl</span></h3><p>改造OrderServiceImpl，注入上面的配置项：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value("${sky.shop.address}")</span></span><br><span class="line"><span class="keyword">private</span> String shopAddress;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value("${sky.baidu.ak}")</span></span><br><span class="line"><span class="keyword">private</span> String ak;</span><br></pre></td></tr></tbody></table></figure>

<p>在OrderServiceImpl中提供校验方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检查客户的收货地址是否超出配送范围</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> address</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkOutOfRange</span><span class="params">(String address)</span> {</span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map.put(<span class="string">"address"</span>,shopAddress);</span><br><span class="line">        map.put(<span class="string">"output"</span>,<span class="string">"json"</span>);</span><br><span class="line">        map.put(<span class="string">"ak"</span>,ak);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取店铺的经纬度坐标</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">shopCoordinate</span> <span class="operator">=</span> HttpClientUtil.doGet(<span class="string">"https://api.map.baidu.com/geocoding/v3"</span>, map);</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSON.parseObject(shopCoordinate);</span><br><span class="line">        <span class="keyword">if</span>(!jsonObject.getString(<span class="string">"status"</span>).equals(<span class="string">"0"</span>)){</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(<span class="string">"店铺地址解析失败"</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//数据解析</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">location</span> <span class="operator">=</span> jsonObject.getJSONObject(<span class="string">"result"</span>).getJSONObject(<span class="string">"location"</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">lat</span> <span class="operator">=</span> location.getString(<span class="string">"lat"</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">lng</span> <span class="operator">=</span> location.getString(<span class="string">"lng"</span>);</span><br><span class="line">        <span class="comment">//店铺经纬度坐标</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">shopLngLat</span> <span class="operator">=</span> lat + <span class="string">","</span> + lng;</span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">"address"</span>,address);</span><br><span class="line">        <span class="comment">//获取用户收货地址的经纬度坐标</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userCoordinate</span> <span class="operator">=</span> HttpClientUtil.doGet(<span class="string">"https://api.map.baidu.com/geocoding/v3"</span>, map);</span><br><span class="line"></span><br><span class="line">        jsonObject = JSON.parseObject(userCoordinate);</span><br><span class="line">        <span class="keyword">if</span>(!jsonObject.getString(<span class="string">"status"</span>).equals(<span class="string">"0"</span>)){</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(<span class="string">"收货地址解析失败"</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//数据解析</span></span><br><span class="line">        location = jsonObject.getJSONObject(<span class="string">"result"</span>).getJSONObject(<span class="string">"location"</span>);</span><br><span class="line">        lat = location.getString(<span class="string">"lat"</span>);</span><br><span class="line">        lng = location.getString(<span class="string">"lng"</span>);</span><br><span class="line">        <span class="comment">//用户收货地址经纬度坐标</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userLngLat</span> <span class="operator">=</span> lat + <span class="string">","</span> + lng;</span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">"origin"</span>,shopLngLat);</span><br><span class="line">        map.put(<span class="string">"destination"</span>,userLngLat);</span><br><span class="line">        map.put(<span class="string">"steps_info"</span>,<span class="string">"0"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//路线规划</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> HttpClientUtil.doGet(<span class="string">"https://api.map.baidu.com/directionlite/v1/driving"</span>, map);</span><br><span class="line"></span><br><span class="line">        jsonObject = JSON.parseObject(json);</span><br><span class="line">        <span class="keyword">if</span>(!jsonObject.getString(<span class="string">"status"</span>).equals(<span class="string">"0"</span>)){</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(<span class="string">"配送路线规划失败"</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//数据解析</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">result</span> <span class="operator">=</span> jsonObject.getJSONObject(<span class="string">"result"</span>);</span><br><span class="line">        <span class="type">JSONArray</span> <span class="variable">jsonArray</span> <span class="operator">=</span> (JSONArray) result.get(<span class="string">"routes"</span>);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">distance</span> <span class="operator">=</span> (Integer) ((JSONObject) jsonArray.get(<span class="number">0</span>)).get(<span class="string">"distance"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(distance &gt; <span class="number">5000</span>){</span><br><span class="line">            <span class="comment">//配送距离超过5000米</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(<span class="string">"超出配送范围"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>

<p>在OrderServiceImpl的submitOrder方法中调用上面的校验方法：</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221222171444981.png" alt="image-20221222171444981"></p>
<h1><span id="cang-qiong-wai-mai-day10">苍穹外卖-day10</span></h1><h2><span id="ke-cheng-nei-rong">课程内容</span></h2><ul>
<li>Spring Task</li>
<li>订单状态定时处理</li>
<li>WebSocket</li>
<li>来单提醒</li>
<li>客户催单</li>
</ul>
<p>功能实现：<strong>订单状态定时处理</strong>、<strong>来单提醒</strong>和<strong>客户催单</strong></p>
<p><strong>订单状态定时处理：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221218204021760.png" alt="image-20221218204021760" style="zoom:50%;"> 



<p><strong>来单提醒：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221218204119663.png" alt="image-20221218204119663" style="zoom:50%;"> 



<p><strong>客户催单：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221218204202847.png" alt="image-20221218204202847" style="zoom:50%;"> 



<h2><span id="1-spring-task">1. Spring Task</span></h2><h3><span id="1-1-jie-shao">1.1 介绍</span></h3><p><strong>Spring Task</strong> 是Spring框架提供的任务调度工具，可以按照约定的时间自动执行某个代码逻辑。</p>
<p><strong>定位：</strong>定时任务框架</p>
<p><strong>作用：</strong>定时自动执行某段Java代码</p>
<p> <img src="/2024/09/26/projection-skytogo/image-20221218183054818.png" alt="image-20221218183054818" style="zoom:50%;"> 为什么要在Java程序中使用Spring Task？</p>
<p><strong>应用场景：</strong></p>
<p>1). 信用卡每月还款提醒</p>
<img src="/2024/09/26/projection-skytogo/image-20221218183213088.png" alt="image-20221218183213088" style="zoom:50%;"> 



<p>2). 银行贷款每月还款提醒</p>
<img src="/2024/09/26/projection-skytogo/image-20221218183410430.png" alt="image-20221218183410430" style="zoom:50%;"> 



<p>3). 火车票售票系统处理未支付订单</p>
<img src="/2024/09/26/projection-skytogo/image-20221218183614351.png" alt="image-20221218183614351" style="zoom:50%;"> 



<p>4). 入职纪念日为用户发送通知</p>
<img src="/2024/09/26/projection-skytogo/image-20221218183655186.png" alt="image-20221218183655186" style="zoom:50%;"> 



<p><strong>强调：</strong>只要是需要定时处理的场景都可以使用Spring Task</p>
<h3><span id="1-2-cron-biao-da-shi">1.2 cron表达式</span></h3><p><strong>cron表达式</strong>其实就是一个字符串，通过cron表达式可以<strong>定义任务触发的时间</strong></p>
<p><strong>构成规则：</strong>分为6或7个域，由空格分隔开，每个域代表一个含义</p>
<p>每个域的含义分别为：秒、分钟、小时、日、月、周、年(可选)</p>
<p><strong>举例：</strong></p>
<p>2022年10月12日上午9点整 对应的cron表达式为：<strong>0 0 9 12 10 ? 2022</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221218184412491.png" alt="image-20221218184412491" style="zoom:50%;"> 

<p><strong>说明：</strong>一般<strong>日</strong>和<strong>周</strong>的值不同时设置，其中一个设置，另一个用？表示。</p>
<p><strong>比如：</strong>描述2月份的最后一天，最后一天具体是几号呢？可能是28号，也有可能是29号，所以就不能写具体数字。</p>
<p>为了描述这些信息，提供一些特殊的字符。这些具体的细节，我们就不用自己去手写，因为这个cron表达式，它其实有在线生成器。</p>
<p>cron表达式在线生成器：<a target="_blank" rel="noopener" href="https://cron.qqe2.com/">https://cron.qqe2.com/</a></p>
<img src="/2024/09/26/projection-skytogo/image-20221218184959888.png" alt="image-20221218184959888" style="zoom:50%;"> 



<p>可以直接在这个网站上面，只要根据自己的要求去生成corn表达式即可。所以一般就不用自己去编写这个表达式。</p>
<p><strong>通配符：</strong></p>
<p>* 表示所有值； </p>
<p>? 表示未说明的值，即不关心它为何值； </p>
<p>- 表示一个指定的范围； </p>
<p>, 表示附加一个可能值； </p>
<p>/ 符号前表示开始时间，符号后表示每次递增的值；</p>
<p><strong>cron表达式案例：</strong></p>
<p>*/5 * * * * ? 每隔5秒执行一次</p>
<p>0 */1 * * * ? 每隔1分钟执行一次</p>
<p>0 0 5-15 * * ? 每天5-15点整点触发</p>
<p>0 0/3 * * * ? 每三分钟触发一次</p>
<p>0 0-5 14 * * ? 在每天下午2点到下午2:05期间的每1分钟触发 </p>
<p>0 0/5 14 * * ? 在每天下午2点到下午2:55期间的每5分钟触发</p>
<p>0 0/5 14,18 * * ? 在每天下午2点到2:55期间和下午6点到6:55期间的每5分钟触发</p>
<p>0 0/30 9-17 * * ? 朝九晚五工作时间内每半小时</p>
<p>0 0 10,14,16 * * ? 每天上午10点，下午2点，4点 </p>
<h3><span id="1-3-ru-men-an-li">1.3 入门案例</span></h3><h4><span id="1-3-1-spring-task-shi-yong-bu-zou">1.3.1 Spring Task使用步骤</span></h4><p>1). 导入maven坐标 spring-context（已存在）</p>
<img src="/2024/09/26/projection-skytogo/image-20221218193251182.png" alt="image-20221218193251182" style="zoom:50%;"> 

<p>2). 启动类添加注解 @EnableScheduling 开启任务调度</p>
<p>3). 自定义定时任务类</p>
<h4><span id="1-3-2-dai-ma-kai-fa">1.3.2 代码开发</span></h4><p><strong>编写定时任务类：</strong></p>
<p>进入sky-server模块中</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.task;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义定时任务类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTask</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定时任务 每隔5秒触发一次</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = "0/5 * * * * ?")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeTask</span><span class="params">()</span>{</span><br><span class="line">        log.info(<span class="string">"定时任务开始执行：{}"</span>,<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>开启任务调度：</strong></p>
<p>启动类添加注解 @EnableScheduling</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.EnableCaching;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.EnableScheduling;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span> <span class="comment">//开启注解方式的事务管理</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="meta">@EnableScheduling</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SkyApplication</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        SpringApplication.run(SkyApplication.class, args);</span><br><span class="line">        log.info(<span class="string">"server started"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="1-3-3-gong-neng-ce-shi">1.3.3 功能测试</span></h4><p>启动服务，查看日志</p>
<img src="/2024/09/26/projection-skytogo/image-20221218194511420.png" alt="image-20221218194511420" style="zoom:80%;"> 

<p>每隔5秒执行一次。</p>
<h2><span id="2-ding-dan-zhuang-tai-ding-shi-chu-li">2.订单状态定时处理</span></h2><h3><span id="2-1-xu-qiu-fen-xi">2.1 需求分析</span></h3><p>用户下单后可能存在的情况：</p>
<ul>
<li>下单后未支付，订单一直处于<strong>“待支付”</strong>状态</li>
<li>用户收货后管理端未点击完成按钮，订单一直处于<strong>“派送中”</strong>状态</li>
</ul>
<p><img src="/2024/09/26/projection-skytogo/image-20221218194939516.png" alt="image-20221218194939516" style="zoom:50%;">                  <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221218194951963.png" alt="image-20221218194951963" style="zoom:50%;"></p>
<p>支付超时的订单如何处理？                                                       派送中的订单一直不点击完成如何处理？</p>
<p>对于上面两种情况需要通过<strong>定时任务</strong>来修改订单状态，具体逻辑为：</p>
<ul>
<li>通过定时任务每分钟检查一次是否存在支付超时订单（下单后超过15分钟仍未支付则判定为支付超时订单），如果存在则修改订单状态为“已取消”</li>
<li>通过定时任务每天凌晨1点检查一次是否存在“派送中”的订单，如果存在则修改订单状态为“已完成”</li>
</ul>
<h3><span id="2-2-dai-ma-kai-fa">2.2 代码开发</span></h3><p><strong>1). 自定义定时任务类OrderTask（待完善）：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.task;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义定时任务，实现订单状态定时处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderTask</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderMapper orderMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理支付超时订单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = "0 * * * * ?")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processTimeoutOrder</span><span class="params">()</span>{</span><br><span class="line">        log.info(<span class="string">"处理支付超时订单：{}"</span>, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理“派送中”状态的订单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = "0 0 1 * * ?")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processDeliveryOrder</span><span class="params">()</span>{</span><br><span class="line">        log.info(<span class="string">"处理派送中订单：{}"</span>, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p><strong>2). 在OrderMapper接口中扩展方法:</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据状态和下单时间查询订单</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> orderTime</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Select("select * from orders where status = #{status} and order_time &lt; #{orderTime}")</span></span><br><span class="line">   List&lt;Orders&gt; <span class="title function_">getByStatusAndOrdertimeLT</span><span class="params">(Integer status, LocalDateTime orderTime)</span>;</span><br></pre></td></tr></tbody></table></figure>



<p><strong>3). 完善定时任务类的processTimeoutOrder方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 处理支付超时订单</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Scheduled(cron = "0 * * * * ?")</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processTimeoutOrder</span><span class="params">()</span>{</span><br><span class="line">       log.info(<span class="string">"处理支付超时订单：{}"</span>, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line"></span><br><span class="line">       <span class="type">LocalDateTime</span> <span class="variable">time</span> <span class="operator">=</span> LocalDateTime.now().plusMinutes(-<span class="number">15</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// select * from orders where status = 1 and order_time &lt; 当前时间-15分钟</span></span><br><span class="line">       List&lt;Orders&gt; ordersList = orderMapper.getByStatusAndOrdertimeLT(Orders.PENDING_PAYMENT, time);</span><br><span class="line">       <span class="keyword">if</span>(ordersList != <span class="literal">null</span> &amp;&amp; ordersList.size() &gt; <span class="number">0</span>){</span><br><span class="line">           ordersList.forEach(order -&gt; {</span><br><span class="line">               order.setStatus(Orders.CANCELLED);</span><br><span class="line">               order.setCancelReason(<span class="string">"支付超时，自动取消"</span>);</span><br><span class="line">               order.setCancelTime(LocalDateTime.now());</span><br><span class="line">               orderMapper.update(order);</span><br><span class="line">           });</span><br><span class="line">       }</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<p><strong>4). 完善定时任务类的processDeliveryOrder方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 处理“派送中”状态的订单</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Scheduled(cron = "0 0 1 * * ?")</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processDeliveryOrder</span><span class="params">()</span>{</span><br><span class="line">       log.info(<span class="string">"处理派送中订单：{}"</span>, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">       <span class="comment">// select * from orders where status = 4 and order_time &lt; 当前时间-1小时</span></span><br><span class="line">       <span class="type">LocalDateTime</span> <span class="variable">time</span> <span class="operator">=</span> LocalDateTime.now().plusMinutes(-<span class="number">60</span>);</span><br><span class="line">       List&lt;Orders&gt; ordersList = orderMapper.getByStatusAndOrdertimeLT(Orders.DELIVERY_IN_PROGRESS, time);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span>(ordersList != <span class="literal">null</span> &amp;&amp; ordersList.size() &gt; <span class="number">0</span>){</span><br><span class="line">           ordersList.forEach(order -&gt; {</span><br><span class="line">               order.setStatus(Orders.COMPLETED);</span><br><span class="line">               orderMapper.update(order);</span><br><span class="line">           });</span><br><span class="line">       }</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-3-gong-neng-ce-shi">2.3 功能测试</span></h3><p>可以通过如下方式进行测试：</p>
<ul>
<li>查看控制台sql</li>
<li>查看数据库中数据变化</li>
</ul>
<p><strong>支付超时的订单测试：</strong></p>
<p><strong>1). 查看订单表</strong></p>
<p>有一条订单，状态为1。订单状态 1待付款 2待接单 3已接单 4派送中 5已完成 6已取消</p>
<img src="/2024/09/26/projection-skytogo/image-20221218202334773.png" alt="image-20221218202334773" style="zoom:50%;"> 



<p><strong>2). 开启定时任务</strong></p>
<p>启动服务，观察控制台日志。处理支付超时订单任务每隔1分钟执行一次。</p>
<img src="/2024/09/26/projection-skytogo/image-20221218203045089.png" alt="image-20221218203045089" style="zoom:50%;"> 



<p><strong>3). 再次查看订单表</strong></p>
<p>状态已更改为6，已取消。</p>
<img src="/2024/09/26/projection-skytogo/image-20221218203146535.png" alt="image-20221218203146535" style="zoom:80%;"> 

<p>证明定时任务已生效。</p>
<p><strong>处理“派送中”状态的订单任务</strong>测试自已完成，测试步骤和上述一致。可适当修改cron表达式，改变任务执行频率，方便测试。</p>
<h2><span id="3-websocket">3. WebSocket</span></h2><h3><span id="3-1-jie-shao">3.1 介绍</span></h3><p>WebSocket 是基于 TCP 的一种新的<strong>网络协议</strong>。它实现了浏览器与服务器全双工通信——浏览器和服务器只需要完成一次握手，两者之间就可以创建<strong>持久性</strong>的连接， 并进行<strong>双向</strong>数据传输。</p>
<p><strong>HTTP协议和WebSocket协议对比：</strong></p>
<ul>
<li>HTTP是<strong>短连接</strong></li>
<li>WebSocket是<strong>长连接</strong></li>
<li>HTTP通信是<strong>单向</strong>的，基于请求响应模式</li>
<li>WebSocket支持<strong>双向</strong>通信</li>
<li>HTTP和WebSocket底层都是TCP连接</li>
</ul>
<p><img src="/2024/09/26/projection-skytogo/image-20221222184340172.png" alt="image-20221222184340172" style="zoom:50%;">           <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221222184352573.png" alt="image-20221222184352573" style="zoom:50%;"> </p>
<p><strong>思考：</strong>既然WebSocket支持双向通信，功能看似比HTTP强大，那么我们是不是可以基于WebSocket开发所有的业务功能？</p>
<p><strong>WebSocket缺点：</strong></p>
<p>服务器长期维护长连接需要一定的成本<br>各个浏览器支持程度不一<br>WebSocket 是长连接，受网络限制比较大，需要处理好重连</p>
<p><strong>结论：</strong>WebSocket并不能完全取代HTTP，它只适合在特定的场景下使用</p>
<p><strong>WebSocket应用场景：</strong></p>
<p>1). 视频弹幕</p>
<p><img src="/2024/09/26/projection-skytogo/image-20221222184616570.png" alt="image-20221222184616570" style="zoom:50%;">v</p>
<p>2). 网页聊天</p>
<img src="/2024/09/26/projection-skytogo/image-20221222184641675.png" alt="image-20221222184641675" style="zoom:50%;"> 



<p>3). 体育实况更新</p>
<img src="/2024/09/26/projection-skytogo/image-20221222184714092.png" alt="image-20221222184714092" style="zoom:50%;"> 



<p>4). 股票基金报价实时更新</p>
<img src="/2024/09/26/projection-skytogo/image-20221222184742094.png" alt="image-20221222184742094" style="zoom:50%;"> 



<h3><span id="3-2-ru-men-an-li">3.2 入门案例</span></h3><h4><span id="3-2-1-an-li-fen-xi">3.2.1 案例分析</span></h4><p><strong>需求：</strong>实现浏览器与服务器全双工通信。浏览器既可以向服务器发送消息，服务器也可主动向浏览器推送消息。</p>
<p><strong>效果展示：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221222190401414.png" alt="image-20221222190401414" style="zoom:50%;"> 

<p><strong>实现步骤：</strong></p>
<p>1). 直接使用websocket.html页面作为WebSocket客户端</p>
<p>2). 导入WebSocket的maven坐标</p>
<p>3). 导入WebSocket服务端组件WebSocketServer，用于和客户端通信</p>
<p>4). 导入配置类WebSocketConfiguration，注册WebSocket的服务端组件</p>
<p>5). 导入定时任务类WebSocketTask，定时向客户端推送数据</p>
<h4><span id="3-2-2-dai-ma-kai-fa">3.2.2 代码开发</span></h4><p>1). 定义websocket.html页面(资料中已提供)</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">HTML</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>WebSocket Demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"text"</span> <span class="attr">type</span>=<span class="string">"text"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">"send()"</span>&gt;</span>发送消息<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">"closeWebSocket()"</span>&gt;</span>关闭连接<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"message"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> websocket = <span class="literal">null</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> clientId = <span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>(<span class="number">36</span>).<span class="title function_">substr</span>(<span class="number">2</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//判断当前浏览器是否支持WebSocket</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span>(<span class="string">'WebSocket'</span> <span class="keyword">in</span> <span class="variable language_">window</span>){</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//连接WebSocket节点</span></span></span><br><span class="line"><span class="language-javascript">        websocket = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">"ws://localhost:8080/ws/"</span>+clientId);</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">else</span>{</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">alert</span>(<span class="string">'Not support websocket'</span>)</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//连接发生错误的回调方法</span></span></span><br><span class="line"><span class="language-javascript">    websocket.<span class="property">onerror</span> = <span class="keyword">function</span>(<span class="params"></span>){</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">setMessageInnerHTML</span>(<span class="string">"error"</span>);</span></span><br><span class="line"><span class="language-javascript">    };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//连接成功建立的回调方法</span></span></span><br><span class="line"><span class="language-javascript">    websocket.<span class="property">onopen</span> = <span class="keyword">function</span>(<span class="params"></span>){</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">setMessageInnerHTML</span>(<span class="string">"连接成功"</span>);</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//接收到消息的回调方法</span></span></span><br><span class="line"><span class="language-javascript">    websocket.<span class="property">onmessage</span> = <span class="keyword">function</span>(<span class="params">event</span>){</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">setMessageInnerHTML</span>(event.<span class="property">data</span>);</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//连接关闭的回调方法</span></span></span><br><span class="line"><span class="language-javascript">    websocket.<span class="property">onclose</span> = <span class="keyword">function</span>(<span class="params"></span>){</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">setMessageInnerHTML</span>(<span class="string">"close"</span>);</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">window</span>.<span class="property">onbeforeunload</span> = <span class="keyword">function</span>(<span class="params"></span>){</span></span><br><span class="line"><span class="language-javascript">        websocket.<span class="title function_">close</span>();</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//将消息显示在网页上</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">setMessageInnerHTML</span>(<span class="params">innerHTML</span>){</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'message'</span>).<span class="property">innerHTML</span> += innerHTML + <span class="string">'&lt;br/&gt;'</span>;</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">//发送消息</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">send</span>(<span class="params"></span>){</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> message = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'text'</span>).<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript">        websocket.<span class="title function_">send</span>(message);</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript">	</span></span><br><span class="line"><span class="language-javascript">	<span class="comment">//关闭连接</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">closeWebSocket</span>(<span class="params"></span>) {</span></span><br><span class="line"><span class="language-javascript">        websocket.<span class="title function_">close</span>();</span></span><br><span class="line"><span class="language-javascript">    }</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<p>2). 导入maven坐标</p>
<p>在sky-server模块pom.xml中已定义</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<p>3). 定义WebSocket服务端组件(资料中已提供)</p>
<p>直接导入到sky-server模块即可</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.websocket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.OnClose;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.OnMessage;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.OnOpen;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.Session;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.PathParam;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerEndpoint;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WebSocket服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ServerEndpoint("/ws/{sid}")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">//存放会话对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Session&gt; sessionMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 连接建立成功调用的方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam("sid")</span> String sid)</span> {</span><br><span class="line">        System.out.println(<span class="string">"客户端："</span> + sid + <span class="string">"建立连接"</span>);</span><br><span class="line">        sessionMap.put(sid, session);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 收到客户端消息后调用的方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 客户端发送过来的消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, <span class="meta">@PathParam("sid")</span> String sid)</span> {</span><br><span class="line">        System.out.println(<span class="string">"收到来自客户端："</span> + sid + <span class="string">"的信息:"</span> + message);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 连接关闭调用的方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sid</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">(<span class="meta">@PathParam("sid")</span> String sid)</span> {</span><br><span class="line">        System.out.println(<span class="string">"连接断开:"</span> + sid);</span><br><span class="line">        sessionMap.remove(sid);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 群发</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendToAllClient</span><span class="params">(String message)</span> {</span><br><span class="line">        Collection&lt;Session&gt; sessions = sessionMap.values();</span><br><span class="line">        <span class="keyword">for</span> (Session session : sessions) {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="comment">//服务器向客户端发送消息</span></span><br><span class="line">                session.getBasicRemote().sendText(message);</span><br><span class="line">            } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p>4). 定义配置类，注册WebSocket的服务端组件(从资料中直接导入即可)</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.server.standard.ServerEndpointExporter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WebSocket配置类，用于注册WebSocket的Bean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketConfiguration</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ServerEndpointExporter <span class="title function_">serverEndpointExporter</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServerEndpointExporter</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p>5). 定义定时任务类，定时向客户端推送数据(从资料中直接导入即可)</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.task;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.websocket.WebSocketServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketTask</span> {</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WebSocketServer webSocketServer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过WebSocket每隔5秒向客户端发送消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = "0/5 * * * * ?")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessageToClient</span><span class="params">()</span> {</span><br><span class="line">        webSocketServer.sendToAllClient(<span class="string">"这是来自服务端的消息："</span> + DateTimeFormatter.ofPattern(<span class="string">"HH:mm:ss"</span>).format(LocalDateTime.now()));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-2-3-gong-neng-ce-shi">3.2.3 功能测试</span></h4><p>启动服务，打开websocket.html页面</p>
<p><strong>浏览器向服务器发送数据：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221222192759049.png" alt="image-20221222192759049" style="zoom:50%;"> 



<p><strong>服务器向浏览器间隔5秒推送数据：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20221222192926954.png" alt="image-20221222192926954" style="zoom:50%;"> 



<h2><span id="4-lai-dan-ti-xing">4. 来单提醒</span></h2><h3><span id="4-1-xu-qiu-fen-xi-he-she-ji">4.1 需求分析和设计</span></h3><p>用户下单并且支付成功后，需要第一时间通知外卖商家。通知的形式有如下两种：</p>
<ul>
<li>语音播报  <img src="/2024/09/26/projection-skytogo/image-20221222194413901.png" alt="image-20221222194413901" style="zoom:50%;"></li>
<li>弹出提示框</li>
</ul>
<img src="/2024/09/26/projection-skytogo/image-20221222194450142.png" alt="image-20221222194450142" style="zoom:50%;"> 



<p><strong>设计思路：</strong></p>
<ul>
<li>通过WebSocket实现管理端页面和服务端保持长连接状态</li>
<li>当客户支付后，调用WebSocket的相关API实现服务端向客户端推送消息</li>
<li>客户端浏览器解析服务端推送的消息，判断是来单提醒还是客户催单，进行相应的消息提示和语音播报</li>
<li>约定服务端发送给客户端浏览器的数据格式为JSON，字段包括：type，orderId，content<ul>
<li>type 为消息类型，1为来单提醒 2为客户催单</li>
<li>orderId 为订单id</li>
<li>content 为消息内容</li>
</ul>
</li>
</ul>
<h3><span id="4-2-dai-ma-kai-fa">4.2 代码开发</span></h3><p><strong>在OrderServiceImpl中注入WebSocketServer对象，修改paySuccess方法，加入如下代码：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> WebSocketServer webSocketServer;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 支付成功，修改订单状态</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> outTradeNo</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">paySuccess</span><span class="params">(String outTradeNo)</span> {</span><br><span class="line">       <span class="comment">// 当前登录用户id</span></span><br><span class="line">       <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> BaseContext.getCurrentId();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 根据订单号查询当前用户的订单</span></span><br><span class="line">       <span class="type">Orders</span> <span class="variable">ordersDB</span> <span class="operator">=</span> orderMapper.getByNumberAndUserId(outTradeNo, userId);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 根据订单id更新订单的状态、支付方式、支付状态、结账时间</span></span><br><span class="line">       <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> Orders.builder()</span><br><span class="line">               .id(ordersDB.getId())</span><br><span class="line">               .status(Orders.TO_BE_CONFIRMED)</span><br><span class="line">               .payStatus(Orders.PAID)</span><br><span class="line">               .checkoutTime(LocalDateTime.now())</span><br><span class="line">               .build();</span><br><span class="line"></span><br><span class="line">       orderMapper.update(orders);</span><br><span class="line">	<span class="comment">//////////////////////////////////////////////</span></span><br><span class="line">       <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">       map.put(<span class="string">"type"</span>, <span class="number">1</span>);<span class="comment">//消息类型，1表示来单提醒</span></span><br><span class="line">       map.put(<span class="string">"orderId"</span>, orders.getId());</span><br><span class="line">       map.put(<span class="string">"content"</span>, <span class="string">"订单号："</span> + outTradeNo);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//通过WebSocket实现来单提醒，向客户端浏览器推送消息</span></span><br><span class="line">       webSocketServer.sendToAllClient(JSON.toJSONString(map));</span><br><span class="line">       <span class="comment">///////////////////////////////////////////////////</span></span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-3-gong-neng-ce-shi">4.3 功能测试</span></h3><p>可以通过如下方式进行测试：</p>
<ul>
<li>查看浏览器调试工具数据交互过程</li>
<li>前后端联调</li>
</ul>
<p><strong>1). 登录管理端后台</strong></p>
<p>登录成功后，浏览器与服务器建立长连接</p>
<img src="/2024/09/26/projection-skytogo/image-20221222200842731.png" alt="image-20221222200842731" style="zoom:50%;"> 

<p>查看控制台日志</p>
<img src="/2024/09/26/projection-skytogo/image-20221222200941497.png" alt="image-20221222200941497" style="zoom:50%;"> 



<p><strong>2). 小程序端下单支付</strong></p>
<p>修改回调地址，利用内网穿透获取域名</p>
<img src="/2024/09/26/projection-skytogo/image-20221222201350616.png" alt="image-20221222201350616" style="zoom:50%;"> 



<p>下单支付</p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221222201718622.png" alt="image-20221222201718622" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221222201754866.png" alt="image-20221222201754866" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/image-20221222201826173.png" alt="image-20221222201826173" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221222202101677.png" alt="image-20221222202101677" style="zoom:50%;"></p>
<p><strong>3). 查看来单提醒</strong></p>
<p>支付成功后，后台收到来单提醒，并有语音播报</p>
<img src="/2024/09/26/projection-skytogo/image-20221222202310953.png" alt="image-20221222202310953" style="zoom:50%;"> 



<h3><span id="4-4-dai-ma-ti-jiao">4.4 代码提交</span></h3><img src="/2024/09/26/projection-skytogo/image-20221222202632141.png" alt="image-20221222202632141" style="zoom:50%;"> 

<p>后续步骤和其它功能代码提交一致，不再赘述。</p>
<h2><span id="5-ke-hu-cui-dan">5. 客户催单</span></h2><h3><span id="5-1-xu-qiu-fen-xi-he-she-ji">5.1 需求分析和设计</span></h3><p>用户在小程序中点击催单按钮后，需要第一时间通知外卖商家。通知的形式有如下两种：</p>
<ul>
<li>语音播报 <img src="/2024/09/26/projection-skytogo/image-20221222203301218.png" alt="image-20221222203301218" style="zoom:50%;"></li>
<li>弹出提示框</li>
</ul>
<img src="/2024/09/26/projection-skytogo/image-20221222203345829.png" alt="image-20221222203345829" style="zoom:50%;"> 



<p><strong>设计思路：</strong></p>
<ul>
<li>通过WebSocket实现管理端页面和服务端保持长连接状态</li>
<li>当用户点击催单按钮后，调用WebSocket的相关API实现服务端向客户端推送消息</li>
<li>客户端浏览器解析服务端推送的消息，判断是来单提醒还是客户催单，进行相应的消息提示和语音播报<br> 约定服务端发送给客户端浏览器的数据格式为JSON，字段包括：type，orderId，content<ul>
<li>type 为消息类型，1为来单提醒 2为客户催单</li>
<li>orderId 为订单id</li>
<li>content 为消息内容</li>
</ul>
</li>
</ul>
<p>当用户点击催单按钮时，向服务端发送请求。</p>
<p><strong>接口设计(催单)：</strong></p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20221222204415339.png" alt="image-20221222204415339" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/image-20221222204434174.png" alt="image-20221222204434174" style="zoom:50%;"></p>
<h3><span id="5-2-dai-ma-kai-fa">5.2 代码开发</span></h3><h4><span id="5-2-1-controller-ceng">5.2.1 Controller层</span></h4><p><strong>根据用户催单的接口定义，在user/OrderController中创建催单方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 用户催单</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@GetMapping("/reminder/{id}")</span></span><br><span class="line">   <span class="meta">@ApiOperation("用户催单")</span></span><br><span class="line">   <span class="keyword">public</span> Result <span class="title function_">reminder</span><span class="params">(<span class="meta">@PathVariable("id")</span> Long id)</span> {</span><br><span class="line">       orderService.reminder(id);</span><br><span class="line">       <span class="keyword">return</span> Result.success();</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="5-2-2-service-ceng-jie-kou">5.2.2 Service层接口</span></h4><p><strong>在OrderService接口中声明reminder方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 用户催单</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">reminder</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="5-2-3-service-ceng-shi-xian-lei">5.2.3 Service层实现类</span></h4><p><strong>在OrderServiceImpl中实现reminder方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 用户催单</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reminder</span><span class="params">(Long id)</span> {</span><br><span class="line">       <span class="comment">// 查询订单是否存在</span></span><br><span class="line">       <span class="type">Orders</span> <span class="variable">orders</span> <span class="operator">=</span> orderMapper.getById(id);</span><br><span class="line">       <span class="keyword">if</span> (orders == <span class="literal">null</span>) {</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OrderBusinessException</span>(MessageConstant.ORDER_NOT_FOUND);</span><br><span class="line">       }</span><br><span class="line"></span><br><span class="line">       <span class="comment">//基于WebSocket实现催单</span></span><br><span class="line">       <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">       map.put(<span class="string">"type"</span>, <span class="number">2</span>);<span class="comment">//2代表用户催单</span></span><br><span class="line">       map.put(<span class="string">"orderId"</span>, id);</span><br><span class="line">       map.put(<span class="string">"content"</span>, <span class="string">"订单号："</span> + orders.getNumber());</span><br><span class="line">       webSocketServer.sendToAllClient(JSON.toJSONString(map));</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<p>5.2.4 Mapper层</p>
<p><strong>在OrderMapper中添加getById：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据id查询订单</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Select("select * from orders where id=#{id}")</span></span><br><span class="line">   Orders <span class="title function_">getById</span><span class="params">(Long id)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="5-3-gong-neng-ce-shi">5.3 功能测试</span></h3><p>可以通过如下方式进行测试：</p>
<ul>
<li>查看浏览器调试工具数据交互过程</li>
<li>前后端联调</li>
</ul>
<p><strong>1). 登录管理端后台</strong></p>
<p>登录成功后，浏览器与服务器建立长连接</p>
<img src="/2024/09/26/projection-skytogo/image-20221222200842731.png" alt="image-20221222200842731" style="zoom:50%;"> 

<p>查看控制台日志</p>
<img src="/2024/09/26/projection-skytogo/image-20221222200941497.png" alt="image-20221222200941497" style="zoom:50%;"> 



<p><strong>2). 用户进行催单</strong></p>
<p>用户可在订单列表或者订单详情，进行催单</p>
<img src="/2024/09/26/projection-skytogo/image-20221222210932942.png" alt="image-20221222210932942" style="zoom:50%;"> 



<p><strong>3). 查看催单提醒</strong></p>
<p>既有催单弹窗，同时语音播报</p>
<img src="/2024/09/26/projection-skytogo/image-20221222211238000.png" alt="image-20221222211238000" style="zoom:50%;"> 



<h3><span id="5-4-dai-ma-ti-jiao">5.4 代码提交</span></h3><img src="/2024/09/26/projection-skytogo/image-20221222211740927.png" alt="image-20221222211740927" style="zoom:50%;"> 

<p>后续步骤和其它功能代码提交一致，不再赘述。</p>
<h1><span id="cang-qiong-wai-mai-day11">苍穹外卖-day11</span></h1><h2><span id="ke-cheng-nei-rong">课程内容</span></h2><ul>
<li>Apache ECharts</li>
<li>营业额统计</li>
<li>用户统计</li>
<li>订单统计</li>
<li>销量排名Top10</li>
</ul>
<p>功能实现：<strong>数据统计</strong></p>
<p><strong>数据统计效果图：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230101152725417.png" alt="image-20230101152725417" style="zoom:80%;"> 



<h2><span id="1-apache-echarts">1. Apache ECharts</span></h2><h3><span id="1-1-jie-shao">1.1 介绍</span></h3><p>Apache ECharts 是一款基于 Javascript 的数据可视化图表库，提供直观，生动，可交互，可个性化定制的数据可视化图表。<br>官网地址：<a target="_blank" rel="noopener" href="https://echarts.apache.org/zh/index.html">https://echarts.apache.org/zh/index.html</a></p>
<img src="/2024/09/26/projection-skytogo/image-20230101153041348.png" alt="image-20230101153041348" style="zoom:50%;"> 



<p><strong>常见效果展示：</strong></p>
<p>1). 柱形图</p>
<img src="/2024/09/26/projection-skytogo/image-20230101153748714.png" alt="image-20230101153748714" style="zoom:50%;"> 



<p>2). 饼形图</p>
<img src="/2024/09/26/projection-skytogo/image-20230101153230868.png" alt="image-20230101153230868" style="zoom:50%;"> 



<p>3). 折线图</p>
<img src="/2024/09/26/projection-skytogo/image-20230101153824086.png" alt="image-20230101153824086" style="zoom:50%;"> 



<p><strong>总结：</strong>不管是哪种形式的图形，最本质的东西实际上是数据，它其实是对数据的一种可视化展示。</p>
<h3><span id="1-2-ru-men-an-li">1.2 入门案例</span></h3><p>Apache Echarts官方提供的快速入门：<a target="_blank" rel="noopener" href="https://echarts.apache.org/handbook/zh/get-started/">https://echarts.apache.org/handbook/zh/get-started/</a></p>
<p><strong>效果展示：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230101155524477.png" alt="image-20230101155524477" style="zoom:50%;"> 



<p><strong>实现步骤：</strong></p>
<p>1). 引入echarts.js 文件(当天资料已提供)</p>
<p>2). 为 ECharts 准备一个设置宽高的 DOM</p>
<p>3). 初始化echarts实例</p>
<p>4). 指定图表的配置项和数据</p>
<p>5). 使用指定的配置项和数据显示图表</p>
<p><strong>代码开发：</strong></p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>ECharts<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引入刚刚下载的 ECharts 文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"echarts.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 为 ECharts 准备一个定义了宽高的 DOM --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"main"</span> <span class="attr">style</span>=<span class="string">"width: 600px;height:400px;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// 基于准备好的dom，初始化echarts实例</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">var</span> myChart = echarts.<span class="title function_">init</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'main'</span>));</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// 指定图表的配置项和数据</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">var</span> option = {</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">title</span>: {</span></span><br><span class="line"><span class="language-javascript">          <span class="attr">text</span>: <span class="string">'ECharts 入门示例'</span></span></span><br><span class="line"><span class="language-javascript">        },</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">tooltip</span>: {},</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">legend</span>: {</span></span><br><span class="line"><span class="language-javascript">          <span class="attr">data</span>: [<span class="string">'销量'</span>]</span></span><br><span class="line"><span class="language-javascript">        },</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">xAxis</span>: {</span></span><br><span class="line"><span class="language-javascript">          <span class="attr">data</span>: [<span class="string">'衬衫'</span>, <span class="string">'羊毛衫'</span>, <span class="string">'雪纺衫'</span>, <span class="string">'裤子'</span>, <span class="string">'高跟鞋'</span>, <span class="string">'袜子'</span>]</span></span><br><span class="line"><span class="language-javascript">        },</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">yAxis</span>: {},</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">series</span>: [</span></span><br><span class="line"><span class="language-javascript">          {</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">name</span>: <span class="string">'销量'</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">type</span>: <span class="string">'bar'</span>,</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">data</span>: [<span class="number">5</span>, <span class="number">20</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">20</span>]</span></span><br><span class="line"><span class="language-javascript">          }</span></span><br><span class="line"><span class="language-javascript">        ]</span></span><br><span class="line"><span class="language-javascript">      };</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// 使用刚指定的配置项和数据显示图表。</span></span></span><br><span class="line"><span class="language-javascript">      myChart.<span class="title function_">setOption</span>(option);</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<p><strong>测试：</strong>(当天资料中已提供)</p>
<img src="/2024/09/26/projection-skytogo/image-20230101160244104.png" alt="image-20230101160244104" style="zoom:50%;"> 

<p>使用浏览器方式打开即可。</p>
<p><strong>总结：</strong>使用Echarts，重点在于研究当前图表所需的数据格式。通常是需要后端提供符合格式要求的动态数据，然后响应给前端来展示图表。</p>
<h2><span id="2-ying-ye-e-tong-ji">2. 营业额统计</span></h2><h3><span id="2-1-xu-qiu-fen-xi-he-she-ji">2.1 需求分析和设计</span></h3><h4><span id="2-1-1-chan-pin-yuan-xing">2.1.1 产品原型</span></h4><p>营业额统计是基于折现图来展现，并且按照天来展示的。实际上，就是某一个时间范围之内的每一天的营业额。同时，不管光标放在哪个点上，那么它就会把具体的数值展示出来。并且还需要注意日期并不是固定写死的，是由上边时间选择器来决定。比如选择是近7天、或者是近30日，或者是本周，就会把相应这个时间段之内的每一天日期通过横坐标展示。</p>
<p><strong>原型图：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230101160747433.png" alt="image-20230101160747433" style="zoom:50%;"> 



<p><strong>业务规则：</strong></p>
<ul>
<li>营业额指订单状态为已完成的订单金额合计</li>
<li>基于可视化报表的折线图展示营业额数据，X轴为日期，Y轴为营业额</li>
<li>根据时间选择区间，展示每天的营业额数据</li>
</ul>
<h4><span id="2-1-2-jie-kou-she-ji">2.1.2 接口设计</span></h4><p>通过上述原型图，设计出对应的接口。</p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20230101160801758.png" alt="image-20230101160801758" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/image-20230101160812029.png" alt="image-20230101160812029" style="zoom:50%;"> </p>
<p><strong>注意：</strong>具体返回数据一般由前端来决定，前端展示图表，具体折现图对应数据是什么格式，是有固定的要求的。<br>所以说，后端需要去适应前端，它需要什么格式的数据，我们就给它返回什么格式的数据。</p>
<h3><span id="2-2-dai-ma-kai-fa">2.2 代码开发</span></h3><h4><span id="2-2-1-vo-she-ji">2.2.1 VO设计</span></h4><p><strong>根据接口定义设计对应的VO：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230101164058056.png" alt="image-20230101164058056" style="zoom:50%;"> 

<p>在sky-pojo模块，TurnoverReportVO.java已定义</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TurnoverReportVO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">//日期，以逗号分隔，例如：2022-10-01,2022-10-02,2022-10-03</span></span><br><span class="line">    <span class="keyword">private</span> String dateList;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//营业额，以逗号分隔，例如：406.0,1520.0,75.0</span></span><br><span class="line">    <span class="keyword">private</span> String turnoverList;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-2-2-controller-ceng">2.2.2 Controller层</span></h4><p><strong>根据接口定义创建ReportController：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.ReportService;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.TurnoverReportVO;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.format.annotation.DateTimeFormat;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 报表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/admin/report")</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = "统计报表相关接口")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReportController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ReportService reportService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 营业额数据统计</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping("/turnoverStatistics")</span></span><br><span class="line">    <span class="meta">@ApiOperation("营业额数据统计")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;TurnoverReportVO&gt; <span class="title function_">turnoverStatistics</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@DateTimeFormat(pattern = "yyyy-MM-dd")</span></span></span><br><span class="line"><span class="params">                    LocalDate begin,</span></span><br><span class="line"><span class="params">            <span class="meta">@DateTimeFormat(pattern = "yyyy-MM-dd")</span></span></span><br><span class="line"><span class="params">                    LocalDate end)</span> {</span><br><span class="line">        <span class="keyword">return</span> Result.success(reportService.getTurnover(begin, end));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-2-3-service-ceng-jie-kou">2.2.3 Service层接口</span></h4><p><strong>创建ReportService接口，声明getTurnover方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.vo.TurnoverReportVO;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ReportService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据时间区间统计营业额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beginTime</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> endTime</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    TurnoverReportVO <span class="title function_">getTurnover</span><span class="params">(LocalDate beginTime, LocalDate endTime)</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-2-4-service-ceng-shi-xian-lei">2.2.4 Service层实现类</span></h4><p><strong>创建ReportServiceImpl实现类，实现getTurnover方法:</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Orders;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.OrderMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.ReportService;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.TurnoverReportVO;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDate;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalTime;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReportServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ReportService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderMapper orderMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据时间区间统计营业额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> TurnoverReportVO <span class="title function_">getTurnover</span><span class="params">(LocalDate begin, LocalDate end)</span> {</span><br><span class="line">        List&lt;LocalDate&gt; dateList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        dateList.add(begin);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!begin.equals(end)){</span><br><span class="line">            begin = begin.plusDays(<span class="number">1</span>);<span class="comment">//日期计算，获得指定日期后1天的日期</span></span><br><span class="line">            dateList.add(begin);</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">       List&lt;Double&gt; turnoverList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (LocalDate date : dateList) {</span><br><span class="line">            <span class="type">LocalDateTime</span> <span class="variable">beginTime</span> <span class="operator">=</span> LocalDateTime.of(date, LocalTime.MIN);</span><br><span class="line">            <span class="type">LocalDateTime</span> <span class="variable">endTime</span> <span class="operator">=</span> LocalDateTime.of(date, LocalTime.MAX);</span><br><span class="line">            <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        	map.put(<span class="string">"status"</span>, Orders.COMPLETED);</span><br><span class="line">        	map.put(<span class="string">"begin"</span>,beginTime);</span><br><span class="line">        	map.put(<span class="string">"end"</span>, endTime);</span><br><span class="line">            <span class="type">Double</span> <span class="variable">turnover</span> <span class="operator">=</span> orderMapper.sumByMap(map); </span><br><span class="line">            turnover = turnover == <span class="literal">null</span> ? <span class="number">0.0</span> : turnover;</span><br><span class="line">            turnoverList.add(turnover);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//数据封装</span></span><br><span class="line">        <span class="keyword">return</span> TurnoverReportVO.builder()</span><br><span class="line">                .dateList(StringUtils.join(dateList,<span class="string">","</span>))</span><br><span class="line">                .turnoverList(StringUtils.join(turnoverList,<span class="string">","</span>))</span><br><span class="line">                .build();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-2-5-mapper-ceng">2.2.5 Mapper层</span></h4><p><strong>在OrderMapper接口声明sumByMap方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据动态条件统计营业额</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> map</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   Double <span class="title function_">sumByMap</span><span class="params">(Map map)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>在OrderMapper.xml文件中编写动态SQL：</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"sumByMap"</span> <span class="attr">resultType</span>=<span class="string">"java.lang.Double"</span>&gt;</span></span><br><span class="line">        select sum(amount) from orders</span><br><span class="line">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"status != null"</span>&gt;</span></span><br><span class="line">                and status = #{status}</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"begin != null"</span>&gt;</span></span><br><span class="line">                and order_time <span class="symbol">&amp;gt;</span>= #{begin}</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"end != null"</span>&gt;</span></span><br><span class="line">                and order_time <span class="symbol">&amp;lt;</span>= #{end}</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-3-gong-neng-ce-shi">2.3 功能测试</span></h3><p>可以通过如下方式进行测试：</p>
<ul>
<li>接口文档测试</li>
<li>前后端联调测试</li>
</ul>
<p>启动服务器，启动nginx，直接采用前后端联调测试。</p>
<p>进入数据统计模块</p>
<p><strong>1). 查看近7日营业额统计</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230101172807757.png" alt="image-20230101172807757" style="zoom:50%;"> 

<p>进入开发者模式，查看返回数据</p>
<img src="/2024/09/26/projection-skytogo/image-20230101173031357.png" alt="image-20230101173031357" style="zoom:80%;"> 



<p><strong>2). 查看近30日营业额统计</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230101173201667.png" alt="image-20230101173201667" style="zoom:50%;"> 

<p>进入开发者模式，查看返回数据</p>
<img src="/2024/09/26/projection-skytogo/image-20230101173304127.png" alt="image-20230101173304127" style="zoom:80%;"> 

<p>也可通过断点方式启动，查看每步执行情况。</p>
<h3><span id="2-4-dai-ma-ti-jiao">2.4 代码提交</span></h3><img src="/2024/09/26/projection-skytogo/image-20230107183427167.png" alt="image-20230107183427167" style="zoom:50%;"> 

<p>后续步骤和其它功能代码提交一致，不再赘述。</p>
<h2><span id="3-yong-hu-tong-ji">3. 用户统计</span></h2><h3><span id="3-1-xu-qiu-fen-xi-he-she-ji">3.1 需求分析和设计</span></h3><h4><span id="3-1-1-chan-pin-yuan-xing">3.1.1 产品原型</span></h4><p>所谓用户统计，实际上统计的是用户的数量。通过折线图来展示，上面这根蓝色线代表的是用户总量，下边这根绿色线代表的是新增用户数量，是具体到每一天。所以说用户统计主要统计<strong>两个数据</strong>，一个是<strong>总的用户数量</strong>，另外一个是<strong>新增用户数量</strong>。</p>
<p><strong>原型图：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230102213727736.png" alt="image-20230102213727736" style="zoom:50%;"> 

<p><strong>业务规则：</strong></p>
<ul>
<li>基于可视化报表的折线图展示用户数据，X轴为日期，Y轴为用户数</li>
<li>根据时间选择区间，展示每天的用户总量和新增用户量数据</li>
</ul>
<h4><span id="3-1-2-jie-kou-she-ji">3.1.2 接口设计</span></h4><p>根据上述原型图设计接口。</p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20230102213809414.png" alt="image-20230102213809414" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/image-20230102213818334.png" alt="image-20230102213818334" style="zoom:50%;"> </p>
<h3><span id="3-2-dai-ma-kai-fa">3.2 代码开发</span></h3><h4><span id="3-2-1-vo-she-ji">3.2.1 VO设计</span></h4><p><strong>根据用户统计接口的返回结果设计VO：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230102211004237.png" alt="image-20230102211004237" style="zoom:50%;"> 

<p>在sky-pojo模块，UserReportVO.java已定义</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserReportVO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">//日期，以逗号分隔，例如：2022-10-01,2022-10-02,2022-10-03</span></span><br><span class="line">    <span class="keyword">private</span> String dateList;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用户总量，以逗号分隔，例如：200,210,220</span></span><br><span class="line">    <span class="keyword">private</span> String totalUserList;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//新增用户，以逗号分隔，例如：20,21,10</span></span><br><span class="line">    <span class="keyword">private</span> String newUserList;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-2-2-controller-ceng">3.2.2 Controller层</span></h4><p><strong>根据接口定义，在ReportController中创建userStatistics方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户数据统计</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping("/userStatistics")</span></span><br><span class="line">    <span class="meta">@ApiOperation("用户数据统计")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;UserReportVO&gt; <span class="title function_">userStatistics</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@DateTimeFormat(pattern = "yyyy-MM-dd")</span> LocalDate begin,</span></span><br><span class="line"><span class="params">            <span class="meta">@DateTimeFormat(pattern = "yyyy-MM-dd")</span> LocalDate end)</span>{</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success(reportService.getUserStatistics(begin,end));            </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-2-3-service-ceng-jie-kou">3.2.3 Service层接口</span></h4><p><strong>在ReportService接口中声明getUserStatistics方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据时间区间统计用户数量</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   UserReportVO <span class="title function_">getUserStatistics</span><span class="params">(LocalDate begin, LocalDate end)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-2-4-service-ceng-shi-xian-lei">3.2.4 Service层实现类</span></h4><p><strong>在ReportServiceImpl实现类中实现getUserStatistics方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> UserReportVO <span class="title function_">getUserStatistics</span><span class="params">(LocalDate begin, LocalDate end)</span> {</span><br><span class="line">       List&lt;LocalDate&gt; dateList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">       dateList.add(begin);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">while</span> (!begin.equals(end)){</span><br><span class="line">           begin = begin.plusDays(<span class="number">1</span>);</span><br><span class="line">           dateList.add(begin);</span><br><span class="line">       }</span><br><span class="line">       List&lt;Integer&gt; newUserList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(); <span class="comment">//新增用户数</span></span><br><span class="line">       List&lt;Integer&gt; totalUserList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(); <span class="comment">//总用户数</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">for</span> (LocalDate date : dateList) {</span><br><span class="line">           <span class="type">LocalDateTime</span> <span class="variable">beginTime</span> <span class="operator">=</span> LocalDateTime.of(date, LocalTime.MIN);</span><br><span class="line">           <span class="type">LocalDateTime</span> <span class="variable">endTime</span> <span class="operator">=</span> LocalDateTime.of(date, LocalTime.MAX);</span><br><span class="line">           <span class="comment">//新增用户数量 select count(id) from user where create_time &gt; ? and create_time &lt; ?</span></span><br><span class="line">           <span class="type">Integer</span> <span class="variable">newUser</span> <span class="operator">=</span> getUserCount(beginTime, endTime);</span><br><span class="line">           <span class="comment">//总用户数量 select count(id) from user where  create_time &lt; ?</span></span><br><span class="line">           <span class="type">Integer</span> <span class="variable">totalUser</span> <span class="operator">=</span> getUserCount(<span class="literal">null</span>, endTime);</span><br><span class="line"></span><br><span class="line">           newUserList.add(newUser);</span><br><span class="line">           totalUserList.add(totalUser);</span><br><span class="line">       }</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> UserReportVO.builder()</span><br><span class="line">               .dateList(StringUtils.join(dateList,<span class="string">","</span>))</span><br><span class="line">               .newUserList(StringUtils.join(newUserList,<span class="string">","</span>))</span><br><span class="line">               .totalUserList(StringUtils.join(totalUserList,<span class="string">","</span>))</span><br><span class="line">               .build();</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>

<p><strong>在ReportServiceImpl实现类中创建私有方法getUserCount：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据时间区间统计用户数量</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> beginTime</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> endTime</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> Integer <span class="title function_">getUserCount</span><span class="params">(LocalDateTime beginTime, LocalDateTime endTime)</span> {</span><br><span class="line">       <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">       map.put(<span class="string">"begin"</span>,beginTime);</span><br><span class="line">       map.put(<span class="string">"end"</span>, endTime);</span><br><span class="line">       <span class="keyword">return</span> userMapper.countByMap(map);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-2-5-mapper-ceng">3.2.5 Mapper层</span></h4><p><strong>在UserMapper接口中声明countByMap方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据动态条件统计用户数量</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> map</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   Integer <span class="title function_">countByMap</span><span class="params">(Map map)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>在UserMapper.xml文件中编写动态SQL：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=<span class="string">"countByMap"</span> resultType=<span class="string">"java.lang.Integer"</span>&gt;</span><br><span class="line">        select <span class="title function_">count</span><span class="params">(id)</span> from user</span><br><span class="line">        &lt;where&gt;</span><br><span class="line">            &lt;<span class="keyword">if</span> test=<span class="string">"begin != null"</span>&gt;</span><br><span class="line">                and create_time &amp;gt;= #{begin}</span><br><span class="line">            &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">            &lt;<span class="keyword">if</span> test=<span class="string">"end != null"</span>&gt;</span><br><span class="line">                and create_time &amp;lt;= #{end}</span><br><span class="line">            &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">        &lt;/where&gt;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-3-gong-neng-ce-shi">3.3 功能测试</span></h3><p>可以通过如下方式进行测试：</p>
<ul>
<li>接口文档测试</li>
<li>前后端联调测试</li>
</ul>
<p>进入数据统计模块</p>
<p><strong>1). 查看近7日用户统计</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230107191339668.png" alt="image-20230107191339668" style="zoom:50%;"> 

<p>进入开发者模式，查看返回数据</p>
<img src="/2024/09/26/projection-skytogo/image-20230107191532175.png" alt="image-20230107191532175" style="zoom:50%;"> 



<p><strong>2). 查看近30日用户统计</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230107191613369.png" alt="image-20230107191613369" style="zoom:50%;"> 

<p>进入开发者模式，查看返回数据</p>
<img src="/2024/09/26/projection-skytogo/image-20230107191707568.png" alt="image-20230107191707568" style="zoom:50%;"> 

<p>也可通过断点方式启动，查看每步执行情况。</p>
<h3><span id="3-4-dai-ma-ti-jiao">3.4 代码提交</span></h3><img src="/2024/09/26/projection-skytogo/image-20230107191949566.png" alt="image-20230107191949566" style="zoom:50%;"> 

<p>后续步骤和其它功能代码提交一致，不再赘述。</p>
<h2><span id="4-ding-dan-tong-ji">4. 订单统计</span></h2><h3><span id="4-1-xu-qiu-fen-xi-he-she-ji">4.1 需求分析和设计</span></h3><h4><span id="4-1-1-chan-pin-yuan-xing">4.1.1 产品原型</span></h4><p>订单统计通过一个折现图来展现，折线图上有两根线，这根蓝色的线代表的是订单总数，而下边这根绿色的线代表的是有效订单数，指的就是状态是已完成的订单就属于有效订单，分别反映的是每一天的数据。上面还有3个数字，分别是订单总数、有效订单、订单完成率，它指的是整个时间区间之内总的数据。</p>
<p><strong>原型图：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230107192859270.png" alt="image-20230107192859270" style="zoom:50%;"> 

<p><strong>业务规则：</strong></p>
<ul>
<li>有效订单指状态为 “已完成” 的订单</li>
<li>基于可视化报表的折线图展示订单数据，X轴为日期，Y轴为订单数量</li>
<li>根据时间选择区间，展示每天的订单总数和有效订单数</li>
<li>展示所选时间区间内的有效订单数、总订单数、订单完成率，订单完成率 = 有效订单数 / 总订单数 * 100%</li>
</ul>
<h4><span id="4-1-2-jie-kou-she-ji">4.1.2 接口设计</span></h4><p>根据上述原型图设计接口。</p>
<p><img src="/2024/09/26/projection-skytogo/image-20230107192942872.png" alt="image-20230107192942872" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20230107192952958.png" alt="image-20230107192952958" style="zoom:50%;"> </p>
<h3><span id="4-2-dai-ma-kai-fa">4.2 代码开发</span></h3><h4><span id="4-2-1-vo-she-ji">4.2.1 VO设计</span></h4><p><strong>根据订单统计接口的返回结果设计VO：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230107195325915.png" alt="image-20230107195325915" style="zoom:50%;"> 

<p>在sky-pojo模块，OrderReportVO.java已定义</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderReportVO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">//日期，以逗号分隔，例如：2022-10-01,2022-10-02,2022-10-03</span></span><br><span class="line">    <span class="keyword">private</span> String dateList;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每日订单数，以逗号分隔，例如：260,210,215</span></span><br><span class="line">    <span class="keyword">private</span> String orderCountList;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每日有效订单数，以逗号分隔，例如：20,21,10</span></span><br><span class="line">    <span class="keyword">private</span> String validOrderCountList;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//订单总数</span></span><br><span class="line">    <span class="keyword">private</span> Integer totalOrderCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//有效订单数</span></span><br><span class="line">    <span class="keyword">private</span> Integer validOrderCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//订单完成率</span></span><br><span class="line">    <span class="keyword">private</span> Double orderCompletionRate;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="4-2-2-controller-ceng">4.2.2 Controller层</span></h4><p><strong>在ReportController中根据订单统计接口创建orderStatistics方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单数据统计</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping("/ordersStatistics")</span></span><br><span class="line">    <span class="meta">@ApiOperation("用户数据统计")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;OrderReportVO&gt; <span class="title function_">orderStatistics</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@DateTimeFormat(pattern = "yyyy-MM-dd")</span></span></span><br><span class="line"><span class="params">                    LocalDate begin,</span></span><br><span class="line"><span class="params">            <span class="meta">@DateTimeFormat(pattern = "yyyy-MM-dd")</span></span></span><br><span class="line"><span class="params">                    LocalDate end)</span>{</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success(reportService.getOrderStatistics(begin,end));</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="4-2-3-service-ceng-jie-kou">4.2.3 Service层接口</span></h4><p><strong>在ReportService接口中声明getOrderStatistics方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 根据时间区间统计订单数量</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> begin </span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">OrderReportVO <span class="title function_">getOrderStatistics</span><span class="params">(LocalDate begin, LocalDate end)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="4-2-4-service-ceng-shi-xian-lei">4.2.4 Service层实现类</span></h4><p><strong>在ReportServiceImpl实现类中实现getOrderStatistics方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 根据时间区间统计订单数量</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> begin </span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> OrderReportVO <span class="title function_">getOrderStatistics</span><span class="params">(LocalDate begin, LocalDate end)</span>{</span><br><span class="line">	List&lt;LocalDate&gt; dateList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    dateList.add(begin);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!begin.equals(end)){</span><br><span class="line">          begin = begin.plusDays(<span class="number">1</span>);</span><br><span class="line">          dateList.add(begin);</span><br><span class="line">     }</span><br><span class="line">    <span class="comment">//每天订单总数集合</span></span><br><span class="line">     List&lt;Integer&gt; orderCountList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//每天有效订单数集合</span></span><br><span class="line">    List&lt;Integer&gt; validOrderCountList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (LocalDate date : dateList) {</span><br><span class="line">         <span class="type">LocalDateTime</span> <span class="variable">beginTime</span> <span class="operator">=</span> LocalDateTime.of(date, LocalTime.MIN);</span><br><span class="line">         <span class="type">LocalDateTime</span> <span class="variable">endTime</span> <span class="operator">=</span> LocalDateTime.of(date, LocalTime.MAX);</span><br><span class="line">   <span class="comment">//查询每天的总订单数 select count(id) from orders where order_time &gt; ? and order_time &lt; ?</span></span><br><span class="line">         <span class="type">Integer</span> <span class="variable">orderCount</span> <span class="operator">=</span> getOrderCount(beginTime, endTime, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//查询每天的有效订单数 select count(id) from orders where order_time &gt; ? and order_time &lt; ? and status = ?</span></span><br><span class="line">         <span class="type">Integer</span> <span class="variable">validOrderCount</span> <span class="operator">=</span> getOrderCount(beginTime, endTime, Orders.COMPLETED);</span><br><span class="line"></span><br><span class="line">         orderCountList.add(orderCount);</span><br><span class="line">         validOrderCountList.add(validOrderCount);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//时间区间内的总订单数</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">totalOrderCount</span> <span class="operator">=</span> orderCountList.stream().reduce(Integer::sum).get();</span><br><span class="line">    <span class="comment">//时间区间内的总有效订单数</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">validOrderCount</span> <span class="operator">=</span> validOrderCountList.stream().reduce(Integer::sum).get();</span><br><span class="line">    <span class="comment">//订单完成率</span></span><br><span class="line">    <span class="type">Double</span> <span class="variable">orderCompletionRate</span> <span class="operator">=</span> <span class="number">0.0</span>;</span><br><span class="line">    <span class="keyword">if</span>(totalOrderCount != <span class="number">0</span>){</span><br><span class="line">         orderCompletionRate = validOrderCount.doubleValue() / totalOrderCount;</span><br><span class="line">     }</span><br><span class="line">    <span class="keyword">return</span> OrderReportVO.builder()</span><br><span class="line">                .dateList(StringUtils.join(dateList, <span class="string">","</span>))</span><br><span class="line">                .orderCountList(StringUtils.join(orderCountList, <span class="string">","</span>))</span><br><span class="line">                .validOrderCountList(StringUtils.join(validOrderCountList, <span class="string">","</span>))</span><br><span class="line">                .totalOrderCount(totalOrderCount)</span><br><span class="line">                .validOrderCount(validOrderCount)</span><br><span class="line">                .orderCompletionRate(orderCompletionRate)</span><br><span class="line">                .build();</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>在ReportServiceImpl实现类中提供私有方法getOrderCount：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 根据时间区间统计指定状态的订单数量</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> beginTime</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> endTime</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> Integer <span class="title function_">getOrderCount</span><span class="params">(LocalDateTime beginTime, LocalDateTime endTime, Integer status)</span> {</span><br><span class="line">	<span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">	map.put(<span class="string">"status"</span>, status);</span><br><span class="line">	map.put(<span class="string">"begin"</span>,beginTime);</span><br><span class="line">	map.put(<span class="string">"end"</span>, endTime);</span><br><span class="line">	<span class="keyword">return</span> orderMapper.countByMap(map);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="4-2-5-mapper-ceng">4.2.5 Mapper层</span></h4><p><strong>在OrderMapper接口中声明countByMap方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*根据动态条件统计订单数量</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> map</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">Integer <span class="title function_">countByMap</span><span class="params">(Map map)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>在OrderMapper.xml文件中编写动态SQL：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id=<span class="string">"countByMap"</span> resultType=<span class="string">"java.lang.Integer"</span>&gt;</span><br><span class="line">        select <span class="title function_">count</span><span class="params">(id)</span> from orders</span><br><span class="line">        &lt;where&gt;</span><br><span class="line">            &lt;<span class="keyword">if</span> test=<span class="string">"status != null"</span>&gt;</span><br><span class="line">                <span class="type">and</span> <span class="variable">status</span> <span class="operator">=</span> #{status}</span><br><span class="line">            &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">            &lt;<span class="keyword">if</span> test=<span class="string">"begin != null"</span>&gt;</span><br><span class="line">                and order_time &amp;gt;= #{begin}</span><br><span class="line">            &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">            &lt;<span class="keyword">if</span> test=<span class="string">"end != null"</span>&gt;</span><br><span class="line">                and order_time &amp;lt;= #{end}</span><br><span class="line">            &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">        &lt;/where&gt;</span><br><span class="line">&lt;/select&gt;</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-3-gong-neng-ce-shi">4.3 功能测试</span></h3><p>可以通过如下方式进行测试：</p>
<ul>
<li>接口文档测试</li>
<li>前后端联调</li>
</ul>
<p>重启服务，直接采用前后端联调测试。</p>
<p>进入数据统计模块</p>
<p><strong>1). 查看近7日订单统计</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230107202854533.png" alt="image-20230107202854533" style="zoom:50%;"> 

<p>进入开发者模式，查看返回数据</p>
<img src="/2024/09/26/projection-skytogo/image-20230107202953128.png" alt="image-20230107202953128" style="zoom:50%;"> 



<p><strong>2). 查看近30日订单统计</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230107203025165.png" alt="image-20230107203025165" style="zoom:50%;"> 

<p>进入开发者模式，查看返回数据</p>
<img src="/2024/09/26/projection-skytogo/image-20230107203127308.png" alt="image-20230107203127308" style="zoom:50%;"> 

<p>也可通过断点方式启动，查看每步执行情况。</p>
<h3><span id="4-4-dai-ma-ti-jiao">4.4 代码提交</span></h3><img src="/2024/09/26/projection-skytogo/image-20230107203344774.png" alt="image-20230107203344774" style="zoom:50%;"> 

<p>后续步骤和其它功能代码提交一致，不再赘述。</p>
<h2><span id="5-xiao-liang-pai-ming-top10">5. 销量排名Top10</span></h2><h3><span id="5-1-xu-qiu-fen-xi-he-she-ji">5.1 需求分析和设计</span></h3><h4><span id="5-1-1-chan-pin-yuan-xing">5.1.1 产品原型</span></h4><p>所谓销量排名，销量指的是商品销售的数量。项目当中的商品主要包含两类：一个是<strong>套餐</strong>，一个是<strong>菜品</strong>，所以销量排名其实指的就是菜品和套餐销售的数量排名。通过柱形图来展示销量排名，这些销量是按照降序来排列，并且只需要统计销量排名前十的商品。</p>
<p><strong>原型图：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230107203622747.png" alt="image-20230107203622747" style="zoom:50%;"> 

<p><strong>业务规则：</strong></p>
<ul>
<li>根据时间选择区间，展示销量前10的商品（包括菜品和套餐）</li>
<li>基于可视化报表的柱状图降序展示商品销量</li>
<li>此处的销量为商品销售的份数</li>
</ul>
<h4><span id="5-1-2-jie-kou-she-ji">5.1.2 接口设计</span></h4><p>根据上述原型图设计接口。</p>
<p><img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20230107203720606.png" alt="image-20230107203720606" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/image-20230107203730681.png" alt="image-20230107203730681" style="zoom:50%;"> </p>
<h3><span id="5-2-dai-ma-kai-fa">5.2 代码开发</span></h3><h4><span id="5-2-1-vo-she-ji">5.2.1 VO设计</span></h4><p><strong>根据销量排名接口的返回结果设计VO：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230107204028895.png" alt="image-20230107204028895" style="zoom:50%;"> 

<p>在sky-pojo模块，SalesTop10ReportVO.java已定义</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Builder;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SalesTop10ReportVO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">//商品名称列表，以逗号分隔，例如：鱼香肉丝,宫保鸡丁,水煮鱼</span></span><br><span class="line">    <span class="keyword">private</span> String nameList;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//销量列表，以逗号分隔，例如：260,215,200</span></span><br><span class="line">    <span class="keyword">private</span> String numberList;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="5-2-2-controller-ceng">5.2.2 Controller层</span></h4><p><strong>在ReportController中根据销量排名接口创建top10方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 销量排名统计</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@GetMapping("/top10")</span></span><br><span class="line"><span class="meta">@ApiOperation("销量排名统计")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;SalesTop10ReportVO&gt; <span class="title function_">top10</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@DateTimeFormat(pattern = "yyyy-MM-dd")</span> LocalDate begin,</span></span><br><span class="line"><span class="params">    <span class="meta">@DateTimeFormat(pattern = "yyyy-MM-dd")</span> LocalDate end)</span>{</span><br><span class="line">	<span class="keyword">return</span> Result.success(reportService.getSalesTop10(begin,end));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="5-2-3-service-ceng-jie-kou">5.2.3 Service层接口</span></h4><p><strong>在ReportService接口中声明getSalesTop10方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 查询指定时间区间内的销量排名top10 </span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">SalesTop10ReportVO <span class="title function_">getSalesTop10</span><span class="params">(LocalDate begin, LocalDate end)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="5-2-4-service-ceng-shi-xian-lei">5.2.4 Service层实现类</span></h4><p><strong>在ReportServiceImpl实现类中实现getSalesTop10方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询指定时间区间内的销量排名top10</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="keyword">public</span> SalesTop10ReportVO <span class="title function_">getSalesTop10</span><span class="params">(LocalDate begin, LocalDate end)</span>{</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">beginTime</span> <span class="operator">=</span> LocalDateTime.of(begin, LocalTime.MIN);</span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">endTime</span> <span class="operator">=</span> LocalDateTime.of(end, LocalTime.MAX);</span><br><span class="line">        List&lt;GoodsSalesDTO&gt; goodsSalesDTOList = orderMapper.getSalesTop10(beginTime, endTime);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">nameList</span> <span class="operator">=</span> StringUtils.join(goodsSalesDTOList.stream().map(GoodsSalesDTO::getName).collect(Collectors.toList()),<span class="string">","</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">numberList</span> <span class="operator">=</span> StringUtils.join(goodsSalesDTOList.stream().map(GoodsSalesDTO::getNumber).collect(Collectors.toList()),<span class="string">","</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> SalesTop10ReportVO.builder()</span><br><span class="line">                .nameList(nameList)</span><br><span class="line">                .numberList(numberList)</span><br><span class="line">                .build();</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="5-2-5-mapper-ceng">5.2.5 Mapper层</span></h4><p><strong>在OrderMapper接口中声明getSalesTop10方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 查询商品销量排名</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">List&lt;GoodsSalesDTO&gt; <span class="title function_">getSalesTop10</span><span class="params">(LocalDateTime begin, LocalDateTime end)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>在OrderMapper.xml文件中编写动态SQL：</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getSalesTop10"</span> <span class="attr">resultType</span>=<span class="string">"com.sky.dto.GoodsSalesDTO"</span>&gt;</span></span><br><span class="line">        select od.name name,sum(od.number) number from order_detail od ,orders o</span><br><span class="line">        where od.order_id = o.id</span><br><span class="line">            and o.status = 5</span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"begin != null"</span>&gt;</span></span><br><span class="line">                and order_time <span class="symbol">&amp;gt;</span>= #{begin}</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"end != null"</span>&gt;</span></span><br><span class="line">                and order_time <span class="symbol">&amp;lt;</span>= #{end}</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        group by name</span><br><span class="line">        order by number desc</span><br><span class="line">        limit 0, 10</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="5-3-gong-neng-ce-shi">5.3 功能测试</span></h3><p>可以通过如下方式进行测试：</p>
<ul>
<li>接口文档测试</li>
<li>前后端联调</li>
</ul>
<p>重启服务，直接采用前后端联调测试。</p>
<p><strong>查看近30日销量排名Top10统计</strong></p>
<p>若查询的某一段时间没有销量数据，则显示不出效果。</p>
<img src="/2024/09/26/projection-skytogo/image-20230107210518821.png" alt="image-20230107210518821" style="zoom:50%;"> 

<p>进入开发者模式，查看返回数据</p>
<img src="/2024/09/26/projection-skytogo/image-20230107210711326.png" alt="image-20230107210711326" style="zoom:50%;"> 

<p>也可通过断点方式启动，查看每步执行情况。</p>
<h3><span id="5-4-dai-ma-ti-jiao">5.4 代码提交</span></h3><img src="/2024/09/26/projection-skytogo/image-20230107210835115.png" alt="image-20230107210835115" style="zoom:50%;"> 

<p>后续步骤和其它功能代码提交一致，不再赘述。</p>
<h1><span id="cang-qiong-wai-mai-day12">苍穹外卖-day12</span></h1><h2><span id="ke-cheng-nei-rong">课程内容</span></h2><ul>
<li>工作台</li>
<li>Apache POI</li>
<li>导出运营数据Excel报表</li>
</ul>
<p>功能实现：<strong>工作台</strong>、<strong>数据导出</strong></p>
<p><strong>工作台效果图：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230130190031553.png" alt="image-20230130190031553" style="zoom: 50%;">  



<p><strong>数据导出效果图：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230130190124725.png" alt="image-20230130190124725" style="zoom: 50%;">   

<p>在数据统计页面点击<strong>数据导出</strong>：生成Excel报表</p>
<img src="/2024/09/26/projection-skytogo/image-20230130190243865.png" alt="image-20230130190243865" style="zoom: 50%;">    



<h2><span id="1-gong-zuo-tai">1. 工作台</span></h2><h3><span id="1-1-xu-qiu-fen-xi-he-she-ji">1.1 需求分析和设计</span></h3><h4><span id="1-1-1-chan-pin-yuan-xing">1.1.1 产品原型</span></h4><p>工作台是系统运营的数据看板，并提供快捷操作入口，可以有效提高商家的工作效率。</p>
<p><strong>工作台展示的数据：</strong></p>
<ul>
<li>今日数据</li>
<li>订单管理</li>
<li>菜品总览</li>
<li>套餐总览</li>
<li>订单信息</li>
</ul>
<p><strong>原型图：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230130191051003.png" alt="image-20230130191051003" style="zoom:50%;"> 



<p><strong>名词解释：</strong></p>
<ul>
<li>营业额：已完成订单的总金额</li>
<li>有效订单：已完成订单的数量</li>
<li>订单完成率：有效订单数 / 总订单数 * 100%</li>
<li>平均客单价：营业额 / 有效订单数</li>
<li>新增用户：新增用户的数量</li>
</ul>
<h4><span id="1-1-2-jie-kou-she-ji">1.1.2 接口设计</span></h4><p>通过上述原型图分析，共包含6个接口。</p>
<p><strong>接口设计：</strong></p>
<ul>
<li>今日数据接口</li>
<li>订单管理接口</li>
<li>菜品总览接口</li>
<li>套餐总览接口</li>
<li>订单搜索（已完成）</li>
<li>各个状态的订单数量统计（已完成）</li>
</ul>
<p><strong>1). 今日数据的接口设计</strong></p>
<p><img src="/2024/09/26/projection-skytogo/image-20230130191820764.png" alt="image-20230130191820764" style="zoom:50%;"> <img src="/2024/09/26/projection-skytogo/../../sky-take-out/讲义/assets/image-20230130191837090.png" alt="image-20230130191837090" style="zoom:50%;"></p>
<p><strong>2). 订单管理的接口设计</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230130192105373.png" alt="image-20230130192105373" style="zoom:50%;"> 



<p><strong>3). 菜品总览的接口设计</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230130192225168.png" alt="image-20230130192225168" style="zoom:50%;"> 



<p><strong>4). 套餐总览的接口设计</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230130195425389.png" alt="image-20230130195425389" style="zoom:50%;"> 



<h3><span id="1-2-dai-ma-dao-ru">1.2 代码导入</span></h3><p>直接导入课程资料中的工作台模块功能代码即可：</p>
<img src="/2024/09/26/projection-skytogo/image-20230130195535421.png" alt="image-20230130195535421" style="zoom:50%;"> 

<h4><span id="1-2-1-controller-ceng">1.2.1 Controller层</span></h4><p><strong>添加WorkSpaceController.java</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.controller.admin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.WorkspaceService;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.BusinessDataVO;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.DishOverViewVO;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.OrderOverViewVO;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.SetmealOverViewVO;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 工作台</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/admin/workspace")</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Api(tags = "工作台相关接口")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WorkSpaceController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WorkspaceService workspaceService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 工作台今日数据查询</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping("/businessData")</span></span><br><span class="line">    <span class="meta">@ApiOperation("工作台今日数据查询")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;BusinessDataVO&gt; <span class="title function_">businessData</span><span class="params">()</span>{</span><br><span class="line">        <span class="comment">//获得当天的开始时间</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">begin</span> <span class="operator">=</span> LocalDateTime.now().with(LocalTime.MIN);</span><br><span class="line">        <span class="comment">//获得当天的结束时间</span></span><br><span class="line">        <span class="type">LocalDateTime</span> <span class="variable">end</span> <span class="operator">=</span> LocalDateTime.now().with(LocalTime.MAX);</span><br><span class="line"></span><br><span class="line">        <span class="type">BusinessDataVO</span> <span class="variable">businessDataVO</span> <span class="operator">=</span> workspaceService.getBusinessData(begin, end);</span><br><span class="line">        <span class="keyword">return</span> Result.success(businessDataVO);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询订单管理数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping("/overviewOrders")</span></span><br><span class="line">    <span class="meta">@ApiOperation("查询订单管理数据")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;OrderOverViewVO&gt; <span class="title function_">orderOverView</span><span class="params">()</span>{</span><br><span class="line">        <span class="keyword">return</span> Result.success(workspaceService.getOrderOverView());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询菜品总览</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping("/overviewDishes")</span></span><br><span class="line">    <span class="meta">@ApiOperation("查询菜品总览")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;DishOverViewVO&gt; <span class="title function_">dishOverView</span><span class="params">()</span>{</span><br><span class="line">        <span class="keyword">return</span> Result.success(workspaceService.getDishOverView());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询套餐总览</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping("/overviewSetmeals")</span></span><br><span class="line">    <span class="meta">@ApiOperation("查询套餐总览")</span></span><br><span class="line">    <span class="keyword">public</span> Result&lt;SetmealOverViewVO&gt; <span class="title function_">setmealOverView</span><span class="params">()</span>{</span><br><span class="line">        <span class="keyword">return</span> Result.success(workspaceService.getSetmealOverView());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="1-2-2-service-ceng-jie-kou">1.2.2 Service层接口</span></h4><p><strong>添加WorkspaceService.java</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.vo.BusinessDataVO;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.DishOverViewVO;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.OrderOverViewVO;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.SetmealOverViewVO;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">WorkspaceService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据时间段统计营业数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    BusinessDataVO <span class="title function_">getBusinessData</span><span class="params">(LocalDateTime begin, LocalDateTime end)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询订单管理数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    OrderOverViewVO <span class="title function_">getOrderOverView</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询菜品总览</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    DishOverViewVO <span class="title function_">getDishOverView</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询套餐总览</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SetmealOverViewVO <span class="title function_">getSetmealOverView</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="1-2-3-service-ceng-shi-xian-lei">1.2.3 Service层实现类</span></h4><p><strong>添加WorkspaceServiceImpl.java</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sky.constant.StatusConstant;</span><br><span class="line"><span class="keyword">import</span> com.sky.entity.Orders;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.DishMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.OrderMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.SetmealMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.sky.service.WorkspaceService;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.BusinessDataVO;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.DishOverViewVO;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.OrderOverViewVO;</span><br><span class="line"><span class="keyword">import</span> com.sky.vo.SetmealOverViewVO;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalTime;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WorkspaceServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">WorkspaceService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderMapper orderMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DishMapper dishMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SetmealMapper setmealMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据时间段统计营业数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> begin</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> BusinessDataVO <span class="title function_">getBusinessData</span><span class="params">(LocalDateTime begin, LocalDateTime end)</span> {</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 营业额：当日已完成订单的总金额</span></span><br><span class="line"><span class="comment">         * 有效订单：当日已完成订单的数量</span></span><br><span class="line"><span class="comment">         * 订单完成率：有效订单数 / 总订单数</span></span><br><span class="line"><span class="comment">         * 平均客单价：营业额 / 有效订单数</span></span><br><span class="line"><span class="comment">         * 新增用户：当日新增用户的数量</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map.put(<span class="string">"begin"</span>,begin);</span><br><span class="line">        map.put(<span class="string">"end"</span>,end);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询总订单数</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">totalOrderCount</span> <span class="operator">=</span> orderMapper.countByMap(map);</span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">"status"</span>, Orders.COMPLETED);</span><br><span class="line">        <span class="comment">//营业额</span></span><br><span class="line">        <span class="type">Double</span> <span class="variable">turnover</span> <span class="operator">=</span> orderMapper.sumByMap(map);</span><br><span class="line">        turnover = turnover == <span class="literal">null</span>? <span class="number">0.0</span> : turnover;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//有效订单数</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">validOrderCount</span> <span class="operator">=</span> orderMapper.countByMap(map);</span><br><span class="line"></span><br><span class="line">        <span class="type">Double</span> <span class="variable">unitPrice</span> <span class="operator">=</span> <span class="number">0.0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">Double</span> <span class="variable">orderCompletionRate</span> <span class="operator">=</span> <span class="number">0.0</span>;</span><br><span class="line">        <span class="keyword">if</span>(totalOrderCount != <span class="number">0</span> &amp;&amp; validOrderCount != <span class="number">0</span>){</span><br><span class="line">            <span class="comment">//订单完成率</span></span><br><span class="line">            orderCompletionRate = validOrderCount.doubleValue() / totalOrderCount;</span><br><span class="line">            <span class="comment">//平均客单价</span></span><br><span class="line">            unitPrice = turnover / validOrderCount;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//新增用户数</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">newUsers</span> <span class="operator">=</span> userMapper.countByMap(map);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> BusinessDataVO.builder()</span><br><span class="line">                .turnover(turnover)</span><br><span class="line">                .validOrderCount(validOrderCount)</span><br><span class="line">                .orderCompletionRate(orderCompletionRate)</span><br><span class="line">                .unitPrice(unitPrice)</span><br><span class="line">                .newUsers(newUsers)</span><br><span class="line">                .build();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询订单管理数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> OrderOverViewVO <span class="title function_">getOrderOverView</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map.put(<span class="string">"begin"</span>, LocalDateTime.now().with(LocalTime.MIN));</span><br><span class="line">        map.put(<span class="string">"status"</span>, Orders.TO_BE_CONFIRMED);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//待接单</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">waitingOrders</span> <span class="operator">=</span> orderMapper.countByMap(map);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//待派送</span></span><br><span class="line">        map.put(<span class="string">"status"</span>, Orders.CONFIRMED);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">deliveredOrders</span> <span class="operator">=</span> orderMapper.countByMap(map);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//已完成</span></span><br><span class="line">        map.put(<span class="string">"status"</span>, Orders.COMPLETED);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">completedOrders</span> <span class="operator">=</span> orderMapper.countByMap(map);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//已取消</span></span><br><span class="line">        map.put(<span class="string">"status"</span>, Orders.CANCELLED);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">cancelledOrders</span> <span class="operator">=</span> orderMapper.countByMap(map);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//全部订单</span></span><br><span class="line">        map.put(<span class="string">"status"</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">allOrders</span> <span class="operator">=</span> orderMapper.countByMap(map);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> OrderOverViewVO.builder()</span><br><span class="line">                .waitingOrders(waitingOrders)</span><br><span class="line">                .deliveredOrders(deliveredOrders)</span><br><span class="line">                .completedOrders(completedOrders)</span><br><span class="line">                .cancelledOrders(cancelledOrders)</span><br><span class="line">                .allOrders(allOrders)</span><br><span class="line">                .build();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询菜品总览</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> DishOverViewVO <span class="title function_">getDishOverView</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map.put(<span class="string">"status"</span>, StatusConstant.ENABLE);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">sold</span> <span class="operator">=</span> dishMapper.countByMap(map);</span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">"status"</span>, StatusConstant.DISABLE);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">discontinued</span> <span class="operator">=</span> dishMapper.countByMap(map);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> DishOverViewVO.builder()</span><br><span class="line">                .sold(sold)</span><br><span class="line">                .discontinued(discontinued)</span><br><span class="line">                .build();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询套餐总览</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> SetmealOverViewVO <span class="title function_">getSetmealOverView</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map.put(<span class="string">"status"</span>, StatusConstant.ENABLE);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">sold</span> <span class="operator">=</span> setmealMapper.countByMap(map);</span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">"status"</span>, StatusConstant.DISABLE);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">discontinued</span> <span class="operator">=</span> setmealMapper.countByMap(map);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> SetmealOverViewVO.builder()</span><br><span class="line">                .sold(sold)</span><br><span class="line">                .discontinued(discontinued)</span><br><span class="line">                .build();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="1-2-4-mapper-ceng">1.2.4 Mapper层</span></h4><p><strong>在SetmealMapper中添加countByMap方法定义</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据条件统计套餐数量</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> map</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   Integer <span class="title function_">countByMap</span><span class="params">(Map map)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>在SetmealMapper.xml中添加对应SQL实现</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"countByMap"</span> <span class="attr">resultType</span>=<span class="string">"java.lang.Integer"</span>&gt;</span></span><br><span class="line">        select count(id) from setmeal</span><br><span class="line">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"status != null"</span>&gt;</span></span><br><span class="line">                and status = #{status}</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"categoryId != null"</span>&gt;</span></span><br><span class="line">                and category_id = #{categoryId}</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<p><strong>在DishMapper中添加countByMap方法定义</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据条件统计菜品数量</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> map</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   Integer <span class="title function_">countByMap</span><span class="params">(Map map)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>在DishMapper.xml中添加对应SQL实现</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"countByMap"</span> <span class="attr">resultType</span>=<span class="string">"java.lang.Integer"</span>&gt;</span></span><br><span class="line">        select count(id) from dish</span><br><span class="line">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"status != null"</span>&gt;</span></span><br><span class="line">                and status = #{status}</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"categoryId != null"</span>&gt;</span></span><br><span class="line">                and category_id = #{categoryId}</span><br><span class="line">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="1-3-gong-neng-ce-shi">1.3 功能测试</span></h3><p>可以通过如下方式进行测试：</p>
<ul>
<li>通过接口文档测试</li>
<li>前后端联调测试</li>
</ul>
<p>接下来我们使用上述两种方式分别测试。</p>
<h4><span id="1-3-1-jie-kou-wen-dang-ce-shi">1.3.1 接口文档测试</span></h4><p><strong>启动服务</strong>，访问<a target="_blank" rel="noopener" href="http://localhost:8080/doc.html%EF%BC%8C%E8%BF%9B%E5%85%A5%E5%B7%A5%E4%BD%9C%E5%8F%B0%E7%9B%B8%E5%85%B3%E6%8E%A5%E5%8F%A3">http://localhost:8080/doc.html，进入工作台相关接口</a></p>
<p><strong>注意：</strong>使用admin用户登录重新获取token，在全局参数设置中添加，防止token失效。</p>
<p><strong>1). 今日数据查询</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230131103600918.png" alt="image-20230131103600918" style="zoom:50%;"> 



<p><strong>2). 菜品总览查询</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230131103714898.png" alt="image-20230131103714898" style="zoom:50%;"> 



<p><strong>3). 订单管理数据查询</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230131103808342.png" alt="image-20230131103808342" style="zoom:50%;"> 



<p><strong>4). 套餐总览查询</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230131103903802.png" alt="image-20230131103903802" style="zoom:50%;"> 



<h4><span id="1-3-2-qian-hou-duan-lian-diao-ce-shi">1.3.2 前后端联调测试</span></h4><p><strong>启动nginx</strong>,访问 <a target="_blank" rel="noopener" href="http://localhost,进入工作台/">http://localhost，进入工作台</a></p>
<img src="/2024/09/26/projection-skytogo/image-20230131104243713.png" alt="image-20230131104243713" style="zoom:50%;"> 

<p>进入开发者模式，分别查看今日数据、订单管理、菜品总览、套餐总览</p>
<p><strong>1). 今日数据查询</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230131104849876.png" alt="image-20230131104849876" style="zoom:50%;"> 



<p><strong>2). 订单管理数据查询</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230131104939694.png" alt="image-20230131104939694" style="zoom:50%;"> 



<p><strong>3). 菜品总览查询</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230131105023109.png" alt="image-20230131105023109" style="zoom:50%;"> 



<p><strong>4). 套餐总览查询</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230131105123610.png" alt="image-20230131105123610" style="zoom:50%;"> 



<h3><span id="1-4-dai-ma-ti-jiao">1.4 代码提交</span></h3><img src="/2024/09/26/projection-skytogo/image-20230131105528906.png" alt="image-20230131105528906" style="zoom:50%;"> 

<p>后续步骤和其它功能代码提交一致，不再赘述。</p>
<h2><span id="2-apache-poi">2. Apache POI</span></h2><h3><span id="2-1-jie-shao">2.1 介绍</span></h3><p>Apache POI 是一个处理Miscrosoft Office各种文件格式的开源项目。简单来说就是，我们可以使用 POI 在 Java 程序中对Miscrosoft Office各种文件进行读写操作。<br>一般情况下，POI 都是用于操作 Excel 文件。</p>
<img src="/2024/09/26/projection-skytogo/image-20230131110631081.png" alt="image-20230131110631081" style="zoom:50%;"> 

<p><strong>Apache POI 的应用场景：</strong></p>
<ul>
<li><p>银行网银系统导出交易明细</p>
 <img src="/2024/09/26/projection-skytogo/image-20230131110810568.png" alt="image-20230131110810568" style="zoom:50%;"> 
</li>
<li><p>各种业务系统导出Excel报表</p>
 <img src="/2024/09/26/projection-skytogo/image-20230131110839959.png" alt="image-20230131110839959" style="zoom:50%;"> 
</li>
<li><p>批量导入业务数据</p>
 <img src="/2024/09/26/projection-skytogo/image-20230131110856903.png" alt="image-20230131110856903" style="zoom:50%;"></li>
</ul>
<h3><span id="2-2-ru-men-an-li">2.2 入门案例</span></h3><p>Apache POI既可以将数据写入Excel文件，也可以读取Excel文件中的数据，接下来分别进行实现。</p>
<p><strong>Apache POI的maven坐标：</strong>(项目中已导入)</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi-ooxml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-2-1-jiang-shu-ju-xie-ru-excel-wen-jian">2.2.1 将数据写入Excel文件</span></h4><p><strong>1). 代码开发</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFCell;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFRow;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFSheet;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFWorkbook;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">POITest</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 基于POI向Excel文件写入数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">()</span> <span class="keyword">throws</span> Exception{</span><br><span class="line">        <span class="comment">//在内存中创建一个Excel文件对象</span></span><br><span class="line">        <span class="type">XSSFWorkbook</span> <span class="variable">excel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XSSFWorkbook</span>();</span><br><span class="line">        <span class="comment">//创建Sheet页</span></span><br><span class="line">        <span class="type">XSSFSheet</span> <span class="variable">sheet</span> <span class="operator">=</span> excel.createSheet(<span class="string">"itcast"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//在Sheet页中创建行，0表示第1行</span></span><br><span class="line">        <span class="type">XSSFRow</span> <span class="variable">row1</span> <span class="operator">=</span> sheet.createRow(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">//创建单元格并在单元格中设置值，单元格编号也是从0开始，1表示第2个单元格</span></span><br><span class="line">        row1.createCell(<span class="number">1</span>).setCellValue(<span class="string">"姓名"</span>);</span><br><span class="line">        row1.createCell(<span class="number">2</span>).setCellValue(<span class="string">"城市"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">XSSFRow</span> <span class="variable">row2</span> <span class="operator">=</span> sheet.createRow(<span class="number">1</span>);</span><br><span class="line">        row2.createCell(<span class="number">1</span>).setCellValue(<span class="string">"张三"</span>);</span><br><span class="line">        row2.createCell(<span class="number">2</span>).setCellValue(<span class="string">"北京"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">XSSFRow</span> <span class="variable">row3</span> <span class="operator">=</span> sheet.createRow(<span class="number">2</span>);</span><br><span class="line">        row3.createCell(<span class="number">1</span>).setCellValue(<span class="string">"李四"</span>);</span><br><span class="line">        row3.createCell(<span class="number">2</span>).setCellValue(<span class="string">"上海"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">"D:\\itcast.xlsx"</span>));</span><br><span class="line">        <span class="comment">//通过输出流将内存中的Excel文件写入到磁盘上</span></span><br><span class="line">        excel.write(out);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//关闭资源</span></span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">        excel.close();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        write();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>2). 实现效果</strong></p>
<p>在D盘中生成itcast.xlsx文件，创建名称为itcast的Sheet页，同时将内容成功写入。</p>
<img src="/2024/09/26/projection-skytogo/image-20230131112905034.png" alt="image-20230131112905034" style="zoom:50%;"> 



<h4><span id="2-2-2-du-qu-excel-wen-jian-zhong-de-shu-ju">2.2.2 读取Excel文件中的数据</span></h4><p><strong>1). 代码开发</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sky.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFCell;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFRow;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFSheet;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFWorkbook;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">POITest</span> {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 基于POI读取Excel文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">read</span><span class="params">()</span> <span class="keyword">throws</span> Exception{</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">"D:\\itcast.xlsx"</span>));</span><br><span class="line">        <span class="comment">//通过输入流读取指定的Excel文件</span></span><br><span class="line">        <span class="type">XSSFWorkbook</span> <span class="variable">excel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XSSFWorkbook</span>(in);</span><br><span class="line">        <span class="comment">//获取Excel文件的第1个Sheet页</span></span><br><span class="line">        <span class="type">XSSFSheet</span> <span class="variable">sheet</span> <span class="operator">=</span> excel.getSheetAt(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取Sheet页中的最后一行的行号</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">lastRowNum</span> <span class="operator">=</span> sheet.getLastRowNum();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= lastRowNum; i++) {</span><br><span class="line">            <span class="comment">//获取Sheet页中的行</span></span><br><span class="line">            <span class="type">XSSFRow</span> <span class="variable">titleRow</span> <span class="operator">=</span> sheet.getRow(i);</span><br><span class="line">            <span class="comment">//获取行的第2个单元格</span></span><br><span class="line">            <span class="type">XSSFCell</span> <span class="variable">cell1</span> <span class="operator">=</span> titleRow.getCell(<span class="number">1</span>);</span><br><span class="line">            <span class="comment">//获取单元格中的文本内容</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">cellValue1</span> <span class="operator">=</span> cell1.getStringCellValue();</span><br><span class="line">            <span class="comment">//获取行的第3个单元格</span></span><br><span class="line">            <span class="type">XSSFCell</span> <span class="variable">cell2</span> <span class="operator">=</span> titleRow.getCell(<span class="number">2</span>);</span><br><span class="line">            <span class="comment">//获取单元格中的文本内容</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">cellValue2</span> <span class="operator">=</span> cell2.getStringCellValue();</span><br><span class="line"></span><br><span class="line">            System.out.println(cellValue1 + <span class="string">" "</span> +cellValue2);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//关闭资源</span></span><br><span class="line">        in.close();</span><br><span class="line">        excel.close();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        read();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>



<p><strong>2). 实现效果</strong></p>
<p>将itcast.xlsx文件中的数据进行读取</p>
<img src="/2024/09/26/projection-skytogo/image-20230131113255962.png" alt="image-20230131113255962" style="zoom:50%;"> 



<h2><span id="3-dao-chu-yun-ying-shu-ju-excel-bao-biao">3. 导出运营数据Excel报表</span></h2><h3><span id="3-1-xu-qiu-fen-xi-he-she-ji">3.1 需求分析和设计</span></h3><h4><span id="3-1-1-chan-pin-yuan-xing">3.1.1 产品原型</span></h4><p>在数据统计页面，有一个数据导出的按钮，点击该按钮时，其实就会下载一个文件。这个文件实际上是一个Excel形式的文件，文件中主要包含最近30日运营相关的数据。表格的形式已经固定，主要由概览数据和明细数据两部分组成。真正导出这个报表之后，相对应的数字就会填充在表格中，就可以进行存档。</p>
<p><strong>原型图：</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230131151132672.png" alt="image-20230131151132672" style="zoom:50%;"> 

<p>导出的Excel报表格式：</p>
<img src="/2024/09/26/projection-skytogo/image-20230130201026785.png" alt="image-20230130201026785" style="zoom: 67%;">  



<p><strong>业务规则：</strong></p>
<ul>
<li>导出Excel形式的报表文件</li>
<li>导出最近30天的运营数据</li>
</ul>
<h4><span id="3-1-2-jie-kou-she-ji">3.1.2 接口设计</span></h4><p>通过上述原型图设计对应的接口。</p>
<img src="/2024/09/26/projection-skytogo/image-20230130201109280.png" alt="image-20230130201109280" style="zoom:50%;"> 

<p><strong>注意：</strong></p>
<ul>
<li><p>当前接口没有传递参数，因为导出的是最近30天的运营数据，后端计算即可，所以不需要任何参数</p>
</li>
<li><p>当前接口没有返回数据，因为报表导出功能本质上是文件下载，服务端会通过输出流将Excel文件下载到客户端浏览器</p>
</li>
</ul>
<h3><span id="3-2-dai-ma-kai-fa">3.2 代码开发</span></h3><h4><span id="3-2-1-shi-xian-bu-zou">3.2.1 实现步骤</span></h4><p>1). 设计Excel模板文件</p>
<p>2). 查询近30天的运营数据</p>
<p>3). 将查询到的运营数据写入模板文件</p>
<p>4). 通过输出流将Excel文件下载到客户端浏览器</p>
<img src="/2024/09/26/projection-skytogo/image-20230131152610559.png" alt="image-20230131152610559" style="zoom:50%;"> 

<h4><span id="3-2-2-controller-ceng">3.2.2 Controller层</span></h4><p><strong>根据接口定义，在ReportController中创建export方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 导出运营数据报表</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@GetMapping("/export")</span></span><br><span class="line">   <span class="meta">@ApiOperation("导出运营数据报表")</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">export</span><span class="params">(HttpServletResponse response)</span>{</span><br><span class="line">       reportService.exportBusinessData(response);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-2-3-service-ceng-jie-kou">3.2.3 Service层接口</span></h4><p><strong>在ReportService接口中声明导出运营数据报表的方法：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 导出近30天的运营数据报表</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">exportBusinessData</span><span class="params">(HttpServletResponse response)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-2-4-service-ceng-shi-xian-lei">3.2.4 Service层实现类</span></h4><p><strong>在ReportServiceImpl实现类中实现导出运营数据报表的方法:</strong></p>
<p>提前将资料中的<strong>运营数据报表模板.xlsx</strong>拷贝到项目的resources/template目录中</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**导出近30天的运营数据报表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exportBusinessData</span><span class="params">(HttpServletResponse response)</span> {</span><br><span class="line">    <span class="type">LocalDate</span> <span class="variable">begin</span> <span class="operator">=</span> LocalDate.now().minusDays(<span class="number">30</span>);</span><br><span class="line">    <span class="type">LocalDate</span> <span class="variable">end</span> <span class="operator">=</span> LocalDate.now().minusDays(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">//查询概览运营数据，提供给Excel模板文件</span></span><br><span class="line">    <span class="type">BusinessDataVO</span> <span class="variable">businessData</span> <span class="operator">=</span> workspaceService.getBusinessData(LocalDateTime.of(begin,LocalTime.MIN), LocalDateTime.of(end, LocalTime.MAX));</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getClassLoader().getResourceAsStream(<span class="string">"template/运营数据报表模板.xlsx"</span>);</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">//基于提供好的模板文件创建一个新的Excel表格对象</span></span><br><span class="line">        <span class="type">XSSFWorkbook</span> <span class="variable">excel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XSSFWorkbook</span>(inputStream);</span><br><span class="line">        <span class="comment">//获得Excel文件中的一个Sheet页</span></span><br><span class="line">        <span class="type">XSSFSheet</span> <span class="variable">sheet</span> <span class="operator">=</span> excel.getSheet(<span class="string">"Sheet1"</span>);</span><br><span class="line"></span><br><span class="line">        sheet.getRow(<span class="number">1</span>).getCell(<span class="number">1</span>).setCellValue(begin + <span class="string">"至"</span> + end);</span><br><span class="line">        <span class="comment">//获得第4行</span></span><br><span class="line">        <span class="type">XSSFRow</span> <span class="variable">row</span> <span class="operator">=</span> sheet.getRow(<span class="number">3</span>);</span><br><span class="line">        <span class="comment">//获取单元格</span></span><br><span class="line">        row.getCell(<span class="number">2</span>).setCellValue(businessData.getTurnover());</span><br><span class="line">        row.getCell(<span class="number">4</span>).setCellValue(businessData.getOrderCompletionRate());</span><br><span class="line">        row.getCell(<span class="number">6</span>).setCellValue(businessData.getNewUsers());</span><br><span class="line">        row = sheet.getRow(<span class="number">4</span>);</span><br><span class="line">        row.getCell(<span class="number">2</span>).setCellValue(businessData.getValidOrderCount());</span><br><span class="line">        row.getCell(<span class="number">4</span>).setCellValue(businessData.getUnitPrice());</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">30</span>; i++) {</span><br><span class="line">            <span class="type">LocalDate</span> <span class="variable">date</span> <span class="operator">=</span> begin.plusDays(i);</span><br><span class="line">           <span class="comment">//准备明细数据</span></span><br><span class="line">            businessData = workspaceService.getBusinessData(LocalDateTime.of(date,LocalTime.MIN), LocalDateTime.of(date, LocalTime.MAX));</span><br><span class="line">            row = sheet.getRow(<span class="number">7</span> + i);</span><br><span class="line">            row.getCell(<span class="number">1</span>).setCellValue(date.toString());</span><br><span class="line">            row.getCell(<span class="number">2</span>).setCellValue(businessData.getTurnover());</span><br><span class="line">            row.getCell(<span class="number">3</span>).setCellValue(businessData.getValidOrderCount());</span><br><span class="line">            row.getCell(<span class="number">4</span>).setCellValue(businessData.getOrderCompletionRate());</span><br><span class="line">            row.getCell(<span class="number">5</span>).setCellValue(businessData.getUnitPrice());</span><br><span class="line">            row.getCell(<span class="number">6</span>).setCellValue(businessData.getNewUsers());</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//通过输出流将文件下载到客户端浏览器中</span></span><br><span class="line">        <span class="type">ServletOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">        excel.write(out);</span><br><span class="line">        <span class="comment">//关闭资源</span></span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">        excel.close();</span><br><span class="line"></span><br><span class="line">    }<span class="keyword">catch</span> (IOException e){</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-3-gong-neng-ce-shi">3.3 功能测试</span></h3><p>直接使用前后端联调测试。</p>
<p><strong>进入数据统计</strong></p>
<img src="/2024/09/26/projection-skytogo/image-20230131155111294.png" alt="image-20230131155111294" style="zoom:50%;"> 

<p><strong>点击数据导出</strong>：Excel报表下载成功</p>
<img src="/2024/09/26/projection-skytogo/image-20230131160647328.png" alt="image-20230131160647328" style="zoom:50%;"> 



<h3><span id="3-4-dai-ma-ti-jiao">3.4 代码提交</span></h3><img src="/2024/09/26/projection-skytogo/image-20230131160929202.png" alt="image-20230131160929202" style="zoom:50%;"> 

<p>后续步骤和其它功能代码提交一致，不再赘述。</p>

        </div>



    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        
            <script src='https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js'></script>
            <script>
                if (window.mermaid) {
                    mermaid.initialize({
                        startOnLoad: true,
                        theme: 'neural',
                    });
                }
            </script>
        
        <span>© zoe | <a href="https://hexo.io" target="_blank"></a>  <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank"></a>
              
                <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<span class="site-uv">

👤

 <i class="busuanzi-value" id="busuanzi_value_site_uv"></i>

</span>&nbsp;





<span class="site-pv">

 | 👁️

 <i class="busuanzi-value" id="busuanzi_value_site_pv"></i>

</span>


  
               
        </span>
    </div>
</footer>

    </div>

    <!-- 搜索功能 -->
    <!-- Chic/layout.ejs -->
    <div id="u-search">
        <div class="modal">
            <div class="modal-header">
                <div class="container">
                    <form id="u-search-modal-form" class="u-search-modal-form">
                        <button type="submit" class="form-submit-btn">
                            <img src="/image/search.png" class="search-btn-img" />
                        </button>
                        <input placeholder="搜索文章。。。" class="form-input" onchange="inputChange(event)" id="modal-form-input">
                    </form>
                    <a class="modal-close">x</a>
                </div>
                <div class="search-loading">
                    <div class="search-loading-bar"></div>
                </div>
            </div>
            <div class="modal-body">
                <!-- <ul class="modal-results">
                    <li class="result-item">
                        <a class="result-item-detail">
                            <span class="title">页面配置</span>
                            <span class="content">
                                网址，例如： front-matter---layout: postdate: <b mark></b>
                                7-07-05title: [转]如何搭建基于Hexo的独立博客categories: [Dev, Hexo]tags: - Hexoauthor: name: xaoxuu avatar: https://cdn.jsdelivr.......
                            </span>
                        </a>
                    </li>
                </ul> -->
            </div>
        </div>
        <div class="modal-overlay"></div>
    </div>


</body>



</html>


