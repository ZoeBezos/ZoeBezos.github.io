<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="zoe">


    <meta name="subtitle" content="liberté">




<title>DaiJia | ZOE&#39;s site</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    
    <script src="/js/jquery-3.7.0.min.js"></script>
    
    <script src="/js/mathjax2.7.5.js"></script>
    



    
    
        
    


<!-- 搜索的部分 -->



    <script>
    // function searchToggle() {
    //     const width = $(document.body).width()
    //     if(width > 479) {
    //         return;
    //     }
    //     const search = $('.search');
    //     const searchForm = $('.form-search')

    //     if(!search.hasClass("mobile-search")) {
    //         search.addClass("mobile-search");
    //     } else {
    //         search.removeClass("mobile-search");
    //     } 
    // }

    function searchToggle() {
        const width = $(document.body).width()
        if(width > 479) {
            return;
        }
        const search = $('.search');
        const searchForm = $('.form-search');
        const menuToggle = $('.menu-toggle');
        const title = $('.navbar-header-title ');

        if(!search.hasClass("mobile-search")) {
            search.addClass("mobile-search");
            menuToggle.addClass("open-search")
            title.addClass("mobile-title-hidden")
        } else {
            search.removeClass("mobile-search");
            menuToggle.removeClass("open-search")
            // title.css({visibility: 'visible'})
            title.removeClass("mobile-title-hidden")
        } 
    }



    function search(searchInputEl, formEl, flag) {
        const path = "/" + "search.json"; // 可以在public 下查看这个search.json
        $(formEl).submit(function(e){
            e.preventDefault();
            let target = null
            if(searchInputEl == null) {
                const screenWidth = $(document.body).width();
                target = screenWidth > 479 ? $('#pc-search-input') : $('#mobile-search-input');
                console.log(target);
            } else {
                target = $(searchInputEl)
            }

            if(!flag && target.val() === '') {
                return ;
            }

            $("#u-search").fadeIn(500, function() {
                $("body > .wrapper").addClass("modal-active");

                $.ajax({
                    url: path,
                    dataType: "json",
                    beforeSend: function (xhr) {
                        $input = target.val();
                        $(".form-input").val($input);
                        const loadingBar = $('.search-loading-bar') 
                        loadingBar.css({
                            width:'100%',
                            display: 'block'
                        });
                    },
                    success: function( datas ) {
                        console.log(datas);
                        const $resultPanel = $(".modal-body")[0];
                        let str = `<ul class="modal-results">`;
                        var keywords = $(".form-input").val().trim().toLowerCase().split(/[\s\-]+/);
                        $resultPanel.innerHTML = "";
                        let hasResult = false
                        let text = `<div class="no-result">找不到与关键词相关的内容....</div>`;

                        if ($(".form-input").val().trim().length <= 0) {
                            // 没有结果
                            $resultPanel.innerHTML = text;
                            return;
                        }
                        datas.forEach(function (data, index) {
                            var isMatch = true;
                            if (!data.title || data.title.trim() === '') {
                                data.title = "Untitled";
                            }
                            var data_title = data.title.trim().toLowerCase();
                            var data_content = data.content && data.content.trim().replace(/<[^>]+>/g, "").toLowerCase() || '';
                            var data_url = data.url;
                            var index_title = -1;
                            var index_content = -1;
                            var first_occur = -1;
                            // only match artiles with not empty contents
                            if (data_content !== '') {
                                keywords.forEach(function (keyword, i) {
                                    index_title = data_title.indexOf(keyword);
                                    index_content = data_content.indexOf(keyword);

                                    if (index_title < 0 && index_content < 0) {
                                        isMatch = false;
                                    } else {
                                        hasResult = true
                                        if (index_content < 0) {
                                            index_content = 0;
                                        }
                                        if (i == 0) {
                                            first_occur = index_content;
                                        }
                                    }
                                });
                            } else {
                                isMatch = false;
                            }
                            // show search results
                            if (isMatch) {
                                str += `<li class='result-item'><a href='${data_url}' class='result-item-detail'> <span class="title">${data_title}</span>`;
                                var content = data.content.trim().replace(/<[^>]+>/g, "");
                                if (first_occur >= 0) {
                                    // cut out 200 characters
                                    var start = first_occur - 40;
                                    var end = first_occur + 160;

                                    if (start < 0) {
                                        start = 0;
                                    }

                                    if (start == 0) {
                                        end = 200;
                                    }

                                    if (end > content.length) {
                                        end = content.length;
                                    }

                                    var match_content = content.substring(start, end);

                                    // highlight all keywords
                                    keywords.forEach(function (keyword) {
                                        var regS = new RegExp(keyword, "gi");
                                        match_content = match_content.replace(regS, `<em class="search-keyword">${keyword}</em>`);
                                    });

                                    str += `<span class="content"> ${match_content} ...</span></a>`;
                                }
                                str += "</li>";
                            }
                        });
                        str += "</ul>";
                        if(hasResult) {
                            $resultPanel.innerHTML = str;
                        } else {
                            $resultPanel.innerHTML = text;
                        }

                    },
                    complete: function() {
                        setTimeout(() => {
                                const loadingBar = $('.search-loading-bar') 
                                loadingBar.css({
                                    width:'0%',
                                    display: 'none'
                                });
                        }, 300)
                    }
                });
            })

        });
    }

    $(document).ready(function() {
        $('.modal-close').click(function () { 
            $("#u-search").fadeOut();
            $("body > .wrapper").removeClass("modal-active")
        })

        $('.modal-overlay').click(function() {
            $("#u-search").fadeOut();
            $("body > .wrapper").removeClass("modal-active")
        })
        search(null, ".form-search", false)
        search("#u-search-modal-form .form-input", ".u-search-modal-form", true)
    })
</script>

<meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                // pagebody.classList.add('dark-theme');
                // mobile
                // document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <!-- <div class="navbar-header header-logo"><a href="/">ZOE&#39;s site</a></div> -->
            <div class="navbar-header header-logo"><a href="/"><i class="iconfont icon-zhuye" style="font-size: 1em;"></i>ZOE&#39;s site</a></div>
            <div class="menu navbar-right">
                <!-- 这里表示的是pc端搜索框 -->
                
                
    <div class="search ">
        <!-- <div class="search-btn" onClick="searchToggle()">
            <img src="/image/search.png" class="search-btn-img" />
        </div> -->
        <form class="form-search">
            <input class="input" placeholder="search" autocomplete="on" id="pc-search-input"/>
        </form>
    </div>

                
                <a class="menu-item" target="_blank" rel="noopener" href="https://github.com/ZoeBezos">Github</a>
                
                <a class="menu-item" target="_blank" rel="noopener" href="https://www.linkedin.com/in/zoe-bezos/">Linkedin</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <!-- <label for="switch_default" class="toggleBtn"></label> -->
            </div>
        </div>
    </nav>
    
    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">ZOE&#39;s site</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="navbar-mobile-right">
                    
                    
    <div class="search ">
        <!-- <div class="search-btn" onClick="searchToggle()">
            <img src="/image/search.png" class="search-btn-img" />
        </div> -->
        <form class="form-search">
            <input class="input" placeholder="search" autocomplete="on" id="mobile-search-input"/>
        </form>
    </div>

                    <!-- <div class="menu-toggle" onclick="mobileBtn()">&#9776; menu</div> -->
                </div>
    
            </div>
            <div class="menu" id="mobile-menu">
                
                <a class="menu-item" target="_blank" rel="noopener" href="https://github.com/ZoeBezos">Github</a>
                
                <a class="menu-item" target="_blank" rel="noopener" href="https://www.linkedin.com/in/zoe-bezos/">Linkedin</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>

    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">DaiJia</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">zoe</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">September 26, 2024&nbsp;&nbsp;0:08:30</a>
                        </span>
                    
                    

                        <span class="post-category">                        
                            Category:                        
                                                    
                            <a href="/categories/projection/">projection</a>
                            
                        </span>

                    

                    
                        
                        <span class="post-count">                        
                            Words:                        
                            <a href="">87.5k</a>                         
                        </span>
                        
                    
                                                                        
                    
                        
                        <span class="post-count">                        
                            Time:                        
                            <a href="">387min</a>                         
                        </span>
                        
                    
                        
                </div>
            
        </header>

        <div class="post-content">
            <blockquote>
<p> 项目GitHub地址：<a target="_blank" rel="noopener" href="https://github.com/ZoeBezos/daijia-project">ZoeBezos/daijia-project (github.com)</a></p>
</blockquote>
<h1><span id="i-huan-jing-da-jian">Ⅰ.环境搭建</span></h1><h2><span id="yi-xiang-mu-jie-shao">一、项目介绍</span></h2><h3><span id="1-jie-shao">1、介绍</span></h3><p>【<strong>乐尚代驾</strong>】代驾是一种新型的出行服务模式，主营业务：酒后<em>代驾</em>、商务代驾、长途代驾，其主要特点是通过线上平台为用户提供代驾服务，伴随中国家庭汽车保有量的飞速增长，互联网代驾行业驶进了快车道，当前项目就是以此为背景设计出来的。</p>
<h3><span id="2-he-xin-ji-zhu">2、核心技术</span></h3><ul>
<li><strong>SpringBoot</strong>：简化Spring应用的初始搭建以及开发过程</li>
<li><strong>SpringCloud</strong>：基于Spring Boot实现的云原生应用开发工具，SpringCloud使用的技术：（Spring Cloud Gateway、Spring Cloud Task和Spring Cloud Feign等）</li>
<li><strong>SpringBoot+SpringCloudAlibaba(Nacos，Sentinel) + OpenFeign + Gateway</strong></li>
<li>MyBatis-Plus：持久层框架，也依赖mybatis</li>
<li>Redis：内存做缓存</li>
<li>Redisson：基于redis的Java驻内存数据网格 - 框架；操作redis的框架</li>
<li>MongoDB: 分布式文件存储的数据库</li>
<li>RabbitMQ：消息中间件；大型分布式项目是标配；分布式事务最终一致性</li>
<li>Seata：分布式事务</li>
<li>Drools：规则引擎，计算预估费用、取消费用等等</li>
<li>GEO：GPS分区定位计算</li>
<li>ThreadPoolExecutor+CompletableFuture：异步编排，线程池来实现异步操作，提高效率</li>
<li>XXL-JOB: 分布式定时任务调用中心</li>
<li>Knife4J/YAPI：Api接口文档工具</li>
<li>MinIO（私有化对象存储集群）：分布式文件存储 类似于OSS（公有）</li>
<li>微信支付：微信支付与微信分账</li>
<li>MySQL：关系型数据库 {shardingSphere-jdbc 进行读写分离; 分库，分表}</li>
<li>Lombok: 实体类的中get/set 生成的jar包</li>
<li>Natapp：内网穿透</li>
<li>Docker：容器化技术;  生产环境Redis（运维人员）；快速搭建环境Docker run</li>
<li>Git：代码管理工具；Git使用，拉代码、提交、推送、合并、冲突解决</li>
</ul>
<p>前端技术栈</p>
<ul>
<li>UniApp</li>
<li>Vue3全家桶</li>
<li>TypeScript</li>
<li>GraceUI</li>
<li>UniUI</li>
<li>uniapp-axios-adapter</li>
</ul>
<h3><span id="3-shi-yong-de-yun-fu-wu">3、使用的云服务</span></h3><p>因为我们开发的是打车类的微信小程序项目，因此要使用了大量的云服务（腾讯云或者其它云都可以）与微信小程序插件，列举如下：</p>
<table>
<thead>
<tr>
<th align="left">序号</th>
<th align="left">云服务名称</th>
<th align="left">具体用途</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">对象存储服务（COS）</td>
<td align="left">存储司机实名认证的身份证和驾驶证照片等隐私图片</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">人脸识别（AiFace）</td>
<td align="left">每天司机接单前的身份核实，并且具备静态活体检测功能</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">人员库管理（face-lib）</td>
<td align="left">云端存储司机注册时候的人脸模型，用于身份比对使用</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left">数据万象（ci）</td>
<td align="left">用于监控大家录音文本内容，判断是否包含暴力和色情</td>
</tr>
<tr>
<td align="left">5</td>
<td align="left">OCR证件识别</td>
<td align="left">用于OCR识别和扫描身份证和驾驶证的信息</td>
</tr>
<tr>
<td align="left">6</td>
<td align="left">微信同声传译插件</td>
<td align="left">把文字合成语音，播报订单；把录音转换成文本，用于安全监控</td>
</tr>
<tr>
<td align="left">7</td>
<td align="left">路线规划插件</td>
<td align="left">用于规划司机下班回家的线路，或者小程序订单显示的路线</td>
</tr>
<tr>
<td align="left">8</td>
<td align="left">地图选点插件</td>
<td align="left">用于小程序上面地图选点操作</td>
</tr>
<tr>
<td align="left">9</td>
<td align="left">腾讯位置服务</td>
<td align="left">路线规划、定位导航、里程和时间预估</td>
</tr>
</tbody></table>
<h3><span id="4-ji-zhu-jia-gou-tu">4、技术架构图</span></h3><img src="/2024/09/26/projection-daijia/djjsjgt.png" alt="技术架构图">



<h3><span id="5-ye-wu-liu-cheng-tu">5、业务流程图</span></h3><p><img src="/2024/09/26/projection-daijia/ywlct.png" alt="69811258724"></p>
<h3><span id="5-xiang-mu-mo-kuai">5、项目模块</span></h3><p>最终服务器端架构模块</p>
<p>daijia-parent：根目录，管理子模块：</p>
<p>​	common：公共类父模块</p>
<p>​		common-log：系统日志管理</p>
<p>​		common-util：核心工具类</p>
<p>​		rabbit-util：service模块工具类</p>
<p>​		service-util：service模块工具类</p>
<p>​		spring-security：spring-security业务模块</p>
<p>​	model：实体类模块</p>
<p>​	server-gateway：网关</p>
<p>​	service：service服务父模块</p>
<p>​		service-coupon：优惠券服务模块</p>
<p>​		service-customer：乘客服务模块</p>
<p>​		service-dispatch：调度服务模块</p>
<p>​		service-driver：司机服务模块</p>
<p>​		service-map：地图服务模块</p>
<p>​		service-mq：mq测试服务模块</p>
<p>​		service-order：订单服务模块</p>
<p>​		service-payment：支付服务模块</p>
<p>​		service-rules：规则服务模块</p>
<p>​		service-system：系统服务模块</p>
<p>​	service-client：远程调用服务父模块</p>
<p>​		service-coupon-client：优惠券服务远程接口</p>
<p>​		service-customer-client：客户服务远程接口</p>
<p>​		service-dispatch-client：调度服务远程接口</p>
<p>​		service-driver-client：司机服务远程接口</p>
<p>​		service-map-client：地图服务远程接口</p>
<p>​		service-order-client：订单服务远程接口</p>
<p>​		service-payment-client：支付服务远程接口</p>
<p>​		service-rules-client：规则服务远程接口</p>
<p>​		service-system-client：系统服务远程接口</p>
<p>​	web：前端系统父模块</p>
<p>​		web-customer：乘客端web系统</p>
<p>​		web-driver：司机端web系统</p>
<p>​		web-mgr：管理端web系统</p>
<h2><span id="er-kai-fa-huan-jing-zhun-bei">二、开发环境准备</span></h2><h3><span id="1-qian-duan-huan-jing">1、前端环境</span></h3><h4><span id="1-1-zhu-ce-wei-xin-kai-fa-zhe-zhang-hao">1.1、注册微信开发者账号</span></h4><p>虽然开发微信小程序可以使用微信提供的测试号，但是测试号提供的功能极为有限，而且不能真机调试。因此说，首先我们必须要申请微信开发者账号，个人申请和使用微信开发者账号是免费的。如果你要开发的是商用小程序，那么就需要以企业身份申请微信开发者账号，而且还要缴纳认证费用。</p>
<p>用浏览器访问 <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/">微信公众平台</a>，然后点击页面右上角的<code>立即注册</code>链接。</p>
<p><img src="/2024/09/26/projection-daijia/1698132655096.png" alt="69813265509"></p>
<p>帐户类型选择<code>小程序</code>，然后填写好注册信息，然后微信平台会给你发送一封电子邮件。你需要点击电子邮件中的激活小程序账号的链接，然后在跳转的页面中，个人详细信息，这样才算是把个人主体的微信小程序开发者账号给注册下来。</p>
<p><img src="/2024/09/26/projection-daijia/1698132709712.png" alt="69813270971"></p>
<p>开发微信小程序必须要用到AppID和密钥，这两个东西可以在微信开发者平台上面获得。刚才大家已经成功注册了开发者账号，那么就处在登陆的状态，不用重新登录微信开发者平台。</p>
<p>在网页中找到<code>开发</code>栏目，然后选择<code>开发管理</code>选项卡，在面板中你就能看到自己的小程序对应的<code>AppID</code>和<code>密钥</code>了。如果是刚注册下来的账号，密钥还没有生成，你要手动点击页面上的按钮，生成密钥字符串。如果已经生成过密钥字符串，那么默认情况，页面会隐藏密钥字符串，你只能点击重置按钮，生成新的密钥字符串了。所以强烈建议大家，获取了密钥字符串之后，最好能用文件把密钥字符串保存下来。</p>
<p><img src="/2024/09/26/projection-daijia/1698132930026.png" alt="69813293002"></p>
<p>本项目包含了获取微信手机号码、微信支付和分账等功能，个人开发者账号是不支持的，必须要使用企业身份的微信开发者账号。</p>
<h4><span id="1-2-kai-tong-fu-wu-yu-cha-jian">1.2、开通服务与插件</span></h4><h5><span id="1-2-1-kai-tong-di-li-wei-zhi">1.2.1、开通地理位置</span></h5><p>开发 -》开发管理 -》接口设置 -》地理位置：</p>
<p><img src="/2024/09/26/projection-daijia/1702349672692.png" alt="70234967269"></p>
<h5><span id="1-2-2-kai-tong-xiao-cheng-xu-cha-jian">1.2.2、开通小程序插件</span></h5><p>添加：腾讯位置服务地图选点与微信同声传译 插件</p>
<p>设置 ==&gt; 第三方设置 ==-&gt; 插件管理 ==-&gt; 添加插件 ==&gt; 搜索 “插件名称” ，如图：</p>
<p><img src="/2024/09/26/projection-daijia/1702350125619.png" alt="70235012561"></p>
<p>没有搜索到，那么就到”微信服务市场“去找，搜索到以后添加到需要的小程序里面即可。</p>
<p>微信服务市场：<a target="_blank" rel="noopener" href="https://fuwu.weixin.qq.com/search">https://fuwu.weixin.qq.com/search</a></p>
<p>此时就到<a target="_blank" rel="noopener" href="https://fuwu.weixin.qq.com/search?tab=3&amp;type=&amp;serviceType=3&amp;page=1&amp;kw=%E5%BE%AE%E4%BF%A1%E5%90%8C%E5%A3%B0%E4%BC%A0%E8%AF%91">微信服务市场</a>去搜，搜索到以后添加到需要的小程序里面</p>
<p><a target="_blank" rel="noopener" href="https://fuwu.weixin.qq.com/search?tab=3&amp;type=&amp;serviceType=3&amp;page=1&amp;kw=%E8%85%BE%E8%AE%AF%E4%BD%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1%E5%9C%B0%E5%9B%BE%E9%80%89%E7%82%B9">https://fuwu.weixin.qq.com/search?tab=3&amp;type=&amp;serviceType=3&amp;page=1&amp;kw=腾讯位置服务地图选点</a></p>
<p><a target="_blank" rel="noopener" href="https://fuwu.weixin.qq.com/search?tab=3&amp;type=&amp;serviceType=3&amp;page=1&amp;kw=%E5%BE%AE%E4%BF%A1%E5%90%8C%E5%A3%B0%E4%BC%A0%E8%AF%91">https://fuwu.weixin.qq.com/search?tab=3&amp;type=&amp;serviceType=3&amp;page=1&amp;kw=微信同声传译</a></p>
<p><img src="/2024/09/26/projection-daijia/1702350309447.png" alt="70235030944"></p>
<p>点击进入详情：</p>
<p><img src="/2024/09/26/projection-daijia/1702350351282.png" alt="70235035128"></p>
<p>添加插件：</p>
<p><img src="/2024/09/26/projection-daijia/1702350381666.png" alt="70235038166"></p>
<p>添加到你申请的小程序即可。</p>
<p>结果如下：</p>
<p><img src="/2024/09/26/projection-daijia/1702350440235.png" alt="70235044023"></p>
<h4><span id="1-3-an-zhuang-node-js">1.3、安装Node.js</span></h4><p><a target="_blank" rel="noopener" href="https://nodejs.org/en/download">https://nodejs.org/en/download</a></p>
<p>UniApp是基于Vue.js环境开发的，前面项目已经安装过，可以忽略，本课程使用Node.js版本是v16.19.1</p>
<h4><span id="1-4-wei-xin-kai-fa-zhe-gong-ju-shi-yong">1.4、微信开发者工具使用</span></h4><p>本课程要运行代驾小程序，必然要用到微信开发者工具。因为移动端项目采用了UniApp架构，正常情况下是在HBuildeX上面开发小程序，编译后在微信开发者工具上运行调试，但是我们不用开发UniApp前端项目，程序已经开发好了，所以就可以不使用HBuildeX工具了。</p>
<p><img src="/2024/09/26/projection-daijia/1698132655089.png" alt="69813293002"></p>
<h5><span id="1-4-1-an-zhuang-wei-xin-kai-fa-zhe-gong-ju">1.4.1、安装微信开发者工具</span></h5><p>由于微信开发者工具不能同时运行两个微信小程序项目，因此我们要安装两个微信开发者工具，只要安装目录变更一下即可，如：微信web开发者工具1、微信web开发者工具2，如图：</p>
<p><img src="/2024/09/26/projection-daijia/1700724385830.png" alt="70072438583"></p>
<h5><span id="1-4-2-qi-dong-yu-deng-lu">1.4.2、启动与登录</span></h5><p>安装完成后，启动微信开发者工具，使用微信扫码登陆</p>
<p><img src="/2024/09/26/projection-daijia/1700790680453.png" alt="70079068045"></p>
<p>登录后如图：</p>
<p><img src="/2024/09/26/projection-daijia/1700790736448.png" alt="70079073644"></p>
<h5><span id="1-4-3-pei-zhi">1.4.3、配置</span></h5><p>微信扫码登陆之后，点击微信开发工具右上角的“齿轮图标”，在弹出的设置面板中开启服务端口。</p>
<p><img src="/2024/09/26/projection-daijia/1700728620331.png" alt="70072862033"></p>
<p>安全 -&gt; 服务端口选中，服务端口是随机分配的。</p>
<p><img src="/2024/09/26/projection-daijia/1700728666327.png" alt="70072866632"></p>
<h5><span id="1-4-4-dao-ru-cheng-ke-duan-xiang-mu">1.4.4、导入乘客端项目</span></h5><p><img src="/2024/09/26/projection-daijia/1700728780968.png" alt="70072878096"></p>
<p>选择导入</p>
<p>选择编译好的前端项目：mp-weixin-customer，使用第一步注册的微信公众号AppId</p>
<p><img src="/2024/09/26/projection-daijia/1700791043242.png" alt="70079104324"></p>
<p>确定，“信任并运行”即可。</p>
<p><img src="/2024/09/26/projection-daijia/1700791140646.png" alt="70079114064"></p>
<p>核对AppId是否正确，如果不对，可以修改；</p>
<p>说明：忽略“详情”下面的项目名称，公司有很多微信小程序项目挂在了改账号下开发，不受影响。</p>
<p><img src="/2024/09/26/projection-daijia/1700791197601.png" alt="70079119760"></p>
<p>注：使用相同的方式，在“微信开发者工具2”，可导入司机端小程序项目。</p>
<h4><span id="1-5-qian-duan-jie-kou-di-zhi">1.5、前端接口地址</span></h4><p>前端微信小程序项目默认已编译好，不用修改配置。</p>
<p>乘客端默认base地址：<a target="_blank" rel="noopener" href="http://localhost:8600/customer-api">http://localhost:8600/customer-api</a></p>
<p>司机端默认base地址：<a target="_blank" rel="noopener" href="http://localhost:8600/driver-api">http://localhost:8600/driver-api</a></p>
<h3><span id="2-fu-wu-qi-duan-huan-jing">2、服务器端环境</span></h3><h4><span id="2-1-shu-ju-ku-biao">2.1、数据库表</span></h4><p>从资料文件中获取，导入数据库</p>
<h4><span id="2-2-xiang-mu-huan-jing-da-jian">2.2、项目环境搭建</span></h4><h5><span id="2-2-1-an-zhuang-ruan-jian-huan-jing">2.2.1、安装软件环境</span></h5><p>参考“软件环境安装.md”，安装开发所需中间件；</p>
<h5><span id="2-2-2-dao-ru-chu-shi-hua-xiang-mu">2.2.2、导入初始化项目</span></h5><p>从资料中获取daijia-parent初始化项目，复制到工作目录，导入idea开发工具中即可；</p>
<p><img src="/2024/09/26/projection-daijia/1700811669260.png" alt="70081166926"></p>
<h5><span id="2-2-3-dao-ru-pei-zhi-wen-jian-dao-nacos">2.2.3、导入配置文件到Nacos</span></h5><p>从资料中获取项目配置文件，压缩成DEFAULT_GROUP.zip，导入nacos服务器。</p>
<p><img src="/2024/09/26/projection-daijia/1700810548938.png" alt="70081054893"></p>
<h5><span id="2-3-4-qi-dong-diao-shi-xiang-mu">2.3.4、启动调试项目</span></h5><p>更改配置文件连接方式：Nacos、Mysql、Rabbitmq与Redis等的连接方式</p>
<p>启动项目，如果项目不报错，则初始化项目导入成功。</p>
<h2><span id="san-mybatis-plus-ru-men">三、Mybatis-Plus入门</span></h2><h3><span id="1-jian-jie">1、简介</span></h3><p>官网：<a target="_blank" rel="noopener" href="https://baomidou.com/">https://baomidou.com/</a></p>
<p>参考教程：<a target="_blank" rel="noopener" href="https://baomidou.com/pages/226c21/#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%B7%A5%E7%A8%8B">https://baomidou.com/pages/226c21/#初始化工程</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/baomidou/mybatis-plus">MyBatis-Plus</a>（简称 MP）是一个 <a target="_blank" rel="noopener" href="http://www.mybatis.org/mybatis-3/">MyBatis</a> 的增强工具，在 MyBatis 的基础上只做增强不做改变，为简化开发、提高效率而生。</p>
<h3><span id="2-chuang-jian-bing-chu-shi-hua-shu-ju-ku">2、创建并初始化数据库</span></h3><h4><span id="2-1-chuang-jian-shu-ju-ku">2.1、创建数据库</span></h4><p><code>mybatis_plus</code></p>
<h4><span id="2-2-chuang-jian-user-biao">2.2、创建 <code>User</code> 表</span></h4><p>其表结构如下：</p>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>age</th>
<th>email</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>Jone</td>
<td>18</td>
<td><a href="mailto:test1@baomidou.com">test1@baomidou.com</a></td>
</tr>
<tr>
<td>2</td>
<td>Jack</td>
<td>20</td>
<td><a href="mailto:test2@baomidou.com">test2@baomidou.com</a></td>
</tr>
<tr>
<td>3</td>
<td>Tom</td>
<td>28</td>
<td><a href="mailto:test3@baomidou.com">test3@baomidou.com</a></td>
</tr>
<tr>
<td>4</td>
<td>Sandy</td>
<td>21</td>
<td><a href="mailto:test4@baomidou.com">test4@baomidou.com</a></td>
</tr>
<tr>
<td>5</td>
<td>Billie</td>
<td>24</td>
<td><a href="mailto:test5@baomidou.com">test5@baomidou.com</a></td>
</tr>
</tbody></table>
<p>其对应的数据库 Schema 脚本如下：</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> <span class="keyword">user</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">user</span></span><br><span class="line">(</span><br><span class="line">    id <span class="type">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'主键ID'</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">30</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'姓名'</span>,</span><br><span class="line">    age <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'年龄'</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'邮箱'</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (id)</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure>

<p>其对应的数据库 Data 脚本如下：</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> <span class="keyword">user</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">user</span> (id, name, age, email) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="string">'Jone'</span>, <span class="number">18</span>, <span class="string">'test1@baomidou.com'</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="string">'Jack'</span>, <span class="number">20</span>, <span class="string">'test2@baomidou.com'</span>),</span><br><span class="line">(<span class="number">3</span>, <span class="string">'Tom'</span>, <span class="number">28</span>, <span class="string">'test3@baomidou.com'</span>),</span><br><span class="line">(<span class="number">4</span>, <span class="string">'Sandy'</span>, <span class="number">21</span>, <span class="string">'test4@baomidou.com'</span>),</span><br><span class="line">(<span class="number">5</span>, <span class="string">'Billie'</span>, <span class="number">24</span>, <span class="string">'test5@baomidou.com'</span>);</span><br></pre></td></tr></tbody></table></figure>

<h3><span id="3-chuang-jian-xiang-mu">3、创建项目</span></h3><h4><span id="3-1-chuang-jian-maven-xiang-mu">3.1、创建maven项目</span></h4><p>mybatis_plus_demo</p>
<p>GroupId：com.atguigu</p>
<p><img src="/2024/09/26/projection-daijia/1701135573194.png" alt="70113557319"></p>
<h4><span id="3-2-springboot-ban-ben">3.2、SpringBoot版本</span></h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4><span id="3-3-tian-jia-yi-lai">3.3、添加依赖</span></h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--mybatis-plus--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--mysql--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.30<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--lombok用来简化实体类--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-4-idea-zhong-an-zhuang-lombok-cha-jian">3.4、idea中安装lombok插件</span></h4><p><strong>idea2022版本</strong></p>
<p><img src="/2024/09/26/projection-daijia/ba5bc431-832b-4bcb-81fe-893d02ad3c6f.png" alt="img"></p>
<h3><span id="4-bian-xie-dai-ma">4、编写代码</span></h3><h4><span id="4-1-pei-zhi-wen-jian">4.1、配置文件</span></h4><p> <code>application.properties</code> 配置文件</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mysql数据库连接</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/mybatis_plus?serverTimezone=GMT%2B8&amp;useSSL=false</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="comment">#mybatis日志</span></span><br><span class="line"><span class="attr">mybatis-plus.configuration.log-impl</span>=<span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="4-2-shi-ti-lei">4.2、实体类</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mp.entity;</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> {</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="4-3-mapper">4.3、mapper</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mp.mapper;</span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt; {</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="5-kai-shi-shi-yong">5、开始使用</span></h3><p>添加测试类，进行功能测试：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mp;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CRUDTests</span> {</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSelectList</span><span class="params">()</span> {</span><br><span class="line">        List&lt;User&gt; userList = userMapper.selectList(<span class="literal">null</span>);</span><br><span class="line">        userList.forEach(System.out::println);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>通过以上几个简单的步骤，我们就实现了 User 表的 CRUD 功能，甚至连 XML 文件都不用编写！</strong></p>
<h3><span id="6-zhu-jian-ce-lue">6、主键策略</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testInsert</span><span class="params">()</span>{</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.setName(<span class="string">"jack"</span>);</span><br><span class="line">    user.setAge(<span class="number">18</span>);</span><br><span class="line">    user.setEmail(<span class="string">"123456332@qq.com"</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> userMapper.insert(user);</span><br><span class="line">    System.out.println(result); <span class="comment">//影响的行数</span></span><br><span class="line">    System.out.println(user); <span class="comment">//id自动回填</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p><strong>注意：</strong>数据库插入id值默认为：全局唯一id</p>
<p><img src="/2024/09/26/projection-daijia/image-20230201154810189.png" alt="image-20230201154810189"></p>
<h4><span id="6-1-quan-ju-wei-yi-id-mo-ren">6.1、全局唯一ID（默认）</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TableId(type = IdType.ASSIGN_ID)</span></span><br></pre></td></tr></tbody></table></figure>

<p>雪花算法是由 Twitter 公布的分布式主键生成算法，它能够保证不同进程主键的不重复性，以及相同进程主键的有序性。</p>
<p><strong>实现原理</strong></p>
<p>在同一个进程中，它首先是通过时间位保证不重复，如果时间相同则是通过序列位保证。 同时由于时间位是单调递增的，且各个服务器如果大体做了时间同步，那么生成的主键在分布式环境可以认为是总体有序的，这就保证了对索引字段的插入的高效性。 例如 MySQL 的 Innodb 存储引擎的主键。</p>
<p>使用雪花算法生成的主键，二进制表示形式包含 4 部分，从高位到低位分表为：1bit 符号位、41bit 时间戳位、10bit 工作进程位以及 12bit 序列号位。</p>
<ul>
<li>符号位（1bit）</li>
</ul>
<p>预留的符号位，恒为零。</p>
<ul>
<li>时间戳位（41bit）</li>
</ul>
<p>41 位的时间戳可以容纳的毫秒数是 2 的 41 次幂，一年所使用的毫秒数是：<code>365 * 24 * 60 * 60 * 1000</code>。 通过计算可知：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Math.pow(2, 41) / (365 * 24 * 60 * 60 * 1000L);</span><br></pre></td></tr></tbody></table></figure>

<p>结果约等于 69.73 年，相信能满足绝大部分系统的要求。</p>
<ul>
<li>工作进程位（10bit）</li>
</ul>
<p>该标志在 Java 进程内是唯一的，如果是分布式应用部署应保证每个工作进程的 id 是不同的。 该值默认为 0，可通过属性设置。可以支持 1024(2 的 10 次幂)个工作进程</p>
<ul>
<li>序列号位（12bit）</li>
</ul>
<p>该序列是用来在同一个毫秒内生成不同的 ID。如果在这个毫秒内生成的数量超过 4096 (2 的 12 次幂)，那么生成器会等待到下个毫秒继续生成。</p>
<p>雪花算法主键的详细结构见下图。</p>
<p><img src="/2024/09/26/projection-daijia/0.6170196949249593.png" alt="雪花算法"></p>
<h4><span id="6-2-zi-zeng-ce-lue">6.2、自增策略</span></h4><ul>
<li>要想主键自增需要配置如下主键策略</li>
<li><ul>
<li>需要在创建数据表的时候设置主键自增</li>
<li>实体字段中配置 @TableId(type = IdType.AUTO)</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TableId(type = IdType.AUTO)</span></span><br><span class="line"><span class="keyword">private</span> Long id;</span><br></pre></td></tr></tbody></table></figure>

<h3><span id="7-fen-ye-cha-jian">7、分页插件</span></h3><p>MyBatis Plus自带分页插件，只要简单的配置即可实现分页功能</p>
<h4><span id="7-1-pei-zhi-fen-ye-cha-jian">7.1、配置分页插件</span></h4><p>创建MybatisPlusConfig</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mp.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusConfig</span> {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分页插件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">optimisticLockerInnerInterceptor</span><span class="params">()</span>{</span><br><span class="line">        <span class="type">MybatisPlusInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line">        <span class="comment">//向Mybatis过滤器链中添加分页拦截器</span></span><br><span class="line">        interceptor.addInnerInterceptor(<span class="keyword">new</span> <span class="title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));</span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="7-2-ce-shi-selectpage-fen-ye">7.2、测试selectPage分页</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSelectPage</span><span class="params">()</span> {</span><br><span class="line">    Page&lt;User&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(<span class="number">1</span>,<span class="number">5</span>);</span><br><span class="line">    userMapper.selectPage(page, <span class="literal">null</span>);</span><br><span class="line">    page.getRecords().forEach(System.out::println);</span><br><span class="line">    System.out.println(page.getCurrent());</span><br><span class="line">    System.out.println(page.getPages());</span><br><span class="line">    System.out.println(page.getSize());</span><br><span class="line">    System.out.println(page.getTotal());</span><br><span class="line">    System.out.println(page.hasNext());</span><br><span class="line">    System.out.println(page.hasPrevious());</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h3><span id="8-luo-ji-shan-chu">8、逻辑删除</span></h3><ul>
<li>物理删除：真实删除，将对应数据从数据库中删除，之后查询不到此条被删除数据</li>
<li>逻辑删除：假删除，将对应数据中代表是否被删除的字段状态修改为“<code>被删除状态</code>”，之后在数据库中仍旧能看到此条数据记录</li>
</ul>
<h4><span id="8-1-shu-ju-ku-zhong-tian-jia-deleted-zi-duan">8.1、数据库中添加 deleted字段</span></h4><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `<span class="keyword">user</span>` <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> `deleted` <span class="type">BOOLEAN</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> COMMENT <span class="string">'逻辑删除字段'</span>;</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="8-2-shi-ti-lei-tian-jia-deleted-zi-duan">8.2、实体类添加deleted 字段</span></h4><p>并加上 @TableLogic 注解</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TableLogic</span></span><br><span class="line"><span class="keyword">private</span> Integer deleted;</span><br><span class="line"><span class="comment">//private Boolean deleted;</span></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="8-3-application-properties-pei-zhi">8.3、application.properties 配置</span></h4><p>此为默认值，如果你的默认值和mp默认的一样，则不需要该配置</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#默认配置</span></span><br><span class="line"><span class="attr">mybatis-plus.global-config.db-config.logic-delete-value</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">mybatis-plus.global-config.db-config.logic-not-delete-value</span>=<span class="string">0</span></span><br></pre></td></tr></tbody></table></figure>

<p>如果使用了@TableLogic注解，则不需要该配置</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mybatis-plus.global-config.db-config.logic-delete-field</span>=<span class="string">deleted</span></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="8-4-ce-shi-luo-ji-shan-chu">8.4、测试逻辑删除</span></h4><ul>
<li>测试后发现，数据并没有被删除，deleted字段的值由0变成了1</li>
<li>测试后分析打印的sql语句，是一条update</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试 逻辑删除</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLogicDelete</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> userMapper.deleteById(<span class="number">1L</span>);</span><br><span class="line">    System.out.println(result);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="8-5-ce-shi-luo-ji-shan-chu-hou-de-cha-xun">8.5、测试逻辑删除后的查询</span></h4><p>MyBatis Plus中查询操作也会自动添加逻辑删除字段的判断</p>
<h1><span id="ii-cheng-ke-duan-deng-lu">Ⅱ.乘客端登录</span></h1><p><strong>学习目标：</strong></p>
<ul>
<li>完成乘客端微信授权登录</li>
<li>掌握登录校验AOP拦截，处理当前用户信息</li>
<li>完成获取当前用户登录信息</li>
<li>完成获取微信手机号码</li>
</ul>
<h3><span id="1-cheng-ke-deng-lu">1、乘客登录</span></h3><h4><span id="1-1-xu-qiu-shuo-ming">1.1、需求说明</span></h4><p>乘客端只要登录，没有注册，登录方式为微信小程序登录，乘客登录我们根据微信接口拿到微信OpenId（全局唯一），到客户表（客户即乘客）查询OpenId是否存在，如果不存在即为注册，添加一天乘客记录；存在则根据用户信息生成token返回。</p>
<p><img src="/2024/09/26/projection-daijia/login.gif" alt="login"></p>
<h4><span id="1-2-wei-xin-shou-quan-deng-lu">1.2、微信授权登录</span></h4><p>官方文档：<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html">https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html</a></p>
<p>小程序可以通过微信官方提供的登录能力方便地获取微信提供的用户身份标识，快速建立小程序内的用户体系。</p>
<h5><span id="1-2-1-deng-lu-liu-cheng-shi-xu">1.2.1、登录流程时序</span></h5><p><img src="/2024/09/26/projection-daijia/1698197615714.png" alt="69819761571"></p>
<p>说明：</p>
<ol>
<li>调用 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html">wx.login()</a> 获取 <strong>临时登录凭证code</strong> ，并回传到开发者服务器。</li>
<li>调用 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html">auth.code2Session</a> 接口，换取 <strong>用户唯一标识 OpenID</strong> 、 用户在微信开放平台账号下的<strong>唯一标识UnionID</strong>（若当前小程序已绑定到微信开放平台账号） 和 <strong>会话密钥 session_key</strong>。</li>
</ol>
<p>之后开发者服务器可以根据用户标识来生成自定义登录态，用于后续业务逻辑中前后端交互时识别用户身份。</p>
<h5><span id="1-2-2-xiao-cheng-xu-duan">1.2.2、小程序端</span></h5><p>官方文档：<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html">https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html</a></p>
<p>wx.login(Object object)调用接口获取登录凭证（code）。通过凭证进而换取用户登录态信息，包括用户在当前小程序的唯一标识（openid）</p>
<p>详情见官方文档</p>
<h5><span id="1-2-3-fu-wu-qi-duan">1.2.3、服务器端</span></h5><p>官方文档：<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html">https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html</a></p>
<p>登录凭证校验。通过 wx.login 接口获得临时登录凭证 code 后传到开发者服务器调用此接口完成登录流程。</p>
<p>详情见官方文档</p>
<h5><span id="1-2-4-wei-xin-java-kai-fa-gong-ju-bao">1.2.4、微信Java开发工具包</span></h5><p>文档：<a target="_blank" rel="noopener" href="https://gitee.com/binary/weixin-java-tools">https://gitee.com/binary/weixin-java-tools</a></p>
<p>微信<code>Java</code>开发工具包，支持包括微信支付、开放平台、公众号、企业微信/企业号、小程序等微信功能模块的后端开发。</p>
<p>微信小程序：<code>weixin-java-miniapp</code></p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.binarywang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>weixin-java-miniapp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.5.5.B<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="1-3-cheng-ke-deng-lu-wei-fu-wu-jie-kou">1.3、乘客登录微服务接口</span></h4><p>操作模块：service-customer</p>
<h5><span id="1-3-1-pom-xml">1.3.1、pom.xml</span></h5><p>引入依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.binarywang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>weixin-java-miniapp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>说明：在父工程已经对改依赖进行了版本管理，这里直接引入即可</p>
<h5><span id="1-3-2-common-account-yaml">1.3.2、common-account.yaml</span></h5><p>第三方账号加到公共账号配置文件里面</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">wx:</span></span><br><span class="line">  <span class="attr">miniapp:</span></span><br><span class="line">    <span class="comment">#小程序授权登录</span></span><br><span class="line">    <span class="attr">appId:</span> <span class="string">wxcc651fcbab275e33</span>  <span class="comment"># 小程序微信公众平台appId</span></span><br><span class="line">    <span class="attr">secret:</span> <span class="string">5f353399a2eae7ff6ceda383e924c5f6</span>  <span class="comment"># 小程序微信公众平台api秘钥</span></span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-3-3-wxmaproperties">1.3.3、WxMaProperties</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.customer.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = "wx.miniapp")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WxMaProperties</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String appId;</span><br><span class="line">    <span class="keyword">private</span> String secret;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-3-4-wxmaconfig">1.3.4、WxMaConfig</span></h5><p>配置WxMaService，通过WxMaService可以快速获取微信OpenId</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.customer.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.binarywang.wx.miniapp.api.WxMaService;</span><br><span class="line"><span class="keyword">import</span> cn.binarywang.wx.miniapp.api.impl.WxMaServiceImpl;</span><br><span class="line"><span class="keyword">import</span> cn.binarywang.wx.miniapp.config.impl.WxMaDefaultConfigImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WxMaConfig</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WxMaProperties wxMaProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> WxMaService <span class="title function_">wxMaService</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">WxMaDefaultConfigImpl</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WxMaDefaultConfigImpl</span>();</span><br><span class="line">        config.setAppid(wxMaProperties.getAppId());</span><br><span class="line">        config.setSecret(wxMaProperties.getSecret());</span><br><span class="line"></span><br><span class="line">        <span class="type">WxMaService</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WxMaServiceImpl</span>();</span><br><span class="line">        service.setWxMaConfig(config);</span><br><span class="line">        <span class="keyword">return</span> service;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-3-5-customerinfocontroller">1.3.5、CustomerInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "小程序授权登录")</span></span><br><span class="line"><span class="meta">@GetMapping("/login/{code}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Long&gt; <span class="title function_">login</span><span class="params">(<span class="meta">@PathVariable</span> String code)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(customerInfoService.login(code));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-3-6-customerinfoservice">1.3.6、CustomerInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Long <span class="title function_">login</span><span class="params">(String code)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-3-7-customerinfoserviceimpl">1.3.7、CustomerInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> WxMaService wxMaService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> CustomerLoginLogMapper customerLoginLogMapper;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 条件：</span></span><br><span class="line"><span class="comment"> *      1、前端开发者appid与服务器端appid一致</span></span><br><span class="line"><span class="comment"> *      2、前端开发者必须加入开发者</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> code</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = {Exception.class})</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">login</span><span class="params">(String code)</span> {</span><br><span class="line">   <span class="type">String</span> <span class="variable">openId</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">   <span class="keyword">try</span> {</span><br><span class="line">      <span class="comment">//获取openId</span></span><br><span class="line">      <span class="type">WxMaJscode2SessionResult</span> <span class="variable">sessionInfo</span> <span class="operator">=</span> wxMaService.getUserService().getSessionInfo(code);</span><br><span class="line">      openId = sessionInfo.getOpenid();</span><br><span class="line">      log.info(<span class="string">"【小程序授权】openId={}"</span>, openId);</span><br><span class="line">   } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">       e.printStackTrace();</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.WX_CODE_ERROR);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="type">CustomerInfo</span> <span class="variable">customerInfo</span> <span class="operator">=</span> <span class="built_in">this</span>.getOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;CustomerInfo&gt;().eq(CustomerInfo::getWxOpenId, openId));</span><br><span class="line">   <span class="keyword">if</span>(<span class="literal">null</span> == customerInfo) {</span><br><span class="line">      customerInfo = <span class="keyword">new</span> <span class="title class_">CustomerInfo</span>();</span><br><span class="line">      customerInfo.setNickname(String.valueOf(System.currentTimeMillis()));</span><br><span class="line">      customerInfo.setAvatarUrl(<span class="string">"https://oss.aliyuncs.com/aliyun_id_photo_bucket/default_handsome.jpg"</span>);</span><br><span class="line">      customerInfo.setWxOpenId(openId);</span><br><span class="line">      <span class="built_in">this</span>.save(customerInfo);</span><br><span class="line">   }</span><br><span class="line">    </span><br><span class="line">   <span class="comment">//登录日志</span></span><br><span class="line">   <span class="type">CustomerLoginLog</span> <span class="variable">customerLoginLog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomerLoginLog</span>();</span><br><span class="line">   customerLoginLog.setCustomerId(customerInfo.getId());</span><br><span class="line">   customerLoginLog.setMsg(<span class="string">"小程序登录"</span>);</span><br><span class="line">   customerLoginLogMapper.insert(customerLoginLog);</span><br><span class="line">   <span class="keyword">return</span> customerInfo.getId();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-4-feign-jie-kou">1.4、Feign接口</span></h4><h5><span id="1-4-1-customerinfofeignclient">1.4.1、CustomerInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 小程序授权登录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> code</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/customer/info/login/{code}")</span></span><br><span class="line">Result&lt;Long&gt; <span class="title function_">login</span><span class="params">(<span class="meta">@PathVariable</span> String code)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-5-cheng-ke-duan-web-jie-kou">1.5、乘客端Web接口</span></h4><h5><span id="1-5-1-customercontroller">1.5.1、CustomerController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> CustomerService customerInfoService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "小程序授权登录")</span></span><br><span class="line"><span class="meta">@GetMapping("/login/{code}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">wxLogin</span><span class="params">(<span class="meta">@PathVariable</span> String code)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(customerInfoService.login(code));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-5-2-customerservice">1.5.2、CustomerService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String <span class="title function_">login</span><span class="params">(String code)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-5-3-customerserviceimpl">1.5.3、CustomerServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> CustomerInfoFeignClient customerInfoFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">login</span><span class="params">(String code)</span> {</span><br><span class="line">   <span class="comment">//获取openId</span></span><br><span class="line">   Result&lt;Long&gt; result = customerInfoFeignClient.login(code);</span><br><span class="line">   <span class="keyword">if</span>(result.getCode().intValue() != <span class="number">200</span>) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(result.getCode(), result.getMessage());</span><br><span class="line">   }</span><br><span class="line">   <span class="type">Long</span> <span class="variable">customerId</span> <span class="operator">=</span> result.getData();</span><br><span class="line">   <span class="keyword">if</span>(<span class="literal">null</span> == customerId) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> UUID.randomUUID().toString().replaceAll(<span class="string">"-"</span>, <span class="string">""</span>);</span><br><span class="line">   redisTemplate.opsForValue().set(RedisConstant.USER_LOGIN_KEY_PREFIX+token, customerId.toString(), RedisConstant.USER_LOGIN_KEY_TIMEOUT, TimeUnit.SECONDS);</span><br><span class="line">   <span class="keyword">return</span> token;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-6-xiao-cheng-xu-ce-shi">1.6、小程序测试</span></h4><p>启动：server-gateway、web-customer、service-customer</p>
<p>测试效果：</p>
<p><img src="/2024/09/26/projection-daijia/login1.gif" alt="login1"></p>
<p>测试结果：微信授权登录接口已经能够正常返回登录toekn，但是页面没有调整，是这样的，登录成功后，小程序又请求了一个获取当前登录用户信息接口，只要这个接口请求成功了它才会跳转页面。</p>
<h3><span id="2-huo-qu-ke-hu-deng-lu-xin-xi">2、获取客户登录信息</span></h3><p>乘客登录成功，小程序会回调“获取客户登录信息”接口，获取当前乘客基本信息</p>
<h4><span id="2-1-wei-fu-wu-jie-kou">2.1、微服务接口</span></h4><h5><span id="2-1-1-customerinfocontroller">2.1.1、CustomerInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "获取客户登录信息")</span></span><br><span class="line"><span class="meta">@GetMapping("/getCustomerLoginInfo/{customerId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;CustomerLoginVo&gt; <span class="title function_">getCustomerLoginInfo</span><span class="params">(<span class="meta">@PathVariable</span> Long customerId)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(customerInfoService.getCustomerLoginInfo(customerId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-2-customerinfoservice">2.1.2、CustomerInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CustomerLoginVo <span class="title function_">getCustomerLoginInfo</span><span class="params">(Long customerId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-3-customerinfoserviceimpl">2.1.3、CustomerInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CustomerLoginVo <span class="title function_">getCustomerLoginInfo</span><span class="params">(Long customerId)</span> {</span><br><span class="line">   <span class="type">CustomerInfo</span> <span class="variable">customerInfo</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(customerId);</span><br><span class="line">   <span class="type">CustomerLoginVo</span> <span class="variable">customerInfoVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomerLoginVo</span>();</span><br><span class="line">   BeanUtils.copyProperties(customerInfo, customerInfoVo);</span><br><span class="line">   <span class="comment">//判断是否绑定手机号码，如果未绑定，小程序端发起绑定事件</span></span><br><span class="line">   <span class="type">Boolean</span> <span class="variable">isBindPhone</span> <span class="operator">=</span> StringUtils.hasText(customerInfo.getPhone());</span><br><span class="line">   customerInfoVo.setIsBindPhone(isBindPhone);</span><br><span class="line">   <span class="keyword">return</span> customerInfoVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-2-feign-jie-kou">2.2、Feign接口</span></h4><h5><span id="2-2-1">2.2.1、/**</span></h5><ul>
<li>获取客户登录信息</li>
<li>@param customerId</li>
<li>@return<br>*/<br> @GetMapping(“/customer/info/getCustomerLoginInfo/{customerId}”)<br> Result<customerloginvo> getCustomerLoginInfo(@PathVariable(“customerId”) Long customerId);</customerloginvo></li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取客户登录信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> customerId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/customer/info/getCustomerLoginInfo/{customerId}")</span></span><br><span class="line">Result&lt;CustomerLoginVo&gt; <span class="title function_">getCustomerLoginInfo</span><span class="params">(<span class="meta">@PathVariable("customerId")</span> Long customerId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-3-cheng-ke-duan-web-jie-kou">2.3、乘客端Web接口</span></h4><h5><span id="2-3-1-customercontroller">2.3.1、CustomerController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "获取客户登录信息")</span></span><br><span class="line"><span class="meta">@GetMapping("/getCustomerLoginInfo")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;CustomerLoginVo&gt; <span class="title function_">getCustomerLoginInfo</span><span class="params">(<span class="meta">@RequestHeader(value="token")</span> String token)</span> {</span><br><span class="line">    <span class="type">String</span> <span class="variable">customerId</span> <span class="operator">=</span> (String)redisTemplate.opsForValue().get(RedisConstant.USER_LOGIN_KEY_PREFIX+token);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(customerInfoService.getCustomerLoginInfo(Long.parseLong(customerId)));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-3-2-customerservice">2.3.2、CustomerService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CustomerLoginVo <span class="title function_">getCustomerLoginInfo</span><span class="params">(Long customerId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-3-3-customerserviceimpl">2.3.3、CustomerServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CustomerLoginVo <span class="title function_">getCustomerLoginInfo</span><span class="params">(Long customerId)</span> {</span><br><span class="line">   Result&lt;CustomerLoginVo&gt; result = customerInfoFeignClient.getCustomerLoginInfo(customerId);</span><br><span class="line">   <span class="keyword">if</span>(result.getCode().intValue() != <span class="number">200</span>) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(result.getCode(), result.getMessage());</span><br><span class="line">   }</span><br><span class="line">   <span class="type">CustomerLoginVo</span> <span class="variable">customerLoginVo</span> <span class="operator">=</span> result.getData();</span><br><span class="line">   <span class="keyword">if</span>(<span class="literal">null</span> == customerLoginVo) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">return</span> customerLoginVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-deng-lu-chu-li">3、登录处理</span></h3><p>用户登录成功，后续小程序的接口都会带上token，要想获取登录用户的信息，都得在controller方法里面解析，很是繁琐，有没有更好的解决方案呢？</p>
<p>当然是有的，我们可以自定义一个登录标签，需要登录的controller方法加上自定义标签，写一个全局AOP拦截器处理登录业务即可，下面来看怎么实现吧。</p>
<h4><span id="3-1-lan-jie-yong-hu-token-chu-li">3.1、拦截用户token处理</span></h4><h5><span id="3-1-1-guigulogin">3.1.1、GuiguLogin</span></h5><p>在service-util定义登录自定义标签</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.common.login;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> GuiguLogin {</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-2-guiguloginaspect">3.1.2、GuiguLoginAspect</span></h5><p>自定义AOP切面类，拦截被@GuiguLogin标识的controller方法</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.common.login;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Order(100)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GuiguLoginAspect</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> joinPoint</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> guiguLogin</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Throwable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Around("execution(* com.atguigu.daijia.*.controller.*.*(..)) &amp;&amp; @annotation(guiguLogin)")</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">process</span><span class="params">(ProceedingJoinPoint joinPoint, GuiguLogin guiguLogin)</span> <span class="keyword">throws</span> Throwable {</span><br><span class="line">        <span class="type">RequestAttributes</span> <span class="variable">ra</span> <span class="operator">=</span> RequestContextHolder.getRequestAttributes();</span><br><span class="line">        <span class="type">ServletRequestAttributes</span> <span class="variable">sra</span> <span class="operator">=</span> (ServletRequestAttributes) ra;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> sra.getRequest();</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">"token"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!StringUtils.hasText(token)) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.LOGIN_AUTH);</span><br><span class="line">        }</span><br><span class="line">        <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> (String)redisTemplate.opsForValue().get(RedisConstant.USER_LOGIN_KEY_PREFIX+token);</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.hasText(userId)) {</span><br><span class="line">            AuthContextHolder.setUserId(Long.parseLong(userId));</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> joinPoint.proceed();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>AuthContextHolder封装了ThreadLocal，用于保存当前线程的用户id，这样后面controller方法就能够获取当前用户id了。</p>
<h4><span id="3-2-gai-zao-huo-qu-ke-hu-deng-lu-xin-xi">3.2、改造获取客户登录信息</span></h4><h5><span id="3-2-1-customercontroller">3.2.1、CustomerController</span></h5><p>乘客端web接口改造</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "获取客户登录信息")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("/getCustomerLoginInfo")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;CustomerLoginVo&gt; <span class="title function_">getCustomerLoginInfo</span><span class="params">()</span> {</span><br><span class="line">   <span class="type">Long</span> <span class="variable">customerId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">   <span class="keyword">return</span> Result.ok(customerInfoService.getCustomerLoginInfo(customerId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>简洁、清晰、明了</p>
<h3><span id="4-huo-qu-cheng-ke-shou-ji-hao-ma">4、获取乘客手机号码</span></h3><p>乘客下单代驾，司机会电话联系乘客，因此乘客必须绑定手机号码，微信小程序可以申请获取用户微信平台手机号码。</p>
<p><strong>说明：获取手机号必须是企业级微信公众号，个人版获取不到。</strong></p>
<p>只要没有绑定手机号码，小程序登录后就会弹出提示，如果下图</p>
<p><img src="/2024/09/26/projection-daijia/phone.gif" alt="phone"></p>
<h4><span id="4-1-huo-qu-wei-xin-shou-ji-hao-ma">4.1、获取微信手机号码</span></h4><h5><span id="4-1-1-xiao-cheng-xu-duan">4.1.1、小程序端</span></h5><p>官方文档：<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html">https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html</a></p>
<p>该能力旨在帮助开发者向用户发起手机号申请，并且<strong>必须经过用户同意后</strong>，开发者才可获得由平台验证后的手机号，进而为用户提供相应服务。</p>
<p><strong>收费说明</strong></p>
<p>自2023年8月28日起，手机号快速验证组件将需要付费使用。标准单价为：每次组件调用成功，收费0.03元</p>
<p>体验额度：每个小程序账号将有1000次体验额度，用于开发、调试和体验。</p>
<p>详情参考官方文档</p>
<h5><span id="4-1-2-fu-wu-qi-duan">4.1.2、服务器端</span></h5><p>官方文档：<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-info/phone-number/getPhoneNumber.html">https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-info/phone-number/getPhoneNumber.html</a></p>
<p>该接口需配合<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html">手机号快速验证</a>或<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getRealtimePhoneNumber.html">手机号实时验证</a>能力一起使用，当用户同意后，可以通过 <code>bindgetphonenumber</code> 或 <code>bindrealtimegetphonenumber</code> 事件回调获取到动态令牌<code>code</code>，再调用该接口将<code>code</code>换取用户手机号。</p>
<p><strong>注意：每个code只能使用一次，code的有效期为5min。</strong></p>
<p>详情参考官方文档</p>
<p><strong>该接口同样使用：微信Java开发工具包</strong></p>
<h4><span id="4-2-geng-xin-cheng-ke-shou-ji-hao-ma-wei-fu-wu-jie-kou">4.2、更新乘客手机号码微服务接口</span></h4><h5><span id="4-2-1-customerinfocontroller">4.2.1、CustomerInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "更新客户微信手机号码")</span></span><br><span class="line"><span class="meta">@PostMapping("/updateWxPhoneNumber")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">updateWxPhoneNumber</span><span class="params">(<span class="meta">@RequestBody</span> UpdateWxPhoneForm updateWxPhoneForm)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(customerInfoService.updateWxPhoneNumber(updateWxPhoneForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-2-2-customerinfoservice">4.2.2、CustomerInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">updateWxPhoneNumber</span><span class="params">(UpdateWxPhoneForm updateWxPhoneForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-2-3-customerinfoserviceimpl">4.2.3、CustomerInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = {Exception.class})</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">updateWxPhoneNumber</span><span class="params">(UpdateWxPhoneForm updateWxPhoneForm)</span> {</span><br><span class="line">   <span class="comment">// 调用微信 API 获取用户的手机号</span></span><br><span class="line">   <span class="type">WxMaPhoneNumberInfo</span> <span class="variable">phoneInfo</span> <span class="operator">=</span> wxMaService.getUserService().getPhoneNoInfo(updateWxPhoneForm.getCode());</span><br><span class="line">   <span class="type">String</span> <span class="variable">phoneNumber</span> <span class="operator">=</span> phoneInfo.getPhoneNumber();</span><br><span class="line">   log.info(<span class="string">"phoneInfo:{}"</span>, JSON.toJSONString(phoneInfo));</span><br><span class="line"></span><br><span class="line">   <span class="type">CustomerInfo</span> <span class="variable">customerInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomerInfo</span>();</span><br><span class="line">   customerInfo.setId(updateWxPhoneForm.getCustomerId());</span><br><span class="line">   customerInfo.setPhone(phoneNumber);</span><br><span class="line">   <span class="keyword">return</span> <span class="built_in">this</span>.updateById(customerInfo);</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-3-feign-jie-kou">4.3、Feign接口</span></h4><h5><span id="4-3-1-customerinfofeignclient">4.3.1、CustomerInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更新客户微信手机号码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> updateWxPhoneForm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping("/customer/info/updateWxPhoneNumber")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">updateWxPhoneNumber</span><span class="params">(<span class="meta">@RequestBody</span> UpdateWxPhoneForm updateWxPhoneForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-4-cheng-ke-duan-web-jie-kou">4.4、乘客端Web接口</span></h4><h5><span id="4-4-1-customercontroller">4.4.1、CustomerController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "更新用户微信手机号")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@PostMapping("/updateWxPhone")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">updateWxPhone</span><span class="params">(<span class="meta">@RequestBody</span> UpdateWxPhoneForm updateWxPhoneForm)</span> {</span><br><span class="line">   updateWxPhoneForm.setCustomerId(AuthContextHolder.getUserId());</span><br><span class="line">   <span class="keyword">return</span> Result.ok(customerInfoService.updateWxPhoneNumber(updateWxPhoneForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>微信公众号为个人版的需调整为如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "更新用户微信手机号")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@PostMapping("/updateWxPhone")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">updateWxPhone</span><span class="params">(<span class="meta">@RequestBody</span> UpdateWxPhoneForm updateWxPhoneForm)</span> {</span><br><span class="line">   updateWxPhoneForm.setCustomerId(AuthContextHolder.getUserId());</span><br><span class="line">   <span class="comment">//customerInfoService.updateWxPhoneNumber(updateWxPhoneForm);</span></span><br><span class="line">   <span class="keyword">return</span> Result.ok(<span class="literal">true</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>说明：个人版的获取不到手机号，直接跳过</p>
<h5><span id="4-4-2-customerservice">4.4.2、CustomerService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">updateWxPhoneNumber</span><span class="params">(<span class="meta">@RequestBody</span> UpdateWxPhoneForm updateWxPhoneForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-4-3-customerserviceimpl">4.4.3、CustomerServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">updateWxPhoneNumber</span><span class="params">(UpdateWxPhoneForm updateWxPhoneForm)</span> {</span><br><span class="line">    customerInfoFeignClient.updateWxPhoneNumber(updateWxPhoneForm);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>


<h3><span id="5-zi-ding-yi-feign-jie-guo-jie-xi">5、自定义Feign结果解析</span></h3><p>在Feign调用的过程中，由于全局异常的处理，所有的Feign调用都会返回Result<t>对象，我们还必须判断它的code是否等于200，如果不等于200，那么说明调用结果抛出异常了，我们必须返回异常信息提示给接口，如果返回code等于200，我们又必须判断data是否等于null，处理方式都一致，处理起来很繁琐，有没有好的统一处理方式呢？</t></p>
<p>答案是肯定的，我们可以通过全局自定义Feign结果解析来处理就可以了。</p>
<p>说明：任何Feign调用Result<t>对象的data我们都必须默认给一个返回值，否则任务数据异常。</t></p>
<h4><span id="5-1-feigncustomdatadecoder">5.1、FeignCustomDataDecoder</span></h4><p>OpenFeign 自定义结果解码器</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.common.feign;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.common.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.common.result.ResultCodeEnum;</span><br><span class="line"><span class="keyword">import</span> feign.Response;</span><br><span class="line"><span class="keyword">import</span> feign.codec.DecodeException;</span><br><span class="line"><span class="keyword">import</span> feign.codec.Decoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.support.SpringDecoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Type;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * OpenFeign 自定义结果解码器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignCustomDataDecoder</span> <span class="keyword">implements</span> <span class="title class_">Decoder</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SpringDecoder decoder;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FeignCustomDataDecoder</span><span class="params">(SpringDecoder decoder)</span> {</span><br><span class="line">        <span class="built_in">this</span>.decoder = decoder;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">decode</span><span class="params">(Response response, Type type)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> <span class="built_in">this</span>.decoder.decode(response, type);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == object) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DecodeException</span>(ResultCodeEnum.FEIGN_FAIL.getCode(), ResultCodeEnum.FEIGN_FAIL.getMessage(), response.request());<span class="comment">//"数据解析失败"</span></span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span>(object <span class="keyword">instanceof</span> Result&lt;?&gt;) {</span><br><span class="line">            Result&lt;?&gt; result = ( Result&lt;?&gt;)object;</span><br><span class="line">            <span class="comment">//返回状态!=200，直接抛出异常，全局异常捕获异常，接口提示</span></span><br><span class="line">            <span class="keyword">if</span> (result.getCode().intValue() != ResultCodeEnum.SUCCESS.getCode().intValue()) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DecodeException</span>(result.getCode(), result.getMessage(), response.request());<span class="comment">//"数据解析失败"</span></span><br><span class="line">            }</span><br><span class="line">            <span class="comment">//远程调用必须有返回值，具体调用中不用判断result.getData() == null，这里统一处理</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == result.getData()) {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DecodeException</span>(ResultCodeEnum.FEIGN_FAIL.getCode(), ResultCodeEnum.FEIGN_FAIL.getMessage(), response.request());<span class="comment">//"数据解析失败"</span></span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="5-2-feignconfig">5.2、FeignConfig</span></h4><p> Feign配置类</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.common.feign;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> feign.codec.Decoder;</span><br><span class="line"><span class="keyword">import</span> feign.optionals.OptionalDecoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.ObjectFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.ObjectProvider;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.http.HttpMessageConverters;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.support.HttpMessageConverterCustomizer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.support.ResponseEntityDecoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.support.SpringDecoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Feign配置类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignConfig</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义解析器</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msgConverters 信息转换</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> customizers   自定义参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 解析器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Decoder <span class="title function_">decoder</span><span class="params">(ObjectFactory&lt;HttpMessageConverters&gt; msgConverters, ObjectProvider&lt;HttpMessageConverterCustomizer&gt; customizers)</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OptionalDecoder</span>((<span class="keyword">new</span> <span class="title class_">ResponseEntityDecoder</span>(<span class="keyword">new</span> <span class="title class_">FeignCustomDataDecoder</span>(<span class="keyword">new</span> <span class="title class_">SpringDecoder</span>(msgConverters, customizers)))));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="5-3-customerserviceimpl">5.3、CustomerServiceImpl</span></h4><p>改造乘客端web接口方法</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">login</span><span class="params">(String code)</span> {</span><br><span class="line">   <span class="type">Long</span> <span class="variable">customerId</span> <span class="operator">=</span> customerInfoFeignClient.login(code).getData();</span><br><span class="line"></span><br><span class="line">   <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> UUID.randomUUID().toString().replaceAll(<span class="string">"-"</span>, <span class="string">""</span>);</span><br><span class="line">   redisTemplate.opsForValue().set(RedisConstant.USER_LOGIN_KEY_PREFIX+token, customerId.toString(), RedisConstant.USER_LOGIN_KEY_TIMEOUT, TimeUnit.SECONDS);</span><br><span class="line">   <span class="keyword">return</span> token;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CustomerLoginVo <span class="title function_">getCustomerLoginInfo</span><span class="params">(Long customerId)</span> {</span><br><span class="line">   <span class="keyword">return</span> customerInfoFeignClient.getCustomerLoginInfo(customerId).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="5-4-ce-shi">5.4、测试</span></h4><p>swg测试小程序登录接口（code随便输入，让他报错），在FeignCustomDataDecoder类设置断点，查看是否正确解析，改造前与改造后返回结果是否一致；如果一致说明全局统一处理成功。</p>
<h1><span id="iii-si-ji-duan-deng-lu-yu-ren-zheng">Ⅲ.司机端登录与认证</span></h1><p><strong>学习目标：</strong></p>
<ul>
<li>完成司机端微信授权登录与获取司机登录信息</li>
<li>掌握腾讯云对象存储COS</li>
<li>掌握腾讯云OCR，识别身份证与驾驶证</li>
<li>完成司机认证功能</li>
<li>掌握司机腾讯云人脸识别技术</li>
</ul>
<h3><span id="1-si-ji-deng-lu">1、司机登录</span></h3><p>司机端登录跟乘客端登录一致，都是微信授权登录，司机第一次登录需要初始化司机设置消息、司机账户信息等。</p>
<p><img src="/2024/09/26/projection-daijia/dr_phone.gif" alt="login"></p>
<h4><span id="1-1-si-ji-wei-fu-wu-jie-kou">1.1、司机微服务接口</span></h4><p>操作模块：service-driver</p>
<h5><span id="1-1-1-pom-xml">1.1.1、pom.xml</span></h5><p>引入依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.binarywang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>weixin-java-miniapp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>说明：在父工程已经对改依赖进行了版本管理，这里直接引入即可</p>
<h5><span id="1-1-2-common-account-yaml">1.1.2、common-account.yaml</span></h5><p>添加配置（已加就忽略）</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wx:</span><br><span class="line">  miniapp:</span><br><span class="line">    #小程序授权登录</span><br><span class="line">    appId: wxcc651fcbab275e33  # 小程序微信公众平台appId</span><br><span class="line">    secret: 5f353399a2eae7ff6ceda383e924c5f6  # 小程序微信公众平台api秘钥</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-3-wxmaproperties">1.1.3、WxMaProperties</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.driver.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = "wx.miniapp")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WxMaProperties</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String appId;</span><br><span class="line">    <span class="keyword">private</span> String secret;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>1.3.4、WxMaConfig</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.driver.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.binarywang.wx.miniapp.api.WxMaService;</span><br><span class="line"><span class="keyword">import</span> cn.binarywang.wx.miniapp.api.impl.WxMaServiceImpl;</span><br><span class="line"><span class="keyword">import</span> cn.binarywang.wx.miniapp.config.impl.WxMaDefaultConfigImpl;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WxMaConfig</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WxMaProperties wxMaProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> WxMaService <span class="title function_">wxMaService</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">WxMaDefaultConfigImpl</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WxMaDefaultConfigImpl</span>();</span><br><span class="line">        config.setAppid(wxMaProperties.getAppId());</span><br><span class="line">        config.setSecret(wxMaProperties.getSecret());</span><br><span class="line"></span><br><span class="line">        <span class="type">WxMaService</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WxMaServiceImpl</span>();</span><br><span class="line">        service.setWxMaConfig(config);</span><br><span class="line">        <span class="keyword">return</span> service;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-3-4-driverinfocontroller">1.3.4、DriverInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DriverInfoService driverInfoService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "小程序授权登录")</span></span><br><span class="line"><span class="meta">@GetMapping("/login/{code}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Long&gt; <span class="title function_">login</span><span class="params">(<span class="meta">@PathVariable</span> String code)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(driverInfoService.login(code));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-3-5-driverinfoservice">1.3.5、DriverInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Long <span class="title function_">login</span><span class="params">(String code)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-3-6-driverinfoserviceimpl">1.3.6、DriverInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DriverInfoMapper driverInfoMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DriverAccountMapper driverAccountMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> WxMaService wxMaService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DriverSetMapper driverSetMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DriverLoginLogMapper driverLoginLogMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">login</span><span class="params">(String code)</span> {</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">openId</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">//获取openId</span></span><br><span class="line">        <span class="type">WxMaJscode2SessionResult</span> <span class="variable">sessionInfo</span> <span class="operator">=</span> wxMaService.getUserService().getSessionInfo(code);</span><br><span class="line">        openId = sessionInfo.getOpenid();</span><br><span class="line">        log.info(<span class="string">"【小程序授权】openId={}"</span>, openId);</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.WX_CODE_ERROR);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">DriverInfo</span> <span class="variable">driverInfo</span> <span class="operator">=</span> <span class="built_in">this</span>.getOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;DriverInfo&gt;().eq(DriverInfo::getWxOpenId, openId));</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == driverInfo) {</span><br><span class="line">        driverInfo = <span class="keyword">new</span> <span class="title class_">DriverInfo</span>();</span><br><span class="line">        driverInfo.setNickname(String.valueOf(System.currentTimeMillis()));</span><br><span class="line">        driverInfo.setAvatarUrl(<span class="string">"https://oss.aliyuncs.com/aliyun_id_photo_bucket/default_handsome.jpg"</span>);</span><br><span class="line">        driverInfo.setWxOpenId(openId);</span><br><span class="line">        <span class="built_in">this</span>.save(driverInfo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化默认设置</span></span><br><span class="line">        <span class="type">DriverSet</span> <span class="variable">driverSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverSet</span>();</span><br><span class="line">        driverSet.setDriverId(driverInfo.getId());</span><br><span class="line">        driverSet.setOrderDistance(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0</span>));<span class="comment">//0：无限制</span></span><br><span class="line">        driverSet.setAcceptDistance(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(SystemConstant.ACCEPT_DISTANCE));<span class="comment">//默认接单范围：5公里</span></span><br><span class="line">        driverSet.setIsAutoAccept(<span class="number">0</span>);<span class="comment">//0：否 1：是</span></span><br><span class="line">        driverSetMapper.insert(driverSet);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化司机账户</span></span><br><span class="line">        <span class="type">DriverAccount</span> <span class="variable">driverAccount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverAccount</span>();</span><br><span class="line">        driverAccount.setDriverId(driverInfo.getId());</span><br><span class="line">        driverAccountMapper.insert(driverAccount);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//登录日志</span></span><br><span class="line">    <span class="type">DriverLoginLog</span> <span class="variable">driverLoginLog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverLoginLog</span>();</span><br><span class="line">    driverLoginLog.setDriverId(driverInfo.getId());</span><br><span class="line">    driverLoginLog.setMsg(<span class="string">"小程序登录"</span>);</span><br><span class="line">    driverLoginLogMapper.insert(driverLoginLog);</span><br><span class="line">    <span class="keyword">return</span> driverInfo.getId();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-feign-jie-kou">1.2、Feign接口</span></h4><h5><span id="1-2-1-driverinfofeignclient">1.2.1、DriverInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 小程序授权登录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> code</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/driver/info/login/{code}")</span></span><br><span class="line">Result&lt;Long&gt; <span class="title function_">login</span><span class="params">(<span class="meta">@PathVariable("code")</span> String code)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-3-si-ji-duan-web-jie-kou">1.3、司机端web接口</span></h4><h5><span id="1-3-1-drivercontroller">1.3.1、DriverController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DriverService driverService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "小程序授权登录")</span></span><br><span class="line"><span class="meta">@GetMapping("/login/{code}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">login</span><span class="params">(<span class="meta">@PathVariable</span> String code)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(driverService.login(code));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-3-2-driverservice">1.3.2、DriverService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String <span class="title function_">login</span><span class="params">(String code)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-3-3-driverserviceimpl">1.3.3、DriverServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DriverInfoFeignClient driverInfoFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">login</span><span class="params">(String code)</span> {</span><br><span class="line">    <span class="comment">//获取openId</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> driverInfoFeignClient.login(code).getData();</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> UUID.randomUUID().toString().replaceAll(<span class="string">"-"</span>, <span class="string">""</span>);</span><br><span class="line">    redisTemplate.opsForValue().set(RedisConstant.USER_LOGIN_KEY_PREFIX + token, driverId.toString(), RedisConstant.USER_LOGIN_KEY_TIMEOUT, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">return</span> token;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>说明：司机端登录后，也需要获取司机登录信息，页面才会跳转，同乘客端一致。</p>
<h3><span id="2-huo-qu-si-ji-deng-lu-xin-xi">2、获取司机登录信息</span></h3><p>司机端每天接单都要进行人脸识别，所以司机登录后都需要判断一下司机到底有没有录入人脸到人脸库</p>
<h4><span id="2-1-si-ji-deng-lu-xin-xi-wei-fu-wu-jie-kou">2.1、司机登录信息微服务接口</span></h4><h5><span id="2-1-1-driverinfocontroller">2.1.1、DriverInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "获取司机登录信息")</span></span><br><span class="line"><span class="meta">@GetMapping("/getDriverLoginInfo/{driverId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;DriverLoginVo&gt; <span class="title function_">getDriverLoginInfo</span><span class="params">(<span class="meta">@PathVariable</span> Long driverId)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(driverInfoService.getDriverLoginInfo(driverId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-2-driverinfoservice">2.1.2、DriverInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DriverLoginVo <span class="title function_">getDriverLoginInfo</span><span class="params">(Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-3-driverinfoserviceimpl">2.1.3、DriverInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DriverLoginVo <span class="title function_">getDriverLoginInfo</span><span class="params">(Long driverId)</span> {</span><br><span class="line">    <span class="type">DriverInfo</span> <span class="variable">driverInfo</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(driverId);</span><br><span class="line">    <span class="type">DriverLoginVo</span> <span class="variable">driverLoginVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverLoginVo</span>();</span><br><span class="line">    BeanUtils.copyProperties(driverInfo, driverLoginVo);</span><br><span class="line">    <span class="comment">//是否创建人脸库人员，接单时做人脸识别判断</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isArchiveFace</span> <span class="operator">=</span> StringUtils.hasText(driverInfo.getFaceModelId());</span><br><span class="line">    driverLoginVo.setIsArchiveFace(isArchiveFace);</span><br><span class="line">    <span class="keyword">return</span> driverLoginVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-2-feign-jie-kou">2.2、Feign接口</span></h4><h5><span id="2-2-1-driverinfofeignclient">2.2.1、DriverInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取司机登录信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/driver/info/getDriverLoginInfo/{driverId}")</span></span><br><span class="line">Result&lt;DriverLoginVo&gt; <span class="title function_">getDriverLoginInfo</span><span class="params">(<span class="meta">@PathVariable("driverId")</span> Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-3-si-ji-duan-web-jie-kou">2.3、司机端web接口</span></h4><h5><span id="2-3-1-drivercontroller">2.3.1、DriverController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "获取司机登录信息")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("/getDriverLoginInfo")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;DriverLoginVo&gt; <span class="title function_">getDriverLoginInfo</span><span class="params">()</span> {</span><br><span class="line">   <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">   <span class="keyword">return</span> Result.ok(driverService.getDriverLoginInfo(driverId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-3-2-driverservice">2.3.2、DriverService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DriverLoginVo <span class="title function_">getDriverLoginInfo</span><span class="params">(Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-3-3-driverserviceimpl">2.3.3、DriverServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DriverLoginVo <span class="title function_">getDriverLoginInfo</span><span class="params">(Long driverId)</span> {</span><br><span class="line">    <span class="keyword">return</span> driverInfoFeignClient.getDriverLoginInfo(driverId).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-kai-tong-teng-xun-yun-dui-xiang-cun-chu-cos">3、开通腾讯云对象存储COS</span></h3><p>接下来我们要实现司机认证模块，司机认证模块需要集成腾讯云对象存储COS、腾讯云OCR证件识别及腾讯云人脸模型库创建，先学习完这些前置接口，再编写认证提交接口，如图：</p>
<p><img src="/2024/09/26/projection-daijia/dr_auth.gif" alt="auth"></p>
<h4><span id="3-1-kai-tong-teng-xun-yun-dui-xiang-cun-chu-cos">3.1、开通腾讯云对象存储COS</span></h4><p>首先注册与登录等腾讯云，官网地址：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/">https://cloud.tencent.com/</a></p>
<p>开通腾讯云对象存储COS：官网地址：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/cos">https://cloud.tencent.com/product/cos</a></p>
<p><img src="/2024/09/26/projection-daijia/1698820225341.png" alt="69882022534"></p>
<p>进入控制台：</p>
<p><img src="/2024/09/26/projection-daijia/1698820336451.png" alt="69882033645"></p>
<h4><span id="3-2-huo-de-teng-xun-yun-fang-wen-mi-yao">3.2、获得腾讯云访问密钥</span></h4><p>调用腾讯云各种服务是需要用到密钥的，例如数据万象、对象存储等等。</p>
<p><img src="/2024/09/26/projection-daijia/1698820499372.png" alt="69882049937"></p>
<p>在访问管理页面中新建密钥，然后你把腾讯云的<code>APPID</code>、<code>SecretId</code>和<code>SecretKey</code>都记下来，一会儿我们写程序要用到。</p>
<p><img src="/2024/09/26/projection-daijia/1698820557253.png" alt="69882055725"></p>
<h4><span id="3-3-chuang-jian-cun-chu-tong">3.3、创建存储桶</span></h4><p>我们在对象存储中创建一个私有存储桶，用来存放身份证和驾驶证这些保密度较高的图片。</p>
<p>创建私有存储桶：</p>
<p><img src="/2024/09/26/projection-daijia/1698820814564.png" alt="69882081456"></p>
<p>创建存储桶：</p>
<p><img src="/2024/09/26/projection-daijia/1698820911879.png" alt="69882091187"></p>
<p>下一步：</p>
<p><img src="/2024/09/26/projection-daijia/1698820942781.png" alt="69882094278"></p>
<p>下一步：</p>
<p><img src="/2024/09/26/projection-daijia/1698820973089.png" alt="69882097308"></p>
<p>创建</p>
<h4><span id="3-4-api-wen-dang">3.4、API文档</span></h4><p>文档地址：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/436/10199">https://cloud.tencent.com/document/product/436/10199</a></p>
<p>初始化客户端</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1 初始化用户身份信息（secretId, secretKey）。</span></span><br><span class="line"><span class="comment">// SECRETID和SECRETKEY请登录访问管理控制台 https://console.cloud.tencent.com/cam/capi 进行查看和管理</span></span><br><span class="line"><span class="type">String</span> <span class="variable">secretId</span> <span class="operator">=</span> <span class="string">"SECRETID"</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">secretKey</span> <span class="operator">=</span> <span class="string">"SECRETKEY"</span>;</span><br><span class="line"><span class="type">COSCredentials</span> <span class="variable">cred</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicCOSCredentials</span>(secretId, secretKey);</span><br><span class="line"><span class="comment">// 2 设置 bucket 的地域, COS 地域的简称请参照 https://cloud.tencent.com/document/product/436/6224</span></span><br><span class="line"><span class="comment">// clientConfig 中包含了设置 region, https(默认 http), 超时, 代理等 set 方法, 使用可参见源码或者常见问题 Java SDK 部分。</span></span><br><span class="line"><span class="type">Region</span> <span class="variable">region</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Region</span>(<span class="string">"COS_REGION"</span>);</span><br><span class="line"><span class="type">ClientConfig</span> <span class="variable">clientConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientConfig</span>(region);</span><br><span class="line"><span class="comment">// 这里建议设置使用 https 协议</span></span><br><span class="line"><span class="comment">// 从 5.6.54 版本开始，默认使用了 https</span></span><br><span class="line">clientConfig.setHttpProtocol(HttpProtocol.https);</span><br><span class="line"><span class="comment">// 3 生成 cos 客户端。</span></span><br><span class="line"><span class="type">COSClient</span> <span class="variable">cosClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">COSClient</span>(cred, clientConfig);</span><br></pre></td></tr></tbody></table></figure>

<p><strong>上传对象</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 指定要上传的文件</span></span><br><span class="line"><span class="type">File</span> <span class="variable">localFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(localFilePath);</span><br><span class="line"><span class="comment">// 指定文件将要存放的存储桶</span></span><br><span class="line"><span class="type">String</span> <span class="variable">bucketName</span> <span class="operator">=</span> <span class="string">"examplebucket-1250000000"</span>; <span class="comment">//存储桶名字-编号</span></span><br><span class="line"><span class="comment">// 指定文件上传到 COS 上的路径，即对象键。例如对象键为folder/picture.jpg，则表示将文件 picture.jpg 上传到 folder 路径下</span></span><br><span class="line"><span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">"exampleobject"</span>; </span><br><span class="line"><span class="type">PutObjectRequest</span> <span class="variable">putObjectRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PutObjectRequest</span>(bucketName, key, localFile);</span><br><span class="line"><span class="type">PutObjectResult</span> <span class="variable">putObjectResult</span> <span class="operator">=</span> cosClient.putObject(putObjectRequest);</span><br></pre></td></tr></tbody></table></figure>

<p><strong>删除对象</strong>：删除 COS 上指定路径的对象，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Bucket的命名格式为 BucketName-APPID ，此处填写的存储桶名称必须为此格式</span></span><br><span class="line"><span class="type">String</span> <span class="variable">bucketName</span> <span class="operator">=</span> <span class="string">"examplebucket-1250000000"</span>;</span><br><span class="line"><span class="comment">// 指定被删除的文件在 COS 上的路径，即对象键。例如对象键为folder/picture.jpg，则表示删除位于 folder 路径下的文件 picture.jpg</span></span><br><span class="line"><span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">"exampleobject"</span>;</span><br><span class="line">cosClient.deleteObject(bucketName, key);</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-dui-xiang-yun-cun-chu-cos-shang-chuan-jie-kou">4、对象云存储COS上传接口</span></h3><p>上传证件照到腾讯云私有存储桶，证件信息属于隐私信息，不能随便访问，得有对应的权限才能申请临时访问url。我们先编写上传接口。</p>
<h4><span id="4-1-si-ji-wei-fu-wu-jie-kou">4.1、司机微服务接口</span></h4><h5><span id="4-1-1-tian-jia-yi-lai">4.1.1、添加依赖</span></h5><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.qcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cos_api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-2-common-account-yaml">4.1.2、common-account.yaml</span></h5><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tencent:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">secretId:</span> <span class="string">AKIDxjGYcR0KPFqBH8j6E7l9ICq****</span></span><br><span class="line">    <span class="attr">secretKey:</span> <span class="string">KPFsGPJyNWQ5WheNq55qMcdOuABw****</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">ap-nanjing</span></span><br><span class="line">    <span class="attr">bucketPrivate:</span> <span class="string">daijia-private-1307503602</span></span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-3-tencentcloudproperties">4.1.3、TencentCloudProperties</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.driver.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = "tencent.cloud")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TencentCloudProperties</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String secretId;</span><br><span class="line">    <span class="keyword">private</span> String secretKey;</span><br><span class="line">    <span class="keyword">private</span> String region;</span><br><span class="line">    <span class="keyword">private</span> String bucketPrivate;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-4-coscontroller">4.1.4、CosController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> CosService cosService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "上传")</span></span><br><span class="line"><span class="meta">@PostMapping("/upload")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;CosUploadVo&gt; <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart("file")</span> MultipartFile file, <span class="meta">@RequestParam("path")</span> String path)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(cosService.upload(file, path));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-5-cosservice">4.1.5、CosService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CosUploadVo <span class="title function_">upload</span><span class="params">(MultipartFile file, String <span class="keyword">module</span>)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-6-cosserviceimpl">4.1.6、CosServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> TencentCloudProperties tencentCloudProperties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> COSClient <span class="title function_">getPrivateCOSClient</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">COSCredentials</span> <span class="variable">cred</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicCOSCredentials</span>(tencentCloudProperties.getSecretId(), tencentCloudProperties.getSecretKey());</span><br><span class="line">    <span class="type">ClientConfig</span> <span class="variable">clientConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientConfig</span>(<span class="keyword">new</span> <span class="title class_">Region</span>(tencentCloudProperties.getRegion()));</span><br><span class="line">    clientConfig.setHttpProtocol(HttpProtocol.https);</span><br><span class="line">    <span class="type">COSClient</span> <span class="variable">cosClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">COSClient</span>(cred, clientConfig);</span><br><span class="line">    <span class="keyword">return</span> cosClient;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * https://console.cloud.tencent.com/cos</span></span><br><span class="line"><span class="comment">     * https://cloud.tencent.com/document/product/436/10199</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> module</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CosUploadVo <span class="title function_">upload</span><span class="params">(MultipartFile file, String path)</span> {</span><br><span class="line">    <span class="type">COSClient</span> <span class="variable">cosClient</span> <span class="operator">=</span> <span class="built_in">this</span>.getPrivateCOSClient();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//元数据信息</span></span><br><span class="line">    <span class="type">ObjectMetadata</span> <span class="variable">meta</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMetadata</span>();</span><br><span class="line">    meta.setContentLength(file.getSize());</span><br><span class="line">    meta.setContentEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">    meta.setContentType(file.getContentType());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//向存储桶中保存文件</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">fileType</span> <span class="operator">=</span> file.getOriginalFilename().substring(file.getOriginalFilename().lastIndexOf(<span class="string">"."</span>)); <span class="comment">//文件后缀名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">uploadPath</span> <span class="operator">=</span> <span class="string">"/driver/"</span> + path + <span class="string">"/"</span> + UUID.randomUUID().toString().replaceAll(<span class="string">"-"</span>, <span class="string">""</span>) + fileType;</span><br><span class="line">    <span class="type">PutObjectRequest</span> <span class="variable">putObjectRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PutObjectRequest</span>(tencentCloudProperties.getBucketPrivate(), uploadPath, file.getInputStream(), meta);</span><br><span class="line">    putObjectRequest.setStorageClass(StorageClass.Standard);</span><br><span class="line">    <span class="type">PutObjectResult</span> <span class="variable">putObjectResult</span> <span class="operator">=</span> cosClient.putObject(putObjectRequest); <span class="comment">//上传文件</span></span><br><span class="line">    log.info(JSON.toJSONString(putObjectResult));</span><br><span class="line">    cosClient.shutdown();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装返回对象</span></span><br><span class="line">    <span class="type">CosUploadVo</span> <span class="variable">cosUploadVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CosUploadVo</span>();</span><br><span class="line">    cosUploadVo.setUrl(uploadPath);</span><br><span class="line">    <span class="comment">//图片临时访问url，回显使用</span></span><br><span class="line">    cosUploadVo.setShowUrl(<span class="string">""</span>);</span><br><span class="line">    <span class="keyword">return</span> cosUploadVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-2-feign-jie-kou">4.2、Feign接口</span></h4><h5><span id="4-2-1-cosfeignclient">4.2.1、CosFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上传</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> file</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> path</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(value = "/cos/upload", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line">Result&lt;CosUploadVo&gt; <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart("file")</span> MultipartFile file, <span class="meta">@RequestParam("path")</span> String path)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>注：consumes = MediaType.MULTIPART_FORM_DATA_VALUE</strong></p>
<h4><span id="4-3-si-ji-duan-web-jie-kou">4.3、司机端web接口</span></h4><h5><span id="4-3-1-coscontroller">4.3.1、CosController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> CosService cosService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "上传")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@PostMapping("/upload")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;CosUploadVo&gt; <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart("file")</span> MultipartFile file, <span class="meta">@RequestParam(name = "path", defaultValue = "auth")</span> String path)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(cosService.upload(file, path));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-3-2-cosservice">4.3.2、CosService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CosUploadVo <span class="title function_">upload</span><span class="params">(MultipartFile file, String path)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-3-3-cosserviceimpl">4.3.3、CosServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CosUploadVo <span class="title function_">upload</span><span class="params">(MultipartFile file, String path)</span> {</span><br><span class="line">    <span class="keyword">return</span> cosFeignClient.upload(file, path).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3><span id="5-huo-qu-lin-shi-qian-ming-url">5、获取临时签名URL</span></h3><p>上面我们实现了上传，但是页面回显还不能显示，当前我们来实现获取临时签名url接口，当前接口不需要对外服务，所以只是编写一个service方法即可。</p>
<p>官方文档地址：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/436/35217">https://cloud.tencent.com/document/product/436/35217</a></p>
<h4><span id="5-1-si-ji-wei-fu-wu-jie-kou">5.1、司机微服务接口</span></h4><h5><span id="5-1-1-cosservice">5.1.1、CosService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String <span class="title function_">getImageUrl</span><span class="params">(String path)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-1-2-cosserviceimpl">5.1.2、CosServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getImageUrl</span><span class="params">(String path)</span> {</span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.hasText(path)) <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">COSClient</span> <span class="variable">cosClient</span> <span class="operator">=</span> getPrivateCOSClient();</span><br><span class="line">    <span class="type">GeneratePresignedUrlRequest</span> <span class="variable">request</span> <span class="operator">=</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">GeneratePresignedUrlRequest</span>(tencentCloudProperties.getBucketPrivate(), path, HttpMethodName.GET);</span><br><span class="line">    <span class="comment">//设置临时URL有效期为15分钟</span></span><br><span class="line">    <span class="type">Date</span> <span class="variable">expiration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DateTime</span>().plusMinutes(<span class="number">15</span>).toDate();</span><br><span class="line">    request.setExpiration(expiration);</span><br><span class="line">    <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> cosClient.generatePresignedUrl(request);</span><br><span class="line">    cosClient.shutdown();</span><br><span class="line">    <span class="keyword">return</span> url.toString();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="5-2-wan-shan-shang-chuan-jie-kou">5.2、完善上传接口</span></h4><h5><span id="5-2-1-cosserviceimpl">5.2.1、CosServiceImpl</span></h5><p>关键代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//图片临时访问url，回显使用</span></span><br><span class="line">cosUploadVo.setShowUrl(<span class="built_in">this</span>.getImageUrl(path));</span><br></pre></td></tr></tbody></table></figure>

<p>完整代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CosUploadVo <span class="title function_">upload</span><span class="params">(MultipartFile file, String path)</span> {</span><br><span class="line">    <span class="type">COSClient</span> <span class="variable">cosClient</span> <span class="operator">=</span> <span class="built_in">this</span>.getPrivateCOSClient();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//元数据信息</span></span><br><span class="line">    <span class="type">ObjectMetadata</span> <span class="variable">meta</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMetadata</span>();</span><br><span class="line">    meta.setContentLength(file.getSize());</span><br><span class="line">    meta.setContentEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">    meta.setContentType(file.getContentType());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//向存储桶中保存文件</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">fileType</span> <span class="operator">=</span> file.getOriginalFilename().substring(file.getOriginalFilename().lastIndexOf(<span class="string">"."</span>)); <span class="comment">//文件后缀名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">uploadPath</span> <span class="operator">=</span> <span class="string">"/driver/"</span> + path + <span class="string">"/"</span> + UUID.randomUUID().toString().replaceAll(<span class="string">"-"</span>, <span class="string">""</span>) + fileType;</span><br><span class="line">    <span class="type">PutObjectRequest</span> <span class="variable">putObjectRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PutObjectRequest</span>(tencentCloudProperties.getBucketPrivate(), uploadPath, file.getInputStream(), meta);</span><br><span class="line">    putObjectRequest.setStorageClass(StorageClass.Standard);</span><br><span class="line">    <span class="type">PutObjectResult</span> <span class="variable">putObjectResult</span> <span class="operator">=</span> cosClient.putObject(putObjectRequest); <span class="comment">//上传文件</span></span><br><span class="line">    log.info(JSON.toJSONString(putObjectResult));</span><br><span class="line">    cosClient.shutdown();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装返回对象</span></span><br><span class="line">    <span class="type">CosUploadVo</span> <span class="variable">cosUploadVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CosUploadVo</span>();</span><br><span class="line">    cosUploadVo.setUrl(uploadPath);</span><br><span class="line">    <span class="comment">//图片临时访问url，回显使用</span></span><br><span class="line">    cosUploadVo.setShowUrl(<span class="built_in">this</span>.getImageUrl(uploadPath));</span><br><span class="line">    <span class="keyword">return</span> cosUploadVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="6-teng-xun-yun-shen-fen-zheng-shi-bie-jie-kou">6、腾讯云身份证识别接口</span></h3><p>司机注册成功之后，应该引导他去做实名认证，这就需要用到腾讯云身份证识别和云存储功能了</p>
<p>身份证识别API地址：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/866/33524">https://cloud.tencent.com/document/product/866/33524</a></p>
<h4><span id="6-1-si-ji-duan-wei-fu-wu-jie-kou">6.1、司机端微服务接口</span></h4><h5><span id="6-1-1-ocrcontroller">6.1.1、OcrController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OcrService ocrService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "身份证识别")</span></span><br><span class="line"><span class="meta">@PostMapping("/idCardOcr")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;IdCardOcrVo&gt; <span class="title function_">idCardOcr</span><span class="params">(<span class="meta">@RequestPart("file")</span> MultipartFile file)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(ocrService.idCardOcr(file));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="6-1-2-ocrservice">6.1.2、OcrService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IdCardOcrVo <span class="title function_">idCardOcr</span><span class="params">(MultipartFile file)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="6-1-3-ocrserviceimpl">6.1.3、OcrServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> CosService cosService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> TencentCloudProperties tencentCloudProperties;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文档地址:</span></span><br><span class="line"><span class="comment"> * https://cloud.tencent.com/document/product/866/33524</span></span><br><span class="line"><span class="comment"> * https://console.cloud.tencent.com/api/explorer?Product=ocr&amp;Version=2018-11-19&amp;Action=IDCardOCR</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> file</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> IdCardOcrVo <span class="title function_">idCardOcr</span><span class="params">(MultipartFile file)</span> {</span><br><span class="line">    <span class="comment">//将图片转换为base64字符串</span></span><br><span class="line">    <span class="type">byte</span>[] encoder = Base64.encodeBase64(file.getBytes());</span><br><span class="line">    <span class="type">String</span> <span class="variable">idCardBase64</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(encoder);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实例化一个认证对象，入参需要传入腾讯云账户 SecretId 和 SecretKey，此处还需注意密钥对的保密</span></span><br><span class="line">    <span class="comment">// 代码泄露可能会导致 SecretId 和 SecretKey 泄露，并威胁账号下所有资源的安全性。以下代码示例仅供参考，建议采用更安全的方式来使用密钥，请参见：https://cloud.tencent.com/document/product/1278/85305</span></span><br><span class="line">    <span class="comment">// 密钥可前往官网控制台 https://console.cloud.tencent.com/cam/capi 进行获取</span></span><br><span class="line">    <span class="type">Credential</span> <span class="variable">cred</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Credential</span>(tencentCloudProperties.getSecretId(), tencentCloudProperties.getSecretKey());</span><br><span class="line">    <span class="comment">// 实例化一个http选项，可选的，没有特殊需求可以跳过</span></span><br><span class="line">    <span class="type">HttpProfile</span> <span class="variable">httpProfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpProfile</span>();</span><br><span class="line">    httpProfile.setEndpoint(<span class="string">"ocr.tencentcloudapi.com"</span>);</span><br><span class="line">    <span class="comment">// 实例化一个client选项，可选的，没有特殊需求可以跳过</span></span><br><span class="line">    <span class="type">ClientProfile</span> <span class="variable">clientProfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientProfile</span>();</span><br><span class="line">    clientProfile.setHttpProfile(httpProfile);</span><br><span class="line">    <span class="comment">// 实例化要请求产品的client对象,clientProfile是可选的</span></span><br><span class="line">    <span class="type">OcrClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OcrClient</span>(cred, tencentCloudProperties.getRegion(), clientProfile);</span><br><span class="line">    <span class="comment">// 实例化一个请求对象,每个接口都会对应一个request对象</span></span><br><span class="line">    <span class="type">IDCardOCRRequest</span> <span class="variable">req</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IDCardOCRRequest</span>();</span><br><span class="line">    req.setImageBase64(idCardBase64);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回的resp是一个IDCardOCRResponse的实例，与请求对象对应</span></span><br><span class="line">    <span class="type">IDCardOCRResponse</span> <span class="variable">resp</span> <span class="operator">=</span> client.IDCardOCR(req);</span><br><span class="line">    <span class="comment">// 输出json格式的字符串回包</span></span><br><span class="line">    log.info(IDCardOCRResponse.toJsonString(resp));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//转换为IdCardOcrVo对象</span></span><br><span class="line">    <span class="type">IdCardOcrVo</span> <span class="variable">idCardOcrVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IdCardOcrVo</span>();</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(resp.getName())) {</span><br><span class="line">        <span class="comment">//身份证正面</span></span><br><span class="line">        idCardOcrVo.setName(resp.getName());</span><br><span class="line">        idCardOcrVo.setGender(<span class="string">"男"</span>.equals(resp.getSex()) ? <span class="string">"1"</span> : <span class="string">"2"</span>);</span><br><span class="line">        idCardOcrVo.setBirthday(DateTimeFormat.forPattern(<span class="string">"yyyy/MM/dd"</span>).parseDateTime(resp.getBirth()).toDate());</span><br><span class="line">        idCardOcrVo.setIdcardNo(resp.getIdNum());</span><br><span class="line">        idCardOcrVo.setIdcardAddress(resp.getAddress());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//上传身份证正面图片到腾讯云cos</span></span><br><span class="line">        <span class="type">CosUploadVo</span> <span class="variable">cosUploadVo</span> <span class="operator">=</span> cosService.upload(file, <span class="string">"idCard"</span>);</span><br><span class="line">        idCardOcrVo.setIdcardFrontUrl(cosUploadVo.getUrl());</span><br><span class="line">        idCardOcrVo.setIdcardFrontShowUrl(cosUploadVo.getShowUrl());</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">//身份证反面</span></span><br><span class="line">        <span class="comment">//证件有效期："2010.07.21-2020.07.21"</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">idcardExpireString</span> <span class="operator">=</span> resp.getValidDate().split(<span class="string">"-"</span>)[<span class="number">1</span>];</span><br><span class="line">        idCardOcrVo.setIdcardExpire(DateTimeFormat.forPattern(<span class="string">"yyyy.MM.dd"</span>).parseDateTime(idcardExpireString).toDate());</span><br><span class="line">        <span class="comment">//上传身份证反面图片到腾讯云cos</span></span><br><span class="line">        <span class="type">CosUploadVo</span> <span class="variable">cosUploadVo</span> <span class="operator">=</span> cosService.upload(file, <span class="string">"idCard"</span>);</span><br><span class="line">        idCardOcrVo.setIdcardBackUrl(cosUploadVo.getUrl());</span><br><span class="line">        idCardOcrVo.setIdcardBackShowUrl(cosUploadVo.getShowUrl());</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> idCardOcrVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="6-2-feign-jie-kou">6.2、Feign接口</span></h4><h5><span id="6-2-1-cosfeignclient">6.2.1、CosFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 身份证识别</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> file</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(value = "/ocr/idCardOcr", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line">Result&lt;IdCardOcrVo&gt; <span class="title function_">idCardOcr</span><span class="params">(<span class="meta">@RequestPart("file")</span> MultipartFile file)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>注：consumes = MediaType.MULTIPART_FORM_DATA_VALUE</strong></p>
<h4><span id="6-3-si-ji-duan-web-jie-kou">6.3、司机端web接口</span></h4><h5><span id="6-3-1-ocrcontroller">6.3.1、OcrController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "身份证识别")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@PostMapping("/idCardOcr")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;IdCardOcrVo&gt; <span class="title function_">uploadDriverLicenseOcr</span><span class="params">(<span class="meta">@RequestPart("file")</span> MultipartFile file)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(ocrService.idCardOcr(file));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="6-3-2-ocrservice">6.3.2、OcrService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IdCardOcrVo <span class="title function_">idCardOcr</span><span class="params">(MultipartFile file)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="6-3-3-ocrserviceimpl">6.3.3、OcrServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OcrFeignClient ocrFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> IdCardOcrVo <span class="title function_">idCardOcr</span><span class="params">(MultipartFile file)</span> {</span><br><span class="line">    <span class="keyword">return</span> ocrFeignClient.idCardOcr(file).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="7-teng-xun-yun-jia-shi-zheng-shi-bie-jie-kou">7、腾讯云驾驶证识别接口</span></h3><p>驾驶证识别API地址：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/866/36213">https://cloud.tencent.com/document/product/866/36213</a></p>
<h4><span id="7-1-si-ji-duan-wei-fu-wu-jie-kou">7.1、司机端微服务接口</span></h4><h5><span id="7-1-1-ocrcontroller">7.1.1、OcrController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "驾驶证识别")</span></span><br><span class="line"><span class="meta">@PostMapping("/driverLicenseOcr")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;DriverLicenseOcrVo&gt; <span class="title function_">driverLicenseOcr</span><span class="params">(<span class="meta">@RequestPart("file")</span> MultipartFile file)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(ocrService.driverLicenseOcr(file));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="7-1-2-ocrservice">7.1.2、OcrService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DriverLicenseOcrVo <span class="title function_">driverLicenseOcr</span><span class="params">(MultipartFile file)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="7-1-3-ocrserviceimpl">7.1.3、OcrServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文档地址：</span></span><br><span class="line"><span class="comment"> * https://cloud.tencent.com/document/product/866/36213</span></span><br><span class="line"><span class="comment"> * https://console.cloud.tencent.com/api/explorer?Product=ocr&amp;Version=2018-11-19&amp;Action=DriverLicenseOCR</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> file</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DriverLicenseOcrVo <span class="title function_">driverLicenseOcr</span><span class="params">(MultipartFile file)</span> {</span><br><span class="line">    <span class="comment">//将图片转换为base64字符串</span></span><br><span class="line">    <span class="type">byte</span>[] encoder = Base64.encodeBase64(file.getBytes());</span><br><span class="line">    <span class="type">String</span> <span class="variable">driverLicenseBase64</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(encoder);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实例化一个认证对象，入参需要传入腾讯云账户 SecretId 和 SecretKey，此处还需注意密钥对的保密</span></span><br><span class="line">    <span class="comment">// 代码泄露可能会导致 SecretId 和 SecretKey 泄露，并威胁账号下所有资源的安全性。以下代码示例仅供参考，建议采用更安全的方式来使用密钥，请参见：https://cloud.tencent.com/document/product/1278/85305</span></span><br><span class="line">    <span class="comment">// 密钥可前往官网控制台 https://console.cloud.tencent.com/cam/capi 进行获取</span></span><br><span class="line">    <span class="type">Credential</span> <span class="variable">cred</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Credential</span>(tencentCloudProperties.getSecretId(), tencentCloudProperties.getSecretKey());</span><br><span class="line">    <span class="comment">// 实例化一个http选项，可选的，没有特殊需求可以跳过</span></span><br><span class="line">    <span class="type">HttpProfile</span> <span class="variable">httpProfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpProfile</span>();</span><br><span class="line">    httpProfile.setEndpoint(<span class="string">"ocr.tencentcloudapi.com"</span>);</span><br><span class="line">    <span class="comment">// 实例化一个client选项，可选的，没有特殊需求可以跳过</span></span><br><span class="line">    <span class="type">ClientProfile</span> <span class="variable">clientProfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientProfile</span>();</span><br><span class="line">    clientProfile.setHttpProfile(httpProfile);</span><br><span class="line">    <span class="comment">// 实例化要请求产品的client对象,clientProfile是可选的</span></span><br><span class="line">    <span class="type">OcrClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OcrClient</span>(cred, tencentCloudProperties.getRegion(), clientProfile);</span><br><span class="line">    <span class="comment">// 实例化一个请求对象,每个接口都会对应一个request对象</span></span><br><span class="line">    <span class="type">DriverLicenseOCRRequest</span> <span class="variable">req</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverLicenseOCRRequest</span>();</span><br><span class="line">    req.setImageBase64(driverLicenseBase64);</span><br><span class="line">    <span class="comment">// 返回的resp是一个VehicleLicenseOCRResponse的实例，与请求对象对应</span></span><br><span class="line">    <span class="type">DriverLicenseOCRResponse</span> <span class="variable">resp</span> <span class="operator">=</span> client.DriverLicenseOCR(req);</span><br><span class="line">    <span class="comment">// 输出json格式的字符串回包</span></span><br><span class="line">    log.info(VehicleLicenseOCRResponse.toJsonString(resp));</span><br><span class="line"></span><br><span class="line">    <span class="type">DriverLicenseOcrVo</span> <span class="variable">driverLicenseOcrVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverLicenseOcrVo</span>();</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(resp.getName())) {</span><br><span class="line">        <span class="comment">//驾驶证正面</span></span><br><span class="line">        <span class="comment">//驾驶证名称要与身份证名称一致</span></span><br><span class="line">        driverLicenseOcrVo.setName(resp.getName());</span><br><span class="line">        driverLicenseOcrVo.setDriverLicenseClazz(resp.getClass_());</span><br><span class="line">        driverLicenseOcrVo.setDriverLicenseNo(resp.getCardCode());</span><br><span class="line">        driverLicenseOcrVo.setDriverLicenseIssueDate(DateTimeFormat.forPattern(<span class="string">"yyyy-MM-dd"</span>).parseDateTime(resp.getDateOfFirstIssue()).toDate());</span><br><span class="line">        driverLicenseOcrVo.setDriverLicenseExpire(DateTimeFormat.forPattern(<span class="string">"yyyy-MM-dd"</span>).parseDateTime(resp.getEndDate()).toDate());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//上传驾驶证反面图片到腾讯云cos</span></span><br><span class="line">        <span class="type">CosUploadVo</span> <span class="variable">cosUploadVo</span> <span class="operator">=</span> cosService.upload(file, <span class="string">"driverLicense"</span>);</span><br><span class="line">        driverLicenseOcrVo.setDriverLicenseFrontUrl(cosUploadVo.getUrl());</span><br><span class="line">        driverLicenseOcrVo.setDriverLicenseFrontShowUrl(cosUploadVo.getShowUrl());</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">//驾驶证反面</span></span><br><span class="line">        <span class="comment">//上传驾驶证反面图片到腾讯云cos</span></span><br><span class="line">        <span class="type">CosUploadVo</span> <span class="variable">cosUploadVo</span> <span class="operator">=</span>  cosService.upload(file, <span class="string">"driverLicense"</span>);</span><br><span class="line">        driverLicenseOcrVo.setDriverLicenseBackUrl(cosUploadVo.getUrl());</span><br><span class="line">        driverLicenseOcrVo.setDriverLicenseBackShowUrl(cosUploadVo.getShowUrl());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> driverLicenseOcrVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="7-2-feign-jie-kou">7.2、Feign接口</span></h4><h5><span id="7-2-1-ocrfeignclient">7.2.1、OcrFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 驾驶证识别</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> file</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(value = "/ocr/driverLicenseOcr", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)</span></span><br><span class="line">Result&lt;DriverLicenseOcrVo&gt; <span class="title function_">driverLicenseOcr</span><span class="params">(<span class="meta">@RequestPart("file")</span> MultipartFile file)</span>;</span><br></pre></td></tr></tbody></table></figure>

<p><strong>注：consumes = MediaType.MULTIPART_FORM_DATA_VALUE</strong></p>
<h4><span id="7-3-si-ji-duan-web-jie-kou">7.3、司机端web接口</span></h4><h5><span id="7-3-1-ocrcontroller">7.3.1、OcrController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "驾驶证识别")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@PostMapping("/driverLicenseOcr")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;DriverLicenseOcrVo&gt; <span class="title function_">driverLicenseOcr</span><span class="params">(<span class="meta">@RequestPart("file")</span> MultipartFile file)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(ocrService.driverLicenseOcr(file));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="7-3-2-ocrservice">7.3.2、OcrService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DriverLicenseOcrVo <span class="title function_">driverLicenseOcr</span><span class="params">(MultipartFile file)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="7-3-3-ocrserviceimpl">7.3.3、OcrServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DriverLicenseOcrVo <span class="title function_">driverLicenseOcr</span><span class="params">(MultipartFile file)</span> {</span><br><span class="line">    <span class="keyword">return</span> ocrFeignClient.driverLicenseOcr(file).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="8-huo-qu-si-ji-ren-zheng-xin-xi">8、获取司机认证信息</span></h3><p>司机登录成功后，会判断司机是否认证，如果未认证调到认证页面，认证页面为修改与查看页面，未认证通过可反复提交认证，因此我们要先查看认证信息。</p>
<p>进入认证页面我们要回显证件信息，因此要申请临时访问路径。</p>
<h4><span id="8-1-huo-qu-si-ji-ren-zheng-xin-xi-wei-fu-wu-jie-kou">8.1、获取司机认证信息微服务接口</span></h4><h5><span id="8-1-1-driverinfocontroller">8.1.1、DriverInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "获取司机认证信息")</span></span><br><span class="line"><span class="meta">@GetMapping("/getDriverAuthInfo/{driverId}")</span></span><br><span class="line">Result&lt;DriverAuthInfoVo&gt; <span class="title function_">getDriverAuthInfo</span><span class="params">(<span class="meta">@PathVariable("driverId")</span> Long driverId)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(driverInfoService.getDriverAuthInfo(driverId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="8-1-2-driverinfoservice">8.1.2、DriverInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DriverAuthInfoVo <span class="title function_">getDriverAuthInfo</span><span class="params">(Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="8-1-3-driverinfoserviceimpl">8.1.3、DriverInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> CosService cosService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DriverAuthInfoVo <span class="title function_">getDriverAuthInfo</span><span class="params">(Long driverId)</span> {</span><br><span class="line">    <span class="type">DriverInfo</span> <span class="variable">driverInfo</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(driverId);</span><br><span class="line">    <span class="type">DriverAuthInfoVo</span> <span class="variable">driverAuthInfoVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverAuthInfoVo</span>();</span><br><span class="line">    BeanUtils.copyProperties(driverInfo, driverAuthInfoVo);</span><br><span class="line">    driverAuthInfoVo.setIdcardBackShowUrl(cosService.getImageUrl(driverAuthInfoVo.getIdcardBackUrl()));</span><br><span class="line">    driverAuthInfoVo.setIdcardFrontShowUrl(cosService.getImageUrl(driverAuthInfoVo.getIdcardFrontUrl()));</span><br><span class="line">    driverAuthInfoVo.setIdcardHandShowUrl(cosService.getImageUrl(driverAuthInfoVo.getIdcardHandUrl()));</span><br><span class="line">    driverAuthInfoVo.setDriverLicenseFrontShowUrl(cosService.getImageUrl(driverAuthInfoVo.getDriverLicenseFrontUrl()));</span><br><span class="line">    driverAuthInfoVo.setDriverLicenseBackShowUrl(cosService.getImageUrl(driverAuthInfoVo.getDriverLicenseBackUrl()));</span><br><span class="line">    driverAuthInfoVo.setDriverLicenseHandShowUrl(cosService.getImageUrl(driverAuthInfoVo.getDriverLicenseHandUrl()));</span><br><span class="line">    <span class="keyword">return</span> driverAuthInfoVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="8-2-feign-jie-kou">8.2、Feign接口</span></h4><h5><span id="8-2-1-driverinfofeignclient">8.2.1、DriverInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取司机认证信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/driver/info/getDriverAuthInfo/{driverId}")</span></span><br><span class="line">Result&lt;DriverAuthInfoVo&gt; <span class="title function_">getDriverAuthInfo</span><span class="params">(<span class="meta">@PathVariable("driverId")</span> Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="8-3-si-ji-duan-web-jie-kou">8.3、司机端web接口</span></h4><h5><span id="8-3-1-drivercontroller">8.3.1、DriverController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "获取司机认证信息")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("/getDriverAuthInfo")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;DriverAuthInfoVo&gt; <span class="title function_">getDriverAuthInfo</span><span class="params">()</span> {</span><br><span class="line">   <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">   <span class="keyword">return</span> Result.ok(driverService.getDriverAuthInfo(driverId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="8-3-2-driverservice">8.3.2、DriverService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DriverAuthInfoVo <span class="title function_">getDriverAuthInfo</span><span class="params">(Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="8-3-3-driverserviceimpl">8.3.3、DriverServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DriverAuthInfoVo <span class="title function_">getDriverAuthInfo</span><span class="params">(Long driverId)</span> {</span><br><span class="line">    <span class="keyword">return</span> driverInfoFeignClient.getDriverAuthInfo(driverId).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="9-xiu-gai-si-ji-ren-zheng-xin-xi">9、修改司机认证信息</span></h3><p><strong>认证状态：</strong></p>
<p>​	 0:未认证 【刚注册完为未认证状态】</p>
<p>​	1：审核中 【提交了认证信息后变为审核中】</p>
<p>​	2：认证通过 【后台审核通过】</p>
<p>​	-1：认证未通过【后台审核不通过】</p>
<p><strong>司机开启接单的条件：</strong></p>
<p>​	1、认证通过</p>
<p>​	2、建立了腾讯云人员库人员</p>
<p>​	3、当日验证了人脸识别</p>
<h4><span id="9-1-xiu-gai-si-ji-ren-zheng-xin-xi-wei-fu-wu-jie-kou">9.1、修改司机认证信息微服务接口</span></h4><h5><span id="9-1-1-driverinfocontroller">9.1.1、DriverInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "更新司机认证信息")</span></span><br><span class="line"><span class="meta">@PostMapping("/updateDriverAuthInfo")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">UpdateDriverAuthInfo</span><span class="params">(<span class="meta">@RequestBody</span> UpdateDriverAuthInfoForm updateDriverAuthInfoForm)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(driverInfoService.updateDriverAuthInfo(updateDriverAuthInfoForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="9-1-2-driverinfoservice">9.1.2、DriverInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">updateDriverAuthInfo</span><span class="params">(UpdateDriverAuthInfoForm updateDriverAuthInfoForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="9-1-3-driverinfoserviceimpl">9.1.3、DriverInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">updateDriverAuthInfo</span><span class="params">(UpdateDriverAuthInfoForm updateDriverAuthInfoForm)</span> {</span><br><span class="line">    <span class="type">DriverInfo</span> <span class="variable">driverInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverInfo</span>();</span><br><span class="line">    driverInfo.setId(updateDriverAuthInfoForm.getDriverId());</span><br><span class="line">    BeanUtils.copyProperties(updateDriverAuthInfoForm, driverInfo);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.updateById(driverInfo);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="9-2-feign-jie-kou">9.2、Feign接口</span></h4><h5><span id="9-2-1-driverinfofeignclient">9.2.1、DriverInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新司机认证信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> updateDriverAuthInfoForm</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@PostMapping("/driver/info/updateDriverAuthInfo")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">UpdateDriverAuthInfo</span><span class="params">(<span class="meta">@RequestBody</span> UpdateDriverAuthInfoForm updateDriverAuthInfoForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="9-3-si-ji-duan-web-jie-kou">9.3、司机端web接口</span></h4><h5><span id="9-3-1-drivercontroller">9.3.1、DriverController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "更新司机认证信息")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@PostMapping("/updateDriverAuthInfo")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">updateDriverAuthInfo</span><span class="params">(<span class="meta">@RequestBody</span> UpdateDriverAuthInfoForm updateDriverAuthInfoForm)</span> {</span><br><span class="line">    updateDriverAuthInfoForm.setDriverId(AuthContextHolder.getUserId());</span><br><span class="line">    <span class="keyword">return</span> Result.ok(driverService.updateDriverAuthInfo(updateDriverAuthInfoForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="9-3-2-driverservice">9.3.2、DriverService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">updateDriverAuthInfo</span><span class="params">(UpdateDriverAuthInfoForm updateDriverAuthInfoForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="9-3-3-driverserviceimpl">9.3.3、DriverServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">updateDriverAuthInfo</span><span class="params">(UpdateDriverAuthInfoForm updateDriverAuthInfoForm)</span> {</span><br><span class="line">    <span class="keyword">return</span> driverInfoFeignClient.UpdateDriverAuthInfo(updateDriverAuthInfoForm).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="10-kai-tong-ren-lian-shi-bie">10、开通人脸识别</span></h3><p>新注册的司机都要采集面部信息，以便司机每天第一次接单的时候做身份核验。类似公司人脸打卡，先录入人脸，后续打卡在验证人脸</p>
<h4><span id="10-1-kai-tong-ren-lian-shi-bie">10.1、开通人脸识别</span></h4><p>官网地址：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/facerecognition">https://cloud.tencent.com/product/facerecognition</a></p>
<p><img src="/2024/09/26/projection-daijia/1698827726408.png" alt="69882772640"></p>
<h4><span id="10-2-chuang-jian-ren-yuan-ku">10.2、创建人员库</span></h4><p>为了存放移动端提交的司机面部照片，我们需要先创建人员库，名字是“代驾”，人员库的ID是“daijia-driver”。</p>
<p><img src="/2024/09/26/projection-daijia/1698827882128.png" alt="69882788212"></p>
<p>确定</p>
<p><img src="/2024/09/26/projection-daijia/1700185354841.png" alt="70018535484"></p>
<p><strong>说明：人员库ID 项目里面要使用，需要配置</strong></p>
<h4><span id="10-3-chuang-jian-ren-yuan-ku-ren-yuan-api">10.3、创建人员库人员API</span></h4><p>文档地址：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/document/api/867/45014">https://cloud.tencent.com/document/api/867/45014</a></p>
<h3><span id="11-chuang-jian-si-ji-ren-lian-mo-xing">11、创建司机人脸模型</span></h3><h4><span id="11-1-si-ji-wei-fu-wu-jie-kou">11.1、司机微服务接口</span></h4><h5><span id="11-1-1-common-account-yaml">11.1.1、common-account.yaml</span></h5><p>将persionGroupId加入配置文件</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tencent:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">secretId:</span> <span class="string">AKIDxjGYcR0KPFqBH8j6E7l9ICqFOO9f****</span></span><br><span class="line">    <span class="string">***:</span> <span class="string">***</span></span><br><span class="line">    <span class="attr">persionGroupId:</span> <span class="number">1</span></span><br></pre></td></tr></tbody></table></figure>

<p>说明：persionGroupId为上面创建的人员库id</p>
<h5><span id="11-1-2-tencentcloudproperties">11.1.2、TencentCloudProperties</span></h5><p>添加配置persionGroupId属性</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.driver.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = "tencent.cloud")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TencentCloudProperties</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String secretId;</span><br><span class="line">    ***</span><br><span class="line">    <span class="keyword">private</span> String persionGroupId;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="11-1-3-driverinfocontroller">11.1.3、DriverInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "创建司机人脸模型")</span></span><br><span class="line"><span class="meta">@PostMapping("/creatDriverFaceModel")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">creatDriverFaceModel</span><span class="params">(<span class="meta">@RequestBody</span> DriverFaceModelForm driverFaceModelForm)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(driverInfoService.creatDriverFaceModel(driverFaceModelForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="11-1-4-driverinfoservice">11.1.4、DriverInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">creatDriverFaceModel</span><span class="params">(DriverFaceModelForm driverFaceModelForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="11-1-5-driverinfoserviceimpl">11.1.5、DriverInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> TencentCloudProperties tencentCloudProperties;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文档地址</span></span><br><span class="line"><span class="comment"> * https://cloud.tencent.com/document/api/867/45014</span></span><br><span class="line"><span class="comment"> * https://console.cloud.tencent.com/api/explorer?Product=iai&amp;Version=2020-03-03&amp;Action=CreatePerson</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverFaceModelForm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">creatDriverFaceModel</span><span class="params">(DriverFaceModelForm driverFaceModelForm)</span> {</span><br><span class="line">    <span class="type">DriverInfo</span> <span class="variable">driverInfo</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(driverFaceModelForm.getDriverId());</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 实例化一个认证对象，入参需要传入腾讯云账户 SecretId 和 SecretKey，此处还需注意密钥对的保密</span></span><br><span class="line">        <span class="comment">// 代码泄露可能会导致 SecretId 和 SecretKey 泄露，并威胁账号下所有资源的安全性。以下代码示例仅供参考，建议采用更安全的方式来使用密钥，请参见：https://cloud.tencent.com/document/product/1278/85305</span></span><br><span class="line">        <span class="comment">// 密钥可前往官网控制台 https://console.cloud.tencent.com/cam/capi 进行获取</span></span><br><span class="line">        <span class="type">Credential</span> <span class="variable">cred</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Credential</span>(tencentCloudProperties.getSecretId(), tencentCloudProperties.getSecretKey());</span><br><span class="line">        <span class="comment">// 实例化一个http选项，可选的，没有特殊需求可以跳过</span></span><br><span class="line">        <span class="type">HttpProfile</span> <span class="variable">httpProfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpProfile</span>();</span><br><span class="line">        httpProfile.setEndpoint(<span class="string">"iai.tencentcloudapi.com"</span>);</span><br><span class="line">        <span class="comment">// 实例化一个client选项，可选的，没有特殊需求可以跳过</span></span><br><span class="line">        <span class="type">ClientProfile</span> <span class="variable">clientProfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientProfile</span>();</span><br><span class="line">        clientProfile.setHttpProfile(httpProfile);</span><br><span class="line">        <span class="comment">// 实例化要请求产品的client对象,clientProfile是可选的</span></span><br><span class="line">        <span class="type">IaiClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IaiClient</span>(cred, tencentCloudProperties.getRegion(), clientProfile);</span><br><span class="line">        <span class="comment">// 实例化一个请求对象,每个接口都会对应一个request对象</span></span><br><span class="line">        <span class="type">CreatePersonRequest</span> <span class="variable">req</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CreatePersonRequest</span>();</span><br><span class="line">        req.setGroupId(tencentCloudProperties.getPersionGroupId());</span><br><span class="line">        <span class="comment">//基本信息</span></span><br><span class="line">        req.setPersonId(String.valueOf(driverInfo.getId()));</span><br><span class="line">        req.setGender(Long.parseLong(driverInfo.getGender()));</span><br><span class="line">        req.setQualityControl(<span class="number">4L</span>);</span><br><span class="line">        req.setUniquePersonControl(<span class="number">4L</span>);</span><br><span class="line">        req.setPersonName(driverInfo.getName());</span><br><span class="line">        req.setImage(driverFaceModelForm.getImageBase64());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回的resp是一个CreatePersonResponse的实例，与请求对象对应</span></span><br><span class="line">        <span class="type">CreatePersonResponse</span> <span class="variable">resp</span> <span class="operator">=</span> client.CreatePerson(req);</span><br><span class="line">        <span class="comment">// 输出json格式的字符串回包</span></span><br><span class="line">        System.out.println(CreatePersonResponse.toJsonString(resp));</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(resp.getFaceId())) {</span><br><span class="line">            <span class="comment">//人脸校验必要参数，保存到数据库表</span></span><br><span class="line">            driverInfo.setFaceModelId(resp.getFaceId());</span><br><span class="line">            <span class="built_in">this</span>.updateById(driverInfo);</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (TencentCloudSDKException e) {</span><br><span class="line">        System.out.println(e.toString());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="11-2-feign-jie-kou">11.2、Feign接口</span></h4><h5><span id="11-2-1-driverinfofeignclient">11.2.1、DriverInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建司机人脸模型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverFaceModelForm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping("/driver/info/creatDriverFaceModel")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">creatDriverFaceModel</span><span class="params">(<span class="meta">@RequestBody</span> DriverFaceModelForm driverFaceModelForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="11-3-si-ji-duan-web-jie-kou">11.3、司机端web接口</span></h4><h5><span id="11-3-1-drivercontroller">11.3.1、DriverController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "创建司机人脸模型")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@PostMapping("/creatDriverFaceModel")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">creatDriverFaceModel</span><span class="params">(<span class="meta">@RequestBody</span> DriverFaceModelForm driverFaceModelForm)</span> {</span><br><span class="line">   driverFaceModelForm.setDriverId(AuthContextHolder.getUserId());</span><br><span class="line">   <span class="keyword">return</span> Result.ok(driverService.creatDriverFaceModel(driverFaceModelForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="11-3-2-driverservice">11.3.2、DriverService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">creatDriverFaceModel</span><span class="params">(DriverFaceModelForm driverFaceModelForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="11-3-3-driverserviceimpl">11.3.3、DriverServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">creatDriverFaceModel</span><span class="params">(DriverFaceModelForm driverFaceModelForm)</span> {</span><br><span class="line">    <span class="keyword">return</span> driverInfoFeignClient.creatDriverFaceModel(driverFaceModelForm).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h1><span id="iv-yu-gu-ding-dan-shu-ju">Ⅳ.预估订单数据</span></h1><h2><span id="yi-yu-gu-ding-dan-shu-ju">一、预估订单数据</span></h2><p><strong>学习目标：</strong></p>
<ul>
<li>掌握腾讯位置服务API接口，封装最优路线规划</li>
<li>学习规则引擎 Drools入门</li>
<li>理解代驾费用规则，封装代驾费用接口</li>
<li>完成预估订单数据接口</li>
</ul>
<p>乘客选择代驾起始点与终点，乘客下单前，先做代驾订单数据的预估，预估代驾里程、代驾时间、代驾金额及代驾的最佳驾驶线路，如图：</p>
<p><img src="/2024/09/26/projection-daijia/cm_order.gif" alt="cm_order"></p>
<p>预估订单数据，根据乘客选择的代驾起始点与终点，服务端端需计算最佳驾驶线路与代驾预估金额。</p>
<p>最佳驾驶线路包含：腾讯地图线路数据、距离及时间</p>
<p>代驾预估金额：根据预估里程和代驾时间，结合费用规则，计算代驾金额，代驾金额的计算比较复杂，涉及规则引擎，后续讲到</p>
<p>接下来我们就来处理这部分接口</p>
<h3><span id="1-cha-zhao-cheng-ke-duan-dang-qian-ding-dan">1、查找乘客端当前订单</span></h3><p>乘客如果已经下过单了，而且这个订单在执行中，没有结束，那么乘客是不可以再下单的，页面会弹出层，进入执行中的订单。<br>当前我们必须把这个接口绕过去，不然我们不能进行下单，因此我们模拟一下这个接口，告诉它没有执行中的订单，后续在订单流程中我们完善这个业务。</p>
<h4><span id="1-1-cheng-ke-duan-web-mo-ni-jie-kou">1.1、乘客端web模拟接口</span></h4><h5><span id="1-1-1-ordercontroller">1.1.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "查找乘客端当前订单")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("/searchCustomerCurrentOrder")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;CurrentOrderInfoVo&gt; <span class="title function_">searchCustomerCurrentOrder</span><span class="params">()</span> {</span><br><span class="line">   <span class="type">CurrentOrderInfoVo</span> <span class="variable">currentOrderInfoVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CurrentOrderInfoVo</span>();</span><br><span class="line">   currentOrderInfoVo.setIsHasCurrentOrder(<span class="literal">false</span>);</span><br><span class="line">   <span class="keyword">return</span> Result.ok(currentOrderInfoVo);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-yu-gu-jia-shi-xian-lu">2、预估驾驶线路</span></h3><h4><span id="2-1-qian-duan-wen-ti">2.1、前端问题</span></h4><p>前端乘客选点时，跳入选点页面，页面空白，报如下错误</p>
<p>使用“腾讯位置服务地图选点”插件时，我们要开通“腾讯位置服务”，并且设置授权APP ID，这样才能使用正确使用选点服务。</p>
<p><img src="/2024/09/26/projection-daijia/1702350645852.png" alt="70235064585"></p>
<h4><span id="2-2-kai-tong-teng-xun-wei-zhi-fu-wu">2.2、开通腾讯位置服务</span></h4><p>腾讯位置服务服务器端API文档：<a target="_blank" rel="noopener" href="https://lbs.qq.com/service/webService/webServiceGuide/webServiceOverview">https://lbs.qq.com/service/webService/webServiceGuide/webServiceOverview</a></p>
<p>代驾订单的时候，后端Java项目要预估里程和时间、计算代驾线路，需要调用腾讯位置服务来实现。</p>
<h5><span id="2-2-1-kai-tong-di-tu-fu-wu">2.2.1、开通地图服务</span></h5><p>开通地图服务，首先你要访问腾讯位置服务的官网（<a target="_blank" rel="noopener" href="https://lbs.qq.com/%EF%BC%89%EF%BC%8C%E7%84%B6%E5%90%8E%E6%B3%A8%E5%86%8C%E6%96%B0%E7%94%A8%E6%88%B7%E5%B9%B6%E4%B8%94%E7%99%BB%E9%99%86%E3%80%82">https://lbs.qq.com/），然后注册新用户并且登陆。</a></p>
<p><img src="/2024/09/26/projection-daijia/1698630705623.png" alt="69863070562"></p>
<h5><span id="2-2-2-chuang-jian-ying-yong">2.2.2、创建应用</span></h5><p>控制台 =》 应用管理 =》 我的应用 =》 创建应用</p>
<p>名字可以随便定义，类型选择“出行”，然后就能拿到地图应用的密钥了。这个密钥你保存好，后面我们要用到。</p>
<p><img src="/2024/09/26/projection-daijia/1698630968148.png" alt="69863096814"></p>
<h5><span id="2-2-3-pei-zhi-ying-yong">2.2.3、配置应用</span></h5><p>创建好应用之后，编辑应用，在弹窗中，把WebService设置成“域名白名单”，然后在弹窗底部还要填写你自己的小程序APPID才行。</p>
<p><img src="/2024/09/26/projection-daijia/1698632079808.png" alt="69863207980"></p>
<h5><span id="2-2-4-zhang-hao-e-du">2.2.4、账号额度</span></h5><p>腾讯位置服务给开发者提供了免费的调用额度，只要你每天调用位置服务各种API次数不超过限额，那么就是免费的，对于开发者来说是足够用了。如果我们的项目上线了，这点配额肯定不够用，那就需要出钱购买了。</p>
<p><img src="/2024/09/26/projection-daijia/1698632199115.png" alt="69863219911"></p>
<h5><span id="2-2-5-qian-duan-geng-gai-pei-zhi">2.2.5、前端更改配置</span></h5><p>修改配置：config/config.js 替换为上面申请的key</p>
<p><img src="/2024/09/26/projection-daijia/1702351764916.png" alt="70235176491"></p>
<h4><span id="2-3-feng-zhuang-di-tu-wei-fu-wu-jie-kou">2.3、封装地图微服务接口</span></h4><p>API文档：<a target="_blank" rel="noopener" href="https://lbs.qq.com/service/webService/webServiceGuide/webServiceRoute">https://lbs.qq.com/service/webService/webServiceGuide/webServiceRoute</a></p>
<p>该接口包含：代驾线路规划、预估里程与时间</p>
<h5><span id="2-3-1-common-account-yaml">2.3.1、common-account.yaml</span></h5><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tencent:</span></span><br><span class="line">  <span class="attr">map:</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">PYOBZ-Y6ZRZ-HMZXP-ZTMES-****-****</span></span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-3-2-mapcontroller">2.3.2、MapController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> MapService mapService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "计算驾驶线路")</span></span><br><span class="line"><span class="meta">@PostMapping("/calculateDrivingLine")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;DrivingLineVo&gt; <span class="title function_">calculateDrivingLine</span><span class="params">(<span class="meta">@RequestBody</span> CalculateDrivingLineForm calculateDrivingLineForm)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(mapService.calculateDrivingLine(calculateDrivingLineForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-3-3-mapservice">2.3.3、MapService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DrivingLineVo <span class="title function_">calculateDrivingLine</span><span class="params">(CalculateDrivingLineForm calculateDrivingLineForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-3-4-mapserviceimpl">2.3.4、MapServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value("${tencent.map.key}")</span></span><br><span class="line"><span class="keyword">private</span> String key;    <span class="comment">// 腾讯地图服务</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DrivingLineVo <span class="title function_">calculateDrivingLine</span><span class="params">(CalculateDrivingLineForm calculateDrivingLineForm)</span> {</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">"https://apis.map.qq.com/ws/direction/v1/driving/?from={from}&amp;to={to}&amp;key={key}"</span>;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">"from"</span>, calculateDrivingLineForm.getStartPointLatitude() + <span class="string">","</span> + calculateDrivingLineForm.getStartPointLongitude());</span><br><span class="line">    map.put(<span class="string">"to"</span>, calculateDrivingLineForm.getEndPointLatitude() + <span class="string">","</span> + calculateDrivingLineForm.getEndPointLongitude());</span><br><span class="line">    map.put(<span class="string">"key"</span>, key);</span><br><span class="line"></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">result</span> <span class="operator">=</span> restTemplate.getForObject(url, JSONObject.class, map);</span><br><span class="line">    <span class="keyword">if</span>(result.getIntValue(<span class="string">"status"</span>) != <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.MAP_FAIL);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回第一条最佳线路</span></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">route</span> <span class="operator">=</span> result.getJSONObject(<span class="string">"result"</span>).getJSONArray(<span class="string">"routes"</span>).getJSONObject(<span class="number">0</span>);</span><br><span class="line">    <span class="type">DrivingLineVo</span> <span class="variable">drivingLineVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DrivingLineVo</span>();</span><br><span class="line">    <span class="comment">//单位：千米</span></span><br><span class="line">    drivingLineVo.setDistance(route.getBigDecimal(<span class="string">"distance"</span>).divide(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">1000</span>)).setScale(<span class="number">2</span>, RoundingMode.HALF_UP));</span><br><span class="line">    drivingLineVo.setDuration(route.getBigDecimal(<span class="string">"duration"</span>));</span><br><span class="line">    drivingLineVo.setPolyline(route.getJSONArray(<span class="string">"polyline"</span>));</span><br><span class="line">    <span class="keyword">return</span> drivingLineVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-3-5-servicemapapplication">2.3.5、ServiceMapApplication</span></h5><p>启动类配置RestTemplate</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-4-feign-jie-kou">2.4、Feign接口</span></h4><h5><span id="2-4-1-mapfeignclient">2.4.1、MapFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算驾驶线路</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> calculateDrivingLineForm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping("/map/calculateDrivingLine")</span></span><br><span class="line">Result&lt;DrivingLineVo&gt; <span class="title function_">calculateDrivingLine</span><span class="params">(<span class="meta">@RequestBody</span> CalculateDrivingLineForm calculateDrivingLineForm)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-yu-gu-ding-dan-jin-e">3、预估订单金额</span></h3><p>乘客在选完代驾起始点后，页面显示预估的订单金额，我们需要根据代驾的费用计算规则，计算代驾费用。</p>
<h4><span id="3-1-fei-yong-gui-ze">3.1、费用规则</span></h4><p><strong>代驾费用 = 里程费 + 等候费 + 远途费</strong>， 等候费当前为0，后续根据时间情况获取</p>
<p>说明：费用规则可能根据实际业务情况，随时会更新调整</p>
<h5><span id="3-1-1-li-cheng-fei">3.1.1、里程费</span></h5><p>里程费 = 基础里程费 + 超出起步里程费</p>
<table>
<thead>
<tr>
<th align="left">时间段</th>
<th align="left">基础里程</th>
<th align="left">收费</th>
<th>超出起步里程费</th>
</tr>
</thead>
<tbody><tr>
<td align="left">00:00 - 06:00</td>
<td align="left">3公里</td>
<td align="left">19元</td>
<td>4元/1公里</td>
</tr>
<tr>
<td align="left">06:00 - 22:00</td>
<td align="left">5公里</td>
<td align="left">19元</td>
<td>3元/1公里</td>
</tr>
</tbody></table>
<h5><span id="3-1-2-deng-hou-fei">3.1.2、等候费</span></h5><p>司机达代驾起始点后，可免费等候10分钟，超出后每1分钟收取1</p>
<table>
<thead>
<tr>
<th>规则</th>
<th>收费</th>
</tr>
</thead>
<tbody><tr>
<td>等候10分钟后</td>
<td>1元/1分钟</td>
</tr>
</tbody></table>
<h5><span id="3-1-3-yuan-tu-fei">3.1.3、远途费</span></h5><p>订单行程超出12公里后每公里1元收取远途费</p>
<table>
<thead>
<tr>
<th>规则</th>
<th>收费</th>
</tr>
</thead>
<tbody><tr>
<td>订单行程超出12公里后</td>
<td>1元/1公里</td>
</tr>
</tbody></table>
<h4><span id="3-2-gui-ze-yin-qing">3.2、规则引擎</span></h4><p>对于不经常变化的业务，我们通常是硬编码到程序中。但是经常变化的业务，我们就得把业务流程从代码中剥离出来，我们怎么从程序中剥离出去？这里就需要用到规则引擎了。</p>
<p>规则引擎可以做到把算法剥离出程序，你可以保存到TXT文件或者数据库表里面，用的时候再加载回程序。虽然加载回来的算法是字符串，但是规则引擎有办法运行这些字符串。例如遇到雨雪天气，代驾费用就得上调一些。如果是业务淡季，代驾费用可以下调一点。既然代驾费的算法经常要变动，我们肯定不能把算法写死到程序里面。我们要把算法从程序中抽离，保存到MySQL里面。将来我们要改动计费算法，直接添加一个新纪录就行了，原有记录不需要删改，程序默认使用最新的计费方式。</p>
<h5><span id="3-2-1-gui-ze-yin-qing-ru-men">3.2.1、规则引擎入门</span></h5><p>参考：《4.预估订单数据之规则引擎》</p>
<h4><span id="3-3-ji-cheng-drools">3.3、集成Drools</span></h4><p>操作模块：service-rules</p>
<h5><span id="3-3-1-pom-xml">3.3.1、pom.xml</span></h5><p>引入依赖，版本：8.41.0.Final，父级模块已加入版本管理</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.drools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>drools-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.drools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>drools-compiler<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.drools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>drools-decisiontables<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.drools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>drools-mvel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-3-2-droolsconfig">3.3.2、DroolsConfig</span></h5><p>Drools配置类</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DroolsConfig</span> {</span><br><span class="line">    <span class="comment">// 制定规则文件的路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RULES_CUSTOMER_RULES_DRL</span> <span class="operator">=</span> <span class="string">"rules/FeeRule.drl"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> KieContainer <span class="title function_">kieContainer</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">KieServices</span> <span class="variable">kieServices</span> <span class="operator">=</span> KieServices.Factory.get();</span><br><span class="line">        </span><br><span class="line">        <span class="type">KieFileSystem</span> <span class="variable">kieFileSystem</span> <span class="operator">=</span> kieServices.newKieFileSystem();</span><br><span class="line">        kieFileSystem.write(ResourceFactory.newClassPathResource(RULES_CUSTOMER_RULES_DRL));</span><br><span class="line">        <span class="type">KieBuilder</span> <span class="variable">kb</span> <span class="operator">=</span> kieServices.newKieBuilder(kieFileSystem);</span><br><span class="line">        kb.buildAll();</span><br><span class="line">        </span><br><span class="line">        <span class="type">KieModule</span> <span class="variable">kieModule</span> <span class="operator">=</span> kb.getKieModule();</span><br><span class="line">        <span class="type">KieContainer</span> <span class="variable">kieContainer</span> <span class="operator">=</span> kieServices.newKieContainer(kieModule.getReleaseId());</span><br><span class="line">        <span class="keyword">return</span> kieContainer;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-3-3-ce-shi-drools-huan-jing">3.3.3、测试Drools环境</span></h5><p>测试Drools环境，看看是否能够正常输出，如果正常输出，则Drools环境集成成功</p>
<h6><span id="3-3-3-1-feerule-drl">3.3.3.1、FeeRule.drl</span></h6><p>创建规则文件resources/rules/FeeRule.drl</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span>  com.atguigu.daijia</span><br><span class="line"></span><br><span class="line">rule <span class="string">"rule_1"</span></span><br><span class="line">    when</span><br><span class="line">       <span class="title function_">eval</span><span class="params">(<span class="literal">true</span>)</span>        </span><br><span class="line">    then</span><br><span class="line">        System.out.println(<span class="string">"打印成功"</span>);</span><br><span class="line">end</span><br></pre></td></tr></tbody></table></figure>

<h6><span id="3-3-3-2-bian-xie-ce-shi-lei">3.3.3.2、编写测试类</span></h6><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServiceRulesApplicationTest</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KieContainer kieContainer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 开启会话</span></span><br><span class="line">        <span class="type">KieSession</span> <span class="variable">kieSession</span> <span class="operator">=</span> kieContainer.newKieSession();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 触发规则</span></span><br><span class="line">        kieSession.fireAllRules();</span><br><span class="line">        <span class="comment">// 中止会话</span></span><br><span class="line">        kieSession.dispose();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>执行测试，如果打印：“打印成功”，则测试成功</p>
<h4><span id="3-4-dai-jia-fei-yong-gui-ze-jie-kou">3.4、代驾费用规则接口</span></h4><h5><span id="3-4-1-feng-zhuang-fei-yong-gui-ze-jie-kou">3.4.1、封装费用规则接口</span></h5><h6><span id="3-4-1-1-feng-zhuang-shu-ru-dui-xiang">3.4.1.1、封装输入对象</span></h6><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeeRuleRequest</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "代驾里程")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal distance;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "代驾时间")</span></span><br><span class="line">    <span class="keyword">private</span> String startTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "等候分钟")</span></span><br><span class="line">    <span class="keyword">private</span> Integer waitMinute;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h6><span id="3-4-1-2-feng-zhuang-shu-chu-dui-xiang">3.4.1.2、封装输出对象</span></h6><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeeRuleResponse</span> {</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "总金额")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal totalAmount;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "里程费")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal distanceFee;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "等时费用")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal waitFee;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "远程费")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal longDistanceFee;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "基础里程（公里）")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal baseDistance;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "基础里程费（元）")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal baseDistanceFee;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "超出基础里程的里程（公里）")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal exceedDistance;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "超出基础里程的价格（元/公里）")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal exceedDistancePrice;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "基础等时分钟（分钟）")</span></span><br><span class="line">    <span class="keyword">private</span> Integer baseWaitMinute;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "超出基础等时的分钟（分钟）")</span></span><br><span class="line">    <span class="keyword">private</span> Integer exceedWaitMinute;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "超出基础分钟的价格（元/分钟）")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal exceedWaitMinutePrice;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "基础远途里程（公里）")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal baseLongDistance;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "超出基础远程里程的里程（公里）")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal exceedLongDistance;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "超出基础远程里程的价格（元/公里）")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal exceedLongDistancePrice;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这些属性都是规则引擎需要输出的属性</p>
<h6><span id="3-4-1-3-fei-yong-gui-ze-wen-jian">3.4.1.3、费用规则文件</span></h6><p>创建规则文件resources/rules/FeeRule.drl</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//package对应的不一定是真正的目录，可以任意写com.abc，同一个包下的drl文件可以相互访问</span></span><br><span class="line"><span class="keyword">package</span>  com.atguigu.daijia</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.model.form.rules.FeeRuleRequest;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.math.RoundingMode;</span><br><span class="line"></span><br><span class="line">global com.atguigu.daijia.model.vo.rules.FeeRuleResponse feeRuleResponse;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">1.起步价</span></span><br><span class="line"><span class="comment">    00:00:00-07:00:00  19元(含3公里)</span></span><br><span class="line"><span class="comment">    07:00:00-24:00:00  19元(含5公里)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">rule <span class="string">"起步价 00:00:00-07:00:00  19元(含3公里)"</span></span><br><span class="line">    salience <span class="number">10</span>          <span class="comment">//指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span></span><br><span class="line">    no-loop <span class="literal">true</span>         <span class="comment">//防止陷入死循环</span></span><br><span class="line">    when</span><br><span class="line">        <span class="comment">/*规则条件，到工作内存中查找FeeRuleRequest对象</span></span><br><span class="line"><span class="comment">        里面出来的结果只能是ture或者false</span></span><br><span class="line"><span class="comment">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span></span><br><span class="line">        $rule:FeeRuleRequest(startTime &gt;= <span class="string">"00:00:00"</span> &amp;&amp; startTime &lt; <span class="string">"07:00:00"</span>)</span><br><span class="line">    then</span><br><span class="line">        feeRuleResponse.setBaseDistance(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"3.0"</span>));</span><br><span class="line">        feeRuleResponse.setBaseDistanceFee(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"19.0"</span>));</span><br><span class="line">        <span class="comment">//3公里内里程费为0</span></span><br><span class="line">        feeRuleResponse.setExceedDistance(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"0.0"</span>));</span><br><span class="line">        feeRuleResponse.setExceedDistancePrice(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"4.0"</span>));</span><br><span class="line">        System.out.println(<span class="string">"00:00:00-07:00:00 "</span> + feeRuleResponse.getBaseDistance() + <span class="string">"公里，起步价:"</span> + feeRuleResponse.getBaseDistanceFee() + <span class="string">"元"</span>);</span><br><span class="line">end</span><br><span class="line">rule <span class="string">"起步价 07:00:00-24:00:00  19元(含5公里)"</span></span><br><span class="line">    salience <span class="number">10</span>          <span class="comment">//指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span></span><br><span class="line">    no-loop <span class="literal">true</span>         <span class="comment">//防止陷入死循环</span></span><br><span class="line">    when</span><br><span class="line">        <span class="comment">/*规则条件，到工作内存中查找FeeRuleRequest对象</span></span><br><span class="line"><span class="comment">        里面出来的结果只能是ture或者false</span></span><br><span class="line"><span class="comment">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span></span><br><span class="line">        $rule:FeeRuleRequest(startTime &gt;= <span class="string">"07:00:00"</span> &amp;&amp; startTime &lt; <span class="string">"24:00:00"</span>)</span><br><span class="line">    then</span><br><span class="line">        feeRuleResponse.setBaseDistance(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"5.0"</span>));</span><br><span class="line">        feeRuleResponse.setBaseDistanceFee(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"19.0"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5公里内里程费为0</span></span><br><span class="line">        feeRuleResponse.setExceedDistance(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"0.0"</span>));</span><br><span class="line">        feeRuleResponse.setExceedDistancePrice(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"3.0"</span>));</span><br><span class="line">        System.out.println(<span class="string">"07:00:00-24:00:00 "</span> + feeRuleResponse.getBaseDistance() + <span class="string">"公里，起步价:"</span> + feeRuleResponse.getBaseDistanceFee() + <span class="string">"元"</span>);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">2.里程费</span></span><br><span class="line"><span class="comment">    超出起步里程后开始计算</span></span><br><span class="line"><span class="comment">    00:00:00-07:00:00   4元/1公里</span></span><br><span class="line"><span class="comment">    07:00:00-24:00:00   3元/1公里</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">rule <span class="string">"里程费 00:00:00-07:00:00 4元/1公里"</span></span><br><span class="line">    salience <span class="number">10</span>          <span class="comment">//指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span></span><br><span class="line">    no-loop <span class="literal">true</span>         <span class="comment">//防止陷入死循环</span></span><br><span class="line">    when</span><br><span class="line">        <span class="comment">/*规则条件，到工作内存中查找FeeRuleRequest对象</span></span><br><span class="line"><span class="comment">        里面出来的结果只能是ture或者false</span></span><br><span class="line"><span class="comment">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span></span><br><span class="line">        $rule:FeeRuleRequest(startTime &gt;= <span class="string">"00:00:00"</span></span><br><span class="line">            &amp;&amp; startTime &lt; <span class="string">"07:00:00"</span></span><br><span class="line">            &amp;&amp; distance.doubleValue() &gt; <span class="number">3.0</span>)</span><br><span class="line">    then</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">exceedDistance</span> <span class="operator">=</span> $rule.getDistance().subtract(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"3.0"</span>));</span><br><span class="line">        feeRuleResponse.setExceedDistance(exceedDistance);</span><br><span class="line">        feeRuleResponse.setExceedDistancePrice(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"4.0"</span>));</span><br><span class="line">        System.out.println(<span class="string">"里程费，超出里程:"</span> + feeRuleResponse.getExceedDistance() + <span class="string">"公里，单价："</span> + feeRuleResponse.getExceedDistancePrice());</span><br><span class="line">end</span><br><span class="line">rule <span class="string">"里程费 07:00:00-24:00:00 3元/1公里"</span></span><br><span class="line">    salience <span class="number">10</span>          <span class="comment">//指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span></span><br><span class="line">    no-loop <span class="literal">true</span>         <span class="comment">//防止陷入死循环</span></span><br><span class="line">    when</span><br><span class="line">        <span class="comment">/*规则条件，到工作内存中查找FeeRuleRequest对象</span></span><br><span class="line"><span class="comment">        里面出来的结果只能是ture或者false</span></span><br><span class="line"><span class="comment">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span></span><br><span class="line">        $rule:FeeRuleRequest(startTime &gt;= <span class="string">"07:00:00"</span></span><br><span class="line">            &amp;&amp; startTime &lt; <span class="string">"24:00:00"</span></span><br><span class="line">            &amp;&amp; distance.doubleValue() &gt; <span class="number">5.0</span>)</span><br><span class="line">    then</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">exceedDistance</span> <span class="operator">=</span> $rule.getDistance().subtract(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"5.0"</span>));</span><br><span class="line">        feeRuleResponse.setExceedDistance(exceedDistance);</span><br><span class="line">        feeRuleResponse.setExceedDistancePrice(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"3.0"</span>));</span><br><span class="line">        System.out.println(<span class="string">"里程费，超出里程:"</span> + feeRuleResponse.getExceedDistance() + <span class="string">"公里，单价："</span> + feeRuleResponse.getExceedDistancePrice());</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">3.等候费</span></span><br><span class="line"><span class="comment">    等候10分钟后  1元/1分钟</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">rule <span class="string">"等候费 等候10分钟后 1元/1分钟"</span></span><br><span class="line">    salience <span class="number">10</span>          <span class="comment">//指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span></span><br><span class="line">    no-loop <span class="literal">true</span>         <span class="comment">//防止陷入死循环</span></span><br><span class="line">    when</span><br><span class="line">        <span class="comment">/*规则条件，到工作内存中查找FeeRuleRequest对象</span></span><br><span class="line"><span class="comment">        里面出来的结果只能是ture或者false</span></span><br><span class="line"><span class="comment">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span></span><br><span class="line">        $rule:FeeRuleRequest(waitMinute &gt; <span class="number">10</span>)</span><br><span class="line">    then</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">exceedWaitMinute</span> <span class="operator">=</span> $rule.getWaitMinute() - <span class="number">10</span>;</span><br><span class="line">        feeRuleResponse.setBaseWaitMinute(<span class="number">10</span>);</span><br><span class="line">        feeRuleResponse.setExceedWaitMinute(exceedWaitMinute);</span><br><span class="line">        feeRuleResponse.setExceedWaitMinutePrice(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"1.0"</span>));</span><br><span class="line">        System.out.println(<span class="string">"等候费，超出分钟:"</span> + feeRuleResponse.getExceedWaitMinute() + <span class="string">"分钟，单价："</span> + feeRuleResponse.getExceedWaitMinutePrice());</span><br><span class="line">end</span><br><span class="line">rule <span class="string">"无等候费"</span></span><br><span class="line">    salience <span class="number">10</span>          <span class="comment">//指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span></span><br><span class="line">    no-loop <span class="literal">true</span>         <span class="comment">//防止陷入死循环</span></span><br><span class="line">    when</span><br><span class="line">        <span class="comment">/*规则条件，到工作内存中查找FeeRuleRequest对象</span></span><br><span class="line"><span class="comment">        里面出来的结果只能是ture或者false</span></span><br><span class="line"><span class="comment">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span></span><br><span class="line">        $rule:FeeRuleRequest(waitMinute &lt;= <span class="number">10</span>)</span><br><span class="line">    then</span><br><span class="line">        feeRuleResponse.setBaseWaitMinute(<span class="number">10</span>);</span><br><span class="line">        feeRuleResponse.setExceedWaitMinute(<span class="number">0</span>);</span><br><span class="line">        feeRuleResponse.setExceedWaitMinutePrice(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"1.0"</span>));</span><br><span class="line">        System.out.println(<span class="string">"等候费：无"</span>);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">4.远途费</span></span><br><span class="line"><span class="comment">    订单行程超出12公里后每公里1元</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">rule <span class="string">"远途费 订单行程超出12公里后每公里1元"</span></span><br><span class="line">    salience <span class="number">10</span>          <span class="comment">//指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span></span><br><span class="line">    no-loop <span class="literal">true</span>         <span class="comment">//防止陷入死循环</span></span><br><span class="line">    when</span><br><span class="line">        <span class="comment">/*规则条件，到工作内存中查找FeeRuleRequest对象</span></span><br><span class="line"><span class="comment">        里面出来的结果只能是ture或者false</span></span><br><span class="line"><span class="comment">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span></span><br><span class="line">        $rule:FeeRuleRequest(distance.doubleValue() &gt; <span class="number">12.0</span>)</span><br><span class="line">    then</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">exceedLongDistance</span> <span class="operator">=</span> $rule.getDistance().subtract(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"12.0"</span>));</span><br><span class="line">        feeRuleResponse.setBaseLongDistance(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"12.0"</span>));</span><br><span class="line">        feeRuleResponse.setExceedLongDistance(exceedLongDistance);</span><br><span class="line">        feeRuleResponse.setExceedLongDistancePrice(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"1.0"</span>));</span><br><span class="line">        System.out.println(<span class="string">"远途费，超出公里:"</span> + feeRuleResponse.getExceedLongDistance() + <span class="string">"公里，单价："</span> + feeRuleResponse.getExceedLongDistancePrice());</span><br><span class="line">end</span><br><span class="line">rule <span class="string">"无远途费"</span></span><br><span class="line">    salience <span class="number">10</span>          <span class="comment">//指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span></span><br><span class="line">    no-loop <span class="literal">true</span>         <span class="comment">//防止陷入死循环</span></span><br><span class="line">    when</span><br><span class="line">        <span class="comment">/*规则条件，到工作内存中查找FeeRuleRequest对象</span></span><br><span class="line"><span class="comment">        里面出来的结果只能是ture或者false</span></span><br><span class="line"><span class="comment">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span></span><br><span class="line">        $rule:FeeRuleRequest(distance.doubleValue() &lt;= <span class="number">12.0</span>)</span><br><span class="line">    then</span><br><span class="line">        feeRuleResponse.setBaseLongDistance(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"12.0"</span>));</span><br><span class="line">        feeRuleResponse.setExceedLongDistance(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"0"</span>));</span><br><span class="line">        feeRuleResponse.setExceedLongDistancePrice(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"0"</span>));</span><br><span class="line">        System.out.println(<span class="string">"远途费：无"</span>);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">5.计算总金额</span></span><br><span class="line"><span class="comment">    订单总金额 = 基础里程费 + 超出基础里程的费 + 等候费 + 远程费</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">rule <span class="string">"计算总金额"</span></span><br><span class="line">    salience <span class="number">10</span>          <span class="comment">//指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span></span><br><span class="line">    no-loop <span class="literal">true</span>         <span class="comment">//防止陷入死循环</span></span><br><span class="line">    when</span><br><span class="line">        <span class="comment">/*规则条件，到工作内存中查找FeeRuleRequest对象</span></span><br><span class="line"><span class="comment">        里面出来的结果只能是ture或者false</span></span><br><span class="line"><span class="comment">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span></span><br><span class="line">        $rule:FeeRuleRequest(distance.doubleValue() &gt; <span class="number">0.0</span>)</span><br><span class="line">    then</span><br><span class="line">        <span class="comment">//订单总金额 = 基础里程费 + 超出基础里程的费 + 等候费 + 远程费</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">distanceFee</span> <span class="operator">=</span> feeRuleResponse.getBaseDistanceFee().add(feeRuleResponse.getExceedDistance().multiply(feeRuleResponse.getExceedDistancePrice()));</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">waitFee</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(feeRuleResponse.getExceedWaitMinute()).multiply(feeRuleResponse.getExceedWaitMinutePrice());</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">longDistanceFee</span> <span class="operator">=</span> feeRuleResponse.getExceedLongDistance().multiply(feeRuleResponse.getExceedLongDistancePrice());</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">totalAmount</span> <span class="operator">=</span> distanceFee.add(waitFee).add(longDistanceFee);</span><br><span class="line">        feeRuleResponse.setDistanceFee(distanceFee);</span><br><span class="line">        feeRuleResponse.setWaitFee(waitFee);</span><br><span class="line">        feeRuleResponse.setLongDistanceFee(longDistanceFee);</span><br><span class="line">        feeRuleResponse.setTotalAmount(totalAmount);</span><br><span class="line">        System.out.println(<span class="string">"计算总金额:"</span> + feeRuleResponse.getTotalAmount() + <span class="string">"元"</span>);</span><br><span class="line">end</span><br></pre></td></tr></tbody></table></figure>

<h6><span id="3-4-1-4-ce-shi-gui-ze">3.4.1.4、测试规则</span></h6><p>修改test1测试类</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">FeeRuleRequest</span> <span class="variable">feeRuleRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeeRuleRequest</span>();</span><br><span class="line">    feeRuleRequest.setDistance(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">15.0</span>));</span><br><span class="line">    feeRuleRequest.setStartTime(<span class="string">"01:59:59"</span>);</span><br><span class="line">    feeRuleRequest.setWaitMinute(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开启会话</span></span><br><span class="line">    <span class="type">KieSession</span> <span class="variable">kieSession</span> <span class="operator">=</span> kieContainer.newKieSession();</span><br><span class="line"></span><br><span class="line">    <span class="type">FeeRuleResponse</span> <span class="variable">feeRuleResponse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeeRuleResponse</span>();</span><br><span class="line">    kieSession.setGlobal(<span class="string">"feeRuleResponse"</span>, feeRuleResponse);</span><br><span class="line">    <span class="comment">// 设置订单对象</span></span><br><span class="line">    kieSession.insert(feeRuleRequest);</span><br><span class="line">    <span class="comment">// 触发规则</span></span><br><span class="line">    kieSession.fireAllRules();</span><br><span class="line">    <span class="comment">// 中止会话</span></span><br><span class="line">    kieSession.dispose();</span><br><span class="line">    System.out.println(<span class="string">"后："</span>+JSON.toJSONString(feeRuleResponse));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>规则打印：</p>
<p>00:00:00-07:00:00 3.0公里，起步价:19.0元<br>里程费，超出里程:12.0公里，单价：4.0<br>等候费，超出分钟:10分钟，单价：1.0<br>远途费，超出公里:3.0公里，单价：1.0<br>计算总金额：80.00元</p>
<h5><span id="3-4-2-feng-zhuang-wei-fu-wu-jie-kou">3.4.2、封装微服务接口</span></h5><h6><span id="3-4-2-1-feerulecontroller">3.4.2.1、FeeRuleController</span></h6><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> FeeRuleService feeRuleService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "计算订单费用")</span></span><br><span class="line"><span class="meta">@PostMapping("/calculateOrderFee")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;FeeRuleResponseVo&gt; <span class="title function_">calculateOrderFee</span><span class="params">(<span class="meta">@RequestBody</span> FeeRuleRequestForm calculateOrderFeeForm)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(feeRuleService.calculateOrderFee(calculateOrderFeeForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h6><span id="3-4-2-2-feeruleservice">3.4.2.2、FeeRuleService</span></h6><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FeeRuleResponseVo <span class="title function_">calculateOrderFee</span><span class="params">(FeeRuleRequestForm calculateOrderFeeForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h6><span id="3-4-2-3-feeruleserviceimpl">3.4.2.3、FeeRuleServiceImpl</span></h6><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> KieContainer kieContainer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> FeeRuleResponseVo <span class="title function_">calculateOrderFee</span><span class="params">(FeeRuleRequestForm feeRuleRequestForm)</span> {</span><br><span class="line">    <span class="comment">//封装传入对象</span></span><br><span class="line">    <span class="type">FeeRuleRequest</span> <span class="variable">feeRuleRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeeRuleRequest</span>();</span><br><span class="line">    feeRuleRequest.setDistance(feeRuleRequestForm.getDistance());</span><br><span class="line">    feeRuleRequest.setStartTime(<span class="keyword">new</span> <span class="title class_">DateTime</span>(feeRuleRequestForm.getStartTime()).toString(<span class="string">"HH:mm:ss"</span>));</span><br><span class="line">    feeRuleRequest.setWaitMinute(feeRuleRequestForm.getWaitMinute());</span><br><span class="line">    log.info(<span class="string">"传入参数：{}"</span>, JSON.toJSONString(feeRuleRequest));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开启会话</span></span><br><span class="line">    <span class="type">KieSession</span> <span class="variable">kieSession</span> <span class="operator">=</span> kieContainer.newKieSession();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装返回对象</span></span><br><span class="line">    <span class="type">FeeRuleResponse</span> <span class="variable">feeRuleResponse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeeRuleResponse</span>();</span><br><span class="line">    kieSession.setGlobal(<span class="string">"feeRuleResponse"</span>, feeRuleResponse);</span><br><span class="line">    <span class="comment">// 设置订单对象</span></span><br><span class="line">    kieSession.insert(feeRuleRequest);</span><br><span class="line">    <span class="comment">// 触发规则</span></span><br><span class="line">    kieSession.fireAllRules();</span><br><span class="line">    <span class="comment">// 中止会话</span></span><br><span class="line">    kieSession.dispose();</span><br><span class="line">    log.info(<span class="string">"计算结果：{}"</span>, JSON.toJSONString(feeRuleResponse));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装返回对象</span></span><br><span class="line">    <span class="type">FeeRuleResponseVo</span> <span class="variable">feeRuleResponseVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeeRuleResponseVo</span>();</span><br><span class="line">    BeanUtils.copyProperties(feeRuleResponse, feeRuleResponseVo);</span><br><span class="line">    <span class="keyword">return</span> feeRuleResponseVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-4-3-feng-zhuang-feign-jie-kou">3.4.3、封装Feign接口</span></h5><h6><span id="3-4-3-1-feerulefeignclient">3.4.3.1、FeeRuleFeignClient</span></h6><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算订单费用</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> calculateOrderFeeForm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping("/rules/fee/calculateOrderFee")</span></span><br><span class="line">Result&lt;FeeRuleResponseVo&gt; <span class="title function_">calculateOrderFee</span><span class="params">(<span class="meta">@RequestBody</span> FeeRuleRequestForm calculateOrderFeeForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="3-5-gui-ze-jie-kou-gai-zao">3.5、规则接口改造</span></h4><p>我们把规则文件写到了项目resources目录下面，显然不利于运营人员调整规则，那么怎么办呢？我们可以把规则保存到数据库表中，需要调整规则时在后台页面更改了即可，同时让他随时生效。只要输入与输出参数不变，怎么调整都没有问题。</p>
<h5><span id="3-5-1-droolshelper">3.5.1、DroolsHelper</span></h5><p>定义一个Drools帮助类，接收规则字符串（规则文件的文本内容），返回KieSession即可</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DroolsHelper</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> KieSession <span class="title function_">loadForRule</span><span class="params">(String drlStr)</span> {</span><br><span class="line">        <span class="type">KieServices</span> <span class="variable">kieServices</span> <span class="operator">=</span> KieServices.Factory.get();</span><br><span class="line"></span><br><span class="line">        <span class="type">KieFileSystem</span> <span class="variable">kieFileSystem</span> <span class="operator">=</span> kieServices.newKieFileSystem();</span><br><span class="line">        kieFileSystem.write(<span class="string">"src/main/resources/rules/"</span> + drlStr.hashCode() + <span class="string">".drl"</span>, drlStr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将KieFileSystem加入到KieBuilder</span></span><br><span class="line">        <span class="type">KieBuilder</span> <span class="variable">kieBuilder</span> <span class="operator">=</span> kieServices.newKieBuilder(kieFileSystem);</span><br><span class="line">        <span class="comment">// 编译此时的builder中所有的规则</span></span><br><span class="line">        kieBuilder.buildAll();</span><br><span class="line">        <span class="keyword">if</span> (kieBuilder.getResults().hasMessages(Message.Level.ERROR)) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"Build Errors:\n"</span> + kieBuilder.getResults().toString());</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="type">KieContainer</span> <span class="variable">kieContainer</span> <span class="operator">=</span> kieServices.newKieContainer(kieServices.getRepository().getDefaultReleaseId());</span><br><span class="line">        <span class="keyword">return</span> kieContainer.newKieSession();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-5-2-gui-ze-wen-jian-fang-ru-shu-ju-ku-biao">3.5.2、规则文件放入数据库表</span></h5><p>将规则文件内容访问fee_rule表rule字段</p>
<h5><span id="3-5-3-gai-zao-feeruleserviceimpl-fang-fa">3.5.3、改造FeeRuleServiceImpl方法</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> FeeRuleMapper feeRuleMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> FeeRuleResponseVo <span class="title function_">calculateOrderFee</span><span class="params">(FeeRuleRequestForm feeRuleRequestForm)</span> {</span><br><span class="line">    <span class="comment">//封装传入对象</span></span><br><span class="line">    <span class="type">FeeRuleRequest</span> <span class="variable">feeRuleRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeeRuleRequest</span>();</span><br><span class="line">    feeRuleRequest.setDistance(feeRuleRequestForm.getDistance());</span><br><span class="line">    feeRuleRequest.setStartTime(<span class="keyword">new</span> <span class="title class_">DateTime</span>(feeRuleRequestForm.getStartTime()).toString(<span class="string">"HH:mm:ss"</span>));</span><br><span class="line">    feeRuleRequest.setWaitMinute(feeRuleRequestForm.getWaitMinute());</span><br><span class="line">    log.info(<span class="string">"传入参数：{}"</span>, JSON.toJSONString(feeRuleRequest));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取最新订单费用规则</span></span><br><span class="line">    <span class="type">FeeRule</span> <span class="variable">feeRule</span> <span class="operator">=</span> feeRuleMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;FeeRule&gt;().orderByDesc(FeeRule::getId).last(<span class="string">"limit 1"</span>));</span><br><span class="line">    <span class="type">KieSession</span> <span class="variable">kieSession</span> <span class="operator">=</span> DroolsHelper.loadForRule(feeRule.getRule());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装返回对象</span></span><br><span class="line">    <span class="type">FeeRuleResponse</span> <span class="variable">feeRuleResponse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeeRuleResponse</span>();</span><br><span class="line">    kieSession.setGlobal(<span class="string">"feeRuleResponse"</span>, feeRuleResponse);</span><br><span class="line">    <span class="comment">// 设置订单对象</span></span><br><span class="line">    kieSession.insert(feeRuleRequest);</span><br><span class="line">    <span class="comment">// 触发规则</span></span><br><span class="line">    kieSession.fireAllRules();</span><br><span class="line">    <span class="comment">// 中止会话</span></span><br><span class="line">    kieSession.dispose();</span><br><span class="line">    log.info(<span class="string">"计算结果：{}"</span>, JSON.toJSONString(feeRuleResponse));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装返回对象</span></span><br><span class="line">    <span class="type">FeeRuleResponseVo</span> <span class="variable">feeRuleResponseVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeeRuleResponseVo</span>();</span><br><span class="line">    feeRuleResponseVo.setFeeRuleId(feeRule.getId());</span><br><span class="line">    BeanUtils.copyProperties(feeRuleResponse, feeRuleResponseVo);</span><br><span class="line">    <span class="keyword">return</span> feeRuleResponseVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>说明：规则调整可以产生一条新记录，每次去最新的一条作为当前费用规则</p>
<h3><span id="4-yu-gu-ding-dan-shu-ju-jie-kou">4、预估订单数据接口</span></h3><p>前面计算了预估驾驶线路与预估订单金额，当前就可以编写web端乘客端预估订单数据接口了。</p>
<p>操作模块：web-customer</p>
<h4><span id="4-1-cheng-ke-duan-web-jie-kou">4.1、乘客端web接口</span></h4><h5><span id="4-1-1-ordercontroller">4.1.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "预估订单数据")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@PostMapping("/expectOrder")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;ExpectOrderVo&gt; <span class="title function_">expectOrder</span><span class="params">(<span class="meta">@RequestBody</span> ExpectOrderForm expectOrderForm)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(orderService.expectOrder(expectOrderForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-2-orderservice">4.1.2、OrderService</span></h5><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExpectOrderVo expectOrder(ExpectOrderForm expectOrderForm);</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-3-orderserviceimpl">4.1.3、OrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> MapFeignClient mapFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> FeeRuleFeignClient feeRuleFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ExpectOrderVo <span class="title function_">expectOrder</span><span class="params">(ExpectOrderForm expectOrderForm)</span> {</span><br><span class="line">    <span class="comment">//计算驾驶线路</span></span><br><span class="line">    <span class="type">CalculateDrivingLineForm</span> <span class="variable">calculateDrivingLineForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CalculateDrivingLineForm</span>();</span><br><span class="line">    BeanUtils.copyProperties(expectOrderForm, calculateDrivingLineForm);</span><br><span class="line">    <span class="type">DrivingLineVo</span> <span class="variable">drivingLineVo</span> <span class="operator">=</span> mapFeignClient.calculateDrivingLine(calculateDrivingLineForm).getData();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//计算订单费用</span></span><br><span class="line">    <span class="type">FeeRuleRequestForm</span> <span class="variable">calculateOrderFeeForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeeRuleRequestForm</span>();</span><br><span class="line">    calculateOrderFeeForm.setDistance(drivingLineVo.getDistance());</span><br><span class="line">    calculateOrderFeeForm.setStartTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    calculateOrderFeeForm.setWaitMinute(<span class="number">0</span>);</span><br><span class="line">    <span class="type">FeeRuleResponseVo</span> <span class="variable">feeRuleResponseVo</span> <span class="operator">=</span> feeRuleFeignClient.calculateOrderFee(calculateOrderFeeForm).getData();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//预估订单实体</span></span><br><span class="line">    <span class="type">ExpectOrderVo</span> <span class="variable">expectOrderVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExpectOrderVo</span>();</span><br><span class="line">    expectOrderVo.setDrivingLineVo(drivingLineVo);</span><br><span class="line">    expectOrderVo.setFeeRuleResponseVo(feeRuleResponseVo);</span><br><span class="line">    <span class="keyword">return</span> expectOrderVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2><span id="er-drools">二、Drools</span></h2><h3><span id="1-wen-ti">1、问题</span></h3><p>某电商平台的促销活动，活动规则是根据⽤户购买订单的⾦额给⽤户送相应的积分，购买的越多送的积分越多用户购买的金额和对应送多少积分的规则如下：</p>
<table>
<thead>
<tr>
<th>规则编号</th>
<th>订单金额</th>
<th>奖励积分</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>100元以下</td>
<td>不加分</td>
</tr>
<tr>
<td>2</td>
<td>100元 - 500元</td>
<td>加100分</td>
</tr>
<tr>
<td>3</td>
<td>500元 - 1000元</td>
<td>加500分</td>
</tr>
<tr>
<td>4</td>
<td>1000元以上</td>
<td>加1000分</td>
</tr>
</tbody></table>
<p>思考：如何实现上面的业务逻辑呢？</p>
<p>我们最容易想到的就是使用分支判断(if else)来实现，例如通过如下代码来检查用户信息合法性：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置订单积分</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOrderPoint</span><span class="params">(Order order)</span>{</span><br><span class="line">    <span class="keyword">if</span> (order.getAmout() &lt;= <span class="number">100</span>){</span><br><span class="line">        order.setScore(<span class="number">0</span>);</span><br><span class="line">    }<span class="keyword">else</span> <span class="keyword">if</span>(order.getAmout() &gt; <span class="number">100</span> &amp;&amp; order.getAmout() &lt;= <span class="number">500</span>){</span><br><span class="line">        order.setScore(<span class="number">100</span>);</span><br><span class="line">    }<span class="keyword">else</span> <span class="keyword">if</span>(order.getAmout() &gt; <span class="number">500</span> &amp;&amp; order.getAmout() &lt;= <span class="number">1000</span>){</span><br><span class="line">        order.setScore(<span class="number">500</span>);</span><br><span class="line">    }<span class="keyword">else</span>{</span><br><span class="line">        order.setScore(<span class="number">1000</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>通过上面的伪代码我们可以看到，需要在代码中写很多这样if else的代码。这种实现方式存在如下问题：</p>
<p>1、硬编码实现业务规则难以维护</p>
<p>2、硬编码实现业务规则难以应对变化</p>
<p>3、业务规则发生变化需要修改代码，重启服务后才能生效</p>
<p>那么面对上面的业务场景，还有什么好的实现方式吗？</p>
<p>此时我们需要引入规则引擎来帮助我们将规则从代码中分离出去，让开发人员从规则的代码逻辑中解放出来，把规则的维护和设置交由业务人员去管理。</p>
<h3><span id="2-gui-ze-yin-qing-gai-shu">2、规则引擎概述</span></h3><h4><span id="2-1-shi-me-shi-gui-ze-yin-qing">2.1、什么是规则引擎</span></h4><p><strong>规则引擎</strong>，全称为<strong>业务规则管理系统</strong>，英文名为BRMS(即Business Rule Management System)。规则引擎的主要思想是将应用程序中的业务决策部分分离出来，并使用预定义的语义模块编写业务决策（业务规则），由用户或开发者在需要时进行配置、管理。</p>
<p>需要注意的是规则引擎并不是一个具体的技术框架，而是指的一类系统，即业务规则管理系统。目前市面上具体的规则引擎产品有：drools、VisualRules、iLog等。</p>
<p>规则引擎实现了将业务决策从应用程序代码中分离出来，接收数据输入，解释业务规则，并根据业务规则做出业务决策。规则引擎其实就是一个输入输出平台。</p>
<p>系统中引入规则引擎后，业务规则不再以程序代码的形式驻留在系统中，取而代之的是处理规则的规则引擎，业务规则存储在规则库中，完全独立于程序。业务人员可以像管理数据一样对业务规则进行管理，比如查询、添加、更新、统计、提交业务规则等。业务规则被加载到规则引擎中供应用系统调用。</p>
<h4><span id="2-2-shi-yong-gui-ze-yin-qing-de-you-shi">2.2、使用规则引擎的优势</span></h4><p>使用规则引擎的优势如下：</p>
<p>1、业务规则与系统代码分离，实现业务规则的集中管理</p>
<p>2、在不重启服务的情况下可随时对业务规则进行扩展和维护</p>
<p>3、可以动态修改业务规则，从而快速响应需求变更</p>
<p>4、规则引擎是相对独立的，只关心业务规则，使得业务分析人员也可以参与编辑、维护系统的业务规则</p>
<p>5、减少了硬编码业务规则的成本和风险</p>
<p>6、使用规则引擎提供的规则编辑工具，使复杂的业务规则实现变得的简单</p>
<h4><span id="2-3-gui-ze-yin-qing-ying-yong-chang-jing">2.3、规则引擎应用场景</span></h4><p>对于一些存在比较复杂的业务规则并且业务规则会频繁变动的系统比较适合使用规则引擎，如下：</p>
<p>1、风险控制系统—-风险贷款、风险评估</p>
<p>2、反欺诈项目—-银行贷款、征信验证</p>
<p>3、决策平台系统—-财务计算</p>
<p>4、促销平台系统—-满减、打折、加价购</p>
<h4><span id="2-4-drools-jie-shao">2.4、Drools介绍</span></h4><p>drools是一款由JBoss组织提供的基于Java语言开发的开源规则引擎，可以将复杂且多变的业务规则从硬编码中解放出来，以规则脚本的形式存放在文件或特定的存储介质中(例如存放在数据库中)，使得业务规则的变更不需要修改项目代码、重启服务器就可以在线上环境立即生效。</p>
<p>drools官网地址：<a target="_blank" rel="noopener" href="https://drools.org/">https://drools.org/</a></p>
<p>drools源码下载地址：<a target="_blank" rel="noopener" href="https://github.com/kiegroup/drools">https://github.com/kiegroup/drools</a></p>
<h3><span id="3-drools-ru-men-an-li">3、Drools入门案例</span></h3><p>我们使用上面的问题案例来入门Drools</p>
<h4><span id="3-1-chuang-jian-springboot-xiang-mu">3.1、创建springboot项目</span></h4><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">groupId：com.atguigu.drools</span></span><br><span class="line"><span class="string">artifactId：drools_demo</span></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-2-yin-ru-yi-lai">3.2、引入依赖</span></h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>17<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">drools.version</span>&gt;</span>8.41.0.Final<span class="tag">&lt;/<span class="name">drools.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.drools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>drools-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>${drools.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.drools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>drools-compiler<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>${drools.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.drools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>drools-decisiontables<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>${drools.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.drools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>drools-mvel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>${drools.version}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-3-tian-jia-drools-pei-zhi-lei">3.3、添加Drools配置类</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.drools.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.kie.api.KieServices;</span><br><span class="line"><span class="keyword">import</span> org.kie.api.builder.*;</span><br><span class="line"><span class="keyword">import</span> org.kie.api.runtime.KieContainer;</span><br><span class="line"><span class="keyword">import</span> org.kie.api.runtime.KieSession;</span><br><span class="line"><span class="keyword">import</span> org.kie.internal.io.ResourceFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 规则引擎配置类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DroolsConfig</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">KieServices</span> <span class="variable">kieServices</span> <span class="operator">=</span> KieServices.Factory.get();</span><br><span class="line">    <span class="comment">//制定规则文件的路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RULES_CUSTOMER_RULES_DRL</span> <span class="operator">=</span> <span class="string">"rules/order.drl"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> KieContainer <span class="title function_">kieContainer</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">//获得Kie容器对象</span></span><br><span class="line">        <span class="type">KieFileSystem</span> <span class="variable">kieFileSystem</span> <span class="operator">=</span> kieServices.newKieFileSystem();</span><br><span class="line">        kieFileSystem.write(ResourceFactory.newClassPathResource(RULES_CUSTOMER_RULES_DRL));</span><br><span class="line"></span><br><span class="line">        <span class="type">KieBuilder</span> <span class="variable">kieBuilder</span> <span class="operator">=</span> kieServices.newKieBuilder(kieFileSystem);</span><br><span class="line">        kieBuilder.buildAll();</span><br><span class="line"></span><br><span class="line">        <span class="type">KieModule</span> <span class="variable">kieModule</span> <span class="operator">=</span> kieBuilder.getKieModule();</span><br><span class="line">        <span class="type">KieContainer</span> <span class="variable">kieContainer</span> <span class="operator">=</span> kieServices.newKieContainer(kieModule.getReleaseId());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> kieContainer;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>说明：</strong></p>
<ul>
<li>定义了一个 <code>KieContainer</code>的<code>Spring Bean</code> ，<code>KieContainer</code>用于通过加载应用程序的<code>/resources</code>文件夹下的规则文件来构建规则引擎。</li>
<li>创建<code>KieFileSystem</code>实例并配置规则引擎并从应用程序的资源目录加载规则的 <code>DRL</code> 文件。</li>
<li>使用<code>KieBuilder</code>实例来构建 <code>drools</code> 模块。我们可以使用KieSerive单例实例来创建 <code>KieBuilder</code> 实例。</li>
<li>最后，使用 <code>KieService</code> 创建一个 <code>KieContainer</code> 并将其配置为 <code>spring bean</code></li>
</ul>
<h4><span id="3-4-chuang-jian-shi-ti-lei-order">3.4、创建实体类Order</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.drools.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Order</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> amout;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> score;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getAmout</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> amout;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAmout</span><span class="params">(<span class="type">double</span> amout)</span> {</span><br><span class="line">        <span class="built_in">this</span>.amout = amout;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getScore</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> score;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setScore</span><span class="params">(<span class="type">double</span> score)</span> {</span><br><span class="line">        <span class="built_in">this</span>.score = score;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-5-order-drl">3.5、order.drl</span></h4><p>创建规则文件resources/rules/order.drl</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//订单积分规则</span></span><br><span class="line"><span class="keyword">package</span> com.order</span><br><span class="line"><span class="keyword">import</span> com.atguigu.drools.model.Order</span><br><span class="line"></span><br><span class="line"><span class="comment">//规则一：100元以下 不加分</span></span><br><span class="line">rule <span class="string">"order_rule_1"</span></span><br><span class="line">    when</span><br><span class="line">        $order:Order(amout &lt; <span class="number">100</span>)</span><br><span class="line">    then</span><br><span class="line">        $order.setScore(<span class="number">0</span>);</span><br><span class="line">        System.out.println(<span class="string">"成功匹配到规则一：100元以下 不加分"</span>);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="comment">//规则二：100元 - 500元 加100分</span></span><br><span class="line">rule <span class="string">"order_rule_2"</span></span><br><span class="line">    when</span><br><span class="line">        $order:Order(amout &gt;= <span class="number">100</span> &amp;&amp; amout &lt; <span class="number">500</span>)</span><br><span class="line">    then</span><br><span class="line">         $order.setScore(<span class="number">100</span>);</span><br><span class="line">         System.out.println(<span class="string">"成功匹配到规则二：100元 - 500元 加100分"</span>);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="comment">//规则三：500元 - 1000元 加500分</span></span><br><span class="line">rule <span class="string">"order_rule_3"</span></span><br><span class="line">    when</span><br><span class="line">        $order:Order(amout &gt;= <span class="number">500</span> &amp;&amp; amout &lt; <span class="number">1000</span>)</span><br><span class="line">    then</span><br><span class="line">         $order.setScore(<span class="number">500</span>);</span><br><span class="line">         System.out.println(<span class="string">"成功匹配到规则三：500元 - 1000元 加500分"</span>);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="comment">//规则四：1000元以上 加1000分</span></span><br><span class="line">rule <span class="string">"order_rule_4"</span></span><br><span class="line">    when</span><br><span class="line">        $order:Order(amout &gt;= <span class="number">1000</span>)</span><br><span class="line">    then</span><br><span class="line">         $order.setScore(<span class="number">1000</span>);</span><br><span class="line">         System.out.println(<span class="string">"成功匹配到规则四：1000元以上 加1000分"</span>);</span><br><span class="line">end</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-6-bian-xie-ce-shi-lei">3.6、编写测试类</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.drools;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.drools.model.Order;</span><br><span class="line"><span class="keyword">import</span> org.kie.api.runtime.KieContainer;</span><br><span class="line"><span class="keyword">import</span> org.kie.api.runtime.KieSession;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DroolsDemosApplicationTests</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KieContainer kieContainer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>{</span><br><span class="line">        <span class="comment">//从Kie容器对象中获取会话对象</span></span><br><span class="line">        <span class="type">KieSession</span> <span class="variable">session</span> <span class="operator">=</span> kieContainer.newKieSession();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Fact对象，事实对象</span></span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Order</span>();</span><br><span class="line">        order.setAmout(<span class="number">1300</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将Order对象插入到工作内存中</span></span><br><span class="line">        session.insert(order);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//激活规则，由Drools框架自动进行规则匹配，如果规则匹配成功，则执行当前规则</span></span><br><span class="line">        session.fireAllRules();</span><br><span class="line">        <span class="comment">//关闭会话</span></span><br><span class="line">        session.dispose();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"订单金额："</span> + order.getAmout() +</span><br><span class="line">                <span class="string">"，添加积分："</span> + order.getScore());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>通过上面的入门案例我们可以发现，使用drools规则引擎主要工作就是编写规则文件，在规则文件中定义跟业务相关的业务规则。规则定义好后就需要调用drools提供的API将数据提供给规则引擎进行规则模式匹配，规则引擎会执行匹配成功的规则并将计算的结果返回给我们。</p>
<p>可能大家会有疑问，就是我们虽然没有在代码中编写规则的判断逻辑，但是我们还是在规则文件中编写了业务规则，这跟在代码中编写规则有什么本质的区别呢？</p>
<p>我们前面其实已经提到，使用规则引擎时业务规则可以做到动态管理。业务人员可以像管理数据一样对业务规则进行管理，比如查询、添加、更新、统计、提交业务规则等。这样就可以做到在不重启服务的情况下调整业务规则。</p>
<h4><span id="3-7-xiao-jie">3.7、小结</span></h4><h5><span id="3-7-1-gui-ze-yin-qing-gou-cheng">3.7.1、规则引擎构成</span></h5><p>drools规则引擎由以下三部分构成：</p>
<ul>
<li>Working Memory（工作内存）</li>
<li>Rule Base（规则库）</li>
<li>Inference Engine（推理引擎）</li>
</ul>
<p>其中Inference Engine（推理引擎）又包括：</p>
<ul>
<li>Pattern Matcher（匹配器）     具体匹配哪一个规则，由这个完成</li>
<li>Agenda(议程)</li>
<li>Execution Engine（执行引擎）</li>
</ul>
<p>如下图所示：</p>
<p><img src="/2024/09/26/projection-daijia/8.png" alt="8"></p>
<h5><span id="3-7-2-xiang-guan-gai-nian-shuo-ming">3.7.2、相关概念说明</span></h5><p><strong>Working Memory</strong>：工作内存，drools规则引擎会从Working Memory中获取数据并和规则文件中定义的规则进行模式匹配，所以我们开发的应用程序只需要将我们的数据插入到Working Memory中即可，例如本案例中我们调用kieSession.insert(order)就是将order对象插入到了工作内存中。</p>
<p><strong>Fact</strong>：事实，是指在drools 规则应用当中，将一个<strong>普通的JavaBean插入到Working Memory后的对象</strong>就是Fact对象，例如本案例中的Order对象就属于Fact对象。Fact对象是我们的应用和规则引擎进行数据交互的桥梁或通道。</p>
<p><strong>Rule Base</strong>：规则库，我们在规则文件中定义的规则都会被加载到规则库中。</p>
<p><strong>Pattern Matcher</strong>：匹配器，将Rule Base中的所有规则与Working Memory中的Fact对象进行模式匹配，匹配成功的规则将被激活并放入Agenda（议程）中。</p>
<p><strong>Agenda</strong>：议程，用于存放通过匹配器进行模式匹配后被激活的规则。</p>
<p><strong>Execution Engine</strong>：执行引擎，执行Agenda中被激活的规则。</p>
<h5><span id="3-7-3-gui-ze-yin-qing-zhi-xing-guo-cheng">3.7.3、规则引擎执行过程</span></h5><p><img src="/2024/09/26/projection-daijia/10.png" alt="10"></p>
<h5><span id="3-7-4-kie-jie-shao">3.7.4、KIE介绍</span></h5><p>我们在操作Drools时经常使用的API以及它们之间的关系如下图：</p>
<p><img src="/2024/09/26/projection-daijia/9.png" alt="9"></p>
<p>通过上面的核心API可以发现，大部分类名都是以Kie开头。<strong>Kie全称为Knowledge Is Everything</strong>，即”知识就是一切”的缩写，是Jboss一系列项目的总称。如下图所示，Kie的主要模块有OptaPlanner、Drools、UberFire、jBPM。</p>
<p><img src="/2024/09/26/projection-daijia/11.png" alt="11"></p>
<p>通过上图可以看到，Drools是整个KIE项目中的一个组件，Drools中还包括一个Drools-WB的模块，它是一个可视化的规则编辑器。</p>
<h3><span id="4-drools-ji-chu-yu-fa">4、Drools基础语法</span></h3><h4><span id="4-1-gui-ze-wen-jian-gou-cheng">4.1、规则文件构成</span></h4><p>在使用Drools时非常重要的一个工作就是编写规则文件，通常规则文件的后缀为.drl。</p>
<p><strong>drl是Drools Rule Language的缩写</strong>。在规则文件中编写具体的规则内容。</p>
<p>一套完整的规则文件内容构成如下：</p>
<table>
<thead>
<tr>
<th align="left">关键字</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">package</td>
<td align="left">包名，只限于逻辑上的管理，同一个包名下的查询或者函数可以直接调用</td>
</tr>
<tr>
<td align="left">import</td>
<td align="left">用于导入类或者静态方法</td>
</tr>
<tr>
<td align="left">global</td>
<td align="left">全局变量</td>
</tr>
<tr>
<td align="left">function</td>
<td align="left">自定义函数</td>
</tr>
<tr>
<td align="left">query</td>
<td align="left">查询</td>
</tr>
<tr>
<td align="left">rule end</td>
<td align="left">规则体</td>
</tr>
</tbody></table>
<p>Drools支持的规则文件，除了drl形式，还有Excel文件类型的。</p>
<h4><span id="4-2-gui-ze-ti-yu-fa-jie-gou">4.2、规则体语法结构</span></h4><p>规则体是规则文件内容中的重要组成部分，是进行业务规则判断、处理业务结果的部分。</p>
<p>规则体语法结构如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">"ruleName"</span></span><br><span class="line">    attributes</span><br><span class="line">    when</span><br><span class="line">        LHS </span><br><span class="line">    then</span><br><span class="line">        RHS</span><br><span class="line">end</span><br></pre></td></tr></tbody></table></figure>

<p><strong>rule</strong>：关键字，表示规则开始，参数为规则的唯一名称。</p>
<p><strong>attributes</strong>：规则属性，是rule与when之间的参数，为可选项。</p>
<p><strong>when</strong>：关键字，后面跟规则的条件部分。</p>
<p><strong>LHS</strong>(Left Hand Side)：是规则的条件部分的通用名称。它由零个或多个条件元素组成。<strong>如果LHS为空，则它将被视为始终为true的条件元素</strong>。  （左手边）</p>
<p><strong>then</strong>：关键字，后面跟规则的结果部分。</p>
<p><strong>RHS</strong>(Right Hand Side)：是规则的后果或行动部分的通用名称。 （右手边）</p>
<p><strong>end</strong>：关键字，表示一个规则结束。</p>
<h4><span id="4-3-zhu-shi">4.3、注释</span></h4><p>在drl形式的规则文件中使用注释和Java类中使用注释一致，分为单行注释和多行注释。</p>
<p>单行注释用”//“进行标记，多行注释以”/<em>“开始，以”</em>/“结束。如下示例：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//规则rule1的注释，这是一个单行注释</span><br><span class="line">rule "rule1"</span><br><span class="line">    when</span><br><span class="line">    then</span><br><span class="line">        System.out.println("rule1触发");</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">规则rule2的注释，</span><br><span class="line">这是一个多行注释</span><br><span class="line">*/</span><br><span class="line">rule "rule2"</span><br><span class="line">    when</span><br><span class="line">    then</span><br><span class="line">        System.out.println("rule2触发");</span><br><span class="line">end</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="4-4-pattern-mo-shi-pi-pei">4.4、Pattern模式匹配</span></h4><p>前面我们已经知道了Drools中的匹配器可以将Rule Base中的所有规则与Working Memory中的Fact对象进行模式匹配，那么我们就需要在规则体的LHS部分定义规则并进行模式匹配。LHS部分由一个或者多个条件组成，条件又称为pattern。</p>
<p><strong>pattern的语法结构为：绑定变量名:Object(Field约束)</strong></p>
<p>其中绑定变量名可以省略，通常绑定变量名的命名一般建议以$开始。如果定义了绑定变量名，就可以在规则体的RHS部分使用此绑定变量名来操作相应的Fact对象。Field约束部分是需要返回true或者false的0个或多个表达式。</p>
<p>例如我们的入门案例中：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//规则二：100元 - 500元 加100分</span></span><br><span class="line">rule <span class="string">"order_rule_2"</span></span><br><span class="line">    when</span><br><span class="line">        $order:Order(amout &gt;= <span class="number">100</span> &amp;&amp; amout &lt; <span class="number">500</span>)</span><br><span class="line">    then</span><br><span class="line">         $order.setScore(<span class="number">100</span>);</span><br><span class="line">         System.out.println(<span class="string">"成功匹配到规则二：100元 - 500元 加100分"</span>);</span><br><span class="line">end</span><br></pre></td></tr></tbody></table></figure>

<p>通过上面的例子我们可以知道，匹配的条件为：</p>
<p>1、工作内存中必须存在Order这种类型的Fact对象—–类型约束</p>
<p>2、Fact对象的amout属性值必须大于等于100——属性约束</p>
<p>3、Fact对象的amout属性值必须小于500——属性约束</p>
<p>以上条件必须同时满足当前规则才有可能被激活。</p>
<h4><span id="4-5-bi-jiao-cao-zuo-fu">4.5、比较操作符</span></h4><p>Drools提供的比较操作符，如下表：</p>
<table>
<thead>
<tr>
<th align="left">符号</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">&lt;</td>
<td align="left">小于</td>
</tr>
<tr>
<td align="left">&gt;</td>
<td align="left">大于</td>
</tr>
<tr>
<td align="left">&gt;=</td>
<td align="left">大于等于</td>
</tr>
<tr>
<td align="left">&lt;=</td>
<td align="left">小于等于</td>
</tr>
<tr>
<td align="left">==</td>
<td align="left">等于</td>
</tr>
<tr>
<td align="left">!=</td>
<td align="left">不等于</td>
</tr>
<tr>
<td align="left">contains</td>
<td align="left">检查一个Fact对象的某个属性值是否包含一个指定的对象值</td>
</tr>
<tr>
<td align="left">not contains</td>
<td align="left">检查一个Fact对象的某个属性值是否不包含一个指定的对象值</td>
</tr>
<tr>
<td align="left">memberOf</td>
<td align="left">判断一个Fact对象的某个属性是否在一个或多个集合中</td>
</tr>
<tr>
<td align="left">not memberOf</td>
<td align="left">判断一个Fact对象的某个属性是否不在一个或多个集合中</td>
</tr>
<tr>
<td align="left">matches</td>
<td align="left">判断一个Fact对象的属性是否与提供的标准的Java正则表达式进行匹配</td>
</tr>
<tr>
<td align="left">not matches</td>
<td align="left">判断一个Fact对象的属性是否不与提供的标准的Java正则表达式进行匹配</td>
</tr>
</tbody></table>
<p>前6个比较操作符和Java中的完全相同。</p>
<h4><span id="4-6-drools-nei-zhi-fang-fa">4.6、Drools内置方法</span></h4><p>规则文件的<code>RHS</code>部分的主要作用是通过<strong>插入，删除或修改工作内存中的Fact数据</strong>，来达到控制规则引擎执行的目的。Drools提供了一些方法可以用来操作工作内存中的数据，<strong>操作完成后规则引擎会重新进行相关规则的匹配，</strong>原来没有匹配成功的规则在我们修改数据完成后有可能就会匹配成功了。</p>
<h5><span id="4-6-1-update-fang-fa">4.6.1、update方法</span></h5><p><strong>update方法的作用是更新工作内存中的数据，并让相关的规则重新匹配。</strong>   （要避免死循环）</p>
<p>参数：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Fact对象，事实对象</span></span><br><span class="line"><span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Order</span>();</span><br><span class="line">order.setAmout(<span class="number">30</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>规则：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//规则一：100元以下 不加分</span></span><br><span class="line">rule <span class="string">"order_rule_1"</span></span><br><span class="line">    when</span><br><span class="line">        $order:Order(amout &lt; <span class="number">100</span>)</span><br><span class="line">    then</span><br><span class="line">        $order.setAmout(<span class="number">150</span>);</span><br><span class="line">	    update($order) <span class="comment">//update方法用于更新Fact对象，会导致相关规则重新匹配</span></span><br><span class="line">        System.out.println(<span class="string">"成功匹配到规则一：100元以下 不加分"</span>);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="comment">//规则二：100元 - 500元 加100分</span></span><br><span class="line">rule <span class="string">"order_rule_2"</span></span><br><span class="line">    when</span><br><span class="line">        $order:Order(amout &gt;= <span class="number">100</span> &amp;&amp; amout &lt; <span class="number">500</span>)</span><br><span class="line">    then</span><br><span class="line">         $order.setScore(<span class="number">100</span>);</span><br><span class="line">         System.out.println(<span class="string">"成功匹配到规则二：100元 - 500元 加100分"</span>);</span><br><span class="line">end</span><br></pre></td></tr></tbody></table></figure>

<p>在更新数据时需要注意防止发生死循环。</p>
<h5><span id="4-6-2-insert-fang-fa">4.6.2、insert方法</span></h5><p>insert方法的作用是向工作内存中插入数据，并让相关的规则重新匹配。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//规则一：100元以下 不加分</span></span><br><span class="line">rule <span class="string">"order_rule_1"</span></span><br><span class="line">    when</span><br><span class="line">        $order:Order(amout &lt; <span class="number">100</span>)</span><br><span class="line">    then</span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Order</span>();</span><br><span class="line">        order.setAmout(<span class="number">130</span>);</span><br><span class="line">        insert(order);      <span class="comment">//insert方法的作用是向工作内存中插入Fact对象，会导致相关规则重新匹配</span></span><br><span class="line">        System.out.println(<span class="string">"成功匹配到规则一：100元以下 不加分"</span>);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="comment">//规则二：100元 - 500元 加100分</span></span><br><span class="line">rule <span class="string">"order_rule_2"</span></span><br><span class="line">    when</span><br><span class="line">        $order:Order(amout &gt;= <span class="number">100</span> &amp;&amp; amout &lt; <span class="number">500</span>)</span><br><span class="line">    then</span><br><span class="line">         $order.setScore(<span class="number">100</span>);</span><br><span class="line">         System.out.println(<span class="string">"成功匹配到规则二：100元 - 500元 加100分"</span>);</span><br><span class="line">end</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-6-3-retract-fang-fa">4.6.3、retract方法</span></h5><p><strong>retract方法的作用是删除工作内存中的数据，并让相关的规则重新匹配。</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//规则一：100元以下 不加分</span></span><br><span class="line">rule <span class="string">"order_rule_1"</span></span><br><span class="line">    when</span><br><span class="line">        $order:Order(amout &lt; <span class="number">100</span>)</span><br><span class="line">    then</span><br><span class="line">        <span class="title function_">retract</span><span class="params">($order)</span>      <span class="comment">//retract方法的作用是删除工作内存中的Fact对象，会导致相关规则重新匹配</span></span><br><span class="line">        System.out.println(<span class="string">"成功匹配到规则一：100元以下 不加分"</span>);</span><br><span class="line">end</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="5-gui-ze-shu-xing-attributes">5、规则属性  attributes</span></h3><p>前面我们已经知道了规则体的构成如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rule <span class="string">"ruleName"</span></span><br><span class="line">    attributes</span><br><span class="line">    when</span><br><span class="line">        LHS</span><br><span class="line">    then</span><br><span class="line">        RHS</span><br><span class="line">end</span><br></pre></td></tr></tbody></table></figure>

<p>本章节就是针对规则体的<strong>attributes</strong>属性部分进行讲解。Drools中提供的属性如下表(部分属性)：</p>
<table>
<thead>
<tr>
<th align="left">属性名</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">salience</td>
<td align="left">指定规则执行优先级</td>
</tr>
<tr>
<td align="left">dialect</td>
<td align="left">指定规则使用的语言类型，取值为java和mvel</td>
</tr>
<tr>
<td align="left">enabled</td>
<td align="left">指定规则是否启用</td>
</tr>
<tr>
<td align="left">date-effective</td>
<td align="left">指定规则生效时间</td>
</tr>
<tr>
<td align="left">date-expires</td>
<td align="left">指定规则失效时间</td>
</tr>
<tr>
<td align="left">activation-group</td>
<td align="left">激活分组，具有相同分组名称的规则只能有一个规则触发</td>
</tr>
<tr>
<td align="left">agenda-group</td>
<td align="left">议程分组，只有获取焦点的组中的规则才有可能触发</td>
</tr>
<tr>
<td align="left">timer</td>
<td align="left">定时器，指定规则触发的时间</td>
</tr>
<tr>
<td align="left">auto-focus</td>
<td align="left">自动获取焦点，一般结合agenda-group一起使用</td>
</tr>
<tr>
<td align="left">no-loop</td>
<td align="left">防止死循环</td>
</tr>
</tbody></table>
<p>重点说一下我们项目需要使用的属性</p>
<h4><span id="5-1-salience-shu-xing">5.1、salience属性</span></h4><p>salience属性用于指定规则的执行优先级，<strong>取值类型为Integer</strong>。<strong>数值越大越优先执行</strong>。每个规则都有一个默认的执行顺序，如果不设置salience属性，规则体的执行顺序为由上到下。</p>
<p>可以通过创建规则文件salience.drl来测试salience属性，内容如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.order</span><br><span class="line"></span><br><span class="line">rule <span class="string">"rule_1"</span></span><br><span class="line">    when</span><br><span class="line">        <span class="title function_">eval</span><span class="params">(<span class="literal">true</span>)</span></span><br><span class="line">    then</span><br><span class="line">        System.out.println(<span class="string">"规则rule_1触发"</span>);</span><br><span class="line">end</span><br><span class="line">    </span><br><span class="line">rule <span class="string">"rule_2"</span></span><br><span class="line">    when</span><br><span class="line">        <span class="title function_">eval</span><span class="params">(<span class="literal">true</span>)</span></span><br><span class="line">    then</span><br><span class="line">        System.out.println(<span class="string">"规则rule_2触发"</span>);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">rule <span class="string">"rule_3"</span></span><br><span class="line">    when</span><br><span class="line">        <span class="title function_">eval</span><span class="params">(<span class="literal">true</span>)</span></span><br><span class="line">    then</span><br><span class="line">        System.out.println(<span class="string">"规则rule_3触发"</span>);</span><br><span class="line">end</span><br></pre></td></tr></tbody></table></figure>



<p>通过控制台可以看到，由于以上三个规则没有设置salience属性，所以执行的顺序是按照规则文件中规则的顺序由上到下执行的。接下来我们修改一下文件内容：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.order</span><br><span class="line"></span><br><span class="line">rule <span class="string">"rule_1"</span></span><br><span class="line">    salience <span class="number">9</span></span><br><span class="line">    when</span><br><span class="line">        <span class="title function_">eval</span><span class="params">(<span class="literal">true</span>)</span></span><br><span class="line">    then</span><br><span class="line">        System.out.println(<span class="string">"规则rule_1触发"</span>);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">rule <span class="string">"rule_2"</span></span><br><span class="line">    salience <span class="number">10</span></span><br><span class="line">    when</span><br><span class="line">        <span class="title function_">eval</span><span class="params">(<span class="literal">true</span>)</span></span><br><span class="line">    then</span><br><span class="line">        System.out.println(<span class="string">"规则rule_2触发"</span>);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">rule <span class="string">"rule_3"</span></span><br><span class="line">    salience <span class="number">8</span></span><br><span class="line">    when</span><br><span class="line">        <span class="title function_">eval</span><span class="params">(<span class="literal">true</span>)</span></span><br><span class="line">    then</span><br><span class="line">        System.out.println(<span class="string">"规则rule_3触发"</span>);</span><br><span class="line">end</span><br></pre></td></tr></tbody></table></figure>

<p>通过控制台可以看到，规则文件执行的顺序是按照我们设置的salience值由大到小顺序执行的。</p>
<p>建议在编写规则时使用salience属性明确指定执行优先级。</p>
<h4><span id="5-2-no-loop-shu-xing">5.2、no-loop属性</span></h4><p>no-loop属性用于防止死循环，当规则通过update之类的函数修改了Fact对象时，可能使当前规则再次被激活从而导致死循环。取值类型为Boolean，默认值为false，测试步骤如下：</p>
<p>编写规则文件/resources/rules/activationgroup.drl</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//订单积分规则</span></span><br><span class="line"><span class="keyword">package</span> com.order</span><br><span class="line"><span class="keyword">import</span> com.atguigu.drools.model.Order</span><br><span class="line"></span><br><span class="line"><span class="comment">//规则一：100元以下 不加分</span></span><br><span class="line">rule <span class="string">"order_rule_1"</span></span><br><span class="line">    no-loop <span class="literal">true</span>         <span class="comment">//防止陷入死循环</span></span><br><span class="line">    when</span><br><span class="line">        $order:Order(amout &lt; <span class="number">100</span>)</span><br><span class="line">    then</span><br><span class="line">        $order.setScore(<span class="number">0</span>);</span><br><span class="line">        update($order)</span><br><span class="line">        System.out.println(<span class="string">"成功匹配到规则一：100元以下 不加分"</span>);</span><br><span class="line">end</span><br></pre></td></tr></tbody></table></figure>

<p>通过控制台可以看到，由于我们没有设置no-loop属性的值，所以发生了死循环。接下来设置no-loop的值为true再次测试则不会发生死循环。</p>
<h3><span id="6-drools-gao-ji-yu-fa">6、Drools高级语法</span></h3><p>前面章节我们已经知道了一套完整的规则文件内容构成如下：</p>
<table>
<thead>
<tr>
<th align="left">关键字</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">package</td>
<td align="left">包名，只限于逻辑上的管理，同一个包名下的查询或者函数可以直接调用</td>
</tr>
<tr>
<td align="left">import</td>
<td align="left">用于导入类或者静态方法</td>
</tr>
<tr>
<td align="left">global</td>
<td align="left">全局变量</td>
</tr>
<tr>
<td align="left">function</td>
<td align="left">自定义函数</td>
</tr>
<tr>
<td align="left">query</td>
<td align="left">查询</td>
</tr>
<tr>
<td align="left">rule end</td>
<td align="left">规则体</td>
</tr>
</tbody></table>
<h4><span id="6-1-global-quan-ju-bian-liang">6.1、global全局变量</span></h4><p>global关键字用于在规则文件中<strong>定义全局变量</strong>，它可以让应用程序的对象在规则文件中能够被访问。可以用来为规则文件提供数据或服务。</p>
<p>语法结构为：<strong>global 对象类型 对象名称</strong></p>
<p>在使用global定义的全局变量时有两点需要注意：</p>
<p>1、如果对象类型为<strong>包装类型</strong>时，在一个规则中改变了global的值，那么<strong>只针对当前规则有效</strong>，对其他规则中的global不会有影响。可以理解为它是当前规则代码中的global副本，规则内部修改不会影响全局的使用。</p>
<p>2、如果对象类型为<strong>集合类型或JavaBean</strong>时，在一个规则中改变了global的值，对java代码和所有规则都有效。</p>
<p>订单Order：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.drools.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Order</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> amout;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getAmout</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> amout;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAmout</span><span class="params">(<span class="type">double</span> amout)</span> {</span><br><span class="line">        <span class="built_in">this</span>.amout = amout;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>积分Integral：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.drools.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Integral</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> score;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getScore</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> score;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setScore</span><span class="params">(<span class="type">double</span> score)</span> {</span><br><span class="line">        <span class="built_in">this</span>.score = score;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>规则文件：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//订单积分规则</span></span><br><span class="line"><span class="keyword">package</span> com.order</span><br><span class="line"><span class="keyword">import</span> com.atguigu.drools.model.Order</span><br><span class="line"></span><br><span class="line">global com.atguigu.drools.model.Integral integral;</span><br><span class="line"></span><br><span class="line"><span class="comment">//规则一：100元以下 不加分</span></span><br><span class="line">rule <span class="string">"order_rule_1"</span></span><br><span class="line">    no-loop <span class="literal">true</span>         <span class="comment">//防止陷入死循环</span></span><br><span class="line">    when</span><br><span class="line">        $order:Order(amout &lt; <span class="number">100</span>)</span><br><span class="line">    then</span><br><span class="line">        integral.setScore(<span class="number">10</span>);</span><br><span class="line">        update($order)</span><br><span class="line">        System.out.println(<span class="string">"成功匹配到规则一：100元以下 不加分"</span>);</span><br><span class="line">end</span><br></pre></td></tr></tbody></table></figure>

<p>测试：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span>{</span><br><span class="line">    <span class="comment">//从Kie容器对象中获取会话对象</span></span><br><span class="line">    <span class="type">KieSession</span> <span class="variable">session</span> <span class="operator">=</span> kieContainer.newKieSession();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Fact对象，事实对象</span></span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Order</span>();</span><br><span class="line">    order.setAmout(<span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//全局变量</span></span><br><span class="line">    <span class="type">Integral</span> <span class="variable">integral</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Integral</span>();</span><br><span class="line">    session.setGlobal(<span class="string">"integral"</span>, integral);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将Order对象插入到工作内存中</span></span><br><span class="line">    session.insert(order);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//激活规则，由Drools框架自动进行规则匹配，如果规则匹配成功，则执行当前规则</span></span><br><span class="line">    session.fireAllRules();</span><br><span class="line">    <span class="comment">//关闭会话</span></span><br><span class="line">    session.dispose();</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"订单金额："</span> + order.getAmout());</span><br><span class="line">    System.out.println(<span class="string">"添加积分："</span> + integral.getScore());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1><span id="v-cheng-ke-xia-dan-yi">Ⅴ.乘客下单（一）</span></h1><h3><span id="1-xu-qiu-shuo-ming">1、需求说明</span></h3><p>乘客下单如图：</p>
<p><img src="/2024/09/26/projection-daijia/cm_order_su.gif" alt="cm_order_su"></p>
<p>经过前面的选点、预估订单数据，接下来就就是呼叫代驾了（即：下单），下单参数：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Schema(description = "乘客id")</span></span><br><span class="line"><span class="keyword">private</span> Long customerId;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Schema(description = "起始地点")</span></span><br><span class="line"><span class="keyword">private</span> String startLocation;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Schema(description = "起始地点经度")</span></span><br><span class="line"><span class="keyword">private</span> BigDecimal startPointLongitude;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Schema(description = "起始点伟度")</span></span><br><span class="line"><span class="keyword">private</span> BigDecimal startPointLatitude;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Schema(description = "结束地点")</span></span><br><span class="line"><span class="keyword">private</span> String endLocation;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Schema(description = "结束地点经度")</span></span><br><span class="line"><span class="keyword">private</span> BigDecimal endPointLongitude;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Schema(description = "结束地点经度")</span></span><br><span class="line"><span class="keyword">private</span> BigDecimal endPointLatitude;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Schema(description = "顾客好处费")</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">BigDecimal</span> <span class="variable">favourFee</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0</span>);</span><br></pre></td></tr></tbody></table></figure>

<p>这些参数，都是从前端页面获取的，顾客好处费为预留属性，有些时候代驾费用太低，司机没兴趣接单，那么乘客可以加价找代驾的情况使用。</p>
<p>然后我们再计算预估里程与预估价格，把这些属性都保存到订单表即可。</p>
<p>订单表：</p>
<p><img src="/2024/09/26/projection-daijia/1700202723040.png" alt="70020272304"></p>
<p>圈着的为下单必须填充的表字段。</p>
<p>保存完订单数据就完事了吗？肯定不是的，因为还要启动任务调度，搜索附近可接单的代驾司机，这一过程相对复杂与繁琐，后续会逐渐完善，先完成一个简单的下单过程。</p>
<h3><span id="2-cheng-ke-xia-dan">2、乘客下单</span></h3><p>乘客下单时，我们拿到的订单费用都是预估费用，不是实际费用，因此下单时我们不插入账单信息，实际的账单信息是在代驾结束后产生的，实际的代驾里程会根据代驾过程中实时上传的金纬度计算获取，代驾过程中可能还要产生一些未知的费用，如：等时费、停车费、路桥费等。</p>
<h4><span id="2-1-ding-dan-wei-fu-wu-jie-kou">2.1、订单微服务接口</span></h4><h5><span id="2-1-1-orderinfoform">2.1.1、OrderInfoForm</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Schema(description = "订单实体")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderInfoForm</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "客户ID")</span></span><br><span class="line">   <span class="keyword">private</span> Long customerId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "订单号")</span></span><br><span class="line">   <span class="keyword">private</span> String orderNo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "起始地点")</span></span><br><span class="line">   <span class="keyword">private</span> String startLocation;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "起始地点经度")</span></span><br><span class="line">   <span class="keyword">private</span> BigDecimal startPointLongitude;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "起始点伟度")</span></span><br><span class="line">   <span class="keyword">private</span> BigDecimal startPointLatitude;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "结束地点")</span></span><br><span class="line">   <span class="keyword">private</span> String endLocation;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "结束地点经度")</span></span><br><span class="line">   <span class="keyword">private</span> BigDecimal endPointLongitude;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "结束地点经度")</span></span><br><span class="line">   <span class="keyword">private</span> BigDecimal endPointLatitude;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "顾客好处费")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal favourFee;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "订单备注信息")</span></span><br><span class="line">    <span class="keyword">private</span> String remark;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//预期费用信息</span></span><br><span class="line">    <span class="meta">@Schema(description = "预估订单费用")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal expectAmount;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "预估里程")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal expectDistance;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-2-orderinfocontroller">2.1.2、OrderInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OrderInfoService orderInfoService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "保存订单信息")</span></span><br><span class="line"><span class="meta">@PostMapping("/saveOrderInfo")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Long&gt; <span class="title function_">saveOrderInfo</span><span class="params">(<span class="meta">@RequestBody</span> OrderInfoForm orderInfoForm)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(orderInfoService.saveOrderInfo(orderInfoForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-3-orderinfoservice">2.1.3、OrderInfoService</span></h5><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Long saveOrderInfo(OrderInfoForm orderInfoForm);</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-4-orderinfoserviceimpl">2.1.4、OrderInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OrderInfoMapper orderInfoMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OrderStatusLogMapper orderStatusLogMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = {Exception.class})</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">saveOrderInfo</span><span class="params">(OrderInfoForm orderInfoForm)</span> {</span><br><span class="line">   <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfo</span>();</span><br><span class="line">   BeanUtils.copyProperties(orderInfoForm, orderInfo);</span><br><span class="line">   <span class="type">String</span> <span class="variable">orderNo</span> <span class="operator">=</span> UUID.randomUUID().toString().replaceAll(<span class="string">"-"</span>,<span class="string">""</span>);</span><br><span class="line">   orderInfo.setStatus(OrderStatus.WAITING_ACCEPT.getStatus());</span><br><span class="line">   orderInfo.setOrderNo(orderNo);</span><br><span class="line">   orderInfoMapper.insert(orderInfo);x</span><br><span class="line"></span><br><span class="line">   <span class="comment">//记录日志</span></span><br><span class="line">   <span class="built_in">this</span>.log(orderInfo.getId(), orderInfo.getStatus());</span><br><span class="line"></span><br><span class="line">   <span class="comment">//接单标识，标识不存在了说明不在等待接单状态了</span></span><br><span class="line">   redisTemplate.opsForValue().set(RedisConstant.ORDER_ACCEPT_MARK, <span class="string">"0"</span>, RedisConstant.ORDER_ACCEPT_MARK_EXPIRES_TIME, TimeUnit.MINUTES);</span><br><span class="line">   <span class="keyword">return</span> orderInfo.getId();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">log</span><span class="params">(Long orderId, Integer status)</span> {</span><br><span class="line">   <span class="type">OrderStatusLog</span> <span class="variable">orderStatusLog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderStatusLog</span>();</span><br><span class="line">   orderStatusLog.setOrderId(orderId);</span><br><span class="line">   orderStatusLog.setOrderStatus(status);</span><br><span class="line">   orderStatusLog.setOperateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">   orderStatusLogMapper.insert(orderStatusLog);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-2-feign-jie-kou">2.2、Feign接口</span></h4><h5><span id="2-2-1-orderinfofeignclient">2.2.1、OrderInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 保存订单信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderInfoForm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping("/order/info/saveOrderInfo")</span></span><br><span class="line">Result&lt;Long&gt; <span class="title function_">saveOrderInfo</span><span class="params">(<span class="meta">@RequestBody</span> OrderInfoForm orderInfoForm)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-3-cheng-ke-duan-web-jie-kou">2.3、乘客端web接口</span></h4><h5><span id="2-3-1-submitorderform">2.3.1、SubmitOrderForm</span></h5><p>乘客下单的参数</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubmitOrderForm</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "乘客id")</span></span><br><span class="line">    <span class="keyword">private</span> Long customerId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "起始地点")</span></span><br><span class="line">    <span class="keyword">private</span> String startLocation;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "起始地点经度")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal startPointLongitude;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "起始点伟度")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal startPointLatitude;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "结束地点")</span></span><br><span class="line">    <span class="keyword">private</span> String endLocation;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "结束地点经度")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal endPointLongitude;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "结束地点经度")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal endPointLatitude;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "顾客好处费")</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">BigDecimal</span> <span class="variable">favourFee</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>说明：支持乘客添加好处费，这样能快速激励司机接单</p>
<h5><span id="2-3-2-ordercontroller">2.3.2、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "乘客下单")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@PostMapping("/submitOrder")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Long&gt; <span class="title function_">submitOrder</span><span class="params">(<span class="meta">@RequestBody</span> SubmitOrderForm submitOrderForm)</span> {</span><br><span class="line">   submitOrderForm.setCustomerId(AuthContextHolder.getUserId());</span><br><span class="line">   <span class="keyword">return</span> Result.ok(orderService.submitOrder(submitOrderForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-3-3-orderservice">2.3.3、OrderService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Long <span class="title function_">submitOrder</span><span class="params">(SubmitOrderForm submitOrderForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-3-4-orderserviceimpl">2.3.4、OrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OrderInfoFeignClient orderInfoFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">submitOrder</span><span class="params">(SubmitOrderForm submitOrderForm)</span> {</span><br><span class="line">    <span class="comment">//1.重新计算驾驶线路</span></span><br><span class="line">    <span class="type">CalculateDrivingLineForm</span> <span class="variable">calculateDrivingLineForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CalculateDrivingLineForm</span>();</span><br><span class="line">    BeanUtils.copyProperties(submitOrderForm, calculateDrivingLineForm);</span><br><span class="line">    <span class="type">DrivingLineVo</span> <span class="variable">drivingLineVo</span> <span class="operator">=</span> mapFeignClient.calculateDrivingLine(calculateDrivingLineForm).getData();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.重新计算订单费用</span></span><br><span class="line">    <span class="type">FeeRuleRequestForm</span> <span class="variable">calculateOrderFeeForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeeRuleRequestForm</span>();</span><br><span class="line">    calculateOrderFeeForm.setDistance(drivingLineVo.getDistance());</span><br><span class="line">    calculateOrderFeeForm.setStartTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    calculateOrderFeeForm.setWaitMinute(<span class="number">0</span>);</span><br><span class="line">    <span class="type">FeeRuleResponseVo</span> <span class="variable">feeRuleResponseVo</span> <span class="operator">=</span> feeRuleFeignClient.calculateOrderFee(calculateOrderFeeForm).getData();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.封装订单信息对象</span></span><br><span class="line">    <span class="type">OrderInfoForm</span> <span class="variable">orderInfoForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfoForm</span>();</span><br><span class="line">    <span class="comment">//订单位置信息</span></span><br><span class="line">    BeanUtils.copyProperties(submitOrderForm, orderInfoForm);</span><br><span class="line">    <span class="comment">//预估里程</span></span><br><span class="line">    orderInfoForm.setExpectDistance(drivingLineVo.getDistance());</span><br><span class="line">    orderInfoForm.setExpectAmount(feeRuleResponseVo.getTotalAmount());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4.保存订单信息</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> orderInfoFeignClient.saveOrderInfo(orderInfoForm).getData();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//TODO启动任务调度</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> orderId;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-cheng-ke-duan-cha-xun-ding-dan-zhuang-tai">3、乘客端查询订单状态</span></h3><p>乘客下完单后，订单状态为1，乘客端小程序会轮询订单状态，当订单状态为2时，说明已经有司机接单了，那么页面进行跳转，进行下一步操作</p>
<h4><span id="3-1-ding-dan-wei-fu-wu-jie-kou">3.1、订单微服务接口</span></h4><h5><span id="3-1-1-orderinfocontroller">3.1.1、OrderInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "根据订单id获取订单状态")</span></span><br><span class="line"><span class="meta">@GetMapping("/getOrderStatus/{orderId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Integer&gt; <span class="title function_">getOrderStatus</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(orderInfoService.getOrderStatus(orderId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-2-orderinfoservice">3.1.2、OrderInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Integer <span class="title function_">getOrderStatus</span><span class="params">(Long orderId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-2-orderinfoserviceimpl">3.1.2、OrderInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Integer <span class="title function_">getOrderStatus</span><span class="params">(Long orderId)</span> {</span><br><span class="line">   LambdaQueryWrapper&lt;OrderInfo&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">   queryWrapper.eq(OrderInfo::getId, orderId);</span><br><span class="line">   queryWrapper.select(OrderInfo::getStatus);</span><br><span class="line">   <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoMapper.selectOne(queryWrapper);</span><br><span class="line">   <span class="keyword">if</span>(<span class="literal">null</span> == orderInfo) {</span><br><span class="line">      <span class="comment">//返回null，feign解析会抛出异常，给默认值，后续会用</span></span><br><span class="line">      <span class="keyword">return</span> OrderStatus.NULL_ORDER.getStatus();</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">return</span> orderInfo.getStatus();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-2-feign-jie-kou">3.2、 Feign接口</span></h4><h5><span id="3-2-1-orderinfofeignclient">3.2.1、OrderInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据订单id获取订单状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/order/info/getOrderStatus/{orderId}")</span></span><br><span class="line">Result&lt;Integer&gt; <span class="title function_">getOrderStatus</span><span class="params">(<span class="meta">@PathVariable("orderId")</span> Long orderId)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-3-cheng-ke-duan-web-jie-kou">3.3、 乘客端web接口</span></h4><h5><span id="3-3-1-ordercontroller">3.3.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "查询订单状态")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("/getOrderStatus/{orderId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Integer&gt; <span class="title function_">getOrderStatus</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(orderService.getOrderStatus(orderId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-3-2-orderservice">3.3.2、OrderService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Integer <span class="title function_">getOrderStatus</span><span class="params">(Long orderId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-3-3-orderserviceimpl">3.3.3、OrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Integer <span class="title function_">getOrderStatus</span><span class="params">(Long orderId)</span> {</span><br><span class="line">    <span class="keyword">return</span> orderInfoFeignClient.getOrderStatus(orderId).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-si-ji-duan-cha-xun-ding-dan-zhuang-tai">4、司机端查询订单状态</span></h3><p>司机端也是一样的，司机端也会轮询订单状态，根据订单状态进行页面跳转，我们先把这个接口给提供了。</p>
<h4><span id="4-1-si-ji-duan-web-jie-kou">4.1、 司机端web接口</span></h4><h5><span id="4-1-1-ordercontroller">4.1.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "查询订单状态")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("/getOrderStatus/{orderId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Integer&gt; <span class="title function_">getOrderStatus</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(orderService.getOrderStatus(orderId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-2-orderservice">4.1.2、OrderService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Integer <span class="title function_">getOrderStatus</span><span class="params">(Long orderId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-3-orderserviceimpl">4.1.3、OrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Integer <span class="title function_">getOrderStatus</span><span class="params">(Long orderId)</span> {</span><br><span class="line">    <span class="keyword">return</span> orderInfoFeignClient.getOrderStatus(orderId).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1><span id="vi-cheng-ke-xia-dan-er">Ⅵ.乘客下单（二）</span></h1><h2><span id="yi-sou-suo-fu-jin-si-ji">一、搜索附近司机</span></h2><h3><span id="1-redis-de-geo-gong-neng">1、Redis的Geo功能</span></h3><p>前面我们创建了订单，但是略过了寻找附近适合接单的司机。接下来完善这部分功能，那就先来看看怎么查询附近的司机吧。假设司机端的小程序实时把自己的GPS定位上传，然后定位信息缓存到Redis里面。咱们怎么能利用Redis计算出，上车点方圆几公里的司机都有谁呢？这就需要使用Redis的Geo功能。</p>
<p><a target="_blank" rel="noopener" href="https://redis.io/docs/latest/develop/data-types/">https://redis.io/docs/latest/develop/data-types/</a></p>
<p>Redis的Geo主要用于存储地理位置信息，并对存储的信息进行操作，该功能在 Redis 3.2 版本新增。 下面我们用<code>GEOADD</code>命令向Redis里面添加几个景点的定位。</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GEOADD gugong 116.403963 39.915119 tiananmen 116.417876 39.915411 wangfujing 116.404354 39.904748 qianmen</span><br></pre></td></tr></tbody></table></figure>

<p>然后我们<code>GEORADIUS</code>命令查询距离某个定位点1公里范围以内的景点有哪些。</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GEORADIUS gugong 116.4000 39.9000 1 km WITHDIST</span><br></pre></td></tr></tbody></table></figure>

<p>既然Redis的GEO命令可以帮我们提取出某个坐标点指定距离以内的景点，如果Redis里面缓存的是司机的定位信息，那么我们用代驾单的起点坐标来查询附近几公里以内的司机，是不是也可以？而且Redis的Geo计算是在内存中完成的，比MySQL的Geo计算快了上千倍。</p>
<h3><span id="2-shi-shi-geng-xin-si-ji-wei-zhi-xin-xi">2、实时更新司机位置信息</span></h3><p>前面我们弄明白了Redis的GEO技术。咱们想要让Redis计算代驾起点周围几公里以内的司机，首先我们要把司机的定位信息缓存到GEO里面。</p>
<p>司机开启接单服务后，司机端小程序就会实时上传经纬度信息到redis的GEO，关闭接单服务我们就要清空GEO数据，当前就一并把更新与删除司机位置信息给写了，删除不需要提供web接口，其他service服务方法调用。</p>
<h4><span id="2-1-feng-zhuang-di-tu-wei-fu-wu-jie-kou">2.1、封装地图微服务接口</span></h4><h5><span id="2-1-1-locationcontroller">2.1.1、LocationController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> LocationService locationService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "开启接单服务：更新司机经纬度位置")</span></span><br><span class="line"><span class="meta">@PostMapping("/updateDriverLocation")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">updateDriverLocation</span><span class="params">(<span class="meta">@RequestBody</span> UpdateDriverLocationForm updateDriverLocationForm)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(locationService.updateDriverLocation(updateDriverLocationForm));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "关闭接单服务：删除司机经纬度位置")</span></span><br><span class="line"><span class="meta">@DeleteMapping("/removeDriverLocation/{driverId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">removeDriverLocation</span><span class="params">(<span class="meta">@PathVariable</span> Long driverId)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(locationService.removeDriverLocation(driverId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-2-locationservice">2.1.2、LocationService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">updateDriverLocation</span><span class="params">(UpdateDriverLocationForm updateDriverLocationForm)</span>;</span><br><span class="line"></span><br><span class="line">Boolean <span class="title function_">removeDriverLocation</span><span class="params">(Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-3-locationserviceimpl">2.1.3、LocationServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">updateDriverLocation</span><span class="params">(UpdateDriverLocationForm updateDriverLocationForm)</span> {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  Redis GEO 主要用于存储地理位置信息，并对存储的信息进行相关操作，该功能在 Redis 3.2 版本新增。</span></span><br><span class="line"><span class="comment">     *  后续用在，乘客下单后寻找5公里范围内开启接单服务的司机，通过Redis GEO进行计算</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">Point</span> <span class="variable">point</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Point</span>(updateDriverLocationForm.getLongitude().doubleValue(), updateDriverLocationForm.getLatitude().doubleValue());</span><br><span class="line">    redisTemplate.opsForGeo().add(RedisConstant.DRIVER_GEO_LOCATION, point, updateDriverLocationForm.getDriverId().toString());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">removeDriverLocation</span><span class="params">(Long driverId)</span> {</span><br><span class="line">    redisTemplate.opsForGeo().remove(RedisConstant.DRIVER_GEO_LOCATION, driverId.toString());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-2-feign-jie-kou">2.2、Feign接口</span></h4><h5><span id="2-2-1-locationfeignclient">2.2.1、LocationFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 开启接单服务：更新司机经纬度位置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> updateDriverLocationForm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping("/map/location/updateDriverLocation")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">updateDriverLocation</span><span class="params">(<span class="meta">@RequestBody</span> UpdateDriverLocationForm updateDriverLocationForm)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 关闭接单服务：删除司机经纬度位置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@DeleteMapping("/map/location/removeDriverLocation/{driverId}")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">removeDriverLocation</span><span class="params">(<span class="meta">@PathVariable("driverId")</span> Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-3-si-ji-duan-web-jie-kou">2.3、司机端web接口</span></h4><h5><span id="2-3-1-locationcontroller">2.3.1、LocationController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> LocationService locationService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "开启接单服务：更新司机经纬度位置")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@PostMapping("/updateDriverLocation")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">updateDriverLocation</span><span class="params">(<span class="meta">@RequestBody</span> UpdateDriverLocationForm updateDriverLocationForm)</span> {</span><br><span class="line">   <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">   updateDriverLocationForm.setDriverId(driverId);</span><br><span class="line">   <span class="keyword">return</span> Result.ok(locationService.updateDriverLocation(updateDriverLocationForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-3-1-locationservice">2.3.1、LocationService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">updateDriverLocation</span><span class="params">(UpdateDriverLocationForm updateDriverLocationForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-3-1-locationserviceimpl">2.3.1、LocationServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">updateDriverLocation</span><span class="params">(UpdateDriverLocationForm updateDriverLocationForm)</span> {</span><br><span class="line">    <span class="keyword">return</span> locationFeignClient.updateDriverLocation(updateDriverLocationForm).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-huo-qu-si-ji-ge-xing-hua-she-zhi-xiao-xi">3、获取司机个性化设置消息</span></h3><p>司机针对接单，有一些个性化设置，只有满足了这些条件，才可以接单，如：“实时更新司机位置信息”，只有开启了接单服务，接口才可以更新数据</p>
<h4><span id="3-1-she-zhi-biao">3.1、设置表</span></h4><p><img src="/2024/09/26/projection-daijia/1698733880294.png" alt="69873388029"></p>
<p><strong>说明：</strong></p>
<p>service_status：服务状态，司机开启了接单，才能进行接单后的一些列操作；</p>
<p>order_distance：订单里程设置，如：order_distance=0（不限制）；order_distance=50（只接代驾里程在50公里范围内的订单）；</p>
<p>accept_distance：接单里程设置，司机起始点距离司机的位置，如：accept_distance=3（只接收3公里范围内的订单）；</p>
<p>is_auto_accept：是否自动接单，开启后，系统自动抢单，不需要手动点接单按钮；</p>
<h4><span id="3-2-si-ji-wei-fu-wu-jie-kou">3.2、司机微服务接口</span></h4><h5><span id="3-2-1-driverinfocontroller">3.2.1、DriverInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "获取司机设置信息")</span></span><br><span class="line"><span class="meta">@GetMapping("/getDriverSet/{driverId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;DriverSet&gt; <span class="title function_">getDriverSet</span><span class="params">(<span class="meta">@PathVariable</span> Long driverId)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(driverInfoService.getDriverSet(driverId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-2-2-driverinfoservice">3.2.2、DriverInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DriverSet <span class="title function_">getDriverSet</span><span class="params">(Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-2-2-driverinfoserviceimpl">3.2.2、DriverInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DriverSetMapper driverSetMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DriverSet <span class="title function_">getDriverSet</span><span class="params">(Long driverId)</span> {</span><br><span class="line">    LambdaQueryWrapper&lt;DriverSet&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(DriverSet::getDriverId, driverId);</span><br><span class="line">    <span class="keyword">return</span> driverSetMapper.selectOne(queryWrapper);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-3-feign-jie-kou">3.3、Feign接口</span></h4><h5><span id="3-3-1-driverinfofeignclient">3.3.1、DriverInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取司机设置信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/driver/info/getDriverSet/{driverId}")</span></span><br><span class="line">Result&lt;DriverSet&gt; <span class="title function_">getDriverSet</span><span class="params">(<span class="meta">@PathVariable("driverId")</span> Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="3-4-geng-xin-shi-shi-geng-xin-si-ji-wei-zhi-xin-xi-web-jie-kou">3.4、更新“实时更新司机位置信息”web接口</span></h4><h5><span id="3-4-1-locationserviceimpl">3.4.1、LocationServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DriverInfoFeignClient driverInfoFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">updateDriverLocation</span><span class="params">(UpdateDriverLocationForm updateDriverLocationForm)</span> {</span><br><span class="line">    <span class="comment">//开启接单了才能更新司机接单位置</span></span><br><span class="line">    <span class="type">DriverSet</span> <span class="variable">driverSet</span> <span class="operator">=</span> driverInfoFeignClient.getDriverSet(updateDriverLocationForm.getDriverId()).getData();</span><br><span class="line">    <span class="keyword">if</span>(driverSet.getServiceStatus().intValue() == <span class="number">1</span>) {</span><br><span class="line">        <span class="keyword">return</span> locationFeignClient.updateDriverLocation(updateDriverLocationForm).getData();</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.NO_START_SERVICE);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-sou-suo-fu-jin-gua-he-jie-dan-de-si-ji">4、搜索附近适合接单的司机</span></h3><p>司机端的小程序开启接单服务后，开始实时上传司机的定位信息到redis的GEO缓存，前面乘客已经下单，现在我们就要查找附近适合接单的司机，如果有对应的司机，那就给司机发送新订单消息。</p>
<h4><span id="4-1-di-tu-wei-fu-wu-jie-kou">4.1、地图微服务接口</span></h4><h5><span id="4-1-1-locationcontroller">4.1.1、LocationController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "搜索附近满足条件的司机")</span></span><br><span class="line"><span class="meta">@PostMapping("/searchNearByDriver")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;List&lt;NearByDriverVo&gt;&gt; <span class="title function_">searchNearByDriver</span><span class="params">(<span class="meta">@RequestBody</span> SearchNearByDriverForm searchNearByDriverForm)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(locationService.searchNearByDriver(searchNearByDriverForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-2-locationservice">4.1.2、LocationService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;NearByDriverVo&gt; <span class="title function_">searchNearByDriver</span><span class="params">(SearchNearByDriverForm searchNearByDriverForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-3-locationserviceimpl">4.1.3、LocationServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DriverInfoFeignClient driverInfoFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;NearByDriverVo&gt; <span class="title function_">searchNearByDriver</span><span class="params">(SearchNearByDriverForm searchNearByDriverForm)</span> {</span><br><span class="line">    <span class="comment">// 搜索经纬度位置5公里以内的司机</span></span><br><span class="line">    <span class="comment">//定义经纬度点</span></span><br><span class="line">    <span class="type">Point</span> <span class="variable">point</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Point</span>(searchNearByDriverForm.getLongitude().doubleValue(), searchNearByDriverForm.getLatitude().doubleValue());</span><br><span class="line">    <span class="comment">//定义距离：5公里(系统配置)</span></span><br><span class="line">    <span class="type">Distance</span> <span class="variable">distance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Distance</span>(SystemConstant.NEARBY_DRIVER_RADIUS, RedisGeoCommands.DistanceUnit.KILOMETERS);</span><br><span class="line">    <span class="comment">//定义以point点为中心，distance为距离这么一个范围</span></span><br><span class="line">    <span class="type">Circle</span> <span class="variable">circle</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Circle</span>(point, distance);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义GEO参数</span></span><br><span class="line">    RedisGeoCommands.<span class="type">GeoRadiusCommandArgs</span> <span class="variable">args</span> <span class="operator">=</span> RedisGeoCommands.GeoRadiusCommandArgs.newGeoRadiusArgs()</span><br><span class="line">            .includeDistance() <span class="comment">//包含距离</span></span><br><span class="line">            .includeCoordinates() <span class="comment">//包含坐标</span></span><br><span class="line">            .sortAscending(); <span class="comment">//排序：升序</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.GEORADIUS获取附近范围内的信息</span></span><br><span class="line">    GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; result = <span class="built_in">this</span>.redisTemplate.opsForGeo().radius(RedisConstant.DRIVER_GEO_LOCATION, circle, args);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.收集信息，存入list</span></span><br><span class="line">    List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; content = result.getContent();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.返回计算后的信息</span></span><br><span class="line">    List&lt;NearByDriverVo&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">    <span class="keyword">if</span>(!CollectionUtils.isEmpty(content)) {</span><br><span class="line">        Iterator&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; iterator = content.iterator();</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) {</span><br><span class="line">            GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; item = iterator.next();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//司机id</span></span><br><span class="line">            <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> Long.parseLong(item.getContent().getName());</span><br><span class="line">            <span class="comment">//当前距离</span></span><br><span class="line">            <span class="type">BigDecimal</span> <span class="variable">currentDistance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(item.getDistance().getValue()).setScale(<span class="number">2</span>, RoundingMode.HALF_UP);</span><br><span class="line">            log.info(<span class="string">"司机：{}，距离：{}"</span>,driverId, item.getDistance().getValue());</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取司机接单设置参数</span></span><br><span class="line">            <span class="type">DriverSet</span> <span class="variable">driverSet</span> <span class="operator">=</span> driverInfoFeignClient.getDriverSet(driverId).getData();</span><br><span class="line">            <span class="comment">//接单里程判断，acceptDistance==0：不限制，</span></span><br><span class="line">            <span class="keyword">if</span>(driverSet.getAcceptDistance().doubleValue() != <span class="number">0</span> &amp;&amp; driverSet.getAcceptDistance().subtract(currentDistance).doubleValue() &lt; <span class="number">0</span>) {</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">//订单里程判断，orderDistance==0：不限制</span></span><br><span class="line">            <span class="keyword">if</span>(driverSet.getOrderDistance().doubleValue() != <span class="number">0</span> &amp;&amp; driverSet.getOrderDistance().subtract(searchNearByDriverForm.getMileageDistance()).doubleValue() &lt; <span class="number">0</span>) {</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">//满足条件的附近司机信息</span></span><br><span class="line">            <span class="type">NearByDriverVo</span> <span class="variable">nearByDriverVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NearByDriverVo</span>();</span><br><span class="line">            nearByDriverVo.setDriverId(driverId);</span><br><span class="line">            nearByDriverVo.setDistance(currentDistance);</span><br><span class="line">            list.add(nearByDriverVo);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="4-2-feign-jie-kou">4.2、Feign接口</span></h4><h5><span id="4-2-1-locationfeignclient">4.2.1、LocationFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 搜索附近满足条件的司机</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> searchNearByDriverForm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping("/map/location/searchNearByDriver")</span></span><br><span class="line">Result&lt;List&lt;NearByDriverVo&gt;&gt; <span class="title function_">searchNearByDriver</span><span class="params">(<span class="meta">@RequestBody</span> SearchNearByDriverForm searchNearByDriverForm)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="4-3-jie-kou-ce-shi">4.3、接口测试</span></h4><p>1、swagger调用“实时更新司机位置信息”接口，更新司机位置信息</p>
<p>2、swagger调用“搜索附近适合接单的司机”接口，接口经纬度在5公里范围内</p>
<h2><span id="er-ren-wu-diao-du">二、任务调度</span></h2><p>前面乘客端已经下单了，附近的司机我们也能搜索了，接下来我们就要看怎么把这两件事给关联上？</p>
<p>乘客下单，搜索附近的司机，但是可能当时附近有司机，也有可能当时附近没有司机，乘客下单的一个等待时间为15分钟（15分钟后系统自动取消订单），那么下单与搜索司机怎么关联上呢？答案肯定是任务调度。</p>
<p>乘客下单了，然后启动一个任务调度，每隔1分钟执行一次搜索附近司机的任务调度，只要在15分钟内没有司机接单，那么就必须一直查找附近适合的司机，直到15分钟内有司机接单为止。任务调度搜索到满足条件的司机后，会在服务器端给司机建立一个临时队列（1分钟过期），把新订单数据放入队列，司机小程序端开启接单服务后，每隔几秒轮询获取临时队列里面的新订单数据，在小程序前端进行语音播报，司机即可进行抢单操作。</p>
<h3><span id="1-ding-shi-ren-wu-diao-du-kuang-jia">1、定时任务调度框架</span></h3><h4><span id="1-1-dan-ji">1.1、单机</span></h4><ul>
<li>Timer：这是 java 自带的 java.util.Timer 类，这个类允许你调度一个 java.util.TimerTask 任务。使用这种方式可以让你的程序按照某一个频度执行，但不能在指定时间运行。一般用的较少。</li>
<li>ScheduledExecutorService：也 jdk 自带的一个类；是基于线程池设计的定时任务类，每个调度任务都会分配到线程池中的一个线程去执行，也就是说，任务是并发执行，互不影响。</li>
<li>Spring Task：Spring3.0 以后自带的 task，配置简单功能较多，如果系统使用单机的话可以优先考虑spring定时器。</li>
</ul>
<h4><span id="1-2-fen-bu-shi">1.2、分布式</span></h4><ul>
<li>Quartz：Java事实上的定时任务标准。但Quartz关注点在于定时任务而非数据，并无一套根据数据处理而定制化的流程。虽然Quartz可以基于数据库实现作业的高可用，但缺少分布式并行调度的功能。</li>
<li>TBSchedule：阿里早期开源的分布式任务调度系统。代码略陈旧，使用timer而非线程池执行任务调度。众所周知，timer在处理异常状况时是有缺陷的。而且TBSchedule作业类型较为单一，只能是获取/处理数据一种模式。还有就是文档缺失比较严重。</li>
<li>elastic-job：当当开发的弹性分布式任务调度系统，功能丰富强大，采用zookeeper实现分布式协调，实现任务高可用以及分片，并且可以支持云开发。</li>
<li>Saturn：是唯品会自主研发的分布式的定时任务的调度平台，基于当当的elastic-job 版本1开发，并且可以很好的部署到docker容器上。</li>
<li>xxl-job: 是大众点评员工徐雪里于2015年发布的分布式任务调度平台，是一个轻量级分布式任务调度框架，其核心设计目标是开发迅速、学习简单、轻量级、易扩展，其在唯品会内部已经发部署350+个节点，每天任务调度4000多万次。同时，管理和统计也是它的亮点。使用案例 大众点评、易信(IM)、京东(电商系统)、360金融(金融系统)、易企秀、随行付(支付系统)、优信二手车。</li>
</ul>
<p>我们项目选择：XXL-JOB</p>
<h3><span id="2-fen-bu-shi-ren-wu-diao-du-ping-tai-xxl-job">2、分布式任务调度平台XXL-JOB</span></h3><p>官方文档：<a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/">https://www.xuxueli.com/xxl-job/</a></p>
<h4><span id="2-1-gai-shu">2.1、概述</span></h4><p>XXL-JOB是一个分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用。</p>
<h4><span id="2-2-te-xing-jin-liao-jie">2.2、特性（仅了解）</span></h4><ul>
<li>1、简单：支持通过Web页面对任务进行CRUD操作，操作简单，一分钟上手；</li>
<li>2、动态：支持动态修改任务状态、启动/停止任务，以及终止运行中任务，即时生效；</li>
<li>3、调度中心HA（中心式）：调度采用中心式设计，“调度中心”自研调度组件并支持集群部署，可保证调度中心HA；</li>
<li>4、执行器HA（分布式）：任务分布式执行，任务”执行器”支持集群部署，可保证任务执行HA；</li>
<li>5、注册中心: 执行器会周期性自动注册任务, 调度中心将会自动发现注册的任务并触发执行。同时，也支持手动录入执行器地址；</li>
<li>6、弹性扩容缩容：一旦有新执行器机器上线或者下线，下次调度时将会重新分配任务；</li>
<li>7、触发策略：提供丰富的任务触发策略，包括：Cron触发、固定间隔触发、固定延时触发、API（事件）触发、人工触发、父子任务触发；</li>
<li>8、调度过期策略：调度中心错过调度时间的补偿处理策略，包括：忽略、立即补偿触发一次等；</li>
<li>9、阻塞处理策略：调度过于密集执行器来不及处理时的处理策略，策略包括：单机串行（默认）、丢弃后续调度、覆盖之前调度；</li>
<li>10、任务超时控制：支持自定义任务超时时间，任务运行超时将会主动中断任务；</li>
<li>11、任务失败重试：支持自定义任务失败重试次数，当任务失败时将会按照预设的失败重试次数主动进行重试；其中分片任务支持分片粒度的失败重试；</li>
<li>12、任务失败告警；默认提供邮件方式失败告警，同时预留扩展接口，可方便的扩展短信、钉钉等告警方式；</li>
<li>13、路由策略：执行器集群部署时提供丰富的路由策略，包括：第一个、最后一个、轮询、随机、一致性HASH、最不经常使用、最近最久未使用、故障转移、忙碌转移等；</li>
<li>14、分片广播任务：执行器集群部署时，任务路由策略选择”分片广播”情况下，一次任务调度将会广播触发集群中所有执行器执行一次任务，可根据分片参数开发分片任务；</li>
<li>15、动态分片：分片广播任务以执行器为维度进行分片，支持动态扩容执行器集群从而动态增加分片数量，协同进行业务处理；在进行大数据量业务操作时可显著提升任务处理能力和速度。</li>
<li>16、故障转移：任务路由策略选择”故障转移”情况下，如果执行器集群中某一台机器故障，将会自动Failover切换到一台正常的执行器发送调度请求。</li>
<li>17、任务进度监控：支持实时监控任务进度；</li>
<li>18、Rolling实时日志：支持在线查看调度结果，并且支持以Rolling方式实时查看执行器输出的完整的执行日志；</li>
<li>19、GLUE：提供Web IDE，支持在线开发任务逻辑代码，动态发布，实时编译生效，省略部署上线的过程。支持30个版本的历史版本回溯。</li>
<li>20、脚本任务：支持以GLUE模式开发和运行脚本任务，包括Shell、Python、NodeJS、PHP、PowerShell等类型脚本;</li>
<li>21、命令行任务：原生提供通用命令行任务Handler（Bean任务，”CommandJobHandler”）；业务方只需要提供命令行即可；</li>
<li>22、任务依赖：支持配置子任务依赖，当父任务执行结束且执行成功后将会主动触发一次子任务的执行, 多个子任务用逗号分隔；</li>
<li>23、一致性：“调度中心”通过DB锁保证集群分布式调度的一致性, 一次任务调度只会触发一次执行；</li>
<li>24、自定义任务参数：支持在线配置调度任务入参，即时生效；</li>
<li>25、调度线程池：调度系统多线程触发调度运行，确保调度精确执行，不被堵塞；</li>
<li>26、数据加密：调度中心和执行器之间的通讯进行数据加密，提升调度信息安全性；</li>
<li>27、邮件报警：任务失败时支持邮件报警，支持配置多邮件地址群发报警邮件；</li>
<li>28、推送maven中央仓库: 将会把最新稳定版推送到maven中央仓库, 方便用户接入和使用;</li>
<li>29、运行报表：支持实时查看运行数据，如任务数量、调度次数、执行器数量等；以及调度报表，如调度日期分布图，调度成功分布图等；</li>
<li>30、全异步：任务调度流程全异步化设计实现，如异步调度、异步运行、异步回调等，有效对密集调度进行流量削峰，理论上支持任意时长任务的运行；</li>
<li>31、跨语言：调度中心与执行器提供语言无关的 RESTful API 服务，第三方任意语言可据此对接调度中心或者实现执行器。除此之外，还提供了 “多任务模式”和“httpJobHandler”等其他跨语言方案；</li>
<li>32、国际化：调度中心支持国际化设置，提供中文、英文两种可选语言，默认为中文；</li>
<li>33、容器化：提供官方docker镜像，并实时更新推送dockerhub，进一步实现产品开箱即用；</li>
<li>34、线程池隔离：调度线程池进行隔离拆分，慢任务自动降级进入”Slow”线程池，避免耗尽调度线程，提高系统稳定性；</li>
<li>35、用户管理：支持在线管理系统用户，存在管理员、普通用户两种角色；</li>
<li>36、权限控制：执行器维度进行权限控制，管理员拥有全量权限，普通用户需要分配执行器权限后才允许相关操作；</li>
</ul>
<h4><span id="2-3-xia-zai">2.3、下载</span></h4><p><strong>文档地址</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/">中文文档</a></li>
<li><a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/en/">English Documentation</a></li>
</ul>
<p><strong>源码仓库地址</strong></p>
<table>
<thead>
<tr>
<th>源码仓库地址</th>
<th>Release Download</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://github.com/xuxueli/xxl-job">https://github.com/xuxueli/xxl-job</a></td>
<td><a target="_blank" rel="noopener" href="https://github.com/xuxueli/xxl-job/releases">Download</a></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="http://gitee.com/xuxueli0323/xxl-job">http://gitee.com/xuxueli0323/xxl-job</a></td>
<td><a target="_blank" rel="noopener" href="http://gitee.com/xuxueli0323/xxl-job/releases">Download</a></td>
</tr>
</tbody></table>
<p><strong>中央仓库地址</strong></p>
<p>当前项目使用版本：2.4.1-SNAPSHOT</p>
<p>注：为了统一版本，已统一下载，在资料中获取：xxl-job-master.zip</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>${最新稳定版本}<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-4-kuai-su-ru-men">2.4、快速入门</span></h4><h5><span id="2-4-1-dao-ru-xiang-mu-dao-idea">2.4.1、导入项目到idea</span></h5><p>解压：xxl-job-master.zip，导入idea，如图：</p>
<p><img src="/2024/09/26/projection-daijia/1690169616781.png" alt="69016961678"></p>
<p>项目结构说明：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">xxl-job-master：</span></span><br><span class="line">    <span class="string">xxl-job-admin：调度中心</span></span><br><span class="line">    <span class="string">xxl-job-core：公共依赖</span></span><br><span class="line">    <span class="string">xxl-job-executor-samples：执行器Sample示例（选择合适的版本执行器，可直接使用，也可以参考其并将现有项目改造成执行器）</span></span><br><span class="line">        <span class="string">xxl-job-executor-sample-springboot：Springboot版本，通过Springboot管理执行器，推荐这种方式；</span></span><br><span class="line">        <span class="string">xxl-job-executor-sample-frameless：无框架版本；</span></span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-4-2-chu-shi-hua-diao-du-shu-ju-ku">2.4.2、初始化“调度数据库”</span></h5><p>获取 “调度数据库初始化SQL脚本” 并执行即可。</p>
<p>调度数据库初始化SQL脚本” 位置为：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/xxl-job-master/doc/db/tables_xxl_job.sql</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-4-3-bu-shu-diao-du-zhong-xin">2.4.3、部署”调度中心“</span></h5><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">调度中心项目：xxl-job-admin</span><br><span class="line">作用：统一管理任务调度平台上调度任务，负责触发调度执行，并且提供任务管理平台。     </span><br></pre></td></tr></tbody></table></figure>

<h6><span id="bu-zou-yi-xiu-gai-shu-ju-ku-lian-jie">步骤一：修改数据库连接</span></h6><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### xxl-job, datasource</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/xxl_job?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br></pre></td></tr></tbody></table></figure>

<h6><span id="bu-zou-er-qi-dong-xiang-mu">步骤二：启动项目</span></h6><p>调度中心访问地址：<a target="_blank" rel="noopener" href="http://localhost:8080/xxl-job-admin">http://localhost:8080/xxl-job-admin</a> </p>
<p>默认登录账号 “admin/123456”, 登录后运行界面如下图所示：</p>
<p><img src="/2024/09/26/projection-daijia/1690178209611.png" alt="69017820961"></p>
<h6><span id="bu-zou-san-diao-du-zhong-xin-ji-qun-bu-shu-ke-xuan">步骤三：调度中心集群部署（可选）</span></h6><p>调度中心支持集群部署，提升调度系统容灾和可用性。</p>
<p>调度中心集群部署时，几点要求和建议：</p>
<ul>
<li>DB配置保持一致；</li>
<li>集群机器时钟保持一致（单机集群忽视）；</li>
<li>建议：推荐通过nginx为调度中心集群做负载均衡，分配域名。调度中心访问、执行器回调配置、调用API服务等操作均通过该域名进行。</li>
</ul>
<h5><span id="2-4-4-pei-zhi-bu-shu-zhi-xing-qi-xiang-mu">2.4.4、配置部署“执行器项目”</span></h5><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">“执行器”项目：xxl-job-executor-sample-springboot (提供多种版本执行器供选择，现以 springboot 版本为例，可直接使用，也可以参考其并将现有项目改造成执行器)</span><br><span class="line">作用：负责接收“调度中心”的调度并执行；可直接部署执行器，也可以将执行器集成到现有业务项目中。</span><br></pre></td></tr></tbody></table></figure>

<h6><span id="bu-zou-yi-maven-yi-lai">步骤一：maven依赖</span></h6><p>确认pom文件中引入了 “xxl-job-core” 的maven依赖；</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- xxl-job-core --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h6><span id="bu-zou-er-zhi-xing-qi-pei-zhi">步骤二：执行器配置</span></h6><p>执行器配置，配置内容说明：</p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 调度中心部署根地址 [选填]：如调度中心集群部署存在多个地址则用逗号分隔。执行器将会使用该地址进行"执行器心跳注册"和"任务结果回调"；为空则关闭自动注册；</span></span><br><span class="line"><span class="attr">xxl.job.admin.addresses</span>=<span class="string">http://127.0.0.1:8080/xxl-job-admin</span></span><br><span class="line"><span class="comment">### 执行器通讯TOKEN [选填]：非空时启用；</span></span><br><span class="line"><span class="attr">xxl.job.accessToken</span>=<span class="string"></span></span><br><span class="line"><span class="comment">### 执行器AppName [选填]：执行器心跳注册分组依据；为空则关闭自动注册</span></span><br><span class="line"><span class="attr">xxl.job.executor.appname</span>=<span class="string">xxl-job-executor-sample</span></span><br><span class="line"><span class="comment">### 执行器注册 [选填]：优先使用该配置作为注册地址，为空时使用内嵌服务 ”IP:PORT“ 作为注册地址。从而更灵活的支持容器类型执行器动态IP和动态映射端口问题。</span></span><br><span class="line"><span class="attr">xxl.job.executor.address</span>=<span class="string"></span></span><br><span class="line"><span class="comment">### 执行器IP [选填]：默认为空表示自动获取IP，多网卡时可手动设置指定IP，该IP不会绑定Host仅作为通讯实用；地址信息用于 "执行器注册" 和 "调度中心请求并触发任务"；</span></span><br><span class="line"><span class="attr">xxl.job.executor.ip</span>=<span class="string"></span></span><br><span class="line"><span class="comment">### 执行器端口号 [选填]：小于等于0则自动获取；默认端口为9999，单机部署多个执行器时，注意要配置不同执行器端口；</span></span><br><span class="line"><span class="attr">xxl.job.executor.port</span>=<span class="string">9999</span></span><br><span class="line"><span class="comment">### 执行器运行日志文件存储磁盘路径 [选填] ：需要对该路径拥有读写权限；为空则使用默认路径；</span></span><br><span class="line"><span class="attr">xxl.job.executor.logpath</span>=<span class="string">/data/applogs/xxl-job/jobhandler</span></span><br><span class="line"><span class="comment">### 执行器日志文件保存天数 [选填] ： 过期日志自动清理, 限制值大于等于3时生效; 否则, 如-1, 关闭自动清理功能；</span></span><br><span class="line"><span class="attr">xxl.job.executor.logretentiondays</span>=<span class="string">30</span></span><br></pre></td></tr></tbody></table></figure>

<h6><span id="bu-zou-san-zhi-xing-qi-zu-jian-pei-zhi">步骤三：执行器组件配置</span></h6><p>执行器组件，配置内容说明：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xxl.job.executor.core.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.executor.impl.XxlJobSpringExecutor;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * xxl-job config</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xuxueli 2017-04-28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XxlJobConfig</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(XxlJobConfig.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${xxl.job.admin.addresses}")</span></span><br><span class="line">    <span class="keyword">private</span> String adminAddresses;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${xxl.job.accessToken}")</span></span><br><span class="line">    <span class="keyword">private</span> String accessToken;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${xxl.job.executor.appname}")</span></span><br><span class="line">    <span class="keyword">private</span> String appname;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${xxl.job.executor.address}")</span></span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${xxl.job.executor.ip}")</span></span><br><span class="line">    <span class="keyword">private</span> String ip;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${xxl.job.executor.port}")</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${xxl.job.executor.logpath}")</span></span><br><span class="line">    <span class="keyword">private</span> String logPath;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${xxl.job.executor.logretentiondays}")</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> logRetentionDays;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> XxlJobSpringExecutor <span class="title function_">xxlJobExecutor</span><span class="params">()</span> {</span><br><span class="line">        logger.info(<span class="string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init."</span>);</span><br><span class="line">        <span class="type">XxlJobSpringExecutor</span> <span class="variable">xxlJobSpringExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxlJobSpringExecutor</span>();</span><br><span class="line">        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);</span><br><span class="line">        xxlJobSpringExecutor.setAppname(appname);</span><br><span class="line">        xxlJobSpringExecutor.setAddress(address);</span><br><span class="line">        xxlJobSpringExecutor.setIp(ip);</span><br><span class="line">        xxlJobSpringExecutor.setPort(port);</span><br><span class="line">        xxlJobSpringExecutor.setAccessToken(accessToken);</span><br><span class="line">        xxlJobSpringExecutor.setLogPath(logPath);</span><br><span class="line">        xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> xxlJobSpringExecutor;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 针对多网卡、容器内部署等情况，可借助 "spring-cloud-commons" 提供的 "InetUtils" 组件灵活定制注册IP；</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *      1、引入依赖：</span></span><br><span class="line"><span class="comment">     *          &lt;dependency&gt;</span></span><br><span class="line"><span class="comment">     *             &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">     *             &lt;artifactId&gt;spring-cloud-commons&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">     *             &lt;version&gt;${version}&lt;/version&gt;</span></span><br><span class="line"><span class="comment">     *         &lt;/dependency&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *      2、配置文件，或者容器启动变量</span></span><br><span class="line"><span class="comment">     *          spring.cloud.inetutils.preferred-networks: 'xxx.xxx.xxx.'</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *      3、获取IP</span></span><br><span class="line"><span class="comment">     *          String ip_ = inetUtils.findFirstNonLoopbackHostInfo().getIpAddress();</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h6><span id="bu-zou-si-qi-dong-zhi-xing-qi-xiang-mu">步骤四：启动执行器项目：</span></h6><p>启动：xxl-job-executor-sample-springboot</p>
<h6><span id="bu-zou-wu-zhi-xing-qi-ji-qun-ke-xuan">步骤五：执行器集群（可选）：</span></h6><p>执行器支持集群部署，提升调度系统可用性，同时提升任务处理能力。</p>
<p>执行器集群部署时，几点要求和建议：</p>
<ul>
<li>执行器回调地址（xxl.job.admin.addresses）需要保持一致；执行器根据该配置进行执行器自动注册等操作。</li>
<li>同一个执行器集群内AppName（xxl.job.executor.appname）需要保持一致；调度中心根据该配置动态发现不同集群的在线执行器列表。</li>
</ul>
<h5><span id="2-4-5-di-yi-ge-ren-wu-diao-du">2.4.5、第一个任务调度</span></h5><h6><span id="bu-zou-yi-pei-zhi-zhi-xing-qi">步骤一：配置执行器</span></h6><p><img src="/2024/09/26/projection-daijia/1690181928710.png" alt="69018192871"></p>
<p>上面我们启动了xxl-job-executor-sample-springboot 执行器项目，当前已注册上来，我们执行使用改执行器。</p>
<p>执行器属性说明：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">AppName: 是每个执行器集群的唯一标示AppName, 执行器会周期性以AppName为对象进行自动注册。可通过该配置自动发现注册成功的执行器, 供任务调度时使用;</span><br><span class="line">名称: 执行器的名称, 因为AppName限制字母数字等组成,可读性不强, 名称为了提高执行器的可读性;排序: 执行器的排序, 系统中需要执行器的地方,如任务新增, 将会按照该排序读取可用的执行器列表;</span><br><span class="line">注册方式：调度中心获取执行器地址的方式；    </span><br><span class="line">	自动注册：执行器自动进行执行器注册，调度中心通过底层注册表可以动态发现执行器机器地址；    </span><br><span class="line">	手动录入：人工手动录入执行器的地址信息，多地址逗号分隔，供调度中心使用；</span><br><span class="line">机器地址："注册方式"为"手动录入"时有效，支持人工维护执行器的地址信息；</span><br></pre></td></tr></tbody></table></figure>

<h6><span id="bu-zou-er-xin-jian-ren-wu">步骤二：新建任务：</span></h6><p>登录调度中心：<a target="_blank" rel="noopener" href="http://localhost:8080/xxl-job-admin">http://localhost:8080/xxl-job-admin</a> </p>
<p>默认登录账号 “admin/123456”</p>
<p>任务管理 ==》 新增</p>
<p><img src="/2024/09/26/projection-daijia/1690180067623.png" alt="69018006762"></p>
<p>添加成功，如图：</p>
<p><img src="/2024/09/26/projection-daijia/1690180127960.png" alt="69018012796"></p>
<h6><span id="bu-zou-san-zhi-xing-qi-xiang-mu-kai-fa-job-fang-fa">步骤三：执行器项目开发job方法</span></h6><p>使用xxl-job-executor-sample-springboot项目job实例，与步骤二的JobHandler配置一致</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1、简单任务示例（Bean模式）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@XxlJob("demoJobHandler")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">demoJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">    XxlJobHelper.log(<span class="string">"XXL-JOB, Hello World."</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) {</span><br><span class="line">        XxlJobHelper.log(<span class="string">"beat at:"</span> + i);</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// default success</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h6><span id="bu-zou-si-qi-dong-ren-wu">步骤四：启动任务</span></h6><p><img src="/2024/09/26/projection-daijia/1690180400846.png" alt="69018040084"></p>
<p>任务列表状态改变，如图：</p>
<p><img src="/2024/09/26/projection-daijia/1690180464140.png" alt="69018046414"></p>
<p>设置断点，执行结果：</p>
<p><img src="/2024/09/26/projection-daijia/1690181665504.png" alt="69018166550"></p>
<p>查看调度日志：</p>
<p><img src="/2024/09/26/projection-daijia/1690182677356.png" alt="69018267735"></p>
<h3><span id="3-ji-cheng-xxl-job">3、集成XXL-JOB</span></h3><p>我们使用单独的一个微服务模块service-dispatch集成XXL-JOB执行器</p>
<h4><span id="3-1-maven-yi-lai">3.1、maven依赖</span></h4><p>已引入，就忽略</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- xxl-job-core --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>注：当前远程maven仓库只更新到2.4.0，也可以把上面项目包安装到本地仓库，对于当前项目使用这两个版本无差异</p>
<h4><span id="3-2-zhi-xing-qi-pei-zhi">3.2、执行器配置</span></h4><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xxl:</span></span><br><span class="line">  <span class="attr">job:</span></span><br><span class="line">    <span class="attr">admin:</span></span><br><span class="line">      <span class="comment"># 调度中心部署跟地址 [选填]：如调度中心集群部署存在多个地址则用逗号分隔。执行器将会使用该地址进行"执行器心跳注册"和"任务结果回调"；为空则关闭自动注册</span></span><br><span class="line">      <span class="attr">addresses:</span> <span class="string">http://localhost:8080/xxl-job-admin</span></span><br><span class="line">      <span class="comment"># 执行器通讯TOKEN [选填]：非空时启用</span></span><br><span class="line">    <span class="attr">accessToken:</span> </span><br><span class="line"></span><br><span class="line">    <span class="attr">executor:</span></span><br><span class="line">      <span class="comment"># 执行器AppName [选填]：执行器心跳注册分组依据；为空则关闭自动注册</span></span><br><span class="line">      <span class="attr">appname:</span> <span class="string">xxl-job-executor-sample</span></span><br><span class="line">      <span class="comment"># 执行器注册 [选填]：优先使用该配置作为注册地址，为空时使用内嵌服务 ”IP:PORT“ 作为注册地址。从而更灵活的支持容器类型执行器动态IP和动态映射端口问题。</span></span><br><span class="line">      <span class="attr">address:</span></span><br><span class="line">      <span class="comment"># 执行器IP [选填]：默认为空表示自动获取IP，多网卡时可手动设置指定IP，该IP不会绑定Host仅作为通讯实用；地址信息用于 "执行器注册" 和 "调度中心请求并触发任务"；</span></span><br><span class="line">      <span class="attr">ip:</span></span><br><span class="line">      <span class="comment"># 执行器端口号 [选填]：小于等于0则自动获取；默认端口为9999，单机部署多个执行器时，注意要配置不同执行器端口；</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9999</span></span><br><span class="line">      <span class="comment"># 执行器运行日志文件存储磁盘路径 [选填] ：需要对该路径拥有读写权限；为空则使用默认路径；</span></span><br><span class="line">      <span class="attr">logpath:</span> <span class="string">/data/applogs/xxl-job/jobhandler</span></span><br><span class="line">      <span class="comment"># 执行器日志文件保存天数 [选填] ： 过期日志自动清理, 限制值大于等于3时生效; 否则, 如-1, 关闭自动清理功能；</span></span><br><span class="line">      <span class="attr">logretentiondays:</span> <span class="number">30</span></span><br></pre></td></tr></tbody></table></figure>

<p>注：如果已配置，忽略</p>
<h4><span id="3-3-zhi-xing-qi-zu-jian-pei-zhi">3.3、执行器组件配置</span></h4><p>将xxl-job-executor-sample-springboot 执行器项目的XxlJobConfig类复制过来</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.dispatch.xxl.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.executor.impl.XxlJobSpringExecutor;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XxlJobConfig</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(XxlJobConfig.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${xxl.job.admin.addresses}")</span></span><br><span class="line">    <span class="keyword">private</span> String adminAddresses;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${xxl.job.accessToken}")</span></span><br><span class="line">    <span class="keyword">private</span> String accessToken;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${xxl.job.executor.appname}")</span></span><br><span class="line">    <span class="keyword">private</span> String appname;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${xxl.job.executor.address}")</span></span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${xxl.job.executor.ip}")</span></span><br><span class="line">    <span class="keyword">private</span> String ip;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${xxl.job.executor.port}")</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${xxl.job.executor.logpath}")</span></span><br><span class="line">    <span class="keyword">private</span> String logPath;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${xxl.job.executor.logretentiondays}")</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> logRetentionDays;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> XxlJobSpringExecutor <span class="title function_">xxlJobExecutor</span><span class="params">()</span> {</span><br><span class="line">        logger.info(<span class="string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init."</span>);</span><br><span class="line">        <span class="type">XxlJobSpringExecutor</span> <span class="variable">xxlJobSpringExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxlJobSpringExecutor</span>();</span><br><span class="line">        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);</span><br><span class="line">        xxlJobSpringExecutor.setAppname(appname);</span><br><span class="line">        xxlJobSpringExecutor.setAddress(address);</span><br><span class="line">        xxlJobSpringExecutor.setIp(ip);</span><br><span class="line">        xxlJobSpringExecutor.setPort(port);</span><br><span class="line">        xxlJobSpringExecutor.setAccessToken(accessToken);</span><br><span class="line">        xxlJobSpringExecutor.setLogPath(logPath);</span><br><span class="line">        xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> xxlJobSpringExecutor;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 针对多网卡、容器内部署等情况，可借助 "spring-cloud-commons" 提供的 "InetUtils" 组件灵活定制注册IP；</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *      1、引入依赖：</span></span><br><span class="line"><span class="comment">     *          &lt;dependency&gt;</span></span><br><span class="line"><span class="comment">     *             &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">     *             &lt;artifactId&gt;spring-cloud-commons&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">     *             &lt;version&gt;${version}&lt;/version&gt;</span></span><br><span class="line"><span class="comment">     *         &lt;/dependency&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *      2、配置文件，或者容器启动变量</span></span><br><span class="line"><span class="comment">     *          spring.cloud.inetutils.preferred-networks: 'xxx.xxx.xxx.'</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *      3、获取IP</span></span><br><span class="line"><span class="comment">     *          String ip_ = inetUtils.findFirstNonLoopbackHostInfo().getIpAddress();</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>到处，我们已经将XXL-JOB集成到项目中了</p>
<h4><span id="3-4-ce-shi-ren-wu">3.4、测试任务</span></h4><p>编写测试任务job方法</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.dispatch.xxl.job;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.handler.annotation.XxlJob;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DispatchJobHandler</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@XxlJob("firstJobHandler")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">firstJobHandler</span><span class="params">()</span> {</span><br><span class="line">        log.info(<span class="string">"xxl-job项目集成测试"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在调度中心配置任务</p>
<p><img src="/2024/09/26/projection-daijia/1690185051215.png" alt="69018505121"></p>
<p>启动任务，测试</p>
<h3><span id="4-feng-zhuang-xxl-job-ke-hu-duan">4、封装XXL-JOB客户端</span></h3><p>乘客下单就要开启任务调度，指定只能动态创建XXL-JOB任务，因此我们要封装XXL-JOB客户端，通过接口的形式添加并启动任务。</p>
<h4><span id="4-1-gai-zao-xxl-job-fu-wu-qi-duan-jie-kou">4.1、改造XXL-JOB服务器端接口</span></h4><p>在xxl-job-admin模块，添加改造后的api接口</p>
<p>在JobInfoController类末尾添加方法，如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*------------------自定义方法----------------------  */</span></span><br><span class="line"><span class="meta">@RequestMapping("/addJob")</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PermissionLimit(limit = false)</span></span><br><span class="line"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title function_">addJobInfo</span><span class="params">(<span class="meta">@RequestBody</span> XxlJobInfo jobInfo)</span> {</span><br><span class="line">   <span class="keyword">return</span> xxlJobService.add(jobInfo);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping("/updateJob")</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PermissionLimit(limit = false)</span></span><br><span class="line"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title function_">updateJob</span><span class="params">(<span class="meta">@RequestBody</span> XxlJobInfo jobInfo)</span> {</span><br><span class="line">   <span class="keyword">return</span> xxlJobService.update(jobInfo);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping("/removeJob")</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PermissionLimit(limit = false)</span></span><br><span class="line"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title function_">removeJob</span><span class="params">(<span class="meta">@RequestBody</span> XxlJobInfo jobInfo)</span> {</span><br><span class="line">   <span class="keyword">return</span> xxlJobService.remove(jobInfo.getId());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping("/stopJob")</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PermissionLimit(limit = false)</span></span><br><span class="line"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title function_">pauseJob</span><span class="params">(<span class="meta">@RequestBody</span> XxlJobInfo jobInfo)</span> {</span><br><span class="line">   <span class="keyword">return</span> xxlJobService.stop(jobInfo.getId());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping("/startJob")</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PermissionLimit(limit = false)</span></span><br><span class="line"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title function_">startJob</span><span class="params">(<span class="meta">@RequestBody</span> XxlJobInfo jobInfo)</span> {</span><br><span class="line">   <span class="keyword">return</span> xxlJobService.start(jobInfo.getId());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping("/addAndStartJob")</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@PermissionLimit(limit = false)</span></span><br><span class="line"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title function_">addAndStartJob</span><span class="params">(<span class="meta">@RequestBody</span> XxlJobInfo jobInfo)</span> {</span><br><span class="line">   ReturnT&lt;String&gt; result = xxlJobService.add(jobInfo);</span><br><span class="line">   <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> Integer.valueOf(result.getContent());</span><br><span class="line">   xxlJobService.start(id);</span><br><span class="line">   <span class="comment">//立即执行一次</span></span><br><span class="line">   JobTriggerPoolHelper.trigger(id, TriggerTypeEnum.MANUAL, -<span class="number">1</span>, <span class="literal">null</span>, jobInfo.getExecutorParam(), <span class="string">""</span>);</span><br><span class="line">   <span class="keyword">return</span> result;</span><br><span class="line">}</span><br><span class="line"><span class="comment">/*------------------自定义方法----------------------  */</span></span><br></pre></td></tr></tbody></table></figure>

<p>说明：排除登录校验（@PermissionLimit(limit = false)）</p>
<h4><span id="4-2-pei-zhi-jie-kou-di-zhi">4.2、配置接口地址</span></h4><p>xxl完整配置，多加了client的配置</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xxl:</span></span><br><span class="line">  <span class="attr">job:</span></span><br><span class="line">    <span class="attr">admin:</span></span><br><span class="line">      <span class="comment"># 调度中心部署跟地址 [选填]：如调度中心集群部署存在多个地址则用逗号分隔。执行器将会使用该地址进行"执行器心跳注册"和"任务结果回调"；为空则关闭自动注册</span></span><br><span class="line">      <span class="attr">addresses:</span> <span class="string">http://139.198.30.131:8080/xxl-job-admin</span></span><br><span class="line">      <span class="comment"># addresses: http://localhost:8080/xxl-job-admin</span></span><br><span class="line">      <span class="comment"># 执行器通讯TOKEN [选填]：非空时启用</span></span><br><span class="line">    <span class="attr">accessToken:</span> </span><br><span class="line"></span><br><span class="line">    <span class="attr">executor:</span></span><br><span class="line">      <span class="comment"># 执行器AppName [选填]：执行器心跳注册分组依据；为空则关闭自动注册</span></span><br><span class="line">      <span class="attr">appname:</span> <span class="string">xxl-job-executor-sample</span></span><br><span class="line">      <span class="comment"># 执行器注册 [选填]：优先使用该配置作为注册地址，为空时使用内嵌服务 ”IP:PORT“ 作为注册地址。从而更灵活的支持容器类型执行器动态IP和动态映射端口问题。</span></span><br><span class="line">      <span class="attr">address:</span></span><br><span class="line">      <span class="comment"># 执行器IP [选填]：默认为空表示自动获取IP，多网卡时可手动设置指定IP，该IP不会绑定Host仅作为通讯实用；地址信息用于 "执行器注册" 和 "调度中心请求并触发任务"；</span></span><br><span class="line">      <span class="attr">ip:</span></span><br><span class="line">      <span class="comment"># 执行器端口号 [选填]：小于等于0则自动获取；默认端口为9999，单机部署多个执行器时，注意要配置不同执行器端口；</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9999</span></span><br><span class="line">      <span class="comment"># 执行器运行日志文件存储磁盘路径 [选填] ：需要对该路径拥有读写权限；为空则使用默认路径；</span></span><br><span class="line">      <span class="attr">logpath:</span> <span class="string">/data/applogs/xxl-job/jobhandler</span></span><br><span class="line">      <span class="comment"># 执行器日志文件保存天数 [选填] ： 过期日志自动清理, 限制值大于等于3时生效; 否则, 如-1, 关闭自动清理功能；</span></span><br><span class="line">      <span class="attr">logretentiondays:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">client:</span></span><br><span class="line">      <span class="attr">jobGroupId:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">addUrl:</span> <span class="string">${xxl.job.admin.addresses}/jobinfo/addJob</span></span><br><span class="line">      <span class="attr">removeUrl:</span> <span class="string">${xxl.job.admin.addresses}/jobinfo/removeJob</span></span><br><span class="line">      <span class="attr">startJobUrl:</span> <span class="string">${xxl.job.admin.addresses}/jobinfo/startJob</span></span><br><span class="line">      <span class="attr">stopJobUrl:</span> <span class="string">${xxl.job.admin.addresses}/jobinfo/stopJob</span></span><br><span class="line">      <span class="attr">addAndStartUrl:</span> <span class="string">${xxl.job.admin.addresses}/jobinfo/addAndStartJob</span></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="4-3-xxljobclientconfig">4.3、XxlJobClientConfig</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.dispatch.xxl.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = "xxl.job.client")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XxlJobClientConfig</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer jobGroupId;</span><br><span class="line">    <span class="keyword">private</span> String addUrl;</span><br><span class="line">    <span class="keyword">private</span> String removeUrl;</span><br><span class="line">    <span class="keyword">private</span> String startJobUrl;</span><br><span class="line">    <span class="keyword">private</span> String stopJobUrl;</span><br><span class="line">    <span class="keyword">private</span> String addAndStartUrl;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="4-4-xxljobclient">4.4、XxlJobClient</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.dispatch.xxl.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.common.execption.GuiguException;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.common.result.ResultCodeEnum;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.dispatch.xxl.config.XxlJobClientConfig;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.model.entity.dispatch.XxlJobInfo;</span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * https://dandelioncloud.cn/article/details/1598865461087518722</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XxlJobClient</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> XxlJobClientConfig xxlJobClientConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">addJob</span><span class="params">(String executorHandler, String param, String corn, String desc)</span>{</span><br><span class="line">        <span class="type">XxlJobInfo</span> <span class="variable">xxlJobInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxlJobInfo</span>();</span><br><span class="line">        xxlJobInfo.setJobGroup(xxlJobClientConfig.getJobGroupId());</span><br><span class="line">        xxlJobInfo.setJobDesc(desc);</span><br><span class="line">        xxlJobInfo.setAuthor(<span class="string">"qy"</span>);</span><br><span class="line">        xxlJobInfo.setScheduleType(<span class="string">"CRON"</span>);</span><br><span class="line">        xxlJobInfo.setScheduleConf(corn);</span><br><span class="line">        xxlJobInfo.setGlueType(<span class="string">"BEAN"</span>);</span><br><span class="line">        xxlJobInfo.setExecutorHandler(executorHandler);</span><br><span class="line">        xxlJobInfo.setExecutorParam(param);</span><br><span class="line">        xxlJobInfo.setExecutorRouteStrategy(<span class="string">"FIRST"</span>);</span><br><span class="line">        xxlJobInfo.setExecutorBlockStrategy(<span class="string">"SERIAL_EXECUTION"</span>);</span><br><span class="line">        xxlJobInfo.setMisfireStrategy(<span class="string">"FIRE_ONCE_NOW"</span>);</span><br><span class="line">        xxlJobInfo.setExecutorTimeout(<span class="number">0</span>);</span><br><span class="line">        xxlJobInfo.setExecutorFailRetryCount(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        headers.setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">        HttpEntity&lt;XxlJobInfo&gt; request = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(xxlJobInfo, headers);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> xxlJobClientConfig.getAddUrl();</span><br><span class="line">        ResponseEntity&lt;JSONObject&gt; response = restTemplate.postForEntity(url, request, JSONObject.class);</span><br><span class="line">        <span class="keyword">if</span>(response.getStatusCode().value() == <span class="number">200</span> &amp;&amp; response.getBody().getIntValue(<span class="string">"code"</span>) == <span class="number">200</span>) {</span><br><span class="line">            log.info(<span class="string">"增加xxl执行任务成功,返回信息:{}"</span>, response.getBody().toJSONString());</span><br><span class="line">            <span class="comment">//content为任务id</span></span><br><span class="line">            <span class="keyword">return</span> response.getBody().getLong(<span class="string">"content"</span>);</span><br><span class="line">        }</span><br><span class="line">        log.info(<span class="string">"调用xxl增加执行任务失败:{}"</span>, response.getBody().toJSONString());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.XXL_JOB_ERROR);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">startJob</span><span class="params">(Long jobId)</span> {</span><br><span class="line">        <span class="type">XxlJobInfo</span> <span class="variable">xxlJobInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxlJobInfo</span>();</span><br><span class="line">        xxlJobInfo.setId(jobId.intValue());</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        headers.setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">        HttpEntity&lt;XxlJobInfo&gt; request = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(xxlJobInfo, headers);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> xxlJobClientConfig.getStartJobUrl();</span><br><span class="line">        ResponseEntity&lt;JSONObject&gt; response = restTemplate.postForEntity(url, request, JSONObject.class);</span><br><span class="line">        <span class="keyword">if</span>(response.getStatusCode().value() == <span class="number">200</span> &amp;&amp; response.getBody().getIntValue(<span class="string">"code"</span>) == <span class="number">200</span>) {</span><br><span class="line">            log.info(<span class="string">"启动xxl执行任务成功:{},返回信息:{}"</span>, jobId, response.getBody().toJSONString());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line">        log.info(<span class="string">"启动xxl执行任务失败:{},返回信息:{}"</span>, jobId, response.getBody().toJSONString());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.XXL_JOB_ERROR);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">stopJob</span><span class="params">(Long jobId)</span> {</span><br><span class="line">        <span class="type">XxlJobInfo</span> <span class="variable">xxlJobInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxlJobInfo</span>();</span><br><span class="line">        xxlJobInfo.setId(jobId.intValue());</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        headers.setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">        HttpEntity&lt;XxlJobInfo&gt; request = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(xxlJobInfo, headers);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> xxlJobClientConfig.getStopJobUrl();</span><br><span class="line">        ResponseEntity&lt;JSONObject&gt; response = restTemplate.postForEntity(url, request, JSONObject.class);</span><br><span class="line">        <span class="keyword">if</span>(response.getStatusCode().value() == <span class="number">200</span> &amp;&amp; response.getBody().getIntValue(<span class="string">"code"</span>) == <span class="number">200</span>) {</span><br><span class="line">            log.info(<span class="string">"停止xxl执行任务成功:{},返回信息:{}"</span>, jobId, response.getBody().toJSONString());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line">        log.info(<span class="string">"停止xxl执行任务失败:{},返回信息:{}"</span>, jobId, response.getBody().toJSONString());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.XXL_JOB_ERROR);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">removeJob</span><span class="params">(Long jobId)</span> {</span><br><span class="line">        <span class="type">XxlJobInfo</span> <span class="variable">xxlJobInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxlJobInfo</span>();</span><br><span class="line">        xxlJobInfo.setId(jobId.intValue());</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        headers.setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">        HttpEntity&lt;XxlJobInfo&gt; request = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(xxlJobInfo, headers);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> xxlJobClientConfig.getRemoveUrl();</span><br><span class="line">        ResponseEntity&lt;JSONObject&gt; response = restTemplate.postForEntity(url, request, JSONObject.class);</span><br><span class="line">        <span class="keyword">if</span>(response.getStatusCode().value() == <span class="number">200</span> &amp;&amp; response.getBody().getIntValue(<span class="string">"code"</span>) == <span class="number">200</span>) {</span><br><span class="line">            log.info(<span class="string">"删除xxl执行任务成功:{},返回信息:{}"</span>, jobId, response.getBody().toJSONString());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line">        log.info(<span class="string">"删除xxl执行任务失败:{},返回信息:{}"</span>, jobId, response.getBody().toJSONString());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.XXL_JOB_ERROR);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Long <span class="title function_">addAndStart</span><span class="params">(String executorHandler, String param, String corn, String desc)</span> {</span><br><span class="line">        <span class="type">XxlJobInfo</span> <span class="variable">xxlJobInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxlJobInfo</span>();</span><br><span class="line">        xxlJobInfo.setJobGroup(xxlJobClientConfig.getJobGroupId());</span><br><span class="line">        xxlJobInfo.setJobDesc(desc);</span><br><span class="line">        xxlJobInfo.setAuthor(<span class="string">"qy"</span>);</span><br><span class="line">        xxlJobInfo.setScheduleType(<span class="string">"CRON"</span>);</span><br><span class="line">        xxlJobInfo.setScheduleConf(corn);</span><br><span class="line">        xxlJobInfo.setGlueType(<span class="string">"BEAN"</span>);</span><br><span class="line">        xxlJobInfo.setExecutorHandler(executorHandler);</span><br><span class="line">        xxlJobInfo.setExecutorParam(param);</span><br><span class="line">        xxlJobInfo.setExecutorRouteStrategy(<span class="string">"FIRST"</span>);</span><br><span class="line">        xxlJobInfo.setExecutorBlockStrategy(<span class="string">"SERIAL_EXECUTION"</span>);</span><br><span class="line">        xxlJobInfo.setMisfireStrategy(<span class="string">"FIRE_ONCE_NOW"</span>);</span><br><span class="line">        xxlJobInfo.setExecutorTimeout(<span class="number">0</span>);</span><br><span class="line">        xxlJobInfo.setExecutorFailRetryCount(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">        headers.setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">        HttpEntity&lt;XxlJobInfo&gt; request = <span class="keyword">new</span> <span class="title class_">HttpEntity</span>&lt;&gt;(xxlJobInfo, headers);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> xxlJobClientConfig.getAddAndStartUrl();</span><br><span class="line">        ResponseEntity&lt;JSONObject&gt; response = restTemplate.postForEntity(url, request, JSONObject.class);</span><br><span class="line">        <span class="keyword">if</span>(response.getStatusCode().value() == <span class="number">200</span> &amp;&amp; response.getBody().getIntValue(<span class="string">"code"</span>) == <span class="number">200</span>) {</span><br><span class="line">            log.info(<span class="string">"增加并开始执行xxl任务成功,返回信息:{}"</span>, response.getBody().toJSONString());</span><br><span class="line">            <span class="comment">//content为任务id</span></span><br><span class="line">            <span class="keyword">return</span> response.getBody().getLong(<span class="string">"content"</span>);</span><br><span class="line">        }</span><br><span class="line">        log.info(<span class="string">"增加并开始执行xxl任务失败:{}"</span>, response.getBody().toJSONString());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.XXL_JOB_ERROR);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="4-5-qi-dong-lei-pei-zhi-resttemplate">4.5、启动类配置RestTemplate</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="5-tian-jia-bing-qi-dong-ren-wu-jie-kou">5、添加并启动任务接口</span></h3><p>乘客下单，调用该接口，那么任务调度就启动了</p>
<h4><span id="5-1-wei-fu-wu-jie-kou">5.1、微服务接口</span></h4><h5><span id="5-1-1-newordercontroller">5.1.1、NewOrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> NewOrderService newOrderService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "添加并开始新订单任务调度")</span></span><br><span class="line"><span class="meta">@PostMapping("/addAndStartTask")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Long&gt; <span class="title function_">addAndStartTask</span><span class="params">(<span class="meta">@RequestBody</span> NewOrderTaskVo newOrderTaskVo)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(newOrderService.addAndStartTask(newOrderTaskVo));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-1-2-neworderservice">5.1.2、NewOrderService</span></h5><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Long addAndStartTask(NewOrderTaskVo newOrderTaskVo);</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-1-2-neworderserviceimpl">5.1.2、NewOrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> XxlJobClient xxlJobClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OrderJobMapper orderJobMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">addAndStartTask</span><span class="params">(NewOrderTaskVo newOrderTaskVo)</span> {</span><br><span class="line">    <span class="type">OrderJob</span> <span class="variable">orderJob</span> <span class="operator">=</span> orderJobMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;OrderJob&gt;().eq(OrderJob::getOrderId, newOrderTaskVo.getOrderId()));</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> == orderJob) {</span><br><span class="line">        <span class="type">Long</span> <span class="variable">jobId</span> <span class="operator">=</span> xxlJobClient.addAndStart(<span class="string">"newOrderTaskHandler"</span>, <span class="string">""</span>, <span class="string">"0 0/1 * * * ?"</span>, <span class="string">"新订单任务,订单id："</span>+newOrderTaskVo.getOrderId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//记录订单与任务的关联信息</span></span><br><span class="line">        orderJob = <span class="keyword">new</span> <span class="title class_">OrderJob</span>();</span><br><span class="line">        orderJob.setOrderId(newOrderTaskVo.getOrderId());</span><br><span class="line">        orderJob.setJobId(jobId);</span><br><span class="line">        orderJob.setParameter(JSONObject.toJSONString(newOrderTaskVo));</span><br><span class="line">        orderJobMapper.insert(orderJob);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> orderJob.getJobId();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>说明：每1分钟执行一次，处理任务的bean为：newOrderTaskHandler</p>
<h4><span id="5-2-feign-jie-kou">5.2、Feign接口</span></h4><h5><span id="5-2-1-neworderfeignclient">5.2.1、NewOrderFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加新订单任务</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> newOrderDispatchVo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping("/dispatch/newOrder/addAndStartTask")</span></span><br><span class="line">Result&lt;Long&gt; <span class="title function_">addAndStartTask</span><span class="params">(<span class="meta">@RequestBody</span> NewOrderTaskVo newOrderDispatchVo)</span>;</span><br></pre></td></tr></tbody></table></figure>


<h3><span id="6-kai-fa-ren-wu-job-fang-fa">6、开发任务Job方法</span></h3><h4><span id="6-1-jobhandler">6.1、JobHandler</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.dispatch.xxl.job;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.nacos.common.utils.ExceptionUtil;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.dispatch.mapper.XxlJobLogMapper;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.dispatch.service.NewOrderService;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.model.entity.dispatch.XxlJobLog;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.model.vo.dispatch.NewOrderTaskVo;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.context.XxlJobHelper;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.handler.annotation.XxlJob;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JobHandler</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> XxlJobLogMapper xxlJobLogMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> NewOrderService newOrderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@XxlJob("newOrderTaskHandler")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">newOrderTaskHandler</span><span class="params">()</span> {</span><br><span class="line">        log.info(<span class="string">"新订单调度任务：{}"</span>, XxlJobHelper.getJobId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//记录定时任务相关的日志信息</span></span><br><span class="line">        <span class="comment">//封装日志对象</span></span><br><span class="line">        <span class="type">XxlJobLog</span> <span class="variable">xxlJobLog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxlJobLog</span>();</span><br><span class="line">        xxlJobLog.setJobId(XxlJobHelper.getJobId());</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">//执行任务</span></span><br><span class="line">            newOrderService.executeTask(XxlJobHelper.getJobId());</span><br><span class="line"></span><br><span class="line">            xxlJobLog.setStatus(<span class="number">1</span>);<span class="comment">//成功</span></span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            xxlJobLog.setStatus(<span class="number">0</span>);<span class="comment">//失败</span></span><br><span class="line">            xxlJobLog.setError(ExceptionUtil.getAllExceptionMsg(e));</span><br><span class="line">            log.error(<span class="string">"定时任务执行失败，任务id为：{}"</span>, XxlJobHelper.getJobId());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            <span class="comment">//耗时</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">times</span> <span class="operator">=</span> (<span class="type">int</span>) (System.currentTimeMillis() - startTime);</span><br><span class="line">            xxlJobLog.setTimes(times);</span><br><span class="line">            xxlJobLogMapper.insert(xxlJobLog);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="6-2-neworderservice">6.2、NewOrderService</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">executeTask</span><span class="params">(Long jobId)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="6-3-neworderserviceimpl">6.3、NewOrderServiceImpl</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> LocationFeignClient locationFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OrderInfoFeignClient orderInfoFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">executeTask</span><span class="params">(Long jobId)</span> {</span><br><span class="line">    <span class="comment">//获取任务参数</span></span><br><span class="line">    <span class="type">OrderJob</span> <span class="variable">orderJob</span> <span class="operator">=</span> orderJobMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;OrderJob&gt;().eq(OrderJob::getJobId, jobId));</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> == orderJob) {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="type">NewOrderTaskVo</span> <span class="variable">newOrderTaskVo</span> <span class="operator">=</span> JSONObject.parseObject(orderJob.getParameter(), NewOrderTaskVo.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询订单状态，如果该订单还在接单状态，继续执行；如果不在接单状态，则停止定时调度</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">orderStatus</span> <span class="operator">=</span> orderInfoFeignClient.getOrderStatus(newOrderTaskVo.getOrderId()).getData();</span><br><span class="line">    <span class="keyword">if</span>(orderStatus.intValue() != OrderStatus.WAITING_ACCEPT.getStatus().intValue()) {</span><br><span class="line">        xxlJobClient.stopJob(jobId);</span><br><span class="line">        log.info(<span class="string">"停止任务调度: {}"</span>, JSON.toJSONString(newOrderTaskVo));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//搜索附近满足条件的司机</span></span><br><span class="line">    <span class="type">SearchNearByDriverForm</span> <span class="variable">searchNearByDriverForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchNearByDriverForm</span>();</span><br><span class="line">    searchNearByDriverForm.setLongitude(newOrderTaskVo.getStartPointLongitude());</span><br><span class="line">    searchNearByDriverForm.setLatitude(newOrderTaskVo.getStartPointLatitude());</span><br><span class="line">    searchNearByDriverForm.setMileageDistance(newOrderTaskVo.getExpectDistance());</span><br><span class="line">    List&lt;NearByDriverVo&gt; nearByDriverVoList = locationFeignClient.searchNearByDriver(searchNearByDriverForm).getData();</span><br><span class="line">    <span class="comment">//给司机派发订单信息</span></span><br><span class="line">    nearByDriverVoList.forEach(driver -&gt; {</span><br><span class="line">        <span class="comment">//记录司机id，防止重复推送订单信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">repeatKey</span> <span class="operator">=</span> RedisConstant.DRIVER_ORDER_REPEAT_LIST+newOrderTaskVo.getOrderId();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isMember</span> <span class="operator">=</span> redisTemplate.opsForSet().isMember(repeatKey, driver.getDriverId());</span><br><span class="line">        <span class="keyword">if</span>(!isMember) {</span><br><span class="line">            <span class="comment">//记录该订单已放入司机临时容器</span></span><br><span class="line">            redisTemplate.opsForSet().add(repeatKey, driver.getDriverId());</span><br><span class="line">            <span class="comment">//过期时间：15分钟，新订单15分钟没人接单自动取消</span></span><br><span class="line">            redisTemplate.expire(repeatKey, RedisConstant.DRIVER_ORDER_REPEAT_LIST_EXPIRES_TIME, TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">            <span class="type">NewOrderDataVo</span> <span class="variable">newOrderDataVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NewOrderDataVo</span>();</span><br><span class="line">            newOrderDataVo.setOrderId(newOrderTaskVo.getOrderId());</span><br><span class="line">            newOrderDataVo.setStartLocation(newOrderTaskVo.getStartLocation());</span><br><span class="line">            newOrderDataVo.setEndLocation(newOrderTaskVo.getEndLocation());</span><br><span class="line">            newOrderDataVo.setExpectAmount(newOrderTaskVo.getExpectAmount());</span><br><span class="line">            newOrderDataVo.setExpectDistance(newOrderTaskVo.getExpectDistance());</span><br><span class="line">            newOrderDataVo.setExpectTime(newOrderTaskVo.getExpectTime());</span><br><span class="line">            newOrderDataVo.setFavourFee(newOrderTaskVo.getFavourFee());</span><br><span class="line">            newOrderDataVo.setDistance(driver.getDistance());</span><br><span class="line">            newOrderDataVo.setCreateTime(newOrderTaskVo.getCreateTime());</span><br><span class="line"></span><br><span class="line">            <span class="comment">//将消息保存到司机的临时队列里面，司机接单了会定时轮询到他的临时队列获取订单消息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstant.DRIVER_ORDER_TEMP_LIST+driver.getDriverId();</span><br><span class="line">            redisTemplate.opsForList().leftPush(key, JSONObject.toJSONString(newOrderDataVo));</span><br><span class="line">            <span class="comment">//过期时间：1分钟，1分钟未消费，自动过期</span></span><br><span class="line">            <span class="comment">//注：司机端开启接单，前端每5秒（远小于1分钟）拉取1次“司机临时队列”里面的新订单消息</span></span><br><span class="line">            redisTemplate.expire(key, RedisConstant.DRIVER_ORDER_TEMP_LIST_EXPIRES_TIME, TimeUnit.MINUTES);</span><br><span class="line">            log.info(<span class="string">"该新订单信息已放入司机临时队列: {}"</span>, JSON.toJSONString(newOrderDataVo));</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="7-xia-dan-fang-fa-tian-jia-ren-wu-diao-du">7、下单方法添加任务调度</span></h3><h4><span id="7-1-orderserviceimpl">7.1、OrderServiceImpl</span></h4><p>代码片段：</p>
<p><img src="/2024/09/26/projection-daijia/1698802907391.png" alt="69880290739"></p>
<p>完整代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> NewOrderFeignClient newOrderFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">submitOrder</span><span class="params">(SubmitOrderForm submitOrderForm)</span> {</span><br><span class="line">    <span class="comment">//1.重新计算驾驶线路</span></span><br><span class="line">    <span class="type">CalculateDrivingLineForm</span> <span class="variable">calculateDrivingLineForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CalculateDrivingLineForm</span>();</span><br><span class="line">    BeanUtils.copyProperties(submitOrderForm, calculateDrivingLineForm);</span><br><span class="line">    <span class="type">DrivingLineVo</span> <span class="variable">drivingLineVo</span> <span class="operator">=</span> mapFeignClient.calculateDrivingLine(calculateDrivingLineForm).getData();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.重新计算订单费用</span></span><br><span class="line">    <span class="type">FeeRuleRequestForm</span> <span class="variable">calculateOrderFeeForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeeRuleRequestForm</span>();</span><br><span class="line">    calculateOrderFeeForm.setDistance(drivingLineVo.getDistance());</span><br><span class="line">    calculateOrderFeeForm.setStartTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    calculateOrderFeeForm.setWaitMinute(<span class="number">0</span>);</span><br><span class="line">    <span class="type">FeeRuleResponseVo</span> <span class="variable">feeRuleResponseVo</span> <span class="operator">=</span> feeRuleFeignClient.calculateOrderFee(calculateOrderFeeForm).getData();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.封装订单信息对象</span></span><br><span class="line">    <span class="type">OrderInfoForm</span> <span class="variable">orderInfoForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfoForm</span>();</span><br><span class="line">    <span class="comment">//订单位置信息</span></span><br><span class="line">    BeanUtils.copyProperties(submitOrderForm, orderInfoForm);</span><br><span class="line">    <span class="comment">//预估里程</span></span><br><span class="line">    orderInfoForm.setExpectDistance(drivingLineVo.getDistance());</span><br><span class="line">    orderInfoForm.setExpectAmount(feeRuleResponseVo.getTotalAmount());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4.保存订单信息</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">orderId</span> <span class="operator">=</span> orderInfoFeignClient.saveOrderInfo(orderInfoForm).getData();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.添加并执行任务调度，每分钟执行一次，搜索附近司机</span></span><br><span class="line">    <span class="comment">//5.1.封装调度参数对象</span></span><br><span class="line">    <span class="type">NewOrderTaskVo</span> <span class="variable">newOrderDispatchVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NewOrderTaskVo</span>();</span><br><span class="line">    newOrderDispatchVo.setOrderId(orderId);</span><br><span class="line">    newOrderDispatchVo.setStartLocation(orderInfoForm.getStartLocation());</span><br><span class="line">    newOrderDispatchVo.setStartPointLongitude(orderInfoForm.getStartPointLongitude());</span><br><span class="line">    newOrderDispatchVo.setStartPointLatitude(orderInfoForm.getStartPointLatitude());</span><br><span class="line">    newOrderDispatchVo.setEndLocation(orderInfoForm.getEndLocation());</span><br><span class="line">    newOrderDispatchVo.setEndPointLongitude(orderInfoForm.getEndPointLongitude());</span><br><span class="line">    newOrderDispatchVo.setEndPointLatitude(orderInfoForm.getEndPointLatitude());</span><br><span class="line">    newOrderDispatchVo.setExpectAmount(orderInfoForm.getExpectAmount());</span><br><span class="line">    newOrderDispatchVo.setExpectDistance(orderInfoForm.getExpectDistance());</span><br><span class="line">    newOrderDispatchVo.setExpectTime(drivingLineVo.getDuration());</span><br><span class="line">    newOrderDispatchVo.setFavourFee(orderInfoForm.getFavourFee());</span><br><span class="line">    newOrderDispatchVo.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    <span class="comment">//5.2.添加并执行任务调度</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">jobId</span> <span class="operator">=</span> newOrderFeignClient.addAndStartTask(newOrderDispatchVo).getData();</span><br><span class="line">    log.info(<span class="string">"订单id为： {}，绑定任务id为：{}"</span>, orderId, jobId);</span><br><span class="line">    <span class="keyword">return</span> orderId;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这样一个完整的乘客下单到任务调用搜索合适司机就这么串连上了。</p>
<h3><span id="8-si-ji-huo-qu-xin-ding-dan-shu-ju-lie-biao">8、司机获取新订单数据列表</span></h3><p>司机开启接单服务后，司机端小程序就会实时轮询新订单数据，如果临时队列有数据，就拉取数据进行实时语音播报。但是当司机接单成功后，就需要清空临时队列，释放系统空间，因此这两接口都提供了吧，清除不需要web接口。</p>
<h4><span id="8-1-diao-du-wei-fu-wu-jie-kou">8.1、调度微服务接口</span></h4><h5><span id="8-1-1-newordercontroller">8.1.1、NewOrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "查询司机新订单数据")</span></span><br><span class="line"><span class="meta">@GetMapping("/findNewOrderQueueData/{driverId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;List&lt;NewOrderDataVo&gt;&gt; <span class="title function_">findNewOrderQueueData</span><span class="params">(<span class="meta">@PathVariable</span> Long driverId)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(newOrderService.findNewOrderQueueData(driverId));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "清空新订单队列数据")</span></span><br><span class="line"><span class="meta">@GetMapping("/clearNewOrderQueueData/{driverId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">clearNewOrderQueueData</span><span class="params">(<span class="meta">@PathVariable</span> Long driverId)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(newOrderService.clearNewOrderQueueData(driverId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="8-1-2-neworderservice">8.1.2、NewOrderService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;NewOrderDataVo&gt; <span class="title function_">findNewOrderQueueData</span><span class="params">(Long driverId)</span>;</span><br><span class="line"></span><br><span class="line">Boolean <span class="title function_">clearNewOrderQueueData</span><span class="params">(Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="8-1-2-neworderserviceimpl">8.1.2、NewOrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;NewOrderDataVo&gt; <span class="title function_">findNewOrderQueueData</span><span class="params">(Long driverId)</span> {</span><br><span class="line">   List&lt;NewOrderDataVo&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">   <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstant.DRIVER_ORDER_TEMP_LIST + driverId;</span><br><span class="line">   <span class="type">long</span> <span class="variable">size</span> <span class="operator">=</span> redisTemplate.opsForList().size(key);</span><br><span class="line">   <span class="keyword">if</span>(size &gt; <span class="number">0</span>) {</span><br><span class="line">      <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;size; i++) {</span><br><span class="line">         <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> (String)redisTemplate.opsForList().leftPop(key);</span><br><span class="line">         <span class="type">NewOrderDataVo</span> <span class="variable">newOrderDataVo</span> <span class="operator">=</span> JSONObject.parseObject(content, NewOrderDataVo.class);</span><br><span class="line">         list.add(newOrderDataVo);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">return</span> list;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">clearNewOrderQueueData</span><span class="params">(Long driverId)</span> {</span><br><span class="line">   <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> RedisConstant.DRIVER_ORDER_TEMP_LIST + driverId;</span><br><span class="line">   <span class="comment">//直接删除，司机开启服务后，有新订单会自动创建容器</span></span><br><span class="line">   redisTemplate.delete(key);</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="8-2-feign-jie-kou">8.2、 Feign接口</span></h4><h5><span id="8-2-1-neworderfeignclient">8.2.1、NewOrderFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询司机新订单数据</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/dispatch/newOrder/findNewOrderQueueData/{driverId}")</span></span><br><span class="line">Result&lt;List&lt;NewOrderDataVo&gt;&gt; <span class="title function_">findNewOrderQueueData</span><span class="params">(<span class="meta">@PathVariable("driverId")</span> Long driverId)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 清空新订单队列数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/dispatch/newOrder/clearNewOrderQueueData/{driverId}")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">clearNewOrderQueueData</span><span class="params">(<span class="meta">@PathVariable("driverId")</span> Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="8-3-si-ji-duan-web-jie-kou">8.3、 司机端web接口</span></h4><h5><span id="8-3-1-ordercontroller">8.3.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "查询司机新订单数据")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("/findNewOrderQueueData")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;List&lt;NewOrderDataVo&gt;&gt; <span class="title function_">findNewOrderQueueData</span><span class="params">()</span> {</span><br><span class="line">   <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">   <span class="keyword">return</span> Result.ok(orderService.findNewOrderQueueData(driverId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="8-3-2-orderservice">8.3.2、OrderService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;NewOrderDataVo&gt; <span class="title function_">findNewOrderQueueData</span><span class="params">(Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="8-3-3-orderserviceimpl">8.3.3、OrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> NewOrderFeignClient newOrderFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;NewOrderDataVo&gt; <span class="title function_">findNewOrderQueueData</span><span class="params">(Long driverId)</span> {</span><br><span class="line">   <span class="keyword">return</span> newOrderFeignClient.findNewOrderQueueData(driverId).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h1><span id="vii-si-ji-qiang-dan">Ⅶ.司机抢单</span></h1><h2><span id="yi-kai-qi-jie-dan-fu-wu">一、开启接单服务</span></h2><p>前面乘客已经下单，新订单消息已经加入司机临时队列，接下来我们把司机端的开启接单到抢单的流程写一下。</p>
<p>开启接单我们要做哪些操作呢？</p>
<p>1、判断司机认证状态，只要认证通过了的司机才能接单，司机登录信息包含司机认证状态（已开发）</p>
<p>2、判断司机当日是否已做人脸识别，司机每天必须做一次人脸识别，如果未做，跳转到人脸识别页面</p>
<p>3、更新司机全局接单状态</p>
<p>4、删除司机之前的geo数据（重新做初始化，防止数据影响）</p>
<p>5、清空司机新订单临时队列（重新做初始化，防止数据影响）</p>
<h3><span id="1-cha-zhao-si-ji-duan-dang-qian-ding-dan">1、查找司机端当前订单</span></h3><p>司机端接单也一样，只要有执行中的订单，没有结束，那么司机是不可以接单的，页面会弹出层，进入执行中的订单。<br>当前我们必须把这个接口绕过去，不然我们不能接单，因此我们模拟一下这个接口，告诉它没有执行中的订单，后续在订单流程中我们完善这个业务。</p>
<h4><span id="1-1-si-ji-duan-web-mo-ni-jie-kou">1.1、司机端web模拟接口</span></h4><h5><span id="1-1-1-ordercontroller">1.1.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "查找司机端当前订单")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("/searchDriverCurrentOrder")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;CurrentOrderInfoVo&gt; <span class="title function_">searchDriverCurrentOrder</span><span class="params">()</span> {</span><br><span class="line">       <span class="type">CurrentOrderInfoVo</span> <span class="variable">currentOrderInfoVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CurrentOrderInfoVo</span>();</span><br><span class="line">       currentOrderInfoVo.setIsHasCurrentOrder(<span class="literal">false</span>);</span><br><span class="line">       <span class="keyword">return</span> Result.ok(currentOrderInfoVo);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-pan-duan-si-ji-dang-ri-shi-fou-yi-zuo-ren-lian-shi-bie">2、判断司机当日是否已做人脸识别</span></h3><h4><span id="2-1-si-ji-duan-wei-fu-wu-jie-kou">2.1、司机端微服务接口</span></h4><h5><span id="2-1-1-driverinfocontroller">2.1.1、DriverInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "判断司机当日是否进行过人脸识别")</span></span><br><span class="line"><span class="meta">@GetMapping("/isFaceRecognition/{driverId}")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">isFaceRecognition</span><span class="params">(<span class="meta">@PathVariable("driverId")</span> Long driverId)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(driverInfoService.isFaceRecognition(driverId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-2-driverinfoservice">2.1.2、DriverInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">isFaceRecognition</span><span class="params">(Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-3-driverinfoserviceimpl">2.1.3、DriverInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DriverFaceRecognitionMapper driverFaceRecognitionMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">isFaceRecognition</span><span class="params">(Long driverId)</span> {</span><br><span class="line">    LambdaQueryWrapper&lt;DriverFaceRecognition&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>();</span><br><span class="line">    queryWrapper.eq(DriverFaceRecognition::getDriverId, driverId);</span><br><span class="line">    queryWrapper.eq(DriverFaceRecognition::getFaceDate, <span class="keyword">new</span> <span class="title class_">DateTime</span>().toString(<span class="string">"yyyy-MM-dd"</span>));</span><br><span class="line">    <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> driverFaceRecognitionMapper.selectCount(queryWrapper);</span><br><span class="line">    <span class="keyword">return</span> count != <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-2-feign-jie-kou">2.2、Feign接口</span></h4><h5><span id="2-2-1-driverinfofeignclient">2.2.1、DriverInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 判断司机当日是否进行过人脸识别</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/driver/info/isFaceRecognition/{driverId}")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">isFaceRecognition</span><span class="params">(<span class="meta">@PathVariable("driverId")</span> Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-3-si-ji-duan-web-jie-kou">2.3、司机端web接口</span></h4><h5><span id="2-3-1-drivercontroller">2.3.1、DriverController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "判断司机当日是否进行过人脸识别")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("/isFaceRecognition")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">isFaceRecognition</span><span class="params">()</span> {</span><br><span class="line">   <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">   <span class="keyword">return</span> Result.ok(driverService.isFaceRecognition(driverId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-3-2-driverservice">2.3.2、DriverService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">isFaceRecognition</span><span class="params">(Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-3-2-driverserviceimpl">2.3.2、DriverServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">isFaceRecognition</span><span class="params">(Long driverId)</span> {</span><br><span class="line">    <span class="keyword">return</span> driverInfoFeignClient.isFaceRecognition(driverId).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-ren-lian-yan-zheng">3、人脸验证</span></h3><p>前面我们已经做了人员库人员信息录入，现在我们要做人脸验证，为了防止司机作弊，我们还要对司机上传的人脸信息做人脸静态活体检测。</p>
<p>人脸静态活体检测可用于对用户上传的静态图片进行防翻拍活体检测，以判断是否是翻拍图片。</p>
<h4><span id="3-1-si-ji-duan-wei-fu-wu-jie-kou">3.1、司机端微服务接口</span></h4><h5><span id="3-1-1-driverinfocontroller">3.1.1、DriverInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "验证司机人脸")</span></span><br><span class="line"><span class="meta">@PostMapping("/verifyDriverFace")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">verifyDriverFace</span><span class="params">(<span class="meta">@RequestBody</span> DriverFaceModelForm driverFaceModelForm)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(driverInfoService.verifyDriverFace(driverFaceModelForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-2-driverinfoservice">3.1.2、DriverInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">verifyDriverFace</span><span class="params">(DriverFaceModelForm driverFaceModelForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-3-driverinfoserviceimpl">3.1.3、DriverInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 人脸验证</span></span><br><span class="line"><span class="comment"> * 文档地址：</span></span><br><span class="line"><span class="comment"> * https://cloud.tencent.com/document/api/867/44983</span></span><br><span class="line"><span class="comment"> * https://console.cloud.tencent.com/api/explorer?Product=iai&amp;Version=2020-03-03&amp;Action=VerifyFace</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverFaceModelForm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">verifyDriverFace</span><span class="params">(DriverFaceModelForm driverFaceModelForm)</span> {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 实例化一个认证对象，入参需要传入腾讯云账户 SecretId 和 SecretKey，此处还需注意密钥对的保密</span></span><br><span class="line">        <span class="comment">// 代码泄露可能会导致 SecretId 和 SecretKey 泄露，并威胁账号下所有资源的安全性。以下代码示例仅供参考，建议采用更安全的方式来使用密钥，请参见：https://cloud.tencent.com/document/product/1278/85305</span></span><br><span class="line">        <span class="comment">// 密钥可前往官网控制台 https://console.cloud.tencent.com/cam/capi 进行获取</span></span><br><span class="line">        <span class="type">Credential</span> <span class="variable">cred</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Credential</span>(tencentCloudProperties.getSecretId(), tencentCloudProperties.getSecretKey());</span><br><span class="line">        <span class="comment">// 实例化一个http选项，可选的，没有特殊需求可以跳过</span></span><br><span class="line">        <span class="type">HttpProfile</span> <span class="variable">httpProfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpProfile</span>();</span><br><span class="line">        httpProfile.setEndpoint(<span class="string">"iai.tencentcloudapi.com"</span>);</span><br><span class="line">        <span class="comment">// 实例化一个client选项，可选的，没有特殊需求可以跳过</span></span><br><span class="line">        <span class="type">ClientProfile</span> <span class="variable">clientProfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientProfile</span>();</span><br><span class="line">        clientProfile.setHttpProfile(httpProfile);</span><br><span class="line">        <span class="comment">// 实例化要请求产品的client对象,clientProfile是可选的</span></span><br><span class="line">        <span class="type">IaiClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IaiClient</span>(cred, tencentCloudProperties.getRegion(), clientProfile);</span><br><span class="line">        <span class="comment">// 实例化一个请求对象,每个接口都会对应一个request对象</span></span><br><span class="line">        <span class="type">VerifyFaceRequest</span> <span class="variable">req</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VerifyFaceRequest</span>();</span><br><span class="line">        req.setImage(driverFaceModelForm.getImageBase64());</span><br><span class="line">        req.setPersonId(String.valueOf(driverFaceModelForm.getDriverId()));</span><br><span class="line">        <span class="comment">// 返回的resp是一个VerifyFaceResponse的实例，与请求对象对应</span></span><br><span class="line">        <span class="type">VerifyFaceResponse</span> <span class="variable">resp</span> <span class="operator">=</span> client.VerifyFace(req);</span><br><span class="line">        <span class="comment">// 输出json格式的字符串回包</span></span><br><span class="line">        System.out.println(VerifyFaceResponse.toJsonString(resp));</span><br><span class="line">        <span class="keyword">if</span> (resp.getIsMatch()) {</span><br><span class="line">            <span class="comment">//活体检查</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">this</span>.detectLiveFace(driverFaceModelForm.getImageBase64())) {</span><br><span class="line">                <span class="type">DriverFaceRecognition</span> <span class="variable">driverFaceRecognition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverFaceRecognition</span>();</span><br><span class="line">                driverFaceRecognition.setDriverId(driverFaceModelForm.getDriverId());</span><br><span class="line">                driverFaceRecognition.setFaceDate(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">                driverFaceRecognitionMapper.insert(driverFaceRecognition);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            };</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (TencentCloudSDKException e) {</span><br><span class="line">        System.out.println(e.toString());</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.FACE_FAIL);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 人脸静态活体检测</span></span><br><span class="line"><span class="comment"> * 文档地址：</span></span><br><span class="line"><span class="comment"> * https://cloud.tencent.com/document/api/867/48501</span></span><br><span class="line"><span class="comment"> * https://console.cloud.tencent.com/api/explorer?Product=iai&amp;Version=2020-03-03&amp;Action=DetectLiveFace</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> imageBase64</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Boolean <span class="title function_">detectLiveFace</span><span class="params">(String imageBase64)</span> {</span><br><span class="line">    <span class="keyword">try</span>{</span><br><span class="line">        <span class="comment">// 实例化一个认证对象，入参需要传入腾讯云账户 SecretId 和 SecretKey，此处还需注意密钥对的保密</span></span><br><span class="line">        <span class="comment">// 代码泄露可能会导致 SecretId 和 SecretKey 泄露，并威胁账号下所有资源的安全性。以下代码示例仅供参考，建议采用更安全的方式来使用密钥，请参见：https://cloud.tencent.com/document/product/1278/85305</span></span><br><span class="line">        <span class="comment">// 密钥可前往官网控制台 https://console.cloud.tencent.com/cam/capi 进行获取</span></span><br><span class="line">        <span class="type">Credential</span> <span class="variable">cred</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Credential</span>(tencentCloudProperties.getSecretId(), tencentCloudProperties.getSecretKey());</span><br><span class="line">        <span class="comment">// 实例化一个http选项，可选的，没有特殊需求可以跳过</span></span><br><span class="line">        <span class="type">HttpProfile</span> <span class="variable">httpProfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpProfile</span>();</span><br><span class="line">        httpProfile.setEndpoint(<span class="string">"iai.tencentcloudapi.com"</span>);</span><br><span class="line">        <span class="comment">// 实例化一个client选项，可选的，没有特殊需求可以跳过</span></span><br><span class="line">        <span class="type">ClientProfile</span> <span class="variable">clientProfile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientProfile</span>();</span><br><span class="line">        clientProfile.setHttpProfile(httpProfile);</span><br><span class="line">        <span class="comment">// 实例化要请求产品的client对象,clientProfile是可选的</span></span><br><span class="line">        <span class="type">IaiClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IaiClient</span>(cred, tencentCloudProperties.getRegion(), clientProfile);</span><br><span class="line">        <span class="comment">// 实例化一个请求对象,每个接口都会对应一个request对象</span></span><br><span class="line">        <span class="type">DetectLiveFaceRequest</span> <span class="variable">req</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DetectLiveFaceRequest</span>();</span><br><span class="line">        req.setImage(imageBase64);</span><br><span class="line">        <span class="comment">// 返回的resp是一个DetectLiveFaceResponse的实例，与请求对象对应</span></span><br><span class="line">        <span class="type">DetectLiveFaceResponse</span> <span class="variable">resp</span> <span class="operator">=</span> client.DetectLiveFace(req);</span><br><span class="line">        <span class="comment">// 输出json格式的字符串回包</span></span><br><span class="line">        System.out.println(DetectLiveFaceResponse.toJsonString(resp));</span><br><span class="line">        <span class="keyword">if</span>(resp.getIsLiveness()) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (TencentCloudSDKException e) {</span><br><span class="line">        System.out.println(e.toString());</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="3-2-feign-jie-kou">3.2、Feign接口</span></h4><h5><span id="3-2-1-driverinfofeignclient">3.2.1、DriverInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证司机人脸</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverFaceModelForm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping("/driver/info/verifyDriverFace")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">verifyDriverFace</span><span class="params">(<span class="meta">@RequestBody</span> DriverFaceModelForm driverFaceModelForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="3-3-si-ji-duan-web-jie-kou">3.3、司机端web接口</span></h4><h5><span id="3-3-1-drivercontroller">3.3.1、DriverController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "验证司机人脸")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@PostMapping("/verifyDriverFace")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">verifyDriverFace</span><span class="params">(<span class="meta">@RequestBody</span> DriverFaceModelForm driverFaceModelForm)</span> {</span><br><span class="line">    driverFaceModelForm.setDriverId(AuthContextHolder.getUserId());</span><br><span class="line">    <span class="keyword">return</span> Result.ok(driverService.verifyDriverFace(driverFaceModelForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-2-driverservice">3.1.2、DriverService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">verifyDriverFace</span><span class="params">(DriverFaceModelForm driverFaceModelForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-3-driverserviceimpl">3.1.3、DriverServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">verifyDriverFace</span><span class="params">(DriverFaceModelForm driverFaceModelForm)</span> {</span><br><span class="line">    <span class="keyword">return</span> driverInfoFeignClient.verifyDriverFace(driverFaceModelForm).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-geng-xin-si-ji-jie-dan-zhuang-tai">4、更新司机接单状态</span></h3><h4><span id="4-1-si-ji-wei-fu-wu-jie-kou">4.1、司机微服务接口</span></h4><h5><span id="4-1-1-driverinfocontroller">4.1.1、DriverInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "更新接单状态")</span></span><br><span class="line"><span class="meta">@GetMapping("/updateServiceStatus/{driverId}/{status}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">updateServiceStatus</span><span class="params">(<span class="meta">@PathVariable</span> Long driverId, <span class="meta">@PathVariable</span> Integer status)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(driverInfoService.updateServiceStatus(driverId, status));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-2-driverinfoservice">4.1.2、DriverInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">updateServiceStatus</span><span class="params">(Long driverId, Integer status)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-3-driverinfoserviceimpl">4.1.3、DriverInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">updateServiceStatus</span><span class="params">(Long driverId, Integer status)</span> {</span><br><span class="line">    LambdaQueryWrapper&lt;DriverSet&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(DriverSet::getDriverId, driverId);</span><br><span class="line">    <span class="type">DriverSet</span> <span class="variable">driverSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverSet</span>();</span><br><span class="line">    driverSet.setServiceStatus(status);</span><br><span class="line">    driverSetMapper.update(driverSet, queryWrapper);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-2-feign-jie-kou">4.2、Feign接口</span></h4><h5><span id="4-2-1-driverinfofeignclient">4.2.1、DriverInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更新接单状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/driver/info/updateServiceStatus/{driverId}/{status}")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">updateServiceStatus</span><span class="params">(<span class="meta">@PathVariable("driverId")</span> Long driverId, <span class="meta">@PathVariable("status")</span> Integer status)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="5-kai-qi-jie-dan-fu-wu-web-jie-kou">5、开启接单服务web接口</span></h3><p>司机要开启接单后，上传位置信息到redis的geo，这样才能被任务调度搜索到司机信息，才能抢单。</p>
<h4><span id="5-1-drivercontroller">5.1、DriverController</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "开始接单服务")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("/startService")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">startService</span><span class="params">()</span> {</span><br><span class="line">   <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">   <span class="keyword">return</span> Result.ok(driverService.startService(driverId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="5-2-driverservice">5.2、DriverService</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">startService</span><span class="params">(Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="5-3-driverserviceimpl">5.3、DriverServiceImpl</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> LocationFeignClient locationFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> NewOrderFeignClient newOrderDispatchFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">startService</span><span class="params">(Long driverId)</span> {</span><br><span class="line">    <span class="comment">//判断认证状态</span></span><br><span class="line">    <span class="type">DriverLoginVo</span> <span class="variable">driverLoginVo</span> <span class="operator">=</span> driverInfoFeignClient.getDriverLoginInfo(driverId).getData();</span><br><span class="line">    <span class="keyword">if</span>(driverLoginVo.getAuthStatus().intValue() != <span class="number">2</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.AUTH_ERROR);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断当日是否人脸识别</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isFaceRecognition</span> <span class="operator">=</span> driverInfoFeignClient.isFaceRecognition(driverId).getData();</span><br><span class="line">    <span class="keyword">if</span>(!isFaceRecognition) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.FACE_ERROR);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新司机接单状态</span></span><br><span class="line">    driverInfoFeignClient.updateServiceStatus(driverId, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除司机位置信息</span></span><br><span class="line">    locationFeignClient.removeDriverLocation(driverId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//清空司机新订单队列</span></span><br><span class="line">    newOrderDispatchFeignClient.clearNewOrderQueueData(driverId);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="6-ting-zhi-jie-dan-fu-wu-web-jie-kou">6、停止接单服务web接口</span></h3><p>司机抢成功单，就要关闭接单服务。</p>
<h4><span id="6-1-drivercontroller">6.1、DriverController</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "停止接单服务")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("/stopService")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">stopService</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">    <span class="keyword">return</span> Result.ok(driverService.stopService(driverId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="6-2-driverservice">6.2、DriverService</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">stopService</span><span class="params">(Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="6-3-driverserviceimpl">6.3、DriverServiceImpl</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">stopService</span><span class="params">(Long driverId)</span> {</span><br><span class="line">    <span class="comment">//更新司机接单状态</span></span><br><span class="line">    driverInfoFeignClient.updateServiceStatus(driverId, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除司机位置信息</span></span><br><span class="line">    locationFeignClient.removeDriverLocation(driverId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//清空司机新订单队列</span></span><br><span class="line">    newOrderDispatchFeignClient.clearNewOrderQueueData(driverId);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="er-si-ji-qiang-dan">二、司机抢单</span></h2><p>当前司机已经开启接单服务了，实时轮流司机服务器端临时队列，只要有合适的新订单产生，那么就会轮回获取新订单数据，进行语音播放，如果司机对这个订单感兴趣就可以抢单，大家注意，同一个新订单会放入满足条件的所有司机的临时队列，谁先抢到就是谁的。</p>
<h3><span id="1-si-ji-qiang-dan">1、司机抢单</span></h3><h4><span id="1-1-ding-dan-wei-fu-wu-jie-kou">1.1、订单微服务接口</span></h4><h5><span id="1-1-1-orderinfocontroller">1.1.1、OrderInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "司机抢单")</span></span><br><span class="line"><span class="meta">@GetMapping("/robNewOrder/{driverId}/{orderId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">robNewOrder</span><span class="params">(<span class="meta">@PathVariable</span> Long driverId, <span class="meta">@PathVariable</span> Long orderId)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(orderInfoService.robNewOrder(driverId, orderId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-2-orderinfoservice">1.1.2、OrderInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">robNewOrder</span><span class="params">(Long driverId, Long orderId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-3-orderinfoserviceimpl">1.1.3、OrderInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">robNewOrder</span><span class="params">(Long driverId, Long orderId)</span> {</span><br><span class="line">    <span class="comment">//抢单成功或取消订单，都会删除该key，redis判断，减少数据库压力</span></span><br><span class="line">    <span class="keyword">if</span>(!redisTemplate.hasKey(RedisConstant.ORDER_ACCEPT_MARK)) {</span><br><span class="line">        <span class="comment">//抢单失败</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.COB_NEW_ORDER_FAIL);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//修改订单状态及司机id</span></span><br><span class="line">    <span class="comment">//update order_info set status = 2, driver_id = #{driverId}, accept_time = now() where id = #{id}</span></span><br><span class="line">    <span class="comment">//修改字段</span></span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfo</span>();</span><br><span class="line">    orderInfo.setId(orderId);</span><br><span class="line">    orderInfo.setStatus(OrderStatus.ACCEPTED.getStatus());</span><br><span class="line">    orderInfo.setAcceptTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    orderInfo.setDriverId(driverId);</span><br><span class="line">    <span class="type">int</span> <span class="variable">rows</span> <span class="operator">=</span> orderInfoMapper.updateById(orderInfo);</span><br><span class="line">    <span class="keyword">if</span>(rows != <span class="number">1</span>) {</span><br><span class="line">        <span class="comment">//抢单失败</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.COB_NEW_ORDER_FAIL);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//记录日志</span></span><br><span class="line">    <span class="built_in">this</span>.log(orderId, orderInfo.getStatus());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除redis订单标识</span></span><br><span class="line">    redisTemplate.delete(RedisConstant.ORDER_ACCEPT_MARK);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-feign-jie-kou">1.2、Feign接口</span></h4><h5><span id="1-2-1-orderinfofeignclient">1.2.1、OrderInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 司机抢单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/order/info/robNewOrder/{driverId}/{orderId}")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">robNewOrder</span><span class="params">(<span class="meta">@PathVariable("driverId")</span> Long driverId, <span class="meta">@PathVariable("orderId")</span> Long orderId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-3-si-ji-duan-web-jie-kou">1.3、司机端web接口</span></h4><h5><span id="1-3-1-ordercontroller">1.3.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "司机抢单")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("/robNewOrder/{orderId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">robNewOrder</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> {</span><br><span class="line">   <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">   <span class="keyword">return</span> Result.ok(orderService.robNewOrder(driverId, orderId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-3-2-orderservice">1.3.2、OrderService</span></h5><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean robNewOrder(Long driverId, Long orderId);</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-3-3-orderserviceimpl">1.3.3、OrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OrderInfoFeignClient orderInfoFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">robNewOrder</span><span class="params">(Long driverId, Long orderId)</span> {</span><br><span class="line">   <span class="keyword">return</span> orderInfoFeignClient.robNewOrder(driverId, orderId).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-si-ji-qiang-dan-you-hua">2、司机抢单优化</span></h3><p>司机端小程序成功显示了新订单，但是司机想要抢单，最终只能有一个司机抢到，而且必须是最先抢到的那个司机接单，这里就涉及到了一个类似电商库存超售的问题。我们以电商为例，讲述一下这个问题。</p>
<h4><span id="2-1-chao-shou-xian-xiang-de-chan-sheng-yuan-yin">2.1、超售现象的产生原因</span></h4><p>商品秒杀过程中经常会出现超售的现象，超售就是卖出了超过预期数量的商品。比如说A商品库存是100个，但是秒杀的过程中，一共卖出去500个A商品。对于卖家来说，这就是超售。</p>
<p>商品超售的后果是非常严重的，比如说，某个店铺在电商平台上搞活动，拿出20部苹果手机半价销售。相当于买到的人，省下了四、五千块钱，抢购手机的人肯定趋之若鹜。于是几万人，甚至几十万人去抢购商品。这下可好，原本商家拿出20部手机搞促销，但是出现了超售现象，实际有两千人用半价抢到了手机。这下子，商家可亏大发了。商家仔细一下，不对啊，我在电商平台的后台设置了，秒杀商品的库存是20，结果卖出去2000部半价手机。电商平台有不可推卸的责任，这是电商系统的程序问题，于是商家提出向电商平台索赔。像是淘宝这一样的B2B电商平台，里面的商家几百万。要是双十一促销活动，都出现了超售现象，淘宝得赔多少钱啊？所以超售这个问题必须解决，一定要解决。</p>
<p><img src="/2024/09/26/projection-daijia/624fe033092f738111620.jpg" alt="img"></p>
<p>上面的这个流程代表，A顾客抢购商品，电商系统先去判断，商品有没有库存，假设现在某个商品库存为1，是可以抢购的，于是电商程序，开启事物，生成UPDATE语句，但是也许是线程被挂起的原因，或者网络延迟的原因，反正就是没有把UPDATE交给数据库执行。</p>
<p>这时候B顾客来抢购商品，电商系统也是先去判断有没有库存，因为A顾客抢购商品的SQL语句并没有执行，但是B顾客抢购商品执行的很顺利，电商系统开启了事务，然后生成库存减1的UPDATE语句，并且提交给数据库运行，事务提交之后，商品库存变成0。这时候A顾客的抢购商品的UPDATE语句，传递给数据库执行，于是数据库对库存又减1，这就形成了超售现象。原本库存只有1件商品，却卖出去两份订单，你说这个商品发货给谁呢？</p>
<h4><span id="2-2-zen-me-yu-fang-shu-ju-ku-chao-shou">2.2、怎么预防数据库超售？</span></h4><p><strong>第一种</strong>办法技术上最稳妥，但是业务上不可行。那就是设置事物的隔离级别为Serializable。这个事物隔离级别非常严格，因为多个事物并发执行，对同一条记录修改，就会出现超售现象。所以干脆，咱们就禁止事物的并发执行吧。Serializable就是让数据库，串行执行事物，一个事物执行完，才能执行下一个事物，这种办法确实解决了超售的问题。但是同学们，SQL语句对数据的修改，最终都是要反应到磁盘上的。磁盘的IO速度你也是知道的，比内存和CPU慢多了。所以说，串行化执行事物，一个事物执行的时间就不短，你让后面的排队的事物等到什么时候？因此说，串行化执行事物的办法是不可行的。你要是这么搞，电商系统几千万人一起买东西的时候，几千万个事物串行执行，最后的事物，真得是要等到猴年马月了，所以绝对不能这么搞。</p>
<p><img src="/2024/09/26/projection-daijia/624fe07609bf9a0318350315.jpg" alt="img"></p>
<p><strong>第二种</strong>办法是给数据表设置乐观锁。我们在数据表上面添加一个乐观锁字段，数据类型是整数的，用来记录数据更新的版本号，这个跟SVN机制很像。乐观锁是一种逻辑锁，他是通过版本号来判定有没有更新冲突出现。比如说，现在A商品的乐观锁版本号是0，现在有事务1来抢购商品了。事务1记录下版本号是0，等到执行修改库存的时候，就把乐观锁的版本号设置成1。但是事务1在执行的过程中，还没来得及执行UPDATE语句修改库存。这个时候事务2进来了，他执行的很快，直接把库存修改成99，然后把版本号变成了1。这时候，事务1开始执行UPDATE语句，但是发现乐观锁的版本号变成了1，这说明，肯定有人抢在事务1之前，更改了库存，所以事务1就不能更新，否则就会出现超售现象。</p>
<p><img src="/2024/09/26/projection-daijia/624fe09d0945e70b24780578.jpg" alt="img"></p>
<p><strong>第三种</strong>办法就是加锁，我们学习过synchronized 及lock锁，但是在微服务环境中就不可以使用了，那么怎么办呢？我可以使用分布式锁，分布式的实现方式多种多样，常见的分布式说可以基于以下集中方式实现：</p>
<p><strong>1、基于 Redis 做分布式锁</strong></p>
<p>基于 REDIS 的 SETNX()、EXPIRE() 方法做分布式锁</p>
<p>（1）、setnx(lockkey, 1) 如果返回 0，则说明占位失败；如果返回 1，则说明占位成功</p>
<p>（2）、expire() 命令对 lockkey 设置超时时间，为的是避免死锁问题。</p>
<p>（3）、执行完<a target="_blank" rel="noopener" href="https://www.zhihu.com/search?q=%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81&amp;search_source=Entity&amp;hybrid_search_source=Entity&amp;hybrid_search_extra=%7B%22sourceType%22:%22answer%22,%22sourceId%22:2958112837%7D">业务代码</a>后，可以通过 delete 命令删除 key</p>
<p><strong>2、基于 REDISSON 做分布式锁</strong></p>
<p>redisson 是 redis 官方的分布式锁组件。</p>
<p><strong>3、基于 ZooKeeper 做分布式锁</strong></p>
<p>基于临时顺序节点实现</p>
<p>每一种分布式锁解决方案都有各自的优缺点</p>
<h3><span id="3-ji-yu-le-guan-suo-jie-jue-si-ji-qiang-dan">3、基于乐观锁解决司机抢单</span></h3><h4><span id="3-1-si-lu">3.1、思路</span></h4><p>前面司机抢单时的sql语句为：</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> order_info <span class="keyword">set</span> status <span class="operator">=</span> <span class="number">2</span>, driver_id <span class="operator">=</span> #{driverId}, accept_time <span class="operator">=</span> now() <span class="keyword">where</span> id <span class="operator">=</span> #{id}</span><br></pre></td></tr></tbody></table></figure>

<p>只要接单标识还没删除，无数个线程都可以执行上面的更新sql，这样就不是先抢先得了，后抢的会覆盖前面的操作。</p>
<p>更改抢单sql：</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> order_info <span class="keyword">set</span> status <span class="operator">=</span> <span class="number">2</span>, driver_id <span class="operator">=</span> #{driverId}, accept_time <span class="operator">=</span> now() <span class="keyword">where</span> id <span class="operator">=</span> #{id} <span class="keyword">and</span> status <span class="operator">=</span> <span class="number">1</span></span><br></pre></td></tr></tbody></table></figure>

<p>或者</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> order_info <span class="keyword">set</span> status <span class="operator">=</span> <span class="number">2</span>, driver_id <span class="operator">=</span> #{driverId}, accept_time <span class="operator">=</span> now() <span class="keyword">where</span> id <span class="operator">=</span> #{id} <span class="keyword">and</span> driver_id <span class="keyword">is</span> <span class="keyword">null</span></span><br></pre></td></tr></tbody></table></figure>

<p>where语句后面相当于加了一个乐观锁，后面的线程执行时更新记录为0，那么我就可以返回抢单失败</p>
<h4><span id="3-2-orderinfoserviceimpl">3.2、OrderInfoServiceImpl</span></h4><p>代码优化</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">robNewOrder</span><span class="params">(Long driverId, Long orderId)</span> {</span><br><span class="line">   <span class="comment">//抢单成功或取消订单，都会删除该key，redis判断，减少数据库压力</span></span><br><span class="line">   <span class="keyword">if</span>(!redisTemplate.hasKey(RedisConstant.ORDER_ACCEPT_MARK)) {</span><br><span class="line">      <span class="comment">//抢单失败</span></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.COB_NEW_ORDER_FAIL);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">//修改订单状态及司机id</span></span><br><span class="line">   <span class="comment">//update order_info set status = 2, driver_id = #{driverId}, accept_time = now() where id = #{id} and status =1</span></span><br><span class="line">   <span class="comment">//条件</span></span><br><span class="line">   LambdaQueryWrapper&lt;OrderInfo&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">   queryWrapper.eq(OrderInfo::getId, orderId);</span><br><span class="line">   queryWrapper.eq(OrderInfo::getStatus, OrderStatus.WAITING_ACCEPT.getStatus());</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//修改字段</span></span><br><span class="line">   <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfo</span>();</span><br><span class="line">   orderInfo.setStatus(OrderStatus.ACCEPTED.getStatus());</span><br><span class="line">   orderInfo.setAcceptTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">   orderInfo.setDriverId(driverId);</span><br><span class="line">   <span class="type">int</span> <span class="variable">rows</span> <span class="operator">=</span> orderInfoMapper.update(orderInfo, queryWrapper);</span><br><span class="line">   <span class="keyword">if</span>(rows != <span class="number">1</span>) {</span><br><span class="line">      <span class="comment">//抢单失败</span></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.COB_NEW_ORDER_FAIL);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">//记录日志</span></span><br><span class="line">   <span class="built_in">this</span>.log(orderId, orderInfo.getStatus());</span><br><span class="line"></span><br><span class="line">   <span class="comment">//删除redis订单标识</span></span><br><span class="line">   redisTemplate.delete(RedisConstant.ORDER_ACCEPT_MARK);</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-fen-bu-shi-suo-ru-men">4、分布式锁入门</span></h3><h4><span id="4-1-ben-di-suo-de-ju-xian-xing">4.1、本地锁的局限性</span></h4><p>之前，我们学习过synchronized 及lock锁，这些锁都是本地锁。接下来写一个案例，演示本地锁的问题</p>
<h5><span id="4-1-1-bian-xie-ce-shi-dai-ma">4.1.1、编写测试代码</span></h5><p>在<code>service-order</code>中新建TestController中添加测试方法</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.order.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.common.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.order.service.TestService;</span><br><span class="line"><span class="keyword">import</span> io.swagger.v3.oas.annotations.tags.Tag;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Tag(name = "测试接口")</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/order/test")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TestService testService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("testLock")</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">testLock</span><span class="params">()</span> {</span><br><span class="line">        testService.testLock();</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p> 业务接口</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.order.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TestService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testLock</span><span class="params">()</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>业务实现类</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.order.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.order.service.TestService;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">TestService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLock</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 查询Redis中的num值</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> (String)<span class="built_in">this</span>.redisTemplate.opsForValue().get(<span class="string">"num"</span>);</span><br><span class="line">        <span class="comment">// 没有该值return</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(value)){</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 有值就转成成int</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> Integer.parseInt(value);</span><br><span class="line">        <span class="comment">// 把Redis中的num值+1</span></span><br><span class="line">        <span class="built_in">this</span>.redisTemplate.opsForValue().set(<span class="string">"num"</span>, String.valueOf(++num));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>说明</strong>：通过reids客户端设置num=0</p>
<h5><span id="4-1-3-shi-yong-ben-di-suo">4.1.3. 使用本地锁</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">testLock</span><span class="params">()</span> {</span><br><span class="line">   <span class="comment">// 查询Redis中的num值</span></span><br><span class="line">   <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> (String)<span class="built_in">this</span>.redisTemplate.opsForValue().get(<span class="string">"num"</span>);</span><br><span class="line">   <span class="comment">// 没有该值return</span></span><br><span class="line">   <span class="keyword">if</span> (StringUtils.isBlank(value)){</span><br><span class="line">      <span class="keyword">return</span> ;</span><br><span class="line">   }</span><br><span class="line">   <span class="comment">// 有值就转成成int</span></span><br><span class="line">   <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> Integer.parseInt(value);</span><br><span class="line">   <span class="comment">// 把Redis中的num值+1</span></span><br><span class="line">   <span class="built_in">this</span>.redisTemplate.opsForValue().set(<span class="string">"num"</span>, String.valueOf(++num));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-4-ben-di-suo-wen-ti-yan-shi-suo">4.1.4、本地锁问题演示锁</span></h5><p>接下来启动8205 8215 8225 三个运行实例，运行多个<code>service-order</code>实例：</p>
<p>server.port=8215</p>
<p>server.port=8225 </p>
<p>注意：bootstrap.properties 添加一个server.port = 8205; 将nacos的配置注释掉！</p>
<p>以上测试，可以发现：</p>
<p>本地锁只能锁住同一工程内的资源，在分布式系统里面都存在局限性。</p>
<p>此时需要分布式锁。。</p>
<h4><span id="4-2-fen-bu-shi-suo-shi-xian-de-jie-jue-fang-an">4.2 分布式锁实现的解决方案</span></h4><p>分布式锁主流的实现方案：</p>
<ol>
<li>基于数据库实现分布式锁</li>
<li>基于缓存（ Redis等）</li>
<li>基于Zookeeper</li>
</ol>
<p>每一种分布式锁解决方案都有各自的优缺点：</p>
<ol>
<li>性能：Redis最高 </li>
<li>可靠性：zookeeper最高</li>
</ol>
<p>因为Redis具备高性能、高可用、高并发的特性，这里，我们就基于Redis实现分布式锁。</p>
<p> 分布式锁的关键是**多进程共享的内存标记(锁)**，因此只要我们在Redis中放置一个这样的标记(数据)就可以了。不过在实现过程中，不要忘了我们需要实现下列目标：</p>
<ul>
<li><p><strong>多进程可见</strong>：多进程可见，否则就无法实现分布式效果</p>
</li>
<li><p><strong>避免死锁</strong>：死锁的情况有很多，我们要思考各种异常导致死锁的情况，保证锁可以被释放</p>
<p> 尝试获取锁</p>
<p>  成功：执行业务代码    执行业务  try（）{业务代码-宕机} catch() finally{ 释放锁}</p>
<p>  失败：等待；失效；下次</p>
</li>
<li><p><strong>排它</strong>：同一时刻，只能有一个进程获得锁</p>
</li>
<li><p><strong>高可用</strong>：避免锁服务宕机或处理好宕机的补救措施(redis集群架构：1.主从复制 2.哨兵 3.cluster集群)</p>
</li>
</ul>
<h4><span id="4-3-shi-yong-redis-shi-xian-fen-bu-shi-suo">4.3 使用Redis实现分布式锁</span></h4><p><img src="/2024/09/26/projection-daijia/wps010.jpg" alt="img"> </p>
<ol>
<li>多个客户端同时获取锁（setnx）</li>
<li>获取成功，执行业务逻辑{从db获取数据，放入缓存，执行完成释放锁（del）</li>
<li>其他客户端等待重试</li>
</ol>
<h5><span id="4-3-1-bian-xie-dai-ma">4.3.1. 编写代码</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 采用SpringDataRedis实现分布式锁</span></span><br><span class="line"><span class="comment"> * 原理：执行业务方法前先尝试获取锁（setnx存入key val），如果获取锁成功再执行业务代码，业务执行完毕后将锁释放(del key)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLock</span><span class="params">()</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">//0.先尝试获取锁 setnx key val</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(<span class="string">"lock"</span>, <span class="string">"lock"</span>);</span><br><span class="line">    <span class="keyword">if</span>(flag){</span><br><span class="line">        <span class="comment">//获取锁成功，执行业务代码</span></span><br><span class="line">        <span class="comment">//1.先从redis中通过key num获取值  key提前手动设置 num 初始值：0</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">"num"</span>);</span><br><span class="line">        <span class="comment">//2.如果值为空则非法直接返回即可</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(value)) {</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//3.对num值进行自增加一</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> Integer.parseInt(value);</span><br><span class="line">        stringRedisTemplate.opsForValue().set(<span class="string">"num"</span>, String.valueOf(++num));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4.将锁释放</span></span><br><span class="line">        stringRedisTemplate.delete(<span class="string">"lock"</span>);</span><br><span class="line"></span><br><span class="line">    }<span class="keyword">else</span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            Thread.sleep(<span class="number">100</span>);</span><br><span class="line">            <span class="built_in">this</span>.testLock();</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>重启，服务集群，通过网关压力测试：</p>
<figure class="highlight http"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ab -n 5000 -c 100 http://192.168.200.1/order/test/testLock  </span><br></pre></td></tr></tbody></table></figure>

<p>查看Redis中num的值：</p>
<p><img src="/2024/09/26/projection-daijia/wps012.jpg" alt="img"> </p>
<p>基本实现。</p>
<p>问题：setnx刚好获取到锁，业务逻辑出现异常，导致锁无法释放</p>
<p>解决：设置过期时间，自动释放锁。</p>
<h5><span id="4-3-2-you-hua-zhi-she-zhi-suo-de-guo-qi-shi-jian">4.3.2. 优化之设置锁的过期时间</span></h5><p>设置过期时间有两种方式：</p>
<ol>
<li>首先想到通过expire设置过期时间（缺乏原子性：如果在setnx和expire之间出现异常，锁也无法释放）</li>
<li>在set时指定过期时间（推荐）</li>
</ol>
<p><img src="/2024/09/26/projection-daijia/wps013.jpg" alt="img"> </p>
<p>设置过期时间：</p>
<p><img src="/2024/09/26/projection-daijia/wps014.jpg" alt="img"> </p>
<p>压力测试肯定也没有问题。自行测试</p>
<p>问题：可能会释放其他服务器的锁。</p>
<p>场景：如果业务逻辑的执行时间是7s。执行流程如下</p>
<ol>
<li><p>index1业务逻辑没执行完，3秒后锁被自动释放。</p>
</li>
<li><p>index2获取到锁，执行业务逻辑，3秒后锁被自动释放。</p>
</li>
<li><p>index3获取到锁，执行业务逻辑</p>
<p>. index1业务逻辑执行完成，开始调用del释放锁，这时释放的是index3的锁，	导致index3的业务只执行1s就被别人释放。</p>
</li>
</ol>
<p>最终等于没锁的情况。</p>
<p>解决：setnx获取锁时，设置一个指定的唯一值（例如：uuid）；释放前获取这个值，判断是否自己的锁</p>
<h5><span id="4-3-3-you-hua-zhi-uuid-fang-wu-shan">4.3.3. 优化之UUID防误删</span></h5><p><img src="/2024/09/26/projection-daijia/wps15.jpg" alt="img"> </p>
<p><img src="/2024/09/26/projection-daijia/wps16.jpg" alt="img"> </p>
<p>问题：删除操作缺乏原子性。</p>
<p>场景：</p>
<ol>
<li>index1执行删除时，查询到的lock值确实和uuid相等</li>
</ol>
<p><img src="/2024/09/26/projection-daijia/wps17.jpg" alt="img"> </p>
<ol>
<li>index1执行删除前，lock刚好过期时间已到，被Redis自动释放</li>
</ol>
<p>在Redis中没有了锁。</p>
<p><img src="/2024/09/26/projection-daijia/wps18.jpg" alt="img"> </p>
<ol>
<li>index2获取了lock,index2线程获取到了cpu的资源，开始执行方法</li>
<li>index1执行删除，此时会把index2的lock删除</li>
</ol>
<p>index1 因为已经在方法中了，所以不需要重新上锁。index1有执行的权限。index1已经比较完成了，这个时候，开始执行</p>
<p><img src="/2024/09/26/projection-daijia/wps19.jpg" alt="img"> </p>
<p>删除的index2的锁！</p>
<h5><span id="4-3-4-you-hua-zhi-lua-jiao-ben-bao-zheng-shan-chu-de-yuan-zi-xing">4.3.4. 优化之LUA脚本保证删除的原子性</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 采用SpringDataRedis实现分布式锁</span></span><br><span class="line"><span class="comment"> * 原理：执行业务方法前先尝试获取锁（setnx存入key val），如果获取锁成功再执行业务代码，业务执行完毕后将锁释放(del key)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLock</span><span class="params">()</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">//0.先尝试获取锁 setnx key val</span></span><br><span class="line">    <span class="comment">//问题：锁可能存在线程间相互释放</span></span><br><span class="line">    <span class="comment">//Boolean flag = stringRedisTemplate.opsForValue().setIfAbsent("lock", "lock", 10, TimeUnit.SECONDS);</span></span><br><span class="line">    <span class="comment">//解决：锁值设置为uuid</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(<span class="string">"lock"</span>, uuid, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(flag){</span><br><span class="line">        <span class="comment">//获取锁成功，执行业务代码</span></span><br><span class="line">        <span class="comment">//1.先从redis中通过key num获取值  key提前手动设置 num 初始值：0</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">"num"</span>);</span><br><span class="line">        <span class="comment">//2.如果值为空则非法直接返回即可</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(value)) {</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//3.对num值进行自增加一</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> Integer.parseInt(value);</span><br><span class="line">        stringRedisTemplate.opsForValue().set(<span class="string">"num"</span>, String.valueOf(++num));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4.将锁释放 判断uuid</span></span><br><span class="line">        <span class="comment">//问题：删除操作缺乏原子性。</span></span><br><span class="line">        <span class="comment">//if(uuid.equals(stringRedisTemplate.opsForValue().get("lock"))){ //线程一：判断是满足是当前线程锁的值</span></span><br><span class="line">        <span class="comment">//    //条件满足，此时锁正好到期，redis锁自动释放了线程2获取锁成功，线程1将线程2的锁删除</span></span><br><span class="line">        <span class="comment">//    stringRedisTemplate.delete("lock");</span></span><br><span class="line">        <span class="comment">//}</span></span><br><span class="line">        <span class="comment">//解决：redis执行lua脚本保证原子，lua脚本执行会作为一个整体执行</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//执行脚本参数 参数1：脚本对象封装lua脚本，参数二：lua脚本中需要key参数（KEYS[i]）  参数三：lua脚本中需要参数值 ARGV[i]</span></span><br><span class="line">        <span class="comment">//4.1 先创建脚本对象 DefaultRedisScript泛型脚本语言返回值类型 Long 0：失败 1：成功</span></span><br><span class="line">        DefaultRedisScript&lt;Long&gt; redisScript = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//4.2设置脚本文本</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">"if redis.call(\"get\",KEYS[1]) == ARGV[1]\n"</span> +</span><br><span class="line">                <span class="string">"then\n"</span> +</span><br><span class="line">                <span class="string">"    return redis.call(\"del\",KEYS[1])\n"</span> +</span><br><span class="line">                <span class="string">"else\n"</span> +</span><br><span class="line">                <span class="string">"    return 0\n"</span> +</span><br><span class="line">                <span class="string">"end"</span>;</span><br><span class="line">        redisScript.setScriptText(script);</span><br><span class="line">        <span class="comment">//4.3 设置响应类型</span></span><br><span class="line">        redisScript.setResultType(Long.class);</span><br><span class="line">        stringRedisTemplate.execute(redisScript, Arrays.asList(<span class="string">"lock"</span>), uuid);</span><br><span class="line">    }<span class="keyword">else</span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">//睡眠</span></span><br><span class="line">            Thread.sleep(<span class="number">100</span>);</span><br><span class="line">            <span class="comment">//自旋重试</span></span><br><span class="line">            <span class="built_in">this</span>.testLock();</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-3-5-zong-jie">4.3.5. 总结</span></h5><p>1、加锁</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 从Redis中获取锁,set k1 v1 px 20000 nx</span></span><br><span class="line"><span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line"><span class="type">Boolean</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.redisTemplate.opsForValue()</span><br><span class="line">      .setIfAbsent(<span class="string">"lock"</span>, uuid, <span class="number">2</span>, TimeUnit.SECONDS);</span><br></pre></td></tr></tbody></table></figure>

<p>2、使用lua释放锁</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2. 释放锁 del</span></span><br><span class="line"><span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> <span class="string">"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end"</span>;</span><br><span class="line"><span class="comment">// 设置lua脚本返回的数据类型</span></span><br><span class="line">DefaultRedisScript&lt;Long&gt; redisScript = <span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;&gt;();</span><br><span class="line"><span class="comment">// 设置lua脚本返回类型为Long</span></span><br><span class="line">redisScript.setResultType(Long.class);</span><br><span class="line">redisScript.setScriptText(script);</span><br><span class="line">redisTemplate.execute(redisScript, Arrays.asList(<span class="string">"lock"</span>),uuid);</span><br></pre></td></tr></tbody></table></figure>

<p>3、重试</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Thread.sleep(<span class="number">500</span>); </span><br><span class="line">testLock();</span><br></pre></td></tr></tbody></table></figure>

<p>为了确保分布式锁可用，我们至少要确保锁的实现同时满足以下四个条件：</p>
<ul>
<li>互斥性。在任意时刻，只有一个客户端能持有锁。</li>
<li>不会发生死锁。即使有一个客户端在持有锁的期间崩溃而没有主动解锁，也能保证后续其他客户端能加锁。</li>
<li>解铃还须系铃人。加锁和解锁必须是同一个客户端，客户端自己不能把别人加的锁给解了。</li>
<li>加锁和解锁必须具有原子性</li>
</ul>
<h4><span id="4-4-shi-yong-redisson-jie-jue-fen-bu-shi-suo">4.4 使用Redisson 解决分布式锁</span></h4><p>​	Redisson是一个在Redis的基础上实现的Java驻内存数据网格（In-Memory Data Grid）。它不仅提供了一系列的分布式的Java常用对象，还提供了许多分布式服务。其中包括(BitSet, Set, Multimap, SortedSet, Map, List, Queue, BlockingQueue, Deque, BlockingDeque, Semaphore, Lock, AtomicLong, CountDownLatch, Publish / Subscribe, Bloom filter, Remote service, Spring cache, Executor service, Live Object service, Scheduler service) Redisson提供了使用Redis的最简单和最便捷的方法。Redisson的宗旨是促进使用者对Redis的关注分离（Separation of Concern），从而让使用者能够将精力更集中地放在处理业务逻辑上。</p>
<p>官方文档地址：<a target="_blank" rel="noopener" href="https://github.com/Redisson/Redisson/wiki">https://github.com/Redisson/Redisson/wiki</a></p>
<p>Github 地址：<a target="_blank" rel="noopener" href="https://github.com/Redisson/Redisson">https://github.com/Redisson/Redisson</a></p>
<h5><span id="4-4-1-shi-xian-dai-ma">4.4.1 实现代码</span></h5><h6><span id="4-4-1-1-yin-ru-yi-lai">4.4.1.1、引入依赖</span></h6><p>父模块已经做了版本管理，直接引用</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h6><span id="4-4-1-2-pei-zhi-redissonclient">4.4.1.2、配置RedissonClient</span></h6><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.common.config.redssion;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.redisson.Redisson;</span><br><span class="line"><span class="keyword">import</span> org.redisson.api.RedissonClient;</span><br><span class="line"><span class="keyword">import</span> org.redisson.config.Config;</span><br><span class="line"><span class="keyword">import</span> org.redisson.config.SingleServerConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * redisson配置信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties("spring.data.redis")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonConfig</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">timeout</span> <span class="operator">=</span> <span class="number">3000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">ADDRESS_PREFIX</span> <span class="operator">=</span> <span class="string">"redis://"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自动装配</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    RedissonClient <span class="title function_">redissonSingle</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!StringUtils.hasText(host)){</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"host is  empty"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="type">SingleServerConfig</span> <span class="variable">serverConfig</span> <span class="operator">=</span> config.useSingleServer()</span><br><span class="line">                .setAddress(ADDRESS_PREFIX + <span class="built_in">this</span>.host + <span class="string">":"</span> + port)</span><br><span class="line">                .setTimeout(<span class="built_in">this</span>.timeout);</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.hasText(<span class="built_in">this</span>.password)) {</span><br><span class="line">            serverConfig.setPassword(<span class="built_in">this</span>.password);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>注意</strong>：这里读取了一个名为RedisProperties的属性，因为我们引入了SpringDataRedis，Spring已经自动加载了RedisProperties，并且读取了配置文件中的Redis信息。</p>
<h6><span id="4-4-1-3-xiu-gai-shi-xian-lei">4.4.1.3、修改实现类</span></h6><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用Redison实现分布式锁</span></span><br><span class="line"><span class="comment"> * 开发步骤：</span></span><br><span class="line"><span class="comment"> * 1.使用RedissonClient客户端对象 创建锁对象</span></span><br><span class="line"><span class="comment"> * 2.调用获取锁方法</span></span><br><span class="line"><span class="comment"> * 3.执行业务逻辑</span></span><br><span class="line"><span class="comment"> * 4.将锁释放</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testLock</span><span class="params">()</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">//0.创建锁对象</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">"lock1"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//0.1 尝试加锁</span></span><br><span class="line">    <span class="comment">//0.1.1 lock() 阻塞等待一直到获取锁,默认锁有效期30s</span></span><br><span class="line">    lock.lock();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.先从redis中通过key num获取值  key提前手动设置 num 初始值：0</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">"num"</span>);</span><br><span class="line">    <span class="comment">//2.如果值为空则非法直接返回即可</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(value)) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"> }</span><br><span class="line">    <span class="comment">//3.对num值进行自增加一</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> Integer.parseInt(value);</span><br><span class="line">    stringRedisTemplate.opsForValue().set(<span class="string">"num"</span>, String.valueOf(++num));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4.将锁释放</span></span><br><span class="line">    lock.unlock();</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p>基于Redis的Redisson分布式可重入锁RLock Java对象实现了java.util.concurrent.locks.Lock接口。</p>
<p>大家都知道，如果负责储存这个分布式锁的Redisson节点宕机以后，而且这个锁正好处于锁住的状态时，这个锁会出现锁死的状态。为了避免这种情况的发生，Redisson内部提供了一个监控锁的看门狗，它的作用是在Redisson实例被关闭前，不断的延长锁的有效期。默认情况下，看门狗的检查锁的超时时间是30秒钟，也可以通过修改Config.lockWatchdogTimeout来另行指定。</p>
<p>另外Redisson还通过加锁的方法提供了leaseTime的参数来指定加锁的时间。超过这个时间后锁便自动解开了。</p>
<p> 看门狗原理:</p>
<p>只要线程一加锁成功，就会启动一个<code>watch dog</code>看门狗，它是一个后台线程，会每隔<code>10</code>秒检查一下，如果线程一还持有锁，那么就会不断的延长锁<code>key</code>的生存时间。因此，<code>Redisson</code>就是使用<code>Redisson</code>解决了锁过期释放，业务没执行完问题。</p>
<blockquote>
<p>1、如果我们指定了锁的超时时间，就发送给Redis执行脚本，进行占锁，默认超时就是我们制定的时间，不会自动续期；<br>2、如果我们未指定锁的超时时间，就使用 <code>lockWatchdogTimeout = 30 * 1000</code> 【看门狗默认时间】 </p>
</blockquote>
<h3><span id="5-ji-yu-redisson-fen-bu-shi-jie-jue-si-ji-qiang-dan">5、基于Redisson分布式解决司机抢单</span></h3><p>操作模块：service-util，我们把redisson配置在这里，后续其他微服务模块可以直接使用</p>
<h4><span id="5-1-orderinfoserviceimpl">5.1、OrderInfoServiceImpl</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">robNewOrder</span><span class="params">(Long driverId, Long orderId)</span> {</span><br><span class="line">   <span class="comment">//抢单成功或取消订单，都会删除该key，redis判断，减少数据库压力</span></span><br><span class="line">   <span class="keyword">if</span>(!redisTemplate.hasKey(RedisConstant.ORDER_ACCEPT_MARK)) {</span><br><span class="line">      <span class="comment">//抢单失败</span></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.COB_NEW_ORDER_FAIL);</span><br><span class="line">   }</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// 初始化分布式锁，创建一个RLock实例</span></span><br><span class="line">   <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(RedisConstant.ROB_NEW_ORDER_LOCK + orderId);</span><br><span class="line">   <span class="keyword">try</span> {</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * TryLock是一种非阻塞式的分布式锁，实现原理：Redis的SETNX命令</span></span><br><span class="line"><span class="comment">       * 参数：</span></span><br><span class="line"><span class="comment">       *     waitTime：等待获取锁的时间</span></span><br><span class="line"><span class="comment">       *     leaseTime：加锁的时间</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> lock.tryLock(RedisConstant.ROB_NEW_ORDER_LOCK_WAIT_TIME,RedisConstant.ROB_NEW_ORDER_LOCK_LEASE_TIME, TimeUnit.SECONDS);</span><br><span class="line">      <span class="comment">//获取到锁</span></span><br><span class="line">      <span class="keyword">if</span> (flag){</span><br><span class="line">         <span class="comment">//二次判断，防止重复抢单</span></span><br><span class="line">         <span class="keyword">if</span>(!redisTemplate.hasKey(RedisConstant.ORDER_ACCEPT_MARK)) {</span><br><span class="line">            <span class="comment">//抢单失败</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.COB_NEW_ORDER_FAIL);</span><br><span class="line">         }</span><br><span class="line"></span><br><span class="line">         <span class="comment">//修改订单状态</span></span><br><span class="line">         <span class="comment">//update order_info set status = 2, driver_id = #{driverId} where id = #{id}</span></span><br><span class="line">         <span class="comment">//修改字段</span></span><br><span class="line">         <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfo</span>();</span><br><span class="line">         orderInfo.setId(orderId);</span><br><span class="line">         orderInfo.setStatus(OrderStatus.ACCEPTED.getStatus());</span><br><span class="line">         orderInfo.setAcceptTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">         orderInfo.setDriverId(driverId);</span><br><span class="line">         <span class="type">int</span> <span class="variable">rows</span> <span class="operator">=</span> orderInfoMapper.updateById(orderInfo);</span><br><span class="line">         <span class="keyword">if</span>(rows != <span class="number">1</span>) {</span><br><span class="line">            <span class="comment">//抢单失败</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.COB_NEW_ORDER_FAIL);</span><br><span class="line">         }</span><br><span class="line"></span><br><span class="line">         <span class="comment">//记录日志</span></span><br><span class="line">         <span class="built_in">this</span>.log(orderId, orderInfo.getStatus());</span><br><span class="line"></span><br><span class="line">         <span class="comment">//删除redis订单标识</span></span><br><span class="line">         redisTemplate.delete(RedisConstant.ORDER_ACCEPT_MARK);</span><br><span class="line">      }</span><br><span class="line">   } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">      <span class="comment">//抢单失败</span></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.COB_NEW_ORDER_FAIL);</span><br><span class="line">   } <span class="keyword">finally</span> {</span><br><span class="line">      <span class="keyword">if</span>(lock.isLocked()) {</span><br><span class="line">         lock.unlock();</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h1><span id="viii-fen-bu-shi-shi-wu">Ⅷ.分布式事务</span></h1><h2><span id="yi-fen-bu-shi-shi-wu-seata">一、分布式事务Seata</span></h2><h3><span id="1-shi-wu-hui-gu">1、事务回顾</span></h3><h4><span id="1-1-shi-me-shi-shi-wu">1.1、什么是事务</span></h4><p><strong>提供一种“要么什么都不做，要么做全套（All or Nothing）”机制。</strong></p>
<h4><span id="1-2-shi-wu-de-zuo-yong">1.2、事务的作用</span></h4><p><strong>保证数据一致性</strong></p>
<h4><span id="1-3-shi-wu-acid-si-da-te-xing">1.3、事务ACID四大特性</span></h4><p><strong>A：原子性(Atomicity)</strong></p>
<p>一个事务(transaction)中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被回滚（Rollback）到事务开始前的状态，就像这个事务从来没有执行过一样。</p>
<p><strong>C：一致性(Consistency)</strong></p>
<p>事务的一致性指的是在一个事务执行之前和执行之后数据库都必须处于一致性状态。</p>
<p>如果事务成功地完成，那么系统中所有变化将正确地应用，系统处于有效状态。</p>
<p>如果在事务中出现错误，那么系统中的所有变化将自动地回滚，系统返回到原始状态。</p>
<p><strong>I：隔离性(Isolation)</strong></p>
<p>指的是在并发环境中，当不同的事务同时操纵相同的数据时，每个事务都有各自的完整数据空间。由并发事务所做的修改必须与任何其他并发事务所做的修改隔离。事务查看数据更新时，数据所处的状态要么是另一事务修改它之前的状态，要么是另一事务修改它之后的状态，事务不会查看到中间状态的数据。</p>
<p><strong>D：持久性(Durability)</strong></p>
<p>指的是只要事务成功结束，它对数据库所做的更新就必须保存下来。即使发生系统崩溃，重新启动数据库系统后，数据库还能恢复到事务成功结束时的状态。</p>
<h4><span id="1-4-shi-wu-de-bing-fa-wen-ti">1.4、事务的并发问题</span></h4><p><strong>脏读****：</strong> ​</p>
<p>事务A读取了事务B更新的数据，事务B未提交并回滚数据，那么A读取到的数据是脏数据</p>
<p><strong>不可重复读****：</strong> ​</p>
<p>事务 A 多次读取同一数据，事务 B 在事务A多次读取的过程中，对数据作了更新并提交，导致事务A多次读取同一数据时，结果 不一致。</p>
<p><strong>幻读****：</strong> ​</p>
<p>系统管理员A将数据库中所有学生的成绩从具体分数改为ABCDE等级，但是系统管理员B就在这个时候插入了一条具体分数的记录，当系统管理员A更改结束后发现还有一条记录没有改过来，就好像发生了幻觉一样，这就叫幻读。</p>
<p>　　小结：不可重复读的和幻读很容易混淆，不可重复读侧重于修改，幻读侧重于新增或删除。解决不可重复读的问题只需锁住满足条件的行，解决幻读需要锁表。</p>
<h4><span id="1-5-mysql-shi-wu-ge-chi-ji-bie">1.5、MySQL事务隔离级别</span></h4><table>
<thead>
<tr>
<th>事务隔离级别
</th>
<th>脏读
</th>
<th>不可重复读
</th>
<th>幻读
</th>
</tr>
</thead>
<tbody><tr>
<td>读未提交（read-uncommitted）
</td>
<td>√
</td>
<td>√
</td>
<td>√
</td>
</tr>
<tr>
<td>读已提交（read-committed）
</td>
<td>×
</td>
<td>√
</td>
<td>√
</td>
</tr>
<tr>
<td>可重复读（repeatable-read）
</td>
<td>×
</td>
<td>×
</td>
<td>√
</td>
</tr>
<tr>
<td>串行化（serializable）
</td>
<td>×
</td>
<td>×
</td>
<td>×
</td>
</tr>
</tbody></table>
<p>mysql默认的事务隔离级别为repeatable-read</p>
<p><img src="/2024/09/26/projection-daijia/image_DBSapxVIGA.png"></p>
<h4><span id="1-6-shi-wu-chuan-bo-xing-wei-propagation-behavior">1.6、事务传播行为（propagation behavior）</span></h4><p>指的就是当一个事务方法被另一个事务方法调用时，这个事务方法应该如何进行。&nbsp;<br>例如：methodA事务方法调用methodB事务方法时，methodB是继续在调用者methodA的事务中运行呢，还是为自己开启一个新事务运行，这就是由methodB的事务传播行为决定的。</p>
<p>Spring定义了七种传播行为：参考 TransactionDefinition类</p>
<table>
<thead>
<tr>
<th><strong>事务传播行为类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>PROPAGATION_REQUIRED
</td>
<td>如果当前没有事务，就新建一个事务，如果已经存在一个事务中，加入到这个事务中。默认
</td>
</tr>
<tr>
<td>PROPAGATION_SUPPORTS
</td>
<td>支持当前事务，如果当前没有事务，就以非事务方式执行
</td>
</tr>
<tr>
<td>PROPAGATION_MANDATORY
</td>
<td>使用当前的事务，如果当前没有事务，就抛出异常。
</td>
</tr>
<tr>
<td>PROPAGATION_REQUIRES_NEW
</td>
<td>新建事务，如果当前存在事务，把当前事务挂起。（一个新的事务将启动，而且如果有一个现有的事务在运行的话，则这个方法将在运行期被挂起，直到新的事务提交或者回滚才恢复执行）
</td>
</tr>
<tr>
<td>PROPAGATION_NOT_SUPPORTED
</td>
<td>以非事务方式执行操作，如果当前存在事务，就把当前事务挂起。
</td>
</tr>
<tr>
<td>PROPAGATION_NEVER
</td>
<td>以非事务方式执行，如果当前存在事务，则抛出异常。
</td>
</tr>
<tr>
<td>PROPAGATION_NESTED
</td>
<td>如果当前存在事务，则在嵌套事务内执行。如果当前没有事务，则执行与PROPAGATION_REQUIRED类似的操作。（外层事务抛出异常回滚，那么内层事务必须回滚，反之内层事务并不影响外层事务）
</td>
</tr>
</tbody></table>
<h4><span id="1-7-ben-di-shi-wu">1.7、本地事务</span></h4><p>本地事务也称为*数据库事务*或*传统事务*（相对于分布式事务而言）。它的执行模式就是常见的：</p>
<table>
<thead>
<tr>
<th>*<em>1. transaction begin</em><em><strong>2. insert/delete/update</strong></em><em>3. insert/delete/update</em>***4. …**<strong>5. transaction commit/rollback</strong></th>
</tr>
</thead>
</table>
<ul>
<li>本地事务有这么几个特征:<ul>
<li>一次事务只连接一个支持事务的数据库（一般来说都是关系型数据库）</li>
<li>事务的执行结果保证ACID</li>
<li>会用到数据库锁</li>
</ul>
</li>
<li>起初，事务仅限于对单一数据库资源的访问控制，架构服务化以后，事务的概念延伸到了服务中。倘若将一个单一的服务操作作为一个事务，那么整个服务操作只能涉及一个单一的数据库资源，这类<strong>基于</strong>单个服务单一数据库**资源访问的事务，被称为本地事务(Local Transaction)**。</li>
</ul>
<p><img src="/2024/09/26/projection-daijia/image_1_2bmRgG83FM.png"></p>
<h3><span id="2-fen-bu-shi-shi-wu">2、分布式事务</span></h3><h4><span id="2-1-wei-fu-wu-fen-bu-shi-shi-wu-wen-ti">2.1、微服务分布式事务问题</span></h4><ul>
<li>首先，传统的<strong>单体应用（Monolithic App）</strong>，通过 3 个 Module，在同一个数据源上更新数据来完成一项业务。很自然的，整个业务过程的<strong>数据一致性</strong>由<strong>本地事务</strong>来保证。</li>
</ul>
<p><img src="/2024/09/26/projection-daijia/image_2_ZS5EDNceeo.png"></p>
<ul>
<li>随着业务需求和架构的变化，<strong>单体应用被拆分为微服务</strong>：原来的 3 个 Module 被拆分为 3 个独立的服务，分别使用独立的数据源。业务过程将由 3 个服务的调用来完成。</li>
</ul>
<p><img src="/2024/09/26/projection-daijia/image_3_uRp3PBs3Ka.png"></p>
<ul>
<li>此时，每一个服务内部的数据一致性仍由本地事务来保证。而整个业务层面的全局数据一致性要如何保障呢？这就是微服务架构下面临的，典型的分布式事务需求：我们需要一个分布式事务的解决方案保障业务全局的数据一致性。</li>
</ul>
<p><img src="/2024/09/26/projection-daijia/image_4_l0qm0VIoEj.png"></p>
<h4><span id="2-2-shi-me-shi-fen-bu-shi-shi-wu">2.2、什么是分布式事务</span></h4><p>分布式事务指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的分布式系统的不同节点之上。</p>
<p>指一次大的操作由不同的小操作组成的，这些小的操作分布在不同的服务器上，分布式事务需要保证这些小操作要么全部成功，要么全部失败。</p>
<p>本质上来说，分布式事务就是为了保证不同数据库的数据一致性。</p>
<h4><span id="2-3-shi-me-shi-fen-bu-shi-xi-tong">2.3、什么是分布式系统</span></h4><ul>
<li>部署在不同节点上的系统通过网络交互来完成协同工作的系统。</li>
<li>比如：<ul>
<li>充值加积分的业务，用户在充值系统向自己的账户充钱，在积分系统中自己积分相应的增加。</li>
<li>充值系统和积分系统是两个不同的系统，一次充值加积分的业务就需要这两个系统协同工作来完成。</li>
</ul>
</li>
</ul>
<h4><span id="2-4-fen-bu-shi-shi-wu-ying-yong-zai-na-xie-chang-jing">2.4、分布式事务应用在哪些场景</span></h4><ul>
<li>电商系统中的下单扣库存</li>
</ul>
<p>电商系统中，<strong>订单系统</strong>和<strong>库存系统</strong>是两个系统，一次下单的操作由两个系统协同完成</p>
<ul>
<li>金融系统中的银行卡充值</li>
</ul>
<p>在金融系统中通过银行卡向平台充值需要通过<strong>银行系统</strong>和<strong>金融系统</strong>协同完成。</p>
<ul>
<li>教育系统中下单选课业务</li>
</ul>
<p>在线教育系统中，用户购买课程，下单支付成功后学生选课成功，此事务由<strong>订单系统</strong>和<strong>选课系统</strong>协同完成。</p>
<ul>
<li>SNS系统的消息发送</li>
</ul>
<p>在社交系统中发送站内消息同时发送手机短信，一次消息发送由<strong>站内消息系统</strong>和<strong>手机通信系统</strong>协同完成。</p>
<h4><span id="2-5-kua-duo-fu-wu-duo-shu-ju-ku-de-fen-bu-shi-shi-wu">2.5、跨多服务多数据库的分布式事务</span></h4><p>一个服务操作调用另一个服务，这时事务需要跨越多个服务。在这种情况下，起始服务的事务在调用另外一个服务的时候，需要以某种机制流转到另外一个服务，从而使被调用的服务访问的资源也自动加入到该事务当中来。这就需要跨服务跨数据库的全局事务进行数据一致性的保证。</p>
<p><img src="/2024/09/26/projection-daijia/image_5_t3E5cx2soD.png"></p>
<p>较之基于单一数据库资源访问的本地事务，分布式事务的应用架构更为复杂。在不同的分布式应用架构下，实现一个分布式事务要考虑的问题并不完全一样，比如对多资源的协调、事务的跨服务传播等，实现机制也是复杂多变。</p>
<h3><span id="3-fen-bu-shi-shi-wu-jie-jue-fang-an">3、分布式事务解决方案</span></h3><p>1.XA两段提交(低效率)-分布式事务解决方案</p>
<p>2.TCC三段提交(2段,高效率[不推荐(补偿代码)])</p>
<p>3.本地消息(MQ+Table)</p>
<p>4.Seata(alibaba)</p>
<h4><span id="3-1-ji-yu-xa-xie-yi-de-liang-jie-duan-ti-jiao-2pc">3.1、基于XA协议的两阶段提交(2PC)</span></h4><p>X/Open 组织（即现在的 Open Group ）定义了分布式事务处理模型</p>
<p>XA协议：XA是一个分布式事务协议。XA中大致分为两部分：<strong>事务管理器</strong>和<strong>本地资源管理器</strong>。其中本地资源管理器往往由数据库实现，比如Oracle、DB2这些商业数据库都实现了XA接口，而事务管理器作为全局的调度者，负责各个本地资源的提交和回滚。</p>
<h5><span id="3-1-1-gai-nian">3.1.1、概念</span></h5><p>二阶段提交2PC（Two phase Commit）是指，在分布式系统里，为了保证所有节点在进行事务提交时保持一致性的一种算法。</p>
<h5><span id="3-1-2-bei-jing">3.1.2、背景</span></h5><p>在分布式系统里，**每个节点都可以知晓自己操作的成功或者失败，却无法知道其他节点操作的成功或失败。**</p>
<p>当一个事务跨多个节点时，为了保持事务的原子性与一致性，需要引入一个**协调者**（Coordinator）来统一掌控所有**参与者**（Participant）的操作结果，并指示它们是否要把操作结果进行真正的提交（commit）或者回滚（rollback）。</p>
<h5><span id="3-1-3-si-lu">3.1.3、思路</span></h5><p>2PC顾名思义分为两个阶段，其实施思路可概括为：</p>
<p>（1）投票阶段（voting phase）：参与者将操作结果通知协调者；</p>
<p>（2）提交阶段（commit phase）：收到参与者的通知后，协调者再向参与者发出通知，根据反馈情况决定各参与者是否要提交还是回滚；</p>
<h5><span id="3-1-4-que-xian">3.1.4、缺陷</span></h5><p>算法执行过程中，**所有节点都处于阻塞状态，所有节点所持有的资源（例如数据库数据，本地文件等）都处于封锁状态。**</p>
<p>典型场景为：</p>
<p>（1）某一个参与者发出通知之前，所有参与者以及协调者都处于阻塞状态；</p>
<p>（2）在协调者发出通知之前，所有参与者都处于阻塞状态；</p>
<p>另外，如有协调者或者某个参与者出现了崩溃，为了避免整个算法处于一个完全阻塞状态，往往需要借助超时机制来将算法继续向前推进，故此时算法的效率比较低。</p>
<p>总的来说，**2PC是一种比较保守的算法**。</p>
<h5><span id="3-1-5-ju-li">3.1.5、举例</span></h5><p>甲乙丙丁四人要组织一个会议，需要确定会议时间，不妨设甲是协调者，乙丙丁是参与者。</p>
<p><strong>投票阶段：</strong></p>
<p>（1）甲发邮件给乙丙丁，周二十点开会是否有时间；</p>
<p>（2）甲回复有时间；</p>
<p>（3）乙回复有时间；</p>
<p>（4）丙迟迟不回复，此时对于这个活动，甲乙丙均处于阻塞状态，算法无法继续进行；</p>
<p>（5）丙回复有时间（或者没有时间）；</p>
<p><strong>提交阶段：</strong></p>
<p>（1）协调者甲将收集到的结果反馈给乙丙丁（什么时候反馈，以及反馈结果如何，在此例中取决与丙的时间与决定）；</p>
<p>（2）乙收到；</p>
<p>（3）丙收到；</p>
<p>（4）丁收到；</p>
<h5><span id="3-1-6-jie-lun">3.1.6、结论</span></h5><p>2PC效率很低，分布式事务很难做</p>
<h5><span id="3-1-7-shi-ji-ying-yong-jiao-hu-liu-cheng">3.1.7、实际应用交互流程</span></h5><h6><span id="2pc-liang-jie-duan-ti-jiao-de-zheng-xiang-liu-cheng">2PC两阶段提交的正向流程</span></h6><p><strong>第一阶段：</strong></p>
<p>2PC中包含着两个角色：**事务协调者**和**事务参与者**。让我们来看一看他们之间的交互流程：</p>
<p><img src="/2024/09/26/projection-daijia/image_6_5fJBL98sLM.png"></p>
<p>在分布式事务的第一阶段，作为事务协调者的节点会首先向所有的参与者节点发送Prepare请求。</p>
<p>在接到Prepare请求之后，每一个参与者节点会各自执行与事务有关的数据更新，写入Undo Log和Redo Log。如果参与者执行成功，暂时不提交事务，而是向事务协调节点返回“完成”消息。</p>
<p>当事务协调者接到了所有参与者的返回消息，整个分布式事务将会进入第二阶段。</p>
<p><strong>第二阶段：</strong></p>
<p><img src="/2024/09/26/projection-daijia/image_7_31p4P-FIYl.png"></p>
<p>在2PC分布式事务的第二阶段，如果事务协调节点在之前所收到都是正向返回，那么它将会向所有事务参与者发出Commit请求。</p>
<p>接到Commit请求之后，事务参与者节点会各自进行本地的事务提交，并释放锁资源。当本地事务完成提交后，将会向事务协调者返回“完成”消息。</p>
<p>当事务协调者接收到所有事务参与者的“完成”反馈，整个分布式事务完成。</p>
<h6><span id="shi-bai-qing-kuang-de-chu-li-liu-cheng">失败情况的处理流程</span></h6><p><strong>第一阶段：</strong></p>
<p><img src="/2024/09/26/projection-daijia/image_8_Ueo-7XP2YE.png"></p>
<p><strong>第二阶段：</strong></p>
<p><img src="/2024/09/26/projection-daijia/image_9_XSy1jA8dpt.png"></p>
<p>在2PC的第一阶段，如果某个事务参与者反馈失败消息，说明该节点的本地事务执行不成功，必须回滚。</p>
<p>于是在第二阶段，事务协调节点向所有的事务参与者发送Abort(中止)请求。接收到Abort请求之后，各个事务参与者节点需要在本地进行事务的回滚操作，回滚操作依照Undo Log来进行。</p>
<p>以上就是2PC两阶段提交协议的详细过程。</p>
<h6><span id="2pc-liang-jie-duan-ti-jiao-jiu-jing-you-na-xie-bu-zu-ni">2PC两阶段提交究竟有哪些不足呢？</span></h6><ol>
<li><strong>性能问题</strong></li>
</ol>
<p>2PC遵循强一致性。在事务执行过程中，各个节点占用着数据库资源，只有当所有节点准备完毕，事务协调者才会通知提交，参与者提交后释放资源。这样的过程有着非常明显的性能问题。</p>
<ol>
<li><strong>协调者单点故障问题</strong></li>
</ol>
<p>2PC模型的核心，一旦事务协调者节点挂掉，参与者收不到提交或是回滚通知，参与者会一直处于中间状态无法完成事务。</p>
<ol>
<li><strong>丢失消息导致的不一致问题。</strong></li>
</ol>
<p>第二个阶段，如果发生局部网络问题，一部分事务参与者收到了提交消息，另一部分事务参与者没收到提交消息，那么就导致了节点之间数据的不一致。</p>
<h4><span id="3-2-dai-ma-bu-chang-shi-wu-tcc">3.2、代码补偿事务(TCC）</span></h4><p>TCC的作用主要是解决跨服务调用场景下的分布式事务问题</p>
<h5><span id="3-2-1-chang-jing-an-li">3.2.1、场景案例</span></h5><p>以航班预定的案例，来介绍TCC要解决的事务场景。在这里笔者虚构一个场景，把自己当做航班预定的主人公，来介绍这个案例。从合肥 –&gt; 昆明 –&gt; 大理。</p>
<p>准备从合肥出发，到云南大理去游玩，然后使用美团App(机票代理商)来订机票。发现没有从合肥直达大理的航班，需要到昆明进行中转。如下图：</p>
<p><img src="/2024/09/26/projection-daijia/image_10_veUMpNEaN8.png"></p>
<p>从图中我们可以看出来，从合肥到昆明乘坐的是四川航空，从昆明到大理乘坐的是东方航空。</p>
<p> 由于使用的是美团App预定，当我选择了这种航班预定方案后，美团App要去四川航空和东方航空各帮我购买一张票。如下图：</p>
<p><img src="/2024/09/26/projection-daijia/image_11_dorvIpjgPi.png"></p>
<p>考虑最简单的情况：美团先去川航帮我买票，如果买不到，那么东航也没必要买了。如果川航购买成功，再去东航购买另一张票。</p>
<p> 现在问题来了：假设美团先从川航成功买到了票，然后去东航买票的时候，因为天气问题，东航航班被取消了。那么此时，美团必须取消川航的票，因为只有一张票是没用的，不取消就是浪费我的钱。那么如果取消会怎样呢？如果读者有取消机票经历的话，非正常退票，肯定要扣手续费的。在这里，川航本来已经购买成功，现在因为东航的原因要退川航的票，川航应该是要扣代理商的钱的。</p>
<p> 那么美团就要保证，如果任一航班购买失败，都不能扣钱，怎么做呢？</p>
<p> 两个航空公司都为美团提供以下3个接口：<strong>机票预留接口、确认接口、取消接口</strong>。美团App分2个阶段进行调用，如下所示：</p>
<p><img src="/2024/09/26/projection-daijia/image_12_69i9kjZ-Mo.png"></p>
<p><strong>在第1阶段：</strong></p>
<p>美团分别请求两个航空公司预留机票，两个航空公司分别告诉美团预留成功还是失败。航空公司需要保证，机票预留成功的话，之后一定能购买到。</p>
<p><strong>在第2阶段：</strong></p>
<p>如果两个航空公司都预留成功，则分别向两个公司发送确认购买请求。</p>
<p>如果两个航空公司任意一个预留失败，则对于预留成功的航空公司也要取消预留。这种情况下，对于之前预留成功机票的航班取消，也不会扣用户的钱，因为购买并没实际发生，之前只是请求预留机票而已。</p>
<p>通过这种方案，可以保证两个航空公司购买机票的一致性，要不都成功，要不都失败，即使失败也不会扣用户的钱。如果在两个航班都已经已经确认购买后，再退票，那肯定还是要扣钱的。</p>
<p>当然，实际情况肯定这里提到的肯定要复杂，通常航空公司在第一阶段，对于预留的机票，会要求在指定的时间必须确认购买(支付成功)，如果没有及时确认购买，会自动取消。假设川航要求10分钟内支付成功，东航要求30分钟内支付成功。以较短的时间算，如果用户在10分钟内支付成功的话，那么美团会向两个航空公司都发送确认购买的请求，如果超过10分钟(以较短的时间为准)，那么就不能进行支付。</p>
<p>这个方案提供给我们一种跨服务保证事务一致性的一种解决思路，可以把这种方案当做TCC的雏形。</p>
<p>具体流程：</p>
<p><img src="/2024/09/26/projection-daijia/image_13_eeaoEFRsEj.png"></p>
<p>TCC是Try ( 尝试 ) — Confirm(确认) — Cancel ( 取消 ) 的简称:</p>
<table>
<thead>
<tr>
<th><strong>操作方法</strong></th>
<th><strong>含义</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Try
</td>
<td>完成所有业务检查（一致性），预留业务资源(准隔离性) 回顾上面航班预定案例的阶段1，机票就是业务资源，所有的资源提供者(航空公司)预留都成功，try阶段才算成功
</td>
</tr>
<tr>
<td>Confirm
</td>
<td>确认执行业务操作，不做任何业务检查， 只使用Try阶段预留的业务资源。回顾上面航班预定案例的阶段2，美团APP确认两个航空公司机票都预留成功，因此向两个航空公司分别发送确认购买的请求。
</td>
</tr>
<tr>
<td>Cancel
</td>
<td>取消Try阶段预留的业务资源。回顾上面航班预定案例的阶段2，如果某个业务方的业务资源没有预留成功，则取消所有业务资源预留请求。
</td>
</tr>
</tbody></table>
<h5><span id="3-2-2-tcc-liang-jie-duan-ti-jiao-yu-xa-liang-jie-duan-ti-jiao-de-qu-bie">3.2.2、TCC两阶段提交与XA两阶段提交的区别</span></h5><p>&nbsp;XA是资源层面的分布式事务，强一致性，在两阶段提交的整个过程中，一直会持有资源的锁。</p>
<p>TCC是业务层面的分布式事务，最终一致性，不会一直持有资源的锁。</p>
<p>其核心在于将业务分为两个操作步骤完成。不依赖 RM 对分布式事务的支持，而是通过对业务逻辑的分解来实现分布式事务。</p>
<h4><span id="3-3-ben-di-xiao-xi-biao-yi-bu-que-bao-shi-wu-zui-zhong-yi-zhi-xing">3.3、本地消息表（异步确保）- 事务最终一致性</span></h4><p>这种实现方式的思路，其实是源于 ebay，后来通过支付宝等公司的布道，在业内广泛使用。**其基本的设计思想是将远程分布式事务拆分成一系列的本地事务**。如果不考虑性能及设计优雅，借助关系型数据库中的表即可实现。</p>
<ul>
<li>订单系统新增一条消息表，将新增订单和新增消息放到一个事务里完成，然后通过轮询的方式去查询消息表，将消息推送到 MQ，库存系统去消费 MQ。</li>
</ul>
<p><img src="/2024/09/26/projection-daijia/image_14_QGUcikslqc.png"></p>
<ul>
<li>执行流程：<ul>
<li>订单系统，添加一条订单和一条消息，在一个事务里提交。</li>
<li>订单系统，使用定时任务轮询查询状态为未同步的消息表，发送到 MQ，如果发送失败，就重试发送。</li>
<li>库存系统，接收 MQ 消息，修改库存表，需要保证幂等操作。</li>
<li>如果修改成功，调用 RPC 接口修改订单系统消息表的状态为已完成或者直接删除这条消息。</li>
<li>如果修改失败，可以不做处理，等待重试。</li>
</ul>
</li>
<li>订单系统中的消息有可能由于业务问题会一直重复发送，所以为了避免这种情况可以记录一下发送次数，当达到次数限制之后报警，人工接入处理；库存系统需要保证幂等，避免同一条消息被多次消费造成数据一致。</li>
<li>本地消息表这种方案实现了最终一致性，需要在业务系统里增加消息表，业务逻辑中多一次插入的 DB 操作，所以性能会有损耗，而且最终一致性的间隔主要由定时任务的间隔时间决定。</li>
<li>优点：&nbsp;一种非常经典的实现，避免了分布式事务，实现了最终一致性。</li>
<li>缺点：&nbsp;消息表会耦合到业务系统中，如果没有封装好的解决方案，会有很多杂活需要处理。</li>
</ul>
<h4><span id="3-4-seata-jie-shao">3.4、Seata介绍</span></h4><p><a target="_blank" rel="noopener" href="http://seata.io/zh-cn/" title="http://seata.io/zh-cn/">http://seata.io/zh-cn/</a></p>
<p><strong>Seata</strong>是阿里开源的一个分布式事务框架，能够让大家在操作分布式事务时，像操作本地事务一样简单。一个注解搞定分布式事务。</p>
<p><strong>解决分布式事务问题，有两个设计初衷</strong></p>
<ul>
<li><strong>对业务无侵入</strong>：即减少技术架构上的微服务化所带来的分布式事务问题对业务的侵入</li>
<li><strong>高性能</strong>：减少分布式事务解决方案所带来的性能消耗</li>
</ul>
<p><strong>Seata中有两种分布式事务实现方案，AT及TCC</strong></p>
<ul>
<li>AT模式主要关注多 DB 访问的数据一致性，当然也包括多服务下的多 DB 数据访问一致性问题 2PC-改进</li>
<li>TCC 模式主要关注业务拆分，在按照业务横向扩展资源时，解决微服务间调用的一致性问题</li>
</ul>
<p><strong>那 Seata 是怎么做到的呢？下面说说它的各个模块之间的关系。</strong></p>
<p>Seata 的设计思路是将一个分布式事务可以理解成一个全局事务，下面挂了若干个分支事务，而一个分支事务是一个满足 ACID 的本地事务，因此我们可以操作分布式事务像操作本地事务一样。</p>
<p>2019 年 1 月，<strong>阿里</strong>巴巴中间件团队发起了开源项目&nbsp;<a target="_blank" rel="noopener" href="https://www.oschina.net/p/fescar" title="Fescar"><em>Fescar</em></a>（Fast &amp; EaSy Commit And Rollback），和社区一起共建开源分布式事务解决方案。Fescar 的愿景是让分布式事务的使用像本地事务的使用一样，简单和高效，并逐步解决开发者们遇到的分布式事务方面的所有难题。</p>
<p>Seata全称：Simple Extensible Autonomous Transaction Architecture,简单可扩展自治事务框架。</p>
<h5><span id="3-4-1-at-mo-shi-automatic-branch-transaction-mode">3.4.1、AT模式（Automatic (Branch) Transaction Mode）</span></h5><ul>
<li><strong>Transaction Coordinator （TC）：</strong> 事务协调器，<strong>维护全局事务的运行状态</strong>，负责协调并决定全局事务的提交或回滚。</li>
<li><strong>Transaction Manager（TM）：</strong> 控制全局事务的边界，负责开启一个全局事务，并最终发起<strong>全局提交</strong>或<strong>全局回滚</strong>的决议。</li>
<li><strong>Resource Manager （RM）：</strong>资源管理器，负责本地事务的注册，本地事务状态的汇报(投票)，并且<strong>负责本地事务的提交和回滚</strong>。</li>
<li><strong>XID：</strong> 一个全局事务的唯一标识</li>
</ul>
<p>其中，TM是一个分布式事务的发起者和终结者，TC负责维护分布式事务的运行状态，而RM则负责本地事务的运行。</p>
<p>如下图所示：</p>
<p><img src="/2024/09/26/projection-daijia/image_16_yy7mgWiiFD.png"></p>
<p>下面是一个分布式事务在Seata中的执行流程：</p>
<ol>
<li>TM 向 TC 申请开启一个全局事务，全局事务创建成功并生成一个全局唯一的 XID</li>
<li>XID 在微服务调用链路的上下文中传播。</li>
<li>RM 向 TC 注册分支事务，接着执行这个分支事务并提交（重点：RM在第一阶段就已经执行了本地事务的提交/回滚），最后将执行结果汇报给TC</li>
<li>TM 根据 TC 中所有的分支事务的执行情况，发起全局提交或回滚决议。</li>
<li>TC 调度 XID 下管辖的全部分支事务完成提交或回滚请求。</li>
</ol>
<p>Seata 中有三大模块，分别是 TM、RM 和 TC。 其中 TM 和 RM 是作为 Seata 的客户端与业务系统集成在一起，TC 作为 Seata 的服务端独立部署。</p>
<h5><span id="3-4-2-mt-mo-shi-manual-branch-transaction-mode">3.4.2 MT模式（Manual (Branch) Transaction Mode）</span></h5><p>Seata还支持MT模式。MT模式本质上是一种TCC方案，业务逻辑需要被拆分为 Prepare/Commit/Rollback 3 部分，形成一个 MT 分支，加入全局事务。如图所示：</p>
<p><img src="/2024/09/26/projection-daijia/tcc.png"></p>
<p>MT 模式一方面是 AT 模式的补充。另外，更重要的价值在于，通过 MT 模式可以把众多非事务性资源纳入全局事务的管理中。</p>
<h3><span id="4-seata-zhi-yuan-li-jian-jie">4、Seata之原理简介</span></h3><h4><span id="4-1-zai-kan-tc-tm-rm-san-da-zu-jian">4.1、再看TC/TM/RM三大组件</span></h4><p><img src="/2024/09/26/projection-daijia/image_35_UAj1MYO6FQ.png"></p>
<h4><span id="4-2-fen-bu-shi-shi-wu-de-zhi-xing-liu-cheng">4.2、分布式事务的执行流程</span></h4><ul>
<li>TM开启分布式事务(TM向TC注册全局事务记录)</li>
<li>换业务场景，编排数据库，服务等事务内资源（RM向TC汇报资源准备状态）</li>
<li>TM结束分布式事务，事务一阶段结束（TM通知TC提交/回滚分布式事务）</li>
<li>TC汇总事务信息，决定分布式事务是提交还是回滚</li>
<li>TC通知所有RM提交/回滚资源，事务二阶段结束。</li>
</ul>
<h4><span id="4-3-at-mo-shi-ru-he-zuo-dao-dui-ye-wu-de-wu-qin-ru">4.3、AT模式如何做到对业务的无侵入</span></h4><h5><span id="4-3-1-yi-jie-duan-jia-zai">4.3.1、一阶段加载</span></h5><ul>
<li>在一阶段，Seata会拦截”业务SQL”<ul>
<li>1.解析SQL语义，找到“业务SQL”要更新的业务数据，在业务数据被更新前，将其保存成“before image”</li>
<li>2.执行”业务SQL”更新业务数据，在业务数据更新之后，</li>
<li>3.其保存成“after image”，最后生成行锁。</li>
</ul>
</li>
<li>以上操作全部在一个数据库事务内完成，这样保证了一阶段操作的原子性。</li>
</ul>
<p><img src="/2024/09/26/projection-daijia/image_38_EB06uJVw2I.png"></p>
<h5><span id="4-3-2-er-jie-duan-ti-jiao">4.3.2、二阶段提交</span></h5><ul>
<li>二阶段如果顺利提交的话，因为“业务SQL”在一阶段已经提交至数据库，所以Seata框架只需将一阶段保存的快照数据和行锁删掉，完成数据清理即可。</li>
</ul>
<p><img src="/2024/09/26/projection-daijia/image_39_5lNHgn0ybu.png"></p>
<h5><span id="4-3-3-er-jie-duan-hui-gun">4.3.3、二阶段回滚</span></h5><p>二阶段如果是回滚的话，Seata就需要回滚一阶段执行的“业务SQL”,还原业务数据。</p>
<p>回滚方式便是用“before image”还原业务数据；但在还原前要首先校验脏写，对比“数据库当前业务数据”和“after image”,如果两份数据完全一致就说明没有脏写，可以还原业务数据，如果不一致就说明有脏写，出现脏写就需要转人工处理。</p>
<p><img src="/2024/09/26/projection-daijia/image_40_Y67Xy72vPH.png"></p>
<h2><span id="er-shi-yong-seata-tian-jia-fen-bu-shi-shi-wu">二、使用Seata添加分布式事务</span></h2><p>项目中很多功能都可以添加分布式事务。</p>
<p>比如，支付后处理，首先更新订单状态，之后要获取系统奖励添加到司机账户，这两件事情保证数据一致性，两件事情在不同的模块中，可以使用分布式事务</p>
<p>再比如，乘客下单要做很多事情，但是我们只需要关注保存订单信息与任务调度开启，这两件事件必须保证强一致性，只要乘客下单了，任务调度就必须开启，要么都成功，要么都回滚。</p>
<p>下面我们就引入Seata来解决问题。</p>
<h3><span id="1-an-zhuang-he-qi-dong-seata-fu-wu">1 安装和启动Seata服务</span></h3><ul>
<li>Seata可以在Linux操作系统中使用docker安装</li>
<li><strong>Seata也可以安装在windows系统（测试）</strong></li>
</ul>
<p><strong>到Seata官网下载安装文件</strong></p>
<p><img src="/2024/09/26/projection-daijia/image-20240320093120065.png" alt="image-20240320093120065"></p>
<p><img src="/2024/09/26/projection-daijia/image-20240320093633784.png" alt="image-20240320093633784"></p>
<h3><span id="2-zai-shi-yong-seata-de-xiang-guan-mo-kuai-yin-ru-yi-lai">2 在使用Seata的相关模块引入依赖</span></h3><ul>
<li>结合实际，在service-payment、service-order和service-driver模块引入依赖</li>
</ul>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-zai-shi-yong-seata-de-xiang-guan-mo-kuai-tian-jia-pei-zhi">3 在使用Seata的相关模块添加配置</span></h3><ul>
<li>结合实际，在service-payment、service-order和service-driver模块添加</li>
<li>添加到bootstrap.properties里面</li>
</ul>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">seata.tx-service-group</span>=<span class="string">tingshu-tx-group</span></span><br><span class="line"><span class="attr">seata.service.vgroup-mapping.tingshu-tx-group</span>=<span class="string">default</span></span><br><span class="line"><span class="attr">seata.service.grouplist.default</span>=<span class="string">127.0.0.1:8091</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-zai-ye-wu-fang-fa-tian-jia-zhu-jie">4 在业务方法添加注解</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GlobalTransactional</span></span><br></pre></td></tr></tbody></table></figure>



<h1><span id="ix-ding-dan-zhi-xing-yi">Ⅸ.订单执行（一）</span></h1><h2><span id="yi-jia-zai-dang-qian-ding-dan">一、加载当前订单</span></h2><p>无论司机端还是乘客端的小程序，如果遇到微信闪退、页面切换、重新登录小程序之后，只要页面回到首页，都必须加载当前的订单，然后跳转到当前订单的执行状态页面。</p>
<p>前面我们写了模拟接口，当前我们来把这部分接口实现了。</p>
<p>司机端效果如图（乘客端类似）：</p>
<p><img src="/2024/09/26/projection-daijia/dr_order_se.gif" alt="login"></p>
<h3><span id="1-cheng-ke-duan-cha-zhao-dang-qian-ding-dan">1、乘客端查找当前订单</span></h3><h4><span id="1-1-ding-dan-wei-fu-wu-jie-kou">1.1、订单微服务接口</span></h4><h5><span id="1-1-1-orderinfocontroller">1.1.1、OrderInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "乘客端查找当前订单")</span></span><br><span class="line"><span class="meta">@GetMapping("/searchCustomerCurrentOrder/{customerId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;CurrentOrderInfoVo&gt; <span class="title function_">searchCustomerCurrentOrder</span><span class="params">(<span class="meta">@PathVariable</span> Long customerId)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(orderInfoService.searchCustomerCurrentOrder(customerId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-2-orderinfoservice">1.1.2、OrderInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CurrentOrderInfoVo <span class="title function_">searchCustomerCurrentOrder</span><span class="params">(Long customerId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-3-orderinfoserviceimp">1.1.3、OrderInfoServiceImp</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CurrentOrderInfoVo <span class="title function_">searchCustomerCurrentOrder</span><span class="params">(Long customerId)</span> {</span><br><span class="line">    LambdaQueryWrapper&lt;OrderInfo&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(OrderInfo::getCustomerId, customerId);</span><br><span class="line">    <span class="comment">//乘客端支付完订单，乘客端主要流程就走完（当前这些节点，乘客端会调整到相应的页面处理逻辑）</span></span><br><span class="line">    Integer[] statusArray = {</span><br><span class="line">        OrderStatus.ACCEPTED.getStatus(),</span><br><span class="line">        OrderStatus.DRIVER_ARRIVED.getStatus(),</span><br><span class="line">        OrderStatus.UPDATE_CART_INFO.getStatus(),</span><br><span class="line">        OrderStatus.START_SERVICE.getStatus(),</span><br><span class="line">        OrderStatus.END_SERVICE.getStatus(),</span><br><span class="line">        OrderStatus.UNPAID.getStatus()</span><br><span class="line">    };</span><br><span class="line">    queryWrapper.in(OrderInfo::getStatus, statusArray);</span><br><span class="line">    queryWrapper.orderByDesc(OrderInfo::getId);</span><br><span class="line">    queryWrapper.last(<span class="string">"limit 1"</span>);</span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoMapper.selectOne(queryWrapper);</span><br><span class="line">    <span class="type">CurrentOrderInfoVo</span> <span class="variable">currentOrderInfoVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CurrentOrderInfoVo</span>();</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> != orderInfo) {</span><br><span class="line">        currentOrderInfoVo.setStatus(orderInfo.getStatus());</span><br><span class="line">        currentOrderInfoVo.setOrderId(orderInfo.getId());</span><br><span class="line">        currentOrderInfoVo.setIsHasCurrentOrder(<span class="literal">true</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        currentOrderInfoVo.setIsHasCurrentOrder(<span class="literal">false</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> currentOrderInfoVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-feign-jie-kou">1.2、Feign接口</span></h4><h5><span id="1-2-1-orderinfofeignclient">1.2.1、OrderInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 乘客端查找当前订单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> customerId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/order/info/searchCustomerCurrentOrder/{customerId}")</span></span><br><span class="line">Result&lt;CurrentOrderInfoVo&gt; <span class="title function_">searchCustomerCurrentOrder</span><span class="params">(<span class="meta">@PathVariable("customerId")</span> Long customerId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-3-si-ji-duan-web-jie-kou">1.3、司机端web接口</span></h4><h5><span id="1-3-1-ordercontroller">1.3.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "乘客端查找当前订单")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("/searchCustomerCurrentOrder")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;CurrentOrderInfoVo&gt; <span class="title function_">searchCustomerCurrentOrder</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">Long</span> <span class="variable">customerId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.searchCustomerCurrentOrder(customerId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-3-2-orderservice">1.3.2、OrderService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CurrentOrderInfoVo <span class="title function_">searchCustomerCurrentOrder</span><span class="params">(Long customerId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-3-3-orderserviceimpl">1.3.3、OrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CurrentOrderInfoVo <span class="title function_">searchCustomerCurrentOrder</span><span class="params">(Long customerId)</span> {</span><br><span class="line">    <span class="keyword">return</span> orderInfoFeignClient.searchCustomerCurrentOrder(customerId).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-si-ji-duan-cha-zhao-dang-qian-ding-dan">2、司机端查找当前订单</span></h3><h4><span id="2-1-ding-dan-wei-fu-wu-jie-kou">2.1、订单微服务接口</span></h4><h5><span id="2-1-1-orderinfocontroller">2.1.1、OrderInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "司机端查找当前订单")</span></span><br><span class="line"><span class="meta">@GetMapping("/searchDriverCurrentOrder/{driverId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;CurrentOrderInfoVo&gt; <span class="title function_">searchDriverCurrentOrder</span><span class="params">(<span class="meta">@PathVariable</span> Long driverId)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderInfoService.searchDriverCurrentOrder(driverId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-2-orderinfoservice">2.1.2、OrderInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CurrentOrderInfoVo <span class="title function_">searchDriverCurrentOrder</span><span class="params">(Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-3-orderinfoserviceimp">2.1.3、OrderInfoServiceImp</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CurrentOrderInfoVo <span class="title function_">searchDriverCurrentOrder</span><span class="params">(Long driverId)</span> {</span><br><span class="line">    LambdaQueryWrapper&lt;OrderInfo&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(OrderInfo::getDriverId, driverId);</span><br><span class="line">    <span class="comment">//司机发送完账单，司机端主要流程就走完（当前这些节点，司机端会调整到相应的页面处理逻辑）</span></span><br><span class="line">    Integer[] statusArray = {</span><br><span class="line">        OrderStatus.ACCEPTED.getStatus(),</span><br><span class="line">        OrderStatus.DRIVER_ARRIVED.getStatus(),</span><br><span class="line">        OrderStatus.UPDATE_CART_INFO.getStatus(),</span><br><span class="line">        OrderStatus.START_SERVICE.getStatus(),</span><br><span class="line">        OrderStatus.END_SERVICE.getStatus()</span><br><span class="line">    };</span><br><span class="line">    queryWrapper.in(OrderInfo::getStatus, statusArray);</span><br><span class="line">    queryWrapper.orderByDesc(OrderInfo::getId);</span><br><span class="line">    queryWrapper.last(<span class="string">"limit 1"</span>);</span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoMapper.selectOne(queryWrapper);</span><br><span class="line">    <span class="type">CurrentOrderInfoVo</span> <span class="variable">currentOrderInfoVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CurrentOrderInfoVo</span>();</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> != orderInfo) {</span><br><span class="line">        currentOrderInfoVo.setStatus(orderInfo.getStatus());</span><br><span class="line">        currentOrderInfoVo.setOrderId(orderInfo.getId());</span><br><span class="line">        currentOrderInfoVo.setIsHasCurrentOrder(<span class="literal">true</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        currentOrderInfoVo.setIsHasCurrentOrder(<span class="literal">false</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> currentOrderInfoVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-2-feign-jie-kou">2.2、Feign接口</span></h4><h5><span id="2-2-1-orderinfofeignclient">2.2.1、OrderInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 司机端查找当前订单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/order/info/searchDriverCurrentOrder/{driverId}")</span></span><br><span class="line">Result&lt;CurrentOrderInfoVo&gt; <span class="title function_">searchDriverCurrentOrder</span><span class="params">(<span class="meta">@PathVariable("driverId")</span> Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-3-si-ji-duan-web-jie-kou">2.3、司机端web接口</span></h4><h5><span id="2-3-1-ordercontroller">2.3.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "司机端查找当前订单")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("/searchDriverCurrentOrder")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;CurrentOrderInfoVo&gt; <span class="title function_">searchDriverCurrentOrder</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.searchDriverCurrentOrder(driverId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-3-2-orderservice">2.3.2、OrderService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CurrentOrderInfoVo <span class="title function_">searchDriverCurrentOrder</span><span class="params">(Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-3-3-orderserviceimpl">2.3.3、OrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CurrentOrderInfoVo <span class="title function_">searchDriverCurrentOrder</span><span class="params">(Long driverId)</span> {</span><br><span class="line">   <span class="keyword">return</span> orderInfoFeignClient.searchDriverCurrentOrder(driverId).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-huo-qu-ding-dan-xin-xi">3、获取订单信息</span></h3><p>进入首页，在有执行中订单的情况下，我们需要获取订单信息，才能知道页面跳转到那里去，因此现在把这个接口给实现了。</p>
<h4><span id="3-1-ding-dan-wei-fu-wu-jie-kou">3.1、订单微服务接口</span></h4><h5><span id="3-1-1-orderinfocontroller">3.1.1、OrderInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "根据订单id获取订单信息")</span></span><br><span class="line"><span class="meta">@GetMapping("/getOrderInfo/{orderId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderInfo&gt; <span class="title function_">getOrderInfo</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(orderInfoService.getById(orderId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="3-2-feign-jie-kou">3.2、Feign接口</span></h4><h5><span id="3-2-1-orderinfofeignclient">3.2.1、OrderInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据订单id获取订单信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/order/info/getOrderInfo/{orderId}")</span></span><br><span class="line">Result&lt;OrderInfo&gt; <span class="title function_">getOrderInfo</span><span class="params">(<span class="meta">@PathVariable("orderId")</span> Long orderId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="3-3-cheng-ke-duan-web-jie-kou">3.3、乘客端web接口</span></h4><h5><span id="3-3-1-ordercontroller">3.3.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "获取订单信息")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("/getOrderInfo/{orderId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderInfoVo&gt; <span class="title function_">getOrderInfo</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> {</span><br><span class="line">    <span class="type">Long</span> <span class="variable">customerId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.getOrderInfo(orderId, customerId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-3-2-orderservice">3.3.2、OrderService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OrderInfoVo <span class="title function_">getOrderInfo</span><span class="params">(Long orderId, Long customerId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-3-3-orderserviceimpl">3.3.3、OrderServiceImpl</span></h5><p>订单的各个状态，获取的订单信息不一样，当前我们只是获取订单基本信息，后续完善</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> OrderInfoVo <span class="title function_">getOrderInfo</span><span class="params">(Long orderId, Long customerId)</span> {</span><br><span class="line">    <span class="comment">//订单信息</span></span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderInfo(orderId).getData();</span><br><span class="line">    <span class="keyword">if</span> (orderInfo.getCustomerId().longValue() != customerId.longValue()) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.ILLEGAL_REQUEST);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装订单信息</span></span><br><span class="line">    <span class="type">OrderInfoVo</span> <span class="variable">orderInfoVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfoVo</span>();</span><br><span class="line">    orderInfoVo.setOrderId(orderId);</span><br><span class="line">    BeanUtils.copyProperties(orderInfo, orderInfoVo);</span><br><span class="line">    <span class="keyword">return</span> orderInfoVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="3-4-si-ji-web-jie-kou">3.4、司机web接口</span></h4><h5><span id="3-4-1-ordercontroller">3.4.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "获取订单账单详细信息")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("/getOrderInfo/{orderId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderInfoVo&gt; <span class="title function_">getOrderInfo</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> {</span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.getOrderInfo(orderId, driverId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-4-2-orderservice">3.4.2、OrderService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OrderInfoVo <span class="title function_">getOrderInfo</span><span class="params">(Long orderId, Long customerId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-4-3-orderserviceimpl">3.4.3、OrderServiceImpl</span></h5><p>订单的各个状态，获取的订单信息不一样，当前我们只是获取订单基本信息，后续完善</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> OrderInfoVo <span class="title function_">getOrderInfo</span><span class="params">(Long orderId, Long driverId)</span> {</span><br><span class="line">   <span class="comment">//订单信息</span></span><br><span class="line">   <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderInfo(orderId).getData();</span><br><span class="line">   <span class="keyword">if</span>(orderInfo.getDriverId().longValue() != driverId.longValue()) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.ILLEGAL_REQUEST);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">//封装订单信息</span></span><br><span class="line">   <span class="type">OrderInfoVo</span> <span class="variable">orderInfoVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfoVo</span>();</span><br><span class="line">   orderInfoVo.setOrderId(orderId);</span><br><span class="line">   BeanUtils.copyProperties(orderInfo, orderInfoVo);</span><br><span class="line">   <span class="keyword">return</span> orderInfoVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="er-si-cheng-tong-xian">二、司乘同显</span></h2><p>司机抢单成功后要赶往上车点，我们要计算司机赶往上车点的最佳线路，司机端与乘客端都要显示司机乘同显，这样乘客就能实时看见司机的动向。</p>
<p><img src="/2024/09/26/projection-daijia/1700466199469.png" alt="70046619946"></p>
<h3><span id="1-si-ji-duan-si-cheng-tong-xian">1、司机端司乘同显</span></h3><p>司机端司乘同显要简单一些，司机的地点就是司乘同显的起始点，代驾起点就是司乘同显的终点，知道起点与终点，我们就可以计算出最佳线路，根据最佳线路在小程序地图组件上一渲染就可以了</p>
<h4><span id="1-1-si-ji-duan-web-jie-kou">1.1、司机端web接口</span></h4><p>前面我们在地图微服务已经实现过了“计算最佳驾驶线路”接口，这里只需要在提供司机端web接口即可</p>
<h5><span id="1-1-1-ordercontroller">1.1.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "计算最佳驾驶线路")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@PostMapping("/calculateDrivingLine")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;DrivingLineVo&gt; <span class="title function_">calculateDrivingLine</span><span class="params">(<span class="meta">@RequestBody</span> CalculateDrivingLineForm calculateDrivingLineForm)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(orderService.calculateDrivingLine(calculateDrivingLineForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-2-orderservice">1.1.2、OrderService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DrivingLineVo <span class="title function_">calculateDrivingLine</span><span class="params">(CalculateDrivingLineForm calculateDrivingLineForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-3-orderserviceimpl">1.1.3、OrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> MapFeignClient mapFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DrivingLineVo <span class="title function_">calculateDrivingLine</span><span class="params">(CalculateDrivingLineForm calculateDrivingLineForm)</span> {</span><br><span class="line">   <span class="keyword">return</span> mapFeignClient.calculateDrivingLine(calculateDrivingLineForm).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-geng-xin-ding-dan-wei-zhi-dao-redis-huan-cun">2、更新订单位置到Redis缓存</span></h3><p>司机赶往代驾点，会实时更新司机的经纬度位置到Redis缓存，这样乘客端才能看见司机的动向，司机端更新，乘客端获取。</p>
<h4><span id="2-1-di-tu-wei-fu-wu-jie-kou">2.1、地图微服务接口</span></h4><h5><span id="2-1-1-locationcontroller">2.1.1、LocationController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "司机赶往代驾起始点：更新订单地址到缓存")</span></span><br><span class="line"><span class="meta">@PostMapping("/updateOrderLocationToCache")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">updateOrderLocationToCache</span><span class="params">(<span class="meta">@RequestBody</span> UpdateOrderLocationForm updateOrderLocationForm)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(locationService.updateOrderLocationToCache(updateOrderLocationForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-2-locationservice">2.1.2、LocationService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">updateOrderLocationToCache</span><span class="params">(UpdateOrderLocationForm updateOrderLocationForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-3-locationserviceimpl">2.1.3、LocationServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">updateOrderLocationToCache</span><span class="params">(UpdateOrderLocationForm updateOrderLocationForm)</span> {</span><br><span class="line">    <span class="type">OrderLocationVo</span> <span class="variable">orderLocationVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderLocationVo</span>();</span><br><span class="line">    orderLocationVo.setLongitude(updateOrderLocationForm.getLongitude());</span><br><span class="line">    orderLocationVo.setLatitude(updateOrderLocationForm.getLatitude());</span><br><span class="line">    redisTemplate.opsForValue().set(RedisConstant.UPDATE_ORDER_LOCATION + updateOrderLocationForm.getOrderId(), orderLocationVo);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-2-feign-jie-kou">2.2、Feign接口</span></h4><h5><span id="2-2-1-locationfeignclient">2.2.1、LocationFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 司机赶往代驾起始点：更新订单地址到缓存</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> updateOrderLocationForm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping("/map/location/updateOrderLocationToCache")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">updateOrderLocationToCache</span><span class="params">(<span class="meta">@RequestBody</span> UpdateOrderLocationForm updateOrderLocationForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-3-si-ji-duan-web-jie-kou">2.3、司机端web接口</span></h4><h5><span id="2-3-1-locationcontroller">2.3.1、LocationController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "司机赶往代驾起始点：更新订单位置到Redis缓存")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@PostMapping("/updateOrderLocationToCache")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">updateOrderLocationToCache</span><span class="params">(<span class="meta">@RequestBody</span> UpdateOrderLocationForm updateOrderLocationForm)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(locationService.updateOrderLocationToCache(updateOrderLocationForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-3-2-locationservice">2.3.2、LocationService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">updateOrderLocationToCache</span><span class="params">(UpdateOrderLocationForm updateOrderLocationForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-3-3-locationserviceimpl">2.3.3、LocationServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">updateOrderLocationToCache</span><span class="params">(UpdateOrderLocationForm updateOrderLocationForm)</span> {</span><br><span class="line">    <span class="keyword">return</span> locationFeignClient.updateOrderLocationToCache(updateOrderLocationForm).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-huo-qu-si-ji-ji-ben-xin-xi">3、获取司机基本信息</span></h3><p>乘客端进入司乘同显页面，需要加载司机的基本信息，显示司机的姓名、头像及驾龄等信息</p>
<h4><span id="3-1-si-ji-wei-fu-wu-jie-kou">3.1、司机微服务接口</span></h4><h5><span id="3-1-1-driverinfocontroller">3.1.1、DriverInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "获取司机基本信息")</span></span><br><span class="line"><span class="meta">@GetMapping("/getDriverInfo/{driverId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;DriverInfoVo&gt; <span class="title function_">getDriverInfo</span><span class="params">(<span class="meta">@PathVariable</span> Long driverId)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(driverInfoService.getDriverInfo(driverId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-2-driverinfoservice">3.1.2、DriverInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DriverInfoVo <span class="title function_">getDriverInfo</span><span class="params">(Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-3-driverinfoserviceimpl">3.1.3、DriverInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DriverInfoVo <span class="title function_">getDriverInfo</span><span class="params">(Long driverId)</span> {</span><br><span class="line">    <span class="type">DriverInfo</span> <span class="variable">driverInfo</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(driverId);</span><br><span class="line">    <span class="type">DriverInfoVo</span> <span class="variable">driverInfoVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverInfoVo</span>();</span><br><span class="line">    BeanUtils.copyProperties(driverInfo, driverInfoVo);</span><br><span class="line">    <span class="comment">//驾龄</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">driverLicenseAge</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DateTime</span>().getYear() - <span class="keyword">new</span> <span class="title class_">DateTime</span>(driverInfo.getDriverLicenseIssueDate()).getYear() + <span class="number">1</span>;</span><br><span class="line">    driverInfoVo.setDriverLicenseAge(driverLicenseAge);</span><br><span class="line">    <span class="keyword">return</span> driverInfoVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="3-2-feign-jie-kou">3.2、Feign接口</span></h4><h5><span id="3-2-1-driverinfofeignclient">3.2.1、DriverInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取司机基本信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/driver/info/getDriverInfo/{driverId}")</span></span><br><span class="line">Result&lt;DriverInfoVo&gt; <span class="title function_">getDriverInfo</span><span class="params">(<span class="meta">@PathVariable("driverId")</span> Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="3-3-cheng-ke-duan-web-jie-kou">3.3、乘客端web接口</span></h4><h5><span id="3-3-1-ordercontroller">3.3.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "根据订单id获取司机基本信息")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("/getDriverInfo/{orderId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;DriverInfoVo&gt; <span class="title function_">getDriverInfo</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> {</span><br><span class="line">    <span class="type">Long</span> <span class="variable">customerId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.getDriverInfo(orderId, customerId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-3-2-orderservice">3.3.2、OrderService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DriverInfoVo <span class="title function_">getDriverInfo</span><span class="params">(Long orderId, Long customerId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-3-2-orderserviceimpl">3.3.2、OrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DriverInfoVo <span class="title function_">getDriverInfo</span><span class="params">(Long orderId, Long customerId)</span> {</span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderInfo(orderId).getData();</span><br><span class="line">    <span class="keyword">if</span> (orderInfo.getCustomerId().longValue() != customerId.longValue()) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.ILLEGAL_REQUEST);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> driverInfoFeignClient.getDriverInfo(orderInfo.getDriverId()).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-cheng-ke-duan-huo-qu-ding-dan-jing-wei-du-wei-zhi">4、乘客端获取订单经纬度位置</span></h3><h4><span id="4-1-di-tu-wei-fu-wu-jie-kou">4.1、地图微服务接口</span></h4><h5><span id="4-1-1-locationcontroller">4.1.1、LocationController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "司机赶往代驾起始点：获取订单经纬度位置")</span></span><br><span class="line"><span class="meta">@GetMapping("/getCacheOrderLocation/{orderId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderLocationVo&gt; <span class="title function_">getCacheOrderLocation</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(locationService.getCacheOrderLocation(orderId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-2-locationservice">4.1.2、LocationService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OrderLocationVo <span class="title function_">getCacheOrderLocation</span><span class="params">(Long orderId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-3-locationserviceimpl">4.1.3、LocationServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> OrderLocationVo <span class="title function_">getCacheOrderLocation</span><span class="params">(Long orderId)</span> {</span><br><span class="line">    <span class="type">OrderLocationVo</span> <span class="variable">orderLocationVo</span> <span class="operator">=</span> (OrderLocationVo)redisTemplate.opsForValue().get(RedisConstant.UPDATE_ORDER_LOCATION + orderId);</span><br><span class="line">    <span class="keyword">return</span> orderLocationVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-2-feign-jie-kou">4.2、Feign接口</span></h4><h5><span id="4-2-1-locationfeignclient">4.2.1、LocationFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 司机赶往代驾起始点：获取订单经纬度位置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/map/location/getCacheOrderLocation/{orderId}")</span></span><br><span class="line">Result&lt;OrderLocationVo&gt; <span class="title function_">getCacheOrderLocation</span><span class="params">(<span class="meta">@PathVariable("orderId")</span> Long orderId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-3-cheng-ke-duan-web-jie-kou">4.3、乘客端web接口</span></h4><h5><span id="4-3-1-ordercontroller">4.3.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "司机赶往代驾起始点：获取订单经纬度位置")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("/getCacheOrderLocation/{orderId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderLocationVo&gt; <span class="title function_">getOrderLocation</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(orderService.getCacheOrderLocation(orderId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-3-3-orderservice">4.3.3、OrderService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OrderLocationVo <span class="title function_">getCacheOrderLocation</span><span class="params">(Long orderId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-3-3-orderserviceimpl">4.3.3、OrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> OrderLocationVo <span class="title function_">getCacheOrderLocation</span><span class="params">(Long orderId)</span> {</span><br><span class="line">    <span class="keyword">return</span> locationFeignClient.getCacheOrderLocation(orderId).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="5-cheng-ke-duan-si-cheng-tong-xian">5、乘客端司乘同显</span></h3><h4><span id="5-1-cheng-ke-duan-web-jie-kou">5.1、乘客端web接口</span></h4><h5><span id="5-1-1-ordercontroller">5.1.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "计算最佳驾驶线路")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@PostMapping("/calculateDrivingLine")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;DrivingLineVo&gt; <span class="title function_">calculateDrivingLine</span><span class="params">(<span class="meta">@RequestBody</span> CalculateDrivingLineForm calculateDrivingLineForm)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.calculateDrivingLine(calculateDrivingLineForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-1-2-orderservice">5.1.2、OrderService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DrivingLineVo <span class="title function_">calculateDrivingLine</span><span class="params">(CalculateDrivingLineForm calculateDrivingLineForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-1-3-orderserviceimpl">5.1.3、OrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DrivingLineVo <span class="title function_">calculateDrivingLine</span><span class="params">(CalculateDrivingLineForm calculateDrivingLineForm)</span> {</span><br><span class="line">    <span class="keyword">return</span> mapFeignClient.calculateDrivingLine(calculateDrivingLineForm).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="san-si-ji-dao-da-qi-shi-dian">三、司机到达起始点</span></h2><p>司机到达代驾起始点，司机手动触发“到达乘客起点”按钮，更新订单状态</p>
<p><img src="/2024/09/26/projection-daijia/daoda.gif" alt="70046619946"></p>
<h3><span id="1-si-ji-dao-da-dai-jia-qi-shi-dian">1、司机到达代驾起始点</span></h3><h4><span id="1-1-ding-dan-wei-fu-wu-jie-kou">1.1、订单微服务接口</span></h4><h5><span id="1-1-1-orderinfocontroller">1.1.1、OrderInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "司机到达起始点")</span></span><br><span class="line"><span class="meta">@GetMapping("/driverArriveStartLocation/{orderId}/{driverId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">driverArriveStartLocation</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId, <span class="meta">@PathVariable</span> Long driverId)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(orderInfoService.driverArriveStartLocation(orderId, driverId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-2-orderinfoservice">1.1.2、OrderInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">driverArriveStartLocation</span><span class="params">(Long orderId, Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-3-orderinfoserviceimp">1.1.3、OrderInfoServiceImp</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">driverArriveStartLocation</span><span class="params">(Long orderId, Long driverId)</span> {</span><br><span class="line">   LambdaQueryWrapper&lt;OrderInfo&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">   queryWrapper.eq(OrderInfo::getId, orderId);</span><br><span class="line">   queryWrapper.eq(OrderInfo::getDriverId, driverId);</span><br><span class="line"></span><br><span class="line">   <span class="type">OrderInfo</span> <span class="variable">updateOrderInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfo</span>();</span><br><span class="line">   updateOrderInfo.setStatus(OrderStatus.DRIVER_ARRIVED.getStatus());</span><br><span class="line">   updateOrderInfo.setArriveTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">   <span class="comment">//只能更新自己的订单</span></span><br><span class="line">   <span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> orderInfoMapper.update(updateOrderInfo, queryWrapper);</span><br><span class="line">   <span class="keyword">if</span>(row == <span class="number">1</span>) {</span><br><span class="line">      <span class="comment">//记录日志</span></span><br><span class="line">      <span class="built_in">this</span>.log(orderId, OrderStatus.DRIVER_ARRIVED.getStatus());</span><br><span class="line">   } <span class="keyword">else</span> {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.UPDATE_ERROR);</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-feign-jie-kou">1.2、Feign接口</span></h4><h5><span id="1-2-1-orderinfofeignclient">1.2.1、OrderInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 司机到达起始点</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/order/info/driverArriveStartLocation/{orderId}/{driverId}")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">driverArriveStartLocation</span><span class="params">(<span class="meta">@PathVariable("orderId")</span> Long orderId, <span class="meta">@PathVariable("driverId")</span> Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-3-si-ji-duan-web-jie-kou">1.3、司机端web接口</span></h4><h5><span id="1-3-1-ordercontroller">1.3.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "司机到达代驾起始地点")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("/driverArriveStartLocation/{orderId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">driverArriveStartLocation</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> {</span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.driverArriveStartLocation(orderId, driverId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-3-2-orderservice">1.3.2、OrderService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">driverArriveStartLocation</span><span class="params">(Long orderId, Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-3-3-orderserviceimpl">1.3.3、OrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">driverArriveStartLocation</span><span class="params">(Long orderId, Long driverId)</span> {</span><br><span class="line">   <span class="keyword">return</span> orderInfoFeignClient.driverArriveStartLocation(orderId, driverId).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="si-si-ji-geng-xin-dai-jia-che-liang-xin-xi">四、司机更新代驾车辆信息</span></h2><p>司机到达代驾起始点，联系了乘客，见到了代驾车辆，要拍照与录入车辆信息</p>
<p><img src="/2024/09/26/projection-daijia/car.gif"></p>
<h3><span id="1-si-ji-geng-xin-dai-jia-che-liang-xin-xi">1、司机更新代驾车辆信息</span></h3><h4><span id="1-1-ding-dan-wei-fu-wu-jie-kou">1.1、订单微服务接口</span></h4><h5><span id="1-1-1-orderinfocontroller">1.1.1、OrderInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "更新代驾车辆信息")</span></span><br><span class="line"><span class="meta">@PostMapping("/updateOrderCart")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">updateOrderCart</span><span class="params">(<span class="meta">@RequestBody</span> UpdateOrderCartForm updateOrderCartForm)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderInfoService.updateOrderCart(updateOrderCartForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-2-orderinfoservice">1.1.2、OrderInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">updateOrderCart</span><span class="params">(UpdateOrderCartForm updateOrderCartForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-3-orderinfoserviceimp">1.1.3、OrderInfoServiceImp</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">updateOrderCart</span><span class="params">(UpdateOrderCartForm updateOrderCartForm)</span> {</span><br><span class="line">    LambdaQueryWrapper&lt;OrderInfo&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(OrderInfo::getId, updateOrderCartForm.getOrderId());</span><br><span class="line">    queryWrapper.eq(OrderInfo::getDriverId, updateOrderCartForm.getDriverId());</span><br><span class="line"></span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">updateOrderInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfo</span>();</span><br><span class="line">    BeanUtils.copyProperties(updateOrderCartForm, updateOrderInfo);</span><br><span class="line">    updateOrderInfo.setStatus(OrderStatus.UPDATE_CART_INFO.getStatus());</span><br><span class="line">    <span class="comment">//只能更新自己的订单</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> orderInfoMapper.update(updateOrderInfo, queryWrapper);</span><br><span class="line">    <span class="keyword">if</span>(row == <span class="number">1</span>) {</span><br><span class="line">        <span class="comment">//记录日志</span></span><br><span class="line">        <span class="built_in">this</span>.log(updateOrderCartForm.getOrderId(), OrderStatus.UPDATE_CART_INFO.getStatus());</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.UPDATE_ERROR);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-feign-jie-kou">1.2、Feign接口</span></h4><h5><span id="1-2-1-orderinfofeignclient">1.2.1、OrderInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更新代驾车辆信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> updateOrderCartForm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping("/order/info//updateOrderCart")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">updateOrderCart</span><span class="params">(<span class="meta">@RequestBody</span> UpdateOrderCartForm updateOrderCartForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-3-si-ji-duan-web-jie-kou">1.3、司机端web接口</span></h4><h5><span id="1-3-1-ordercontroller">1.3.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "更新代驾车辆信息")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@PostMapping("/updateOrderCart")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">updateOrderCart</span><span class="params">(<span class="meta">@RequestBody</span> UpdateOrderCartForm updateOrderCartForm)</span> {</span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">    updateOrderCartForm.setDriverId(driverId);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.updateOrderCart(updateOrderCartForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-3-2-orderservice">1.3.2、OrderService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">updateOrderCart</span><span class="params">(UpdateOrderCartForm updateOrderCartForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-3-3-orderserviceimpl">1.3.3、OrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">updateOrderCart</span><span class="params">(UpdateOrderCartForm updateOrderCartForm)</span> {</span><br><span class="line">   <span class="keyword">return</span> orderInfoFeignClient.updateOrderCart(updateOrderCartForm).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1><span id="x-ding-dan-zhi-xing-er">Ⅹ.订单执行（二）</span></h1><h2><span id="yi-mongodb-ru-men">一、MongoDB入门</span></h2><h3><span id="1-mongodb">1、MongoDB</span></h3><h4><span id="1-1-mongodb-gai-nian">1.1、MongoDB 概念</span></h4><h5><span id="1-1-1-shi-me-shi-mongodb">1.1.1、什么是MongoDB</span></h5><p>MongoDB 是在2007年由DoubleClick公司的几位核心成员开发出的一款分布式文档数据库，由C++语言编写。</p>
<p>目的是为了解决数据大量增长的时候系统的可扩展性和敏捷性。MongoDB要比传统的关系型数据库简单很多。</p>
<p>在MongoDB中数据主要的组织结构就是<code>数据库、集合和文档</code>，文档存储在集合当中，集合存储在数据库中。</p>
<p>MongoDB中每一条数据记录就是一个文档，<code>数据结构由键值(key=&gt;value)对组成</code>。</p>
<p>文档类似于 JSON 对象，它的数据结构被叫做<code>BSON</code>（Binary JSON）。</p>
<p><img src="/2024/09/26/projection-daijia/788db5ab-31c3-4fa4-bf9c-881c3d09ec54.png" alt="img"></p>
<p>下表将帮助您更容易理解MongoDB中的一些概念：</p>
<table>
<thead>
<tr>
<th>RDBMS</th>
<th>MongoDB</th>
</tr>
</thead>
<tbody><tr>
<td>数据库</td>
<td>数据库</td>
</tr>
<tr>
<td>表格</td>
<td>集合</td>
</tr>
<tr>
<td>行</td>
<td>文档</td>
</tr>
<tr>
<td>列</td>
<td>字段</td>
</tr>
<tr>
<td>表联合</td>
<td>嵌入文档</td>
</tr>
<tr>
<td>主键</td>
<td>_id</td>
</tr>
</tbody></table>
<h5><span id="1-1-2-mongodb-gua-yong-chang-jing">1.1.2、MongoDB适用场景</span></h5><p>MongoDB不需要去明确指定一张表的具体结构，对字段的管理非常灵活，有很强的可扩展性。</p>
<p>支持高并发、高可用、高可扩展性，自带数据压缩功能，支持海量数据的高效存储和访问。</p>
<p>支持基本的CRUD、数据聚合、文本搜索和地理空间查询功能。</p>
<p><strong>适用场景：</strong></p>
<ul>
<li>网站数据：Mongo非常适合实时的插入，更新与查询，并具备网站实时数据存储所需的复制及高度伸缩性。</li>
<li>高伸缩性的场景：Mongo非常适合由数十或数百台服务器组成的数据库。</li>
<li>大尺寸，低价值的数据：使用传统的关系型数据库存储一些数据时可能会比较昂贵，在此之前，很多时候程序员往往会选择传统的文件进行存储。</li>
<li>缓存：由于性能很高，Mongo也适合作为信息基础设施的缓存层。在系统重启之后，由Mongo搭建的持久化缓存层可以避免下层的数据源过载。</li>
</ul>
<p><strong>例如：</strong></p>
<p>弹幕、直播间互动信息、朋友圈信息、物流场景等</p>
<p><strong>不适用场合：</strong></p>
<ul>
<li>高度事务性系统：例如银行系统。传统的关系型数据库目前还是更适用于需要大量原子性复杂事务的应用程序。</li>
<li>传统的商业智能应用：针对特定问题的BI数据库会对产生高度优化的查询方式。对于此类应用，数据仓库可能是更合适的选择。</li>
</ul>
<h4><span id="1-2-an-zhuang-he-qi-dong-docker-fang-shi">1.2、安装和启动（docker方式）</span></h4><h5><span id="1-2-1-la-qu-jing-xiang">1.2.1、拉取镜像</span></h5><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull mongo:7.0.0</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-2-2-chuang-jian-he-qi-dong-rong-qi">1.2.2、创建和启动容器</span></h5><p>需要在宿主机建立文件夹</p>
<blockquote>
<p>rm -rf /opt/mongo</p>
<p>mkdir -p /opt/mongo/data/db</p>
</blockquote>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --restart=always -p 27017:27017 --name mongo -v /opt/mongo/data/db:/data/db mongo:7.0.0</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-2-3-jin-ru-rong-qi">1.2.3、进入容器</span></h5><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it mongo mongosh</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-2-4-ji-ben-ming-ling">1.2.4、基本命令</span></h5><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">show dbs</span><br><span class="line">db.version() #当前db版本</span><br><span class="line">db.getMongo() #查看当前db的链接机器地址</span><br><span class="line">db.help() #帮助</span><br><span class="line">quit() #退出命令行</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="1-3-ke-hu-duan-yuan-cheng-yuan-cheng-lian-jie">1.3、客户端远程远程连接</span></h4><p><strong>资料：</strong><code>资料&gt;mongodb客户端&gt;mongodb-compass-1.39.3-win32-x64.exe</code>，安装</p>
<p><strong>客户端连接：</strong></p>
<p><img src="/2024/09/26/projection-daijia/1693377341958.png" alt="69337734195"></p>
<h4><span id="1-4-shu-ju-ku-cao-zuo">1.4、数据库操作</span></h4><h5><span id="1-4-1-chuang-jian-shu-ju-ku">1.4.1、创建数据库</span></h5><p>如果数据库不存在，则创建数据库，否则切换到指定数据库。</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use tingshu</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-4-2-cha-kan-dang-qian-shu-ju-ku">1.4.2、查看当前数据库</span></h5><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.getName()</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-4-3-xian-shi-dang-qian-shu-ju-ku-zhuang-tai">1.4.3、显示当前数据库状态</span></h5><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.stats()</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-4-4-shan-chu-dang-qian-shu-ju-ku">1.4.4、删除当前数据库</span></h5><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.dropDatabase()</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="1-5-ji-he-cao-zuo">1.5、集合操作</span></h4><h5><span id="1-5-1-chuang-jian-ji-he">1.5.1、创建集合</span></h5><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.createCollection("User")</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-5-2-shan-chu-ji-he">1.5.2、删除集合</span></h5><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.User.drop()</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="1-6-wen-dang-cao-zuo">1.6、文档操作</span></h4><p>文档是一组键值(key-value)对。MongoDB 的文档不需要设置相同的字段，并且相同的字段不需要相同的数据类型，这与关系型数据库有很大的区别，也是 MongoDB 非常突出的特点。</p>
<p><strong>需要注意的是：</strong></p>
<p>1、MongoDB区分类型和大小写。</p>
<p>2、MongoDB的文档不能有重复的键。</p>
<h5><span id="1-6-1-insert">1.6.1、insert</span></h5><p>向User集合插入一条记录。可以预先使用createCollection方法创建集合，也可以不创建集合，直接插入数据，那么集合会被自动创建</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.User.insert({name:'zhangsan',age:21,sex:true})</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-6-2-query">1.6.2、query</span></h5><p>查询当前User集合中所有的记录</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.User.find()</span><br></pre></td></tr></tbody></table></figure>

<p>查询当前User集合中name是zhangsan的记录</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.User.find({name:"zhangsan"})</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-6-3-update">1.6.3、update</span></h5><p>只更新匹配到的第一条记录</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.User.update({age:20}, {$set:{name:100}}) </span><br></pre></td></tr></tbody></table></figure>

<p>更新匹配到的所有记录</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.User.update({age:21}, {$set:{age:99}}, {multi: true})</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-6-4-remove">1.6.4、remove</span></h5><p>移除一个文档</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.User.remove(id)</span><br></pre></td></tr></tbody></table></figure>

<p>移除所有文档</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.User.remove({}) </span><br></pre></td></tr></tbody></table></figure>



<p><strong>更多命令参考：</strong><a target="_blank" rel="noopener" href="https://www.runoob.com/mongodb/mongodb-tutorial.html">https://www.runoob.com/mongodb/mongodb-tutorial.html</a></p>
<h3><span id="2-springboot-ji-cheng-mongodb">2、SpringBoot集成MongoDB</span></h3><p>spring-data-mongodb提供了<code>MongoTemplate</code>与<code>MongoRepository</code>两种方式访问mongodb，MongoRepository操作简单，MongoTemplate操作灵活，我们在项目中可以灵活使用这两种方式操作mongodb。</p>
<h4><span id="2-1-ji-cheng-spring-data-mongodb">2.1、集成spring-data-mongodb</span></h4><h5><span id="2-1-1-da-jian-xiang-mu">2.1.1、搭建项目</span></h5><p>1、创建项目：mongo_demo</p>
<p>2、导入pom.xml：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mongo_demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>17<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--mongodb--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>3、添加配置文件</p>
<p>application.yml</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">mongodb:</span></span><br><span class="line">      <span class="attr">database:</span> <span class="string">daijia</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.100</span><span class="number">.101</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">27017</span></span><br></pre></td></tr></tbody></table></figure>



<h5><span id="2-1-2-tian-jia-shi-ti">2.1.2、添加实体</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mongo_demo.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.bson.types.ObjectId;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.annotation.Id;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.mapping.Document;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Document("user")</span> <span class="comment">//指定mongodb中的集合名字</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> ObjectId id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="keyword">private</span> Date createDate;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-2-mongorepository">2.2、MongoRepository</span></h4><h5><span id="2-2-1-tian-jia-repository-lei">2.2.1、添加Repository类</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mongo_demo.repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.mongo_demo.model.User;</span><br><span class="line"><span class="keyword">import</span> org.bson.types.ObjectId;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.repository.MongoRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserRepository</span> <span class="keyword">extends</span> <span class="title class_">MongoRepository</span>&lt;User, ObjectId&gt; {</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-2-2-chuang-jian-ce-shi-lei">2.2.2、创建测试类</span></h5><p>test目录创建测试类：MongoRepositoryTest</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mongo_demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.mongo_demo.model.User;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.mongo_demo.repository.UserRepository;</span><br><span class="line"><span class="keyword">import</span> org.bson.types.ObjectId;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Example;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Page;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.PageRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.domain.Sort;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MongoRepositoryTest</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//插入</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCreateUser</span><span class="params">()</span>{</span><br><span class="line"></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setName(<span class="string">"小谷"</span>);</span><br><span class="line">        user.setAge(<span class="number">19</span>);</span><br><span class="line">        user.setCreateDate(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        userRepository.save(user);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询所有</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindAll</span><span class="params">()</span>{</span><br><span class="line">        List&lt;User&gt; userList = userRepository.findAll();</span><br><span class="line">        System.out.println(userList);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据id查询</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindById</span><span class="params">()</span>{</span><br><span class="line"></span><br><span class="line">        Optional&lt;User&gt; optional = userRepository.findById(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ObjectId</span>(<span class="string">"64eee9dff317c823c62b4faf"</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">present</span> <span class="operator">=</span> optional.isPresent();</span><br><span class="line">        <span class="keyword">if</span>(present){</span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> optional.get();</span><br><span class="line">            System.out.println(user);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//条件查询</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindAllExample</span><span class="params">()</span>{</span><br><span class="line"></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setAge(<span class="number">19</span>);</span><br><span class="line">        Example&lt;User&gt; example = Example.of(user);</span><br><span class="line">        List&lt;User&gt; userList = userRepository.findAll(example);</span><br><span class="line">        System.out.println(userList);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//排序查询</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindAllSort</span><span class="params">()</span>{</span><br><span class="line">        <span class="type">Sort</span> <span class="variable">sort</span> <span class="operator">=</span> Sort.by(Sort.Direction.DESC, <span class="string">"age"</span>);</span><br><span class="line">        List&lt;User&gt; userList = userRepository.findAll(sort);</span><br><span class="line">        System.out.println(userList);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//分页查询</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindAllPage</span><span class="params">()</span>{</span><br><span class="line"></span><br><span class="line">        <span class="type">PageRequest</span> <span class="variable">pageRequest</span> <span class="operator">=</span> PageRequest.of(<span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">        Page&lt;User&gt; page = userRepository.findAll(pageRequest);</span><br><span class="line">        <span class="type">int</span> <span class="variable">totalPages</span> <span class="operator">=</span> page.getTotalPages();</span><br><span class="line">        List&lt;User&gt; userList = page.getContent();</span><br><span class="line">        System.out.println(userList);</span><br><span class="line">        System.out.println(totalPages);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpdateUser</span><span class="params">()</span>{</span><br><span class="line"></span><br><span class="line">        <span class="comment">//注意：先查询，再更新</span></span><br><span class="line">        Optional&lt;User&gt; optional = userRepository.findById(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ObjectId</span>(<span class="string">"64eee9dff317c823c62b4faf"</span>)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span>(optional.isPresent()){</span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> optional.get();</span><br><span class="line">            user.setAge(<span class="number">100</span>);</span><br><span class="line">            <span class="comment">//user中包含id，就会执行更新</span></span><br><span class="line">            userRepository.save(user);</span><br><span class="line">            System.out.println(user);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDeleteUser</span><span class="params">()</span>{</span><br><span class="line">        userRepository.deleteById(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ObjectId</span>(<span class="string">"64eee9dff317c823c62b4faf"</span>)</span><br><span class="line">        );</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-3-mongotemplate">2.3、MongoTemplate</span></h4><p>test目录创建测试类：MongoTemplateTest</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mongo_demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.mongo_demo.model.User;</span><br><span class="line"><span class="keyword">import</span> com.mongodb.client.result.DeleteResult;</span><br><span class="line"><span class="keyword">import</span> com.mongodb.client.result.UpdateResult;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.MongoTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.query.Criteria;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.query.Query;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.query.Update;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MongoTemplateTest</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MongoTemplate mongoTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCreateUser</span><span class="params">()</span>{</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setAge(<span class="number">20</span>);</span><br><span class="line">        user.setName(<span class="string">"test"</span>);</span><br><span class="line">        user.setEmail(<span class="string">"test@qq.com"</span>);</span><br><span class="line">        mongoTemplate.insert(user);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询所有</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindUser</span><span class="params">()</span> {</span><br><span class="line">        List&lt;User&gt; userList = mongoTemplate.findAll(User.class);</span><br><span class="line">        System.out.println(userList);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据id查询</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFindUserById</span><span class="params">()</span>{</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> mongoTemplate.findById(<span class="string">"64eeeae31711344f35635788"</span>, User.class);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRemove</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> Criteria.where(<span class="string">"_id"</span>).is(<span class="string">"64eeeae31711344f35635788"</span>);</span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(criteria);</span><br><span class="line">        <span class="type">DeleteResult</span> <span class="variable">result</span> <span class="operator">=</span> mongoTemplate.remove(query, User.class);</span><br><span class="line">        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> result.getDeletedCount();</span><br><span class="line">        System.out.println(count);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//条件查询 and</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findUserList</span><span class="params">()</span> {</span><br><span class="line"></span><br><span class="line">        <span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> Criteria.where(<span class="string">"name"</span>).is(<span class="string">"test"</span>).and(<span class="string">"age"</span>).is(<span class="number">20</span>);</span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(criteria);</span><br><span class="line"></span><br><span class="line">        List&lt;User&gt; userList = mongoTemplate.find(query, User.class);</span><br><span class="line">        System.out.println(userList);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//分页查询</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findUsersPage</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>();</span><br><span class="line">        <span class="comment">//先查询总记录数</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> mongoTemplate.count(query, User.class);</span><br><span class="line">        System.out.println(count);</span><br><span class="line">        <span class="comment">//后查询分页列表</span></span><br><span class="line">        List&lt;User&gt; userList = mongoTemplate.find(query.skip(<span class="number">0</span>).limit(<span class="number">2</span>), User.class);</span><br><span class="line">        System.out.println(userList);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//修改</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpdateUser</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> Criteria.where(<span class="string">"_id"</span>).is(<span class="string">"64eeeae31711344f35635788"</span>);</span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(criteria);</span><br><span class="line">        <span class="type">Update</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Update</span>();</span><br><span class="line">        update.set(<span class="string">"name"</span>, <span class="string">"zhangsan"</span>);</span><br><span class="line">        update.set(<span class="string">"age"</span>, <span class="number">99</span>);</span><br><span class="line">        <span class="type">UpdateResult</span> <span class="variable">result</span> <span class="operator">=</span> mongoTemplate.upsert(query, update, User.class);<span class="comment">//改一条</span></span><br><span class="line">        <span class="comment">//UpdateResult result = mongoTemplate.updateMulti(query, update, User.class);//改多条</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> result.getModifiedCount();</span><br><span class="line">        System.out.println(count);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="er-kai-shi-dai-jia">二、开始代驾</span></h2><p>司机录入车辆信息后，就开始代驾了。开始代驾后，司机端与乘客端同样要进入司乘同显页面，司乘同显的起始点与终点就是代驾订单的起始点与终点，这里我们不需要提供额外的接口，直接使用“计算最佳驾驶线路”接口即可。</p>
<p>订单在在代驾过程中，我们需要保存驾驶途中的GPS定位，将来我们计算代驾真实里程的时候，就需要用到这些坐标点。那么这些定位点保存在MySQL中可以吗？当然不行，MySQL单表记录超过千万行就开始变慢了。那么保存再哪里呢？保存到MongoDB中。</p>
<p>订单在代驾的过程中，司机端小程序要实时采集录音，把录音和对话文本上传到后端系统，将录音监控保存到Minio，对话文本保存到MongoDB中</p>
<h3><span id="1-kai-shi-dai-jia">1、开始代驾</span></h3><p>代驾开始，我们要更新订单状态及相关信息</p>
<h4><span id="1-1-ding-dan-wei-fu-wu-jie-kou">1.1、订单微服务接口</span></h4><h5><span id="1-1-1-orderinfocontroller">1.1.1、OrderInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "开始代驾服务")</span></span><br><span class="line"><span class="meta">@PostMapping("/startDrive")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">startDrive</span><span class="params">(<span class="meta">@RequestBody</span> StartDriveForm startDriveForm)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderInfoService.startDrive(startDriveForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-2-orderinfoservice">1.1.2、OrderInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">startDrive</span><span class="params">(StartDriveForm startDriveForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-3-orderinfoserviceimp">1.1.3、OrderInfoServiceImp</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">startDrive</span><span class="params">(StartDriveForm startDriveForm)</span> {</span><br><span class="line">    LambdaQueryWrapper&lt;OrderInfo&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(OrderInfo::getId, startDriveForm.getOrderId());</span><br><span class="line">    queryWrapper.eq(OrderInfo::getDriverId, startDriveForm.getDriverId());</span><br><span class="line"></span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">updateOrderInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfo</span>();</span><br><span class="line">    updateOrderInfo.setStatus(OrderStatus.START_SERVICE.getStatus());</span><br><span class="line">    updateOrderInfo.setStartServiceTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    <span class="comment">//只能更新自己的订单</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> orderInfoMapper.update(updateOrderInfo, queryWrapper);</span><br><span class="line">    <span class="keyword">if</span>(row == <span class="number">1</span>) {</span><br><span class="line">        <span class="comment">//记录日志</span></span><br><span class="line">        <span class="built_in">this</span>.log(startDriveForm.getOrderId(), OrderStatus.START_SERVICE.getStatus());</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.UPDATE_ERROR);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-feign-jie-kou">1.2、Feign接口</span></h4><h5><span id="1-2-1-orderinfofeignclient">1.2.1、OrderInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 开始代驾服务</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> startDriveForm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping("/order/info/startDrive")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">startDrive</span><span class="params">(<span class="meta">@RequestBody</span> StartDriveForm startDriveForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-3-si-ji-duan-web-jie-kou">1.3、司机端web接口</span></h4><h5><span id="1-3-1-ordercontroller">1.3.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "开始代驾服务")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@PostMapping("/startDrive")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">startDrive</span><span class="params">(<span class="meta">@RequestBody</span> StartDriveForm startDriveForm)</span> {</span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">    startDriveForm.setDriverId(driverId);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.startDrive(startDriveForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-3-2-orderservice">1.3.2、OrderService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">startDrive</span><span class="params">(StartDriveForm startDriveForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-3-3-orderserviceimpl">1.3.3、OrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">startDrive</span><span class="params">(StartDriveForm startDriveForm)</span> {</span><br><span class="line">   <span class="keyword">return</span> orderInfoFeignClient.startDrive(startDriveForm).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-pi-liang-bao-cun-ding-dan-wei-zhi-xin-xi">2、批量保存订单位置信息</span></h3><p>司机开始代驾后，为了减少请求次数，司机端会实时收集变更的GPS定位信息，定时批量上传到后台服务器。</p>
<h4><span id="2-1-di-tu-wei-fu-wu-jie-kou">2.1、地图微服务接口</span></h4><h5><span id="2-1-1-locationcontroller">2.1.1、LocationController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "开始代驾服务：保存代驾服务订单位置")</span></span><br><span class="line"><span class="meta">@PostMapping("/saveOrderServiceLocation")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">saveOrderServiceLocation</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;OrderServiceLocationForm&gt; orderLocationServiceFormList)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(locationService.saveOrderServiceLocation(orderLocationServiceFormList));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-2-locationservice">2.1.2、LocationService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">saveOrderServiceLocation</span><span class="params">(List&lt;OrderServiceLocationForm&gt; orderLocationServiceFormList)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-3-locationserviceimp">2.1.3、LocationServiceImp</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OrderServiceLocationRepository orderServiceLocationRepository;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">saveOrderServiceLocation</span><span class="params">(List&lt;OrderServiceLocationForm&gt; orderLocationServiceFormList)</span> {</span><br><span class="line">    List&lt;OrderServiceLocation&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    orderLocationServiceFormList.forEach(item -&gt; {</span><br><span class="line">        <span class="type">OrderServiceLocation</span> <span class="variable">orderServiceLocation</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderServiceLocation</span>();</span><br><span class="line">        BeanUtils.copyProperties(item, orderServiceLocation);</span><br><span class="line">        orderServiceLocation.setId(ObjectId.get().toString());</span><br><span class="line">        orderServiceLocation.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        list.add(orderServiceLocation);</span><br><span class="line">    });</span><br><span class="line">    orderServiceLocationRepository.saveAll(list);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-2-feign-jie-kou">2.2、Feign接口</span></h4><h5><span id="2-2-1-locationfeignclient">2.2.1、LocationFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开始代驾服务：保存代驾服务订单位置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderLocationServiceFormList</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@PostMapping("/map/location/saveOrderServiceLocation")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">saveOrderServiceLocation</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;OrderServiceLocationForm&gt; orderLocationServiceFormList)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-3-si-ji-duan-web-jie-kou">2.3、司机端web接口</span></h4><h5><span id="2-3-1-locationcontroller">2.3.1、LocationController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "开始代驾服务：保存代驾服务订单位置")</span></span><br><span class="line"><span class="meta">@PostMapping("/saveOrderServiceLocation")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">saveOrderServiceLocation</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;OrderServiceLocationForm&gt; orderLocationServiceFormList)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(locationService.saveOrderServiceLocation(orderLocationServiceFormList));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-3-2-locationservice">2.3.2、LocationService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">saveOrderServiceLocation</span><span class="params">(List&lt;OrderServiceLocationForm&gt; orderLocationServiceFormList)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-3-3-locationserviceimpl">2.3.3、LocationServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">saveOrderServiceLocation</span><span class="params">(List&lt;OrderServiceLocationForm&gt; orderLocationServiceFormList)</span> {</span><br><span class="line">    <span class="keyword">return</span> locationFeignClient.saveOrderServiceLocation(orderLocationServiceFormList).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-huo-qu-ding-dan-fu-wu-zui-hou-yi-ge-wei-zhi-xin-xi">3、获取订单服务最后一个位置信息</span></h3><p>司机开始代驾后，乘客端要获取司机的动向，就必须定时获取上面更新的最后一个位置信息。</p>
<h4><span id="3-1-di-tu-wei-fu-wu-jie-kou">3.1、地图微服务接口</span></h4><h5><span id="3-1-1-locationcontroller">3.1.1、LocationController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "代驾服务：获取订单服务最后一个位置信息")</span></span><br><span class="line"><span class="meta">@GetMapping("/getOrderServiceLastLocation/{orderId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderServiceLastLocationVo&gt; <span class="title function_">getOrderServiceLastLocation</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(locationService.getOrderServiceLastLocation(orderId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-2-locationservice">3.1.2、LocationService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OrderServiceLastLocationVo <span class="title function_">getOrderServiceLastLocation</span><span class="params">(Long orderId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-3-locationserviceimp">3.1.3、LocationServiceImp</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> MongoTemplate mongoTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> OrderServiceLastLocationVo <span class="title function_">getOrderServiceLastLocation</span><span class="params">(Long orderId)</span> {</span><br><span class="line">    <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>();</span><br><span class="line">    query.addCriteria(Criteria.where(<span class="string">"orderId"</span>).is(orderId));</span><br><span class="line">    query.with(Sort.by(Sort.Order.desc(<span class="string">"createTime"</span>)));</span><br><span class="line">    query.limit(<span class="number">1</span>);</span><br><span class="line">    <span class="type">OrderServiceLocation</span> <span class="variable">orderServiceLocation</span> <span class="operator">=</span> mongoTemplate.findOne(query, OrderServiceLocation.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装返回对象</span></span><br><span class="line">    <span class="type">OrderServiceLastLocationVo</span> <span class="variable">orderServiceLastLocationVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderServiceLastLocationVo</span>();</span><br><span class="line">    BeanUtils.copyProperties(orderServiceLocation, orderServiceLastLocationVo);</span><br><span class="line">    <span class="keyword">return</span> orderServiceLastLocationVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="3-2-feign-jie-kou">3.2、Feign接口</span></h4><h5><span id="3-2-1-locationfeignclient">3.2.1、LocationFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 代驾服务：获取订单服务最后一个位置信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/map/location/getOrderServiceLastLocation/{orderId}")</span></span><br><span class="line">Result&lt;OrderServiceLastLocationVo&gt; <span class="title function_">getOrderServiceLastLocation</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="3-3-cheng-ke-duan-web-jie-kou">3.3、乘客端web接口</span></h4><h5><span id="3-3-1-ordercontroller">3.3.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "代驾服务：获取订单服务最后一个位置信息")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("/getOrderServiceLastLocation/{orderId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderServiceLastLocationVo&gt; <span class="title function_">getOrderServiceLastLocation</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.getOrderServiceLastLocation(orderId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-3-2-orderservice">3.3.2、OrderService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OrderServiceLastLocationVo <span class="title function_">getOrderServiceLastLocation</span><span class="params">(Long orderId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-3-3-orderserviceimpl">3.3.3、OrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> OrderServiceLastLocationVo <span class="title function_">getOrderServiceLastLocation</span><span class="params">(Long orderId)</span> {</span><br><span class="line">    <span class="keyword">return</span> locationFeignClient.getOrderServiceLastLocation(orderId).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-minio-shang-chuan-jie-kou">4、Minio上传接口</span></h3><p>司机在代驾的过程中要上传录音文件信息，我们可以保存到Minio里面。毕竟我们是拿Minio充当私有云来使用的，当前我们来封装Minio的上传接口</p>
<h4><span id="4-1-minio-ru-men">4.1、Minio入门</span></h4><h5><span id="4-1-1-minio-jie-shao">4.1.1、Minio介绍</span></h5><p>官网：<a target="_blank" rel="noopener" href="https://www.minio.org.cn/">https://www.minio.org.cn/</a></p>
<p>MinIO是一个开源的分布式对象存储服务器，支持S3协议并且可以在多节点上实现数据的高可用和容错。它采用Go语言开发，拥有轻量级、高性能、易部署等特点，并且可以自由选择底层存储介质。</p>
<p>MinIO的主要特点包括：</p>
<p>1、高性能：MinIO基于GO语言编写，具有高速、轻量级、高并发等性能特点，还支持多线程和缓存等机制进行优化，可以快速地处理大规模数据。</p>
<p>2、可扩展性：MinIO采用分布式存储模式，支持水平扩展，通过增加节点数量来扩展存储容量和性能，支持自动数据迁移和负载均衡。</p>
<p>3、安全性：MinIO提供了多种安全策略，如访问控制列表（ACL）、服务端加密（SSE）、传输层安全性（TLS）等，可以保障数据安全和隐私。</p>
<p>4、兼容性：MinIO兼容AWS S3 API，还支持其他云服务提供商的API，比如GCP、Azure等，可以通过简单的配置实现互操作性。</p>
<p>5、简单易用：MinIO的部署和管理非常简单，只需要运行一个二进制包即可启动服务，同时提供了Web界面和命令行工具等方便的管理工具。</p>
<p><strong>S3协议</strong>是Amazon Web Services (AWS) 提供的对象存储服务（Simple Storage Service）的API协议。它是一种 RESTful风格的Web服务接口，使用HTTP/HTTPS协议进行通信，支持多种编程语言和操作系统，并实现了数据的可靠存储、高扩展性以及良好的可用性。</p>
<h5><span id="4-1-2-minio-an-zhuang">4.1.2、Minio安装</span></h5><p>官网地址：<a target="_blank" rel="noopener" href="https://www.minio.org.cn/docs/cn/minio/container/index.html">https://www.minio.org.cn/docs/cn/minio/container/index.html</a></p>
<p>具体命令：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建数据存储目录</span></span><br><span class="line">mkdir -p ~/minio/data</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建minio</span></span><br><span class="line">docker run \</span><br><span class="line">   -p <span class="number">9000</span>:<span class="number">9000</span> \</span><br><span class="line">   -p <span class="number">9090</span>:<span class="number">9090</span> \</span><br><span class="line">   --name minio \</span><br><span class="line">   -v ~/minio/data:/data \</span><br><span class="line">   -e <span class="string">"MINIO_ROOT_USER=admin"</span> \</span><br><span class="line">   -e <span class="string">"MINIO_ROOT_PASSWORD=admin123456"</span> \</span><br><span class="line">   -d \</span><br><span class="line">   quay.io/minio/minio server /data --console-address <span class="string">":9090"</span></span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-3-minio-ru-men">4.1.3、Minio入门</span></h5><p>本章节会给大家介绍一下如何通过Java客户端操作Minio，可以参考官网地址。</p>
<p>官网地址：<a target="_blank" rel="noopener" href="https://min.io/docs/minio/linux/developers/java/minio-java.html">https://min.io/docs/minio/linux/developers/java/minio-java.html</a></p>
<p>具体步骤：</p>
<p>1、加入如下依赖</p>
<p>已引入可忽略</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- web-driver模块中加入如下依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.minio<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>minio<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>2、示例代码</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileUploadTest</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个Minio的客户端对象</span></span><br><span class="line">        <span class="type">MinioClient</span> <span class="variable">minioClient</span> <span class="operator">=</span> MinioClient.builder()</span><br><span class="line">                        .endpoint(<span class="string">"http://192.168.136.142:9001"</span>)</span><br><span class="line">                        .credentials(<span class="string">"admin"</span>, <span class="string">"admin123456"</span>)</span><br><span class="line">                        .build();</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">found</span> <span class="operator">=</span> minioClient.bucketExists(BucketExistsArgs.builder().bucket(<span class="string">"daijia"</span>).build());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果不存在，那么此时就创建一个新的桶</span></span><br><span class="line">        <span class="keyword">if</span> (!found) {</span><br><span class="line">            minioClient.makeBucket(MakeBucketArgs.builder().bucket(<span class="string">"daijia"</span>).build());</span><br><span class="line">        } <span class="keyword">else</span> {  <span class="comment">// 如果存在打印信息</span></span><br><span class="line">            System.out.println(<span class="string">"Bucket 'daijia' already exists."</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">"D://images//1.jpg"</span>) ;</span><br><span class="line">        <span class="type">PutObjectArgs</span> <span class="variable">putObjectArgs</span> <span class="operator">=</span> PutObjectArgs.builder()</span><br><span class="line">                .bucket(<span class="string">"spzx-bucket"</span>)</span><br><span class="line">                .stream(fis, fis.available(), -<span class="number">1</span>)</span><br><span class="line">                .object(<span class="string">"1.jpg"</span>)</span><br><span class="line">                .build();</span><br><span class="line">        minioClient.putObject(putObjectArgs) ;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构建fileUrl</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileUrl</span> <span class="operator">=</span> <span class="string">"http://192.168.136.142:9000/spzx-bucket/1.jpg"</span> ;</span><br><span class="line">        System.out.println(fileUrl);</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>注意：设置minio的中该桶的访问权限为public，如下所示：</p>
<p><img src="/2024/09/26/projection-daijia/image-20230515234445425.png" alt="image-20230515234445425"></p>
<h4><span id="4-2-si-ji-duan-web-jie-kou">4.2、司机端web接口</span></h4><h5><span id="4-2-1-common-account-yaml">4.2.1、common-account.yaml</span></h5><p>添加配置文件</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">minio:</span></span><br><span class="line">  <span class="attr">endpointUrl:</span> <span class="string">http://192.168.136.142:9000</span></span><br><span class="line">  <span class="attr">accessKey:</span> <span class="string">admin</span></span><br><span class="line">  <span class="attr">secreKey:</span> <span class="string">admin123456</span></span><br><span class="line">  <span class="attr">bucketName:</span> <span class="string">daijia</span></span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-2-2-minioproperties">4.2.2、MinioProperties</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.driver.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix="minio")</span> <span class="comment">//读取节点</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MinioProperties</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String endpointUrl;</span><br><span class="line">    <span class="keyword">private</span> String accessKey;</span><br><span class="line">    <span class="keyword">private</span> String secreKey;</span><br><span class="line">    <span class="keyword">private</span> String bucketName;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-2-3-filecontroller">4.2.3、FileController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> FileService fileService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "Minio文件上传")</span></span><br><span class="line"><span class="meta">@PostMapping("upload")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestPart("file")</span> MultipartFile file)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(fileService.upload(file));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-2-4-fileservice">4.2.4、FileService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String <span class="title function_">upload</span><span class="params">(MultipartFile file)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-2-5-fileserviceimpl">4.2.5、FileServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> MinioProperties minioProperties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">upload</span><span class="params">(MultipartFile file)</span> {</span><br><span class="line">   <span class="keyword">try</span> {</span><br><span class="line">      <span class="comment">// 创建一个Minio的客户端对象</span></span><br><span class="line">      <span class="type">MinioClient</span> <span class="variable">minioClient</span> <span class="operator">=</span> MinioClient.builder()</span><br><span class="line">            .endpoint(minioProperties.getEndpointUrl())</span><br><span class="line">            .credentials(minioProperties.getAccessKey(), minioProperties.getSecreKey())</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 判断桶是否存在</span></span><br><span class="line">      <span class="type">boolean</span> <span class="variable">found</span> <span class="operator">=</span> minioClient.bucketExists(BucketExistsArgs.builder().bucket(minioProperties.getBucketName()).build());</span><br><span class="line">      <span class="keyword">if</span> (!found) {       <span class="comment">// 如果不存在，那么此时就创建一个新的桶</span></span><br><span class="line">         minioClient.makeBucket(MakeBucketArgs.builder().bucket(minioProperties.getBucketName()).build());</span><br><span class="line">      } <span class="keyword">else</span> {  <span class="comment">// 如果存在打印信息</span></span><br><span class="line">         System.out.println(<span class="string">"Bucket 'daijia' already exists."</span>);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 设置存储对象名称</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">extFileName</span> <span class="operator">=</span> file.getOriginalFilename().substring(file.getOriginalFilename().lastIndexOf(<span class="string">"."</span>));</span><br><span class="line">      <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">"yyyyMMdd"</span>)</span><br><span class="line">            .format(<span class="keyword">new</span> <span class="title class_">Date</span>()) + <span class="string">"/"</span> + UUID.randomUUID().toString().replace(<span class="string">"-"</span> , <span class="string">""</span>) + <span class="string">"."</span> + extFileName;</span><br><span class="line"></span><br><span class="line">      <span class="type">PutObjectArgs</span> <span class="variable">putObjectArgs</span> <span class="operator">=</span> PutObjectArgs.builder()</span><br><span class="line">            .bucket(minioProperties.getBucketName())</span><br><span class="line">            .stream(file.getInputStream(), file.getSize(), -<span class="number">1</span>)</span><br><span class="line">            .object(fileName)</span><br><span class="line">            .build();</span><br><span class="line">      minioClient.putObject(putObjectArgs) ;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> minioProperties.getEndpointUrl() + <span class="string">"/"</span> + minioProperties.getBucketName() + <span class="string">"/"</span> + fileName ;</span><br><span class="line"></span><br><span class="line">   } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.FILE_ERROR);</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="5-bao-cun-ding-dan-jian-kong-ji-lu-shu-ju">5、保存订单监控记录数据</span></h3><p>只要开始代驾，司机端小程序就要录制司乘对话，直到代驾结束，才停止录音。</p>
<p>司机端小程序怎么录音呢？同声传译插件可以实现录音，并且把录音中的语音部分转换成文本。这是前端小程序实现的功能，我们只做了解。</p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/wxopen/plugindevdoc?appid=wx069ba97219f66d99&amp;token=61191740&amp;lang=zh_CN">https://mp.weixin.qq.com/wxopen/plugindevdoc?appid=wx069ba97219f66d99&amp;token=61191740&amp;lang=zh_CN</a></p>
<p>说明：注意controller接收参数的形式</p>
<h4><span id="5-1-ding-dan-wei-fu-wu-jie-kou">5.1、订单微服务接口</span></h4><h5><span id="5-1-1-ordermonitorcontroller">5.1.1、OrderMonitorController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OrderMonitorService orderMonitorService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "保存订单监控记录数据")</span></span><br><span class="line"><span class="meta">@PostMapping("/saveOrderMonitorRecord")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">saveMonitorRecord</span><span class="params">(<span class="meta">@RequestBody</span> OrderMonitorRecord orderMonitorRecord)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderMonitorService.saveOrderMonitorRecord(orderMonitorRecord));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-1-2-monitorservice">5.1.2、MonitorService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">saveOrderMonitorRecord</span><span class="params">(OrderMonitorRecord orderMonitorRecord)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-1-3-monitorserviceimpl">5.1.3、MonitorServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OrderMonitorRecordRepository orderMonitorRecordRepository;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">saveOrderMonitorRecord</span><span class="params">(OrderMonitorRecord orderMonitorRecord)</span> {</span><br><span class="line">   orderMonitorRecordRepository.save(orderMonitorRecord);</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="5-2-feign-jie-kou">5.2、Feign接口</span></h4><h5><span id="5-2-1-ordermonitorfeignclient">5.2.1、OrderMonitorFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 保存订单监控记录数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderMonitorRecord</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping("/order/monitor/saveOrderMonitorRecord")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">saveMonitorRecord</span><span class="params">(<span class="meta">@RequestBody</span> OrderMonitorRecord orderMonitorRecord)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="5-3-ding-dan-wei-fu-wu-jie-kou">5.3、订单微服务接口</span></h4><h5><span id="5-3-1-monitorcontroller">5.3.1、MonitorController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> MonitorService monitorService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "上传录音")</span></span><br><span class="line"><span class="meta">@PostMapping("/upload")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestParam("file")</span> MultipartFile file,</span></span><br><span class="line"><span class="params">                       OrderMonitorForm orderMonitorForm)</span> {</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">return</span> Result.ok(monitorService.upload(file, orderMonitorForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-3-2-monitorservice">5.3.2、MonitorService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">upload</span><span class="params">(MultipartFile file, OrderMonitorForm orderMonitorForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-3-3-monitorserviceimpl">5.3.3、MonitorServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> FileService fileService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OrderMonitorFeignClient orderMonitorFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">upload</span><span class="params">(MultipartFile file, OrderMonitorForm orderMonitorForm)</span> {</span><br><span class="line">    <span class="comment">//上传对话文件</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> fileService.upload(file);</span><br><span class="line">    log.info(<span class="string">"upload: {}"</span>, url);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存订单监控记录数</span></span><br><span class="line">    <span class="type">OrderMonitorRecord</span> <span class="variable">orderMonitorRecord</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderMonitorRecord</span>();</span><br><span class="line">    orderMonitorRecord.setOrderId(orderMonitorForm.getOrderId());</span><br><span class="line">    orderMonitorRecord.setFileUrl(url);</span><br><span class="line">    orderMonitorRecord.setContent(orderMonitorForm.getContent());</span><br><span class="line">    orderMonitorFeignClient.saveMonitorRecord(orderMonitorRecord);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="6-kai-tong-shu-ju-wan-xiang-fu-wu-ci">6、开通数据万象服务CI</span></h3><p>数据万象（Cloud Infinite，CI）是依托腾讯云对象存储的数据处理平台，涵盖图片处理、内容审核、媒体处理、AI 识别、文档预览等功能，为客户提供一站式的专业数据处理解决方案，满足您多种业务场景的需求。</p>
<p>我们项目中很多业务都可以使用腾讯云的数据万象服务，比如审核司机上传的身份证、驾驶证照片与手持证件照片等是否包含暴力色情的内容，还有审核代驾过程对话记录是否含有暴力色情等等。如果用人工审核，速度太慢，所以我们需要用数据万象的AI引擎来帮我们审核。</p>
<h4><span id="6-1-kai-tong-shu-ju-wan-xiang-fu-wu">6.1、开通数据万象服务</span></h4><p>官网地址：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/ci">https://cloud.tencent.com/product/ci</a></p>
<p>API文档地址：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/460/57227">https://cloud.tencent.com/document/product/460/57227</a></p>
<p><img src="/2024/09/26/projection-daijia/1700468528769.png" alt="70046852876"></p>
<h4><span id="6-2-feng-zhuang-tu-pian-shen-he-jie-kou">6.2、封装图片审核接口</span></h4><p>接口文档地址：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/460/57227">https://cloud.tencent.com/document/product/460/57227</a></p>
<p>我们只需要提供service接口，在对于的业务中调用该接口即可</p>
<h5><span id="6-2-1-si-ji-wei-fu-wu-jie-kou">6.2.1、司机微服务接口</span></h5><h6><span id="6-2-1-1-ciservice">6.2.1.1、CiService</span></h6><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">imageAuditing</span><span class="params">(String path)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h6><span id="6-2-1-2-ciserviceimpl">6.2.1.2、CiServiceImpl</span></h6><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> TencentCloudProperties tencentCloudProperties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> COSClient <span class="title function_">getPrivateCOSClient</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">COSCredentials</span> <span class="variable">cred</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicCOSCredentials</span>(tencentCloudProperties.getSecretId(), tencentCloudProperties.getSecretKey());</span><br><span class="line">    <span class="type">ClientConfig</span> <span class="variable">clientConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientConfig</span>(<span class="keyword">new</span> <span class="title class_">Region</span>(tencentCloudProperties.getRegion()));</span><br><span class="line">    clientConfig.setHttpProtocol(HttpProtocol.https);</span><br><span class="line">    <span class="type">COSClient</span> <span class="variable">cosClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">COSClient</span>(cred, clientConfig);</span><br><span class="line">    <span class="keyword">return</span> cosClient;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">imageAuditing</span><span class="params">(String path)</span> {</span><br><span class="line">    <span class="type">COSClient</span> <span class="variable">cosClient</span> <span class="operator">=</span> <span class="built_in">this</span>.getPrivateCOSClient();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//审核图片内容</span></span><br><span class="line">    <span class="comment">//1.创建任务请求对象</span></span><br><span class="line">    <span class="type">ImageAuditingRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ImageAuditingRequest</span>();</span><br><span class="line">    <span class="comment">//2.添加请求参数 参数详情请见 API 接口文档</span></span><br><span class="line">    <span class="comment">//2.1设置请求 bucket</span></span><br><span class="line">    request.setBucketName(tencentCloudProperties.getBucketPrivate());</span><br><span class="line">    <span class="comment">//2.2设置审核策略 不传则为默认策略（预设）</span></span><br><span class="line">    <span class="comment">//request.setBizType("");</span></span><br><span class="line">    <span class="comment">//2.3设置 bucket 中的图片位置</span></span><br><span class="line">    request.setObjectKey(path);</span><br><span class="line">    <span class="comment">//3.调用接口,获取任务响应对象</span></span><br><span class="line">    <span class="type">ImageAuditingResponse</span> <span class="variable">response</span> <span class="operator">=</span> cosClient.imageAuditing(request);</span><br><span class="line">    cosClient.shutdown();</span><br><span class="line">    <span class="comment">//用于返回该审核场景的审核结果，返回值：0：正常。1：确认为当前场景的违规内容。2：疑似为当前场景的违规内容。</span></span><br><span class="line">    <span class="keyword">if</span> (!response.getPornInfo().getHitFlag().equals(<span class="string">"0"</span>)</span><br><span class="line">            || !response.getAdsInfo().getHitFlag().equals(<span class="string">"0"</span>)</span><br><span class="line">            || !response.getTerroristInfo().getHitFlag().equals(<span class="string">"0"</span>)</span><br><span class="line">            || !response.getPoliticsInfo().getHitFlag().equals(<span class="string">"0"</span>)</span><br><span class="line">    ) {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="6-3-teng-xun-yun-cos-tu-pian-shen-he">6.3、腾讯云COS图片审核</span></h4><p>凡是上传到腾讯云COS私有桶的图片，我都需要审核一下。</p>
<p>修改司机微服务CosServiceImpl.upload方法</p>
<p>关键代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//审核图片</span></span><br><span class="line"><span class="type">Boolean</span> <span class="variable">isAuditing</span> <span class="operator">=</span> ciService.imageAuditing(uploadPath);</span><br><span class="line"><span class="keyword">if</span>(!isAuditing) {</span><br><span class="line">   <span class="comment">//删除违规图片</span></span><br><span class="line">   cosClient.deleteObject(tencentCloudProperties.getBucketPrivate(), uploadPath);</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.IMAGE_AUDITION_FAIL);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>完整代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> CiService ciService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CosUploadVo <span class="title function_">upload</span><span class="params">(MultipartFile file, String path)</span> {</span><br><span class="line">    <span class="type">COSClient</span> <span class="variable">cosClient</span> <span class="operator">=</span> <span class="built_in">this</span>.getPrivateCOSClient();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//元数据信息</span></span><br><span class="line">    <span class="type">ObjectMetadata</span> <span class="variable">meta</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMetadata</span>();</span><br><span class="line">    meta.setContentLength(file.getSize());</span><br><span class="line">    meta.setContentEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">    meta.setContentType(file.getContentType());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//向存储桶中保存文件</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">fileType</span> <span class="operator">=</span> file.getOriginalFilename().substring(file.getOriginalFilename().lastIndexOf(<span class="string">"."</span>)); <span class="comment">//文件后缀名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">uploadPath</span> <span class="operator">=</span> <span class="string">"/driver/"</span> + path + <span class="string">"/"</span> + UUID.randomUUID().toString().replaceAll(<span class="string">"-"</span>, <span class="string">""</span>) + fileType;</span><br><span class="line">    <span class="type">PutObjectRequest</span> <span class="variable">putObjectRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PutObjectRequest</span>(tencentCloudProperties.getBucketPrivate(), uploadPath, file.getInputStream(), meta);</span><br><span class="line">    putObjectRequest.setStorageClass(StorageClass.Standard);</span><br><span class="line">    <span class="type">PutObjectResult</span> <span class="variable">putObjectResult</span> <span class="operator">=</span> cosClient.putObject(putObjectRequest); <span class="comment">//上传文件</span></span><br><span class="line">    log.info(JSON.toJSONString(putObjectResult));</span><br><span class="line">    cosClient.shutdown();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//审核图片</span></span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isAuditing</span> <span class="operator">=</span> ciService.imageAuditing(uploadPath);</span><br><span class="line">    <span class="keyword">if</span>(!isAuditing) {</span><br><span class="line">        <span class="comment">//删除违规图片</span></span><br><span class="line">        cosClient.deleteObject(tencentCloudProperties.getBucketPrivate(), uploadPath);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.IMAGE_AUDITION_FAIL);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装返回对象</span></span><br><span class="line">    <span class="type">CosUploadVo</span> <span class="variable">cosUploadVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CosUploadVo</span>();</span><br><span class="line">    cosUploadVo.setUrl(path);</span><br><span class="line">    <span class="comment">//图片临时访问url</span></span><br><span class="line">    cosUploadVo.setShowUrl(<span class="built_in">this</span>.getImageUrl(path));</span><br><span class="line">    <span class="keyword">return</span> cosUploadVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="6-4-feng-zhuang-wen-ben-shen-he-jie-kou">6.4、封装文本审核接口</span></h4><p>接口文档地址：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/460/61607">https://cloud.tencent.com/document/product/460/61607</a></p>
<p>审核结果文档地址：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/460/56284">https://cloud.tencent.com/document/product/460/56284</a></p>
<h5><span id="6-4-1-si-ji-wei-fu-wu-jie-kou">6.4.1、司机微服务接口</span></h5><h6><span id="6-4-1-1-cicontroller">6.4.1.1、CiController</span></h6><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> CiService ciService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "文本审核")</span></span><br><span class="line"><span class="meta">@PostMapping("/textAuditing")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;TextAuditingVo&gt; <span class="title function_">textAuditing</span><span class="params">(<span class="meta">@RequestBody</span> String content)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(ciService.textAuditing(content));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h6><span id="6-4-1-2-ciservice">6.4.1.2、CiService</span></h6><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TextAuditingVo <span class="title function_">textAuditing</span><span class="params">(String content)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h6><span id="6-4-1-3-ciserviceimpl">6.4.1.3、CiServiceImpl</span></h6><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> TextAuditingVo <span class="title function_">textAuditing</span><span class="params">(String content)</span> {</span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.hasText(content)) {</span><br><span class="line">        <span class="type">TextAuditingVo</span> <span class="variable">textAuditingVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TextAuditingVo</span>();</span><br><span class="line">        textAuditingVo.setResult(<span class="string">"0"</span>);</span><br><span class="line">        <span class="keyword">return</span> textAuditingVo;</span><br><span class="line">    }</span><br><span class="line">    <span class="type">COSClient</span> <span class="variable">cosClient</span> <span class="operator">=</span> <span class="built_in">this</span>.getPrivateCOSClient();</span><br><span class="line"></span><br><span class="line">    <span class="type">TextAuditingRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TextAuditingRequest</span>();</span><br><span class="line">    request.setBucketName(tencentCloudProperties.getBucketPrivate());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将图片转换为base64字符串</span></span><br><span class="line">    <span class="type">byte</span>[] encoder = org.apache.commons.codec.binary.Base64.encodeBase64(content.getBytes());</span><br><span class="line">    <span class="type">String</span> <span class="variable">contentBase64</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(encoder);</span><br><span class="line">    request.getInput().setContent(contentBase64);</span><br><span class="line">    request.getConf().setDetectType(<span class="string">"all"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">TextAuditingResponse</span> <span class="variable">response</span> <span class="operator">=</span> cosClient.createAuditingTextJobs(request);</span><br><span class="line">    <span class="type">AuditingJobsDetail</span> <span class="variable">detail</span> <span class="operator">=</span> response.getJobsDetail();</span><br><span class="line">    <span class="type">TextAuditingVo</span> <span class="variable">textAuditingVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TextAuditingVo</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"Success"</span>.equals(detail.getState())) {</span><br><span class="line">        <span class="comment">//检测结果: 0（审核正常），1 （判定为违规敏感文件），2（疑似敏感，建议人工复核）。</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> detail.getResult();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//违规关键词</span></span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">keywords</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        List&lt;SectionInfo&gt; sectionInfoList = detail.getSectionList();</span><br><span class="line">        <span class="keyword">for</span> (SectionInfo info : sectionInfoList) {</span><br><span class="line">            <span class="type">String</span> <span class="variable">pornInfoKeyword</span> <span class="operator">=</span> info.getPornInfo().getKeywords();</span><br><span class="line">            <span class="type">String</span> <span class="variable">illegalInfoKeyword</span> <span class="operator">=</span> info.getIllegalInfo().getKeywords();</span><br><span class="line">            <span class="type">String</span> <span class="variable">abuseInfoKeyword</span> <span class="operator">=</span> info.getAbuseInfo().getKeywords();</span><br><span class="line">            <span class="keyword">if</span> (pornInfoKeyword.length() &gt; <span class="number">0</span>) {</span><br><span class="line">                keywords.append(pornInfoKeyword).append(<span class="string">","</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (illegalInfoKeyword.length() &gt; <span class="number">0</span>) {</span><br><span class="line">                keywords.append(illegalInfoKeyword).append(<span class="string">","</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (abuseInfoKeyword.length() &gt; <span class="number">0</span>) {</span><br><span class="line">                keywords.append(abuseInfoKeyword).append(<span class="string">","</span>);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        textAuditingVo.setResult(result);</span><br><span class="line">        textAuditingVo.setKeywords(keywords.toString());</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> textAuditingVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="6-4-2-feign-jie-kou">6.4.2、Feign接口</span></h5><h6><span id="6-4-2-1-cifeignclient">6.4.2.1、CiFeignClient</span></h6><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文本审核</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> content</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping("/ci/textAuditing")</span></span><br><span class="line">Result&lt;TextAuditingVo&gt; <span class="title function_">textAuditing</span><span class="params">(<span class="meta">@RequestBody</span> String content)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="6-5-geng-xin-ding-dan-jian-kong-ji-lu">6.5、更新订单监控记录</span></h4><p>前面我们保存了司乘之间的对话文字内容，接下来我们要对文字内容加以审核，看看对话的内容是否包含色情或者暴力的成分，我们要对聊天内容做一个安全评级。如果用人工去监视司机和乘客之间的对话，那成本可太高了，而且也雇不起那么多人，所以我们要用AI去监控对话的内容。</p>
<p>上面我们封装了腾讯云数据万象文本审核接口，数据万象可以对用户上传的文本进行内容安全识别，能够做到识别准确率高、召回率高，多维度覆盖对内容识别的要求，并实时更新识别服务的识别标准和能力。</p>
<h5><span id="6-5-1-monitorserviceimpl">6.5.1、MonitorServiceImpl</span></h5><p>完整代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> FileService fileService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OrderMonitorFeignClient orderMonitorFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> CiFeignClient ciFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">upload</span><span class="params">(MultipartFile file, OrderMonitorForm orderMonitorForm)</span> {</span><br><span class="line">    <span class="comment">//上传对话文件</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> fileService.upload(file);</span><br><span class="line">    log.info(<span class="string">"upload: {}"</span>, url);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存订单监控记录信息</span></span><br><span class="line">    <span class="type">OrderMonitorRecord</span> <span class="variable">orderMonitorRecord</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderMonitorRecord</span>();</span><br><span class="line">    orderMonitorRecord.setOrderId(orderMonitorForm.getOrderId());</span><br><span class="line">    orderMonitorRecord.setFileUrl(url);</span><br><span class="line">    orderMonitorRecord.setContent(orderMonitorForm.getContent());</span><br><span class="line">    <span class="comment">//记录审核结果</span></span><br><span class="line">    <span class="type">TextAuditingVo</span> <span class="variable">textAuditingVo</span> <span class="operator">=</span> ciFeignClient.textAuditing(orderMonitorForm.getContent()).getData();</span><br><span class="line">    orderMonitorRecord.setResult(textAuditingVo.getResult());</span><br><span class="line">    orderMonitorRecord.setKeywords(textAuditingVo.getKeywords());</span><br><span class="line">    orderMonitorFeignClient.saveMonitorRecord(orderMonitorRecord);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="7-ding-dan-jian-kong-tong-ji">7、订单监控统计</span></h3><p>我们必须对司乘之间的对话内容做监控，保障乘客人身安全是我们首要的任务。腾讯的数据万象服务可以审核文本内容，咱们要把这个功能利用起来。我们调用腾讯万象的接口，审核司乘之间的对话内容，看看是否包含色情或者暴力的成分。审核的结果咱们要更新到order_monitor数据表中，每个订单一条记录。</p>
<p>order_monitor表：</p>
<p><img src="/2024/09/26/projection-daijia/1699511786878.png" alt="69951178687"></p>
<h4><span id="7-1-cha-ru-ding-dan-jian-kong-wei-fu-wu-jie-kou">7.1、插入订单监控微服务接口</span></h4><p>司机端小程序点击开始代驾，我们就可以初始化这条记录。下面我们保存订单接口、获取与修改实现了，后续要使用。</p>
<h5><span id="7-1-1-ordermonitorcontroller">7.1.1、OrderMonitorController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "根据订单id获取订单监控信息")</span></span><br><span class="line"><span class="meta">@GetMapping("/getOrderMonitor/{orderId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderMonitor&gt; <span class="title function_">getOrderMonitor</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderMonitorService.getOrderMonitor(orderId));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "更新订单监控信息")</span></span><br><span class="line"><span class="meta">@PostMapping("/updateOrderMonitor")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">updateOrderMonitor</span><span class="params">(<span class="meta">@RequestBody</span> OrderMonitor OrderMonitor)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderMonitorService.updateOrderMonitor(OrderMonitor));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="7-1-2-monitorservice">7.1.2、MonitorService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Long <span class="title function_">saveOrderMonitor</span><span class="params">(OrderMonitor orderMonitor)</span>;</span><br><span class="line"></span><br><span class="line">OrderMonitor <span class="title function_">getOrderMonitor</span><span class="params">(Long orderId)</span>;</span><br><span class="line"></span><br><span class="line">Boolean <span class="title function_">updateOrderMonitor</span><span class="params">(OrderMonitor orderMonitor)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="7-1-3-monitorserviceimpl">7.1.3、MonitorServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OrderMonitorMapper orderMonitorMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">saveOrderMonitor</span><span class="params">(OrderMonitor orderMonitor)</span> {</span><br><span class="line">    orderMonitorMapper.insert(orderMonitor);</span><br><span class="line">    <span class="keyword">return</span> orderMonitor.getId();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> OrderMonitor <span class="title function_">getOrderMonitor</span><span class="params">(Long orderId)</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.getOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;OrderMonitor&gt;().eq(OrderMonitor::getOrderId, orderId));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">updateOrderMonitor</span><span class="params">(OrderMonitor orderMonitor)</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.updateById(orderMonitor);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="7-2-feign-jie-kou">7.2、Feign接口</span></h4><h5><span id="7-2-1-ordermonitorfeignclient">7.2.1、OrderMonitorFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据订单id获取订单监控信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/order/monitor/getOrderMonitor/{orderId}")</span></span><br><span class="line">Result&lt;OrderMonitor&gt; <span class="title function_">getOrderMonitor</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更新订单监控信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> OrderMonitor</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping("/order/monitor/updateOrderMonitor")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">updateOrderMonitor</span><span class="params">(<span class="meta">@RequestBody</span> OrderMonitor OrderMonitor)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="7-3-kai-shi-dai-jia-chu-shi-hua-jian-kong-tong-ji-shu-ju">7.3、开始代驾初始化监控统计数据</span></h4><p>监控数据在代驾开始才会产生，因此我们在代驾开始时，初始化监控统计数据。</p>
<h5><span id="7-3-1-orderinfoserviceimpl">7.3.1、OrderInfoServiceImpl</span></h5><p>订单微服务service方法</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OrderMonitorService orderMonitorService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">startDrive</span><span class="params">(StartDriveForm startDriveForm)</span> {</span><br><span class="line">   LambdaQueryWrapper&lt;OrderInfo&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">   queryWrapper.eq(OrderInfo::getId, startDriveForm.getOrderId());</span><br><span class="line">   queryWrapper.eq(OrderInfo::getDriverId, startDriveForm.getDriverId());</span><br><span class="line"></span><br><span class="line">   <span class="type">OrderInfo</span> <span class="variable">updateOrderInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfo</span>();</span><br><span class="line">   updateOrderInfo.setStatus(OrderStatus.START_SERVICE.getStatus());</span><br><span class="line">   updateOrderInfo.setStartServiceTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">   <span class="comment">//只能更新自己的订单</span></span><br><span class="line">   <span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> orderInfoMapper.update(updateOrderInfo, queryWrapper);</span><br><span class="line">   <span class="keyword">if</span>(row == <span class="number">1</span>) {</span><br><span class="line">      <span class="comment">//记录日志</span></span><br><span class="line">      <span class="built_in">this</span>.log(startDriveForm.getOrderId(), OrderStatus.START_SERVICE.getStatus());</span><br><span class="line">   } <span class="keyword">else</span> {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.UPDATE_ERROR);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">//初始化订单监控统计数据</span></span><br><span class="line">   <span class="type">OrderMonitor</span> <span class="variable">orderMonitor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderMonitor</span>();</span><br><span class="line">   orderMonitor.setOrderId(startDriveForm.getOrderId());</span><br><span class="line">   orderMonitorService.saveOrderMonitor(orderMonitor);</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="7-3-geng-xin-ding-dan-jian-kong-ji-lu-jie-kou">7.3、更新订单监控记录接口</span></h4><h5><span id="7-3-1-monitorserviceimpl">7.3.1、MonitorServiceImpl</span></h5><p>完整代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> FileService fileService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OrderMonitorFeignClient orderMonitorFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> CiFeignClient ciFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">upload</span><span class="params">(MultipartFile file, OrderMonitorForm orderMonitorForm)</span> {</span><br><span class="line">    <span class="comment">//上传对话文件</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> fileService.upload(file);</span><br><span class="line">    log.info(<span class="string">"upload: {}"</span>, url);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//保存订单监控记录信息</span></span><br><span class="line">    <span class="type">OrderMonitorRecord</span> <span class="variable">orderMonitorRecord</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderMonitorRecord</span>();</span><br><span class="line">    orderMonitorRecord.setOrderId(orderMonitorForm.getOrderId());</span><br><span class="line">    orderMonitorRecord.setFileUrl(url);</span><br><span class="line">    orderMonitorRecord.setContent(orderMonitorForm.getContent());</span><br><span class="line">    <span class="comment">//记录审核结果</span></span><br><span class="line">    <span class="type">TextAuditingVo</span> <span class="variable">textAuditingVo</span> <span class="operator">=</span> ciFeignClient.textAuditing(orderMonitorForm.getContent()).getData();</span><br><span class="line">    orderMonitorRecord.setResult(textAuditingVo.getResult());</span><br><span class="line">    orderMonitorRecord.setKeywords(textAuditingVo.getKeywords());</span><br><span class="line">    orderMonitorFeignClient.saveMonitorRecord(orderMonitorRecord);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新订单监控统计</span></span><br><span class="line">    <span class="type">OrderMonitor</span> <span class="variable">orderMonitor</span> <span class="operator">=</span> orderMonitorFeignClient.getOrderMonitor(orderMonitorForm.getOrderId()).getData();</span><br><span class="line">    <span class="type">int</span> <span class="variable">fileNum</span> <span class="operator">=</span> orderMonitor.getFileNum() + <span class="number">1</span>;</span><br><span class="line">    orderMonitor.setFileNum(fileNum);</span><br><span class="line">    <span class="comment">//审核结果: 0（审核正常），1 （判定为违规敏感文件），2（疑似敏感，建议人工复核）。</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">"3"</span>.equals(orderMonitorRecord.getResult())) {</span><br><span class="line">        <span class="type">int</span> <span class="variable">auditNum</span> <span class="operator">=</span> orderMonitor.getAuditNum() + <span class="number">1</span>;</span><br><span class="line">        orderMonitor.setAuditNum(auditNum);</span><br><span class="line">    }</span><br><span class="line">    orderMonitorFeignClient.updateOrderMonitor(orderMonitor);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h1><span id="xi-ding-dan-zhi-xing-san">XI.订单执行（三）</span></h1><p>司机到达代驾终点，就可以结束代驾了，结束代驾我们要输入其他费用（路桥费、停车费与其他费用）、计算订单实际里程、计算代驾实际费用、系统奖励、分账信息与生成账单。</p>
<p><img src="/2024/09/26/projection-daijia/end_order.gif" alt="end_order"></p>
<h3><span id="1-ji-suan-ding-dan-shi-ji-li-cheng">1、计算订单实际里程</span></h3><p>订单实际里程其实就是把MongoDB中该订单的GPS定位坐标都给取出来，以时间排序，连接成连线，这个线的距离就是时间里程。</p>
<h4><span id="1-1-di-tu-wei-fu-wu-jie-kou">1.1、地图微服务接口</span></h4><h5><span id="1-1-1-locationutil">1.1.1、LocationUtil</span></h5><p>工具类可以添加到common-util模块</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.common.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocationUtil</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 地球赤道半径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">double</span> <span class="variable">EARTH_RADIUS</span> <span class="operator">=</span> <span class="number">6378.137</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//等同——Math.toRadians()</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">double</span> <span class="title function_">rad</span><span class="params">(<span class="type">double</span> d)</span> {</span><br><span class="line">        <span class="keyword">return</span> d * Math.PI / <span class="number">180.0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @描述 经纬度获取距离，单位为米</span></span><br><span class="line"><span class="comment">     * @参数 [lat1, lng1, lat2, lng2]</span></span><br><span class="line"><span class="comment">     * @返回值 double</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">double</span> <span class="title function_">getDistance</span><span class="params">(<span class="type">double</span> lat1, <span class="type">double</span> lng1, <span class="type">double</span> lat2,</span></span><br><span class="line"><span class="params">                                     <span class="type">double</span> lng2)</span> {</span><br><span class="line">        <span class="type">double</span> <span class="variable">radLat1</span> <span class="operator">=</span> rad(lat1);</span><br><span class="line">        <span class="type">double</span> <span class="variable">radLat2</span> <span class="operator">=</span> rad(lat2);</span><br><span class="line">        <span class="type">double</span> <span class="variable">a</span> <span class="operator">=</span> radLat1 - radLat2;</span><br><span class="line">        <span class="type">double</span> <span class="variable">b</span> <span class="operator">=</span> rad(lng1) - rad(lng2);</span><br><span class="line">        <span class="type">double</span> <span class="variable">s</span> <span class="operator">=</span> <span class="number">2</span> * Math.asin(Math.sqrt(Math.pow(Math.sin(a / <span class="number">2</span>), <span class="number">2</span>)</span><br><span class="line">                + Math.cos(radLat1) * Math.cos(radLat2)</span><br><span class="line">                * Math.pow(Math.sin(b / <span class="number">2</span>), <span class="number">2</span>)));</span><br><span class="line">        s = s * EARTH_RADIUS;</span><br><span class="line">        s = Math.round(s * <span class="number">10000d</span>) / <span class="number">10000d</span>;</span><br><span class="line">        s = s * <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">double</span> <span class="variable">distance</span> <span class="operator">=</span> getDistance(<span class="number">30.57404</span>, <span class="number">104.073013</span>,</span><br><span class="line">                <span class="number">30.509376</span>, <span class="number">104.077001</span>);</span><br><span class="line">        System.out.println(<span class="string">"距离"</span> + distance + <span class="string">"米"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-2-locationcontroller">1.1.2、LocationController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "代驾服务：计算订单实际里程")</span></span><br><span class="line"><span class="meta">@GetMapping("/calculateOrderRealDistance/{orderId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;BigDecimal&gt; <span class="title function_">calculateOrderRealDistance</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(locationService.calculateOrderRealDistance(orderId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-3-locationservice">1.1.3、LocationService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BigDecimal <span class="title function_">calculateOrderRealDistance</span><span class="params">(Long orderId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-4-locationserviceimpl">1.1.4、LocationServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OrderInfoFeignClient orderInfoFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> BigDecimal <span class="title function_">calculateOrderRealDistance</span><span class="params">(Long orderId)</span> {</span><br><span class="line">    List&lt;OrderServiceLocation&gt; orderServiceLocationList = orderServiceLocationRepository.findByOrderIdOrderByCreateTimeAsc(orderId);</span><br><span class="line">    <span class="type">double</span> <span class="variable">realDistance</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(!CollectionUtils.isEmpty(orderServiceLocationList)) {</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, size=orderServiceLocationList.size()-<span class="number">1</span>; i &lt; size; i++) {</span><br><span class="line">            <span class="type">OrderServiceLocation</span> <span class="variable">location1</span> <span class="operator">=</span> orderServiceLocationList.get(i);</span><br><span class="line">            <span class="type">OrderServiceLocation</span> <span class="variable">location2</span> <span class="operator">=</span> orderServiceLocationList.get(i+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">double</span> <span class="variable">distance</span> <span class="operator">=</span> LocationUtil.getDistance(location1.getLatitude().doubleValue(), location1.getLongitude().doubleValue(), location2.getLatitude().doubleValue(), location2.getLongitude().doubleValue());</span><br><span class="line">            realDistance += distance;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//测试过程中，没有真正代驾，实际代驾GPS位置没有变化，模拟：实际代驾里程 = 预期里程 + 5</span></span><br><span class="line">    <span class="keyword">if</span>(realDistance == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> orderInfoFeignClient.getOrderInfo(orderId).getData().getExpectDistance().add(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"5"</span>));</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(realDistance);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-5-orderservicelocationrepository">1.1.5、OrderServiceLocationRepository</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;OrderServiceLocation&gt; <span class="title function_">findByOrderIdOrderByCreateTimeAsc</span><span class="params">(Long orderId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-feign-jie-kou">1.2、Feign接口</span></h4><h5><span id="1-2-1-locationfeignclient">1.2.1、LocationFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 代驾服务：计算订单实际里程</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/map/location/calculateOrderRealDistance/{orderId}")</span></span><br><span class="line">Result&lt;BigDecimal&gt; <span class="title function_">calculateOrderRealDistance</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-ji-suan-xi-tong-jiang-li">2、计算系统奖励</span></h3><p>系统奖励规则：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">系统奖励</span><br><span class="line">    每天完成5单后 每单奖励2元</span><br><span class="line">    每天完成10单后 每单奖励5元</span><br><span class="line">    每天完成20单后 每单奖励10元</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-1-gui-ze-wei-fu-wu-jie-kou">2.1、规则微服务接口</span></h4><h5><span id="2-1-1-rewardrulerequestform">2.1.1、RewardRuleRequestForm</span></h5><p>输入参数：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.model.form.rules;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RewardRuleRequestForm</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "订单个数")</span></span><br><span class="line">    <span class="keyword">private</span> Long orderNum;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h5><span id="2-1-2-rewardruleresponsevo">2.1.2、RewardRuleResponseVo</span></h5><p>输出参数：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.model.vo.rules;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RewardRuleResponseVo</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "奖励规则ID")</span></span><br><span class="line">    <span class="keyword">private</span> Long rewardRuleId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "奖励金额")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal rewardAmount;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h5><span id="2-1-3-gui-ze-wen-ben">2.1.3、规则文本</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//package对应的不一定是真正的目录，可以任意写com.abc，同一个包下的drl文件可以相互访问</span></span><br><span class="line"><span class="keyword">package</span>  com.atguigu.daijia</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.model.form.rules.RewardRuleRequest;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.math.RoundingMode;</span><br><span class="line"></span><br><span class="line">global com.atguigu.daijia.model.vo.rules.RewardRuleResponse rewardRuleResponse;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">系统奖励</span></span><br><span class="line"><span class="comment">    每天完成5单后 每单奖励2元</span></span><br><span class="line"><span class="comment">    每天完成10单后 每单奖励5元</span></span><br><span class="line"><span class="comment">    每天完成20单后 每单奖励10元</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">rule <span class="string">"完成5单后 每单奖励2元"</span></span><br><span class="line">    salience <span class="number">10</span>          <span class="comment">//指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span></span><br><span class="line">    no-loop <span class="literal">true</span>         <span class="comment">//防止陷入死循环</span></span><br><span class="line">    when</span><br><span class="line">        <span class="comment">/*规则条件，到工作内存中查找FeeRuleRequest对象</span></span><br><span class="line"><span class="comment">        里面出来的结果只能是ture或者false</span></span><br><span class="line"><span class="comment">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span></span><br><span class="line">        $rule:RewardRuleRequest(orderNum &gt;= <span class="number">5</span> &amp;&amp; orderNum &lt; <span class="number">10</span>)</span><br><span class="line">    then</span><br><span class="line">        rewardRuleResponse.setRewardAmount(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"2.0"</span>));</span><br><span class="line">        System.out.println(<span class="string">"完成10单后 奖励："</span> + rewardRuleResponse.getRewardAmount() + <span class="string">"元"</span>);</span><br><span class="line">end</span><br><span class="line">rule <span class="string">"完成10单后 每单奖励5元"</span></span><br><span class="line">    salience <span class="number">10</span>          <span class="comment">//指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span></span><br><span class="line">    no-loop <span class="literal">true</span>         <span class="comment">//防止陷入死循环</span></span><br><span class="line">    when</span><br><span class="line">        <span class="comment">/*规则条件，到工作内存中查找FeeRuleRequest对象</span></span><br><span class="line"><span class="comment">        里面出来的结果只能是ture或者false</span></span><br><span class="line"><span class="comment">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span></span><br><span class="line">        $rule:RewardRuleRequest(orderNum &gt;= <span class="number">10</span> &amp;&amp; orderNum &lt; <span class="number">20</span>)</span><br><span class="line">    then</span><br><span class="line">        rewardRuleResponse.setRewardAmount(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"5.0"</span>));</span><br><span class="line">        System.out.println(<span class="string">"完成10单后 奖励："</span> + rewardRuleResponse.getRewardAmount() + <span class="string">"元"</span>);</span><br><span class="line">end</span><br><span class="line">rule <span class="string">"完成20单后 每单奖励10元"</span></span><br><span class="line">    salience <span class="number">10</span>          <span class="comment">//指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span></span><br><span class="line">    no-loop <span class="literal">true</span>         <span class="comment">//防止陷入死循环</span></span><br><span class="line">    when</span><br><span class="line">        <span class="comment">/*规则条件，到工作内存中查找FeeRuleRequest对象</span></span><br><span class="line"><span class="comment">        里面出来的结果只能是ture或者false</span></span><br><span class="line"><span class="comment">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span></span><br><span class="line">        $rule:RewardRuleRequest(orderNum &gt;= <span class="number">20</span>)</span><br><span class="line">    then</span><br><span class="line">        rewardRuleResponse.setRewardAmount(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"10.0"</span>));</span><br><span class="line">        System.out.println(<span class="string">"完成20单后 奖励："</span> + rewardRuleResponse.getRewardAmount() + <span class="string">"元"</span>);</span><br><span class="line">end</span><br></pre></td></tr></tbody></table></figure>



<h5><span id="2-1-4-droolshelper">2.1.4、DroolsHelper</span></h5><p>定义一个Drools帮助类，接收规则文件，返回KieSession即可</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DroolsHelper</span> {</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RULES_CUSTOMER_RULES_DRL</span> <span class="operator">=</span> <span class="string">"rules/FeeRule.drl"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> KieSession <span class="title function_">loadForRule</span><span class="params">(String drlStr)</span> {</span><br><span class="line">         <span class="type">KieServices</span> <span class="variable">kieServices</span> <span class="operator">=</span> KieServices.Factory.get();</span><br><span class="line">        </span><br><span class="line">        <span class="type">KieFileSystem</span> <span class="variable">kieFileSystem</span> <span class="operator">=</span> kieServices.newKieFileSystem();</span><br><span class="line">    kieFileSystem.write(</span><br><span class="line">        ResourceFactory.newClassPathResource(drlStr));</span><br><span class="line">        </span><br><span class="line">        <span class="type">KieBuilder</span> <span class="variable">kb</span> <span class="operator">=</span> kieServices.newKieBuilder(kieFileSystem);</span><br><span class="line">        kb.buildAll();</span><br><span class="line"></span><br><span class="line">        <span class="type">KieModule</span> <span class="variable">kieModule</span> <span class="operator">=</span> kb.getKieModule();</span><br><span class="line">        <span class="type">KieContainer</span> <span class="variable">kieContainer</span> <span class="operator">=</span> kieServices.newKieContainer(kieModule.getReleaseId());</span><br><span class="line">        <span class="keyword">return</span> kieContainer.newKieSession();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h5><span id="2-1-5-rewardrulecontroller">2.1.5、RewardRuleController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RewardRuleService rewardRuleService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "计算订单奖励费用")</span></span><br><span class="line"><span class="meta">@PostMapping("/calculateOrderRewardFee")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;RewardRuleResponseVo&gt; <span class="title function_">calculateOrderRewardFee</span><span class="params">(<span class="meta">@RequestBody</span> RewardRuleRequestForm rewardRuleRequestForm)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(rewardRuleService.calculateOrderRewardFee(rewardRuleRequestForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h5><span id="2-1-6-rewardruleservice">2.1.6、RewardRuleService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RewardRuleResponseVo </span><br><span class="line">    <span class="title function_">calculateOrderRewardFee</span><span class="params">(RewardRuleRequestForm rewardRuleRequestForm)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h5><span id="2-1-7-rewardruleserviceimpl">2.1.7、RewardRuleServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RewardRuleMapper rewardRuleMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> RewardRuleResponseVo <span class="title function_">calculateOrderRewardFee</span><span class="params">(RewardRuleRequestForm rewardRuleRequestForm)</span> {</span><br><span class="line">    <span class="comment">//封装传入对象</span></span><br><span class="line">    <span class="type">RewardRuleRequest</span> <span class="variable">rewardRuleRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RewardRuleRequest</span>();</span><br><span class="line">    rewardRuleRequest.setOrderNum(rewardRuleRequestForm.getOrderNum());</span><br><span class="line">    log.info(<span class="string">"传入参数：{}"</span>, JSON.toJSONString(rewardRuleRequest));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取最新订单费用规则</span></span><br><span class="line">    <span class="type">RewardRule</span> <span class="variable">rewardRule</span> <span class="operator">=</span> rewardRuleMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;RewardRule&gt;().orderByDesc(RewardRule::getId).last(<span class="string">"limit 1"</span>));</span><br><span class="line">    <span class="type">KieSession</span> <span class="variable">kieSession</span> <span class="operator">=</span> DroolsHelper.loadForRule(rewardRule.getRule());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装返回对象</span></span><br><span class="line">    <span class="type">RewardRuleResponse</span> <span class="variable">rewardRuleResponse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RewardRuleResponse</span>();</span><br><span class="line">    kieSession.setGlobal(<span class="string">"rewardRuleResponse"</span>, rewardRuleResponse);</span><br><span class="line">    <span class="comment">// 设置订单对象</span></span><br><span class="line">    kieSession.insert(rewardRuleRequest);</span><br><span class="line">    <span class="comment">// 触发规则</span></span><br><span class="line">    kieSession.fireAllRules();</span><br><span class="line">    <span class="comment">// 中止会话</span></span><br><span class="line">    kieSession.dispose();</span><br><span class="line">    log.info(<span class="string">"计算结果：{}"</span>, JSON.toJSONString(rewardRuleResponse));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装返回对象</span></span><br><span class="line">    <span class="type">RewardRuleResponseVo</span> <span class="variable">rewardRuleResponseVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RewardRuleResponseVo</span>();</span><br><span class="line">    rewardRuleResponseVo.setRewardRuleId(rewardRule.getId());</span><br><span class="line">    rewardRuleResponseVo.setRewardAmount(rewardRuleResponse.getRewardAmount());</span><br><span class="line">    <span class="keyword">return</span> rewardRuleResponseVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="2-2-feign-jie-kou">2.2、Feign接口</span></h4><h5><span id="2-2-1-rewardrulefeignclient">2.2.1、RewardRuleFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算订单奖励费用</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> rewardRuleRequestForm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping("/rules/reward/calculateOrderRewardFee")</span></span><br><span class="line">Result&lt;RewardRuleResponseVo&gt; <span class="title function_">calculateOrderRewardFee</span><span class="params">(<span class="meta">@RequestBody</span> RewardRuleRequestForm rewardRuleRequestForm)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-gen-ju-shi-jian-duan-huo-qu-ding-dan-shu">3、根据时间段获取订单数</span></h3><h4><span id="3-1-ding-dan-wei-fu-wu-jie-kou">3.1、订单微服务接口</span></h4><h5><span id="3-1-1-orderinfocontroller">3.1.1、OrderInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "根据时间段获取订单数")</span></span><br><span class="line"><span class="meta">@GetMapping("/getOrderNumByTime/{startTime}/{endTime}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Long&gt; <span class="title function_">getOrderNumByTime</span><span class="params">(<span class="meta">@PathVariable</span> String startTime, <span class="meta">@PathVariable</span> String endTime)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(orderInfoService.getOrderNumByTime(startTime, endTime));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-2-orderinfoservice">3.1.2、OrderInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Long <span class="title function_">getOrderNumByTime</span><span class="params">(String startTime, String endTime)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-3-orderinfoserviceimpl">3.1.3、OrderInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Long <span class="title function_">getOrderNumByTime</span><span class="params">(String startTime, String endTime)</span> {</span><br><span class="line">LambdaQueryWrapper&lt;OrderInfo&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">queryWrapper.ge(OrderInfo::getStartServiceTime, startTime);</span><br><span class="line">queryWrapper.lt(OrderInfo::getStartServiceTime, endTime);</span><br><span class="line"><span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> orderInfoMapper.selectCount(queryWrapper);</span><br><span class="line"><span class="keyword">return</span> count;</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="3-2-feign-jie-kou">3.2、Feign接口</span></h4><h5><span id="3-2-1-orderinfofeignclient">3.2.1、OrderInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  根据时间段获取订单数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> startTime</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> endTime</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/order/info/getOrderNumByTime/{startTime}/{endTime}")</span></span><br><span class="line">Result&lt;Long&gt; <span class="title function_">getOrderNumByTime</span><span class="params">(<span class="meta">@PathVariable("startTime")</span> String startTime, <span class="meta">@PathVariable("endTime")</span> String endTime)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-ji-suan-fen-zhang-xin-xi">4、计算分账信息</span></h3><p>结束代驾，我们还要计算分账信息，将分账信息记录数据库表，用户支付后，实时分账。</p>
<p>分账表信息</p>
<p><img src="/2024/09/26/projection-daijia/1699582861217.png" alt="69958286121"></p>
<p>分账规则：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">支付微信平台费用</span><br><span class="line">    平台费率：0.6%</span><br><span class="line">   </span><br><span class="line">订单金额小于等于100</span><br><span class="line">    当天完成订单小于等于10单 平台抽成 20%</span><br><span class="line">    当天完成订单大于10单 平台抽成 18%</span><br><span class="line">    </span><br><span class="line">订单金额大于100</span><br><span class="line">    当天完成订单小于等于10单 平台抽成 18%</span><br><span class="line">    当天完成订单大于10单 平台抽成 16%</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-1-gui-ze-wei-fu-wu-jie-kou">4.1、规则微服务接口</span></h4><h5><span id="4-1-1-rewardrulerequestform">4.1.1、RewardRuleRequestForm</span></h5><p>输入参数：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.model.form.rules;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProfitsharingRuleRequestForm</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "订单金额")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal orderAmount;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "当天完成订单个数")</span></span><br><span class="line">    <span class="keyword">private</span> Long orderNum;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-2-rewardruleresponsevo">4.1.2、RewardRuleResponseVo</span></h5><p>输出参数：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.model.vo.rules;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProfitsharingRuleResponseVo</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "分账规则ID")</span></span><br><span class="line">    <span class="keyword">private</span> Long profitsharingRuleId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "订单金额")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal orderAmount;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "微信支付平台费率")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal paymentRate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "微信支付平台费用")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal paymentFee;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "代驾司机代缴个税税率")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal driverTaxRate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "代驾司机税率支出费用")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal driverTaxFee;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "平台分账收入")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal platformIncome;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Schema(description = "司机分账收入")</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal driverIncome;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-3-gui-ze-wen-ben">4.1.3、规则文本</span></h5><p>放入reward_rule数据库表</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//package对应的不一定是真正的目录，可以任意写com.abc，同一个包下的drl文件可以相互访问</span></span><br><span class="line"><span class="keyword">package</span>  com.atguigu.daijia</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.model.form.rules.ProfitsharingRuleRequest;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.math.RoundingMode;</span><br><span class="line"></span><br><span class="line">global com.atguigu.daijia.model.vo.rules.ProfitsharingRuleResponse profitsharingRuleResponse;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">支付微信平台费用</span></span><br><span class="line"><span class="comment">    平台费率：0.6%</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">rule <span class="string">"支付微信平台费用 平台费率：0.6%"</span></span><br><span class="line">    salience <span class="number">10</span>          <span class="comment">//指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span></span><br><span class="line">    no-loop <span class="literal">true</span>         <span class="comment">//防止陷入死循环</span></span><br><span class="line">    when</span><br><span class="line">        <span class="comment">/*规则条件，到工作内存中查找FeeRuleRequest对象</span></span><br><span class="line"><span class="comment">        里面出来的结果只能是ture或者false</span></span><br><span class="line"><span class="comment">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span></span><br><span class="line">        $rule:ProfitsharingRuleRequest()</span><br><span class="line">    then</span><br><span class="line">        profitsharingRuleResponse.setOrderAmount($rule.getOrderAmount());</span><br><span class="line">        profitsharingRuleResponse.setPaymentRate(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"0.006"</span>));</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">paymentFee</span> <span class="operator">=</span> profitsharingRuleResponse.getOrderAmount().multiply(profitsharingRuleResponse.getPaymentRate()).setScale(<span class="number">2</span>, RoundingMode.HALF_UP);</span><br><span class="line">        profitsharingRuleResponse.setPaymentFee(paymentFee);</span><br><span class="line">        System.out.println(<span class="string">"支付微信平台费用："</span> + profitsharingRuleResponse.getPaymentFee() + <span class="string">"元"</span>);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">订单金额小于等于100</span></span><br><span class="line"><span class="comment">    当天完成订单小于等于10单 平台抽成 20%</span></span><br><span class="line"><span class="comment">    当天完成订单大于10单 平台抽成 18%</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">rule <span class="string">"订单金额小于等于100 当天完成订单小于等于10单"</span></span><br><span class="line">    salience <span class="number">10</span>          <span class="comment">//指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span></span><br><span class="line">    no-loop <span class="literal">true</span>         <span class="comment">//防止陷入死循环</span></span><br><span class="line">    when</span><br><span class="line">        <span class="comment">/*规则条件，到工作内存中查找FeeRuleRequest对象</span></span><br><span class="line"><span class="comment">        里面出来的结果只能是ture或者false</span></span><br><span class="line"><span class="comment">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span></span><br><span class="line">        $rule:ProfitsharingRuleRequest(orderAmount.doubleValue() &lt;= <span class="number">100.0</span> &amp;&amp; orderNum &lt;= <span class="number">10</span>)</span><br><span class="line">    then</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">totalAmount</span> <span class="operator">=</span> profitsharingRuleResponse.getOrderAmount().subtract(profitsharingRuleResponse.getPaymentFee());</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">platformIncome</span> <span class="operator">=</span> totalAmount.multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"0.2"</span>)).setScale(<span class="number">2</span>, RoundingMode.HALF_UP);</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">driverTotalIncome</span> <span class="operator">=</span> totalAmount.subtract(platformIncome);</span><br><span class="line">        <span class="comment">//代驾司机个税，税率：10%</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">driverTaxFee</span> <span class="operator">=</span> driverTotalIncome.multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"0.1"</span>)).setScale(<span class="number">2</span>, RoundingMode.HALF_UP);</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">driverIncome</span> <span class="operator">=</span> driverTotalIncome.subtract(driverTaxFee);</span><br><span class="line">        profitsharingRuleResponse.setPlatformIncome(platformIncome);</span><br><span class="line">        profitsharingRuleResponse.setDriverIncome(driverIncome);</span><br><span class="line">        profitsharingRuleResponse.setDriverTaxRate(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"0.1"</span>));</span><br><span class="line">        profitsharingRuleResponse.setDriverTaxFee(driverTaxFee);</span><br><span class="line">        System.out.println(<span class="string">"平台分账收入："</span> + platformIncome + <span class="string">"元"</span> + <span class="string">"，司机分账收入："</span> + driverIncome + <span class="string">"元"</span> + <span class="string">"，司机个税："</span> + driverTaxFee + <span class="string">"元"</span>);</span><br><span class="line">end</span><br><span class="line">rule <span class="string">"订单金额小于等于100 天完成订单大于10单"</span></span><br><span class="line">    salience <span class="number">10</span>          <span class="comment">//指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span></span><br><span class="line">    no-loop <span class="literal">true</span>         <span class="comment">//防止陷入死循环</span></span><br><span class="line">    when</span><br><span class="line">        <span class="comment">/*规则条件，到工作内存中查找FeeRuleRequest对象</span></span><br><span class="line"><span class="comment">        里面出来的结果只能是ture或者false</span></span><br><span class="line"><span class="comment">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span></span><br><span class="line">        $rule:ProfitsharingRuleRequest(orderAmount.doubleValue() &lt;= <span class="number">100.0</span> &amp;&amp; orderNum &gt; <span class="number">10</span>)</span><br><span class="line">    then</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">totalAmount</span> <span class="operator">=</span> profitsharingRuleResponse.getOrderAmount().subtract(profitsharingRuleResponse.getPaymentFee());</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">platformIncome</span> <span class="operator">=</span> totalAmount.multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"0.18"</span>)).setScale(<span class="number">2</span>, RoundingMode.HALF_UP);</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">driverTotalIncome</span> <span class="operator">=</span> totalAmount.subtract(platformIncome);</span><br><span class="line">        <span class="comment">//代驾司机个税，税率：10%</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">driverTaxFee</span> <span class="operator">=</span> driverTotalIncome.multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"0.1"</span>)).setScale(<span class="number">2</span>, RoundingMode.HALF_UP);</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">driverIncome</span> <span class="operator">=</span> driverTotalIncome.subtract(driverTaxFee);</span><br><span class="line">        profitsharingRuleResponse.setPlatformIncome(platformIncome);</span><br><span class="line">        profitsharingRuleResponse.setDriverIncome(driverIncome);</span><br><span class="line">        profitsharingRuleResponse.setDriverTaxRate(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"0.1"</span>));</span><br><span class="line">        profitsharingRuleResponse.setDriverTaxFee(driverTaxFee);</span><br><span class="line">        System.out.println(<span class="string">"平台分账收入："</span> + platformIncome + <span class="string">"元"</span> + <span class="string">"，司机分账收入："</span> + driverIncome + <span class="string">"元"</span> + <span class="string">"，司机个税："</span> + driverTaxFee + <span class="string">"元"</span>);</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">订单金额大于100</span></span><br><span class="line"><span class="comment">    当天完成订单小于等于10单 平台抽成 18%</span></span><br><span class="line"><span class="comment">    当天完成订单大于10单 平台抽成 16%</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">rule <span class="string">"订单金额大于100 当天完成订单小于等于10单"</span></span><br><span class="line">    salience <span class="number">10</span>          <span class="comment">//指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span></span><br><span class="line">    no-loop <span class="literal">true</span>         <span class="comment">//防止陷入死循环</span></span><br><span class="line">    when</span><br><span class="line">        <span class="comment">/*规则条件，到工作内存中查找FeeRuleRequest对象</span></span><br><span class="line"><span class="comment">        里面出来的结果只能是ture或者false</span></span><br><span class="line"><span class="comment">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span></span><br><span class="line">        $rule:ProfitsharingRuleRequest(orderAmount.doubleValue() &gt; <span class="number">100.0</span> &amp;&amp; orderNum &lt;= <span class="number">10</span>)</span><br><span class="line">    then</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">totalAmount</span> <span class="operator">=</span> profitsharingRuleResponse.getOrderAmount().subtract(profitsharingRuleResponse.getPaymentFee());</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">platformIncome</span> <span class="operator">=</span> totalAmount.multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"0.18"</span>)).setScale(<span class="number">2</span>, RoundingMode.HALF_UP);</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">driverTotalIncome</span> <span class="operator">=</span> totalAmount.subtract(platformIncome);</span><br><span class="line">        <span class="comment">//代驾司机个税，税率：10%</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">driverTaxFee</span> <span class="operator">=</span> driverTotalIncome.multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"0.1"</span>)).setScale(<span class="number">2</span>, RoundingMode.HALF_UP);</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">driverIncome</span> <span class="operator">=</span> driverTotalIncome.subtract(driverTaxFee);</span><br><span class="line">        profitsharingRuleResponse.setPlatformIncome(platformIncome);</span><br><span class="line">        profitsharingRuleResponse.setDriverIncome(driverIncome);</span><br><span class="line">        profitsharingRuleResponse.setDriverTaxRate(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"0.1"</span>));</span><br><span class="line">        profitsharingRuleResponse.setDriverTaxFee(driverTaxFee);</span><br><span class="line">        System.out.println(<span class="string">"平台分账收入："</span> + platformIncome + <span class="string">"元"</span> + <span class="string">"，司机分账收入："</span> + driverIncome + <span class="string">"元"</span> + <span class="string">"，司机个税："</span> + driverTaxFee + <span class="string">"元"</span>);</span><br><span class="line">end</span><br><span class="line">rule <span class="string">"订单金额大于100 天完成订单大于10单"</span></span><br><span class="line">    salience <span class="number">10</span>          <span class="comment">//指定优先级，数值越大优先级越高，不指定的情况下由上到下执行</span></span><br><span class="line">    no-loop <span class="literal">true</span>         <span class="comment">//防止陷入死循环</span></span><br><span class="line">    when</span><br><span class="line">        <span class="comment">/*规则条件，到工作内存中查找FeeRuleRequest对象</span></span><br><span class="line"><span class="comment">        里面出来的结果只能是ture或者false</span></span><br><span class="line"><span class="comment">        $rule是绑定变量名，可以任意命名，官方推荐$符号，定义了绑定变量名，可以在then部分操作fact对象*/</span></span><br><span class="line">        $rule:ProfitsharingRuleRequest(orderAmount.doubleValue() &gt; <span class="number">100.0</span> &amp;&amp; orderNum &gt; <span class="number">10</span>)</span><br><span class="line">    then</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">totalAmount</span> <span class="operator">=</span> profitsharingRuleResponse.getOrderAmount().subtract(profitsharingRuleResponse.getPaymentFee());</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">platformIncome</span> <span class="operator">=</span> totalAmount.multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"0.18"</span>)).setScale(<span class="number">2</span>, RoundingMode.HALF_UP);</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">driverTotalIncome</span> <span class="operator">=</span> totalAmount.subtract(platformIncome);</span><br><span class="line">        <span class="comment">//代驾司机个税，税率：10%</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">driverTaxFee</span> <span class="operator">=</span> driverTotalIncome.multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"0.1"</span>)).setScale(<span class="number">2</span>, RoundingMode.HALF_UP);</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">driverIncome</span> <span class="operator">=</span> driverTotalIncome.subtract(driverTaxFee);</span><br><span class="line">        profitsharingRuleResponse.setPlatformIncome(platformIncome);</span><br><span class="line">        profitsharingRuleResponse.setDriverIncome(driverIncome);</span><br><span class="line">        profitsharingRuleResponse.setDriverTaxRate(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"0.1"</span>));</span><br><span class="line">        profitsharingRuleResponse.setDriverTaxFee(driverTaxFee);</span><br><span class="line">        System.out.println(<span class="string">"平台分账收入："</span> + platformIncome + <span class="string">"元"</span> + <span class="string">"，司机分账收入："</span> + driverIncome + <span class="string">"元"</span> + <span class="string">"，司机个税："</span> + driverTaxFee + <span class="string">"元"</span>);</span><br><span class="line">end</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-4-profitsharingrulecontroller">4.1.4、ProfitsharingRuleController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ProfitsharingRuleService profitsharingRuleService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "计算系统分账费用")</span></span><br><span class="line"><span class="meta">@PostMapping("/calculateOrderProfitsharingFee")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;ProfitsharingRuleResponseVo&gt; <span class="title function_">calculateOrderProfitsharingFee</span><span class="params">(<span class="meta">@RequestBody</span> ProfitsharingRuleRequestForm profitsharingRuleRequestForm)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(profitsharingRuleService.calculateOrderProfitsharingFee(profitsharingRuleRequestForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-5-profitsharingruleservice">4.1.5、ProfitsharingRuleService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ProfitsharingRuleResponseVo <span class="title function_">calculateOrderProfitsharingFee</span><span class="params">(ProfitsharingRuleRequestForm profitsharingRuleRequestForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-6-profitsharingruleserviceimpl">4.1.6、ProfitsharingRuleServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ProfitsharingRuleMapper rewardRuleMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ProfitsharingRuleResponseVo <span class="title function_">calculateOrderProfitsharingFee</span><span class="params">(ProfitsharingRuleRequestForm profitsharingRuleRequestForm)</span> {</span><br><span class="line">    <span class="comment">//封装传入对象</span></span><br><span class="line">    <span class="type">ProfitsharingRuleRequest</span> <span class="variable">profitsharingRuleRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProfitsharingRuleRequest</span>();</span><br><span class="line">    profitsharingRuleRequest.setOrderAmount(profitsharingRuleRequestForm.getOrderAmount());</span><br><span class="line">    profitsharingRuleRequest.setOrderNum(profitsharingRuleRequestForm.getOrderNum());</span><br><span class="line">    log.info(<span class="string">"传入参数：{}"</span>, JSON.toJSONString(profitsharingRuleRequest));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取最新订单费用规则</span></span><br><span class="line">    <span class="type">ProfitsharingRule</span> <span class="variable">profitsharingRule</span> <span class="operator">=</span> rewardRuleMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;ProfitsharingRule&gt;().orderByDesc(ProfitsharingRule::getId).last(<span class="string">"limit 1"</span>));</span><br><span class="line">    <span class="type">KieSession</span> <span class="variable">kieSession</span> <span class="operator">=</span> DroolsHelper.loadForRule(profitsharingRule.getRule());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装返回对象</span></span><br><span class="line">    <span class="type">ProfitsharingRuleResponse</span> <span class="variable">profitsharingRuleResponse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProfitsharingRuleResponse</span>();</span><br><span class="line">    kieSession.setGlobal(<span class="string">"profitsharingRuleResponse"</span>, profitsharingRuleResponse);</span><br><span class="line">    <span class="comment">// 设置订单对象</span></span><br><span class="line">    kieSession.insert(profitsharingRuleRequest);</span><br><span class="line">    <span class="comment">// 触发规则</span></span><br><span class="line">    kieSession.fireAllRules();</span><br><span class="line">    <span class="comment">// 中止会话</span></span><br><span class="line">    kieSession.dispose();</span><br><span class="line">    log.info(<span class="string">"计算结果：{}"</span>, JSON.toJSONString(profitsharingRuleResponse));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装返回对象</span></span><br><span class="line">    <span class="type">ProfitsharingRuleResponseVo</span> <span class="variable">profitsharingRuleResponseVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProfitsharingRuleResponseVo</span>();</span><br><span class="line">    profitsharingRuleResponseVo.setProfitsharingRuleId(profitsharingRule.getId());</span><br><span class="line">    BeanUtils.copyProperties(profitsharingRuleResponse, profitsharingRuleResponseVo);</span><br><span class="line">    <span class="keyword">return</span> profitsharingRuleResponseVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-2-feign-jie-kou">4.2、Feign接口</span></h4><h5><span id="4-2-1-profitsharingrulefeignclient">4.2.1、ProfitsharingRuleFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算订单分账数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> profitsharingRuleRequestForm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping("/rules/profitsharing/calculateOrderProfitsharingFee")</span></span><br><span class="line">Result&lt;ProfitsharingRuleResponseVo&gt; <span class="title function_">calculateOrderProfitsharingFee</span><span class="params">(<span class="meta">@RequestBody</span> ProfitsharingRuleRequestForm profitsharingRuleRequestForm)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="5-jie-shu-dai-jia-geng-xin-zhang-dan">5、结束代驾更新账单</span></h3><h4><span id="5-1-ding-dan-wei-fu-wu-jie-kou">5.1、订单微服务接口</span></h4><h5><span id="5-1-1-orderinfocontroller">5.1.1、OrderInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "结束代驾服务更新订单账单")</span></span><br><span class="line"><span class="meta">@PostMapping("/endDrive")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">endDrive</span><span class="params">(<span class="meta">@RequestBody</span> UpdateOrderBillForm updateOrderBillForm)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(orderInfoService.endDrive(updateOrderBillForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-1-2-orderinfoservice">5.1.2、OrderInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">endDrive</span><span class="params">(UpdateOrderBillForm updateOrderBillForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-1-3-orderinfoserviceimpl">5.1.3、OrderInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OrderBillMapper orderBillMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OrderProfitsharingMapper orderProfitsharingMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">endDrive</span><span class="params">(UpdateOrderBillForm updateOrderBillForm)</span> {</span><br><span class="line">   <span class="comment">//更新订单信息</span></span><br><span class="line">   LambdaQueryWrapper&lt;OrderInfo&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">   queryWrapper.eq(OrderInfo::getId, updateOrderBillForm.getOrderId());</span><br><span class="line">   queryWrapper.eq(OrderInfo::getDriverId, updateOrderBillForm.getDriverId());</span><br><span class="line">   <span class="comment">//更新字段</span></span><br><span class="line">   <span class="type">OrderInfo</span> <span class="variable">updateOrderInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfo</span>();</span><br><span class="line">   updateOrderInfo.setStatus(OrderStatus.END_SERVICE.getStatus());</span><br><span class="line">   updateOrderInfo.setRealAmount(updateOrderBillForm.getTotalAmount());</span><br><span class="line">   updateOrderInfo.setFavourFee(updateOrderBillForm.getFavourFee());</span><br><span class="line">   updateOrderInfo.setEndServiceTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">   updateOrderInfo.setRealDistance(updateOrderBillForm.getRealDistance());</span><br><span class="line">   <span class="comment">//只能更新自己的订单</span></span><br><span class="line">   <span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> orderInfoMapper.update(updateOrderInfo, queryWrapper);</span><br><span class="line">   <span class="keyword">if</span>(row == <span class="number">1</span>) {</span><br><span class="line">      <span class="comment">//记录日志</span></span><br><span class="line">      <span class="built_in">this</span>.log(updateOrderBillForm.getOrderId(), OrderStatus.END_SERVICE.getStatus());</span><br><span class="line"></span><br><span class="line">      <span class="comment">//插入实际账单数据</span></span><br><span class="line">      <span class="type">OrderBill</span> <span class="variable">orderBill</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderBill</span>();</span><br><span class="line">      BeanUtils.copyProperties(updateOrderBillForm, orderBill);</span><br><span class="line">      orderBill.setOrderId(updateOrderBillForm.getOrderId());</span><br><span class="line">      orderBill.setPayAmount(orderBill.getTotalAmount());</span><br><span class="line">      orderBillMapper.insert(orderBill);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//插入分账信息数据</span></span><br><span class="line">      <span class="type">OrderProfitsharing</span> <span class="variable">orderProfitsharing</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderProfitsharing</span>();</span><br><span class="line">      BeanUtils.copyProperties(updateOrderBillForm, orderProfitsharing);</span><br><span class="line">      orderProfitsharing.setOrderId(updateOrderBillForm.getOrderId());</span><br><span class="line">      orderProfitsharing.setRuleId(updateOrderBillForm.getProfitsharingRuleId());</span><br><span class="line">      orderProfitsharing.setStatus(<span class="number">1</span>);</span><br><span class="line">      orderProfitsharingMapper.insert(orderProfitsharing);</span><br><span class="line">   } <span class="keyword">else</span> {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.UPDATE_ERROR);</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="5-2-feign-jie-kou">5.2、Feign接口</span></h4><h5><span id="5-2-1-orderinfofeignclient">5.2.1、OrderInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 结束代驾服务更新订单账单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> updateOrderBillForm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping("/order/info/endDrive")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">endDrive</span><span class="params">(<span class="meta">@RequestBody</span> UpdateOrderBillForm updateOrderBillForm)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="6-jie-shu-dai-jia">6、结束代驾</span></h3><h4><span id="6-1-si-ji-duan-web-jie-kou">6.1、司机端web接口</span></h4><h5><span id="6-1-1-ordercontroller">6.1.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "结束代驾服务更新订单账单")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@PostMapping("/endDrive")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">endDrive</span><span class="params">(<span class="meta">@RequestBody</span> OrderFeeForm orderFeeForm)</span> {</span><br><span class="line">   <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">   orderFeeForm.setDriverId(driverId);</span><br><span class="line">   <span class="keyword">return</span> Result.ok(orderService.endDrive(orderFeeForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="6-1-2-orderservice">6.1.2、OrderService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">endDrive</span><span class="params">(OrderFeeForm orderFeeForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="6-1-3-orderserviceimpl">6.1.3、OrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> LocationFeignClient locationFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> FeeRuleFeignClient feeRuleFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RewardRuleFeignClient rewardRuleFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ProfitsharingRuleFeignClient profitsharingRuleFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">endDrive</span><span class="params">(OrderFeeForm orderFeeForm)</span> {</span><br><span class="line">   <span class="comment">//1.获取订单信息</span></span><br><span class="line">   <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderInfo(orderFeeForm.getOrderId()).getData();</span><br><span class="line">   <span class="keyword">if</span>(orderInfo.getDriverId().longValue() != orderFeeForm.getDriverId().longValue()) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.ARGUMENT_VALID_ERROR);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">//2.计算订单实际里程</span></span><br><span class="line">   <span class="type">BigDecimal</span> <span class="variable">realDistance</span> <span class="operator">=</span> locationFeignClient.calculateOrderRealDistance(orderFeeForm.getOrderId()).getData();</span><br><span class="line">   log.info(<span class="string">"结束代驾，订单实际里程：{}"</span>, realDistance);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//3.计算代驾实际费用</span></span><br><span class="line">   <span class="type">FeeRuleRequestForm</span> <span class="variable">feeRuleRequestForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeeRuleRequestForm</span>();</span><br><span class="line">   feeRuleRequestForm.setDistance(realDistance);</span><br><span class="line">   feeRuleRequestForm.setStartTime(orderInfo.getStartServiceTime());</span><br><span class="line">   <span class="comment">//等候时间</span></span><br><span class="line">   <span class="type">Integer</span> <span class="variable">waitMinute</span> <span class="operator">=</span> Math.abs((<span class="type">int</span>) ((orderInfo.getArriveTime().getTime() - orderInfo.getAcceptTime().getTime()) / (<span class="number">1000</span> * <span class="number">60</span>)));</span><br><span class="line">   feeRuleRequestForm.setWaitMinute(waitMinute);</span><br><span class="line">   log.info(<span class="string">"结束代驾，费用参数：{}"</span>, JSON.toJSONString(feeRuleRequestForm));</span><br><span class="line">   <span class="type">FeeRuleResponseVo</span> <span class="variable">feeRuleResponseVo</span> <span class="operator">=</span> feeRuleFeignClient.calculateOrderFee(feeRuleRequestForm).getData();</span><br><span class="line">   log.info(<span class="string">"费用明细：{}"</span>, JSON.toJSONString(feeRuleResponseVo));</span><br><span class="line">   <span class="comment">//订单总金额 需加上 路桥费、停车费、其他费用、乘客好处费</span></span><br><span class="line">   <span class="type">BigDecimal</span> <span class="variable">totalAmount</span> <span class="operator">=</span> feeRuleResponseVo.getTotalAmount().add(orderFeeForm.getTollFee()).add(orderFeeForm.getParkingFee()).add(orderFeeForm.getOtherFee()).add(orderInfo.getFavourFee());</span><br><span class="line">   feeRuleResponseVo.setTotalAmount(totalAmount);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//4.计算系统奖励</span></span><br><span class="line">   <span class="comment">//4.1.获取订单数</span></span><br><span class="line">   <span class="type">String</span> <span class="variable">startTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DateTime</span>(orderInfo.getStartServiceTime()).toString(<span class="string">"yyyy-MM-dd"</span>) + <span class="string">" 00:00:00"</span>;</span><br><span class="line">   <span class="type">String</span> <span class="variable">endTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DateTime</span>(orderInfo.getStartServiceTime()).toString(<span class="string">"yyyy-MM-dd"</span>) + <span class="string">" 24:00:00"</span>;</span><br><span class="line">   <span class="type">Long</span> <span class="variable">orderNum</span> <span class="operator">=</span> orderInfoFeignClient.getOrderNumByTime(startTime, endTime).getData();</span><br><span class="line">   <span class="comment">//4.2.封装参数</span></span><br><span class="line">   <span class="type">RewardRuleRequestForm</span> <span class="variable">rewardRuleRequestForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RewardRuleRequestForm</span>();</span><br><span class="line">   rewardRuleRequestForm.setStartTime(orderInfo.getStartServiceTime());</span><br><span class="line">   rewardRuleRequestForm.setOrderNum(orderNum);</span><br><span class="line">   <span class="comment">//4.3.执行</span></span><br><span class="line">   <span class="type">RewardRuleResponseVo</span> <span class="variable">rewardRuleResponseVo</span> <span class="operator">=</span> rewardRuleFeignClient.calculateOrderRewardFee(rewardRuleRequestForm).getData();</span><br><span class="line">   log.info(<span class="string">"结束代驾，系统奖励：{}"</span>, JSON.toJSONString(rewardRuleResponseVo));</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//5.计算分账信息</span></span><br><span class="line">   <span class="type">ProfitsharingRuleRequestForm</span> <span class="variable">profitsharingRuleRequestForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProfitsharingRuleRequestForm</span>();</span><br><span class="line">   profitsharingRuleRequestForm.setOrderAmount(feeRuleResponseVo.getTotalAmount());</span><br><span class="line">   profitsharingRuleRequestForm.setOrderNum(orderNum);</span><br><span class="line">   <span class="type">ProfitsharingRuleResponseVo</span> <span class="variable">profitsharingRuleResponseVo</span> <span class="operator">=</span> profitsharingRuleFeignClient.calculateOrderProfitsharingFee(profitsharingRuleRequestForm).getData();</span><br><span class="line">   log.info(<span class="string">"结束代驾，分账信息：{}"</span>, JSON.toJSONString(profitsharingRuleResponseVo));</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//6.封装更新订单账单相关实体对象</span></span><br><span class="line">   <span class="type">UpdateOrderBillForm</span> <span class="variable">updateOrderBillForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpdateOrderBillForm</span>();</span><br><span class="line">   updateOrderBillForm.setOrderId(orderFeeForm.getOrderId());</span><br><span class="line">   updateOrderBillForm.setDriverId(orderFeeForm.getDriverId());</span><br><span class="line">   <span class="comment">//路桥费、停车费、其他费用</span></span><br><span class="line">   updateOrderBillForm.setTollFee(orderFeeForm.getTollFee());</span><br><span class="line">   updateOrderBillForm.setParkingFee(orderFeeForm.getParkingFee());</span><br><span class="line">   updateOrderBillForm.setOtherFee(orderFeeForm.getOtherFee());</span><br><span class="line">   <span class="comment">//乘客好处费</span></span><br><span class="line">   updateOrderBillForm.setFavourFee(orderInfo.getFavourFee());</span><br><span class="line"></span><br><span class="line">   <span class="comment">//实际里程</span></span><br><span class="line">   updateOrderBillForm.setRealDistance(realDistance);</span><br><span class="line">   <span class="comment">//订单奖励信息</span></span><br><span class="line">   BeanUtils.copyProperties(rewardRuleResponseVo, updateOrderBillForm);</span><br><span class="line">   <span class="comment">//代驾费用信息</span></span><br><span class="line">   BeanUtils.copyProperties(feeRuleResponseVo, updateOrderBillForm);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//分账相关信息</span></span><br><span class="line">   BeanUtils.copyProperties(profitsharingRuleResponseVo, updateOrderBillForm);</span><br><span class="line">   updateOrderBillForm.setProfitsharingRuleId(profitsharingRuleResponseVo.getProfitsharingRuleId());</span><br><span class="line">   log.info(<span class="string">"结束代驾，更新账单信息：{}"</span>, JSON.toJSONString(updateOrderBillForm));</span><br><span class="line"></span><br><span class="line">   <span class="comment">//7.结束代驾更新账单</span></span><br><span class="line">   orderInfoFeignClient.endDrive(updateOrderBillForm);</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="7-zhi-neng-pan-duan-si-ji-shua-dan-xing-wei">7、智能判断司机刷单行为</span></h3><p>判断司机刷单的办法也很简单，司机点击到达上车点按钮的时候，司机端小程序通过腾讯地图服务的API，计算当前定位到上车点的距离。如果超过1公里，那就不可以。司机必须距离上车点在1公里以内，点击到达上车点才有效。当司机想要结束代驾的时候，距离代驾终点必须在2公里以内才可以，否则就无法结束代驾。</p>
<p>只是上面的限制也是不够的，我们后面还可以加上预期的里程与实际的里程的一个距离差来进一步判断。</p>
<h4><span id="7-1-orderserviceimpl">7.1、OrderServiceImpl</span></h4><p>司机端web接口，司机到达代驾起始地点加限制</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">driverArriveStartLocation</span><span class="params">(Long orderId, Long driverId)</span> {</span><br><span class="line">    <span class="comment">//防止刷单，计算司机的经纬度与代驾的起始经纬度是否在1公里范围内</span></span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderInfo(orderId).getData();</span><br><span class="line">    <span class="type">OrderLocationVo</span> <span class="variable">orderLocationVo</span> <span class="operator">=</span> locationFeignClient.getCacheOrderLocation(orderId).getData();</span><br><span class="line">    <span class="comment">//司机的位置与代驾起始点位置的距离</span></span><br><span class="line">    <span class="type">double</span> <span class="variable">distance</span> <span class="operator">=</span> LocationUtil.getDistance(orderInfo.getStartPointLatitude().doubleValue(), orderInfo.getStartPointLongitude().doubleValue(), orderLocationVo.getLatitude().doubleValue(), orderLocationVo.getLongitude().doubleValue());</span><br><span class="line">    <span class="keyword">if</span>(distance &gt; SystemConstant.DRIVER_START_LOCATION_DISTION) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DRIVER_START_LOCATION_DISTION_ERROR);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> orderInfoFeignClient.driverArriveStartLocation(orderId, driverId).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="7-2-orderserviceimpl">7.2、OrderServiceImpl</span></h4><p>司机端web接口，结束代驾服务更新订单账单加限制</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">endDrive</span><span class="params">(OrderFeeForm orderFeeForm)</span> {</span><br><span class="line">   <span class="comment">//1.获取订单信息</span></span><br><span class="line">   <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderInfo(orderFeeForm.getOrderId()).getData();</span><br><span class="line">   <span class="keyword">if</span>(orderInfo.getDriverId().longValue() != orderFeeForm.getDriverId().longValue()) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.ARGUMENT_VALID_ERROR);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">//2.防止刷单，计算司机的经纬度与代驾的终点经纬度是否在2公里范围内</span></span><br><span class="line">   <span class="type">OrderServiceLastLocationVo</span> <span class="variable">orderServiceLastLocationVo</span> <span class="operator">=</span> locationFeignClient.getOrderServiceLastLocation(orderFeeForm.getOrderId()).getData();</span><br><span class="line">   <span class="comment">//司机的位置与代驾终点位置的距离</span></span><br><span class="line">   <span class="type">double</span> <span class="variable">distance</span> <span class="operator">=</span> LocationUtil.getDistance(orderInfo.getEndPointLatitude().doubleValue(), orderInfo.getEndPointLongitude().doubleValue(), orderServiceLastLocationVo.getLatitude().doubleValue(), orderServiceLastLocationVo.getLongitude().doubleValue());</span><br><span class="line">   <span class="keyword">if</span>(distance &gt; SystemConstant.DRIVER_START_LOCATION_DISTION) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DRIVER_END_LOCATION_DISTION_ERROR);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">//3.计算订单实际里程</span></span><br><span class="line">   <span class="type">BigDecimal</span> <span class="variable">realDistance</span> <span class="operator">=</span> locationFeignClient.calculateOrderRealDistance(orderFeeForm.getOrderId()).getData();</span><br><span class="line">   log.info(<span class="string">"结束代驾，订单实际里程：{}"</span>, realDistance);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//4.计算代驾实际费用</span></span><br><span class="line">   <span class="type">FeeRuleRequestForm</span> <span class="variable">feeRuleRequestForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeeRuleRequestForm</span>();</span><br><span class="line">   feeRuleRequestForm.setDistance(realDistance);</span><br><span class="line">   feeRuleRequestForm.setStartTime(orderInfo.getStartServiceTime());</span><br><span class="line">   <span class="comment">//等候时间</span></span><br><span class="line">   <span class="type">Integer</span> <span class="variable">waitMinute</span> <span class="operator">=</span> Math.abs((<span class="type">int</span>) ((orderInfo.getArriveTime().getTime() - orderInfo.getAcceptTime().getTime()) / (<span class="number">1000</span> * <span class="number">60</span>)));</span><br><span class="line">   feeRuleRequestForm.setWaitMinute(waitMinute);</span><br><span class="line">   log.info(<span class="string">"结束代驾，费用参数：{}"</span>, JSON.toJSONString(feeRuleRequestForm));</span><br><span class="line">   <span class="type">FeeRuleResponseVo</span> <span class="variable">feeRuleResponseVo</span> <span class="operator">=</span> feeRuleFeignClient.calculateOrderFee(feeRuleRequestForm).getData();</span><br><span class="line">   log.info(<span class="string">"费用明细：{}"</span>, JSON.toJSONString(feeRuleResponseVo));</span><br><span class="line">   <span class="comment">//订单总金额 需加上 路桥费、停车费、其他费用、乘客好处费</span></span><br><span class="line">   <span class="type">BigDecimal</span> <span class="variable">totalAmount</span> <span class="operator">=</span> feeRuleResponseVo.getTotalAmount().add(orderFeeForm.getTollFee()).add(orderFeeForm.getParkingFee()).add(orderFeeForm.getOtherFee()).add(orderInfo.getFavourFee());</span><br><span class="line">   feeRuleResponseVo.setTotalAmount(totalAmount);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//5.计算系统奖励</span></span><br><span class="line">   <span class="comment">//5.1.获取订单数</span></span><br><span class="line">   <span class="type">String</span> <span class="variable">startTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DateTime</span>(orderInfo.getStartServiceTime()).toString(<span class="string">"yyyy-MM-dd"</span>) + <span class="string">" 00:00:00"</span>;</span><br><span class="line">   <span class="type">String</span> <span class="variable">endTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DateTime</span>(orderInfo.getStartServiceTime()).toString(<span class="string">"yyyy-MM-dd"</span>) + <span class="string">" 24:00:00"</span>;</span><br><span class="line">   <span class="type">Long</span> <span class="variable">orderNum</span> <span class="operator">=</span> orderInfoFeignClient.getOrderNumByTime(startTime, endTime).getData();</span><br><span class="line">   <span class="comment">//5.2.封装参数</span></span><br><span class="line">   <span class="type">RewardRuleRequestForm</span> <span class="variable">rewardRuleRequestForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RewardRuleRequestForm</span>();</span><br><span class="line">   rewardRuleRequestForm.setStartTime(orderInfo.getStartServiceTime());</span><br><span class="line">   rewardRuleRequestForm.setOrderNum(orderNum);</span><br><span class="line">   <span class="comment">//5.3.执行</span></span><br><span class="line">   <span class="type">RewardRuleResponseVo</span> <span class="variable">rewardRuleResponseVo</span> <span class="operator">=</span> rewardRuleFeignClient.calculateOrderRewardFee(rewardRuleRequestForm).getData();</span><br><span class="line">   log.info(<span class="string">"结束代驾，系统奖励：{}"</span>, JSON.toJSONString(rewardRuleResponseVo));</span><br><span class="line"></span><br><span class="line">   <span class="comment">//6.计算分账信息</span></span><br><span class="line">   <span class="type">ProfitsharingRuleRequestForm</span> <span class="variable">profitsharingRuleRequestForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProfitsharingRuleRequestForm</span>();</span><br><span class="line">   profitsharingRuleRequestForm.setOrderAmount(feeRuleResponseVo.getTotalAmount());</span><br><span class="line">   profitsharingRuleRequestForm.setOrderNum(orderNum);</span><br><span class="line">   <span class="type">ProfitsharingRuleResponseVo</span> <span class="variable">profitsharingRuleResponseVo</span> <span class="operator">=</span> profitsharingRuleFeignClient.calculateOrderProfitsharingFee(profitsharingRuleRequestForm).getData();</span><br><span class="line">   log.info(<span class="string">"结束代驾，分账信息：{}"</span>, JSON.toJSONString(profitsharingRuleResponseVo));</span><br><span class="line"></span><br><span class="line">   <span class="comment">//7.封装更新订单账单相关实体对象</span></span><br><span class="line">   <span class="type">UpdateOrderBillForm</span> <span class="variable">updateOrderBillForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpdateOrderBillForm</span>();</span><br><span class="line">   updateOrderBillForm.setOrderId(orderFeeForm.getOrderId());</span><br><span class="line">   updateOrderBillForm.setDriverId(orderFeeForm.getDriverId());</span><br><span class="line">   <span class="comment">//路桥费、停车费、其他费用</span></span><br><span class="line">   updateOrderBillForm.setTollFee(orderFeeForm.getTollFee());</span><br><span class="line">   updateOrderBillForm.setParkingFee(orderFeeForm.getParkingFee());</span><br><span class="line">   updateOrderBillForm.setOtherFee(orderFeeForm.getOtherFee());</span><br><span class="line">   <span class="comment">//乘客好处费</span></span><br><span class="line">   updateOrderBillForm.setFavourFee(orderInfo.getFavourFee());</span><br><span class="line"></span><br><span class="line">   <span class="comment">//实际里程</span></span><br><span class="line">   updateOrderBillForm.setRealDistance(realDistance);</span><br><span class="line">   <span class="comment">//订单奖励信息</span></span><br><span class="line">   BeanUtils.copyProperties(rewardRuleResponseVo, updateOrderBillForm);</span><br><span class="line">   <span class="comment">//代驾费用信息</span></span><br><span class="line">   BeanUtils.copyProperties(feeRuleResponseVo, updateOrderBillForm);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//分账相关信息</span></span><br><span class="line">   BeanUtils.copyProperties(profitsharingRuleResponseVo, updateOrderBillForm);</span><br><span class="line">   updateOrderBillForm.setProfitsharingRuleId(profitsharingRuleResponseVo.getProfitsharingRuleId());</span><br><span class="line">   log.info(<span class="string">"结束代驾，更新账单信息：{}"</span>, JSON.toJSONString(updateOrderBillForm));</span><br><span class="line"></span><br><span class="line">   <span class="comment">//8.结束代驾更新账单</span></span><br><span class="line">   orderInfoFeignClient.endDrive(updateOrderBillForm);</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1><span id="xii-rabbitmq">XII.RabbitMQ</span></h1><p><strong>学习目标：</strong></p>
<ul>
<li>能够说出Rabbitmq应用场景</li>
<li>能够说出Rabbitmq消息不丢失解决方案</li>
<li>掌握Rabbitmq实现普通消息的收发</li>
<li>掌握Rabbitmq实现延迟消息</li>
<li>基于Rabbitmq消息队列实现商品数据同步</li>
<li>基于Rabbitmq消息队列实现订单延迟关闭</li>
</ul>
<h3><span id="1-mu-qian-cun-zai-de-wen-ti">1、目前存在的问题</span></h3><h4><span id="ding-dan-fu-wu-qu-xiao-ding-dan-wen-ti">订单服务取消订单问题</span></h4><p>乘客下单后，如果15分账未支付，我们该如何取消订单</p>
<ul>
<li><p>方案1：定时任务，定时扫描未支付订单，超过15分钟自动关闭</p>
</li>
<li><p>方案2：使用延迟队列关闭订单</p>
</li>
</ul>
<h3><span id="2-xiao-xi-dui-lie-jie-jue-shi-me-wen-ti">2、消息队列解决什么问题</span></h3><p>消息队列都解决了什么问题？</p>
<h4><span id="2-1-yi-bu">2.1、异步</span></h4><p><img src="/2024/09/26/projection-daijia/wps1.jpg" alt="img"> </p>
<h4><span id="2-2-jie-ou">2.2、解耦</span></h4><p>​	<img src="/2024/09/26/projection-daijia/wps2.jpg" alt="img"></p>
<h4><span id="2-3-bing-xing">2.3、并行</span></h4><p> <img src="/2024/09/26/projection-daijia/wps3.jpg" alt="img"></p>
<h4><span id="2-4-pai-dui">2.4、排队</span></h4><p><img src="/2024/09/26/projection-daijia/wps4.jpg" alt="img"> </p>
<h3><span id="3-xiao-xi-dui-lie-gong-ju-rabbitmq">3、消息队列工具 RabbitMQ</span></h3><h4><span id="3-1-chang-jian-mq-chan-pin">3.1、常见MQ产品</span></h4><ul>
<li><p>ActiveMQ：基于JMS（Java Message Service）协议，java语言，jdk</p>
</li>
<li><p>RabbitMQ：基于AMQP协议，erlang语言开发，稳定性好</p>
</li>
<li><p>RocketMQ：基于JMS，阿里巴巴产品，目前交由Apache基金会</p>
</li>
<li><p>Kafka：分布式消息系统，高吞吐量</p>
</li>
</ul>
<h4><span id="3-2-rabbitmq-ji-chu-gai-nian">3.2、RabbitMQ基础概念</span></h4><p><img src="/2024/09/26/projection-daijia/wps5.png" alt="img"> </p>
<p>Broker：简单来说就是消息队列服务器实体</p>
<p>Exchange：消息交换机，它指定消息按什么规则，路由到哪个队列</p>
<p>Queue：消息队列载体，每个消息都会被投入到一个或多个队列</p>
<p>Binding：绑定，它的作用就是把 exchange和 queue按照路由规则绑定起来</p>
<p>Routing Key：路由关键字， exchange根据这个关键字进行消息投递</p>
<p>vhost：虚拟主机，一个 broker里可以开设多个 vhost，用作不同用户的权限分离</p>
<p>producer：消息生产者，就是投递消息的程序</p>
<p>consumer：消息消费者，就是接受消息的程序</p>
<p>channel：消息通道，在客户端的每个连接里，可建立多个 channel，每个 channel代表一个会话任务</p>
<h4><span id="3-3-an-zhuang-rabbitmq">3.3、安装RabbitMQ</span></h4><p>看电商软件环境安装.doc</p>
<p>访问IP地址：<a target="_blank" rel="noopener" href="http://192.168.200.128:15672/">http://192.168.200.128:15672</a></p>
<ul>
<li><p>用户名：admin</p>
</li>
<li><p>密码：admin</p>
</li>
</ul>
<h4><span id="3-4-wu-chong-xiao-xi-mo-xing">3.4、五种消息模型</span></h4><p>RabbitMQ提供了6种消息模型，但是第6种其实是RPC，并不是MQ，因此不予学习。那么也就剩下5种。</p>
<p>但是其实3、4、5这三种都属于订阅模型，只不过进行路由的方式不同。</p>
<p><img src="/2024/09/26/projection-daijia/wps6.jpg" alt="img"> </p>
<ul>
<li><p>基本消息模型：生产者–&gt;队列–&gt;消费者</p>
</li>
<li><p>work消息模型：生产者–&gt;队列–&gt;多个消费者竞争消费</p>
</li>
<li><p>订阅模型-Fanout：广播模式，将消息交给所有绑定到交换机的队列，每个消费者都会收到同一条消息</p>
</li>
<li><p><strong>订阅模型-Direct：定向，把消息交给符合指定 rotingKey 的队列</strong></p>
</li>
<li><p>订阅模型-Topic 主题模式：通配符，把消息交给符合routing pattern（路由模式） 的队列</p>
</li>
</ul>
<p>我们项目使用的是第四种!</p>
<h3><span id="4-xiao-xi-bu-diu-shi">4、消息不丢失</span></h3><p>消息的不丢失，在MQ角度考虑，一般有三种途径：</p>
<ol>
<li><p>生产者不丢数据</p>
</li>
<li><p>MQ服务器不丢数据</p>
</li>
<li><p>消费者不丢数据</p>
</li>
</ol>
<p>保证消息不丢失有两种实现方式：</p>
<ul>
<li><p>开启事务模式</p>
</li>
<li><p>消息息确认模式（生产者，消费者）</p>
</li>
</ul>
<p>说明：开启事务会大幅降低消息发送及接收效率，使用的相对较少，因此我们生产环境一般都采取消息确认模式，以下我们只是讲解消息确认模式</p>
<h4><span id="4-1-xiao-xi-que-ren">4.1、消息确认</span></h4><h5><span id="4-1-1-xiao-xi-chi-jiu-hua">4.1.1、消息持久化</span></h5><p>如果希望RabbitMQ重启之后消息不丢失，那么需要对以下3种实体均配置持久化</p>
<p><strong>Exchange</strong></p>
<p>声明exchange时设置持久化（durable = true）并且不自动删除(autoDelete = false)</p>
<p><strong>Queue</strong></p>
<p>声明queue时设置持久化（durable = true）并且不自动删除(autoDelete = false)</p>
<p><strong>message</strong></p>
<p>xxxxxxxxxx&nbsp;@Overridepublic Boolean endDrive(OrderFeeForm orderFeeForm) { &nbsp; //1.获取订单信息 &nbsp; OrderInfo orderInfo = orderInfoFeignClient.getOrderInfo(orderFeeForm.getOrderId()).getData(); &nbsp; if(orderInfo.getDriverId().longValue() != orderFeeForm.getDriverId().longValue()) { &nbsp; &nbsp; &nbsp;throw new GuiguException(ResultCodeEnum.ARGUMENT_VALID_ERROR); &nbsp; }​ &nbsp; //2.防止刷单，计算司机的经纬度与代驾的终点经纬度是否在2公里范围内 &nbsp; OrderServiceLastLocationVo orderServiceLastLocationVo = locationFeignClient.getOrderServiceLastLocation(orderFeeForm.getOrderId()).getData(); &nbsp; //司机的位置与代驾终点位置的距离 &nbsp; double distance = LocationUtil.getDistance(orderInfo.getEndPointLatitude().doubleValue(), orderInfo.getEndPointLongitude().doubleValue(), orderServiceLastLocationVo.getLatitude().doubleValue(), orderServiceLastLocationVo.getLongitude().doubleValue()); &nbsp; if(distance &gt; SystemConstant.DRIVER_START_LOCATION_DISTION) { &nbsp; &nbsp; &nbsp;throw new GuiguException(ResultCodeEnum.DRIVER_END_LOCATION_DISTION_ERROR); &nbsp; }​ &nbsp; //3.计算订单实际里程 &nbsp; BigDecimal realDistance = locationFeignClient.calculateOrderRealDistance(orderFeeForm.getOrderId()).getData(); &nbsp; log.info(“结束代驾，订单实际里程：{}”, realDistance);​ &nbsp; //4.计算代驾实际费用 &nbsp; FeeRuleRequestForm feeRuleRequestForm = new FeeRuleRequestForm(); &nbsp; feeRuleRequestForm.setDistance(realDistance); &nbsp; feeRuleRequestForm.setStartTime(orderInfo.getStartServiceTime()); &nbsp; //等候时间 &nbsp; Integer waitMinute = Math.abs((int) ((orderInfo.getArriveTime().getTime() - orderInfo.getAcceptTime().getTime()) / (1000 * 60))); &nbsp; feeRuleRequestForm.setWaitMinute(waitMinute); &nbsp; log.info(“结束代驾，费用参数：{}”, JSON.toJSONString(feeRuleRequestForm)); &nbsp; FeeRuleResponseVo feeRuleResponseVo = feeRuleFeignClient.calculateOrderFee(feeRuleRequestForm).getData(); &nbsp; log.info(“费用明细：{}”, JSON.toJSONString(feeRuleResponseVo)); &nbsp; //订单总金额 需加上 路桥费、停车费、其他费用、乘客好处费 &nbsp; BigDecimal totalAmount = feeRuleResponseVo.getTotalAmount().add(orderFeeForm.getTollFee()).add(orderFeeForm.getParkingFee()).add(orderFeeForm.getOtherFee()).add(orderInfo.getFavourFee()); &nbsp; feeRuleResponseVo.setTotalAmount(totalAmount);​ &nbsp; //5.计算系统奖励 &nbsp; //5.1.获取订单数 &nbsp; String startTime = new DateTime(orderInfo.getStartServiceTime()).toString(“yyyy-MM-dd”) + “ 00:00:00”; &nbsp; String endTime = new DateTime(orderInfo.getStartServiceTime()).toString(“yyyy-MM-dd”) + “ 24:00:00”; &nbsp; Long orderNum = orderInfoFeignClient.getOrderNumByTime(startTime, endTime).getData(); &nbsp; //5.2.封装参数 &nbsp; RewardRuleRequestForm rewardRuleRequestForm = new RewardRuleRequestForm(); &nbsp; rewardRuleRequestForm.setStartTime(orderInfo.getStartServiceTime()); &nbsp; rewardRuleRequestForm.setOrderNum(orderNum); &nbsp; //5.3.执行 &nbsp; RewardRuleResponseVo rewardRuleResponseVo = rewardRuleFeignClient.calculateOrderRewardFee(rewardRuleRequestForm).getData(); &nbsp; log.info(“结束代驾，系统奖励：{}”, JSON.toJSONString(rewardRuleResponseVo));​ &nbsp; //6.计算分账信息 &nbsp; ProfitsharingRuleRequestForm profitsharingRuleRequestForm = new ProfitsharingRuleRequestForm(); &nbsp; profitsharingRuleRequestForm.setOrderAmount(feeRuleResponseVo.getTotalAmount()); &nbsp; profitsharingRuleRequestForm.setOrderNum(orderNum); &nbsp; ProfitsharingRuleResponseVo profitsharingRuleResponseVo = profitsharingRuleFeignClient.calculateOrderProfitsharingFee(profitsharingRuleRequestForm).getData(); &nbsp; log.info(“结束代驾，分账信息：{}”, JSON.toJSONString(profitsharingRuleResponseVo));​ &nbsp; //7.封装更新订单账单相关实体对象 &nbsp; UpdateOrderBillForm updateOrderBillForm = new UpdateOrderBillForm(); &nbsp; updateOrderBillForm.setOrderId(orderFeeForm.getOrderId()); &nbsp; updateOrderBillForm.setDriverId(orderFeeForm.getDriverId()); &nbsp; //路桥费、停车费、其他费用 &nbsp; updateOrderBillForm.setTollFee(orderFeeForm.getTollFee()); &nbsp; updateOrderBillForm.setParkingFee(orderFeeForm.getParkingFee()); &nbsp; updateOrderBillForm.setOtherFee(orderFeeForm.getOtherFee()); &nbsp; //乘客好处费 &nbsp; updateOrderBillForm.setFavourFee(orderInfo.getFavourFee());​ &nbsp; //实际里程 &nbsp; updateOrderBillForm.setRealDistance(realDistance); &nbsp; //订单奖励信息 &nbsp; BeanUtils.copyProperties(rewardRuleResponseVo, updateOrderBillForm); &nbsp; //代驾费用信息 &nbsp; BeanUtils.copyProperties(feeRuleResponseVo, updateOrderBillForm);​ &nbsp; //分账相关信息 &nbsp; BeanUtils.copyProperties(profitsharingRuleResponseVo, updateOrderBillForm); &nbsp; updateOrderBillForm.setProfitsharingRuleId(profitsharingRuleResponseVo.getProfitsharingRuleId()); &nbsp; log.info(“结束代驾，更新账单信息：{}”, JSON.toJSONString(updateOrderBillForm));​ &nbsp; //8.结束代驾更新账单 &nbsp; orderInfoFeignClient.endDrive(updateOrderBillForm); &nbsp; return true;}java</p>
<h5><span id="4-1-2-fa-song-que-ren">4.1.2、发送确认</span></h5><p>有时，业务处理成功，消息也发了，但是我们并不知道消息是否成功到达了rabbitmq，如果由于网络等原因导致业务成功而消息发送失败，那么发送方将出现不一致的问题，此时可以使用rabbitmq的发送确认功能，即要求rabbitmq显式告知我们消息是否已成功发送。</p>
<h5><span id="4-1-3-shou-dong-xiao-fei-que-ren">4.1.3、手动消费确认</span></h5><p>有时，消息被正确投递到消费方，但是消费方处理失败，那么便会出现消费方的不一致问题。比如:订单已创建的消息发送到用户积分子系统中用于增加用户积分，但是积分消费方处理却都失败了，用户就会问：我购买了东西为什么积分并没有增加呢？</p>
<p>要解决这个问题，需要引入消费方确认，即只有消息被成功处理之后才告知rabbitmq以ack，否则告知rabbitmq以nack</p>
<h3><span id="5-da-jian-rabbit-util-mo-kuai">5、搭建rabbit-util模块</span></h3><p>由于消息队列是公共模块，我们把mq的相关代码（生产者）封装到该模块，其他service微服务模块都可能使用，因此我们把他封装到一个单独的模块，需要使用mq的模块直接引用该模块即可。</p>
<p>模块已搭建，依赖已添加，我们只需要封装关键部分即可。</p>
<h4><span id="5-1-rabbitinitconfigapplicationlistener">5.1、RabbitInitConfigApplicationListener</span></h4><p>消息确认配置类</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.common.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.event.ApplicationReadyEvent;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitInitConfigApplicationListener</span> <span class="keyword">implements</span> <span class="title class_">ApplicationListener</span>&lt;ApplicationReadyEvent&gt; {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ApplicationReadyEvent event)</span> {</span><br><span class="line">        <span class="built_in">this</span>.setupCallbacks();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setupCallbacks</span><span class="params">()</span> {</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 只确认消息是否正确到达 Exchange 中,成功与否都会回调</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> correlation 相关数据  非消息本身业务数据</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> ack             应答结果</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> reason           如果发送消息到交换器失败，错误原因</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">this</span>.rabbitTemplate.setConfirmCallback((correlation, ack, reason) -&gt; {</span><br><span class="line">            <span class="keyword">if</span> (ack) {</span><br><span class="line">                <span class="comment">//消息到交换器成功</span></span><br><span class="line">                log.info(<span class="string">"消息发送到Exchange成功：{}"</span>, correlation);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">//消息到交换器失败</span></span><br><span class="line">                log.error(<span class="string">"消息发送到Exchange失败：{}"</span>, reason);</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 消息没有正确到达队列时触发回调，如果正确到达队列不执行</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">this</span>.rabbitTemplate.setReturnsCallback(returned -&gt; {</span><br><span class="line">            log.error(<span class="string">"Returned: "</span> + returned.getMessage() + <span class="string">"\nreplyCode: "</span> + returned.getReplyCode()</span><br><span class="line">                    + <span class="string">"\nreplyText: "</span> + returned.getReplyText() + <span class="string">"\nexchange/rk: "</span></span><br><span class="line">                    + returned.getExchange() + <span class="string">"/"</span> + returned.getRoutingKey());</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="5-2-feng-zhuang-xiao-xi-fa-song">5.2、封装消息发送</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.common.service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitService</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  发送消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exchange 交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> routingKey 路由键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message 消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">sendMessage</span><span class="params">(String exchange, String routingKey, Object message)</span> {</span><br><span class="line">        rabbitTemplate.convertAndSend(exchange, routingKey, message);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="5-3-fa-song-que-ren-xiao-xi-ce-shi">5.3、发送确认消息测试</span></h4><h5><span id="5-3-1-pom-xml">5.3.1、pom.xml</span></h5><p>在<code>service-mq</code>引入<code>rabbit-util</code>模块依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.gmall<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rabbit-util<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-3-2-tian-jia-pei-zhi">5.3.2、添加配置</span></h5><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rabbitmq:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="number">139.198</span><span class="number">.163</span><span class="number">.91</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">  <span class="attr">publisher-confirm-type:</span> <span class="string">CORRELATED</span></span><br><span class="line">  <span class="attr">publisher-returns:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">listener:</span></span><br><span class="line">    <span class="attr">simple:</span></span><br><span class="line">      <span class="attr">cknowledge-mode:</span> <span class="string">manual</span> <span class="comment">#默认情况下消息消费者是自动确认消息的，如果要手动确认消息则需要修改确认模式为manual</span></span><br><span class="line">      <span class="attr">prefetch:</span> <span class="number">1</span> <span class="comment"># 消费者每次从队列获取的消息数量。此属性当不设置时为：轮询分发，设置为1为：公平分发</span></span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-3-3-mqcontroller">5.3.3、MqController</span></h5><p>消息发送端</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.mq.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.common.result.Result;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.common.service.RabbitService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/mq")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MqController</span> {</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitService rabbitService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息发送</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//http://localhost:8282/mq/sendConfirm</span></span><br><span class="line">    <span class="meta">@GetMapping("sendConfirm")</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">sendConfirm</span><span class="params">()</span> {</span><br><span class="line">        rabbitService.sendMessage(<span class="string">"exchange.confirm"</span>, <span class="string">"routing.confirm"</span>, <span class="string">"来人了，开始接客吧！"</span>);</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-3-4-confirmreceiver">5.3.4、ConfirmReceiver</span></h5><p>消息接收端</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.order.receiver;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Exchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.QueueBinding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConfirmReceiver</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">            value = @Queue(value = "queue.confirm"),</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(value = "exchange.confirm"),</span></span><br><span class="line"><span class="meta">            key = "routing.confirm"))</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(Message message, Channel channel)</span> {</span><br><span class="line">        System.out.println(<span class="string">"RabbitListener:"</span> + <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// false 确认一个消息，true 批量确认</span></span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>测试：<a target="_blank" rel="noopener" href="http://localhost:8282/mq/sendConfirm">http://localhost:8282/mq/sendConfirm</a></p>
<h4><span id="5-4-xiao-xi-fa-song-shi-bai-she-zhi-chong-fa-ji-zhi">5.4、消息发送失败，设置重发机制</span></h4><p>实现思路：借助redis来实现重发机制</p>
<h5><span id="5-4-1-guigucorrelationdata">5.4.1、GuiguCorrelationData</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.common.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GuiguCorrelationData</span> <span class="keyword">extends</span> <span class="title class_">CorrelationData</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">//消息体</span></span><br><span class="line">    <span class="keyword">private</span> Object message;</span><br><span class="line">    <span class="comment">//交换机</span></span><br><span class="line">    <span class="keyword">private</span> String exchange;</span><br><span class="line">    <span class="comment">//路由键</span></span><br><span class="line">    <span class="keyword">private</span> String routingKey;</span><br><span class="line">    <span class="comment">//重试次数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">retryCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//是否延迟消息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">isDelay</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//延迟时长</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">delayTime</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-4-2-xiu-gai-fa-song-fang-fa">5.4.2、修改发送方法</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  发送消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> exchange 交换机</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> routingKey 路由键</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message 消息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">sendMessage</span><span class="params">(String exchange, String routingKey, Object message)</span> {</span><br><span class="line">    <span class="comment">//1.创建自定义相关消息对象-包含业务数据本身，交换器名称，路由键，队列类型，延迟时间,重试次数</span></span><br><span class="line">    <span class="type">GuiguCorrelationData</span> <span class="variable">correlationData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GuiguCorrelationData</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> <span class="string">"mq:"</span> + UUID.randomUUID().toString().replaceAll(<span class="string">"-"</span>, <span class="string">""</span>);</span><br><span class="line">    correlationData.setId(uuid);</span><br><span class="line">    correlationData.setMessage(message);</span><br><span class="line">    correlationData.setExchange(exchange);</span><br><span class="line">    correlationData.setRoutingKey(routingKey);</span><br><span class="line">    <span class="comment">//2.将相关消息封装到发送消息方法中</span></span><br><span class="line"></span><br><span class="line">    rabbitTemplate.convertAndSend(exchange, routingKey, message, correlationData);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.将相关消息存入Redis  Key：UUID  相关消息对象  10 分钟</span></span><br><span class="line">    redisTemplate.opsForValue().set(uuid, JSON.toJSONString(correlationData), <span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//log.info("生产者发送消息成功：{}，{}，{}", exchange, routingKey, message);</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-4-3-rabbitinitconfigapplicationlistener">5.4.3、RabbitInitConfigApplicationListener</span></h5><p>修改RabbitInitConfigApplicationListener配置类</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.common.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.common.entity.GuiguCorrelationData;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.event.ApplicationReadyEvent;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitInitConfigApplicationListener</span> <span class="keyword">implements</span> <span class="title class_">ApplicationListener</span>&lt;ApplicationReadyEvent&gt; {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ApplicationReadyEvent event)</span> {</span><br><span class="line">        <span class="built_in">this</span>.setupCallbacks();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setupCallbacks</span><span class="params">()</span> {</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 只确认消息是否正确到达 Exchange 中,成功与否都会回调</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> correlation 相关数据  非消息本身业务数据</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> ack             应答结果</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> reason           如果发送消息到交换器失败，错误原因</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">this</span>.rabbitTemplate.setConfirmCallback((correlationData, ack, reason) -&gt; {</span><br><span class="line">            <span class="keyword">if</span> (ack) {</span><br><span class="line">                <span class="comment">//消息到交换器成功</span></span><br><span class="line">                log.info(<span class="string">"消息发送到Exchange成功：{}"</span>, correlationData);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">//消息到交换器失败</span></span><br><span class="line">                log.error(<span class="string">"消息发送到Exchange失败：{}"</span>, reason);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//执行消息重发</span></span><br><span class="line">                <span class="built_in">this</span>.retrySendMsg(correlationData);</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 消息没有正确到达队列时触发回调，如果正确到达队列不执行</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">this</span>.rabbitTemplate.setReturnsCallback(returned -&gt; {</span><br><span class="line">            log.error(<span class="string">"Returned: "</span> + returned.getMessage() + <span class="string">"\nreplyCode: "</span> + returned.getReplyCode()</span><br><span class="line">                    + <span class="string">"\nreplyText: "</span> + returned.getReplyText() + <span class="string">"\nexchange/rk: "</span></span><br><span class="line">                    + returned.getExchange() + <span class="string">"/"</span> + returned.getRoutingKey());</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息重新发送</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> correlationData</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">retrySendMsg</span><span class="params">(CorrelationData correlationData)</span> {</span><br><span class="line">        <span class="comment">//获取相关数据</span></span><br><span class="line">        <span class="type">GuiguCorrelationData</span> <span class="variable">gmallCorrelationData</span> <span class="operator">=</span> (GuiguCorrelationData) correlationData;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取redis中存放重试次数</span></span><br><span class="line">        <span class="comment">//先重发，在写会到redis中次数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">retryCount</span> <span class="operator">=</span> gmallCorrelationData.getRetryCount();</span><br><span class="line">        <span class="keyword">if</span> (retryCount &gt;= <span class="number">3</span>) {</span><br><span class="line">            <span class="comment">//超过最大重试次数</span></span><br><span class="line">            log.error(<span class="string">"生产者超过最大重试次数，将失败的消息存入数据库用人工处理；给管理员发送邮件；给管理员发送短信；"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//重发消息</span></span><br><span class="line">        rabbitTemplate.convertAndSend(gmallCorrelationData.getExchange(), gmallCorrelationData.getRoutingKey(), gmallCorrelationData.getMessage(), gmallCorrelationData);</span><br><span class="line">        <span class="comment">//重发次数+1</span></span><br><span class="line">        retryCount += <span class="number">1</span>;</span><br><span class="line">        gmallCorrelationData.setRetryCount(retryCount);</span><br><span class="line">        redisTemplate.opsForValue().set(gmallCorrelationData.getId(), JSON.toJSONString(gmallCorrelationData), <span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line">        log.info(<span class="string">"进行消息重发！"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>测试： 修改路由键或交换机 – 完美!</p>
<p>后续微信支付成功回调会使用消息确认机制。</p>
<h3><span id="6-yan-chi-xiao-xi">6、延迟消息</span></h3><p>延迟消息有两种实现方案：</p>
<p>1，基于死信队列</p>
<p>2，集成延迟插件</p>
<h4><span id="6-1-ji-yu-si-xin-shi-xian-yan-chi-xiao-xi">6.1、基于死信实现延迟消息</span></h4><p>使用RabbitMQ来实现延迟消息必须先了解RabbitMQ的两个概念：消息的TTL和死信Exchange，通过这两者的组合来实现延迟队列</p>
<h5><span id="6-1-1-xiao-xi-de-ttl-time-to-live">6.1.1、消息的TTL（Time To Live）</span></h5><p>消息的TTL就是消息的存活时间。RabbitMQ可以对队列和消息分别设置TTL。对队列设置就是队列没有消费者连着的保留时间，也可以对每一个单独的消息做单独的设置。超过了这个时间，我们认为这个消息就死了，称之为死信。</p>
<p>如何设置TTL：</p>
<p>我们创建一个队列queue.temp，在Arguments 中添加x-message-ttl 为5000 （单位是毫秒），那所在压在这个队列的消息在5秒后会消失。</p>
<h5><span id="6-1-2-si-xin-jiao-huan-ji-dead-letter-exchanges">6.1.2、死信交换机  Dead Letter Exchanges</span></h5><p>一个消息在满足如下条件下，会进死信路由，记住这里是路由而不是队列，一个路由可以对应很多队列。</p>
<p>（1） 一个消息被Consumer拒收了，并且reject方法的参数里requeue是false。也就是说不会被再次放在队列里，被其他消费者使用。</p>
<p>（2）<strong>上面的消息的TTL到了，消息过期了。</strong></p>
<p>（3）队列的长度限制满了。排在前面的消息会被丢弃或者扔到死信路由上。</p>
<p>Dead Letter Exchange其实就是一种普通的exchange，和创建其他exchange没有两样。只是在某一个设置Dead Letter Exchange的队列中有消息过期了，会自动触发消息的转发，发送到Dead Letter Exchange中去。</p>
<p><img src="/2024/09/26/projection-daijia/wps7.jpg" alt="img"> </p>
<p>我们现在可以测试一下延迟队列。</p>
<p>（1）创建死信队列 </p>
<p>（2）创建交换机 </p>
<p>（3）建立交换器与队列之间的绑定 </p>
<p>（4）创建队列</p>
<h5><span id="6-1-3-dai-ma-shi-xian">6.1.3、代码实现</span></h5><h6><span id="6-1-3-1-zai-service-mq-zhong-tian-jia-pei-zhi-lei">6.1.3.1、在service-mq中添加配置类</span></h6><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.mq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Binding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.BindingBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.DirectExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeadLetterMqConfig</span> {</span><br><span class="line">    <span class="comment">// 声明一些变量</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">exchange_dead</span> <span class="operator">=</span> <span class="string">"exchange.dead"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">routing_dead_1</span> <span class="operator">=</span> <span class="string">"routing.dead.1"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">routing_dead_2</span> <span class="operator">=</span> <span class="string">"routing.dead.2"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">queue_dead_1</span> <span class="operator">=</span> <span class="string">"queue.dead.1"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">queue_dead_2</span> <span class="operator">=</span> <span class="string">"queue.dead.2"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义交换机</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">exchange</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(exchange_dead, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queue1</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 设置如果队列一 出现问题，则通过参数转到exchange_dead，routing_dead_2 上！</span></span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 参数绑定 此处的key 固定值，不能随意写</span></span><br><span class="line">        map.put(<span class="string">"x-dead-letter-exchange"</span>, exchange_dead);</span><br><span class="line">        map.put(<span class="string">"x-dead-letter-routing-key"</span>, routing_dead_2);</span><br><span class="line">        <span class="comment">// 设置延迟时间</span></span><br><span class="line">        map.put(<span class="string">"x-message-ttl"</span>, <span class="number">10</span> * <span class="number">1000</span>);</span><br><span class="line">        <span class="comment">// 队列名称，是否持久化，是否独享、排外的【true:只可以在本次连接中访问】，是否自动删除，队列的其他属性参数</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(queue_dead_1, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, map);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">binding</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 将队列一 通过routing_dead_1 key 绑定到exchange_dead 交换机上</span></span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue1()).to(exchange()).with(routing_dead_1);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这个队列二就是一个普通队列</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queue2</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(queue_dead_2, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置队列二的绑定规则</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">binding2</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 将队列二通过routing_dead_2 key 绑定到exchange_dead交换机上！</span></span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue2()).to(exchange()).with(routing_dead_2);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="6-1-3-2-mqcontroller">6.1.3.2、MqController</span></h5><p>配置发送消息</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息发送延迟消息：基于死信实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/sendDeadLetterMsg")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sendDeadLetterMsg</span><span class="params">()</span> {</span><br><span class="line">    rabbitService.sendMessage(DeadLetterMqConfig.exchange_dead, DeadLetterMqConfig.routing_dead_1, <span class="string">"我是延迟消息"</span>);</span><br><span class="line">    log.info(<span class="string">"基于死信发送延迟消息成功"</span>);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h6><span id="6-1-3-3-deadletterreceiver">6.1.3.3、DeadLetterReceiver</span></h6><p>消息接收方</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.mq.receiver;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeadLetterReceiver</span> {</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听延迟消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = {DeadLetterMqConfig.queue_dead_2})</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getDeadLetterMsg</span><span class="params">(String msg, Message message, Channel channel)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNotBlank(msg)) {</span><br><span class="line">                log.info(<span class="string">"死信消费者：{}"</span>, msg);</span><br><span class="line">            }</span><br><span class="line">            channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            log.error(<span class="string">"[xx服务]监听xxx业务异常：{}"</span>, e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="6-2-ji-yu-yan-chi-cha-jian-shi-xian-yan-chi-xiao-xi">6.2、基于延迟插件实现延迟消息</span></h4><p>Rabbitmq实现了一个插件x-delay-message来实现延时队列</p>
<h5><span id="6-2-1-cha-jian-an-zhuang">6.2.1、插件安装</span></h5><ol>
<li><p>首先我们将刚下载下来的rabbitmq_delayed_message_exchange-3.9.0.ez文件上传到RabbitMQ所在服务器，下载地址：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/community-plugins.html">https://www.rabbitmq.com/community-plugins.html</a></p>
</li>
<li><p>切换到插件所在目录，执行命令，将刚插件拷贝到容器内plugins目录下</p>
<figure class="highlight dockerfile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp rabbitmq_delayed_message_exchange-<span class="number">3.9</span>.<span class="number">0</span>.ez gmalldocker_rabbitmq_1:/plugins</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>执行 docker exec -it gmalldocker_rabbitmq_1 /bin/bash 命令进入到容器内部，并 cd plugins 进入plugins目录</p>
</li>
<li><p>执行 ls -l|grep delay  命令查看插件是否copy成功</p>
</li>
<li><p>在容器内plugins目录下，执行 rabbitmq-plugins enable rabbitmq_delayed_message_exchange  命令启用插件</p>
</li>
<li><p>exit命令退出RabbitMQ容器内部，然后执行 docker restart gmalldocker_rabbitmq_1 命令重启RabbitMQ容器</p>
</li>
</ol>
<h5><span id="6-2-2-dai-ma-shi-xian">6.2.2、代码实现</span></h5><p><code>service-mq</code></p>
<h6><span id="6-2-2-1-delayedmqconfig">6.2.2.1、DelayedMqConfig</span></h6><p>配置队列</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.mq.config;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayedMqConfig</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">exchange_delay</span> <span class="operator">=</span> <span class="string">"exchange.delay"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">routing_delay</span> <span class="operator">=</span> <span class="string">"routing.delay"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">queue_delay_1</span> <span class="operator">=</span> <span class="string">"queue.delay.1"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">delayQeue1</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 第一个参数是创建的queue的名字，第二个参数是是否支持持久化</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(queue_delay_1, <span class="literal">true</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CustomExchange <span class="title function_">delayExchange</span><span class="params">()</span> {</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        args.put(<span class="string">"x-delayed-type"</span>, <span class="string">"direct"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomExchange</span>(exchange_delay, <span class="string">"x-delayed-message"</span>, <span class="literal">true</span>, <span class="literal">false</span>, args);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">delayBbinding1</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(delayQeue1()).to(delayExchange()).with(routing_delay).noargs();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h6><span id="6-2-2-2-mqcontroller">6.2.2.2、 MqController</span></h6><p>MqController：发送消息</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息发送延迟消息：基于延迟插件使用,使用插件后交换机会暂存消息固交换器无法即时路由消息到队列</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//@GetMapping("/sendDelayMsg")</span></span><br><span class="line"><span class="comment">//public Result sendDelayMsg() {</span></span><br><span class="line"><span class="comment">//    rabbitTemplate.convertAndSend(DelayedMqConfig.exchange_delay,</span></span><br><span class="line"><span class="comment">//            DelayedMqConfig.routing_delay,</span></span><br><span class="line"><span class="comment">//            "基于延迟插件-我是延迟消息",</span></span><br><span class="line"><span class="comment">//            (message -&gt; {</span></span><br><span class="line"><span class="comment">//                //设置消息ttl</span></span><br><span class="line"><span class="comment">//                message.getMessageProperties().setDelay(10000);</span></span><br><span class="line"><span class="comment">//                return message;</span></span><br><span class="line"><span class="comment">//            })</span></span><br><span class="line"><span class="comment">//    );</span></span><br><span class="line"><span class="comment">//    log.info("基于延迟插件-发送延迟消息成功");</span></span><br><span class="line"><span class="comment">//    return Result.ok();</span></span><br><span class="line"><span class="comment">//}</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息发送延迟消息：基于延迟插件使用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/sendDelayMsg")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sendDelayMsg</span><span class="params">()</span> {</span><br><span class="line">    <span class="comment">//调用工具方法发送延迟消息</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">delayTime</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    rabbitService.sendDealyMessage(DelayedMqConfig.exchange_delay, DelayedMqConfig.routing_delay, <span class="string">"我是延迟消息"</span>, delayTime);</span><br><span class="line">    log.info(<span class="string">"基于延迟插件-发送延迟消息成功"</span>);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h6><span id="6-2-2-3-rabbitservice">6.2.2.3、 RabbitService</span></h6><p> <code>rabbit-util</code>中<code>RabbitService</code>中封装发送延迟消息方法,队列确认方法中增加延迟队列判断</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送延迟消息方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> exchange 交换机</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> routingKey 路由键</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message 消息数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> delayTime 延迟时间，单位为：秒</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">sendDealyMessage</span><span class="params">(String exchange, String routingKey, Object message, <span class="type">int</span> delayTime)</span> {</span><br><span class="line">    <span class="comment">//1.创建自定义相关消息对象-包含业务数据本身，交换器名称，路由键，队列类型，延迟时间,重试次数</span></span><br><span class="line">    <span class="type">GuiguCorrelationData</span> <span class="variable">correlationData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GuiguCorrelationData</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> <span class="string">"mq:"</span> + UUID.randomUUID().toString().replaceAll(<span class="string">"-"</span>, <span class="string">""</span>);</span><br><span class="line">    correlationData.setId(uuid);</span><br><span class="line">    correlationData.setMessage(message);</span><br><span class="line">    correlationData.setExchange(exchange);</span><br><span class="line">    correlationData.setRoutingKey(routingKey);</span><br><span class="line">    correlationData.setDelay(<span class="literal">true</span>);</span><br><span class="line">    correlationData.setDelayTime(delayTime);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.将相关消息封装到发送消息方法中</span></span><br><span class="line">    rabbitTemplate.convertAndSend(exchange, routingKey, message,message1 -&gt; {</span><br><span class="line">        message1.getMessageProperties().setDelay(delayTime*<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">return</span> message1;</span><br><span class="line">    }, correlationData);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.将相关消息存入Redis  Key：UUID  相关消息对象  10 分钟</span></span><br><span class="line">    redisTemplate.opsForValue().set(uuid, JSON.toJSONString(correlationData), <span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h6><span id="6-2-2-4-rabbitinitconfigapplicationlistener">6.2.2.4、 RabbitInitConfigApplicationListener</span></h6><p><code>RabbitInitConfigApplicationListener</code>队列确认增加延迟消息判断</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.common.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitInitConfigApplicationListener</span> <span class="keyword">implements</span> <span class="title class_">ApplicationListener</span>&lt;ApplicationReadyEvent&gt; {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ApplicationReadyEvent event)</span> {</span><br><span class="line">        <span class="built_in">this</span>.setupCallbacks();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setupCallbacks</span><span class="params">()</span> {</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 只确认消息是否正确到达 Exchange 中,成功与否都会回调</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> correlation 相关数据  非消息本身业务数据</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> ack             应答结果</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> reason           如果发送消息到交换器失败，错误原因</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">this</span>.rabbitTemplate.setConfirmCallback((correlationData, ack, reason) -&gt; {</span><br><span class="line">            <span class="keyword">if</span> (ack) {</span><br><span class="line">                <span class="comment">//消息到交换器成功</span></span><br><span class="line">                log.info(<span class="string">"消息发送到Exchange成功：{}"</span>, correlationData);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">//消息到交换器失败</span></span><br><span class="line">                log.error(<span class="string">"消息发送到Exchange失败：{}"</span>, reason);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//执行消息重发</span></span><br><span class="line">                <span class="built_in">this</span>.retrySendMsg(correlationData);</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 消息没有正确到达队列时触发回调，如果正确到达队列不执行</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">this</span>.rabbitTemplate.setReturnsCallback(returned -&gt; {</span><br><span class="line">            log.error(<span class="string">"Returned: "</span> + returned.getMessage() + <span class="string">"\nreplyCode: "</span> + returned.getReplyCode()</span><br><span class="line">                    + <span class="string">"\nreplyText: "</span> + returned.getReplyText() + <span class="string">"\nexchange/rk: "</span></span><br><span class="line">                    + returned.getExchange() + <span class="string">"/"</span> + returned.getRoutingKey());</span><br><span class="line"></span><br><span class="line">            <span class="comment">//当路由队列失败 也需要重发</span></span><br><span class="line">            <span class="comment">//1.构建相关数据对象</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> returned.getMessage().getMessageProperties().getHeader(<span class="string">"spring_returned_message_correlation"</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">correlationDataStr</span> <span class="operator">=</span> (String) redisTemplate.opsForValue().get(redisKey);</span><br><span class="line">            <span class="type">GuiguCorrelationData</span> <span class="variable">guiguCorrelationData</span> <span class="operator">=</span> JSON.parseObject(correlationDataStr, GuiguCorrelationData.class);</span><br><span class="line">            <span class="comment">//todo 方式一:如果不考虑延迟消息重发 直接返回</span></span><br><span class="line">            <span class="keyword">if</span>(guiguCorrelationData.isDelay()){</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">//2.调用消息重发方法</span></span><br><span class="line">            <span class="built_in">this</span>.retrySendMsg(guiguCorrelationData);</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息重新发送</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> correlationData</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">retrySendMsg</span><span class="params">(CorrelationData correlationData)</span> {</span><br><span class="line">        <span class="comment">//获取相关数据</span></span><br><span class="line">        <span class="type">GuiguCorrelationData</span> <span class="variable">guiguCorrelationData</span> <span class="operator">=</span> (GuiguCorrelationData) correlationData;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取redis中存放重试次数</span></span><br><span class="line">        <span class="comment">//先重发，在写会到redis中次数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">retryCount</span> <span class="operator">=</span> guiguCorrelationData.getRetryCount();</span><br><span class="line">        <span class="keyword">if</span> (retryCount &gt;= <span class="number">3</span>) {</span><br><span class="line">            <span class="comment">//超过最大重试次数</span></span><br><span class="line">            log.error(<span class="string">"生产者超过最大重试次数，将失败的消息存入数据库用人工处理；给管理员发送邮件；给管理员发送短信；"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//重发次数+1</span></span><br><span class="line">        retryCount += <span class="number">1</span>;</span><br><span class="line">        guiguCorrelationData.setRetryCount(retryCount);</span><br><span class="line">        redisTemplate.opsForValue().set(guiguCorrelationData.getId(), JSON.toJSONString(guiguCorrelationData), <span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line">        log.info(<span class="string">"进行消息重发！"</span>);</span><br><span class="line">        <span class="comment">//重发消息</span></span><br><span class="line">        <span class="comment">//todo 方式二：如果是延迟消息，依然需要设置消息延迟时间</span></span><br><span class="line">        <span class="keyword">if</span> (guiguCorrelationData.isDelay()) {</span><br><span class="line">            <span class="comment">//延迟消息</span></span><br><span class="line">            rabbitTemplate.convertAndSend(guiguCorrelationData.getExchange(), guiguCorrelationData.getRoutingKey(), guiguCorrelationData.getMessage(), message -&gt; {</span><br><span class="line">                message.getMessageProperties().setDelay(guiguCorrelationData.getDelayTime() * <span class="number">1000</span>);</span><br><span class="line">                <span class="keyword">return</span> message;</span><br><span class="line">            }, guiguCorrelationData);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">//普通消息</span></span><br><span class="line">            rabbitTemplate.convertAndSend(guiguCorrelationData.getExchange(), guiguCorrelationData.getRoutingKey(), guiguCorrelationData.getMessage(), guiguCorrelationData);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h6><span id="6-2-2-5-delayreceiver">6.2.2.5、DelayReceiver</span></h6><p>接收消息,消费者端判断是否需要做幂等性处理</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.mq.receiver;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelayReceiver</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听到延迟消息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = DelayedMqConfig.queue_delay_1)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getDelayMsg</span><span class="params">(String msg, Message message, Channel channel)</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">"mq:"</span> + msg;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">//如果业务保证幂等性，基于redis setnx保证</span></span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">flag</span> <span class="operator">=</span> redisTemplate.opsForValue().setIfAbsent(key, <span class="string">""</span>, <span class="number">2</span>, TimeUnit.SECONDS);</span><br><span class="line">            <span class="keyword">if</span> (!flag) {</span><br><span class="line">                <span class="comment">//说明该业务数据以及被执行</span></span><br><span class="line">                channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNotBlank(msg)) {</span><br><span class="line">                log.info(<span class="string">"延迟插件监听消息：{}"</span>, msg);</span><br><span class="line">            }</span><br><span class="line">            channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            log.error(<span class="string">"异常：{}"</span>, e);</span><br><span class="line">            redisTemplate.delete(key);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>消费结果会发送三次，也被消费三次！</p>
<p>如何保证消息幂等性？</p>
<ol>
<li><p>使用数据库方式</p>
</li>
<li><p><strong>使用redis setnx 命令解决（推荐）</strong></p>
</li>
</ol>
<h4><span id="6-3-ji-yu-yan-chi-cha-jian-shi-xian-qu-xiao-ding-dan">6.3、基于延迟插件实现取消订单</span></h4><p>service-order模块</p>
<h5><span id="6-3-1-yin-ru-yi-lai">6.3.1、引入依赖</span></h5><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--rabbitmq工具模块--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.gmall<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rabbit-util<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h5><span id="6-3-2-tian-jia-pei-zhi">6.3.2、添加配置</span></h5><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rabbitmq:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="number">139.198</span><span class="number">.163</span><span class="number">.91</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">  <span class="attr">publisher-confirm-type:</span> <span class="string">CORRELATED</span></span><br><span class="line">  <span class="attr">publisher-returns:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">listener:</span></span><br><span class="line">    <span class="attr">simple:</span></span><br><span class="line">      <span class="attr">cknowledge-mode:</span> <span class="string">manual</span> <span class="comment">#默认情况下消息消费者是自动确认消息的，如果要手动确认消息则需要修改确认模式为manual</span></span><br><span class="line">      <span class="attr">prefetch:</span> <span class="number">1</span> <span class="comment"># 消费者每次从队列获取的消息数量。此属性当不设置时为：轮询分发，设置为1为：公平分发</span></span><br></pre></td></tr></tbody></table></figure>

<h5><span id="6-3-3-canelordermqconfig">6.3.3、CanelOrderMqConfig</span></h5><p>配置队列</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.order.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.common.constant.MqConst;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Binding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.BindingBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.CustomExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CanelOrderMqConfig</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">cancelQueue</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 第一个参数是创建的queue的名字，第二个参数是是否支持持久化</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(MqConst.QUEUE_CANCEL_ORDER, <span class="literal">true</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CustomExchange <span class="title function_">cancelExchange</span><span class="params">()</span> {</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        args.put(<span class="string">"x-delayed-type"</span>, <span class="string">"direct"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomExchange</span>(MqConst.EXCHANGE_CANCEL_ORDER, <span class="string">"x-delayed-message"</span>, <span class="literal">true</span>, <span class="literal">false</span>, args);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingCancel</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(cancelQueue()).to(cancelExchange()).with(MqConst.ROUTING_CANCEL_ORDER).noargs();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="6-3-4-fa-song-xiao-xi">6.3.4、发送消息</span></h5><p>创建订单时，发送延迟消息</p>
<p>修改保存订单方法</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RabbitService rabbitService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = {Exception.class})</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">saveOrderInfo</span><span class="params">(OrderInfoForm orderInfoForm)</span> {</span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">   <span class="comment">//发送延迟消息，取消订单</span></span><br><span class="line">   rabbitService.sendDealyMessage(MqConst.EXCHANGE_CANCEL_ORDER, MqConst.ROUTING_CANCEL_ORDER, String.valueOf(orderInfo.getId()), SystemConstant.CANCEL_ORDER_DELAY_TIME);</span><br><span class="line">   <span class="keyword">return</span> orderInfo.getId();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="6-3-5-jie-shou-xiao-xi">6.3.5、接收消息</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.order.receiver;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.common.constant.MqConst;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.daijia.order.service.OrderInfoService;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Exchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.QueueBinding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderReceiver</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderInfoService orderInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 系统取消订单</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = MqConst.QUEUE_CANCEL_ORDER)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">systemCancelOrder</span><span class="params">(String orderId, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">//1.处理业务</span></span><br><span class="line">            <span class="keyword">if</span> (orderId != <span class="literal">null</span>) {</span><br><span class="line">                log.info(<span class="string">"【订单微服务】关闭订单消息：{}"</span>, orderId);</span><br><span class="line">                orderInfoService.systemCancelOrder(Long.parseLong(orderId));</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">//2.手动应答</span></span><br><span class="line">            channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            log.error(<span class="string">"【订单微服务】关闭订单业务异常：{}"</span>, e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-3-6-orderinfoservice">5.3.6、OrderInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">systemCancelOrder</span><span class="params">(Long orderId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-3-7-orderinfoserviceimpl">5.3.7、 OrderInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">systemCancelOrder</span><span class="params">(Long orderId)</span> {</span><br><span class="line">   <span class="type">Integer</span> <span class="variable">orderStatus</span> <span class="operator">=</span> <span class="built_in">this</span>.getOrderStatus(orderId);</span><br><span class="line">   <span class="keyword">if</span>(<span class="literal">null</span> != orderStatus &amp;&amp; orderStatus.intValue() == OrderStatus.WAITING_ACCEPT.getStatus().intValue()) {</span><br><span class="line">      <span class="comment">//取消订单</span></span><br><span class="line">      <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfo</span>();</span><br><span class="line">      orderInfo.setId(orderId);</span><br><span class="line">      orderInfo.setStatus(OrderStatus.CANCEL_ORDER.getStatus());</span><br><span class="line">      <span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> orderInfoMapper.updateById(orderInfo);</span><br><span class="line">      <span class="keyword">if</span>(row == <span class="number">1</span>) {</span><br><span class="line">         <span class="comment">//记录日志</span></span><br><span class="line">         <span class="built_in">this</span>.log(orderInfo.getId(), orderInfo.getStatus());</span><br><span class="line"></span><br><span class="line">         <span class="comment">//删除redis订单标识</span></span><br><span class="line">         redisTemplate.delete(RedisConstant.ORDER_ACCEPT_MARK);</span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.UPDATE_ERROR);</span><br><span class="line">      }</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1><span id="xiii-wo-de-ding-dan-yu-yi-bu-bian-pai">XIII.我的订单与异步编排</span></h1><h2><span id="yi-wo-de-ding-dan">一、我的订单</span></h2><p>乘客端与司机端都有我的订单，在执行中的订单，都会跳转到执行中的页面，代驾结束后，进入订单详情页。</p>
<p><img src="/2024/09/26/projection-daijia/image-20240615191346427.png" alt="image-20240615191346427"></p>
<h3><span id="1-cheng-ke-duan-wo-de-ding-dan">1、乘客端我的订单</span></h3><h4><span id="1-1-ding-dan-wei-fu-wu-jie-kou">1.1、订单微服务接口</span></h4><h5><span id="1-1-1-orderinfocontroller">1.1.1、OrderInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "获取乘客订单分页列表")</span></span><br><span class="line"><span class="meta">@GetMapping("/findCustomerOrderPage/{customerId}/{page}/{limit}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;PageVo&gt; <span class="title function_">findCustomerOrderPage</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@Parameter(name = "customerId", description = "乘客id", required = true)</span></span></span><br><span class="line"><span class="params">    <span class="meta">@PathVariable</span> Long customerId,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">    <span class="meta">@Parameter(name = "page", description = "当前页码", required = true)</span></span></span><br><span class="line"><span class="params">    <span class="meta">@PathVariable</span> Long page,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">    <span class="meta">@Parameter(name = "limit", description = "每页记录数", required = true)</span></span></span><br><span class="line"><span class="params">    <span class="meta">@PathVariable</span> Long limit)</span> {</span><br><span class="line">    Page&lt;OrderInfo&gt; pageParam = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(page, limit);</span><br><span class="line">    <span class="type">PageVo</span> <span class="variable">pageVo</span> <span class="operator">=</span> orderInfoService.findCustomerOrderPage(pageParam, customerId);</span><br><span class="line">    pageVo.setPage(page);</span><br><span class="line">    pageVo.setLimit(limit);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(pageVo);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-2-orderinfoservice">1.1.2、OrderInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PageVo <span class="title function_">findCustomerOrderPage</span><span class="params">(Page&lt;OrderInfo&gt; pageParam, Long customerId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-3-orderinfoserviceimpl">1.1.3、OrderInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageVo <span class="title function_">findCustomerOrderPage</span><span class="params">(Page&lt;OrderInfo&gt; pageParam, Long customerId)</span> {</span><br><span class="line">    IPage&lt;OrderListVo&gt; pageInfo = orderInfoMapper.selectCustomerOrderPage(pageParam, customerId);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageVo</span>(pageInfo.getRecords(), pageInfo.getPages(), pageInfo.getTotal());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-4-orderinfomapper">1.1.4、OrderInfoMapper</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IPage&lt;OrderListVo&gt; <span class="title function_">selectCustomerOrderPage</span><span class="params">(Page&lt;OrderInfo&gt; page, <span class="meta">@Param("customerId")</span> Long customerId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-4-orderinfomapper-xml">1.1.4、OrderInfoMapper.xml</span></h5><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectCustomerOrderPage"</span> <span class="attr">resultType</span>=<span class="string">"com.atguigu.daijia.model.vo.order.OrderListVo"</span>&gt;</span></span><br><span class="line">    select</span><br><span class="line">        info.id,</span><br><span class="line">        info.order_no,</span><br><span class="line">        info.start_location,</span><br><span class="line">        info.end_location,</span><br><span class="line">        if(info.status <span class="symbol">&amp;lt;</span> 7, info.expect_amount, bill.pay_amount) as amount,</span><br><span class="line">        info.status,</span><br><span class="line">        info.create_time</span><br><span class="line">    from order_info info</span><br><span class="line">     left join order_bill bill on bill.order_id = info.id</span><br><span class="line">    where info.customer_id = #{customerId}</span><br><span class="line">    and info.is_deleted = 0</span><br><span class="line">    order by info.create_time desc</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-feign-jie-kou">1.2、Feign接口</span></h4><h5><span id="1-2-1-orderinfofeignclient">1.2.1、OrderInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取乘客订单分页列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> customerId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> page</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> limit</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/order/info/findCustomerOrderPage/{customerId}/{page}/{limit}")</span></span><br><span class="line">Result&lt;PageVo&gt; <span class="title function_">findCustomerOrderPage</span><span class="params">(<span class="meta">@PathVariable("customerId")</span> Long customerId,</span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable("page")</span> Long page,</span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable("limit")</span> Long limit)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-3-cheng-ke-duan-web-jie-kou">1.3、乘客端web接口</span></h4><h5><span id="1-3-1-ordercontroller">1.3.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "获取乘客订单分页列表")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("findCustomerOrderPage/{page}/{limit}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;PageVo&gt; <span class="title function_">findCustomerOrderPage</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@Parameter(name = "page", description = "当前页码", required = true)</span></span></span><br><span class="line"><span class="params">    <span class="meta">@PathVariable</span> Long page,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">    <span class="meta">@Parameter(name = "limit", description = "每页记录数", required = true)</span></span></span><br><span class="line"><span class="params">    <span class="meta">@PathVariable</span> Long limit)</span> {</span><br><span class="line">    <span class="type">Long</span> <span class="variable">customerId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">    <span class="type">PageVo</span> <span class="variable">pageVo</span> <span class="operator">=</span> orderService.findCustomerOrderPage(customerId, page, limit);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(pageVo);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-3-2-orderservice">1.3.2、OrderService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PageVo <span class="title function_">findCustomerOrderPage</span><span class="params">(Long customerId, Long page, Long limit)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-3-3-orderserviceimpl">1.3.3、OrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageVo <span class="title function_">findCustomerOrderPage</span><span class="params">(Long customerId, Long page, Long limit)</span> {</span><br><span class="line">    <span class="keyword">return</span> orderInfoFeignClient.findCustomerOrderPage(customerId, page, limit).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-si-ji-duan-wo-de-ding-dan">2、司机端我的订单</span></h3><h4><span id="2-1-ding-dan-wei-fu-wu-jie-kou">2.1、订单微服务接口</span></h4><h5><span id="2-1-1-orderinfocontroller">2.1.1、OrderInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "获取司机订单分页列表")</span></span><br><span class="line"><span class="meta">@GetMapping("/findDriverOrderPage/{driverId}/{page}/{limit}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;PageVo&gt; <span class="title function_">findDriverOrderPage</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@Parameter(name = "driverId", description = "司机id", required = true)</span></span></span><br><span class="line"><span class="params">    <span class="meta">@PathVariable</span> Long driverId,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">    <span class="meta">@Parameter(name = "page", description = "当前页码", required = true)</span></span></span><br><span class="line"><span class="params">    <span class="meta">@PathVariable</span> Long page,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">    <span class="meta">@Parameter(name = "limit", description = "每页记录数", required = true)</span></span></span><br><span class="line"><span class="params">    <span class="meta">@PathVariable</span> Long limit)</span> {</span><br><span class="line">    Page&lt;OrderInfo&gt; pageParam = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(page, limit);</span><br><span class="line">    <span class="type">PageVo</span> <span class="variable">pageVo</span> <span class="operator">=</span> orderInfoService.findDriverOrderPage(pageParam, driverId);</span><br><span class="line">    pageVo.setPage(page);</span><br><span class="line">    pageVo.setLimit(limit);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(pageVo);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-2-orderinfoservice">2.1.2、OrderInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PageVo <span class="title function_">findDriverOrderPage</span><span class="params">(Page&lt;OrderInfo&gt; pageParam, Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-3-orderinfoserviceimpl">2.1.3、OrderInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageVo <span class="title function_">findDriverOrderPage</span><span class="params">(Page&lt;OrderInfo&gt; pageParam, Long driverId)</span> {</span><br><span class="line">    IPage&lt;OrderListVo&gt; pageInfo = orderInfoMapper.selectDriverOrderPage(pageParam, driverId);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageVo</span>(pageInfo.getRecords(), pageInfo.getPages(), pageInfo.getTotal());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-4-orderinfomapper">2.1.4、OrderInfoMapper</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IPage&lt;OrderListVo&gt; <span class="title function_">selectDriverOrderPage</span><span class="params">(Page&lt;OrderInfo&gt; page, <span class="meta">@Param("driverId")</span> Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-4-orderinfomapper-xml">2.1.4、OrderInfoMapper.xml</span></h5><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectDriverOrderPage"</span> <span class="attr">resultType</span>=<span class="string">"com.atguigu.daijia.model.vo.order.OrderListVo"</span>&gt;</span></span><br><span class="line">    select</span><br><span class="line">        id,</span><br><span class="line">        order_no,</span><br><span class="line">        start_location,</span><br><span class="line">        end_location,</span><br><span class="line">        real_amount as pay_amount,</span><br><span class="line">        if(status <span class="symbol">&amp;lt;</span> 7, expect_amount, real_amount) as amount,</span><br><span class="line">        status,</span><br><span class="line">        create_time</span><br><span class="line">    from order_info</span><br><span class="line">    where driver_id = #{driverId}</span><br><span class="line">      and is_deleted = 0</span><br><span class="line">    order by create_time desc</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-2-feign-jie-kou">2.2、Feign接口</span></h4><h5><span id="2-2-1-orderinfofeignclient">2.2.1、OrderInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取司机订单分页列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> page</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> limit</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/order/info/findDriverOrderPage/{driverId}/{page}/{limit}")</span></span><br><span class="line">Result&lt;PageVo&gt; <span class="title function_">findDriverOrderPage</span><span class="params">(<span class="meta">@PathVariable("driverId")</span> Long driverId,</span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable("page")</span> Long page,</span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable("limit")</span> Long limit)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-3-si-ji-duan-web-jie-kou">2.3、司机端web接口</span></h4><h5><span id="2-3-1-ordercontroller">2.3.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "获取司机订单分页列表")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("findDriverOrderPage/{page}/{limit}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;PageVo&gt; <span class="title function_">findDriverOrderPage</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@Parameter(name = "page", description = "当前页码", required = true)</span></span></span><br><span class="line"><span class="params">    <span class="meta">@PathVariable</span> Long page,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">    <span class="meta">@Parameter(name = "limit", description = "每页记录数", required = true)</span></span></span><br><span class="line"><span class="params">    <span class="meta">@PathVariable</span> Long limit)</span> {</span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">    <span class="type">PageVo</span> <span class="variable">pageVo</span> <span class="operator">=</span> orderService.findDriverOrderPage(driverId, page, limit);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(pageVo);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-3-2-orderservice">2.3.2、OrderService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PageVo <span class="title function_">findDriverOrderPage</span><span class="params">(Long driverId, Long page, Long limit)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-3-3-orderserviceimpl">2.3.3、OrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageVo <span class="title function_">findDriverOrderPage</span><span class="params">(Long driverId, Long page, Long limit)</span> {</span><br><span class="line">    <span class="keyword">return</span> orderInfoFeignClient.findDriverOrderPage(driverId, page, limit).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="er-completablefuture-yi-bu-bian-pai">二、CompletableFuture异步编排</span></h2><h3><span id="1-completablefuture-yi-bu-bian-pai">1、CompletableFuture异步编排</span></h3><h4><span id="1-1-completablefuture-jie-shao">1.1、CompletableFuture介绍</span></h4><ul>
<li>问题：司机结束代驾服务页面非常复杂，数据的获取都需要远程调用，必然需要花费更多的时间。</li>
</ul>
<p>假如司机结束代驾服务的每个查询，需要如下标注的时间才能完成</p>
<ol>
<li>获取订单信息   1s</li>
<li>计算防止刷单 0.5s</li>
<li>计算订单实际里程 0.5s</li>
<li>计算订单实际代驾费用 1s</li>
<li>……</li>
</ol>
<ul>
<li><p>那么，司机需要4s后才能结束代驾服务。很显然是不能接受的。如果有多个线程同时完成这多步操作，也许只需要1.1s即可完成响应。</p>
</li>
<li><p>使用<code>CompletableFuture</code>可用于线程异步编排，使原本串行执行的代码，变为并行执行，提高代码执行速度。</p>
</li>
</ul>
<h4><span id="1-2-completablefuture-shi-yong">1.2、CompletableFuture使用</span></h4><p>说明：使用<code>CompletableFuture</code>异步编排大多方法都会有一个重载方法，会多出一个executor参数，用来传来自定义的线程池，如果不传就会使用默认的线程池。</p>
<h5><span id="1-2-1-chuang-jian-yi-bu-bian-pai-dui-xiang">1.2.1、创建异步编排对象</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">supplyAsync</span><span class="params">(Supplier&lt;U&gt; supplier)</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">supplyAsync</span><span class="params">(Supplier&lt;U&gt; supplier, Executor executor)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CompletableFuture&lt;Void&gt; <span class="title function_">runAsync</span><span class="params">(Runnable runnable)</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CompletableFuture&lt;Void&gt; <span class="title function_">runAsync</span><span class="params">(Runnable runnable, Executor executor)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h5><span id="1-2-2-xian-cheng-chuan-xing-fang-fa">1.2.2、线程串行方法</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使线程串行执行，无入参，无返回值</span></span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;Void&gt; <span class="title function_">thenRun</span><span class="params">(Runnable action)</span>;</span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;Void&gt; <span class="title function_">thenRunAsync</span><span class="params">(Runnable action)</span>;</span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;Void&gt; <span class="title function_">thenRunAsync</span><span class="params">(Runnable action, Executor executor)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使线程串行执行，有入参，无返回值</span></span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;Void&gt; <span class="title function_">thenAccept</span><span class="params">(Consumer&lt;? <span class="built_in">super</span> T&gt; action)</span>;</span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;Void&gt; <span class="title function_">thenAcceptAsync</span><span class="params">(Consumer&lt;? <span class="built_in">super</span> T&gt; action)</span>;</span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;Void&gt; <span class="title function_">thenAcceptAsync</span><span class="params">(Consumer&lt;? <span class="built_in">super</span> T&gt; action, Executor executor)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使线程串行执行，有入参，有返回值</span></span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">thenApply</span><span class="params">(Function&lt;? <span class="built_in">super</span> T,? extends U&gt; fn)</span>;</span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">thenApplyAsync</span><span class="params">(Function&lt;? <span class="built_in">super</span> T,? extends U&gt; fn)</span>;</span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">thenApplyAsync</span><span class="params">(Function&lt;? <span class="built_in">super</span> T,? extends U&gt; fn, Executor executor)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h5><span id="1-2-3-duo-ren-wu-zu-he">1.2.3、多任务组合</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> CompletableFuture&lt;Void&gt; <span class="title function_">allOf</span><span class="params">(CompletableFuture&lt;?&gt;... cfs)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h5><span id="1-2-4-dai-ma-shi-li">1.2.4、代码示例</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.driver;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CompletableFutureTest5</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="comment">//动态获取服务器核数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">processors</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors();</span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">                processors+<span class="number">1</span>, <span class="comment">// 核心线程个数 io:2n ,cpu: n+1  n:内核数据</span></span><br><span class="line">                processors+<span class="number">1</span>,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                TimeUnit.SECONDS,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">10</span>),</span><br><span class="line">                Executors.defaultThreadFactory(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.AbortPolicy()</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        CompletableFuture&lt;String&gt; future01 = CompletableFuture.supplyAsync(() -&gt; <span class="string">"任务1"</span>, executor);</span><br><span class="line">        CompletableFuture&lt;String&gt; future02 = CompletableFuture.supplyAsync(() -&gt; <span class="string">"任务2"</span>, executor);</span><br><span class="line">        CompletableFuture&lt;String&gt; future03 = CompletableFuture.supplyAsync(() -&gt; {</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"任务3"</span>;</span><br><span class="line">        }, executor);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 串联起若干个线程任务, 没有返回值</span></span><br><span class="line">        CompletableFuture&lt;Void&gt; all = CompletableFuture.allOf(future01, future02, future03);</span><br><span class="line">        <span class="comment">// 等待所有线程执行完成</span></span><br><span class="line">        <span class="comment">// .join()和.get()都会阻塞并获取线程的执行情况</span></span><br><span class="line">        <span class="comment">// .join()会抛出未经检查的异常，不会强制开发者处理异常 .get()会抛出检查异常，需要开发者处理</span></span><br><span class="line">        all.join();</span><br><span class="line">        all.get();</span><br><span class="line">    }</span><br><span class="line">}   </span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-jie-shu-dai-jia">2、结束代驾</span></h3><h4><span id="2-1-threadpoolconfig">2.1、ThreadPoolConfig</span></h4><p>全局自定义线程池配置</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.driver.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ArrayBlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全局自定义线程池配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolConfig</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ThreadPoolExecutor <span class="title function_">threadPoolExecutor</span><span class="params">()</span>{</span><br><span class="line">        <span class="comment">//动态获取服务器核数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">processors</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors();</span><br><span class="line">        <span class="type">ThreadPoolExecutor</span> <span class="variable">threadPoolExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">                processors+<span class="number">1</span>, <span class="comment">// 核心线程个数 io:2n ,cpu: n+1  n:内核数据</span></span><br><span class="line">                processors+<span class="number">1</span>,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                TimeUnit.SECONDS,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">3</span>),</span><br><span class="line">                Executors.defaultThreadFactory(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.AbortPolicy()</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">//  返回线程池对象</span></span><br><span class="line">        <span class="keyword">return</span> threadPoolExecutor;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-2-orderserviceimpl">2.2、OrderServiceImpl</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ThreadPoolExecutor threadPoolExecutor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SneakyThrows</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">endDrive</span><span class="params">(OrderFeeForm orderFeeForm)</span> {</span><br><span class="line">   <span class="comment">//1.获取订单信息</span></span><br><span class="line">   CompletableFuture&lt;OrderInfo&gt; orderInfoCompletableFuture = CompletableFuture.supplyAsync(() -&gt; {</span><br><span class="line">      <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderInfo(orderFeeForm.getOrderId()).getData();</span><br><span class="line">      <span class="keyword">return</span> orderInfo;</span><br><span class="line">   }, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//2.防止刷单，计算司机的经纬度与代驾的终点经纬度是否在2公里范围内</span></span><br><span class="line">   CompletableFuture&lt;OrderServiceLastLocationVo&gt; orderServiceLastLocationVoCompletableFuture = CompletableFuture.supplyAsync((() -&gt; {</span><br><span class="line">      <span class="type">OrderServiceLastLocationVo</span> <span class="variable">orderServiceLastLocationVo</span> <span class="operator">=</span> locationFeignClient.getOrderServiceLastLocation(orderFeeForm.getOrderId()).getData();</span><br><span class="line">      <span class="keyword">return</span> orderServiceLastLocationVo;</span><br><span class="line">   }), threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//合并</span></span><br><span class="line">   CompletableFuture.allOf(orderInfoCompletableFuture,</span><br><span class="line">         orderServiceLastLocationVoCompletableFuture</span><br><span class="line">   ).join();</span><br><span class="line"></span><br><span class="line">   <span class="comment">//获取数据</span></span><br><span class="line">   <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoCompletableFuture.get();</span><br><span class="line">   <span class="comment">//2.1.判断刷单</span></span><br><span class="line">   <span class="type">OrderServiceLastLocationVo</span> <span class="variable">orderServiceLastLocationVo</span> <span class="operator">=</span> orderServiceLastLocationVoCompletableFuture.get();</span><br><span class="line">   <span class="comment">//司机的位置与代驾终点位置的距离</span></span><br><span class="line">   <span class="type">double</span> <span class="variable">distance</span> <span class="operator">=</span> LocationUtil.getDistance(orderInfo.getEndPointLatitude().doubleValue(), orderInfo.getEndPointLongitude().doubleValue(), orderServiceLastLocationVo.getLatitude().doubleValue(), orderServiceLastLocationVo.getLongitude().doubleValue());</span><br><span class="line">   <span class="keyword">if</span>(distance &gt; SystemConstant.DRIVER_START_LOCATION_DISTION) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DRIVER_END_LOCATION_DISTION_ERROR);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">//3.计算订单实际里程</span></span><br><span class="line">   CompletableFuture&lt;BigDecimal&gt; realDistanceCompletableFuture = CompletableFuture.supplyAsync(() -&gt; {</span><br><span class="line">      <span class="type">BigDecimal</span> <span class="variable">realDistance</span> <span class="operator">=</span> locationFeignClient.calculateOrderRealDistance(orderFeeForm.getOrderId()).getData();</span><br><span class="line">      log.info(<span class="string">"结束代驾，订单实际里程：{}"</span>, realDistance);</span><br><span class="line">      <span class="keyword">return</span> realDistance;</span><br><span class="line">   }, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">//4.计算代驾实际费用</span></span><br><span class="line">   CompletableFuture&lt;FeeRuleResponseVo&gt; feeRuleResponseVoCompletableFuture = realDistanceCompletableFuture.thenApplyAsync((realDistance)-&gt;{</span><br><span class="line">      <span class="type">FeeRuleRequestForm</span> <span class="variable">feeRuleRequestForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeeRuleRequestForm</span>();</span><br><span class="line">      feeRuleRequestForm.setDistance(realDistance);</span><br><span class="line">      feeRuleRequestForm.setStartTime(orderInfo.getStartServiceTime());</span><br><span class="line">      <span class="comment">//等候时间</span></span><br><span class="line">      <span class="type">Integer</span> <span class="variable">waitMinute</span> <span class="operator">=</span> Math.abs((<span class="type">int</span>) ((orderInfo.getArriveTime().getTime() - orderInfo.getAcceptTime().getTime()) / (<span class="number">1000</span> * <span class="number">60</span>)));</span><br><span class="line">      feeRuleRequestForm.setWaitMinute(waitMinute);</span><br><span class="line">      log.info(<span class="string">"结束代驾，费用参数：{}"</span>, JSON.toJSONString(feeRuleRequestForm));</span><br><span class="line">      <span class="type">FeeRuleResponseVo</span> <span class="variable">feeRuleResponseVo</span> <span class="operator">=</span> feeRuleFeignClient.calculateOrderFee(feeRuleRequestForm).getData();</span><br><span class="line">      log.info(<span class="string">"费用明细：{}"</span>, JSON.toJSONString(feeRuleResponseVo));</span><br><span class="line">      <span class="comment">//订单总金额 需加上 路桥费、停车费、其他费用、乘客好处费</span></span><br><span class="line">      <span class="type">BigDecimal</span> <span class="variable">totalAmount</span> <span class="operator">=</span> feeRuleResponseVo.getTotalAmount().add(orderFeeForm.getTollFee()).add(orderFeeForm.getParkingFee()).add(orderFeeForm.getOtherFee()).add(orderInfo.getFavourFee());</span><br><span class="line">      feeRuleResponseVo.setTotalAmount(totalAmount);</span><br><span class="line">      <span class="keyword">return</span> feeRuleResponseVo;</span><br><span class="line">   });</span><br><span class="line"></span><br><span class="line">   <span class="comment">//5.计算系统奖励</span></span><br><span class="line">   <span class="comment">//5.1.获取订单数</span></span><br><span class="line">   CompletableFuture&lt;Long&gt; orderNumCompletableFuture = CompletableFuture.supplyAsync(() -&gt; {</span><br><span class="line">      <span class="type">String</span> <span class="variable">startTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DateTime</span>(orderInfo.getStartServiceTime()).toString(<span class="string">"yyyy-MM-dd"</span>) + <span class="string">" 00:00:00"</span>;</span><br><span class="line">      <span class="type">String</span> <span class="variable">endTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DateTime</span>(orderInfo.getStartServiceTime()).toString(<span class="string">"yyyy-MM-dd"</span>) + <span class="string">" 24:00:00"</span>;</span><br><span class="line">      <span class="type">Long</span> <span class="variable">orderNum</span> <span class="operator">=</span> orderInfoFeignClient.getOrderNumByTime(startTime, endTime).getData();</span><br><span class="line">      <span class="keyword">return</span> orderNum;</span><br><span class="line">   }, threadPoolExecutor);</span><br><span class="line">   <span class="comment">//5.2.封装参数</span></span><br><span class="line">   CompletableFuture&lt;RewardRuleResponseVo&gt; rewardRuleResponseVoCompletableFuture = orderNumCompletableFuture.thenApplyAsync((orderNum)-&gt;{</span><br><span class="line">      <span class="type">RewardRuleRequestForm</span> <span class="variable">rewardRuleRequestForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RewardRuleRequestForm</span>();</span><br><span class="line">      rewardRuleRequestForm.setStartTime(orderInfo.getStartServiceTime());</span><br><span class="line">      rewardRuleRequestForm.setOrderNum(orderNum);</span><br><span class="line">      <span class="comment">//5.3.执行</span></span><br><span class="line">      <span class="type">RewardRuleResponseVo</span> <span class="variable">rewardRuleResponseVo</span> <span class="operator">=</span> rewardRuleFeignClient.calculateOrderRewardFee(rewardRuleRequestForm).getData();</span><br><span class="line">      log.info(<span class="string">"结束代驾，系统奖励：{}"</span>, JSON.toJSONString(rewardRuleResponseVo));</span><br><span class="line">      <span class="keyword">return</span> rewardRuleResponseVo;</span><br><span class="line">   });</span><br><span class="line"></span><br><span class="line">   <span class="comment">//6.计算分账信息</span></span><br><span class="line">   CompletableFuture&lt;ProfitsharingRuleResponseVo&gt; profitsharingRuleResponseVoCompletableFuture = feeRuleResponseVoCompletableFuture.thenCombineAsync(orderNumCompletableFuture, (feeRuleResponseVo, orderNum)-&gt;{</span><br><span class="line">      <span class="type">ProfitsharingRuleRequestForm</span> <span class="variable">profitsharingRuleRequestForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProfitsharingRuleRequestForm</span>();</span><br><span class="line">      profitsharingRuleRequestForm.setOrderAmount(feeRuleResponseVo.getTotalAmount());</span><br><span class="line">      profitsharingRuleRequestForm.setOrderNum(orderNum);</span><br><span class="line">      <span class="type">ProfitsharingRuleResponseVo</span> <span class="variable">profitsharingRuleResponseVo</span> <span class="operator">=</span> profitsharingRuleFeignClient.calculateOrderProfitsharingFee(profitsharingRuleRequestForm).getData();</span><br><span class="line">      log.info(<span class="string">"结束代驾，分账信息：{}"</span>, JSON.toJSONString(profitsharingRuleResponseVo));</span><br><span class="line">      <span class="keyword">return</span> profitsharingRuleResponseVo;</span><br><span class="line">   });</span><br><span class="line">   CompletableFuture.allOf(orderInfoCompletableFuture,</span><br><span class="line">         realDistanceCompletableFuture,</span><br><span class="line">         feeRuleResponseVoCompletableFuture,</span><br><span class="line">         orderNumCompletableFuture,</span><br><span class="line">         rewardRuleResponseVoCompletableFuture,</span><br><span class="line">         profitsharingRuleResponseVoCompletableFuture</span><br><span class="line">   ).join();</span><br><span class="line"></span><br><span class="line">   <span class="comment">//获取执行结果</span></span><br><span class="line">   <span class="type">BigDecimal</span> <span class="variable">realDistance</span> <span class="operator">=</span> realDistanceCompletableFuture.get();</span><br><span class="line">   <span class="type">FeeRuleResponseVo</span> <span class="variable">feeRuleResponseVo</span> <span class="operator">=</span> feeRuleResponseVoCompletableFuture.get();</span><br><span class="line">   <span class="type">RewardRuleResponseVo</span> <span class="variable">rewardRuleResponseVo</span> <span class="operator">=</span> rewardRuleResponseVoCompletableFuture.get();</span><br><span class="line">   <span class="type">ProfitsharingRuleResponseVo</span> <span class="variable">profitsharingRuleResponseVo</span> <span class="operator">=</span> profitsharingRuleResponseVoCompletableFuture.get();</span><br><span class="line"></span><br><span class="line">   <span class="comment">//7.封装更新订单账单相关实体对象</span></span><br><span class="line">   <span class="type">UpdateOrderBillForm</span> <span class="variable">updateOrderBillForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpdateOrderBillForm</span>();</span><br><span class="line">   updateOrderBillForm.setOrderId(orderFeeForm.getOrderId());</span><br><span class="line">   updateOrderBillForm.setDriverId(orderFeeForm.getDriverId());</span><br><span class="line">   <span class="comment">//路桥费、停车费、其他费用</span></span><br><span class="line">   updateOrderBillForm.setTollFee(orderFeeForm.getTollFee());</span><br><span class="line">   updateOrderBillForm.setParkingFee(orderFeeForm.getParkingFee());</span><br><span class="line">   updateOrderBillForm.setOtherFee(orderFeeForm.getOtherFee());</span><br><span class="line">   <span class="comment">//乘客好处费</span></span><br><span class="line">   updateOrderBillForm.setFavourFee(orderInfo.getFavourFee());</span><br><span class="line"></span><br><span class="line">   <span class="comment">//实际里程</span></span><br><span class="line">   updateOrderBillForm.setRealDistance(realDistance);</span><br><span class="line">   <span class="comment">//订单奖励信息</span></span><br><span class="line">   BeanUtils.copyProperties(rewardRuleResponseVo, updateOrderBillForm);</span><br><span class="line">   <span class="comment">//代驾费用信息</span></span><br><span class="line">   BeanUtils.copyProperties(feeRuleResponseVo, updateOrderBillForm);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//分账相关信息</span></span><br><span class="line">   BeanUtils.copyProperties(profitsharingRuleResponseVo, updateOrderBillForm);</span><br><span class="line">   updateOrderBillForm.setProfitsharingRuleId(profitsharingRuleResponseVo.getProfitsharingRuleId());</span><br><span class="line">   log.info(<span class="string">"结束代驾，更新账单信息：{}"</span>, JSON.toJSONString(updateOrderBillForm));</span><br><span class="line"></span><br><span class="line">   <span class="comment">//8.结束代驾更新账单</span></span><br><span class="line">   orderInfoFeignClient.endDrive(updateOrderBillForm);</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h1><span id="xiv-ding-dan-zhi-fu">XIV.订单支付</span></h1><h2><span id="yi-zhang-dan-xin-xi">一、账单信息</span></h2><p>上一节中我们结束的代驾，更新了账单信息与分账信息，接下来司机端小程序会跳转到账单确认页，展示账单信息，然后发送账单给乘客端，乘客端拿到账单信息后进行支付账单。</p>
<p><img src="/2024/09/26/projection-daijia/pay.gif" alt="pay"></p>
<h3><span id="1-huo-qu-zhang-dan-xin-xi">1、获取账单信息</span></h3><p>order_bill表记录的账单信息，我们直接获取即可</p>
<h4><span id="1-1-ding-dan-wei-fu-wu-jie-kou">1.1、订单微服务接口</span></h4><h5><span id="1-1-1-orderinfocontroller">1.1.1、OrderInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "根据订单id获取实际账单信息")</span></span><br><span class="line"><span class="meta">@GetMapping("/getOrderBillInfo/{orderId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderBillVo&gt; <span class="title function_">getOrderBillInfo</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(orderInfoService.getOrderBillInfo(orderId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-2-orderinfoservice">1.1.2、OrderInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OrderBillVo <span class="title function_">getOrderBillInfo</span><span class="params">(Long orderId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-3-orderinfoserviceimpl">1.1.3、OrderInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> OrderBillVo <span class="title function_">getOrderBillInfo</span><span class="params">(Long orderId)</span> {</span><br><span class="line">   <span class="type">OrderBill</span> <span class="variable">orderBill</span> <span class="operator">=</span> orderBillMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;OrderBill&gt;().eq(OrderBill::getOrderId, orderId));</span><br><span class="line">   <span class="type">OrderBillVo</span> <span class="variable">orderBillVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderBillVo</span>();</span><br><span class="line">   BeanUtils.copyProperties(orderBill, orderBillVo);</span><br><span class="line">   <span class="keyword">return</span> orderBillVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-feign-jie-kou">1.2、Feign接口</span></h4><h5><span id="1-2-1-orderinfofeignclient">1.2.1、OrderInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据订单id获取实际账单信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/order/info/getOrderBillInfo/{orderId}")</span></span><br><span class="line">Result&lt;OrderBillVo&gt; <span class="title function_">getOrderBillInfo</span><span class="params">(<span class="meta">@PathVariable("orderId")</span> Long orderId)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-huo-qu-fen-zhang-xin-xi">2、获取分账信息</span></h3><p>order_profitsharing表记录的分账信息，我们直接获取即可</p>
<h4><span id="2-1-ding-dan-wei-fu-wu-jie-kou">2.1、订单微服务接口</span></h4><h5><span id="2-1-1-orderinfocontroller">2.1.1、OrderInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "根据订单id获取实际分账信息")</span></span><br><span class="line"><span class="meta">@GetMapping("/getOrderProfitsharing/{orderId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderProfitsharingVo&gt; <span class="title function_">getOrderProfitsharing</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderInfoService.getOrderProfitsharing(orderId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-2-orderinfoservice">2.1.2、OrderInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OrderProfitsharingVo <span class="title function_">getOrderProfitsharing</span><span class="params">(Long orderId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-3-orderinfoserviceimpl">2.1.3、OrderInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> OrderProfitsharingVo <span class="title function_">getOrderProfitsharing</span><span class="params">(Long orderId)</span> {</span><br><span class="line">    <span class="type">OrderProfitsharing</span> <span class="variable">orderProfitsharing</span> <span class="operator">=</span> orderProfitsharingMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;OrderProfitsharing&gt;().eq(OrderProfitsharing::getOrderId, orderId));</span><br><span class="line">    <span class="type">OrderProfitsharingVo</span> <span class="variable">orderProfitsharingVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderProfitsharingVo</span>();</span><br><span class="line">    BeanUtils.copyProperties(orderProfitsharing, orderProfitsharingVo);</span><br><span class="line">    <span class="keyword">return</span> orderProfitsharingVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-2-feign-jie-kou">2.2、Feign接口</span></h4><h5><span id="2-2-1-orderinfofeignclient">2.2.1、OrderInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据订单id获取实际分账信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/order/info/getOrderProfitsharing/{orderId}")</span></span><br><span class="line">Result&lt;OrderProfitsharingVo&gt; <span class="title function_">getOrderProfitsharing</span><span class="params">(<span class="meta">@PathVariable("orderId")</span> Long orderId)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-si-ji-duan-huo-qu-zhang-dan-xin-xi">3、司机端获取账单信息</span></h3><p>司机端账单信息其实就是订单的明细，前面我们已经提供获取订单信息接口，这里我们直接完善即可</p>
<h4><span id="3-1-si-ji-duan-web-jie-kou">3.1、司机端web接口</span></h4><h5><span id="3-1-1-orderserviceimpl">3.1.1、OrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> OrderInfoVo <span class="title function_">getOrderInfo</span><span class="params">(Long orderId, Long driverId)</span> {</span><br><span class="line">   <span class="comment">//订单信息</span></span><br><span class="line">   <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderInfo(orderId).getData();</span><br><span class="line">   <span class="keyword">if</span>(orderInfo.getDriverId().longValue() != driverId.longValue()) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.ILLEGAL_REQUEST);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">//账单信息</span></span><br><span class="line">   <span class="type">OrderBillVo</span> <span class="variable">orderBillVo</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">   <span class="comment">//分账信息</span></span><br><span class="line">   <span class="type">OrderProfitsharingVo</span> <span class="variable">orderProfitsharing</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">   <span class="keyword">if</span> (orderInfo.getStatus().intValue() &gt;= OrderStatus.END_SERVICE.getStatus().intValue()) {</span><br><span class="line">      orderBillVo = orderInfoFeignClient.getOrderBillInfo(orderId).getData();</span><br><span class="line"></span><br><span class="line">      <span class="comment">//获取分账信息</span></span><br><span class="line">      orderProfitsharing = orderInfoFeignClient.getOrderProfitsharing(orderId).getData();</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">//封装订单信息</span></span><br><span class="line">   <span class="type">OrderInfoVo</span> <span class="variable">orderInfoVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfoVo</span>();</span><br><span class="line">   orderInfoVo.setOrderId(orderId);</span><br><span class="line">   BeanUtils.copyProperties(orderInfo, orderInfoVo);</span><br><span class="line">   orderInfoVo.setOrderBillVo(orderBillVo);</span><br><span class="line">   orderInfoVo.setOrderProfitsharingVo(orderProfitsharing);</span><br><span class="line">   <span class="keyword">return</span> orderInfoVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-fa-song-zhang-dan">4、发送账单</span></h3><p>司机端确认账单信息后，点击“发送账单”，乘客端才能切换到未支付账单页面，发送账单其实就是更新订单流程中的一个状态。</p>
<h4><span id="4-1-ding-dan-wei-fu-wu-jie-kou">4.1、订单微服务接口</span></h4><h5><span id="4-1-1-orderinfocontroller">4.1.1、OrderInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "发送账单信息")</span></span><br><span class="line"><span class="meta">@GetMapping("/sendOrderBillInfo/{orderId}/{driverId}")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">sendOrderBillInfo</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId, <span class="meta">@PathVariable</span> Long driverId)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderInfoService.sendOrderBillInfo(orderId, driverId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-2-orderinfoservice">4.1.2、OrderInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">sendOrderBillInfo</span><span class="params">(Long orderId, Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-3-orderinfoserviceimpl">4.1.3、OrderInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">sendOrderBillInfo</span><span class="params">(Long orderId, Long driverId)</span> {</span><br><span class="line">    <span class="comment">//更新订单信息</span></span><br><span class="line">    LambdaQueryWrapper&lt;OrderInfo&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(OrderInfo::getId, orderId);</span><br><span class="line">    queryWrapper.eq(OrderInfo::getDriverId, driverId);</span><br><span class="line">    <span class="comment">//更新字段</span></span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">updateOrderInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfo</span>();</span><br><span class="line">    updateOrderInfo.setStatus(OrderStatus.UNPAID.getStatus());</span><br><span class="line">    <span class="comment">//只能更新自己的订单</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> orderInfoMapper.update(updateOrderInfo, queryWrapper);</span><br><span class="line">    <span class="keyword">if</span>(row == <span class="number">1</span>) {</span><br><span class="line">        <span class="comment">//记录日志</span></span><br><span class="line">        <span class="built_in">this</span>.log(orderId, OrderStatus.UNPAID.getStatus());</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.UPDATE_ERROR);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-2-feign-jie-kou">4.2、Feign接口</span></h4><h5><span id="4-2-1-orderinfofeignclient">4.2.1、OrderInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 司机发送账单信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/order/info/sendOrderBillInfo/{orderId}/{driverId}")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">sendOrderBillInfo</span><span class="params">(<span class="meta">@PathVariable("orderId")</span> Long orderId, <span class="meta">@PathVariable("driverId")</span> Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-3-si-ji-duan-web-jie-kou">4.3、司机端web接口</span></h4><h5><span id="4-3-1-ordercontroller">4.3.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "司机发送账单信息")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("/sendOrderBillInfo/{orderId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">sendOrderBillInfo</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> {</span><br><span class="line">    <span class="type">Long</span> <span class="variable">driverId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">    <span class="keyword">return</span> Result.ok(orderService.sendOrderBillInfo(orderId, driverId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-3-2-orderservice">4.3.2、OrderService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">sendOrderBillInfo</span><span class="params">(Long orderId, Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-3-3-orderserviceimpl">4.3.3、OrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">sendOrderBillInfo</span><span class="params">(Long orderId, Long driverId)</span> {</span><br><span class="line">   <span class="keyword">return</span> orderInfoFeignClient.sendOrderBillInfo(orderId, driverId).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="5-cheng-ke-duan-huo-qu-zhang-dan">5、乘客端获取账单</span></h3><p>账单信息其实就是订单的明细，前面我们已经提供获取订单信息接口，这里我们直接完善即可。</p>
<h4><span id="5-1-cheng-ke-duan-web-jie-kou">5.1、乘客端web接口</span></h4><h5><span id="5-1-1-orderserviceimpl">5.1.1、OrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> OrderInfoVo <span class="title function_">getOrderInfo</span><span class="params">(Long orderId, Long customerId)</span> {</span><br><span class="line">    <span class="comment">//订单信息</span></span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderInfo(orderId).getData();</span><br><span class="line">    <span class="keyword">if</span> (orderInfo.getCustomerId().longValue() != customerId.longValue()) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.ILLEGAL_REQUEST);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">     <span class="comment">//获取司机信息</span></span><br><span class="line">    <span class="type">DriverInfoVo</span> <span class="variable">driverInfoVo</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> != orderInfo.getDriverId()) {</span><br><span class="line">        driverInfoVo = driverInfoFeignClient.getDriverInfo(orderInfo.getDriverId()).getData();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//账单信息</span></span><br><span class="line">    <span class="type">OrderBillVo</span> <span class="variable">orderBillVo</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (orderInfo.getStatus().intValue() &gt;= OrderStatus.UNPAID.getStatus().intValue()) {</span><br><span class="line">        orderBillVo = orderInfoFeignClient.getOrderBillInfo(orderId).getData();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装订单信息</span></span><br><span class="line">    <span class="type">OrderInfoVo</span> <span class="variable">orderInfoVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfoVo</span>();</span><br><span class="line">    orderInfoVo.setOrderId(orderId);</span><br><span class="line">    BeanUtils.copyProperties(orderInfo, orderInfoVo);</span><br><span class="line">    orderInfoVo.setOrderBillVo(orderBillVo);</span><br><span class="line">    <span class="keyword">return</span> orderInfoVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="er-wei-xin-zhi-fu">二、微信支付</span></h2><p><img src="/2024/09/26/projection-daijia/image-20240616124527861.png" alt="image-20240616124527861"></p>
<p>因为咱们要创建可以分账的微信支付账单，调用API的时候需要分别提供司机和乘客的OpenId，当前咱们把这两个数据给查询出来。</p>
<h3><span id="1-huo-qu-cheng-ke-openid">1、获取乘客OpenId</span></h3><h4><span id="1-1-cheng-ke-wei-fu-wu-jie-kou">1.1、乘客微服务接口</span></h4><h5><span id="1-1-1-customerinfocontroller">1.1.1、CustomerInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "获取客户OpenId")</span></span><br><span class="line"><span class="meta">@GetMapping("/getCustomerOpenId/{customerId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">getCustomerOpenId</span><span class="params">(<span class="meta">@PathVariable</span> Long customerId)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(customerInfoService.getCustomerOpenId(customerId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-2-customerinfoservice">1.1.2、CustomerInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String <span class="title function_">getCustomerOpenId</span><span class="params">(Long customerId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-3-customerinfoserviceimpl">1.1.3、CustomerInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getCustomerOpenId</span><span class="params">(Long customerId)</span> {</span><br><span class="line">   <span class="type">CustomerInfo</span> <span class="variable">customerInfo</span> <span class="operator">=</span> <span class="built_in">this</span>.getOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;CustomerInfo&gt;().eq(CustomerInfo::getId, customerId).select(CustomerInfo::getWxOpenId));</span><br><span class="line">   <span class="keyword">return</span> customerInfo.getWxOpenId();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-feign-jie-kou">1.2、Feign接口</span></h4><h5><span id="1-2-1-customerinfofeignclient">1.2.1、CustomerInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取客户OpenId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> customerId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/customer/info/getCustomerOpenId/{customerId}")</span></span><br><span class="line">Result&lt;String&gt; <span class="title function_">getCustomerOpenId</span><span class="params">(<span class="meta">@PathVariable("customerId")</span> Long customerId)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-huo-qu-si-ji-openid">2、获取司机OpenId</span></h3><h4><span id="2-1-si-ji-wei-fu-wu-jie-kou">2.1、司机微服务接口</span></h4><h5><span id="2-1-1-driverinfocontroller">2.1.1、DriverInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "获取司机OpenId")</span></span><br><span class="line"><span class="meta">@GetMapping("/getDriverOpenId/{driverId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;String&gt; <span class="title function_">getDriverOpenId</span><span class="params">(<span class="meta">@PathVariable</span> Long driverId)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(driverInfoService.getDriverOpenId(driverId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-2-driverinfoservice">2.1.2、DriverInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String <span class="title function_">getDriverOpenId</span><span class="params">(Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-3-driverinfoserviceimpl">2.1.3、DriverInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getDriverOpenId</span><span class="params">(Long driverId)</span> {</span><br><span class="line">    <span class="type">DriverInfo</span> <span class="variable">driverInfo</span> <span class="operator">=</span> <span class="built_in">this</span>.getOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;DriverInfo&gt;().eq(DriverInfo::getId, driverId).select(DriverInfo::getWxOpenId));</span><br><span class="line">    <span class="keyword">return</span> driverInfo.getWxOpenId();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-2-feign-jie-kou">2.2、Feign接口</span></h4><h5><span id="2-2-1-driverinfofeignclient">2.2.1、DriverInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取司机OpenId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> driverId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/driver/info/getDriverOpenId/{driverId}")</span></span><br><span class="line">Result&lt;String&gt; <span class="title function_">getDriverOpenId</span><span class="params">(<span class="meta">@PathVariable("driverId")</span> Long driverId)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-huo-qu-ding-dan-zhi-fu-xin-xi">3、获取订单支付信息</span></h3><h4><span id="3-1-ding-dan-wei-fu-wu-jie-kou">3.1、订单微服务接口</span></h4><h5><span id="3-1-1-orderinfocontroller">3.1.1、OrderInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "获取订单支付信息")</span></span><br><span class="line"><span class="meta">@GetMapping("/getOrderPayVo/{orderNo}/{customerId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderPayVo&gt; <span class="title function_">getOrderPayVo</span><span class="params">(<span class="meta">@PathVariable</span> String orderNo, <span class="meta">@PathVariable</span> Long customerId)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(orderInfoService.getOrderPayVo(orderNo, customerId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-2-orderinfoservice">3.1.2、OrderInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OrderPayVo <span class="title function_">getOrderPayVo</span><span class="params">(String orderNo, Long customerId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-3-orderinfoserviceimpl">3.1.3、OrderInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> OrderPayVo <span class="title function_">getOrderPayVo</span><span class="params">(String orderNo, Long customerId)</span> {</span><br><span class="line">   <span class="type">OrderPayVo</span> <span class="variable">orderPayVo</span> <span class="operator">=</span> orderInfoMapper.selectOrderPayVo(orderNo, customerId);</span><br><span class="line">   <span class="keyword">if</span>(<span class="literal">null</span> != orderPayVo) {</span><br><span class="line">      <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> orderPayVo.getStartLocation() + <span class="string">" 到 "</span> + orderPayVo.getEndLocation();</span><br><span class="line">      orderPayVo.setContent(content);</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">return</span> orderPayVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-4-orderinfomapper">3.1.4、OrderInfoMapper</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OrderPayVo <span class="title function_">selectOrderPayVo</span><span class="params">(<span class="meta">@Param("orderNo")</span>String orderNo, <span class="meta">@Param("customerId")</span>Long customerId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-5-orderinfomapper-xml">3.1.5、OrderInfoMapper.xml</span></h5><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectOrderPayVo"</span> <span class="attr">resultType</span>=<span class="string">"com.atguigu.daijia.model.vo.order.OrderPayVo"</span>&gt;</span></span><br><span class="line">    select</span><br><span class="line">        info.id as order_id,</span><br><span class="line">        info.customer_id,</span><br><span class="line">        info.driver_id,</span><br><span class="line">        info.order_no,</span><br><span class="line">        info.start_location,</span><br><span class="line">        info.end_location,</span><br><span class="line">        info.status,</span><br><span class="line">        bill.pay_amount,</span><br><span class="line">        bill.coupon_amount</span><br><span class="line">    from order_info info</span><br><span class="line">             inner join order_bill bill on bill.order_id = info.id</span><br><span class="line">    where info.customer_id = #{customerId}</span><br><span class="line">      and info.order_no = #{orderNo}</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4><span id="3-2-feign-jie-kou">3.2、Feign接口</span></h4><h5><span id="3-2-1-orderinfofeignclient">3.2.1、OrderInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取订单支付信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderNo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> customerId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/order/info/getOrderPayVo/{orderNo}/{customerId}")</span></span><br><span class="line">Result&lt;OrderPayVo&gt; <span class="title function_">getOrderPayVo</span><span class="params">(<span class="meta">@PathVariable("orderNo")</span> String orderNo, <span class="meta">@PathVariable("customerId")</span> Long customerId)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-wei-xin-zhi-fu">4、微信支付</span></h3><h4><span id="4-1-wei-xin-zhi-fu-jie-kou">4.1、微信支付接口</span></h4><h5><span id="4-1-1-shen-qing-bing-bang-ding-wei-xin-zhi-fu">4.1.1、申请并绑定微信支付</span></h5><p>微信支付商户平台：<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/index.php/core/home/login">https://pay.weixin.qq.com/index.php/core/home/login</a></p>
<p>对于商家来说，想要开通微信支付，必须要去“微信支付商户平台”注册，然后把需要的资料提交上去，经过审核通过，你就开通了微信支付功能。</p>
<p>企业申请资料：</p>
<p>1、营业执照：彩色扫描件或数码照片</p>
<p>2、组织机构代码证：彩色扫描件或数码照片，若已三证合一，则无需提供</p>
<p>3、对公银行账户：包含开户行省市信息，开户账号</p>
<p>4、法人身份证：彩色扫描件或数码照片</p>
<p><img src="/2024/09/26/projection-daijia/1699860787734.png" alt="69986078773"></p>
<p>如果想要在网站或者小程序上面使用微信支付，还要在微信公众平台上面关联你自己的微信商户账号。前提是你的微信开发者账号必须是企业身份，个人身份的开发者账号是无法调用微信支付API的。</p>
<p><img src="/2024/09/26/projection-daijia/1699861132564.png" alt="69986113256"></p>
<p>已关联商户号</p>
<p><img src="/2024/09/26/projection-daijia/1699861198438.png" alt="69986119843"></p>
<h5><span id="4-1-2-zhi-fu-mi-yao-he-shu-zi-zheng-shu">4.1.2、支付密钥和数字证书</span></h5><p>因为调用微信支付平台的API接口，必须要用到支付密钥和数字证书，这些参数在微信支付商户平台都可以获取。</p>
<p>说明：需要测试支付的人员必须加入微信开发者，才能调用微信支付，微信小程序的AppId必须与微信支付的AppId一致。</p>
<h5><span id="4-1-3-wei-xin-zhi-fu-jie-kou">4.1.3、微信支付接口</span></h5><p>小程序前端官方文档：<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/payment/wx.requestPayment.html">https://developers.weixin.qq.com/miniprogram/dev/api/payment/wx.requestPayment.html</a></p>
<p>服务器端官方文档：<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_1.shtml">https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_1.shtml</a></p>
<h4><span id="4-2-zhi-fu-wei-fu-wu-jie-kou">4.2、支付微服务接口</span></h4><h5><span id="4-2-1-pom-xml">4.2.1、pom.xml</span></h5><p>官方文档地址：<a target="_blank" rel="noopener" href="https://github.com/wechatpay-apiv3/wechatpay-java">https://github.com/wechatpay-apiv3/wechatpay-java</a></p>
<p>微信官方封装了微信支付的SDK，引入依赖直接使用，很是方便</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.wechatpay-apiv3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>wechatpay-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-2-2-common-account-yaml">4.2.2、common-account.yaml</span></h5><p>apiclient_key.pem在资料文件夹中，路径改为可访问的正确路径。</p>
<p>异步回调地址必须外网能够访问，本地可以使用内网穿透。</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">wx:</span></span><br><span class="line">  <span class="attr">v3pay:</span></span><br><span class="line">    <span class="comment">#小程序微信公众平台appId</span></span><br><span class="line">    <span class="attr">appid:</span> <span class="string">wxcc651fcbab275e33</span></span><br><span class="line">    <span class="comment">#商户号</span></span><br><span class="line">    <span class="attr">merchantId:</span> <span class="number">1631833859</span></span><br><span class="line">    <span class="comment">#商户API私钥路径</span></span><br><span class="line">    <span class="attr">privateKeyPath:</span> <span class="string">/root/daijia/apiclient_key.pem</span></span><br><span class="line">    <span class="comment">#商户证书序列号</span></span><br><span class="line">    <span class="attr">merchantSerialNumber:</span> <span class="string">4AE80B52EBEAB2B96F68E02510A42801E952E889</span></span><br><span class="line">    <span class="comment">#商户APIV3密钥</span></span><br><span class="line">    <span class="attr">apiV3key:</span> <span class="string">84dba6dd51cdaf779e55bcabae564b53</span></span><br><span class="line">    <span class="comment">#异步回调地址</span></span><br><span class="line">    <span class="attr">notifyUrl:</span> <span class="string">http://139.198.127.41:8600/payment/wxPay/notify</span></span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-2-3-wxpayv3config">4.2.3、WxPayV3Config</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.payment.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.wechat.pay.java.core.RSAAutoCertificateConfig;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix="wx.v3pay")</span> <span class="comment">//读取节点</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WxPayV3Properties</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String appid;</span><br><span class="line">    <span class="comment">/** 商户号 */</span></span><br><span class="line">    <span class="keyword">public</span> String merchantId;</span><br><span class="line">    <span class="comment">/** 商户API私钥路径 */</span></span><br><span class="line">    <span class="keyword">public</span> String privateKeyPath;</span><br><span class="line">    <span class="comment">/** 商户证书序列号 */</span></span><br><span class="line">    <span class="keyword">public</span> String merchantSerialNumber;</span><br><span class="line">    <span class="comment">/** 商户APIV3密钥 */</span></span><br><span class="line">    <span class="keyword">public</span> String apiV3key;</span><br><span class="line">    <span class="comment">/** 回调地址 */</span></span><br><span class="line">    <span class="keyword">private</span> String notifyUrl;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RSAAutoCertificateConfig <span class="title function_">getConfig</span><span class="params">()</span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RSAAutoCertificateConfig</span>.Builder()</span><br><span class="line">                        .merchantId(<span class="built_in">this</span>.getMerchantId())</span><br><span class="line">                        .privateKeyFromPath(<span class="built_in">this</span>.getPrivateKeyPath())</span><br><span class="line">                        .merchantSerialNumber(<span class="built_in">this</span>.getMerchantSerialNumber())</span><br><span class="line">                        .apiV3Key(<span class="built_in">this</span>.getApiV3key())</span><br><span class="line">                        .build();</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-2-4-wxpaycontroller">4.2.4、WxPayController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "创建微信支付")</span></span><br><span class="line"><span class="meta">@PostMapping("/createJsapi")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;WxPrepayVo&gt; <span class="title function_">createWxPayment</span><span class="params">(<span class="meta">@RequestBody</span> PaymentInfoForm paymentInfoForm)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(wxPayService.createWxPayment(paymentInfoForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-2-5-wxpayservice">4.2.5、WxPayService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WxPrepayVo <span class="title function_">createWxPayment</span><span class="params">(PaymentInfoForm paymentInfoForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-2-6-wxpayserviceimpl">4.2.6、WxPayServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> WxPrepayVo <span class="title function_">createWxPayment</span><span class="params">(PaymentInfoForm paymentInfoForm)</span> {</span><br><span class="line">   <span class="keyword">try</span> {</span><br><span class="line">      <span class="type">PaymentInfo</span> <span class="variable">paymentInfo</span> <span class="operator">=</span> paymentInfoMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;PaymentInfo&gt;().eq(PaymentInfo::getOrderNo, paymentInfoForm.getOrderNo()));</span><br><span class="line">      <span class="keyword">if</span>(<span class="literal">null</span> == paymentInfo) {</span><br><span class="line">         paymentInfo = <span class="keyword">new</span> <span class="title class_">PaymentInfo</span>();</span><br><span class="line">         BeanUtils.copyProperties(paymentInfoForm, paymentInfo);</span><br><span class="line">         paymentInfo.setPaymentStatus(<span class="number">0</span>);</span><br><span class="line">         paymentInfoMapper.insert(paymentInfo);</span><br><span class="line">      }</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 构建service</span></span><br><span class="line">      <span class="type">JsapiServiceExtension</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JsapiServiceExtension</span>.Builder().config(rsaAutoCertificateConfig).build();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// request.setXxx(val)设置所需参数，具体参数可见Request定义</span></span><br><span class="line">      <span class="type">PrepayRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrepayRequest</span>();</span><br><span class="line">      <span class="type">Amount</span> <span class="variable">amount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Amount</span>();</span><br><span class="line">      amount.setTotal(paymentInfoForm.getAmount().multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">100</span>)).intValue());</span><br><span class="line">      request.setAmount(amount);</span><br><span class="line">      request.setAppid(wxPayV3Properties.getAppid());</span><br><span class="line">      request.setMchid(wxPayV3Properties.getMerchantId());</span><br><span class="line">      <span class="comment">//string[1,127]</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">description</span> <span class="operator">=</span> paymentInfo.getContent();</span><br><span class="line">      <span class="keyword">if</span>(description.length() &gt; <span class="number">127</span>) {</span><br><span class="line">         description = description.substring(<span class="number">0</span>, <span class="number">127</span>);</span><br><span class="line">      }</span><br><span class="line">      request.setDescription(paymentInfo.getContent());</span><br><span class="line">      request.setNotifyUrl(wxPayV3Properties.getNotifyUrl());</span><br><span class="line">      request.setOutTradeNo(paymentInfo.getOrderNo());</span><br><span class="line"></span><br><span class="line">      <span class="comment">//获取用户信息</span></span><br><span class="line">      <span class="type">Payer</span> <span class="variable">payer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Payer</span>();</span><br><span class="line">      payer.setOpenid(paymentInfoForm.getCustomerOpenId());</span><br><span class="line">      request.setPayer(payer);</span><br><span class="line">       </span><br><span class="line">      <span class="comment">//是否指定分账，不指定不能分账</span></span><br><span class="line">      <span class="type">SettleInfo</span> <span class="variable">settleInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SettleInfo</span>();</span><br><span class="line">      settleInfo.setProfitSharing(<span class="literal">true</span>);</span><br><span class="line">      request.setSettleInfo(settleInfo);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 调用下单方法，得到应答</span></span><br><span class="line">      <span class="comment">// response包含了调起支付所需的所有参数，可直接用于前端调起支付</span></span><br><span class="line">      <span class="type">PrepayWithRequestPaymentResponse</span> <span class="variable">response</span> <span class="operator">=</span> service.prepayWithRequestPayment(request);</span><br><span class="line">      log.info(<span class="string">"微信支付下单返回参数：{}"</span>, JSON.toJSONString(response));</span><br><span class="line"></span><br><span class="line">      <span class="type">WxPrepayVo</span> <span class="variable">wxPrepayVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WxPrepayVo</span>();</span><br><span class="line">      BeanUtils.copyProperties(response, wxPrepayVo);</span><br><span class="line">      wxPrepayVo.setTimeStamp(response.getTimeStamp());</span><br><span class="line">      <span class="keyword">return</span> wxPrepayVo;</span><br><span class="line">   } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.WX_CREATE_ERROR);</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-3-feign-jie-kou">4.3、Feign接口</span></h4><h5><span id="4-3-1-wxpayfeignclient">4.3.1、WxPayFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建微信支付</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> paymentInfoForm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping("/payment/wxPay/createWxPayment")</span></span><br><span class="line">Result&lt;WxPrepayVo&gt; <span class="title function_">createWxPayment</span><span class="params">(<span class="meta">@RequestBody</span> PaymentInfoForm paymentInfoForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-4-cheng-ke-duan-web-jie-kou">4.4、乘客端web接口</span></h4><h5><span id="4-4-1-ordercontroller">4.4.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "创建微信支付")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@PostMapping("/createWxPayment")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;WxPrepayVo&gt; <span class="title function_">createWxPayment</span><span class="params">(<span class="meta">@RequestBody</span> CreateWxPaymentForm createWxPaymentForm)</span> {</span><br><span class="line">   <span class="type">Long</span> <span class="variable">customerId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">   createWxPaymentForm.setCustomerId(customerId);</span><br><span class="line">   <span class="keyword">return</span> Result.ok(orderService.createWxPayment(createWxPaymentForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-4-2-orderservice">4.4.2、OrderService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WxPrepayVo <span class="title function_">createWxPayment</span><span class="params">(CreateWxPaymentForm createWxPaymentForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-4-2-orderserviceimpl">4.4.2、OrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DriverInfoFeignClient driverInfoFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> CustomerInfoFeignClient customerInfoFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> WxPayFeignClient wxPayFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> WxPrepayVo <span class="title function_">createWxPayment</span><span class="params">(CreateWxPaymentForm createWxPaymentForm)</span> {</span><br><span class="line">    <span class="comment">//1.获取订单支付相关信息</span></span><br><span class="line">    <span class="type">OrderPayVo</span> <span class="variable">orderPayVo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderPayVo(createWxPaymentForm.getOrderNo(), createWxPaymentForm.getCustomerId()).getData();</span><br><span class="line">    <span class="comment">//判断是否在未支付状态</span></span><br><span class="line">    <span class="keyword">if</span> (orderPayVo.getStatus().intValue() != OrderStatus.UNPAID.getStatus().intValue()) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.ILLEGAL_REQUEST);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.获取乘客微信openId</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">customerOpenId</span> <span class="operator">=</span> customerInfoFeignClient.getCustomerOpenId(orderPayVo.getCustomerId()).getData();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.获取司机微信openId</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">driverOpenId</span> <span class="operator">=</span> driverInfoFeignClient.getDriverOpenId(orderPayVo.getDriverId()).getData();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4.封装微信下单对象，微信支付只关注以下订单属性</span></span><br><span class="line">    <span class="type">PaymentInfoForm</span> <span class="variable">paymentInfoForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PaymentInfoForm</span>();</span><br><span class="line">    paymentInfoForm.setCustomerOpenId(customerOpenId);</span><br><span class="line">    paymentInfoForm.setDriverOpenId(driverOpenId);</span><br><span class="line">    paymentInfoForm.setOrderNo(orderPayVo.getOrderNo());</span><br><span class="line">    paymentInfoForm.setAmount(orderPayVo.getPayAmount());</span><br><span class="line">    paymentInfoForm.setContent(orderPayVo.getContent());</span><br><span class="line">    paymentInfoForm.setPayWay(<span class="number">1</span>);</span><br><span class="line">    <span class="type">WxPrepayVo</span> <span class="variable">wxPrepayVo</span> <span class="operator">=</span> wxPayFeignClient.createWxPayment(paymentInfoForm).getData();</span><br><span class="line">    <span class="keyword">return</span> wxPrepayVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-5-cheng-ke-duan-xiao-cheng-xu-huan-qi-fu-kuan-chuang-kou">4.5、乘客端小程序唤起付款窗口</span></h4><p>小程序前端官方文档：<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/payment/wx.requestPayment.html">https://developers.weixin.qq.com/miniprogram/dev/api/payment/wx.requestPayment.html</a></p>
<p>乘客端小程序调用创建微信支付接口，然后调用<code>uni.requestPayment()</code>函数传入返回参数，小程序就能弹出付款窗口了。</p>
<h3><span id="5-zhi-fu-jie-guo-tong-zhi">5、支付结果通知</span></h3><p>官方文档地址：<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_5.shtml">https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_5.shtml</a></p>
<p>支付成功，微信平台异步通知，我们处理完支付微服务业务逻辑后，快速返回，需要发送mq消息处理订单其他业务，因此我们要引入mq消息队列。</p>
<h4><span id="5-1-zhi-fu-wei-fu-wu-jie-kou">5.1、支付微服务接口</span></h4><h5><span id="5-1-1-yin-ru-yi-lai">5.1.1、引入依赖</span></h5><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.daijia<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rabbit-util<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-1-2-tian-jia-pei-zhi">5.1.2、添加配置</span></h5><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rabbitmq:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="number">139.198</span><span class="number">.163</span><span class="number">.91</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">guest</span></span><br><span class="line">  <span class="attr">publisher-confirm-type:</span> <span class="string">CORRELATED</span></span><br><span class="line">  <span class="attr">publisher-returns:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">listener:</span></span><br><span class="line">    <span class="attr">simple:</span></span><br><span class="line">      <span class="attr">cknowledge-mode:</span> <span class="string">manual</span> <span class="comment">#默认情况下消息消费者是自动确认消息的，如果要手动确认消息则需要修改确认模式为manual</span></span><br><span class="line">      <span class="attr">prefetch:</span> <span class="number">1</span> <span class="comment"># 消费者每次从队列获取的消息数量。此属性当不设置时为：轮询分发，设置为1为：公平分发</span></span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-1-3-wxpaycontroller">5.1.3、WxPayController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "微信支付异步通知接口")</span></span><br><span class="line"><span class="meta">@PostMapping("/notify")</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title function_">notify</span><span class="params">(HttpServletRequest request)</span> {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        wxPayService.wxnotify(request);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回成功</span></span><br><span class="line">        Map&lt;String,Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        result.put(<span class="string">"code"</span>, <span class="string">"SUCCESS"</span>);</span><br><span class="line">        result.put(<span class="string">"message"</span>, <span class="string">"成功"</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回失败</span></span><br><span class="line">    Map&lt;String,Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    result.put(<span class="string">"code"</span>, <span class="string">"FAIL"</span>);</span><br><span class="line">    result.put(<span class="string">"message"</span>, <span class="string">"失败"</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-1-4-wxpayservice">5.1.4、WxPayService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">wxnotify</span><span class="params">(HttpServletRequest request)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-1-5-wxpayserviceimpl">5.1.5、WxPayServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RabbitService rabbitService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">wxnotify</span><span class="params">(HttpServletRequest request)</span> {</span><br><span class="line">   <span class="comment">//1.回调通知的验签与解密</span></span><br><span class="line">   <span class="comment">//从request头信息获取参数</span></span><br><span class="line">   <span class="comment">//HTTP 头 Wechatpay-Signature</span></span><br><span class="line">   <span class="comment">// HTTP 头 Wechatpay-Nonce</span></span><br><span class="line">   <span class="comment">//HTTP 头 Wechatpay-Timestamp</span></span><br><span class="line">   <span class="comment">//HTTP 头 Wechatpay-Serial</span></span><br><span class="line">   <span class="comment">//HTTP 头 Wechatpay-Signature-Type</span></span><br><span class="line">   <span class="comment">//HTTP 请求体 body。切记使用原始报文，不要用 JSON 对象序列化后的字符串，避免验签的 body 和原文不一致。</span></span><br><span class="line">   <span class="type">String</span> <span class="variable">wechatPaySerial</span> <span class="operator">=</span> request.getHeader(<span class="string">"Wechatpay-Serial"</span>);</span><br><span class="line">   <span class="type">String</span> <span class="variable">nonce</span> <span class="operator">=</span> request.getHeader(<span class="string">"Wechatpay-Nonce"</span>);</span><br><span class="line">   <span class="type">String</span> <span class="variable">timestamp</span> <span class="operator">=</span> request.getHeader(<span class="string">"Wechatpay-Timestamp"</span>);</span><br><span class="line">   <span class="type">String</span> <span class="variable">signature</span> <span class="operator">=</span> request.getHeader(<span class="string">"Wechatpay-Signature"</span>);</span><br><span class="line">   <span class="type">String</span> <span class="variable">requestBody</span> <span class="operator">=</span> RequestUtils.readData(request);</span><br><span class="line">   log.info(<span class="string">"wechatPaySerial：{}"</span>, wechatPaySerial);</span><br><span class="line">   log.info(<span class="string">"nonce：{}"</span>, nonce);</span><br><span class="line">   log.info(<span class="string">"timestamp：{}"</span>, timestamp);</span><br><span class="line">   log.info(<span class="string">"signature：{}"</span>, signature);</span><br><span class="line">   log.info(<span class="string">"requestBody：{}"</span>, requestBody);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//2.构造 RequestParam</span></span><br><span class="line">   <span class="type">RequestParam</span> <span class="variable">requestParam</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestParam</span>.Builder()</span><br><span class="line">         .serialNumber(wechatPaySerial)</span><br><span class="line">         .nonce(nonce)</span><br><span class="line">         .signature(signature)</span><br><span class="line">         .timestamp(timestamp)</span><br><span class="line">         .body(requestBody)</span><br><span class="line">         .build();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">//3.初始化 NotificationParser</span></span><br><span class="line">   <span class="type">NotificationParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NotificationParser</span>(rsaAutoCertificateConfig);</span><br><span class="line">   <span class="comment">//4.以支付通知回调为例，验签、解密并转换成 Transaction</span></span><br><span class="line">   <span class="type">Transaction</span> <span class="variable">transaction</span> <span class="operator">=</span> parser.parse(requestParam, Transaction.class);</span><br><span class="line">   log.info(<span class="string">"成功解析：{}"</span>, JSON.toJSONString(transaction));</span><br><span class="line">   <span class="keyword">if</span>(<span class="literal">null</span> != transaction &amp;&amp; transaction.getTradeState() == Transaction.TradeStateEnum.SUCCESS) {</span><br><span class="line">      <span class="comment">//5.处理支付业务</span></span><br><span class="line">      <span class="built_in">this</span>.handlePayment(transaction);</span><br><span class="line">   }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handlePayment</span><span class="params">(Transaction transaction)</span> {</span><br><span class="line">   <span class="type">PaymentInfo</span> <span class="variable">paymentInfo</span> <span class="operator">=</span> paymentInfoMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;PaymentInfo&gt;().eq(PaymentInfo::getOrderNo, transaction.getOutTradeNo()));</span><br><span class="line">   <span class="keyword">if</span> (paymentInfo.getPaymentStatus() == <span class="number">1</span>) {</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">//更新支付信息</span></span><br><span class="line">   paymentInfo.setPaymentStatus(<span class="number">1</span>);</span><br><span class="line">   paymentInfo.setOrderNo(transaction.getOutTradeNo());</span><br><span class="line">   paymentInfo.setTransactionId(transaction.getTransactionId());</span><br><span class="line">   paymentInfo.setCallbackTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">   paymentInfo.setCallbackContent(JSON.toJSONString(transaction));</span><br><span class="line">   paymentInfoMapper.updateById(paymentInfo);</span><br><span class="line">   <span class="comment">// 表示交易成功！</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 后续更新订单状态！ 使用消息队列！</span></span><br><span class="line">   rabbitService.sendMessage(MqConst.EXCHANGE_ORDER, MqConst.ROUTING_PAY_SUCCESS, paymentInfo.getOrderNo());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="6-zhi-fu-cha-xun">6、支付查询</span></h3><p>微信支付调用成功与失败 不能够完全依据前端 <strong>success</strong>，<strong>fail</strong> 回调函数来进行判断 , 判断是否支付成功，由后端进行判断。因此在发起支付后，乘客端小程序要轮询查询后端是否支付成功。</p>
<p>微信支付查询订单文档：<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_2.shtml">https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_2.shtml</a></p>
<h4><span id="6-1-zhi-fu-wei-fu-wu-jie-kou">6.1、支付微服务接口</span></h4><h4><span id="6-1-1-wxpaycontroller">6.1.1、WxPayController</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "支付状态查询")</span></span><br><span class="line"><span class="meta">@GetMapping("/queryPayStatus/{orderNo}")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">queryPayStatus</span><span class="params">(<span class="meta">@PathVariable</span> String orderNo)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.ok(wxPayService.queryPayStatus(orderNo));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="6-1-2-wxpayservice">6.1.2、WxPayService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">queryPayStatus</span><span class="params">(String orderNo)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="6-1-3-wxpayserviceimpl">6.1.3、WxPayServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">queryPayStatus</span><span class="params">(String orderNo)</span> {</span><br><span class="line">   <span class="comment">// 构建service</span></span><br><span class="line">   <span class="type">JsapiServiceExtension</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JsapiServiceExtension</span>.Builder().config(rsaAutoCertificateConfig).build();</span><br><span class="line"></span><br><span class="line">   <span class="type">QueryOrderByOutTradeNoRequest</span> <span class="variable">queryRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryOrderByOutTradeNoRequest</span>();</span><br><span class="line">   queryRequest.setMchid(wxPayV3Properties.getMerchantId());</span><br><span class="line">   queryRequest.setOutTradeNo(orderNo);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> {</span><br><span class="line">      <span class="type">Transaction</span> <span class="variable">transaction</span> <span class="operator">=</span> service.queryOrderByOutTradeNo(queryRequest);</span><br><span class="line">      log.info(JSON.toJSONString(transaction));</span><br><span class="line">      <span class="keyword">if</span>(<span class="literal">null</span> != transaction &amp;&amp; transaction.getTradeState() == Transaction.TradeStateEnum.SUCCESS) {</span><br><span class="line">         <span class="comment">//更改订单状态</span></span><br><span class="line">         <span class="built_in">this</span>.handlePayment(transaction);</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      }</span><br><span class="line">   } <span class="keyword">catch</span> (ServiceException e) {</span><br><span class="line">      <span class="comment">// API返回失败, 例如ORDER_NOT_EXISTS</span></span><br><span class="line">      System.out.printf(<span class="string">"code=[%s], message=[%s]\n"</span>, e.getErrorCode(), e.getErrorMessage());</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="6-2-feign-jie-kou">6.2、Feign接口</span></h4><h5><span id="6-2-1-wxpayfeignclient">6.2.1、WxPayFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 支付状态查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderNo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/payment/wxPay/queryPayStatus/{orderNo}")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">queryPayStatus</span><span class="params">(<span class="meta">@PathVariable("orderNo")</span> String orderNo)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="6-3-cheng-ke-duan-web-jie-kou">6.3、乘客端web接口</span></h4><h5><span id="6-3-1-ordercontroller">6.3.1、OrderController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "支付状态查询")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("/queryPayStatus/{orderNo}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">queryPayStatus</span><span class="params">(<span class="meta">@PathVariable</span> String orderNo)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(orderService.queryPayStatus(orderNo));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="6-3-2-orderservice">6.3.2、OrderService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">queryPayStatus</span><span class="params">(String orderNo)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="6-3-3-orderserviceimpl">6.3.3、OrderServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">queryPayStatus</span><span class="params">(String orderNo)</span> {</span><br><span class="line">    <span class="keyword">return</span> wxPayFeignClient.queryPayStatus(orderNo).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="san-zhi-fu-cheng-gong-ye-wu-chu-li">三、支付成功业务处理</span></h2><p>前面支付成功了，微信平台也回调了，只要我们支付记录表记录了支付信息与更改了支付状态，我们就让他快速返回，后面的业务我们通过mq来保证最终的一致。</p>
<p>后续还有哪些业务要处理呢？</p>
<p>1、更改订单状态</p>
<p>2、如果有系统奖励，需要将系统奖励打入司机个人账户</p>
<p>3、执行分账</p>
<p>这三个业务必须都一起执行成功，得保证事务的一致性，因此需要引入seata</p>
<h3><span id="1-zhi-fu-cheng-gong-geng-xin-ding-dan-zhuang-tai">1、支付成功更新订单状态</span></h3><h4><span id="1-1-ding-dan-wei-fu-wu-jie-kou">1.1、订单微服务接口</span></h4><h5><span id="1-1-1-orderinfocontroller">1.1.1、OrderInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "更改订单支付状态")</span></span><br><span class="line"><span class="meta">@GetMapping("/updateOrderPayStatus/{orderNo}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">updateOrderPayStatus</span><span class="params">(<span class="meta">@PathVariable</span> String orderNo)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(orderInfoService.updateOrderPayStatus(orderNo));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-2-orderinfoservice">1.1.2、OrderInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">updateOrderPayStatus</span><span class="params">(String orderNo)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-3-orderinfoserviceimpl">1.1.3、OrderInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">updateOrderPayStatus</span><span class="params">(String orderNo)</span> {</span><br><span class="line">    <span class="comment">//查询订单，判断订单状态，如果已更新支付状态，直接返回</span></span><br><span class="line">    LambdaQueryWrapper&lt;OrderInfo&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(OrderInfo::getOrderNo, orderNo);</span><br><span class="line">    queryWrapper.select(OrderInfo::getId, OrderInfo::getDriverId, OrderInfo::getStatus);</span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoMapper.selectOne(queryWrapper);</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> == orderInfo || orderInfo.getStatus().intValue() == OrderStatus.PAID.getStatus().intValue()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新订单状态</span></span><br><span class="line">    LambdaQueryWrapper&lt;OrderInfo&gt; updateQueryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    updateQueryWrapper.eq(OrderInfo::getOrderNo, orderNo);</span><br><span class="line">    <span class="comment">//更新字段</span></span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">updateOrderInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfo</span>();</span><br><span class="line">    updateOrderInfo.setStatus(OrderStatus.PAID.getStatus());</span><br><span class="line">    updateOrderInfo.setPayTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    <span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> orderInfoMapper.update(updateOrderInfo, queryWrapper);</span><br><span class="line">    <span class="keyword">if</span>(row == <span class="number">1</span>) {</span><br><span class="line">        <span class="comment">//记录日志</span></span><br><span class="line">        <span class="built_in">this</span>.log(orderInfo.getId(), OrderStatus.PAID.getStatus());</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        log.error(<span class="string">"订单支付回调更新订单状态失败，订单号为："</span> + orderNo);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.UPDATE_ERROR);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-feign-jie-kou">1.2、Feign接口</span></h4><h5><span id="1-2-1-orderinfofeignclient">1.2.1、OrderInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更改订单支付状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderNo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/order/info//updateOrderPayStatus/{orderNo}")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">updateOrderPayStatus</span><span class="params">(<span class="meta">@PathVariable("orderNo")</span> String orderNo)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-huo-qu-ding-dan-xi-tong-jiang-li">2、获取订单系统奖励</span></h3><h4><span id="2-1-ding-dan-wei-fu-wu-jie-kou">2.1、订单微服务接口</span></h4><h5><span id="2-1-1-orderinfocontroller">2.1.1、OrderInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "获取订单的系统奖励")</span></span><br><span class="line"><span class="meta">@GetMapping("/getOrderRewardFee/{orderNo}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;OrderRewardVo&gt; <span class="title function_">getOrderRewardFee</span><span class="params">(<span class="meta">@PathVariable</span> String orderNo)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(orderInfoService.getOrderRewardFee(orderNo));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-2-orderinfoservice">2.1.2、OrderInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OrderRewardVo <span class="title function_">getOrderRewardFee</span><span class="params">(String orderNo)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-3-orderinfoserviceimpl">2.1.3、OrderInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> OrderRewardVo <span class="title function_">getOrderRewardFee</span><span class="params">(String orderNo)</span> {</span><br><span class="line">    <span class="comment">//查询订单</span></span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;OrderInfo&gt;().eq(OrderInfo::getOrderNo, orderNo).select(OrderInfo::getId,OrderInfo::getDriverId));</span><br><span class="line">    <span class="comment">//账单</span></span><br><span class="line">    <span class="type">OrderBill</span> <span class="variable">orderBill</span> <span class="operator">=</span> orderBillMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;OrderBill&gt;().eq(OrderBill::getOrderId, orderInfo.getId()).select(OrderBill::getRewardFee));</span><br><span class="line">    <span class="type">OrderRewardVo</span> <span class="variable">orderRewardVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderRewardVo</span>();</span><br><span class="line">    orderRewardVo.setOrderId(orderInfo.getId());</span><br><span class="line">    orderRewardVo.setDriverId(orderInfo.getDriverId());</span><br><span class="line">    orderRewardVo.setRewardFee(orderBill.getRewardFee());</span><br><span class="line">    <span class="keyword">return</span> orderRewardVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-2-feign-jie-kou">2.2、Feign接口</span></h4><h5><span id="2-2-1-orderinfofeignclient">2.2.1、OrderInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取订单的系统奖励</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderNo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/order/info//getOrderRewardFee/{orderNo}")</span></span><br><span class="line">Result&lt;OrderRewardVo&gt; <span class="title function_">getOrderRewardFee</span><span class="params">(<span class="meta">@PathVariable("orderNo")</span> String orderNo)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-xi-tong-jiang-li-da-ru-si-ji-zhang-hu">3、系统奖励打入司机账户</span></h3><p>奖励只是添加到司机的个人账户，司机后续可提现或处理罚款</p>
<h4><span id="3-1-si-ji-wei-fu-wu-jie-kou">3.1、司机微服务接口</span></h4><h5><span id="3-1-1-driveraccountcontroller">3.1.1、DriverAccountController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DriverAccountService driverAccountService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "转账")</span></span><br><span class="line"><span class="meta">@PostMapping("/transfer")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">transfer</span><span class="params">(<span class="meta">@RequestBody</span> TransferForm transferForm)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(driverAccountService.transfer(transferForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-2-driveraccountservice">3.1.2、DriverAccountService</span></h5><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean transfer(TransferForm transferForm);</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-3-driveraccountserviceimpl">3.1.3、DriverAccountServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DriverAccountMapper driverAccountMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DriverAccountDetailMapper driverAccountDetailMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">transfer</span><span class="params">(TransferForm transferForm)</span> {</span><br><span class="line">   <span class="comment">//去重</span></span><br><span class="line">   <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> driverAccountDetailMapper.selectCount(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;DriverAccountDetail&gt;().eq(DriverAccountDetail::getTradeNo, transferForm.getTradeNo()));</span><br><span class="line">   <span class="keyword">if</span>(count &gt; <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//添加账号金额</span></span><br><span class="line">   driverAccountMapper.add(transferForm.getDriverId(), transferForm.getAmount());</span><br><span class="line"></span><br><span class="line">   <span class="comment">//添加账户明细</span></span><br><span class="line">   <span class="type">DriverAccountDetail</span> <span class="variable">driverAccountDetail</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverAccountDetail</span>();</span><br><span class="line">   BeanUtils.copyProperties(transferForm, driverAccountDetail);</span><br><span class="line">   driverAccountDetailMapper.insert(driverAccountDetail);</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-4-driveraccountmapper">3.1.4、DriverAccountMapper</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Integer <span class="title function_">add</span><span class="params">(<span class="meta">@Param("driverId")</span> Long userId, <span class="meta">@Param("amount")</span> BigDecimal amount)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-5-driveraccountmapper-xml">3.1.5、DriverAccountMapper.xml</span></h5><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"add"</span>&gt;</span></span><br><span class="line">   update driver_account</span><br><span class="line">   set total_amount = total_amount + #{amount}, available_amount = available_amount + #{amount}, total_income_amount = total_income_amount + #{amount}</span><br><span class="line">   where driver_id = #{driverId}</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4><span id="3-2-feign-jie-kou">3.2、Feign接口</span></h4><h5><span id="3-2-1-driveraccountfeignclient">3.2.1、DriverAccountFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 转账</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> transferForm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping("/driver/account/transfer")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">transfer</span><span class="params">(<span class="meta">@RequestBody</span> TransferForm transferForm)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-zhi-fu-cheng-gong-ye-wu-chu-li">4、支付成功业务处理</span></h3><h4><span id="4-1-zhi-fu-wei-fu-wu-jie-kou">4.1、支付微服务接口</span></h4><h5><span id="4-1-1-paymentreceiver">4.1.1、PaymentReceiver</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.payment.receiver;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PaymentReceiver</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WxPayService wxPayService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订单支付成功，处理支付回调</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderNo</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">            value = @Queue(value = MqConst.QUEUE_PAY_SUCCESS, durable = "true"),</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(value = MqConst.EXCHANGE_ORDER),</span></span><br><span class="line"><span class="meta">            key = {MqConst.ROUTING_PAY_SUCCESS}</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">paySuccess</span><span class="params">(String orderNo, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">        wxPayService.handleOrder(orderNo);</span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-2-wxpayservice">4.1.2、WxPayService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">handleOrder</span><span class="params">(String orderNo)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-3-wxpayserviceimpl">4.1.3、WxPayServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GlobalTransactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleOrder</span><span class="params">(String orderNo)</span> {</span><br><span class="line">   <span class="comment">//1.更改订单支付状态</span></span><br><span class="line">   orderInfoFeignClient.updateOrderPayStatus(orderNo);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//2.处理系统奖励，打入司机账户</span></span><br><span class="line">   <span class="type">OrderRewardVo</span> <span class="variable">orderRewardVo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderRewardFee(orderNo).getData();</span><br><span class="line">   <span class="keyword">if</span>(<span class="literal">null</span> != orderRewardVo.getRewardFee() &amp;&amp; orderRewardVo.getRewardFee().doubleValue() &gt; <span class="number">0</span>) {</span><br><span class="line">      <span class="type">TransferForm</span> <span class="variable">transferForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransferForm</span>();</span><br><span class="line">      transferForm.setTradeNo(orderNo);</span><br><span class="line">      transferForm.setTradeType(TradeType.REWARD.getType());</span><br><span class="line">      transferForm.setContent(TradeType.REWARD.getContent());</span><br><span class="line">      transferForm.setAmount(orderRewardVo.getRewardFee());</span><br><span class="line">      transferForm.setDriverId(orderRewardVo.getDriverId());</span><br><span class="line">      driverAccountFeignClient.transfer(transferForm);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">//3.TODO分账</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="5-wei-xin-fen-zhang">5、微信分账</span></h3><h4><span id="5-1-wei-xin-fen-zhang-jie-shao">5.1、微信分账介绍</span></h4><h5><span id="5-1-1-kai-tong-fen-zhang-gong-neng">5.1.1、 开通分账功能</span></h5><p>在微信商户平台上面，在产品大全栏目中可以找到微信分账服务，开启这项服务即可。</p>
<p><img src="/2024/09/26/projection-daijia/fz01.jpg" alt="图片描述"></p>
<h5><span id="5-1-2-guan-yu-fen-zhang-bi-li">5.1.2、 关于分账比例</span></h5><p>普通商户的分账比例默认上限是30%，也就是说商户自己留存70%，给员工或者其他人分账最高比例是30%，在普通业务中也还凑合，因为员工拿的提成很少有高于30%的。但是在代驾业务中，代驾司机的劳务费占了订单总额的大头，所以给司机30%的分账比例根本不够。</p>
<p>微信商户平台之所以给商户默认设置这么低的分账上限，主要是为了防止商户逃税或者洗钱。比如公司按照营业利润交税，但是公司老板想要少缴税，这需要通过某些手段减少企业盈利。于是把订单分账比例调高到99%，然后公司客户每笔货款都被分账到了老板指定的微信上面，揣到老板自己腰包里面，而公司的营业利润大幅降低，缴纳的税款也就变少了。微信平台为了避免有些公司通过分账来逃税，所以就给分账比例设置了30%的上线。不过也不是申请更高的分账比例，在设置分账比例上线的页面中，我们可以按照申请流程的指引，申请更高的分账比例。这就需要企业提交更多的证明材料，然后微信平台还要聘请专业的审计公司对审核的单位加以评估。即便你们公司申请下来高比例的分账，但是微信平台会把你们公司的分账记录和税务局的金税系统联网，随时监控你们公司是否伪造交易虚设分账，企图逃税。</p>
<p><img src="/2024/09/26/projection-daijia/fz02.jpg" alt="图片描述"><br>申请高比例分账，走的流程非常复杂，而且还要接受税务局和微信支付系统的严格监督，所以我们就没必要申请高比例分账。大家要清楚这一点就可以了。</p>
<h5><span id="5-1-3-wen-dang-shuo-ming">5.1.3、 文档说明</span></h5><p>微信分账官方文档：<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/api/allocation.php?chapter=26_1">https://pay.weixin.qq.com/wiki/doc/api/allocation.php?chapter=26_1</a></p>
<p>微信分账官方接口文档：<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter8_1_1.shtml">https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter8_1_1.shtml</a></p>
<h4><span id="5-2-feng-zhuang-fen-zhang-xiao-xi-jie-kou">5.2、封装分账消息接口</span></h4><p>用户付款成功后，商户系统至少要2分钟之后才可以申请分账。很多同学第一次做分账，不知道这个细节，导致Web方法刚收到付款成功的通知消息，就立即发起分账，然后就收到订单暂时不可以分账的异常消息。既然我们要等待两分钟以上才可以申请分账，所以我们使用mq延迟消息执行分账。</p>
<h5><span id="5-2-1-profitsharingmqconfig">5.2.1、ProfitsharingMqConfig</span></h5><p>配置MQ延迟队列</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.daijia.payment.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProfitsharingMqConfig</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">profitsharingQueue</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 第一个参数是创建的queue的名字，第二个参数是是否支持持久化</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(MqConst.QUEUE_PROFITSHARING, <span class="literal">true</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CustomExchange <span class="title function_">profitsharingExchange</span><span class="params">()</span> {</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        args.put(<span class="string">"x-delayed-type"</span>, <span class="string">"direct"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomExchange</span>(MqConst.EXCHANGE_PROFITSHARING, <span class="string">"x-delayed-message"</span>, <span class="literal">true</span>, <span class="literal">false</span>, args);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingCancel</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(profitsharingQueue()).to(profitsharingExchange()).with(MqConst.ROUTING_PROFITSHARING).noargs();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-2-2-paymentreceiver">5.2.2、PaymentReceiver</span></h5><p>添加消息监听</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> WxProfitsharingService wxProfitsharingService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 分账消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> param</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = MqConst.QUEUE_PROFITSHARING)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">profitsharingMessage</span><span class="params">(String param, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="type">ProfitsharingForm</span> <span class="variable">profitsharingForm</span> <span class="operator">=</span> JSONObject.parseObject(param, ProfitsharingForm.class);</span><br><span class="line">        log.info(<span class="string">"分账：{}"</span>, param);</span><br><span class="line">        wxProfitsharingService.profitsharing(profitsharingForm);</span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        log.info(<span class="string">"分账调用失败：{}"</span>, e.getMessage());</span><br><span class="line">        <span class="comment">//任务执行失败，就退回队列继续执行，优化：设置退回次数，超过次数记录日志</span></span><br><span class="line">        channel.basicNack(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-2-3-wxprofitsharingservice">5.2.3、WxProfitsharingService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">profitsharing</span><span class="params">(ProfitsharingForm profitsharingForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-2-4-wxprofitsharingserviceimpl">5.2.4、WxProfitsharingServiceImpl</span></h5><p>步骤：</p>
<p>1、添加分账接收方：<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter8_1_8.shtml">https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter8_1_8.shtml</a></p>
<p>2、请求分账：<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter8_1_1.shtml">https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter8_1_1.shtml</a></p>
<p>注：订单必须是分账订单</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> PaymentInfoMapper paymentInfoMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ProfitsharingInfoMapper profitsharingInfoMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> WxPayV3Properties wxPayV3Properties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RSAAutoCertificateConfig rsaAutoCertificateConfig;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RabbitService rabbitService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * https://pay.weixin.qq.com/wiki/doc/api/allocation.php?chapter=26_1</span></span><br><span class="line"><span class="comment"> * 支付文档入口：https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter8_1_1.shtml</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 对接方式：https://github.com/wechatpay-apiv3/wechatpay-java</span></span><br><span class="line"><span class="comment"> * https://github.com/wechatpay-apiv3/wechatpay-java/blob/main/service/src/example/java/com/wechat/pay/java/service/profitsharing/ProfitsharingServiceExample.java</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> profitsharingForm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">profitsharing</span><span class="params">(ProfitsharingForm profitsharingForm)</span> {</span><br><span class="line">    <span class="comment">//分账成功才记录分账消息，查询是否已经分账</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> profitsharingInfoMapper.selectCount(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;ProfitsharingInfo&gt;().eq(ProfitsharingInfo::getOrderNo, profitsharingForm.getOrderNo()));</span><br><span class="line">    <span class="keyword">if</span>(count &gt; <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据订单号获取微信支付信息</span></span><br><span class="line">    <span class="type">PaymentInfo</span> <span class="variable">paymentInfo</span> <span class="operator">=</span> paymentInfoMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;PaymentInfo&gt;().eq(PaymentInfo::getOrderNo, profitsharingForm.getOrderNo()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建分账service</span></span><br><span class="line">    <span class="type">ProfitsharingService</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProfitsharingService</span>.Builder().config(rsaAutoCertificateConfig).build();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加分账接收方</span></span><br><span class="line">    <span class="comment">//API地址：https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter8_1_8.shtml</span></span><br><span class="line">    <span class="comment">//构建分账接收方参数</span></span><br><span class="line">    <span class="type">AddReceiverRequest</span> <span class="variable">addReceiverRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AddReceiverRequest</span>();</span><br><span class="line">    addReceiverRequest.setAppid(wxPayV3Properties.getAppid());</span><br><span class="line">    addReceiverRequest.setType(ReceiverType.PERSONAL_OPENID);</span><br><span class="line">    addReceiverRequest.setAccount(paymentInfo.getDriverOpenId());</span><br><span class="line">    addReceiverRequest.setRelationType(ReceiverRelationType.PARTNER);</span><br><span class="line">    <span class="type">AddReceiverResponse</span> <span class="variable">addReceiverResponse</span> <span class="operator">=</span> service.addReceiver(addReceiverRequest);</span><br><span class="line">    log.info(<span class="string">"添加分账接收方：{}"</span>, JSON.toJSONString(addReceiverResponse));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构建分账参数</span></span><br><span class="line">    <span class="type">CreateOrderRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CreateOrderRequest</span>();</span><br><span class="line">    request.setAppid(wxPayV3Properties.getAppid());</span><br><span class="line">    request.setTransactionId(paymentInfo.getTransactionId());</span><br><span class="line">    <span class="comment">//商户分账单号</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">outOrderNo</span> <span class="operator">=</span> profitsharingForm.getOrderNo() + <span class="string">"_"</span> + <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">10</span>);</span><br><span class="line">    request.setOutOrderNo(outOrderNo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//分账接收方列表</span></span><br><span class="line">    List&lt;CreateOrderReceiver&gt; receivers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="type">CreateOrderReceiver</span> <span class="variable">orderReceiver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CreateOrderReceiver</span>();</span><br><span class="line">    orderReceiver.setType(<span class="string">"PERSONAL_OPENID"</span>);</span><br><span class="line">    orderReceiver.setAccount(paymentInfo.getDriverOpenId());</span><br><span class="line">    <span class="comment">//分账金额从元转换成分</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">amount</span> <span class="operator">=</span> profitsharingForm.getAmount().multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"100"</span>)).longValue();</span><br><span class="line">    orderReceiver.setAmount(amount);</span><br><span class="line">    orderReceiver.setDescription(<span class="string">"司机代驾分账"</span>);</span><br><span class="line">    receivers.add(orderReceiver);</span><br><span class="line">    <span class="comment">//分账接收方列表</span></span><br><span class="line"></span><br><span class="line">    request.setReceivers(receivers);</span><br><span class="line">    request.setUnfreezeUnsplit(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">//执行分账，返回结果</span></span><br><span class="line">    <span class="type">OrdersEntity</span> <span class="variable">ordersEntity</span> <span class="operator">=</span> service.createOrder(request);</span><br><span class="line">    <span class="comment">//分账成功</span></span><br><span class="line">    <span class="keyword">if</span>(ordersEntity.getState().name().equals(<span class="string">"FINISHED"</span>)) {</span><br><span class="line">        <span class="type">ProfitsharingInfo</span> <span class="variable">profitsharingInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProfitsharingInfo</span>();</span><br><span class="line">        profitsharingInfo.setOrderNo(paymentInfo.getOrderNo());</span><br><span class="line">        profitsharingInfo.setTransactionId(paymentInfo.getTransactionId());</span><br><span class="line">        profitsharingInfo.setOutTradeNo(outOrderNo);</span><br><span class="line">        profitsharingInfo.setAmount(profitsharingInfo.getAmount());</span><br><span class="line">        profitsharingInfo.setState(ordersEntity.getState().name());</span><br><span class="line">        profitsharingInfo.setResponeContent(JSON.toJSONString(ordersEntity));</span><br><span class="line">        profitsharingInfoMapper.insert(profitsharingInfo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//分账成功，发送消息</span></span><br><span class="line">        rabbitService.sendMessage(MqConst.EXCHANGE_ORDER, MqConst.ROUTING_PROFITSHARING_SUCCESS, paymentInfo.getOrderNo());</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span>(ordersEntity.getState().name().equals(<span class="string">"PROCESSING"</span>)) {</span><br><span class="line">        <span class="comment">//如果状态是分账中，等待2分钟再执行分账</span></span><br><span class="line">        rabbitService.sendDealyMessage(MqConst.EXCHANGE_PROFITSHARING, MqConst.ROUTING_PROFITSHARING, JSON.toJSONString(profitsharingForm), SystemConstant.PROFITSHARING_DELAY_TIME);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        log.error(<span class="string">"执行分账失败"</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.PROFITSHARING_FAIL);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="5-3-zhi-fu-cheng-gong-ye-wu-xiu-gai">5.3、支付成功业务修改</span></h4><h5><span id="5-3-1-wxpayserviceimpl">5.3.1、WxPayServiceImpl</span></h5><p>前面我们未加分账逻辑，现在补充</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GlobalTransactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleOrder</span><span class="params">(String orderNo)</span> {</span><br><span class="line">   <span class="comment">//更改订单支付状态</span></span><br><span class="line">   orderInfoFeignClient.updateOrderPayStatus(orderNo);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//处理系统奖励，打入司机账户</span></span><br><span class="line">   <span class="type">OrderRewardVo</span> <span class="variable">orderRewardVo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderRewardFee(orderNo).getData();</span><br><span class="line">   <span class="keyword">if</span>(<span class="literal">null</span> != orderRewardVo.getRewardFee() &amp;&amp; orderRewardVo.getRewardFee().doubleValue() &gt; <span class="number">0</span>) {</span><br><span class="line">      <span class="type">TransferForm</span> <span class="variable">transferForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransferForm</span>();</span><br><span class="line">      transferForm.setTradeNo(orderNo);</span><br><span class="line">      transferForm.setTradeType(TradeType.REWARD.getType());</span><br><span class="line">      transferForm.setContent(TradeType.REWARD.getContent());</span><br><span class="line">      transferForm.setAmount(orderRewardVo.getRewardFee());</span><br><span class="line">      transferForm.setDriverId(orderRewardVo.getDriverId());</span><br><span class="line">      driverAccountFeignClient.transfer(transferForm);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   <span class="comment">//分账处理</span></span><br><span class="line">   <span class="type">OrderProfitsharingVo</span> <span class="variable">orderProfitsharingVo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderProfitsharing(orderRewardVo.getOrderId()).getData();</span><br><span class="line">   <span class="comment">//封装分账参数对象</span></span><br><span class="line">   <span class="type">ProfitsharingForm</span> <span class="variable">profitsharingForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProfitsharingForm</span>();</span><br><span class="line">   profitsharingForm.setOrderNo(orderNo);</span><br><span class="line">   profitsharingForm.setAmount(orderProfitsharingVo.getDriverIncome());</span><br><span class="line">   profitsharingForm.setDriverId(orderRewardVo.getDriverId());</span><br><span class="line">   <span class="comment">//分账有延迟，支付成功后最少2分钟执行分账申请</span></span><br><span class="line">   rabbitService.sendDelayMessage(MqConst.EXCHANGE_PROFITSHARING, MqConst.ROUTING_PROFITSHARING, JSON.toJSONString(profitsharingForm), SystemConstant.PROFITSHARING_DELAY_TIME);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="6-geng-xin-ding-dan-fen-zhang-zhuang-tai">6、更新订单分账状态</span></h3><p>微信分账成功后，发送了消息，我们需要在订单微服务模块，监听消息，处理消息</p>
<h4><span id="6-1-ding-dan-wei-fu-wu-jie-kou">6.1、订单微服务接口</span></h4><h5><span id="6-1-1-orderreceiver">6.1.1、OrderReceiver</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 订单分账成功，更新分账状态</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderNo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(value = MqConst.QUEUE_PROFITSHARING_SUCCESS, durable = "true"),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(value = MqConst.EXCHANGE_ORDER),</span></span><br><span class="line"><span class="meta">        key = {MqConst.ROUTING_PROFITSHARING_SUCCESS}</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">profitsharingSuccess</span><span class="params">(String orderNo, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    orderInfoService.updateProfitsharingStatus(orderNo);</span><br><span class="line">    channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="6-1-2-orderinfoservice">6.1.2、OrderInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">updateProfitsharingStatus</span><span class="params">(String orderNo)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="6-1-3-orderinfoserviceimpl">6.1.3、OrderInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateProfitsharingStatus</span><span class="params">(String orderNo)</span> {</span><br><span class="line">   <span class="comment">//查询订单</span></span><br><span class="line">   <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoMapper.selectOne(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;OrderInfo&gt;().eq(OrderInfo::getOrderNo, orderNo).select(OrderInfo::getId));</span><br><span class="line"></span><br><span class="line">   <span class="comment">//更新状态条件</span></span><br><span class="line">   LambdaQueryWrapper&lt;OrderProfitsharing&gt; updateQueryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">   updateQueryWrapper.eq(OrderProfitsharing::getOrderId, orderInfo.getId());</span><br><span class="line">   <span class="comment">//更新字段</span></span><br><span class="line">   <span class="type">OrderProfitsharing</span> <span class="variable">updateOrderProfitsharing</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderProfitsharing</span>();</span><br><span class="line">   updateOrderProfitsharing.setStatus(<span class="number">2</span>);</span><br><span class="line">   orderProfitsharingMapper.update(updateOrderProfitsharing, updateQueryWrapper);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="si-chao-shi-ding-dan-qu-xiao">四、超时订单取消</span></h2><ul>
<li><p>需求：乘客下单后，如果15分钟没有司机接单，代驾订单会自动取消，需要使用延迟消息实现以上的功能</p>
</li>
<li><p><strong>延迟消息</strong>有多种实现方案：</p>
</li>
</ul>
<p>1，基于死信队列</p>
<p>2，使用Redisson实现</p>
<h3><span id="1-ji-yu-si-xin-dui-lie-shi-xian">1、基于死信队列实现</span></h3><p>使用RabbitMQ来实现延迟消息必须先了解RabbitMQ的两个概念：消息的TTL和死信Exchange，通过这两者的组合来实现延迟队列</p>
<h4><span id="1-1-xiao-xi-de-ttl-time-to-live">1.1、消息的TTL（Time To Live）</span></h4><p>消息的TTL就是消息的存活时间。RabbitMQ可以对队列和消息分别设置TTL。对队列设置就是队列没有消费者连着的保留时间，也可以对每一个单独的消息做单独的设置。超过了这个时间，我们认为这个消息就死了，称为死信。</p>
<h4><span id="1-2-si-xin-jiao-huan-ji-dead-letter-exchanges">1.2、死信交换机  Dead Letter Exchanges</span></h4><p>一个消息在满足如下条件下，会进死信路由，记住这里是路由而不是队列，一个路由可以对应很多队列。</p>
<p>（1） 一个消息被Consumer拒收了，并且reject方法的参数里requeue是false。也就是说不会被再次放在队列里，被其他消费者使用。</p>
<p>（2）<strong>上面的消息的TTL到了，消息过期了。</strong></p>
<p>（3）队列的长度限制满了。排在前面的消息会被丢弃或者扔到死信路由上。</p>
<p>Dead Letter Exchange其实就是一种普通的exchange，和创建其他exchange没有两样。只是在某一个设置Dead Letter Exchange的队列中有消息过期了，会自动触发消息的转发，发送到Dead Letter Exchange中去。</p>
<p><img src="/2024/09/26/projection-daijia/wps7-1727286174922882.jpg" alt="img"> </p>
<h3><span id="2-shi-yong-redisson-shi-xian">2、使用Redisson实现</span></h3><p>利用redissonClient 发送延迟消息。</p>
<p>redissonClient.getBlockingDeque(): 创建一个阻塞队列</p>
<p>redissonClient.getDelayedQueue(): 获取延迟队列</p>
<p>delayedQueue.offer(): 向队列中存储数据</p>
<p>blockingDeque.take(): 从队列中获取数据</p>
<h4><span id="fa-song-xiao-xi-shi-xian">发送消息实现</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送延迟消息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sendDelayMessage</span><span class="params">(Long orderId)</span> {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">//  创建一个队列</span></span><br><span class="line">        RBlockingDeque&lt;Object&gt; blockingDeque = redissonClient</span><br><span class="line">            .getBlockingDeque(<span class="string">"queue_cancel"</span>);</span><br><span class="line">        <span class="comment">//  将队列放入延迟队列中</span></span><br><span class="line">        RDelayedQueue&lt;Object&gt; delayedQueue = redissonClient</span><br><span class="line">            .getDelayedQueue(blockingDeque);</span><br><span class="line">        <span class="comment">//  发送的内容</span></span><br><span class="line">        delayedQueue.offer(orderId.toString(),</span><br><span class="line">                           <span class="number">15</span>, TimeUnit.SECONDS);</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="jian-ting-xiao-xi">监听消息</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisDelayHandle</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderInfoService orderInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">listener</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;{</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>){</span><br><span class="line">                <span class="comment">// 获取到阻塞队列</span></span><br><span class="line">                RBlockingDeque&lt;String&gt; blockingDeque = redissonClient</span><br><span class="line">                        .getBlockingDeque(<span class="string">"queue_cancel"</span>);</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="comment">// 从阻塞队列中获取到订单Id</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">orderId</span> <span class="operator">=</span> blockingDeque.take();</span><br><span class="line">                    <span class="comment">// 订单Id 不为空的时候，调用取消订单方法</span></span><br><span class="line">                    <span class="keyword">if</span>(!StringUtils.isEmpty(orderId)) {</span><br><span class="line">                        log.info(<span class="string">"接收延时队列成功，订单id：{}"</span>, orderId);</span><br><span class="line">                        orderInfoService.orderCancel(Long.parseLong(orderId));</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                    log.error(<span class="string">"接收延时队列失败"</span>);</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }).start();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="jie-kou-yu-shi-xian-lei">接口与实现类</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderInfoService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;OrderInfo&gt; {    </span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据订单Id 取消订单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderId</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">orderCancel</span><span class="params">(<span class="type">long</span> orderId)</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">orderCancel</span><span class="params">(<span class="type">long</span> orderId)</span> {</span><br><span class="line">    <span class="type">OrderInfo</span> <span class="variable">orderInfo</span> <span class="operator">=</span> orderInfoMapper.selectById(orderId);</span><br><span class="line">    <span class="keyword">if</span>(orderInfo.getStatus() == OrderStatus.WAITING_ACCEPT.getStatus()) {</span><br><span class="line">        <span class="comment">// 设置更新数据</span></span><br><span class="line">        <span class="type">OrderInfo</span> <span class="variable">orderInfoUpt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderInfo</span>();</span><br><span class="line">        orderInfoUpt.setId(orderId);</span><br><span class="line">        orderInfoUpt.setStatus(OrderStatus.CANCEL_ORDER.getStatus());</span><br><span class="line">        <span class="comment">// 执行更新方法</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">rows</span> <span class="operator">=</span> orderInfoMapper.updateById(orderInfoUpt);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(rows == <span class="number">1</span>) {</span><br><span class="line">            <span class="comment">//删除redis订单标识</span></span><br><span class="line">            redisTemplate.delete(RedisConstant.ORDER_ACCEPT_MARK);</span><br><span class="line">        } </span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h1><span id="xv-you-hui-quan">XV.优惠券</span></h1><h2><span id="yi-you-hui-quan-ling-qu">一、优惠券领取</span></h2><h3><span id="1-you-hui-quan-xu-qiu">1、优惠券需求</span></h3><h4><span id="1-1-you-hui-quan-shuo-ming">1.1、优惠券说明</span></h4><p>优惠券是一种代驾服务的抵扣凭证，可用于打折或者现金优惠代驾服务的特色活动，可以让驾车人享受到更加方便快捷、经济实惠的代驾服务。</p>
<p>优惠券的难点在于如何设计优惠券规则，及并发超售问题，现在我们就着手开发这部分功能。</p>
<p>乘客端有优惠券频道，未使用、未领取及已使用三个菜单，在结束代驾服务后，乘客支付时可以选择一张满足条件的优惠券进行抵扣支付。</p>
<p><img src="/2024/09/26/projection-daijia/coupon.gif" alt="coupon"></p>
<h4><span id="1-2-you-hui-quan-shu-ju-ku-biao">1.2、优惠券数据库表</span></h4><p><strong>优惠券表：</strong></p>
<p>优惠券规则设计表</p>
<p><img src="/2024/09/26/projection-daijia/1700621089531.png" alt="70062108953"></p>
<p>关键字段说明：</p>
<p>​	1、优惠券类型，两种，现金卷与折扣券；现金卷对应金额为：amount字段，折扣卷对应折扣为：discount字段；</p>
<p>​	2、使用门槛，针对现金卷与折扣卷，0：无门槛； 大于0：如果5，即：订单金额大于5元才可以使用；</p>
<p>​	3、发行数量，最多领取的优惠券张数，如果是0，则无限制；</p>
<p>​	4、每人限领张数，即每个人最多领取多少张，不能超领，必须严格控制（并发超卖控制）；</p>
<p>​	5、领取数量，如果发行100，那么最多只能领取100张，必须严格控制（并发超卖控制）</p>
<p>表数据说明：</p>
<p>​	优惠券表已初始化一部分数据，大家也可以根据实际情况配置更多的数据。</p>
<p><strong>优惠券领取记录表：</strong></p>
<p>乘客领取后的记录信息关联表</p>
<p><img src="/2024/09/26/projection-daijia/1698996625664.png" alt="69899662566"></p>
<h3><span id="2-wei-ling-qu-you-hui-quan">2、未领取优惠券</span></h3><p>平台发布了优惠券，乘客还未领取完的优惠券，这里需要注意一点，每人限领张数，有的优惠券只能领取1张，但是有的优惠券可以领取多张，这是该功能点的一个细节，也是考验sql的一个难道，需要大家注意。</p>
<h4><span id="2-1-you-hui-quan-wei-fu-wu-jie-kou">2.1、优惠券微服务接口</span></h4><h5><span id="2-1-1-couponinfocontroller">2.1.1、CouponInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "查询未领取优惠券分页列表")</span></span><br><span class="line"><span class="meta">@GetMapping("findNoReceivePage/{customerId}/{page}/{limit}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;PageVo&lt;NoReceiveCouponVo&gt;&gt; <span class="title function_">findNoReceivePage</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="meta">@Parameter(name = "customerId", description = "乘客id", required = true)</span></span></span><br><span class="line"><span class="params">      <span class="meta">@PathVariable</span> Long customerId,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">      <span class="meta">@Parameter(name = "page", description = "当前页码", required = true)</span></span></span><br><span class="line"><span class="params">      <span class="meta">@PathVariable</span> Long page,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">      <span class="meta">@Parameter(name = "limit", description = "每页记录数", required = true)</span></span></span><br><span class="line"><span class="params">      <span class="meta">@PathVariable</span> Long limit)</span> {</span><br><span class="line">   Page&lt;CouponInfo&gt; pageParam = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(page, limit);</span><br><span class="line">   PageVo&lt;NoReceiveCouponVo&gt; pageVo = couponInfoService.findNoReceivePage(pageParam, customerId);</span><br><span class="line">   pageVo.setPage(page);</span><br><span class="line">   pageVo.setLimit(limit);</span><br><span class="line">   <span class="keyword">return</span> Result.ok(pageVo);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-2-couponinfoservice">2.1.2、CouponInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PageVo&lt;NoReceiveCouponVo&gt; <span class="title function_">findNoReceivePage</span><span class="params">(Page&lt;CouponInfo&gt; pageParam, Long customerId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-3-couponinfoserviceimpl">2.1.3、CouponInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageVo&lt;NoReceiveCouponVo&gt; <span class="title function_">findNoReceivePage</span><span class="params">(Page&lt;CouponInfo&gt; pageParam, Long customerId)</span> {</span><br><span class="line">    IPage&lt;NoReceiveCouponVo&gt; pageInfo = couponInfoMapper.findNoReceivePage(pageParam, customerId);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageVo</span>(pageInfo.getRecords(), pageInfo.getPages(), pageInfo.getTotal());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-4-couponinfomapper">2.1.4、CouponInfoMapper</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IPage&lt;NoReceiveCouponVo&gt; <span class="title function_">findNoReceivePage</span><span class="params">(Page&lt;CouponInfo&gt; pageParam, <span class="meta">@Param("customerId")</span> Long customerId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-5-couponinfomapper-xml">2.1.5、CouponInfoMapper.xml</span></h5><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findNoReceivePage"</span> <span class="attr">resultType</span>=<span class="string">"com.atguigu.daijia.model.vo.coupon.NoReceiveCouponVo"</span>&gt;</span></span><br><span class="line">   select</span><br><span class="line">      info.id,</span><br><span class="line">      info.coupon_type,</span><br><span class="line">      info.name,</span><br><span class="line">      info.amount,</span><br><span class="line">      info.discount,</span><br><span class="line">      info.condition_amount,</span><br><span class="line">      info.publish_count,</span><br><span class="line">      info.per_limit,</span><br><span class="line">      info.expire_time,</span><br><span class="line">      info.description</span><br><span class="line">   from coupon_info info</span><br><span class="line">          left join (</span><br><span class="line">      select coupon_id, customer_id, count(customer_id) cnt  from customer_coupon where customer_id = #{customerId}  group by coupon_id, customer_id</span><br><span class="line">   ) cus_coup on cus_coup.coupon_id = info.id</span><br><span class="line">   where</span><br><span class="line">      info.status = 1</span><br><span class="line">     and info.receive_count <span class="symbol">&amp;lt;</span> info.publish_count</span><br><span class="line">     and (</span><br><span class="line">            info.per_limit =0 or info.per_limit &gt; cus_coup.cnt or cus_coup.cnt is null</span><br><span class="line">      )</span><br><span class="line">   order by info.id desc</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-2-feign-jie-kou">2.2、Feign接口</span></h4><h5><span id="2-2-1-couponinfofeignclient">2.2.1、CouponInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询未领取优惠券分页列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> customerId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> page</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> limit</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/coupon/info/findNoReceivePage/{customerId}/{page}/{limit}")</span></span><br><span class="line">Result&lt;PageVo&lt;NoReceiveCouponVo&gt;&gt; <span class="title function_">findNoReceivePage</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable("customerId")</span> Long customerId,</span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable("page")</span> Long page,</span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable("limit")</span> Long limit)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-3-cheng-ke-duan-web-jie-kou">2.3、乘客端web接口</span></h4><h5><span id="2-3-1-couponcontroller">2.3.1、CouponController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> CouponService couponService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Operation(summary = "查询未领取优惠券分页列表")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("findNoReceivePage/{page}/{limit}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;PageVo&lt;NoReceiveCouponVo&gt;&gt; <span class="title function_">findNoReceivePage</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="meta">@Parameter(name = "page", description = "当前页码", required = true)</span></span></span><br><span class="line"><span class="params">      <span class="meta">@PathVariable</span> Long page,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">      <span class="meta">@Parameter(name = "limit", description = "每页记录数", required = true)</span></span></span><br><span class="line"><span class="params">      <span class="meta">@PathVariable</span> Long limit)</span> {</span><br><span class="line">   <span class="type">Long</span> <span class="variable">customerId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">   PageVo&lt;NoReceiveCouponVo&gt; pageVo = couponService.findNoReceivePage(customerId, page, limit);</span><br><span class="line">   <span class="keyword">return</span> Result.ok(pageVo);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-3-2-couponservice">2.3.2、CouponService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PageVo&lt;NoReceiveCouponVo&gt; <span class="title function_">findNoReceivePage</span><span class="params">(Long customerId, Long page, Long limit)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-3-3-couponserviceimpl">2.3.3、CouponServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageVo&lt;NoReceiveCouponVo&gt; <span class="title function_">findNoReceivePage</span><span class="params">(Long customerId, Long page, Long limit)</span> {</span><br><span class="line">    <span class="keyword">return</span> couponFeignClient.findNoReceivePage(customerId, page, limit).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-wei-shi-yong-you-hui-quan">3、未使用优惠券</span></h3><p>已经领取了，但是还没有使用的优惠券列表。</p>
<h4><span id="3-1-you-hui-quan-wei-fu-wu-jie-kou">3.1、优惠券微服务接口</span></h4><h5><span id="3-1-1-couponinfocontroller">3.1.1、CouponInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "查询未使用优惠券分页列表")</span></span><br><span class="line"><span class="meta">@GetMapping("findNoUsePage/{customerId}/{page}/{limit}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;PageVo&lt;NoUseCouponVo&gt;&gt; <span class="title function_">findNoUsePage</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="meta">@Parameter(name = "customerId", description = "乘客id", required = true)</span></span></span><br><span class="line"><span class="params">      <span class="meta">@PathVariable</span> Long customerId,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">      <span class="meta">@Parameter(name = "page", description = "当前页码", required = true)</span></span></span><br><span class="line"><span class="params">      <span class="meta">@PathVariable</span> Long page,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">      <span class="meta">@Parameter(name = "limit", description = "每页记录数", required = true)</span></span></span><br><span class="line"><span class="params">      <span class="meta">@PathVariable</span> Long limit)</span> {</span><br><span class="line">   Page&lt;CouponInfo&gt; pageParam = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(page, limit);</span><br><span class="line">   PageVo&lt;NoUseCouponVo&gt; pageVo = couponInfoService.findNoUsePage(pageParam, customerId);</span><br><span class="line">   pageVo.setPage(page);</span><br><span class="line">   pageVo.setLimit(limit);</span><br><span class="line">   <span class="keyword">return</span> Result.ok(pageVo);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-2-couponinfoservice">3.1.2、CouponInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PageVo&lt;NoUseCouponVo&gt; <span class="title function_">findNoUsePage</span><span class="params">(Page&lt;CouponInfo&gt; pageParam, Long customerId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-3-couponinfoserviceimpl">3.1.3、CouponInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageVo&lt;NoUseCouponVo&gt; <span class="title function_">findNoUsePage</span><span class="params">(Page&lt;CouponInfo&gt; pageParam, Long customerId)</span> {</span><br><span class="line">    IPage&lt;NoUseCouponVo&gt; pageInfo = couponInfoMapper.findNoUsePage(pageParam, customerId);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageVo</span>(pageInfo.getRecords(), pageInfo.getPages(), pageInfo.getTotal());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-4-couponinfomapper">3.1.4、CouponInfoMapper</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IPage&lt;NoUseCouponVo&gt; <span class="title function_">findNoUsePage</span><span class="params">(Page&lt;CouponInfo&gt; pageParam, <span class="meta">@Param("customerId")</span> Long customerId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-5-couponinfomapper-xml">3.1.5、CouponInfoMapper.xml</span></h5><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findNoUsePage"</span> <span class="attr">resultType</span>=<span class="string">"com.atguigu.daijia.model.vo.coupon.NoUseCouponVo"</span>&gt;</span></span><br><span class="line">   select</span><br><span class="line">      info.id,</span><br><span class="line">      info.coupon_type,</span><br><span class="line">      info.name,</span><br><span class="line">      info.amount,</span><br><span class="line">      info.discount,</span><br><span class="line">      info.condition_amount,</span><br><span class="line">      info.publish_count,</span><br><span class="line">      info.per_limit,</span><br><span class="line">      info.expire_time,</span><br><span class="line">      info.description,</span><br><span class="line"></span><br><span class="line">      cstr.receive_time</span><br><span class="line">   from coupon_info info</span><br><span class="line">          inner join customer_coupon cstr on cstr.coupon_id = info.id</span><br><span class="line">   where</span><br><span class="line">      cstr.customer_id = #{customerId}</span><br><span class="line">     and cstr.status = 1</span><br><span class="line">     and cstr.expire_time &gt; now()</span><br><span class="line">   order by cstr.id desc</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4><span id="3-2-feign-jie-kou">3.2、Feign接口</span></h4><h5><span id="3-2-1-couponinfofeignclient">3.2.1、CouponInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询未使用优惠券分页列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> customerId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> page</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> limit</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/coupon/info/findNoUsePage/{customerId}/{page}/{limit}")</span></span><br><span class="line">Result&lt;PageVo&lt;NoUseCouponVo&gt;&gt; <span class="title function_">findNoUsePage</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable("customerId")</span> Long customerId,</span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable("page")</span> Long page,</span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable("limit")</span> Long limit)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="3-3-cheng-ke-duan-web-jie-kou">3.3、乘客端web接口</span></h4><h5><span id="3-3-1-couponcontroller">3.3.1、CouponController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "查询未使用优惠券分页列表")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("findNoUsePage/{page}/{limit}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;PageVo&lt;NoUseCouponVo&gt;&gt; <span class="title function_">findNoUsePage</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="meta">@Parameter(name = "page", description = "当前页码", required = true)</span></span></span><br><span class="line"><span class="params">      <span class="meta">@PathVariable</span> Long page,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">      <span class="meta">@Parameter(name = "limit", description = "每页记录数", required = true)</span></span></span><br><span class="line"><span class="params">      <span class="meta">@PathVariable</span> Long limit)</span> {</span><br><span class="line">   <span class="type">Long</span> <span class="variable">customerId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">   PageVo&lt;NoUseCouponVo&gt; pageVo = couponService.findNoUsePage(customerId, page, limit);</span><br><span class="line">   <span class="keyword">return</span> Result.ok(pageVo);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-3-2-couponservice">3.3.2、CouponService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PageVo&lt;NoUseCouponVo&gt; <span class="title function_">findNoUsePage</span><span class="params">(Long customerId, Long page, Long limit)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-3-3-couponserviceimpl">3.3.3、CouponServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageVo&lt;NoUseCouponVo&gt; <span class="title function_">findNoUsePage</span><span class="params">(Long customerId, Long page, Long limit)</span> {</span><br><span class="line">    <span class="keyword">return</span> couponFeignClient.findNoUsePage(customerId, page, limit).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-yi-shi-yong-you-hui-quan">4、已使用优惠券</span></h3><p>已经领取了，但是也使用了的优惠券，这个也很好理解。</p>
<h4><span id="4-1-you-hui-quan-wei-fu-wu-jie-kou">4.1、优惠券微服务接口</span></h4><h5><span id="4-1-1-couponinfocontroller">4.1.1、CouponInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "查询已使用优惠券分页列表")</span></span><br><span class="line"><span class="meta">@GetMapping("findUsedPage/{customerId}/{page}/{limit}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;PageVo&lt;UsedCouponVo&gt;&gt; <span class="title function_">findUsedPage</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="meta">@Parameter(name = "customerId", description = "乘客id", required = true)</span></span></span><br><span class="line"><span class="params">      <span class="meta">@PathVariable</span> Long customerId,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">      <span class="meta">@Parameter(name = "page", description = "当前页码", required = true)</span></span></span><br><span class="line"><span class="params">      <span class="meta">@PathVariable</span> Long page,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">      <span class="meta">@Parameter(name = "limit", description = "每页记录数", required = true)</span></span></span><br><span class="line"><span class="params">      <span class="meta">@PathVariable</span> Long limit)</span> {</span><br><span class="line">   Page&lt;CouponInfo&gt; pageParam = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(page, limit);</span><br><span class="line">   PageVo&lt;UsedCouponVo&gt; pageVo = couponInfoService.findUsedPage(pageParam, customerId);</span><br><span class="line">   pageVo.setPage(page);</span><br><span class="line">   pageVo.setLimit(limit);</span><br><span class="line">   <span class="keyword">return</span> Result.ok(pageVo);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-2-couponinfoservice">4.1.2、CouponInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PageVo&lt;UsedCouponVo&gt; <span class="title function_">findUsedPage</span><span class="params">(Page&lt;CouponInfo&gt; pageParam, Long customerId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-3-couponinfoserviceimpl">4.1.3、CouponInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageVo&lt;UsedCouponVo&gt; <span class="title function_">findUsedPage</span><span class="params">(Page&lt;CouponInfo&gt; pageParam, Long customerId)</span> {</span><br><span class="line">    IPage&lt;UsedCouponVo&gt; pageInfo = couponInfoMapper.findUsedPage(pageParam, customerId);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageVo</span>(pageInfo.getRecords(), pageInfo.getPages(), pageInfo.getTotal());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-4-couponinfomapper">4.1.4、CouponInfoMapper</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IPage&lt;UsedCouponVo&gt; <span class="title function_">findUsedPage</span><span class="params">(Page&lt;CouponInfo&gt; pageParam, <span class="meta">@Param("customerId")</span> Long customerId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-1-5-couponinfomapper-xml">4.1.5、CouponInfoMapper.xml</span></h5><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findUsedPage"</span> <span class="attr">resultType</span>=<span class="string">"com.atguigu.daijia.model.vo.coupon.UsedCouponVo"</span>&gt;</span></span><br><span class="line">   select</span><br><span class="line">      info.id,</span><br><span class="line">      info.coupon_type,</span><br><span class="line">      info.name,</span><br><span class="line">      info.amount,</span><br><span class="line">      info.discount,</span><br><span class="line">      info.condition_amount,</span><br><span class="line">      info.publish_count,</span><br><span class="line">      info.per_limit,</span><br><span class="line">      info.expire_time,</span><br><span class="line">      info.description,</span><br><span class="line"></span><br><span class="line">      cstr.id as customerCouponId,</span><br><span class="line">      cstr.used_time</span><br><span class="line">   from coupon_info info</span><br><span class="line">          inner join customer_coupon cstr on cstr.coupon_id = info.id</span><br><span class="line">   where</span><br><span class="line">      cstr.customer_id = #{customerId}</span><br><span class="line">     and cstr.status = 2</span><br><span class="line">   order by cstr.id desc</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-2-feign-jie-kou">4.2、Feign接口</span></h4><h5><span id="4-2-1-couponinfofeignclient">4.2.1、CouponInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询已使用优惠券分页列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> customerId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> page</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> limit</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/coupon/info/findUsedPage/{customerId}/{page}/{limit}")</span></span><br><span class="line">Result&lt;PageVo&lt;UsedCouponVo&gt;&gt; <span class="title function_">findUsedPage</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable("customerId")</span> Long customerId,</span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable("page")</span> Long page,</span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable("limit")</span> Long limit)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-3-cheng-ke-duan-web-jie-kou">4.3、乘客端web接口</span></h4><h5><span id="4-3-1-couponcontroller">4.3.1、CouponController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "查询已使用优惠券分页列表")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("findUsedPage/{page}/{limit}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;PageVo&lt;UsedCouponVo&gt;&gt; <span class="title function_">findUsedPage</span><span class="params">(</span></span><br><span class="line"><span class="params">      <span class="meta">@Parameter(name = "page", description = "当前页码", required = true)</span></span></span><br><span class="line"><span class="params">      <span class="meta">@PathVariable</span> Long page,</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">      <span class="meta">@Parameter(name = "limit", description = "每页记录数", required = true)</span></span></span><br><span class="line"><span class="params">      <span class="meta">@PathVariable</span> Long limit)</span> {</span><br><span class="line">   <span class="type">Long</span> <span class="variable">customerId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">   PageVo&lt;UsedCouponVo&gt; pageVo = couponService.findUsedPage(customerId, page, limit);</span><br><span class="line">   <span class="keyword">return</span> Result.ok(pageVo);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-3-2-couponservice">4.3.2、CouponService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PageVo&lt;UsedCouponVo&gt; <span class="title function_">findUsedPage</span><span class="params">(Long customerId, Long page, Long limit)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="4-3-3-couponserviceimpl">4.3.3、CouponServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> PageVo&lt;UsedCouponVo&gt; <span class="title function_">findUsedPage</span><span class="params">(Long customerId, Long page, Long limit)</span> {</span><br><span class="line">    <span class="keyword">return</span> couponFeignClient.findUsedPage(customerId, page, limit).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="5-ling-qu-you-hui-quan">5、领取优惠券</span></h3><p>领取优惠券涉及并发超卖问题，如果定时推出一个优惠粒度大的优惠券，一旦优惠券推出后，可能吸引很多用户同时领取该优惠券，这样就会出现并发控制问题，下面我们逐步实现这部分功能。</p>
<h4><span id="5-1-you-hui-quan-wei-fu-wu-jie-kou">5.1、优惠券微服务接口</span></h4><h5><span id="5-1-1-couponinfocontroller">5.1.1、CouponInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "领取优惠券")</span></span><br><span class="line"><span class="meta">@GetMapping("/receive/{customerId}/{couponId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">receive</span><span class="params">(<span class="meta">@PathVariable</span> Long customerId, <span class="meta">@PathVariable</span> Long couponId)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(couponInfoService.receive(customerId, couponId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-1-2-couponinfoservice">5.1.2、CouponInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">receive</span><span class="params">(Long customerId, Long couponId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-1-3-couponinfoserviceimpl">5.1.3、CouponInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> <span class="keyword">private</span> CustomerCouponMapper customerCouponMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">receive</span><span class="params">(Long customerId, Long couponId)</span> {</span><br><span class="line">    <span class="comment">//1、查询优惠券</span></span><br><span class="line">    <span class="type">CouponInfo</span> <span class="variable">couponInfo</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(couponId);</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> == couponInfo) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、优惠券过期日期判断</span></span><br><span class="line">    <span class="keyword">if</span> (couponInfo.getExpireTime().before(<span class="keyword">new</span> <span class="title class_">Date</span>())) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.COUPON_EXPIRE);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3、校验库存，优惠券领取数量判断</span></span><br><span class="line">    <span class="keyword">if</span> (couponInfo.getPublishCount() !=<span class="number">0</span> &amp;&amp; couponInfo.getReceiveCount() &gt;= couponInfo.getPublishCount()) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.COUPON_LESS);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4、校验每人限领数量</span></span><br><span class="line">    <span class="keyword">if</span> (couponInfo.getPerLimit() &gt; <span class="number">0</span>) {</span><br><span class="line">        <span class="comment">//4.1、统计当前用户对当前优惠券的已经领取的数量</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> customerCouponMapper.selectCount(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;CustomerCoupon&gt;().eq(CustomerCoupon::getCouponId, couponId).eq(CustomerCoupon::getCustomerId, customerId));</span><br><span class="line">        <span class="comment">//4.2、校验限领数量</span></span><br><span class="line">        <span class="keyword">if</span> (count &gt;= couponInfo.getPerLimit()) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.COUPON_USER_LIMIT);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5、更新优惠券领取数量</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> couponInfoMapper.updateReceiveCount(couponId);</span><br><span class="line">    <span class="keyword">if</span> (row == <span class="number">1</span>) {</span><br><span class="line">        <span class="comment">//6、保存领取记录</span></span><br><span class="line">        <span class="built_in">this</span>.saveCustomerCoupon(customerId, couponId, couponInfo.getExpireTime());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.COUPON_LESS);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">saveCustomerCoupon</span><span class="params">(Long customerId, Long couponId, Date expireTime)</span> {</span><br><span class="line">    <span class="type">CustomerCoupon</span> <span class="variable">customerCoupon</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomerCoupon</span>();</span><br><span class="line">    customerCoupon.setCustomerId(customerId);</span><br><span class="line">    customerCoupon.setCouponId(couponId);</span><br><span class="line">    customerCoupon.setStatus(<span class="number">1</span>);</span><br><span class="line">    customerCoupon.setReceiveTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    customerCoupon.setExpireTime(expireTime);</span><br><span class="line">    customerCouponMapper.insert(customerCoupon);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-1-4-couponinfomapper">5.1.4、CouponInfoMapper</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">updateReceiveCount</span><span class="params">(<span class="meta">@Param("id")</span> Long id)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-1-5-couponinfomapper-xml">5.1.5、CouponInfoMapper.xml</span></h5><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateReceiveCount"</span>&gt;</span></span><br><span class="line">   update coupon_info set receive_count = receive_count + 1 where id = #{id}</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4><span id="5-2-feign-jie-kou">5.2、Feign接口</span></h4><h5><span id="5-2-1-couponinfofeignclient">5.2.1、CouponInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 领取优惠券</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> customerId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> couponId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/coupon/info/receive/{customerId}/{couponId}")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">receive</span><span class="params">(<span class="meta">@PathVariable("customerId")</span> Long customerId, <span class="meta">@PathVariable("couponId")</span> Long couponId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="5-3-cheng-ke-duan-web-jie-kou">5.3、乘客端web接口</span></h4><h5><span id="5-3-1-couponcontroller">5.3.1、CouponController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "领取优惠券")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("/receive/{couponId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">receive</span><span class="params">(<span class="meta">@PathVariable</span> Long couponId)</span> {</span><br><span class="line">   <span class="type">Long</span> <span class="variable">customerId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">   <span class="keyword">return</span> Result.ok(couponService.receive(customerId, couponId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-3-2-couponservice">5.3.2、CouponService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">receive</span><span class="params">(Long customerId, Long couponId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="5-3-3-couponserviceimpl">5.3.3、CouponServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">receive</span><span class="params">(Long customerId, Long couponId)</span> {</span><br><span class="line">    <span class="keyword">return</span> couponFeignClient.receive(customerId, couponId).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="6-bing-fa-wen-ti-jie-jue">6、并发问题解决</span></h3><h4><span id="6-1-bing-fa-ce-shi">6.1、并发测试</span></h4><p>通过乘客端小程序领取，我们没有发现什么问题。</p>
<p>要知道领券的过程中有大量的校验，这些校验逻辑在高并发的场景下很容易出现问题。因此，我们必须对领券功能做并发测试，看看是否会出现并发安全问题。</p>
<p>并发测试，比较常见的一种工具就是 Jemeter 了，我们在资料中以提供，直接使用：</p>
<p><img src="/2024/09/26/projection-daijia/1700632256702.png" alt="70063225670"></p>
<p>同时，我们也提供了一个《领取优惠券测试计划.jmx》文件，里面配置了一份测试脚本，将其导入 Jemeter 中，直接使用即可。</p>
<p><img src="/2024/09/26/projection-daijia/1700632354704.png" alt="70063235470"></p>
<p>为了模拟并发领取，需要指定 多个乘客用户，我们把乘客用户id放到了《customerId.txt》文件中，模拟测试。</p>
<p><img src="/2024/09/26/projection-daijia/1700632681918.png" alt="70063268191"></p>
<p>Jemeter 模拟乘客用户id，是通过http的header头传递到服务器端的，因此，我们需要调整一下controller接口，只用于测试使用。</p>
<p><img src="/2024/09/26/projection-daijia/1700632885767.png" alt="70063288576"></p>
<p><strong>CouponInfoController</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "领取优惠券")</span></span><br><span class="line"><span class="meta">@GetMapping("/receive/{couponId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">receive1</span><span class="params">(<span class="meta">@RequestHeader("customerId")</span> Long customerId, <span class="meta">@PathVariable</span> Long couponId)</span> {</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> Result.ok(couponInfoService.receive(customerId, couponId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>启动service-coupon微服务</p>
<p>执行Jemeter ：</p>
<p><img src="/2024/09/26/projection-daijia/1700633002541.png" alt="70063300254"></p>
<p>查看数据表数据：</p>
<p><img src="/2024/09/26/projection-daijia/1700633075958.png" alt="70063307595"></p>
<p>领取数量：108，超领了！！！</p>
<h4><span id="6-2-fen-xi-yuan-yin">6.2、分析原因</span></h4><p>并发问题出现的点：</p>
<p>​	第一：每人限领数量，同一张优惠券每人限领的数量不能超</p>
<p>​	第二：发现数量，总的领取的数量不能大于发行数量</p>
<p>下面我们就来分析一下</p>
<h5><span id="6-2-1-xian-ling-shu-liang-mei-xian-zhi-fa-xing-shu-liang-mei-xian-zhi">6.2.1、限领数量没限制、发行数量没限制</span></h5><p>无并发问题</p>
<h5><span id="6-2-2-xian-ling-shu-liang-mei-xian-zhi-fa-xing-shu-liang-you-xian-zhi">6.2.2、限领数量没限制、发行数量有限制</span></h5><p>存在并发问题</p>
<p><strong>问题分析：</strong></p>
<p><img src="/2024/09/26/projection-daijia/1700633980421.png" alt="70063398042"></p>
<p>多线程并行运行，上面的判断与更新领取数据不具有原子性，因此会超领。</p>
<p><strong>解决方案：</strong></p>
<p>针对并发安全问题，最广为人知的解决方案就是<strong>加锁</strong>。不过，加锁的方式多种多样，大家熟悉的 Synchronized、ReentrantLock 只是其中最基础的锁。</p>
<p>今天先不讨论具体的锁的实现方式，而是讲讲加锁的思想。从实现思想上来说，锁可以分为两大类：</p>
<ul>
<li>悲观锁</li>
<li>乐观锁</li>
</ul>
<p>何为悲观锁？</p>
<blockquote>
<p>悲观锁是一种独占和排他的锁机制，保守地认为数据会被其他事务修改，所以在整个数据处理过程中将数据处于锁定状态。</p>
</blockquote>
<p>何为乐观锁？</p>
<blockquote>
<p>乐观锁是一种较为乐观的并发控制方法，假设多用户并发的不会产生安全问题，因此无需独占和锁定资源。但在更新数据前，会先检查是否有其他线程修改了该数据，如果有，则认为可能有风险，会放弃修改操作</p>
</blockquote>
<p>可见，悲观锁、乐观锁是对并发安全问题的处理态度不同：</p>
<ul>
<li>悲观锁认为安全问题一定会发生，所以直接独占资源。结果就是多个线程会串行执行被保护的代码。<ul>
<li>优点：安全性非常高</li>
<li>缺点：性能较差</li>
</ul>
</li>
<li>乐观锁则认为安全问题不一定发生，所以不独占资源。结果就是允许多线程并行执行。但如果真的发生并发修改怎么办？乐观锁采用 CAS（Compare And Set）思想，在更新数据前先判断数据与我之前查询到的是否一致，不一致则证明有其它线程也在更新。为了避免出现安全问题，放弃本次更新或者重新尝试一次。<ul>
<li>优点：性能好、安全性也好</li>
<li>缺点：并发较高时，可能出现更新成功率较低的问题（并行的 N 个线程只会有 1 个成功）</li>
</ul>
</li>
</ul>
<p>针对上面的介绍，我们发现当前这种场景使用<strong>乐观锁</strong>即可解决问题。</p>
<p>更新领取数量，原sql：</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> coupon_info <span class="keyword">set</span> receive_count <span class="operator">=</span> receive_count <span class="operator">+</span> <span class="number">1</span> <span class="keyword">where</span> id <span class="operator">=</span> #{id}</span><br></pre></td></tr></tbody></table></figure>

<p>修改后的sql：</p>
<figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> coupon_info <span class="keyword">set</span> receive_count <span class="operator">=</span> receive_count <span class="operator">+</span> <span class="number">1</span> <span class="keyword">where</span> id <span class="operator">=</span> #{id} <span class="keyword">and</span> receive_count <span class="operator">&lt;</span> publish_count</span><br></pre></td></tr></tbody></table></figure>

<p>如果更新失败了，返回row=0，则说明优惠券领取完了</p>
<p>恢复数据库数据，再次执行Jemeter ，结果领取数据为100，未超领。</p>
<h5><span id="6-2-3-xian-ling-shu-liang-you-xian-zhi-fa-xing-shu-liang-mei-xian-zhi">6.2.3、限领数量有限制、发行数量没限制</span></h5><p>存在并发问题</p>
<p><strong>问题分析：</strong></p>
<p><img src="/2024/09/26/projection-daijia/1700635319735.png" alt="70063531973"></p>
<p>还是一样的问题，先统计判断，再插入，不具有原子性，这个问题怎么解决？</p>
<p><strong>解决方案：</strong></p>
<p>是不是跟上一个场景一样，使用乐观锁解决？</p>
<p>显然不行，因为乐观锁常用在更新上面，因此新增时无法基于乐观锁做判断。</p>
<p>所以，这里只能采用悲观锁方案，也就是大家熟悉的 Synchronized 或者 Lock，但是 Synchronized 或者 Lock它们是本地锁，我们是微服务项目，因此要使用分布式锁。我们直接使用Redisson加锁。</p>
<p><strong>锁的粒度呢？当然是粒度越小并发越大，因此我们只需要针对乘客id加锁即可。</strong></p>
<h5><span id="6-2-4-xian-ling-shu-liang-you-xian-zhi-fa-xing-shu-liang-you-xian-zhi">6.2.4、限领数量有限制、发行数量有限制</span></h5><p>存在并发问题</p>
<p>上面已经分析过了</p>
<p><strong>解决方案：</strong></p>
<p>乐观锁 + 分布式锁（悲观锁）</p>
<h4><span id="6-3-dai-ma-you-hua">6.3、代码优化</span></h4><h5><span id="6-3-1-couponinfomapper">6.3.1、CouponInfoMapper</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">updateReceiveCountByLimit</span><span class="params">(<span class="meta">@Param("id")</span> Long id)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="6-3-2-couponinfomapper-xml">6.3.2、CouponInfoMapper.xml</span></h5><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateReceiveCountByLimit"</span>&gt;</span></span><br><span class="line">   update coupon_info set receive_count = receive_count + 1 where id = #{id} and receive_count <span class="symbol">&amp;lt;</span> publish_count</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h5><span id="6-3-3-couponinfoserviceimpl">6.3.3、CouponInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">receive</span><span class="params">(Long customerId, Long couponId)</span> {</span><br><span class="line">    <span class="comment">//1、查询优惠券</span></span><br><span class="line">    <span class="type">CouponInfo</span> <span class="variable">couponInfo</span> <span class="operator">=</span> <span class="built_in">this</span>.getById(couponId);</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> == couponInfo) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、优惠券过期日期判断</span></span><br><span class="line">    <span class="keyword">if</span> (couponInfo.getExpireTime().before(<span class="keyword">new</span> <span class="title class_">Date</span>())) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.COUPON_EXPIRE);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3、校验库存，优惠券领取数量判断</span></span><br><span class="line">    <span class="keyword">if</span> (couponInfo.getPublishCount() !=<span class="number">0</span> &amp;&amp; couponInfo.getReceiveCount() &gt;= couponInfo.getPublishCount()) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.COUPON_LESS);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 初始化分布式锁</span></span><br><span class="line">        <span class="comment">//每人领取限制  与 优惠券发行总数 必须保证原子性，使用customerId减少锁的粒度，增加并发能力</span></span><br><span class="line">        lock = redissonClient.getLock(RedisConstant.COUPON_LOCK + customerId);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> lock.tryLock(RedisConstant.COUPON_LOCK_WAIT_TIME, RedisConstant.COUPON_LOCK_LEASE_TIME, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">if</span> (flag) {</span><br><span class="line">            <span class="comment">//4、校验每人限领数量</span></span><br><span class="line">            <span class="keyword">if</span> (couponInfo.getPerLimit() &gt; <span class="number">0</span>) {</span><br><span class="line">                <span class="comment">//4.1、统计当前用户对当前优惠券的已经领取的数量</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> customerCouponMapper.selectCount(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;CustomerCoupon&gt;().eq(CustomerCoupon::getCouponId, couponId).eq(CustomerCoupon::getCustomerId, customerId));</span><br><span class="line">                <span class="comment">//4.2、校验限领数量</span></span><br><span class="line">                <span class="keyword">if</span> (count &gt;= couponInfo.getPerLimit()) {</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.COUPON_USER_LIMIT);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">//5、更新优惠券领取数量</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (couponInfo.getPublishCount() == <span class="number">0</span>) {<span class="comment">//没有限制</span></span><br><span class="line">                row = couponInfoMapper.updateReceiveCount(couponId);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                row = couponInfoMapper.updateReceiveCountByLimit(couponId);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (row == <span class="number">1</span>) {</span><br><span class="line">                <span class="comment">//6、保存领取记录</span></span><br><span class="line">                <span class="built_in">this</span>.saveCustomerCoupon(customerId, couponId, couponInfo.getExpireTime());</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != lock) {</span><br><span class="line">            lock.unlock();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.COUPON_LESS);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="er-you-hui-quan-shi-yong">二、优惠券使用</span></h2><p>优惠券使用如图：</p>
<p><img src="/2024/09/26/projection-daijia/coupon_use.gif" alt="use"></p>
<h3><span id="1-huo-qu-wei-shi-yong-de-zui-jia-you-hui-quan-xin-xi">1、获取未使用的最佳优惠券信息</span></h3><p>乘客支付时，可根据订单金额，搜索满足条件的已领取未使用的优惠券列表，默认选中优惠最大金额优惠券，作为支付时抵扣的金额，只能选择一张，用户也可切换其他优惠券（不做限制）</p>
<p>说明：一个订单未支付前只能选择一次，第一次选中后放弃支付，下一次支付默认使用第一次选中的优惠券。</p>
<h4><span id="1-1-you-hui-quan-wei-fu-wu-jie-kou">1.1、优惠券微服务接口</span></h4><h5><span id="1-1-1-couponinfocontroller">1.1.1、CouponInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "获取未使用的最佳优惠券信息")</span></span><br><span class="line"><span class="meta">@GetMapping("/findAvailableCoupon/{customerId}/{orderAmount}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;List&lt;AvailableCouponVo&gt;&gt; <span class="title function_">findAvailableCoupon</span><span class="params">(<span class="meta">@PathVariable</span> Long customerId, <span class="meta">@PathVariable</span> BigDecimal orderAmount)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(couponInfoService.findAvailableCoupon(customerId, orderAmount));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-2-couponinfoservice">1.1.2、CouponInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;AvailableCouponVo&gt; <span class="title function_">findAvailableCoupon</span><span class="params">(Long customerId, BigDecimal orderAmount)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-3-couponinfoserviceimpl">1.1.3、CouponInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;AvailableCouponVo&gt; <span class="title function_">findAvailableCoupon</span><span class="params">(Long customerId, BigDecimal orderAmount)</span> {</span><br><span class="line">    <span class="comment">//1.定义符合条件的优惠券信息容器</span></span><br><span class="line">    List&lt;AvailableCouponVo&gt; availableCouponVoList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.获取未使用的优惠券列表</span></span><br><span class="line">    List&lt;NoUseCouponVo&gt; list = couponInfoMapper.findNoUseList(customerId);</span><br><span class="line">    <span class="comment">//2.1.现金券</span></span><br><span class="line">    List&lt;NoUseCouponVo&gt; type1List = list.stream().filter(item -&gt; item.getCouponType().intValue() == <span class="number">1</span>).collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">for</span> (NoUseCouponVo noUseCouponVo : type1List) {</span><br><span class="line">        <span class="comment">//使用门槛判断</span></span><br><span class="line">        <span class="comment">//2.1.1.没门槛，订单金额必须大于优惠券减免金额</span></span><br><span class="line">        <span class="comment">//减免金额</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">reduceAmount</span> <span class="operator">=</span> noUseCouponVo.getAmount();</span><br><span class="line">        <span class="keyword">if</span> (noUseCouponVo.getConditionAmount().doubleValue() == <span class="number">0</span> &amp;&amp; orderAmount.subtract(reduceAmount).doubleValue() &gt; <span class="number">0</span>) {</span><br><span class="line">            availableCouponVoList.add(<span class="built_in">this</span>.buildBestNoUseCouponVo(noUseCouponVo, reduceAmount));</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//2.1.2.有门槛，订单金额大于优惠券门槛金额</span></span><br><span class="line">        <span class="keyword">if</span> (noUseCouponVo.getConditionAmount().doubleValue() &gt; <span class="number">0</span> &amp;&amp; orderAmount.subtract(noUseCouponVo.getConditionAmount()).doubleValue() &gt; <span class="number">0</span>) {</span><br><span class="line">            availableCouponVoList.add(<span class="built_in">this</span>.buildBestNoUseCouponVo(noUseCouponVo, reduceAmount));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.2.折扣券</span></span><br><span class="line">    List&lt;NoUseCouponVo&gt; type2List = list.stream().filter(item -&gt; item.getCouponType().intValue() == <span class="number">2</span>).collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">for</span> (NoUseCouponVo noUseCouponVo : type2List) {</span><br><span class="line">        <span class="comment">//使用门槛判断</span></span><br><span class="line">        <span class="comment">//订单折扣后金额</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">discountOrderAmount</span> <span class="operator">=</span> orderAmount.multiply(noUseCouponVo.getDiscount()).divide(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"10"</span>)).setScale(<span class="number">2</span>, RoundingMode.HALF_UP);</span><br><span class="line">        <span class="comment">//减免金额</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">reduceAmount</span> <span class="operator">=</span> orderAmount.subtract(discountOrderAmount);</span><br><span class="line">        <span class="comment">//订单优惠金额</span></span><br><span class="line">        <span class="comment">//2.2.1.没门槛</span></span><br><span class="line">        <span class="keyword">if</span> (noUseCouponVo.getConditionAmount().doubleValue() == <span class="number">0</span>) {</span><br><span class="line">            availableCouponVoList.add(<span class="built_in">this</span>.buildBestNoUseCouponVo(noUseCouponVo, reduceAmount));</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//2.2.2.有门槛，订单折扣后金额大于优惠券门槛金额</span></span><br><span class="line">        <span class="keyword">if</span> (noUseCouponVo.getConditionAmount().doubleValue() &gt; <span class="number">0</span> &amp;&amp; discountOrderAmount.subtract(noUseCouponVo.getConditionAmount()).doubleValue() &gt; <span class="number">0</span>) {</span><br><span class="line">            availableCouponVoList.add(<span class="built_in">this</span>.buildBestNoUseCouponVo(noUseCouponVo, reduceAmount));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//排序</span></span><br><span class="line">    <span class="keyword">if</span> (!CollectionUtils.isEmpty(availableCouponVoList)) {</span><br><span class="line">        Collections.sort(availableCouponVoList, <span class="keyword">new</span> <span class="title class_">Comparator</span>&lt;AvailableCouponVo&gt;() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(AvailableCouponVo o1, AvailableCouponVo o2)</span> {</span><br><span class="line">                <span class="keyword">return</span> o1.getReduceAmount().compareTo(o2.getReduceAmount());</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> availableCouponVoList;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> AvailableCouponVo <span class="title function_">buildBestNoUseCouponVo</span><span class="params">(NoUseCouponVo noUseCouponVo, BigDecimal reduceAmount)</span> {</span><br><span class="line">    <span class="type">AvailableCouponVo</span> <span class="variable">bestNoUseCouponVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AvailableCouponVo</span>();</span><br><span class="line">    BeanUtils.copyProperties(noUseCouponVo, bestNoUseCouponVo);</span><br><span class="line">    bestNoUseCouponVo.setCouponId(noUseCouponVo.getId());</span><br><span class="line">    bestNoUseCouponVo.setReduceAmount(reduceAmount);</span><br><span class="line">    <span class="keyword">return</span> bestNoUseCouponVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-4-couponinfomapper">1.1.4、CouponInfoMapper</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;NoUseCouponVo&gt; <span class="title function_">findNoUseList</span><span class="params">(<span class="meta">@Param("customerId")</span> Long customerId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-1-5-couponinfomapper-xml">1.1.5、CouponInfoMapper.xml</span></h5><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findNoUseList"</span> <span class="attr">resultType</span>=<span class="string">"com.atguigu.daijia.model.vo.coupon.NoUseCouponVo"</span>&gt;</span></span><br><span class="line">   select</span><br><span class="line">      info.id,</span><br><span class="line">      info.coupon_type,</span><br><span class="line">      info.name,</span><br><span class="line">      info.amount,</span><br><span class="line">      info.discount,</span><br><span class="line">      info.condition_amount,</span><br><span class="line">      info.publish_count,</span><br><span class="line">      info.per_limit,</span><br><span class="line">      info.expire_time,</span><br><span class="line">      info.description,</span><br><span class="line"></span><br><span class="line">      cstr.id as customerCouponId,</span><br><span class="line">      cstr.receive_time</span><br><span class="line">   from coupon_info info</span><br><span class="line">          inner join customer_coupon cstr on cstr.coupon_id = info.id</span><br><span class="line">   where</span><br><span class="line">      cstr.customer_id = #{customerId}</span><br><span class="line">     and cstr.status = 1</span><br><span class="line">     and cstr.expire_time &gt; now()</span><br><span class="line">   order by cstr.id desc</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-2-feign-jie-kou">1.2、Feign接口</span></h4><h5><span id="1-2-1-couponinfofeignclient">1.2.1、CouponInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取未使用的最佳优惠券信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> customerId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderAmount</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/coupon/info/findAvailableCoupon/{customerId}/{orderAmount}")</span></span><br><span class="line">Result&lt;List&lt;AvailableCouponVo&gt;&gt; <span class="title function_">findAvailableCoupon</span><span class="params">(<span class="meta">@PathVariable("customerId")</span> Long customerId, <span class="meta">@PathVariable("orderAmount")</span> BigDecimal orderAmount)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="1-3-cheng-ke-duan-web-jie-kou">1.3、乘客端web接口</span></h4><h5><span id="1-3-1-couponcontroller">1.3.1、CouponController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "获取未使用的最佳优惠券信息")</span></span><br><span class="line"><span class="meta">@GuiguLogin</span></span><br><span class="line"><span class="meta">@GetMapping("/findAvailableCoupon/{orderId}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;List&lt;AvailableCouponVo&gt;&gt; <span class="title function_">findAvailableCoupon</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId)</span> {</span><br><span class="line">   <span class="type">Long</span> <span class="variable">customerId</span> <span class="operator">=</span> AuthContextHolder.getUserId();</span><br><span class="line">   <span class="keyword">return</span> Result.ok(couponService.findAvailableCoupon(customerId, orderId));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-3-2-couponservice">1.3.2、CouponService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;AvailableCouponVo&gt; <span class="title function_">findAvailableCoupon</span><span class="params">(Long customerId, Long orderId)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="1-3-3-couponserviceimpl">1.3.3、CouponServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> OrderInfoFeignClient orderInfoFeignClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;AvailableCouponVo&gt; <span class="title function_">findAvailableCoupon</span><span class="params">(Long customerId, Long orderId)</span> {</span><br><span class="line">   <span class="type">OrderBillVo</span> <span class="variable">orderBillVo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderBillInfo(orderId).getData();</span><br><span class="line">   <span class="keyword">return</span> couponFeignClient.findAvailableCoupon(customerId, orderBillVo.getPayAmount()).getData();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-shi-yong-you-hui-quan">2、使用优惠券</span></h3><p>在支付使用优惠券前，我们先要完成2个接口，一个使用优惠券接口，一个更新订单优惠券金额接口</p>
<h4><span id="2-1-you-hui-quan-wei-fu-wu-jie-kou">2.1、优惠券微服务接口</span></h4><h5><span id="2-1-1-couponinfocontroller">2.1.1、CouponInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "使用优惠券")</span></span><br><span class="line"><span class="meta">@PostMapping("/useCoupon")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;BigDecimal&gt; <span class="title function_">useCoupon</span><span class="params">(<span class="meta">@RequestBody</span> UseCouponForm useCouponForm)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(couponInfoService.useCoupon(useCouponForm));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-2-couponinfoservice">2.1.2、CouponInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BigDecimal <span class="title function_">useCoupon</span><span class="params">(UseCouponForm useCouponForm)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-3-couponinfoserviceimpl">2.1.3、CouponInfoServiceImpl</span></h5><p>使用优惠券，同样要判断优惠券使用规则。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(noRollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> BigDecimal <span class="title function_">useCoupon</span><span class="params">(UseCouponForm useCouponForm)</span> {</span><br><span class="line">    <span class="comment">//获取乘客优惠券</span></span><br><span class="line">    <span class="type">CustomerCoupon</span> <span class="variable">customerCoupon</span> <span class="operator">=</span> customerCouponMapper.selectById(useCouponForm.getCustomerCouponId());</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> == customerCoupon) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.ARGUMENT_VALID_ERROR);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//获取优惠券信息</span></span><br><span class="line">    <span class="type">CouponInfo</span> <span class="variable">couponInfo</span> <span class="operator">=</span> couponInfoMapper.selectById(customerCoupon.getCouponId());</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">null</span> == couponInfo) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.ARGUMENT_VALID_ERROR);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//判断该优惠券是否为乘客所有</span></span><br><span class="line">    <span class="keyword">if</span>(customerCoupon.getCustomerId().longValue() != useCouponForm.getCustomerId().longValue()) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.ILLEGAL_REQUEST);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//获取优惠券减免金额</span></span><br><span class="line">    <span class="type">BigDecimal</span> <span class="variable">reduceAmount</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(couponInfo.getCouponType().intValue() == <span class="number">1</span>) {</span><br><span class="line">        <span class="comment">//使用门槛判断</span></span><br><span class="line">        <span class="comment">//2.1.1.没门槛，订单金额必须大于优惠券减免金额</span></span><br><span class="line">        <span class="keyword">if</span> (couponInfo.getConditionAmount().doubleValue() == <span class="number">0</span> &amp;&amp; useCouponForm.getOrderAmount().subtract(couponInfo.getAmount()).doubleValue() &gt; <span class="number">0</span>) {</span><br><span class="line">            <span class="comment">//减免金额</span></span><br><span class="line">            reduceAmount = couponInfo.getAmount();</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//2.1.2.有门槛，订单金额大于优惠券门槛金额</span></span><br><span class="line">        <span class="keyword">if</span> (couponInfo.getConditionAmount().doubleValue() &gt; <span class="number">0</span> &amp;&amp; useCouponForm.getOrderAmount().subtract(couponInfo.getConditionAmount()).doubleValue() &gt; <span class="number">0</span>) {</span><br><span class="line">            <span class="comment">//减免金额</span></span><br><span class="line">            reduceAmount = couponInfo.getAmount();</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">//使用门槛判断</span></span><br><span class="line">        <span class="comment">//订单折扣后金额</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">discountOrderAmount</span> <span class="operator">=</span> useCouponForm.getOrderAmount().multiply(couponInfo.getDiscount()).divide(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"10"</span>)).setScale(<span class="number">2</span>, RoundingMode.HALF_UP);</span><br><span class="line">        <span class="comment">//订单优惠金额</span></span><br><span class="line">        <span class="comment">//2.2.1.没门槛</span></span><br><span class="line">        <span class="keyword">if</span> (couponInfo.getConditionAmount().doubleValue() == <span class="number">0</span>) {</span><br><span class="line">            <span class="comment">//减免金额</span></span><br><span class="line">            reduceAmount = useCouponForm.getOrderAmount().subtract(discountOrderAmount);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//2.2.2.有门槛，订单折扣后金额大于优惠券门槛金额</span></span><br><span class="line">        <span class="keyword">if</span> (couponInfo.getConditionAmount().doubleValue() &gt; <span class="number">0</span> &amp;&amp; discountOrderAmount.subtract(couponInfo.getConditionAmount()).doubleValue() &gt; <span class="number">0</span>) {</span><br><span class="line">            <span class="comment">//减免金额</span></span><br><span class="line">            reduceAmount = useCouponForm.getOrderAmount().subtract(discountOrderAmount);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span>(reduceAmount.doubleValue() &gt; <span class="number">0</span>) {</span><br><span class="line">        <span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> couponInfoMapper.updateUseCount(couponInfo.getId());</span><br><span class="line">        <span class="keyword">if</span>(row == <span class="number">1</span>) {</span><br><span class="line">            <span class="type">CustomerCoupon</span> <span class="variable">updateCustomerCoupon</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CustomerCoupon</span>();</span><br><span class="line">            updateCustomerCoupon.setId(customerCoupon.getId());</span><br><span class="line">            updateCustomerCoupon.setUsedTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">            updateCustomerCoupon.setOrderId(useCouponForm.getOrderId());</span><br><span class="line">            customerCouponMapper.updateById(updateCustomerCoupon);</span><br><span class="line">            <span class="keyword">return</span> reduceAmount;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-4-couponinfomapper">2.1.4、CouponInfoMapper</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">updateUseCount</span><span class="params">(<span class="meta">@Param("id")</span> Long id)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="2-1-5-couponinfomapper-xml">2.1.5、CouponInfoMapper.xml</span></h5><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateUseCount"</span>&gt;</span></span><br><span class="line">   update coupon_info set use_count = use_count + 1 where id = #{id}</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4><span id="2-2-feign-jie-kou">2.2、Feign接口</span></h4><h5><span id="2-2-1-couponinfofeignclient">2.2.1、CouponInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用优惠券</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> useCouponForm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping("/coupon/info/useCoupon")</span></span><br><span class="line">Result&lt;BigDecimal&gt; <span class="title function_">useCoupon</span><span class="params">(<span class="meta">@RequestBody</span> UseCouponForm useCouponForm)</span>;</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-geng-xin-ding-dan-you-hui-quan-jin-e">3、更新订单优惠券金额</span></h3><h4><span id="3-1-ding-dan-wei-fu-wu-jie-kou">3.1、订单微服务接口</span></h4><h5><span id="3-1-1-orderinfocontroller">3.1.1、OrderInfoController</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Operation(summary = "更新订单优惠券金额")</span></span><br><span class="line"><span class="meta">@GetMapping("/updateCouponAmount/{orderId}/{couponAmount}")</span></span><br><span class="line"><span class="keyword">public</span> Result&lt;Boolean&gt; <span class="title function_">updateCouponAmount</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId, <span class="meta">@PathVariable</span> BigDecimal couponAmount)</span> {</span><br><span class="line">   <span class="keyword">return</span> Result.ok(orderInfoService.updateCouponAmount(orderId, couponAmount));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-2-orderinfoservice">3.1.2、OrderInfoService</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Boolean <span class="title function_">updateCouponAmount</span><span class="params">(Long orderId, BigDecimal couponAmount)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-3-orderinfoserviceimpl">3.1.3、OrderInfoServiceImpl</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">updateCouponAmount</span><span class="params">(Long orderId, BigDecimal couponAmount)</span> {</span><br><span class="line">   <span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> orderBillMapper.updateCouponAmount(orderId, couponAmount);</span><br><span class="line">    <span class="keyword">if</span>(row != <span class="number">1</span>) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.UPDATE_ERROR);</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-4-orderbillmapper">3.1.4、OrderBillMapper</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">updateCouponAmount</span><span class="params">(<span class="meta">@Param("orderId")</span> Long orderId, <span class="meta">@Param("couponAmount")</span> BigDecimal couponAmount)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h5><span id="3-1-5-orderbillmapper-xml">3.1.5、OrderBillMapper.xml</span></h5><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateCouponAmount"</span>&gt;</span></span><br><span class="line">    update order_bill set coupon_amount = #{couponAmount}, pay_amount = pay_amount - #{couponAmount} where order_id = #{orderId}</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h4><span id="3-2-feign-jie-kou">3.2、Feign接口</span></h4><h5><span id="3-2-1-orderinfofeignclient">3.2.1、OrderInfoFeignClient</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更新优惠券金额</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> couponAmount</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("/order/info/updateCouponAmount/{orderId}/{couponAmount}")</span></span><br><span class="line">Result&lt;Boolean&gt; <span class="title function_">updateCouponAmount</span><span class="params">(<span class="meta">@PathVariable</span> Long orderId, <span class="meta">@PathVariable</span> BigDecimal couponAmount)</span>;</span><br></pre></td></tr></tbody></table></figure>

<h3><span id="4-cheng-ke-duan-zhi-fu-gai-zao">4、乘客端支付改造</span></h3><p>改造乘客端web接口：“创建微信支付”接口</p>
<h4><span id="4-1-orderserviceimpl">4.1、OrderServiceImpl</span></h4><p>关键代码：</p>
<p><img src="/2024/09/26/projection-daijia/1700639275487.png" alt="70063927548"></p>
<p>完整代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> WxPrepayVo <span class="title function_">createWxPayment</span><span class="params">(CreateWxPaymentForm createWxPaymentForm)</span> {</span><br><span class="line">    <span class="comment">//1.获取订单支付相关信息</span></span><br><span class="line">    <span class="type">OrderPayVo</span> <span class="variable">orderPayVo</span> <span class="operator">=</span> orderInfoFeignClient.getOrderPayVo(createWxPaymentForm.getOrderNo(), createWxPaymentForm.getCustomerId()).getData();</span><br><span class="line">    <span class="comment">//判断是否在未支付状态</span></span><br><span class="line">    <span class="keyword">if</span> (orderPayVo.getStatus().intValue() != OrderStatus.UNPAID.getStatus().intValue()) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.ILLEGAL_REQUEST);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.获取乘客微信openId</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">customerOpenId</span> <span class="operator">=</span> customerInfoFeignClient.getCustomerOpenId(orderPayVo.getCustomerId()).getData();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.获取司机微信openId</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">driverOpenId</span> <span class="operator">=</span> driverInfoFeignClient.getDriverOpenId(orderPayVo.getDriverId()).getData();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4.处理优惠券</span></span><br><span class="line">    <span class="type">BigDecimal</span> <span class="variable">couponAmount</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">//支付时选择过一次优惠券，如果支付失败或未支付，下次支付时不能再次选择，只能使用第一次选中的优惠券（前端已控制，后端再次校验）</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == orderPayVo.getCouponAmount() &amp;&amp; <span class="literal">null</span> != createWxPaymentForm.getCustomerCouponId() &amp;&amp; createWxPaymentForm.getCustomerCouponId() != <span class="number">0</span>) {</span><br><span class="line">        <span class="type">UseCouponForm</span> <span class="variable">useCouponForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UseCouponForm</span>();</span><br><span class="line">        useCouponForm.setOrderId(orderPayVo.getOrderId());</span><br><span class="line">        useCouponForm.setCustomerCouponId(createWxPaymentForm.getCustomerCouponId());</span><br><span class="line">        useCouponForm.setOrderAmount(orderPayVo.getPayAmount());</span><br><span class="line">        useCouponForm.setCustomerId(createWxPaymentForm.getCustomerId());</span><br><span class="line">        couponAmount = couponFeignClient.useCoupon(useCouponForm).getData();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.更新账单优惠券金额</span></span><br><span class="line">    <span class="comment">//支付金额</span></span><br><span class="line">    <span class="type">BigDecimal</span> <span class="variable">payAmount</span> <span class="operator">=</span> orderPayVo.getPayAmount();</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> != couponAmount) {</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">isUpdate</span> <span class="operator">=</span> orderInfoFeignClient.updateCouponAmount(orderPayVo.getOrderId(), couponAmount).getData();</span><br><span class="line">        <span class="keyword">if</span> (!isUpdate) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">GuiguException</span>(ResultCodeEnum.DATA_ERROR);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//当前支付金额 = 支付金额 - 优惠券金额</span></span><br><span class="line">        payAmount = payAmount.subtract(couponAmount);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6.封装微信下单对象，微信支付只关注以下订单属性</span></span><br><span class="line">    <span class="type">PaymentInfoForm</span> <span class="variable">paymentInfoForm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PaymentInfoForm</span>();</span><br><span class="line">    paymentInfoForm.setCustomerOpenId(customerOpenId);</span><br><span class="line">    paymentInfoForm.setDriverOpenId(driverOpenId);</span><br><span class="line">    paymentInfoForm.setOrderNo(orderPayVo.getOrderNo());</span><br><span class="line">    paymentInfoForm.setAmount(payAmount);</span><br><span class="line">    paymentInfoForm.setContent(orderPayVo.getContent());</span><br><span class="line">    paymentInfoForm.setPayWay(<span class="number">1</span>);</span><br><span class="line">    <span class="type">WxPrepayVo</span> <span class="variable">wxPrepayVo</span> <span class="operator">=</span> wxPayFeignClient.createWxPayment(paymentInfoForm).getData();</span><br><span class="line">    <span class="keyword">return</span> wxPrepayVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4><span id="4-2-tian-jia-fen-bu-shi-shi-wu">4.2、添加分布式事务</span></h4><p>如果乘客选择了优惠券抵扣，那么涉及订单微服务、优惠券微服务与支付微服务，都设计更新操作，因此我们要加Seata控制。</p>
<p>实现过程和之前订单支付后处理类似，自行完成即可！</p>

        </div>



    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        
            <script src='https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js'></script>
            <script>
                if (window.mermaid) {
                    mermaid.initialize({
                        startOnLoad: true,
                        theme: 'neural',
                    });
                }
            </script>
        
        <span>© zoe | <a href="https://hexo.io" target="_blank"></a>  <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank"></a>
              
                <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<span class="site-uv">

👤

 <i class="busuanzi-value" id="busuanzi_value_site_uv"></i>

</span>&nbsp;





<span class="site-pv">

 | 👁️

 <i class="busuanzi-value" id="busuanzi_value_site_pv"></i>

</span>


  
               
        </span>
    </div>
</footer>

    </div>

    <!-- 搜索功能 -->
    <!-- Chic/layout.ejs -->
    <div id="u-search">
        <div class="modal">
            <div class="modal-header">
                <div class="container">
                    <form id="u-search-modal-form" class="u-search-modal-form">
                        <button type="submit" class="form-submit-btn">
                            <img src="/image/search.png" class="search-btn-img" />
                        </button>
                        <input placeholder="搜索文章。。。" class="form-input" onchange="inputChange(event)" id="modal-form-input">
                    </form>
                    <a class="modal-close">x</a>
                </div>
                <div class="search-loading">
                    <div class="search-loading-bar"></div>
                </div>
            </div>
            <div class="modal-body">
                <!-- <ul class="modal-results">
                    <li class="result-item">
                        <a class="result-item-detail">
                            <span class="title">页面配置</span>
                            <span class="content">
                                网址，例如： front-matter---layout: postdate: <b mark></b>
                                7-07-05title: [转]如何搭建基于Hexo的独立博客categories: [Dev, Hexo]tags: - Hexoauthor: name: xaoxuu avatar: https://cdn.jsdelivr.......
                            </span>
                        </a>
                    </li>
                </ul> -->
            </div>
        </div>
        <div class="modal-overlay"></div>
    </div>


</body>



</html>


