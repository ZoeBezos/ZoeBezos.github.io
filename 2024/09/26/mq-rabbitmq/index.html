<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="zoe">


    <meta name="subtitle" content="liberté">




<title>RabbitMQ | ZOE&#39;s site</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    
    <script src="/js/jquery-3.7.0.min.js"></script>
    
    <script src="/js/mathjax2.7.5.js"></script>
    



    
    
        
    


<!-- 搜索的部分 -->



    <script>
    // function searchToggle() {
    //     const width = $(document.body).width()
    //     if(width > 479) {
    //         return;
    //     }
    //     const search = $('.search');
    //     const searchForm = $('.form-search')

    //     if(!search.hasClass("mobile-search")) {
    //         search.addClass("mobile-search");
    //     } else {
    //         search.removeClass("mobile-search");
    //     } 
    // }

    function searchToggle() {
        const width = $(document.body).width()
        if(width > 479) {
            return;
        }
        const search = $('.search');
        const searchForm = $('.form-search');
        const menuToggle = $('.menu-toggle');
        const title = $('.navbar-header-title ');

        if(!search.hasClass("mobile-search")) {
            search.addClass("mobile-search");
            menuToggle.addClass("open-search")
            title.addClass("mobile-title-hidden")
        } else {
            search.removeClass("mobile-search");
            menuToggle.removeClass("open-search")
            // title.css({visibility: 'visible'})
            title.removeClass("mobile-title-hidden")
        } 
    }



    function search(searchInputEl, formEl, flag) {
        const path = "/" + "search.json"; // 可以在public 下查看这个search.json
        $(formEl).submit(function(e){
            e.preventDefault();
            let target = null
            if(searchInputEl == null) {
                const screenWidth = $(document.body).width();
                target = screenWidth > 479 ? $('#pc-search-input') : $('#mobile-search-input');
                console.log(target);
            } else {
                target = $(searchInputEl)
            }

            if(!flag && target.val() === '') {
                return ;
            }

            $("#u-search").fadeIn(500, function() {
                $("body > .wrapper").addClass("modal-active");

                $.ajax({
                    url: path,
                    dataType: "json",
                    beforeSend: function (xhr) {
                        $input = target.val();
                        $(".form-input").val($input);
                        const loadingBar = $('.search-loading-bar') 
                        loadingBar.css({
                            width:'100%',
                            display: 'block'
                        });
                    },
                    success: function( datas ) {
                        console.log(datas);
                        const $resultPanel = $(".modal-body")[0];
                        let str = `<ul class="modal-results">`;
                        var keywords = $(".form-input").val().trim().toLowerCase().split(/[\s\-]+/);
                        $resultPanel.innerHTML = "";
                        let hasResult = false
                        let text = `<div class="no-result">找不到与关键词相关的内容....</div>`;

                        if ($(".form-input").val().trim().length <= 0) {
                            // 没有结果
                            $resultPanel.innerHTML = text;
                            return;
                        }
                        datas.forEach(function (data, index) {
                            var isMatch = true;
                            if (!data.title || data.title.trim() === '') {
                                data.title = "Untitled";
                            }
                            var data_title = data.title.trim().toLowerCase();
                            var data_content = data.content && data.content.trim().replace(/<[^>]+>/g, "").toLowerCase() || '';
                            var data_url = data.url;
                            var index_title = -1;
                            var index_content = -1;
                            var first_occur = -1;
                            // only match artiles with not empty contents
                            if (data_content !== '') {
                                keywords.forEach(function (keyword, i) {
                                    index_title = data_title.indexOf(keyword);
                                    index_content = data_content.indexOf(keyword);

                                    if (index_title < 0 && index_content < 0) {
                                        isMatch = false;
                                    } else {
                                        hasResult = true
                                        if (index_content < 0) {
                                            index_content = 0;
                                        }
                                        if (i == 0) {
                                            first_occur = index_content;
                                        }
                                    }
                                });
                            } else {
                                isMatch = false;
                            }
                            // show search results
                            if (isMatch) {
                                str += `<li class='result-item'><a href='${data_url}' class='result-item-detail'> <span class="title">${data_title}</span>`;
                                var content = data.content.trim().replace(/<[^>]+>/g, "");
                                if (first_occur >= 0) {
                                    // cut out 200 characters
                                    var start = first_occur - 40;
                                    var end = first_occur + 160;

                                    if (start < 0) {
                                        start = 0;
                                    }

                                    if (start == 0) {
                                        end = 200;
                                    }

                                    if (end > content.length) {
                                        end = content.length;
                                    }

                                    var match_content = content.substring(start, end);

                                    // highlight all keywords
                                    keywords.forEach(function (keyword) {
                                        var regS = new RegExp(keyword, "gi");
                                        match_content = match_content.replace(regS, `<em class="search-keyword">${keyword}</em>`);
                                    });

                                    str += `<span class="content"> ${match_content} ...</span></a>`;
                                }
                                str += "</li>";
                            }
                        });
                        str += "</ul>";
                        if(hasResult) {
                            $resultPanel.innerHTML = str;
                        } else {
                            $resultPanel.innerHTML = text;
                        }

                    },
                    complete: function() {
                        setTimeout(() => {
                                const loadingBar = $('.search-loading-bar') 
                                loadingBar.css({
                                    width:'0%',
                                    display: 'none'
                                });
                        }, 300)
                    }
                });
            })

        });
    }

    $(document).ready(function() {
        $('.modal-close').click(function () { 
            $("#u-search").fadeOut();
            $("body > .wrapper").removeClass("modal-active")
        })

        $('.modal-overlay').click(function() {
            $("#u-search").fadeOut();
            $("body > .wrapper").removeClass("modal-active")
        })
        search(null, ".form-search", false)
        search("#u-search-modal-form .form-input", ".u-search-modal-form", true)
    })
</script>

<meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                // pagebody.classList.add('dark-theme');
                // mobile
                // document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <!-- <div class="navbar-header header-logo"><a href="/">ZOE&#39;s site</a></div> -->
            <div class="navbar-header header-logo"><a href="/"><i class="iconfont icon-zhuye" style="font-size: 1em;"></i>ZOE&#39;s site</a></div>
            <div class="menu navbar-right">
                <!-- 这里表示的是pc端搜索框 -->
                
                
    <div class="search ">
        <!-- <div class="search-btn" onClick="searchToggle()">
            <img src="/image/search.png" class="search-btn-img" />
        </div> -->
        <form class="form-search">
            <input class="input" placeholder="search" autocomplete="on" id="pc-search-input"/>
        </form>
    </div>

                
                <a class="menu-item" target="_blank" rel="noopener" href="https://github.com/ZoeBezos">Github</a>
                
                <a class="menu-item" target="_blank" rel="noopener" href="https://www.linkedin.com/in/zoe-bezos/">Linkedin</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <!-- <label for="switch_default" class="toggleBtn"></label> -->
            </div>
        </div>
    </nav>
    
    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">ZOE&#39;s site</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="navbar-mobile-right">
                    
                    
    <div class="search ">
        <!-- <div class="search-btn" onClick="searchToggle()">
            <img src="/image/search.png" class="search-btn-img" />
        </div> -->
        <form class="form-search">
            <input class="input" placeholder="search" autocomplete="on" id="mobile-search-input"/>
        </form>
    </div>

                    <!-- <div class="menu-toggle" onclick="mobileBtn()">&#9776; menu</div> -->
                </div>
    
            </div>
            <div class="menu" id="mobile-menu">
                
                <a class="menu-item" target="_blank" rel="noopener" href="https://github.com/ZoeBezos">Github</a>
                
                <a class="menu-item" target="_blank" rel="noopener" href="https://www.linkedin.com/in/zoe-bezos/">Linkedin</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>

    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">RabbitMQ</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">zoe</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">September 26, 2024&nbsp;&nbsp;0:07:17</a>
                        </span>
                    
                    

                        <span class="post-category">                        
                            Category:                        
                                                    
                            <a href="/categories/MQ/">MQ</a>
                            
                        </span>

                    

                    
                        
                        <span class="post-count">                        
                            Words:                        
                            <a href="">17.3k</a>                         
                        </span>
                        
                    
                                                                        
                    
                        
                        <span class="post-count">                        
                            Time:                        
                            <a href="">81min</a>                         
                        </span>
                        
                    
                        
                </div>
            
        </header>

        <div class="post-content">
            <blockquote>
<p> 视频资源（2024-05-21）：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1sw4m1U7Qe/?spm_id_from=333.999.0.0&amp;vd_source=7213f8cda7f8cf9dc59fb736cd897d74">尚硅谷 RabbitMQ教程_哔哩哔哩_bilibili</a></p>
</blockquote>
<h1><span id="i-rabbitmq-an-zhuang">Ⅰ.RabbitMQ安装</span></h1><h2><span id="yi-an-zhuang">一、安装</span></h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取镜像</span></span><br><span class="line">docker pull rabbitmq:3.13-management</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-d 参数：后台运行 Docker 容器</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--name 参数：设置容器名称</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-p 参数：映射端口号，格式是“宿主机端口号:容器内端口号”。5672供客户端程序访问，15672供后台管理界面访问</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-v 参数：卷映射目录</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-e 参数：设置容器内的环境变量，这里我们设置了登录RabbitMQ管理后台的默认用户和密码</span></span><br><span class="line">docker run -d \</span><br><span class="line">--name rabbitmq \</span><br><span class="line">-p 5672:5672 \</span><br><span class="line">-p 15672:15672 \</span><br><span class="line">-v rabbitmq-plugin:/plugins \</span><br><span class="line">-e RABBITMQ_DEFAULT_USER=guest \</span><br><span class="line">-e RABBITMQ_DEFAULT_PASS=123456 \</span><br><span class="line">rabbitmq:3.13-management</span><br></pre></td></tr></tbody></table></figure>



<br>



<h2><span id="er-yan-zheng">二、验证</span></h2><p>访问后台管理界面：<a target="_blank" rel="noopener" href="http://192.168.200.100:15672/">http://192.168.200.100:15672</a></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231102194452610.png" alt="image-20231102194452610"></p>
<br>

<p>使用上面创建Docker容器时指定的默认用户名、密码登录：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231102194633997.png" alt="image-20231102194633997"></p>
<br>



<p><img src="/2024/09/26/mq-rabbitmq/image-20231102194746743.png" alt="image-20231102194746743"></p>
<br>



<h2><span id="san-ke-neng-de-wen-ti">三、可能的问题</span></h2><h3><span id="1-wen-ti-xian-xiang">1、问题现象</span></h3><p>在使用Docker拉取RabbitMQ镜像的时候，如果遇到提示：missing signature key，那就说明Docker版本太低了，需要升级</p>
<p>比如我目前的Docker版本如下图所示：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231105151245299.png" alt="image-20231105151245299"></p>
<h3><span id="2-jie-jue-ban-fa">2、解决办法</span></h3><blockquote>
<p>基于CentOS7</p>
</blockquote>
<h4><span id="xie-zai-dang-qian-docker">①卸载当前Docker</span></h4><p>更好的办法是安装Docker前曾经给服务器拍摄了快照，此时恢复快照；</p>
<p>如果不曾拍摄快照，那只能执行卸载操作了</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">yum erase -y docker \</span><br><span class="line">	docker-client \</span><br><span class="line">	docker-client-latest \</span><br><span class="line">	docker-common \</span><br><span class="line">	docker-latest \</span><br><span class="line">	docker-latest-logrotate \</span><br><span class="line">	docker-logrotate \</span><br><span class="line">	docker-selinux \</span><br><span class="line">	docker-engine-selinux \</span><br><span class="line">	docker-engine \</span><br><span class="line">	docker-ce</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="sheng-ji-yum-ku">②升级yum库</span></h4><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update -y</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="an-zhuang-docker-zui-xin-ban">③安装Docker最新版</span></h4><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br></pre></td></tr></tbody></table></figure>



<p>如果这一步看到提示：没有可用软件包 docker-ce，那就添加Docker的yum源：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils</span><br><span class="line">yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="she-zhi-docker-fu-wu">④设置Docker服务</span></h4><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start docker</span><br><span class="line">systemctl enable docker</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-yan-zheng">3、验证</span></h3><p>上述操作执行完成后，再次查看Docker版本：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240321113218105-17276766699915.png" alt="image-20240321113218105"></p>
<h1><span id="ii-helloworld">Ⅱ.HelloWorld</span></h1><h2><span id="yi-mu-biao">一、目标</span></h2><p>生产者发送消息，消费者接收消息，用最简单的方式实现<br></p>
<p>官网说明参见下面超链接：<br></p>
<p><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/tutorials/tutorial-one-java.html">RabbitMQ tutorial - “Hello World!” — RabbitMQ</a></p>
<p><img src="/2024/09/26/mq-rabbitmq/python-one-172767680894411.png" alt="python-one"></p>
<h2><span id="er-ju-ti-cao-zuo">二、具体操作</span></h2><h3><span id="1-chuang-jian-java-gong-cheng">1、创建Java工程</span></h3><h4><span id="xiao-xi-fa-song-duan-sheng-chan-zhe">①消息发送端（生产者）</span></h4><p><img src="/2024/09/26/mq-rabbitmq/img54.png" alt="images"></p>
<br>



<h4><span id="xiao-xi-jie-shou-duan-xiao-fei-zhe">②消息接收端（消费者）</span></h4><p><img src="/2024/09/26/mq-rabbitmq/img55.png" alt="images"></p>
<br>



<h4><span id="tian-jia-yi-lai">③添加依赖</span></h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rabbitmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>amqp-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.20.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<br>



<h3><span id="2-fa-song-xiao-xi">2、发送消息</span></h3><h4><span id="java-dai-ma">①Java代码</span></h4><p>不用客气，整个代码全部复制——当然，连接信息改成你自己的：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.rabbitmq.simple;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> {  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 创建连接工厂  </span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 设置主机地址  </span></span><br><span class="line">        connectionFactory.setHost(<span class="string">"192.168.200.100"</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 设置连接端口号：默认为 5672</span></span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 虚拟主机名称：默认为 /</span></span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">"/"</span>);</span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 设置连接用户名；默认为guest  </span></span><br><span class="line">        connectionFactory.setUsername(<span class="string">"guest"</span>);</span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 设置连接密码；默认为guest  </span></span><br><span class="line">        connectionFactory.setPassword(<span class="string">"123456"</span>);</span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 创建连接  </span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionFactory.newConnection();  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 创建频道  </span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 声明（创建）队列  </span></span><br><span class="line">        <span class="comment">// queue      参数1：队列名称  </span></span><br><span class="line">        <span class="comment">// durable    参数2：是否定义持久化队列，当 MQ 重启之后还在  </span></span><br><span class="line">        <span class="comment">// exclusive  参数3：是否独占本次连接。若独占，只能有一个消费者监听这个队列且 Connection 关闭时删除这个队列  </span></span><br><span class="line">        <span class="comment">// autoDelete 参数4：是否在不使用的时候自动删除队列，也就是在没有Consumer时自动删除  </span></span><br><span class="line">        <span class="comment">// arguments  参数5：队列其它参数  </span></span><br><span class="line">        channel.queueDeclare(<span class="string">"simple_queue"</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 要发送的信息  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">"你好；小兔子！"</span>;  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 参数1：交换机名称,如果没有指定则使用默认Default Exchange  </span></span><br><span class="line">        <span class="comment">// 参数2：路由key,简单模式可以传递队列名称  </span></span><br><span class="line">        <span class="comment">// 参数3：配置信息  </span></span><br><span class="line">        <span class="comment">// 参数4：消息内容  </span></span><br><span class="line">        channel.basicPublish(<span class="string">""</span>, <span class="string">"simple_queue"</span>, <span class="literal">null</span>, message.getBytes());  </span><br><span class="line">  </span><br><span class="line">        System.out.println(<span class="string">"已发送消息："</span> + message);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 关闭资源  </span></span><br><span class="line">        channel.close();  </span><br><span class="line">        connection.close();  </span><br><span class="line">  </span><br><span class="line">    }  </span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="cha-kan-xiao-guo">②查看效果</span></h4><p><img src="/2024/09/26/mq-rabbitmq/image-20231102210451880.png" alt="image-20231102210451880"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231102210812912.png" alt="image-20231102210812912"></p>
<h3><span id="3-jie-shou-xiao-xi">3、接收消息</span></h3><h4><span id="java-dai-ma">①Java代码</span></h4><p>不用客气，整个代码全部复制——当然，连接信息改成你自己的：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.rabbitmq.simple;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> {  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 1.创建连接工厂  </span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 2. 设置参数  </span></span><br><span class="line">        factory.setHost(<span class="string">"192.168.200.100"</span>);  </span><br><span class="line">        factory.setPort(<span class="number">5672</span>);  </span><br><span class="line">        factory.setVirtualHost(<span class="string">"/"</span>);  </span><br><span class="line">        factory.setUsername(<span class="string">"guest"</span>);</span><br><span class="line">        factory.setPassword(<span class="string">"123456"</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 3. 创建连接 Connection        </span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 4. 创建Channel  </span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 5. 创建队列  </span></span><br><span class="line">        <span class="comment">// 如果没有一个名字叫simple_queue的队列，则会创建该队列，如果有则不会创建  </span></span><br><span class="line">        <span class="comment">// 参数1. queue：队列名称  </span></span><br><span class="line">        <span class="comment">// 参数2. durable：是否持久化。如果持久化，则当MQ重启之后还在  </span></span><br><span class="line">        <span class="comment">// 参数3. exclusive：是否独占。  </span></span><br><span class="line">        <span class="comment">// 参数4. autoDelete：是否自动删除。当没有Consumer时，自动删除掉  </span></span><br><span class="line">        <span class="comment">// 参数5. arguments：其它参数。  </span></span><br><span class="line">        channel.queueDeclare(<span class="string">"simple_queue"</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 接收消息  </span></span><br><span class="line">        <span class="type">DefaultConsumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel){  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 回调方法,当收到消息后，会自动执行该方法  </span></span><br><span class="line">            <span class="comment">// 参数1. consumerTag：标识  </span></span><br><span class="line">            <span class="comment">// 参数2. envelope：获取一些信息，交换机，路由key...  </span></span><br><span class="line">            <span class="comment">// 参数3. properties：配置信息  </span></span><br><span class="line">            <span class="comment">// 参数4. body：数据  </span></span><br><span class="line">            <span class="meta">@Override</span>  </span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException {  </span><br><span class="line">  </span><br><span class="line">                System.out.println(<span class="string">"consumerTag："</span>+consumerTag);  </span><br><span class="line">                System.out.println(<span class="string">"Exchange："</span>+envelope.getExchange());  </span><br><span class="line">                System.out.println(<span class="string">"RoutingKey："</span>+envelope.getRoutingKey());  </span><br><span class="line">                System.out.println(<span class="string">"properties："</span>+properties);  </span><br><span class="line">                System.out.println(<span class="string">"body："</span>+<span class="keyword">new</span> <span class="title class_">String</span>(body));  </span><br><span class="line">  </span><br><span class="line">            }  </span><br><span class="line">  </span><br><span class="line">        };  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 参数1. queue：队列名称  </span></span><br><span class="line">        <span class="comment">// 参数2. autoAck：是否自动确认，类似咱们发短信，发送成功会收到一个确认消息  </span></span><br><span class="line">        <span class="comment">// 参数3. callback：回调对象  </span></span><br><span class="line">        <span class="comment">// 消费者类似一个监听程序，主要是用来监听消息  </span></span><br><span class="line">        channel.basicConsume(<span class="string">"simple_queue"</span>,<span class="literal">true</span>,consumer);  </span><br><span class="line">  </span><br><span class="line">    }  </span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="kong-zhi-tai-da-yin">②控制台打印</span></h4><blockquote>
<p>consumerTag：amq.ctag-8EB87GaZFP52LKSMcj98UA<br>Exchange：<br>RoutingKey：simple_queue<br>properties：#contentHeader<basic>(content-type=null, content-encoding=null, headers=null, delivery-mode=null, priority=null, correlation-id=null, reply-to=null, expiration=null, message-id=null, timestamp=null, type=null, user-id=null, app-id=null, cluster-id=null)<br>body：<span style="color:blue;font-weight:bolder;">你好；小兔子！</span></basic></p>
</blockquote>
<h4><span id="cha-kan-hou-tai-guan-li-jie-mian">③查看后台管理界面</span></h4><p>因为消息被消费掉了，所以RabbitMQ服务器上没有了：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231102211243699-172767686673913.png" alt="image-20231102211243699"></p>
<h1><span id="iii-gong-zuo-dui-lie-mo-shi">Ⅲ.工作队列模式</span></h1><h2><span id="yi-sheng-chan-zhe-dai-ma">一、生产者代码</span></h2><h3><span id="1-feng-zhuang-gong-ju-lei">1、封装工具类</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.rabbitmq.util;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConnectionUtil</span> {  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">HOST_ADDRESS</span> <span class="operator">=</span> <span class="string">"192.168.200.100"</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title function_">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> Exception {  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 定义连接工厂  </span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 设置服务地址  </span></span><br><span class="line">        factory.setHost(HOST_ADDRESS);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 端口  </span></span><br><span class="line">        factory.setPort(<span class="number">5672</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//设置账号信息，用户名、密码、vhost  </span></span><br><span class="line">        factory.setVirtualHost(<span class="string">"/"</span>);  </span><br><span class="line">        factory.setUsername(<span class="string">"guest"</span>);  </span><br><span class="line">        factory.setPassword(<span class="string">"123456"</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 通过工程获取连接  </span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> connection;  </span><br><span class="line">    }  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> ConnectionUtil.getConnection();  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// amqp://guest@192.168.200.100:5672/  </span></span><br><span class="line">        System.out.println(con);  </span><br><span class="line">  </span><br><span class="line">        con.close();  </span><br><span class="line">  </span><br><span class="line">    }  </span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-bian-xie-dai-ma">2、编写代码</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.rabbitmq.work;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.atguigu.rabbitmq.util.ConnectionUtil;  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> {  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">"work_queue"</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> ConnectionUtil.getConnection();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();  </span><br><span class="line">  </span><br><span class="line">        channel.queueDeclare(QUEUE_NAME,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++) {  </span><br><span class="line">  </span><br><span class="line">            <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> i+<span class="string">"hello rabbitmq~~~"</span>;  </span><br><span class="line">  </span><br><span class="line">            channel.basicPublish(<span class="string">""</span>,QUEUE_NAME,<span class="literal">null</span>,body.getBytes());  </span><br><span class="line">  </span><br><span class="line">        }  </span><br><span class="line">  </span><br><span class="line">        channel.close();  </span><br><span class="line">  </span><br><span class="line">        connection.close();  </span><br><span class="line">  </span><br><span class="line">    }  </span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-fa-song-xiao-xi-xiao-guo">3、发送消息效果</span></h3><p><img src="/2024/09/26/mq-rabbitmq/img60-1698977979067-1.png" alt="img"></p>
<h2><span id="er-xiao-fei-zhe-dai-ma">二、消费者代码</span></h2><h3><span id="1-bian-xie-dai-ma">1、编写代码</span></h3><p>创建Consumer1和Consumer2。Consumer2只是类名和打印提示不同，代码完全一样。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.rabbitmq.work;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.atguigu.rabbitmq.util.ConnectionUtil;  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer1</span> {  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">"work_queue"</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> ConnectionUtil.getConnection();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();  </span><br><span class="line">  </span><br><span class="line">        channel.queueDeclare(QUEUE_NAME,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel){  </span><br><span class="line">  </span><br><span class="line">            <span class="meta">@Override</span>  </span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException {  </span><br><span class="line">  </span><br><span class="line">                System.out.println(<span class="string">"Consumer1 body："</span>+<span class="keyword">new</span> <span class="title class_">String</span>(body));  </span><br><span class="line">  </span><br><span class="line">            }  </span><br><span class="line">  </span><br><span class="line">        };  </span><br><span class="line">  </span><br><span class="line">        channel.basicConsume(QUEUE_NAME,<span class="literal">true</span>,consumer);  </span><br><span class="line">  </span><br><span class="line">    }  </span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>注意</strong>：运行的时候先启动两个消费端程序，然后再启动生产者端程序。<br><br>如果已经运行过生产者程序，则手动把work_queue队列删掉。<br></p>
<h3><span id="2-yun-xing-xiao-guo">2、运行效果</span></h3><p>最终两个消费端程序竞争结果如下：<br></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231103103841644.png" alt="image-20231103103841644"></p>
<br>

<p><img src="/2024/09/26/mq-rabbitmq/image-20231103103955165-172767694589117.png" alt="image-20231103103955165"></p>
<h1><span id="iv-fa-bu-ding-yue-mo-shi">Ⅳ.发布订阅模式</span></h1><h2><span id="yi-sheng-chan-zhe-dai-ma">一、生产者代码</span></h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.rabbitmq.fanout;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.atguigu.rabbitmq.util.ConnectionUtil;  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> {  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {  </span><br><span class="line">  </span><br><span class="line">      <span class="comment">// 1、获取连接  </span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> ConnectionUtil.getConnection();  </span><br><span class="line">  </span><br><span class="line">      <span class="comment">// 2、创建频道  </span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 参数1. exchange：交换机名称  </span></span><br><span class="line">        <span class="comment">// 参数2. type：交换机类型  </span></span><br><span class="line">        <span class="comment">//     DIRECT("direct")：定向  </span></span><br><span class="line">        <span class="comment">//     FANOUT("fanout")：扇形（广播），发送消息到每一个与之绑定队列。  </span></span><br><span class="line">        <span class="comment">//     TOPIC("topic")：通配符的方式  </span></span><br><span class="line">        <span class="comment">//     HEADERS("headers")：参数匹配  </span></span><br><span class="line">        <span class="comment">// 参数3. durable：是否持久化  </span></span><br><span class="line">        <span class="comment">// 参数4. autoDelete：自动删除  </span></span><br><span class="line">        <span class="comment">// 参数5. internal：内部使用。一般false  </span></span><br><span class="line">        <span class="comment">// 参数6. arguments：其它参数  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">"test_fanout"</span>;  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 3、创建交换机  </span></span><br><span class="line">        channel.exchangeDeclare(exchangeName, BuiltinExchangeType.FANOUT,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 4、创建队列  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queue1Name</span> <span class="operator">=</span> <span class="string">"test_fanout_queue1"</span>;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">queue2Name</span> <span class="operator">=</span> <span class="string">"test_fanout_queue2"</span>;  </span><br><span class="line">  </span><br><span class="line">        channel.queueDeclare(queue1Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);  </span><br><span class="line">        channel.queueDeclare(queue2Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 5、绑定队列和交换机  </span></span><br><span class="line">      <span class="comment">// 参数1. queue：队列名称  </span></span><br><span class="line">      <span class="comment">// 参数2. exchange：交换机名称  </span></span><br><span class="line">      <span class="comment">// 参数3. routingKey：路由键，绑定规则  </span></span><br><span class="line">      <span class="comment">//     如果交换机的类型为fanout，routingKey设置为""  </span></span><br><span class="line">        channel.queueBind(queue1Name,exchangeName,<span class="string">""</span>);  </span><br><span class="line">        channel.queueBind(queue2Name,exchangeName,<span class="string">""</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">"日志信息：张三调用了findAll方法...日志级别：info..."</span>;  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 6、发送消息  </span></span><br><span class="line">        channel.basicPublish(exchangeName,<span class="string">""</span>,<span class="literal">null</span>,body.getBytes());  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 7、释放资源  </span></span><br><span class="line">        channel.close();  </span><br><span class="line">        connection.close();  </span><br><span class="line">  </span><br><span class="line">    }  </span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="er-xiao-fei-zhe-dai-ma">二、消费者代码</span></h2><h3><span id="1-xiao-fei-zhe-1-hao">1、消费者1号</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.rabbitmq.fanout;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.atguigu.rabbitmq.util.ConnectionUtil;  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer1</span> {  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> ConnectionUtil.getConnection();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">queue1Name</span> <span class="operator">=</span> <span class="string">"test_fanout_queue1"</span>;  </span><br><span class="line">  </span><br><span class="line">        channel.queueDeclare(queue1Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel){  </span><br><span class="line">  </span><br><span class="line">            <span class="meta">@Override</span>  </span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException {  </span><br><span class="line">  </span><br><span class="line">                System.out.println(<span class="string">"body："</span>+<span class="keyword">new</span> <span class="title class_">String</span>(body));  </span><br><span class="line">                System.out.println(<span class="string">"队列 1 消费者 1 将日志信息打印到控制台....."</span>);  </span><br><span class="line">  </span><br><span class="line">            }  </span><br><span class="line">  </span><br><span class="line">        };  </span><br><span class="line">  </span><br><span class="line">        channel.basicConsume(queue1Name,<span class="literal">true</span>,consumer);  </span><br><span class="line">  </span><br><span class="line">    }  </span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-xiao-fei-zhe-2-hao">2、消费者2号</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.rabbitmq.fanout;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.atguigu.rabbitmq.util.ConnectionUtil;  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer2</span> {  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> ConnectionUtil.getConnection();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">queue2Name</span> <span class="operator">=</span> <span class="string">"test_fanout_queue2"</span>;  </span><br><span class="line">  </span><br><span class="line">        channel.queueDeclare(queue2Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel){  </span><br><span class="line">  </span><br><span class="line">            <span class="meta">@Override</span>  </span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException {  </span><br><span class="line">  </span><br><span class="line">                System.out.println(<span class="string">"body："</span>+<span class="keyword">new</span> <span class="title class_">String</span>(body));  </span><br><span class="line">                System.out.println(<span class="string">"队列 2 消费者 2 将日志信息打印到控制台....."</span>);  </span><br><span class="line">  </span><br><span class="line">            }  </span><br><span class="line">  </span><br><span class="line">        };  </span><br><span class="line">  </span><br><span class="line">        channel.basicConsume(queue2Name,<span class="literal">true</span>,consumer);  </span><br><span class="line">  </span><br><span class="line">    }  </span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="san-yun-xing-xiao-guo">三、运行效果</span></h2><p>还是先启动消费者，然后再运行生产者程序发送消息：</p>
<p><img src="/2024/09/26/mq-rabbitmq/img66.png" alt="img"></p>
<p><img src="/2024/09/26/mq-rabbitmq/img67.png" alt="img"></p>
<h2><span id="si-xiao-jie">四、小结</span></h2><p>交换机和队列的绑定关系如下图所示：</p>
<p><img src="/2024/09/26/mq-rabbitmq/img68.png" alt="images"></p>
<p>交换机需要与队列进行绑定，绑定之后；一个消息可以被多个消费者都收到。</p>
<p><strong>发布订阅模式与工作队列模式的区别：</strong></p>
<ul>
<li>工作队列模式本质上是绑定默认交换机</li>
<li>发布订阅模式绑定指定交换机</li>
<li>监听同一个队列的消费端程序彼此之间是竞争关系</li>
<li>绑定同一个交换机的多个队列在发布订阅模式下，消息是广播的，每个队列都能接收到消息</li>
</ul>
<h1><span id="v-lu-you-mo-shi">Ⅴ.路由模式</span></h1><h2><span id="yi-sheng-chan-zhe-dai-ma">一、生产者代码</span></h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.rabbitmq.routing;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.atguigu.rabbitmq.util.ConnectionUtil;  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> {  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {  </span><br><span class="line">  </span><br><span class="line">      <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> ConnectionUtil.getConnection();  </span><br><span class="line">  </span><br><span class="line">      <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();  </span><br><span class="line">  </span><br><span class="line">      <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">"test_direct"</span>;  </span><br><span class="line">  </span><br><span class="line">      <span class="comment">// 创建交换机  </span></span><br><span class="line">      channel.exchangeDeclare(exchangeName,BuiltinExchangeType.DIRECT,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">      <span class="comment">// 创建队列  </span></span><br><span class="line">      <span class="type">String</span> <span class="variable">queue1Name</span> <span class="operator">=</span> <span class="string">"test_direct_queue1"</span>;  </span><br><span class="line">      <span class="type">String</span> <span class="variable">queue2Name</span> <span class="operator">=</span> <span class="string">"test_direct_queue2"</span>;  </span><br><span class="line">  </span><br><span class="line">      <span class="comment">// 声明（创建）队列  </span></span><br><span class="line">      channel.queueDeclare(queue1Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);  </span><br><span class="line">      channel.queueDeclare(queue2Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">      <span class="comment">// 队列绑定交换机  </span></span><br><span class="line">      <span class="comment">// 队列1绑定error  </span></span><br><span class="line">      channel.queueBind(queue1Name,exchangeName,<span class="string">"error"</span>);  </span><br><span class="line">  </span><br><span class="line">      <span class="comment">// 队列2绑定info error warning  </span></span><br><span class="line">      channel.queueBind(queue2Name,exchangeName,<span class="string">"info"</span>);  </span><br><span class="line">      channel.queueBind(queue2Name,exchangeName,<span class="string">"error"</span>);  </span><br><span class="line">      channel.queueBind(queue2Name,exchangeName,<span class="string">"warning"</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">"日志信息：张三调用了delete方法.错误了,日志级别warning"</span>;  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 发送消息  </span></span><br><span class="line">        channel.basicPublish(exchangeName,<span class="string">"warning"</span>,<span class="literal">null</span>,message.getBytes());  </span><br><span class="line">        System.out.println(message);  </span><br><span class="line">  </span><br><span class="line">      <span class="comment">// 释放资源  </span></span><br><span class="line">        channel.close();  </span><br><span class="line">        connection.close();  </span><br><span class="line">  </span><br><span class="line">    }  </span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="er-xiao-fei-zhe-dai-ma">二、消费者代码</span></h2><h3><span id="1-xiao-fei-zhe-1-hao">1、消费者1号</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.rabbitmq.routing;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.atguigu.rabbitmq.util.ConnectionUtil;  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer1</span> {  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> ConnectionUtil.getConnection();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">queue1Name</span> <span class="operator">=</span> <span class="string">"test_direct_queue1"</span>;  </span><br><span class="line">  </span><br><span class="line">        channel.queueDeclare(queue1Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel){  </span><br><span class="line">  </span><br><span class="line">            <span class="meta">@Override</span>  </span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException {  </span><br><span class="line">  </span><br><span class="line">                System.out.println(<span class="string">"body："</span>+<span class="keyword">new</span> <span class="title class_">String</span>(body));  </span><br><span class="line">                System.out.println(<span class="string">"Consumer1 将日志信息打印到控制台....."</span>);  </span><br><span class="line">  </span><br><span class="line">            }  </span><br><span class="line">  </span><br><span class="line">        };  </span><br><span class="line">  </span><br><span class="line">        channel.basicConsume(queue1Name,<span class="literal">true</span>,consumer);  </span><br><span class="line">  </span><br><span class="line">    }  </span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-xiao-fei-zhe-2-hao">2、消费者2号</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.rabbitmq.routing;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.atguigu.rabbitmq.util.ConnectionUtil;  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer2</span> {  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> ConnectionUtil.getConnection();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">queue2Name</span> <span class="operator">=</span> <span class="string">"test_direct_queue2"</span>;  </span><br><span class="line">  </span><br><span class="line">        channel.queueDeclare(queue2Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel){  </span><br><span class="line">  </span><br><span class="line">            <span class="meta">@Override</span>  </span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException {  </span><br><span class="line">  </span><br><span class="line">                System.out.println(<span class="string">"body："</span>+<span class="keyword">new</span> <span class="title class_">String</span>(body));  </span><br><span class="line">                System.out.println(<span class="string">"Consumer2 将日志信息存储到数据库....."</span>);  </span><br><span class="line">  </span><br><span class="line">            }  </span><br><span class="line">  </span><br><span class="line">        };  </span><br><span class="line">  </span><br><span class="line">        channel.basicConsume(queue2Name,<span class="literal">true</span>,consumer);  </span><br><span class="line">  </span><br><span class="line">    }  </span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="san-yun-xing-jie-guo">三、运行结果</span></h2><h3><span id="1-bang-ding-guan-xi">1、绑定关系</span></h3><p><img src="/2024/09/26/mq-rabbitmq/img69.png" alt="img"></p>
<h3><span id="2-xiao-fei-xiao-xi">2、消费消息</span></h3><p><img src="/2024/09/26/mq-rabbitmq/img70.png" alt="img"></p>
<p><img src="/2024/09/26/mq-rabbitmq/img70-172767713415024.png" alt="img70"></p>
<h1><span id="vi-zhu-ti-mo-shi">Ⅵ.主题模式</span></h1><h2><span id="yi-sheng-chan-zhe-dai-ma">一、生产者代码</span></h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.rabbitmq.topic;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.atguigu.rabbitmq.util.ConnectionUtil;  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.BuiltinExchangeType;  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> {  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> ConnectionUtil.getConnection();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">"test_topic"</span>;  </span><br><span class="line">  </span><br><span class="line">        channel.exchangeDeclare(exchangeName, BuiltinExchangeType.TOPIC,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">queue1Name</span> <span class="operator">=</span> <span class="string">"test_topic_queue1"</span>;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">queue2Name</span> <span class="operator">=</span> <span class="string">"test_topic_queue2"</span>;  </span><br><span class="line">  </span><br><span class="line">        channel.queueDeclare(queue1Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);  </span><br><span class="line">        channel.queueDeclare(queue2Name,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 绑定队列和交换机  </span></span><br><span class="line">      <span class="comment">// 参数1. queue：队列名称  </span></span><br><span class="line">      <span class="comment">// 参数2. exchange：交换机名称  </span></span><br><span class="line">      <span class="comment">// 参数3. routingKey：路由键,绑定规则  </span></span><br><span class="line">      <span class="comment">//      如果交换机的类型为fanout ,routingKey设置为""  </span></span><br><span class="line">        <span class="comment">// routing key 常用格式：系统的名称.日志的级别。  </span></span><br><span class="line">        <span class="comment">// 需求： 所有error级别的日志存入数据库,所有order系统的日志存入数据库  </span></span><br><span class="line">        channel.queueBind(queue1Name,exchangeName,<span class="string">"#.error"</span>);  </span><br><span class="line">        channel.queueBind(queue1Name,exchangeName,<span class="string">"order.*"</span>);  </span><br><span class="line">        channel.queueBind(queue2Name,exchangeName,<span class="string">"*.*"</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 分别发送消息到队列：order.info、goods.info、goods.error  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> <span class="string">"[所在系统：order][日志级别：info][日志内容：订单生成，保存成功]"</span>;  </span><br><span class="line">        channel.basicPublish(exchangeName,<span class="string">"order.info"</span>,<span class="literal">null</span>,body.getBytes());  </span><br><span class="line">  </span><br><span class="line">        body = <span class="string">"[所在系统：goods][日志级别：info][日志内容：商品发布成功]"</span>;  </span><br><span class="line">        channel.basicPublish(exchangeName,<span class="string">"goods.info"</span>,<span class="literal">null</span>,body.getBytes());  </span><br><span class="line">  </span><br><span class="line">        body = <span class="string">"[所在系统：goods][日志级别：error][日志内容：商品发布失败]"</span>;  </span><br><span class="line">        channel.basicPublish(exchangeName,<span class="string">"goods.error"</span>,<span class="literal">null</span>,body.getBytes());  </span><br><span class="line">  </span><br><span class="line">        channel.close();  </span><br><span class="line">        connection.close();  </span><br><span class="line">  </span><br><span class="line">    }  </span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="er-xiao-fei-zhe-dai-ma">二、消费者代码</span></h2><h3><span id="1-xiao-fei-zhe-1-hao">1、消费者1号</span></h3><p>消费者1监听队列1：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.rabbitmq.topic;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.atguigu.rabbitmq.util.ConnectionUtil;  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer1</span> {  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> ConnectionUtil.getConnection();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">"test_topic_queue1"</span>;  </span><br><span class="line">  </span><br><span class="line">        channel.queueDeclare(QUEUE_NAME,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel){  </span><br><span class="line">  </span><br><span class="line">            <span class="meta">@Override</span>  </span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException {  </span><br><span class="line">  </span><br><span class="line">                System.out.println(<span class="string">"body："</span>+<span class="keyword">new</span> <span class="title class_">String</span>(body));  </span><br><span class="line">  </span><br><span class="line">            }  </span><br><span class="line">  </span><br><span class="line">        };  </span><br><span class="line">  </span><br><span class="line">        channel.basicConsume(QUEUE_NAME,<span class="literal">true</span>,consumer);  </span><br><span class="line">  </span><br><span class="line">    }  </span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-xiao-fei-zhe-2-hao">2、消费者2号</span></h3><p>消费者2监听队列2：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.rabbitmq.topic;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.atguigu.rabbitmq.util.ConnectionUtil;  </span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer2</span> {  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception {  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> ConnectionUtil.getConnection();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">"test_topic_queue2"</span>;  </span><br><span class="line">  </span><br><span class="line">        channel.queueDeclare(QUEUE_NAME,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel){  </span><br><span class="line">  </span><br><span class="line">            <span class="meta">@Override</span>  </span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException {  </span><br><span class="line">  </span><br><span class="line">                System.out.println(<span class="string">"body："</span>+<span class="keyword">new</span> <span class="title class_">String</span>(body));  </span><br><span class="line">  </span><br><span class="line">            }  </span><br><span class="line">  </span><br><span class="line">        };  </span><br><span class="line">  </span><br><span class="line">        channel.basicConsume(QUEUE_NAME,<span class="literal">true</span>,consumer);  </span><br><span class="line">  </span><br><span class="line">    }  </span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="san-yun-xing-xiao-guo">三、运行效果</span></h2><p>队列1：</p>
<p><img src="/2024/09/26/mq-rabbitmq/img71-1698995061577-1.png" alt="img"></p>
<p>队列2：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240930142311541.png" alt="image-20240930142311541"></p>
<h1><span id="vii-zheng-he-springboot">Ⅶ.整合SpringBoot</span></h1><h2><span id="1-xiao-fei-zhe-gong-cheng">1、消费者工程</span></h2><h3><span id="chuang-jian-module">①创建module</span></h3><p><img src="/2024/09/26/mq-rabbitmq/img76-172767741102927.png" alt="images"></p>
<h3><span id="pei-zhi-pom">②配置POM</span></h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="yaml">③YAML</span></h3><p>增加日志打印的配置：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.200</span><span class="number">.100</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.atguigu.mq.listener.MyMessageListener:</span> <span class="string">info</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="zhu-qi-dong-lei">④主启动类</span></h3><p>仿照生产者工程的主启动类，改一下类名即可</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConsumerMainType</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        SpringApplication.run(RabbitMQConsumerMainType.class, args);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>





<h3><span id="jian-ting-qi">⑤监听器</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Exchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.QueueBinding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyMessageListener</span> {</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_DIRECT</span> <span class="operator">=</span> <span class="string">"exchange.direct.order"</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY</span> <span class="operator">=</span> <span class="string">"order"</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span>  <span class="operator">=</span> <span class="string">"queue.order"</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">            value = @Queue(value = QUEUE_NAME, durable = "true"),</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(value = EXCHANGE_DIRECT),</span></span><br><span class="line"><span class="meta">            key = {ROUTING_KEY}</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processMessage</span><span class="params">(String dateString,</span></span><br><span class="line"><span class="params">                               Message message,</span></span><br><span class="line"><span class="params">                               Channel channel)</span> {</span><br><span class="line">        log.info(dateString);</span><br><span class="line">    }</span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="2-rabbitlistener-zhu-jie-shu-xing-dui-bi">2、@RabbitListener注解属性对比</span></h2><h3><span id="bindings-shu-xing">①bindings属性</span></h3><ul>
<li>表面作用：<ul>
<li>指定交换机和队列之间的绑定关系</li>
<li>指定当前方法要监听的队列</li>
</ul>
</li>
<li>隐藏效果：如果RabbitMQ服务器上没有这里指定的交换机和队列，那么框架底层的代码会创建它们</li>
</ul>
<h3><span id="queues-shu-xing">②queues属性</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = {QUEUE_ATGUIGU})</span></span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>作用：指定当前方法要监听的队列</li>
<li><span style="color:blue;font-weight:bolder;">注意</span>：此时框架不会创建相关交换机和队列，必须提前创建好</li>
</ul>
<h2><span id="3-sheng-chan-zhe-gong-cheng">3、生产者工程</span></h2><h3><span id="chuang-jian-module">①创建module</span></h3><p><img src="/2024/09/26/mq-rabbitmq/img75-172767741102928.png" alt="images"></p>
<h3><span id="pei-zhi-pom">②配置POM</span></h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="yaml">③YAML</span></h3><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">rabbitmq:</span> </span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.200</span><span class="number">.100</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span> </span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span> </span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span> </span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="zhu-qi-dong-lei">④主启动类</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQProducerMainType</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        SpringApplication.run(RabbitMQProducerMainType.class, args);  </span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="ce-shi-cheng-xu">⑤测试程序</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq.test;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQTest</span> {  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_DIRECT</span> <span class="operator">=</span> <span class="string">"exchange.direct.order"</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY</span> <span class="operator">=</span> <span class="string">"order"</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Autowired</span>  </span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Test</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessage</span><span class="params">()</span> {  </span><br><span class="line">        rabbitTemplate.convertAndSend(  </span><br><span class="line">                EXCHANGE_DIRECT,   </span><br><span class="line">                ROUTING_KEY,   </span><br><span class="line">                <span class="string">"Hello atguigu"</span>);  </span><br><span class="line">    }  </span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h1><span id="viii-a-sheng-chan-zhe-duan-xiao-xi-que-ren-ji-zhi">Ⅷ-A.生产者端消息确认机制</span></h1><h2><span id="yi-chuang-jian-module">一、创建module</span></h2><p><img src="/2024/09/26/mq-rabbitmq/img77-172767749837031.png" alt="images"></p>
<h2><span id="er-da-jian-huan-jing">二、搭建环境</span></h2><h3><span id="1-pei-zhi-pom">1、配置POM</span></h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-zhu-qi-dong-lei">2、主启动类</span></h3><p>没有特殊设定：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQProducerMainType</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        SpringApplication.run(RabbitMQProducerMainType.class, args);  </span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-yaml">3、YAML</span></h3><p><span style="color:blue;font-weight:bold;">注意</span>：publisher-confirm-type和publisher-returns是两个必须要增加的配置，如果没有则本节功能不生效</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.200</span><span class="number">.100</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">CORRELATED</span> <span class="comment"># 交换机的确认</span></span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">true</span> <span class="comment"># 队列的确认</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.atguigu.mq.config.MQProducerAckConfig:</span> <span class="string">info</span></span><br></pre></td></tr></tbody></table></figure>



<h2><span id="san-chuang-jian-pei-zhi-lei">三、创建配置类</span></h2><h3><span id="1-mu-biao">1、目标</span></h3><p>在这里我们为什么要创建这个配置类呢？首先，我们需要声明回调函数来接收RabbitMQ服务器返回的确认信息：</p>
<table>
<thead>
<tr>
<th>方法名</th>
<th>方法功能</th>
<th>所属接口</th>
<th>接口所属类</th>
</tr>
</thead>
<tbody><tr>
<td>confirm()</td>
<td>确认消息是否发送到交换机</td>
<td>ConfirmCallback</td>
<td>RabbitTemplate</td>
</tr>
<tr>
<td>returnedMessage()</td>
<td>确认消息是否发送到队列</td>
<td>ReturnsCallback</td>
<td>RabbitTemplate</td>
</tr>
</tbody></table>
<p>然后，就是对RabbitTemplate的功能进行增强，因为回调函数所在对象必须设置到RabbitTemplate对象中才能生效。</p>
<p>原本RabbitTemplate对象并没有生产者端消息确认的功能，要给它设置对应的组件才可以。</p>
<p>而设置对应的组件，需要调用RabbitTemplate对象下面两个方法：</p>
<table>
<thead>
<tr>
<th>设置组件调用的方法</th>
<th>所需对象类型</th>
</tr>
</thead>
<tbody><tr>
<td>setConfirmCallback()</td>
<td>ConfirmCallback接口类型</td>
</tr>
<tr>
<td>setReturnCallback()</td>
<td>ReturnCallback接口类型</td>
</tr>
</tbody></table>
<h3><span id="2-api-shuo-ming">2、API说明</span></h3><h4><span id="confirmcallback-jie-kou">①ConfirmCallback接口</span></h4><p>这是RabbitTemplate内部的一个接口，源代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A callback for publisher confirmations.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ConfirmCallback</span> {</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Confirmation callback.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> correlationData correlation data for the callback.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> ack true for ack, false for nack</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> cause An optional cause, for nack, when available, otherwise null.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(<span class="meta">@Nullable</span> CorrelationData correlationData, <span class="type">boolean</span> ack, <span class="meta">@Nullable</span> String cause)</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>生产者端发送消息之后，回调confirm()方法</p>
<ul>
<li>ack参数值为true：表示消息成功发送到了交换机</li>
<li>ack参数值为false：表示消息没有发送到交换机</li>
</ul>
<h4><span id="returncallback-jie-kou">②ReturnCallback接口</span></h4><p>同样也RabbitTemplate内部的一个接口，源代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A callback for returned messages.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ReturnsCallback</span> {</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returned message callback.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> returned the returned message and metadata.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(ReturnedMessage returned)</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><span style="color:blue;font-weight:bold;">注意</span>：接口中的returnedMessage()方法<span style="color:blue;font-weight:bold;font-size:25px;">仅</span>在消息<span style="color:blue;font-weight:bold;font-size:25px;">没有</span>发送到队列时调用</p>
<p>ReturnedMessage类中主要属性含义如下：</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>类型</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>message</td>
<td>org.springframework.amqp.core.Message</td>
<td>消息以及消息相关数据</td>
</tr>
<tr>
<td>replyCode</td>
<td>int</td>
<td>应答码，类似于HTTP响应状态码</td>
</tr>
<tr>
<td>replyText</td>
<td>String</td>
<td>应答码说明</td>
</tr>
<tr>
<td>exchange</td>
<td>String</td>
<td>交换机名称</td>
</tr>
<tr>
<td>routingKey</td>
<td>String</td>
<td>路由键名称</td>
</tr>
</tbody></table>
<h3><span id="3-pei-zhi-lei-dai-ma">3、配置类代码</span></h3><h4><span id="yao-dian-1">①要点1</span></h4><p>加@Component注解，加入IOC容器</p>
<h4><span id="yao-dian-2">②要点2</span></h4><p>配置类自身实现ConfirmCallback、ReturnCallback这两个接口，然后通过this指针把配置类的对象设置到RabbitTemplate对象中。</p>
<p>操作封装到了一个专门的void init()方法中。</p>
<p>为了保证这个void init()方法在应用启动时被调用，我们使用@PostConstruct注解来修饰这个方法。</p>
<p>关于@PostConstruct注解大家可以参照以下说明：</p>
<blockquote>
<p>@PostConstruct注解是<span style="color:blue;font-weight:bolder;">Java中的一个标准注解</span>，它用于指定在<span style="color:blue;font-weight:bolder;">对象创建之后立即执行</span>的方法。当使用依赖注入（如Spring框架）或者其他方式创建对象时，@PostConstruct注解可以确保在对象完全初始化之后，执行相应的方法。</p>
<p>使用@PostConstruct注解的方法必须满足以下条件：</p>
<ol>
<li><span style="color:blue;font-weight:bolder;">方法不能有任何参数</span>。</li>
<li><span style="color:blue;font-weight:bolder;">方法必须是非静态的</span>。</li>
<li><span style="color:blue;font-weight:bolder;">方法不能返回任何值</span>。</li>
</ol>
<p>当容器实例化一个带有@PostConstruct注解的Bean时，它会在<span style="color:blue;font-weight:bolder;">调用构造函数之后</span>，并在<span style="color:blue;font-weight:bolder;">依赖注入完成之前</span>调用被@PostConstruct注解标记的方法。这样，我们可以在该方法中进行一些初始化操作，比如读取配置文件、建立数据库连接等。</p>
</blockquote>
<h4><span id="dai-ma">③代码</span></h4><p>有了以上说明，下面我们就可以展示配置类的整体代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.ReturnedMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MQProducerAckConfig</span> <span class="keyword">implements</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback, RabbitTemplate.ReturnsCallback{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> {</span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="built_in">this</span>);</span><br><span class="line">        rabbitTemplate.setReturnsCallback(<span class="built_in">this</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> ack, String cause)</span> {</span><br><span class="line">        <span class="keyword">if</span> (ack) {</span><br><span class="line">            log.info(<span class="string">"消息发送到交换机成功！数据："</span> + correlationData);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            log.info(<span class="string">"消息发送到交换机失败！数据："</span> + correlationData + <span class="string">" 原因："</span> + cause);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(ReturnedMessage returned)</span> {</span><br><span class="line">        log.info(<span class="string">"消息主体: "</span> + <span class="keyword">new</span> <span class="title class_">String</span>(returned.getMessage().getBody()));</span><br><span class="line">        log.info(<span class="string">"应答码: "</span> + returned.getReplyCode());</span><br><span class="line">        log.info(<span class="string">"描述："</span> + returned.getReplyText());</span><br><span class="line">        log.info(<span class="string">"消息使用的交换器 exchange : "</span> + returned.getExchange());</span><br><span class="line">        log.info(<span class="string">"消息使用的路由键 routing : "</span> + returned.getRoutingKey());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="si-fa-song-xiao-xi">四、发送消息</span></h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq.test;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQTest</span> {  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_DIRECT</span> <span class="operator">=</span> <span class="string">"exchange.direct.order"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY</span> <span class="operator">=</span> <span class="string">"order"</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Autowired</span>  </span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Test</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessage</span><span class="params">()</span> {  </span><br><span class="line">        rabbitTemplate.convertAndSend(  </span><br><span class="line">                EXCHANGE_DIRECT,   </span><br><span class="line">                ROUTING_KEY,   </span><br><span class="line">                <span class="string">"Hello atguigu"</span>);  </span><br><span class="line">    }  </span><br><span class="line">  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>通过调整代码，测试如下三种情况：</p>
<ul>
<li>交换机正确、路由键正确</li>
<li>交换机正确、路由键不正确，无法发送到队列</li>
<li>交换机不正确，无法发送到交换机</li>
</ul>
<h1><span id="viii-b-bei-fen-jiao-huan-ji">Ⅷ-B.备份交换机</span></h1><h2><span id="yi-chuang-jian-bei-fen-jiao-huan-ji">一、创建备份交换机</span></h2><h3><span id="1-chuang-jian-bei-fen-jiao-huan-ji">1、创建备份交换机</span></h3><p><span style="color:blue;font-weight:bolder;">注意</span>：备份交换机<span style="color:blue;font-weight:bolder;">一定</span>要选择<span style="color:blue;font-weight:bolder;">fanout类型</span>，因为原交换机转入备份交换机时并不会指定路由键</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231203231926247-172767766143734.png" alt="image-20231203231926247"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231202183701454-172767766143733.png" alt="image-20231202183701454"></p>
<h3><span id="2-chuang-jian-bei-fen-jiao-huan-ji-yao-bang-ding-de-dui-lie">2、创建备份交换机要绑定的队列</span></h3><h4><span id="chuang-jian-dui-lie">①创建队列</span></h4><p><img src="/2024/09/26/mq-rabbitmq/image-20231202183906676-172767766143735.png" alt="image-20231202183906676"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231202183949674-172767766143737.png" alt="image-20231202183949674"></p>
<h4><span id="bang-ding-jiao-huan-ji">②绑定交换机</span></h4><p><span style="color:blue;font-weight:bolder;">注意</span>：这里是要和备份交换机绑定</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231203232801504-172767766143839.png" alt="image-20231203232801504"></p>
<h3><span id="3-zhen-dui-bei-fen-dui-lie-chuang-jian-xiao-fei-duan-jian-ting-qi">3、针对备份队列创建消费端监听器</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_DIRECT_BACKUP</span> <span class="operator">=</span> <span class="string">"exchange.direct.order.backup"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME_BACKUP</span>  <span class="operator">=</span> <span class="string">"queue.order.backup"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(value = QUEUE_NAME_BACKUP, durable = "true"),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(value = EXCHANGE_DIRECT_BACKUP),</span></span><br><span class="line"><span class="meta">        key = {""}</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processMessageBackup</span><span class="params">(String dateString,</span></span><br><span class="line"><span class="params">                                 Message message,</span></span><br><span class="line"><span class="params">                                 Channel channel)</span> {</span><br><span class="line">    log.info(<span class="string">"BackUp: "</span> + dateString);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="er-she-ding-bei-fen-guan-xi">二、设定备份关系</span></h2><h3><span id="1-yuan-jiao-huan-ji-shan-chu">1、原交换机删除</span></h3><p>·</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231202184840124-172767766143736.png" alt="image-20231202184840124"></p>
<h3><span id="2-chong-xin-chuang-jian-yuan-jiao-huan-ji">2、重新创建原交换机</span></h3><p><img src="/2024/09/26/mq-rabbitmq/image-20231202185211633-172767766143738.png" alt="image-20231202185211633"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231202185342087-172767766143840.png" alt="image-20231202185342087"></p>
<h3><span id="3-yuan-jiao-huan-ji-chong-xin-bang-ding-yuan-dui-lie">3、原交换机重新绑定原队列</span></h3><p><img src="/2024/09/26/mq-rabbitmq/image-20231202190111581-172767766143842.png" alt="image-20231202190111581"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231202185955138-172767766143841.png" alt="image-20231202185955138"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231202190036520-172767766143843.png" alt="image-20231202190036520"></p>
<h2><span id="san-ce-shi">三、测试</span></h2><ul>
<li>启动消费者端</li>
<li>发送消息，但是路由键不对，于是转入备份交换机</li>
</ul>
<h1><span id="viii-c-jiao-huan-ji-he-dui-lie-chi-jiu-hua">Ⅷ-C.交换机和队列持久化</span></h1><h2><span id="yi-ce-shi-fei-chi-jiu-hua-jiao-huan-ji-he-dui-lie">一、测试非持久化交换机和队列</span></h2><h3><span id="1-chuang-jian-fei-chi-jiu-hua-jiao-huan-ji">1、创建非持久化交换机</span></h3><p><img src="/2024/09/26/mq-rabbitmq/image-20231106192621173-172767783388990.png" alt="image-20231106192621173"></p>
<p>创建之后，可以在列表中看到：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231106192708597-172767783388989.png" alt="image-20231106192708597"></p>
<h3><span id="2-chuang-jian-fei-chi-jiu-hua-dui-lie">2、创建非持久化队列</span></h3><p><img src="/2024/09/26/mq-rabbitmq/image-20231106195216265-172767783388888.png" alt="image-20231106195216265"></p>
<p>创建之后，可以在列表中看到：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231106195132627-172767783388787.png" alt="image-20231106195132627"></p>
<h3><span id="3-bang-ding">3、绑定</span></h3><p><img src="/2024/09/26/mq-rabbitmq/image-20231106195748319-172767783388991.png" alt="image-20231106195748319"></p>
<h3><span id="4-fa-song-xiao-xi">4、发送消息</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_TRANSIENT</span> <span class="operator">=</span> <span class="string">"exchange.transient.user"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY_TRANSIENT</span> <span class="operator">=</span> <span class="string">"user"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessageTransient</span><span class="params">()</span> {</span><br><span class="line">    rabbitTemplate.convertAndSend(</span><br><span class="line">            EXCHANGE_TRANSIENT,</span><br><span class="line">            ROUTING_KEY_TRANSIENT,</span><br><span class="line">            <span class="string">"Hello atguigu user~~~"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="5-cha-kan-yi-fa-song-xiao-xi">5、查看已发送消息</span></h3><p><img src="/2024/09/26/mq-rabbitmq/image-20231106200245531-172767783388992.png" alt="image-20231106200245531"></p>
<p>结论：临时性的交换机和队列也能够接收消息，但如果RabbitMQ服务器重启之后会怎么样呢？</p>
<h3><span id="6-chong-qi-rabbitmq-fu-wu-qi">6、重启RabbitMQ服务器</span></h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart rabbitmq</span><br></pre></td></tr></tbody></table></figure>

<p>重启之后，刚才临时性的交换机和队列都没了。在交换机和队列这二者中，队列是消息存储的容器，队列没了，消息就也跟着没了。</p>
<h2><span id="er-chi-jiu-hua-de-jiao-huan-ji-he-dui-lie">二、持久化的交换机和队列</span></h2><p>我们其实不必专门创建持久化的交换机和队列，因为它们默认就是持久化的。接下来我们只需要确认一下：存放到队列中，尚未被消费端取走的消息，是否会随着RabbitMQ服务器重启而丢失？</p>
<h3><span id="1-fa-song-xiao-xi">1、发送消息</span></h3><p>运行以前的发送消息方法即可，不过要关掉消费端程序</p>
<h3><span id="2-zai-guan-li-jie-mian-cha-kan-xiao-xi">2、在管理界面查看消息</span></h3><p><img src="/2024/09/26/mq-rabbitmq/image-20231106200934265-172767783388993.png" alt="image-20231106200934265"></p>
<h3><span id="3-chong-qi-rabbitmq-fu-wu-qi">3、重启RabbitMQ服务器</span></h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart rabbitmq</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-zai-ci-cha-kan-xiao-xi">4、再次查看消息</span></h3><p>仍然还在：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231106201123268-172767783388994.png" alt="image-20231106201123268"></p>
<h2><span id="san-jie-lun">三、结论</span></h2><p>在后台管理界面创建交换机和队列时，默认就是持久化的模式。</p>
<p>此时消息也是持久化的，不需要额外设置。</p>
<h1><span id="viii-d-xiao-fei-duan-xiao-xi-que-ren">Ⅷ-D.消费端消息确认</span></h1><h2><span id="yi-ack">一、ACK</span></h2><p>ACK是acknowledge的缩写，表示已确认</p>
<h2><span id="er-mo-ren-qing-kuang">二、默认情况</span></h2><p>默认情况下，消费端取回消息后，默认会自动返回ACK确认消息，所以在前面的测试中消息被消费端消费之后，RabbitMQ得到ACK确认信息就会删除消息</p>
<p>但实际开发中，消费端根据消息队列投递的消息执行对应的业务，未必都能执行成功，如果希望能够多次重试，那么默认设定就不满足要求了</p>
<p>所以还是要修改成手动确认</p>
<h2><span id="san-chuang-jian-xiao-fei-duan-module">三、创建消费端module</span></h2><h3><span id="1-pei-zhi-pom">1、配置POM</span></h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-yaml">2、YAML</span></h3><p>增加针对监听器的设置：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.200</span><span class="number">.100</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">manual</span> <span class="comment"># 把消息确认模式改为手动确认</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-zhu-qi-dong-lei">3、主启动类</span></h3><p>没有特殊设定：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConsumerMainType</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        SpringApplication.run(RabbitMQConsumerMainType.class, args);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="si-xiao-fei-duan-jian-ting-qi">四、消费端监听器</span></h2><h3><span id="1-chuang-jian-jian-ting-qi-lei">1、创建监听器类</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyMessageListener</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_DIRECT</span> <span class="operator">=</span> <span class="string">"exchange.direct.order"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY</span> <span class="operator">=</span> <span class="string">"order"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span>  <span class="operator">=</span> <span class="string">"queue.order"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processMessage</span><span class="params">(String dataString, Message message, Channel channel)</span> {</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-zai-jie-shou-xiao-xi-de-fang-fa-shang-ying-yong-zhu-jie">2、在接收消息的方法上应用注解</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修饰监听方法</span></span><br><span class="line"><span class="meta">@RabbitListener(</span></span><br><span class="line"><span class="meta">        // 设置绑定关系</span></span><br><span class="line"><span class="meta">        bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">            // 配置队列信息：durable 设置为 true 表示队列持久化；autoDelete 设置为 false 表示关闭自动删除</span></span><br><span class="line"><span class="meta">            value = @Queue(value = QUEUE_NAME, durable = "true", autoDelete = "false"),</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">            // 配置交换机信息：durable 设置为 true 表示队列持久化；autoDelete 设置为 false 表示关闭自动删除</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(value = EXCHANGE_DIRECT, durable = "true", autoDelete = "false"),</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">            // 配置路由键信息</span></span><br><span class="line"><span class="meta">            key = {ROUTING_KEY}</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processMessage</span><span class="params">(String dataString, Message message, Channel channel)</span> {</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-jie-shou-xiao-xi-fang-fa-nei-bu-luo-ji">3、接收消息方法内部逻辑</span></h3><ul>
<li>业务处理成功：手动返回ACK信息，表示消息成功消费</li>
<li>业务处理失败：手动返回NACK信息，表示消息消费失败。此时有两种后续操作供选择：<ul>
<li>把消息重新放回消息队列，RabbitMQ会重新投递这条消息，那么消费端将重新消费这条消息——从而让业务代码再执行一遍</li>
<li>不把消息放回消息队列，返回reject信息表示拒绝，那么这条消息的处理就到此为止</li>
</ul>
</li>
</ul>
<h3><span id="4-xiang-guan-api">4、相关API</span></h3><p>先回到PPT理解“deliveryTag：交付标签机制”</p>
<p>下面我们探讨的三个方法都是来自于com.rabbitmq.client.<span style="color:blue;font-weight:bolder;">Channel</span>接口</p>
<h4><span id="basicack-fang-fa">①basicAck()方法</span></h4><ul>
<li>方法功能：给Broker返回ACK确认信息，表示消息已经在消费端成功消费，这样Broker就可以把消息删除了</li>
<li>参数列表：</li>
</ul>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>long deliveryTag</td>
<td>Broker给每一条进入队列的消息都设定一个唯一标识</td>
</tr>
<tr>
<td>boolean multiple</td>
<td>取值为true：为小于、等于deliveryTag的消息批量返回ACK信息<br>取值为false：仅为指定的deliveryTag返回ACK信息</td>
</tr>
</tbody></table>
<h4><span id="basicnack-fang-fa">②basicNack()方法</span></h4><ul>
<li>方法功能：给Broker返回NACK信息，表示消息在消费端消费失败，此时Broker的后续操作取决于参数requeue的值</li>
<li>参数列表：</li>
</ul>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>long deliveryTag</td>
<td>Broker给每一条进入队列的消息都设定一个唯一标识</td>
</tr>
<tr>
<td>boolean multiple</td>
<td>取值为true：为小于、等于deliveryTag的消息批量返回ACK信息<br>取值为false：仅为指定的deliveryTag返回ACK信息</td>
</tr>
<tr>
<td>boolean requeue</td>
<td>取值为true：Broker将消息重新放回队列，接下来会重新投递给消费端<br>取值为false：Broker将消息标记为已消费，不会放回队列</td>
</tr>
</tbody></table>
<h4><span id="basicreject-fang-fa">③basicReject()方法</span></h4><ul>
<li>方法功能：根据指定的deliveryTag，对该消息表示拒绝</li>
<li>参数列表：</li>
</ul>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>long deliveryTag</td>
<td>Broker给每一条进入队列的消息都设定一个唯一标识</td>
</tr>
<tr>
<td>boolean requeue</td>
<td>取值为true：Broker将消息重新放回队列，接下来会重新投递给消费端<br>取值为false：Broker将消息标记为已消费，不会放回队列</td>
</tr>
</tbody></table>
<ul>
<li>basicNack()和basicReject()有啥区别？<ul>
<li>basicNack()有批量操作</li>
<li>basicReject()没有批量操作</li>
</ul>
</li>
</ul>
<h3><span id="5-wan-zheng-dai-ma-shi-li">5、完整代码示例</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Exchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.QueueBinding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyMessageListener</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_DIRECT</span> <span class="operator">=</span> <span class="string">"exchange.direct.order"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY</span> <span class="operator">=</span> <span class="string">"order"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span>  <span class="operator">=</span> <span class="string">"queue.order"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修饰监听方法</span></span><br><span class="line">    <span class="meta">@RabbitListener(</span></span><br><span class="line"><span class="meta">            // 设置绑定关系</span></span><br><span class="line"><span class="meta">            bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">                // 配置队列信息：durable 设置为 true 表示队列持久化；autoDelete 设置为 false 表示关闭自动删除</span></span><br><span class="line"><span class="meta">                value = @Queue(value = QUEUE_NAME, durable = "true", autoDelete = "false"),</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">                // 配置交换机信息：durable 设置为 true 表示队列持久化；autoDelete 设置为 false 表示关闭自动删除</span></span><br><span class="line"><span class="meta">                exchange = @Exchange(value = EXCHANGE_DIRECT, durable = "true", autoDelete = "false"),</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">                // 配置路由键信息</span></span><br><span class="line"><span class="meta">                key = {ROUTING_KEY}</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processMessage</span><span class="params">(String dataString, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1、获取当前消息的 deliveryTag 值备用</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">deliveryTag</span> <span class="operator">=</span> message.getMessageProperties().getDeliveryTag();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 2、正常业务操作</span></span><br><span class="line">            log.info(<span class="string">"消费端接收到消息内容："</span> + dataString);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// System.out.println(10 / 0);</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3、给 RabbitMQ 服务器返回 ACK 确认信息</span></span><br><span class="line">            channel.basicAck(deliveryTag, <span class="literal">false</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4、获取信息，看当前消息是否曾经被投递过</span></span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">redelivered</span> <span class="operator">=</span> message.getMessageProperties().getRedelivered();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!redelivered) {</span><br><span class="line">                <span class="comment">// 5、如果没有被投递过，那就重新放回队列，重新投递，再试一次</span></span><br><span class="line">                channel.basicNack(deliveryTag, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// 6、如果已经被投递过，且这一次仍然进入了 catch 块，那么返回拒绝且不再放回队列</span></span><br><span class="line">                channel.basicReject(deliveryTag, <span class="literal">false</span>);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="wu-yao-dian-zong-jie">五、要点总结</span></h2><ul>
<li>要点1：把消息确认模式改为<span style="color:blue;font-weight:bold;">手动确认</span></li>
<li>要点2：调用Channel对象的方法返回信息<ul>
<li>ACK：Acknowledgement，表示消息处理成功</li>
<li>NACK：Negative Acknowledgement，表示消息处理失败</li>
<li>Reject：拒绝，同样表示消息处理失败</li>
</ul>
</li>
<li>要点3：后续操作<ul>
<li>requeue为true：重新放回队列，重新投递，再次尝试</li>
<li>requeue为false：不放回队列，不重新投递</li>
</ul>
</li>
<li>要点4：deliveryTag 消息的唯一标识，查找具体某一条消息的依据</li>
</ul>
<h2><span id="liu-liu-cheng-shu-li">六、流程梳理</span></h2><p><img src="/2024/09/26/mq-rabbitmq/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6-1727677890252103.png" alt="未命名文件"></p>
<h2><span id="qi-duo-luo-suo-yi-ju">七、多啰嗦一句</span></h2><p>消费端如果设定消息重新放回队列，Broker重新投递消息，那么消费端就可以再次消费消息，这是一种“重试”机制，这需要消费端代码支持“<span style="color:blue;font-weight:bold;">幂等性</span>”——这属于前置知识，不展开了。</p>
<h1><span id="ix-prefetch">Ⅸ.Prefetch</span></h1><h2><span id="yi-si-lu">一、思路</span></h2><ul>
<li>生产者发送100个消息</li>
<li>对照两种情况：<ul>
<li>消费端没有设置prefetch参数：100个消息被全部取回</li>
<li>消费端设置prefetch参数为1：100个消息慢慢取回</li>
</ul>
</li>
</ul>
<h2><span id="er-sheng-chan-zhe-duan-dai-ma">二、生产者端代码</span></h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessage</span><span class="params">()</span> {</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) {</span><br><span class="line">        rabbitTemplate.convertAndSend(</span><br><span class="line">                EXCHANGE_DIRECT,</span><br><span class="line">                ROUTING_KEY,</span><br><span class="line">                <span class="string">"Hello atguigu"</span> + i);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="san-xiao-fei-zhe-duan-dai-ma">三、消费者端代码</span></h2><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2、正常业务操作</span></span><br><span class="line">log.info(<span class="string">"消费端接收到消息内容："</span> + dataString);</span><br><span class="line"></span><br><span class="line"><span class="comment">// System.out.println(10 / 0);</span></span><br><span class="line">TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3、给 RabbitMQ 服务器返回 ACK 确认信息</span></span><br><span class="line">channel.basicAck(deliveryTag, <span class="literal">false</span>);</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="si-ce-shi">四、测试</span></h2><h3><span id="1-wei-shi-yong-prefetch">1、未使用prefetch</span></h3><ul>
<li>不要启动消费端程序，如果正在运行就把它停了</li>
<li>运行生产者端程序发送100条消息</li>
<li>查看队列中消息的情况：</li>
</ul>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231107155915253-1727678155542109.png" alt="image-20231107155915253"></p>
<ul>
<li><p>说明：</p>
<ul>
<li>Ready表示已经发送到队列的消息数量</li>
<li>Unacked表示已经发送到消费端但是消费端尚未返回ACK信息的消息数量</li>
<li>Total未被删除的消息总数</li>
</ul>
</li>
<li><p>接下来启动消费端程序，再查看队列情况：</p>
</li>
</ul>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231107160233539-1727678155542108.png" alt="image-20231107160233539"></p>
<ul>
<li>能看到消息全部被消费端取走了，正在逐个处理、确认，说明有多少消息消费端就并发处理多少</li>
</ul>
<h3><span id="2-she-ding-prefetch">2、设定prefetch</span></h3><h4><span id="yaml-pei-zhi">①YAML配置</span></h4><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.200</span><span class="number">.100</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">manual</span></span><br><span class="line">        <span class="attr">prefetch:</span> <span class="number">1</span> <span class="comment"># 设置每次最多从消息队列服务器取回多少消息</span></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="ce-shi-liu-cheng">②测试流程</span></h4><ul>
<li>停止消费端程序</li>
<li>运行生产者端程序发送100条消息</li>
<li>查看队列中消息的情况：</li>
</ul>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231107160820062-1727678155542110.png" alt="image-20231107160820062"></p>
<ul>
<li>接下来启动消费端程序，持续观察队列情况：</li>
</ul>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231107160922632-1727678155541107.png" alt="image-20231107160922632"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231107160936216-1727678155542111.png" alt="image-20231107160936216"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231107160951639-1727678155542112.png" alt="image-20231107160951639"></p>
<ul>
<li>能看到消息不是一次性全部取回的，而是有个过程</li>
</ul>
<h1><span id="x-xiao-xi-chao-shi">Ⅹ.消息超时</span></h1><h2><span id="yi-dui-lie-ceng-mian-she-zhi">一、队列层面设置</span></h2><h3><span id="1-she-zhi">1、设置</span></h3><p><img src="/2024/09/26/mq-rabbitmq/image-20231107162548129-1727678194082119.png" alt="image-20231107162548129"></p>
<p>别忘了设置绑定关系：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231107162705883-1727678194082120.png" alt="image-20231107162705883"></p>
<h3><span id="2-ce-shi">2、测试</span></h3><ul>
<li>不启动消费端程序</li>
<li>向设置了过期时间的队列中发送100条消息</li>
<li>等10秒后，看是否全部被过期删除</li>
</ul>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231107163052001-1727678194082121.png" alt="image-20231107163052001"></p>
<h2><span id="er-xiao-xi-ceng-mian-she-zhi">二、消息层面设置</span></h2><h3><span id="1-she-zhi">1、设置</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.MessagePostProcessor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessageTTL</span><span class="params">()</span> {  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 1、创建消息后置处理器对象  </span></span><br><span class="line">    <span class="type">MessagePostProcessor</span> <span class="variable">messagePostProcessor</span> <span class="operator">=</span> (Message message) -&gt; {  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 设定 TTL 时间，以毫秒为单位</span></span><br><span class="line">        message.getMessageProperties().setExpiration(<span class="string">"5000"</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    };</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 2、发送消息  </span></span><br><span class="line">    rabbitTemplate.convertAndSend(    </span><br><span class="line">            EXCHANGE_DIRECT,     </span><br><span class="line">            ROUTING_KEY,     </span><br><span class="line">            <span class="string">"Hello atguigu"</span>, messagePostProcessor);    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-cha-kan-xiao-guo">2、查看效果</span></h3><p>这次我们是发送到普通队列上：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231107163534385.png" alt="image-20231107163534385"></p>
<h1><span id="xi-si-xin">Ⅺ.死信</span></h1><h2><span id="yi-ce-shi-xiang-guan-zhun-bei">一、测试相关准备</span></h2><h3><span id="1-chuang-jian-si-xin-jiao-huan-ji-he-si-xin-dui-lie">1、创建死信交换机和死信队列</span></h3><p>常规设定即可，没有特殊设置：</p>
<ul>
<li>死信交换机：exchange.dead.letter.video</li>
<li>死信队列：queue.dead.letter.video</li>
<li>死信路由键：routing.key.dead.letter.video</li>
</ul>
<h3><span id="2-chuang-jian-zheng-chang-jiao-huan-ji-he-zheng-chang-dui-lie">2、创建正常交换机和正常队列</span></h3><p><span style="color:blue;font-weight:bolder;">注意</span>：一定要注意正常队列有诸多限定和设置，这样才能让无法处理的消息进入死信交换机</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240318165821774-1727678344074128.png" alt="image-20240318165821774"></p>
<ul>
<li>正常交换机：exchange.normal.video</li>
<li>正常队列：queue.normal.video</li>
<li>正常路由键：routing.key.normal.video</li>
</ul>
<p>全部设置完成后参照如下细节：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240318165927279-1727678344074127.png" alt="image-20240318165927279"></p>
<h3><span id="3-java-dai-ma-zhong-de-xiang-guan-chang-liang-sheng-ming">3、Java代码中的相关常量声明</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NORMAL</span> <span class="operator">=</span> <span class="string">"exchange.normal.video"</span>;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_DEAD_LETTER</span> <span class="operator">=</span> <span class="string">"exchange.dead.letter.video"</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY_NORMAL</span> <span class="operator">=</span> <span class="string">"routing.key.normal.video"</span>;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY_DEAD_LETTER</span> <span class="operator">=</span> <span class="string">"routing.key.dead.letter.video"</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NORMAL</span> <span class="operator">=</span> <span class="string">"queue.normal.video"</span>;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_DEAD_LETTER</span> <span class="operator">=</span> <span class="string">"queue.dead.letter.video"</span>;</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="er-xiao-fei-duan-ju-shou-xiao-xi">二、消费端拒收消息</span></h2><h3><span id="1-fa-song-xiao-xi-de-dai-ma">1、发送消息的代码</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessageButReject</span><span class="params">()</span> {  </span><br><span class="line">    rabbitTemplate  </span><br><span class="line">            .convertAndSend(  </span><br><span class="line">                    EXCHANGE_NORMAL,  </span><br><span class="line">                    ROUTING_KEY_NORMAL,  </span><br><span class="line">                    <span class="string">"测试死信情况1：消息被拒绝"</span>);  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-jie-shou-xiao-xi-de-dai-ma">2、接收消息的代码</span></h3><h4><span id="jian-ting-zheng-chang-dui-lie">①监听正常队列</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = {QUEUE_NORMAL})</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processMessageNormal</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="comment">// 监听正常队列，但是拒绝消息</span></span><br><span class="line">    log.info(<span class="string">"★[normal]消息接收到，但我拒绝。"</span>);</span><br><span class="line">    channel.basicReject(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="jian-ting-si-xin-dui-lie">②监听死信队列</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = {QUEUE_DEAD_LETTER})</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processMessageDead</span><span class="params">(String dataString, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException {  </span><br><span class="line">    <span class="comment">// 监听死信队列  </span></span><br><span class="line">    log.info(<span class="string">"★[dead letter]dataString = "</span> + dataString);</span><br><span class="line">    log.info(<span class="string">"★[dead letter]我是死信监听方法，我接收到了死信消息"</span>);</span><br><span class="line">    channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-zhi-xing-jie-guo">3、执行结果</span></h3><p><img src="/2024/09/26/mq-rabbitmq/image-20231107170523503-1727678344074126.png" alt="image-20231107170523503"></p>
<h2><span id="san-xiao-xi-shu-liang-chao-guo-dui-lie-rong-na-ji-xian">三、消息数量超过队列容纳极限</span></h2><h3><span id="1-fa-song-xiao-xi-de-dai-ma">1、发送消息的代码</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMultiMessage</span><span class="params">()</span> {  </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) {  </span><br><span class="line">        rabbitTemplate.convertAndSend(  </span><br><span class="line">                EXCHANGE_NORMAL,  </span><br><span class="line">                ROUTING_KEY_NORMAL,  </span><br><span class="line">                <span class="string">"测试死信情况2：消息数量超过队列的最大容量"</span> + i);  </span><br><span class="line">    }  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-jie-shou-xiao-xi-de-dai-ma">2、接收消息的代码</span></h3><p>消息接收代码不再拒绝消息：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queues = {QUEUE_NORMAL})</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processMessageNormal</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="comment">// 监听正常队列</span></span><br><span class="line">    log.info(<span class="string">"★[normal]消息接收到。"</span>);</span><br><span class="line">    channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>重启微服务使代码修改生效。</p>
<h3><span id="3-zhi-xing-xiao-guo">3、执行效果</span></h3><p>正常队列的参数如下图所示：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231107171231765-1727678344074125.png" alt="image-20231107171231765"></p>
<p>生产者发送20条消息之后，消费端死信队列接收到前10条消息：</p>
<p><img src="/2024/09/26/mq-rabbitmq/img87-1727678344074132.png" alt="images"></p>
<h2><span id="si-xiao-xi-chao-shi-wei-xiao-fei">四、消息超时未消费</span></h2><h3><span id="1-fa-song-xiao-xi-de-dai-ma">1、发送消息的代码</span></h3><p>正常发送一条消息即可，所以使用第一个例子的代码。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessageTimeout</span><span class="params">()</span> {</span><br><span class="line">    rabbitTemplate</span><br><span class="line">            .convertAndSend(</span><br><span class="line">                    EXCHANGE_NORMAL,</span><br><span class="line">                    ROUTING_KEY_NORMAL,</span><br><span class="line">                    <span class="string">"测试死信情况3：消息超时"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-zhi-xing-xiao-guo">2、执行效果</span></h3><p>队列参数生效：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231107172002297-1727678344074129.png" alt="image-20231107172002297"></p>
<p>因为没有消费端监听程序，所以消息未超时前滞留在队列中：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231107172234849-1727678344074130.png" alt="image-20231107172234849"></p>
<p>消息超时后，进入死信队列：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231107172042460-1727678344074131.png" alt="image-20231107172042460"></p>
<h1><span id="xii-yan-chi-cha-jian">Ⅻ.延迟插件</span></h1><h2><span id="yi-cha-jian-jian-jie">一、插件简介</span></h2><ul>
<li>官网地址：<a target="_blank" rel="noopener" href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange">https://github.com/rabbitmq/rabbitmq-delayed-message-exchange</a></li>
<li>延迟极限：最多两天</li>
</ul>
<h2><span id="er-cha-jian-an-zhuang">二、插件安装</span></h2><h3><span id="1-que-ding-juan-ying-she-mu-lu">1、确定卷映射目录</span></h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect rabbitmq</span><br></pre></td></tr></tbody></table></figure>



<p>运行结果：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">"Mounts"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"Type"</span><span class="punctuation">:</span> <span class="string">"volume"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Name"</span><span class="punctuation">:</span> <span class="string">"rabbitmq-plugin"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Source"</span><span class="punctuation">:</span> <span class="string">"/var/lib/docker/volumes/rabbitmq-plugin/_data"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Destination"</span><span class="punctuation">:</span> <span class="string">"/plugins"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Driver"</span><span class="punctuation">:</span> <span class="string">"local"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Mode"</span><span class="punctuation">:</span> <span class="string">"z"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"RW"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Propagation"</span><span class="punctuation">:</span> <span class="string">""</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"Type"</span><span class="punctuation">:</span> <span class="string">"volume"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Name"</span><span class="punctuation">:</span> <span class="string">"cca7bc3012f5b76bd6c47a49ca6911184f9076f5f6263b41f4b9434a7f269b11"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Source"</span><span class="punctuation">:</span> <span class="string">"/var/lib/docker/volumes/cca7bc3012f5b76bd6c47a49ca6911184f9076f5f6263b41f4b9434a7f269b11/_data"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Destination"</span><span class="punctuation">:</span> <span class="string">"/var/lib/rabbitmq"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Driver"</span><span class="punctuation">:</span> <span class="string">"local"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Mode"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"RW"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"Propagation"</span><span class="punctuation">:</span> <span class="string">""</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></tbody></table></figure>

<p>和容器内/plugins目录对应的宿主机目录是：/var/lib/docker/volumes/rabbitmq-plugin/_data</p>
<h3><span id="2-xia-zai-yan-chi-cha-jian">2、下载延迟插件</span></h3><p>官方文档说明页地址：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/community-plugins.html">https://www.rabbitmq.com/community-plugins.html</a></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231107180045135-1727678462046141.png" alt="image-20231107180045135"></p>
<p>下载插件安装文件：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases/download/v3.13.0/rabbitmq_delayed_message_exchange-3.13.0.ez</span><br><span class="line">mv rabbitmq_delayed_message_exchange-3.13.0.ez /var/lib/docker/volumes/rabbitmq-plugin/_data</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-qi-yong-cha-jian">3、启用插件</span></h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">登录进入容器内部</span></span><br><span class="line">docker exec -it rabbitmq /bin/bash</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rabbitmq-plugins命令所在目录已经配置到<span class="variable">$PATH</span>环境变量中了，可以直接调用</span></span><br><span class="line">rabbitmq-plugins enable rabbitmq_delayed_message_exchange</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">退出Docker容器</span></span><br><span class="line">exit</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启Docker容器</span></span><br><span class="line">docker restart rabbitmq</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-que-ren">4、确认</span></h3><p>确认点1：查看当前节点已启用插件的列表：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240321115348525-1727678462046142.png" alt="image-20240321115348525"></p>
<p>确认点2：如果创建新交换机时可以在type中看到x-delayed-message选项，那就说明插件安装好了</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231107181914265-1727678462047143.png" alt="image-20231107181914265"></p>
<h2><span id="san-chuang-jian-jiao-huan-ji">三、创建交换机</span></h2><p>rabbitmq_delayed_message_exchange插件在工作时要求交换机是<span style="color:blue;font-weight:bolder;">x-delayed-message</span>类型才可以，创建方式如下：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240319163915574-1727678462047144.png" alt="image-20240319163915574"></p>
<p>关于<span style="color:blue;font-weight:bolder;">x-delayed-type</span>参数的理解：</p>
<blockquote>
<p>原本指定交换机类型的地方使用了x-delayed-message这个值，那么这个交换机除了支持延迟消息之外，到底是direct、fanout、topic这些类型中的哪一个呢？</p>
<p>这里就额外使用x-delayed-type来指定交换机本身的类型</p>
</blockquote>
<h2><span id="si-dai-ma-ce-shi">四、代码测试</span></h2><h3><span id="1-sheng-chan-zhe-duan-dai-ma">1、生产者端代码</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendDelayMessage</span><span class="params">()</span> {</span><br><span class="line">    rabbitTemplate.convertAndSend(</span><br><span class="line">            EXCHANGE_DELAY,</span><br><span class="line">            ROUTING_KEY_DELAY,</span><br><span class="line">            <span class="string">"测试基于插件的延迟消息 ["</span> + <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">"hh:mm:ss"</span>).format(<span class="keyword">new</span> <span class="title class_">Date</span>()) + <span class="string">"]"</span>,</span><br><span class="line">            messageProcessor -&gt; {</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 设置延迟时间：以毫秒为单位</span></span><br><span class="line">                messageProcessor.getMessageProperties().setHeader(<span class="string">"x-delay"</span>, <span class="string">"10000"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> messageProcessor;</span><br><span class="line">            });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-xiao-fei-zhe-duan-dai-ma">2、消费者端代码</span></h3><h4><span id="qing-kuang-a-zi-yuan-yi-chuang-jian">①情况A：资源已创建</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Component</span>  </span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyDelayMessageListener</span> {</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_DELAY</span> <span class="operator">=</span> <span class="string">"queue.delay.video"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RabbitListener(queues = {QUEUE_DELAY})</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(String dataString, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException {  </span><br><span class="line">        log.info(<span class="string">"[生产者]"</span> + dataString);</span><br><span class="line">        log.info(<span class="string">"[消费者]"</span> + <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">"hh:mm:ss"</span>).format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="qing-kuang-b-zi-yuan-wei-chuang-jian">②情况B：资源未创建</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq.listener;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.*;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;  </span><br><span class="line"><span class="keyword">import</span> java.util.Date;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Component</span>  </span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyDelayMessageListener</span> {  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_DELAY</span> <span class="operator">=</span> <span class="string">"exchange.delay.video"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY_DELAY</span> <span class="operator">=</span> <span class="string">"routing.key.delay.video"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_DELAY</span> <span class="operator">=</span> <span class="string">"queue.delay.video"</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(  </span></span><br><span class="line"><span class="meta">        value = @Queue(value = QUEUE_DELAY, durable = "true", autoDelete = "false"),  </span></span><br><span class="line"><span class="meta">        exchange = @Exchange(  </span></span><br><span class="line"><span class="meta">                value = EXCHANGE_DELAY,   </span></span><br><span class="line"><span class="meta">                durable = "true",   </span></span><br><span class="line"><span class="meta">                autoDelete = "false",   </span></span><br><span class="line"><span class="meta">                type = "x-delayed-message",   </span></span><br><span class="line"><span class="meta">                arguments = @Argument(name = "x-delayed-type", value = "direct")),  </span></span><br><span class="line"><span class="meta">        key = {ROUTING_KEY_DELAY}  </span></span><br><span class="line"><span class="meta">    ))</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(String dataString, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException {  </span><br><span class="line">        log.info(<span class="string">"[生产者]"</span> + dataString);  </span><br><span class="line">        log.info(<span class="string">"[消费者]"</span> + <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">"hh:mm:ss"</span>).format(<span class="keyword">new</span> <span class="title class_">Date</span>()));  </span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);  </span><br><span class="line">    }  </span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-zhi-xing-xiao-guo">3、执行效果</span></h3><h4><span id="jiao-huan-ji-lei-xing">①交换机类型</span></h4><p><img src="/2024/09/26/mq-rabbitmq/image-20240319171359652-1727678462047145.png" alt="image-20240319171359652"></p>
<h4><span id="sheng-chan-zhe-duan-xiao-guo">②生产者端效果</span></h4><p><span style="color:blue;font-weight:bolder;">注意</span>：使用rabbitmq_delayed_message_exchange插件后，即使消息成功发送到队列上，也会导致returnedMessage()方法执行</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240321115605608-1727678462047146.png" alt="image-20240321115605608"></p>
<h4><span id="xiao-fei-zhe-duan-xiao-guo">③消费者端效果</span></h4><p><img src="/2024/09/26/mq-rabbitmq/image-20240321115646548.png" alt="image-20240321115646548"></p>
<h1><span id="xiii-shi-wu-xiao-xi-zhi-sheng-chan-zhe-duan">ⅩⅢ.事务消息之生产者端</span></h1><h2><span id="yi-ce-shi-dai-ma">一、测试代码</span></h2><h3><span id="1-yin-ru-yi-lai">1、引入依赖</span></h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-yaml-pei-zhi">2、yaml配置</span></h3><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.200</span><span class="number">.100</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-zhu-qi-dong-lei">3、主启动类</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQProducerMainType</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        SpringApplication.run(RabbitMQProducerMainType.class, args);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-xiang-guan-pei-zhi">4、相关配置</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CachingConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.transaction.RabbitTransactionManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitConfig</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RabbitTransactionManager <span class="title function_">transactionManager</span><span class="params">(CachingConnectionFactory connectionFactory)</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RabbitTransactionManager</span>(connectionFactory);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RabbitTemplate <span class="title function_">rabbitTemplate</span><span class="params">(CachingConnectionFactory connectionFactory)</span> {</span><br><span class="line">        <span class="type">RabbitTemplate</span> <span class="variable">rabbitTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>(connectionFactory);</span><br><span class="line">        rabbitTemplate.setChannelTransacted(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> rabbitTemplate;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="5-ce-shi-dai-ma">5、测试代码</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQTest</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">"exchange.tx.dragon"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY</span> <span class="operator">=</span> <span class="string">"routing.key.tx.dragon"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessageInTx</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 1、发送第一条消息</span></span><br><span class="line">        rabbitTemplate.convertAndSend(EXCHANGE_NAME, ROUTING_KEY, <span class="string">"I am a dragon(tx msg ~~~01)"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2、抛出异常</span></span><br><span class="line">        log.info(<span class="string">"do bad:"</span> + <span class="number">10</span> / <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3、发送第二条消息</span></span><br><span class="line">        rabbitTemplate.convertAndSend(EXCHANGE_NAME, ROUTING_KEY, <span class="string">"I am a dragon(tx msg ~~~02)"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="er-zhi-xing-ce-shi">二、执行测试</span></h2><h3><span id="1-wei-shi-yong-shi-wu">1、未使用事务</span></h3><p>抛出异常前的消息发送了，抛异常后的消息没有发送：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231109131321901-1727678534732156.png" alt="image-20231109131321901"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231109131413185-1727678534731154.png" alt="image-20231109131413185"></p>
<p>为了不影响后续操作，我们直接在管理界面这里把这条消息消费掉：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231109131520985-1727678534731153.png" alt="image-20231109131520985"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231109131611991-1727678534732155.png" alt="image-20231109131611991"></p>
<h3><span id="2-shi-yong-shi-wu">2、使用事务</span></h3><h4><span id="shuo-ming">①说明</span></h4><p>因为在junit中给测试方法使用@Transactional注解默认就会回滚，所以回滚操作需要使用@RollBack注解操控</p>
<h4><span id="ce-shi-ti-jiao-shi-wu-de-qing-kuang">②测试提交事务的情况</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Rollback(value = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessageInTx</span><span class="params">()</span> {</span><br><span class="line">    <span class="comment">// 1、发送第一条消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(EXCHANGE_NAME, ROUTING_KEY, <span class="string">"I am a dragon(tx msg [commit] ~~~01)"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、发送第二条消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(EXCHANGE_NAME, ROUTING_KEY, <span class="string">"I am a dragon(tx msg [commit] ~~~02)"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p><img src="/2024/09/26/mq-rabbitmq/image-20231109132025204-1727678534732157.png" alt="image-20231109132025204"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231109132112164-1727678534732158.png" alt="image-20231109132112164"></p>
<h4><span id="ce-shi-hui-gun-shi-wu-de-qing-kuang">③测试回滚事务的情况</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Rollback(value = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessageInTx</span><span class="params">()</span> {</span><br><span class="line">    <span class="comment">// 1、发送第一条消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(EXCHANGE_NAME, ROUTING_KEY, <span class="string">"I am a dragon(tx msg [rollback] ~~~01)"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、发送第二条消息</span></span><br><span class="line">    rabbitTemplate.convertAndSend(EXCHANGE_NAME, ROUTING_KEY, <span class="string">"I am a dragon(tx msg [rollback] ~~~02)"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p><img src="/2024/09/26/mq-rabbitmq/image-20231109132312914-1727678534732159.png" alt="image-20231109132312914"></p>
<h1><span id="xiv-duo-xing-dui-lie">ⅩⅣ.惰性队列</span></h1><h2><span id="yi-chuang-jian-duo-xing-dui-lie">一、创建惰性队列</span></h2><h3><span id="1-guan-wang-shuo-ming">1、官网说明</span></h3><p><img src="/2024/09/26/mq-rabbitmq/image-20231110110607266-1727678703783171.png" alt="image-20231110110607266"></p>
<p>队列可以创建为<code>默认</code>或<code>惰性</code>模式，模式指定方式是：</p>
<ul>
<li>使用队列策略（建议）</li>
<li>设置<code>queue.declare</code>参数</li>
</ul>
<p>如果策略和队列参数同时指定，那么队列参数有更高优先级。如果队列模式是在声明时通过可选参数指定的，那么只能通过删除队列再重新创建来修改。</p>
<h3><span id="2-ji-yu-ce-lue-fang-shi-she-ding">2、基于策略方式设定</span></h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">登录Docker容器</span></span><br><span class="line">docker exec -it rabbitmq /bin/bash</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">运行rabbitmqctl命令</span></span><br><span class="line">rabbitmqctl set_policy Lazy "^lazy-queue$" '{"queue-mode":"lazy"}' --apply-to queues</span><br></pre></td></tr></tbody></table></figure>

<p>命令解读：</p>
<ul>
<li><p>rabbitmqctl命令所在目录是：/opt/rabbitmq/sbin，该目录已配置到Path环境变量</p>
</li>
<li><p>set_policy是子命令，表示设置策略</p>
</li>
<li><p>Lazy是当前要设置的策略名称，是我们自己自定义的，不是系统定义的</p>
</li>
<li><p>“^lazy-queue$”是用正则表达式限定的队列名称，凡是名称符合这个正则表达式的队列都会应用这里的设置</p>
</li>
<li><p>‘{“queue-mode”:”lazy”}’是一个JSON格式的参数设置指定了队列的模式为”lazy”</p>
</li>
<li><p>–-apply-to参数指定该策略将应用于队列（queues）级别</p>
</li>
<li><p>命令执行后，所有名称符合正则表达式的队列都会应用指定策略，包括未来新创建的队列</p>
</li>
</ul>
<p>如果需要修改队列模式可以执行如下命令（不必删除队列再重建）：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl set_policy Lazy "^lazy-queue$" '{"queue-mode":"default"}' --apply-to queues</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-zai-sheng-ming-dui-lie-shi-shi-yong-can-shu-she-ding">3、在声明队列时使用参数设定</span></h3><ul>
<li>参数名称：x-queue-mode</li>
<li>可用参数值：<ul>
<li>default</li>
<li>lazy</li>
</ul>
</li>
<li>不设置就是取值为default</li>
</ul>
<p>Java代码原生API设置方式：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">args.put(<span class="string">"x-queue-mode"</span>, <span class="string">"lazy"</span>);</span><br><span class="line">channel.queueDeclare(<span class="string">"myqueue"</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, args);</span><br></pre></td></tr></tbody></table></figure>



<p>Java代码注解设置方式：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Queue(value = QUEUE_NAME, durable = "true", autoDelete = "false", arguments = {</span></span><br><span class="line"><span class="meta">	@Argument(name = "x-queue-mode", value = "lazy")</span></span><br><span class="line"><span class="meta">})</span></span><br></pre></td></tr></tbody></table></figure>



<h2><span id="er-shi-cao-yan-lian">二、实操演练</span></h2><h3><span id="1-sheng-chan-zhe-duan-dai-ma">1、生产者端代码</span></h3><h4><span id="pei-zhi-pom">①配置POM</span></h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="pei-zhi-yaml">②配置YAML</span></h4><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.200</span><span class="number">.100</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="zhu-qi-dong-lei">③主启动类</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQLazyProducer</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        SpringApplication.run(RabbitMQLazyProducer.class, args);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="fa-song-xiao-xi">④发送消息</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQTest</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_LAZY_NAME</span> <span class="operator">=</span> <span class="string">"exchange.atguigu.lazy"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_LAZY_KEY</span> <span class="operator">=</span> <span class="string">"routing.key.atguigu.lazy"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessage</span><span class="params">()</span> {</span><br><span class="line">        rabbitTemplate.convertAndSend(EXCHANGE_LAZY_NAME, ROUTING_LAZY_KEY, <span class="string">"I am a message for test lazy queue."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-xiao-fei-zhe-duan-dai-ma">2、消费者端代码</span></h3><h4><span id="pei-zhi-pom">①配置POM</span></h4><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="pei-zhi-yaml">②配置YAML</span></h4><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.200</span><span class="number">.100</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="zhu-qi-dong-lei">③主启动类</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQLazyConsumerMainType</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        SpringApplication.run(RabbitMQLazyConsumerMainType.class, args);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="jian-ting-qi">④监听器</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyLazyMessageProcessor</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_LAZY_NAME</span> <span class="operator">=</span> <span class="string">"exchange.atguigu.lazy"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_LAZY_KEY</span> <span class="operator">=</span> <span class="string">"routing.key.atguigu.lazy"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_LAZY_NAME</span> <span class="operator">=</span> <span class="string">"queue.atguigu.lazy"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(value = QUEUE_LAZY_NAME, durable = "true", autoDelete = "false", arguments = {</span></span><br><span class="line"><span class="meta">            @Argument(name = "x-queue-mode", value = "lazy")</span></span><br><span class="line"><span class="meta">        }),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(value = EXCHANGE_LAZY_NAME, durable = "true", autoDelete = "false"),</span></span><br><span class="line"><span class="meta">        key = {ROUTING_LAZY_KEY}</span></span><br><span class="line"><span class="meta">    ))</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processMessageLazy</span><span class="params">(String data, Message message, Channel channel)</span> {</span><br><span class="line">        log.info(<span class="string">"消费端接收到消息："</span> + data);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="san-ce-shi">三、测试</span></h2><ul>
<li><p>先启动消费端</p>
</li>
<li><p>基于消费端@RabbitListener注解中的配置，自动创建了队列</p>
</li>
</ul>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231110201151470-1727678703783172.png" alt="image-20231110201151470"></p>
<ul>
<li>发送消息</li>
</ul>
<h1><span id="xv-you-xian-ji-dui-lie">ⅩⅤ.优先级队列</span></h1><h2><span id="yi-chuang-jian-xiang-guan-zi-yuan">一、创建相关资源</span></h2><h3><span id="1-chuang-jian-jiao-huan-ji">1、创建交换机</span></h3><p>exchange.test.priority</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231110234945082-1727678731140176.png" alt="image-20231110234945082"></p>
<h3><span id="2-chuang-jian-dui-lie">2、创建队列</span></h3><p>queue.test.priority</p>
<p>x-max-priority</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231110235404630-1727678731140175.png" alt="image-20231110235404630"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231110235707445-1727678731140178.png" alt="image-20231110235707445"></p>
<h3><span id="3-dui-lie-bang-ding-jiao-huan-ji">3、队列绑定交换机</span></h3><p><img src="/2024/09/26/mq-rabbitmq/image-20231110235749304-1727678731140177.png" alt="image-20231110235749304"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231110235808541-1727678731140179.png" alt="image-20231110235808541"></p>
<h2><span id="er-sheng-chan-zhe-fa-song-xiao-xi">二、生产者发送消息</span></h2><h3><span id="1-pei-zhi-pom">1、配置POM</span></h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-pei-zhi-yaml">2、配置YAML</span></h3><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.200</span><span class="number">.100</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-zhu-qi-dong-lei">3、主启动类</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQPriorityProducer</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        SpringApplication.run(RabbitMQPriorityProducer.class, args);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-fa-song-xiao-xi">4、发送消息</span></h3><ul>
<li>不要启动消费者程序，让多条不同优先级的消息滞留在队列中</li>
<li>第一次发送优先级为1的消息</li>
<li>第二次发送优先级为2的消息</li>
<li>第三次发送优先级为3的消息</li>
<li>先发送的消息优先级低，后发送的消息优先级高，将来看看消费端是不是先收到优先级高的消息</li>
</ul>
<h4><span id="di-yi-ci-fa-song-you-xian-ji-wei-1-de-xiao-xi">①第一次发送优先级为1的消息</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQTest</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_PRIORITY</span> <span class="operator">=</span> <span class="string">"exchange.test.priority"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY_PRIORITY</span> <span class="operator">=</span> <span class="string">"routing.key.test.priority"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessage</span><span class="params">()</span> {</span><br><span class="line">        rabbitTemplate.convertAndSend(EXCHANGE_PRIORITY, ROUTING_KEY_PRIORITY, <span class="string">"I am a message with priority 1."</span>, message-&gt;{</span><br><span class="line">            message.getMessageProperties().setPriority(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="di-er-ci-fa-song-you-xian-ji-wei-2-de-xiao-xi">②第二次发送优先级为2的消息</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessage</span><span class="params">()</span> {</span><br><span class="line">    rabbitTemplate.convertAndSend(EXCHANGE_PRIORITY, ROUTING_KEY_PRIORITY, <span class="string">"I am a message with priority 2."</span>, message-&gt;{</span><br><span class="line">        message.getMessageProperties().setPriority(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="di-san-ci-fa-song-you-xian-ji-wei-3-de-xiao-xi">③第三次发送优先级为3的消息</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessage</span><span class="params">()</span> {</span><br><span class="line">    rabbitTemplate.convertAndSend(EXCHANGE_PRIORITY, ROUTING_KEY_PRIORITY, <span class="string">"I am a message with priority 3."</span>, message-&gt;{</span><br><span class="line">        message.getMessageProperties().setPriority(<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p><img src="/2024/09/26/mq-rabbitmq/image-20231111001627339-1727678731140180.png" alt="image-20231111001627339"></p>
<h2><span id="san-xiao-fei-duan-jie-shou-xiao-xi">三、消费端接收消息</span></h2><h3><span id="1-pei-zhi-pom">1、配置POM</span></h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-pei-zhi-yaml">2、配置YAML</span></h3><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.200</span><span class="number">.100</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">guest</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-zhu-qi-dong-lei">3、主启动类</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQPriorityConsumer</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        SpringApplication.run(RabbitMQPriorityConsumer.class, args);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-jian-ting-qi">4、监听器</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyMessageProcessor</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_PRIORITY</span> <span class="operator">=</span> <span class="string">"queue.test.priority"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = {QUEUE_PRIORITY})</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processPriorityMessage</span><span class="params">(String data, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">        log.info(data);</span><br><span class="line"></span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="5-ce-shi-xiao-guo">5、测试效果</span></h3><p>对于已经滞留服务器的消息，只要消费端一启动，就能够收到消息队列的投递，打印效果如下：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231111003358425.png" alt="image-20231111003358425"></p>
<h1><span id="xvi-ji-qun-da-jian">ⅩⅥ.集群搭建</span></h1><h2><span id="yi-an-zhuang-rabbitmq">一、安装RabbitMQ</span></h2><h3><span id="1-qian-zhi-yao-qiu">1、前置要求</span></h3><p>CentOS发行版的版本≥CentOS 8 Stream<br></p>
<p>镜像下载地址：<a target="_blank" rel="noopener" href="https://mirrors.163.com/centos/8-stream/isos/x86_64/CentOS-Stream-8-20240318.0-x86_64-dvd1.iso">https://mirrors.163.com/centos/8-stream/isos/x86_64/CentOS-Stream-8-20240318.0-x86_64-dvd1.iso</a></p>
<p>RabbitMQ安装方式官方指南：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240325212425988-1727678806423189.png" alt="image-20240325212425988"></p>
<h3><span id="2-an-zhuang-erlang-huan-jing">2、安装Erlang环境</span></h3><h4><span id="chuang-jian-yum-ku-pei-zhi-wen-jian">①创建yum库配置文件</span></h4><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/yum.repos.d/rabbitmq.repo</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="jia-ru-pei-zhi-nei-rong">②加入配置内容</span></h4><p>以下内容来自官方文档：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/docs/install-rpm">https://www.rabbitmq.com/docs/install-rpm</a></p>
<figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># In /etc/yum.repos.d/rabbitmq.repo</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment">## Zero dependency Erlang RPM</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[modern-erlang]</span></span><br><span class="line"><span class="attr">name</span>=<span class="string">modern-erlang-el8</span></span><br><span class="line"><span class="comment"># uses a Cloudsmith mirror @ yum.novemberain.com in addition to its Cloudsmith upstream.</span></span><br><span class="line"><span class="comment"># Unlike Cloudsmith, the mirror does not have any traffic quotas</span></span><br><span class="line"><span class="attr">baseurl</span>=<span class="string">https://yum1.novemberain.com/erlang/el/8/$basearch</span></span><br><span class="line">        <span class="attr">https</span>:<span class="string">//yum2.novemberain.com/erlang/el/8/$basearch</span></span><br><span class="line">        <span class="attr">https</span>:<span class="string">//dl.cloudsmith.io/public/rabbitmq/rabbitmq-erlang/rpm/el/8/$basearch</span></span><br><span class="line"><span class="attr">repo_gpgcheck</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">enabled</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">gpgkey</span>=<span class="string">https://github.com/rabbitmq/signing-keys/releases/download/3.0/cloudsmith.rabbitmq-erlang.E495BB49CC4BBE5B.key</span></span><br><span class="line"><span class="attr">gpgcheck</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">sslverify</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">sslcacert</span>=<span class="string">/etc/pki/tls/certs/ca-bundle.crt</span></span><br><span class="line"><span class="attr">metadata_expire</span>=<span class="string">300</span></span><br><span class="line"><span class="attr">pkg_gpgcheck</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">autorefresh</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">type</span>=<span class="string">rpm-md</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[modern-erlang-noarch]</span></span><br><span class="line"><span class="attr">name</span>=<span class="string">modern-erlang-el8-noarch</span></span><br><span class="line"><span class="comment"># uses a Cloudsmith mirror @ yum.novemberain.com.</span></span><br><span class="line"><span class="comment"># Unlike Cloudsmith, it does not have any traffic quotas</span></span><br><span class="line"><span class="attr">baseurl</span>=<span class="string">https://yum1.novemberain.com/erlang/el/8/noarch</span></span><br><span class="line">        <span class="attr">https</span>:<span class="string">//yum2.novemberain.com/erlang/el/8/noarch</span></span><br><span class="line">        <span class="attr">https</span>:<span class="string">//dl.cloudsmith.io/public/rabbitmq/rabbitmq-erlang/rpm/el/8/noarch</span></span><br><span class="line"><span class="attr">repo_gpgcheck</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">enabled</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">gpgkey</span>=<span class="string">https://github.com/rabbitmq/signing-keys/releases/download/3.0/cloudsmith.rabbitmq-erlang.E495BB49CC4BBE5B.key</span></span><br><span class="line">       <span class="attr">https</span>:<span class="string">//github.com/rabbitmq/signing-keys/releases/download/3.0/rabbitmq-release-signing-key.asc</span></span><br><span class="line"><span class="attr">gpgcheck</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">sslverify</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">sslcacert</span>=<span class="string">/etc/pki/tls/certs/ca-bundle.crt</span></span><br><span class="line"><span class="attr">metadata_expire</span>=<span class="string">300</span></span><br><span class="line"><span class="attr">pkg_gpgcheck</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">autorefresh</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">type</span>=<span class="string">rpm-md</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[modern-erlang-source]</span></span><br><span class="line"><span class="attr">name</span>=<span class="string">modern-erlang-el8-source</span></span><br><span class="line"><span class="comment"># uses a Cloudsmith mirror @ yum.novemberain.com.</span></span><br><span class="line"><span class="comment"># Unlike Cloudsmith, it does not have any traffic quotas</span></span><br><span class="line"><span class="attr">baseurl</span>=<span class="string">https://yum1.novemberain.com/erlang/el/8/SRPMS</span></span><br><span class="line">        <span class="attr">https</span>:<span class="string">//yum2.novemberain.com/erlang/el/8/SRPMS</span></span><br><span class="line">        <span class="attr">https</span>:<span class="string">//dl.cloudsmith.io/public/rabbitmq/rabbitmq-erlang/rpm/el/8/SRPMS</span></span><br><span class="line"><span class="attr">repo_gpgcheck</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">enabled</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">gpgkey</span>=<span class="string">https://github.com/rabbitmq/signing-keys/releases/download/3.0/cloudsmith.rabbitmq-erlang.E495BB49CC4BBE5B.key</span></span><br><span class="line">       <span class="attr">https</span>:<span class="string">//github.com/rabbitmq/signing-keys/releases/download/3.0/rabbitmq-release-signing-key.asc</span></span><br><span class="line"><span class="attr">gpgcheck</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">sslverify</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">sslcacert</span>=<span class="string">/etc/pki/tls/certs/ca-bundle.crt</span></span><br><span class="line"><span class="attr">metadata_expire</span>=<span class="string">300</span></span><br><span class="line"><span class="attr">pkg_gpgcheck</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">autorefresh</span>=<span class="string">1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment">## RabbitMQ Server</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[rabbitmq-el8]</span></span><br><span class="line"><span class="attr">name</span>=<span class="string">rabbitmq-el8</span></span><br><span class="line"><span class="attr">baseurl</span>=<span class="string">https://yum2.novemberain.com/rabbitmq/el/8/$basearch</span></span><br><span class="line">        <span class="attr">https</span>:<span class="string">//yum1.novemberain.com/rabbitmq/el/8/$basearch</span></span><br><span class="line">        <span class="attr">https</span>:<span class="string">//dl.cloudsmith.io/public/rabbitmq/rabbitmq-server/rpm/el/8/$basearch</span></span><br><span class="line"><span class="attr">repo_gpgcheck</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">enabled</span>=<span class="string">1</span></span><br><span class="line"><span class="comment"># Cloudsmith's repository key and RabbitMQ package signing key</span></span><br><span class="line"><span class="attr">gpgkey</span>=<span class="string">https://github.com/rabbitmq/signing-keys/releases/download/3.0/cloudsmith.rabbitmq-server.9F4587F226208342.key</span></span><br><span class="line">       <span class="attr">https</span>:<span class="string">//github.com/rabbitmq/signing-keys/releases/download/3.0/rabbitmq-release-signing-key.asc</span></span><br><span class="line"><span class="attr">gpgcheck</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">sslverify</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">sslcacert</span>=<span class="string">/etc/pki/tls/certs/ca-bundle.crt</span></span><br><span class="line"><span class="attr">metadata_expire</span>=<span class="string">300</span></span><br><span class="line"><span class="attr">pkg_gpgcheck</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">autorefresh</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">type</span>=<span class="string">rpm-md</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[rabbitmq-el8-noarch]</span></span><br><span class="line"><span class="attr">name</span>=<span class="string">rabbitmq-el8-noarch</span></span><br><span class="line"><span class="attr">baseurl</span>=<span class="string">https://yum2.novemberain.com/rabbitmq/el/8/noarch</span></span><br><span class="line">        <span class="attr">https</span>:<span class="string">//yum1.novemberain.com/rabbitmq/el/8/noarch</span></span><br><span class="line">        <span class="attr">https</span>:<span class="string">//dl.cloudsmith.io/public/rabbitmq/rabbitmq-server/rpm/el/8/noarch</span></span><br><span class="line"><span class="attr">repo_gpgcheck</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">enabled</span>=<span class="string">1</span></span><br><span class="line"><span class="comment"># Cloudsmith's repository key and RabbitMQ package signing key</span></span><br><span class="line"><span class="attr">gpgkey</span>=<span class="string">https://github.com/rabbitmq/signing-keys/releases/download/3.0/cloudsmith.rabbitmq-server.9F4587F226208342.key</span></span><br><span class="line">       <span class="attr">https</span>:<span class="string">//github.com/rabbitmq/signing-keys/releases/download/3.0/rabbitmq-release-signing-key.asc</span></span><br><span class="line"><span class="attr">gpgcheck</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">sslverify</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">sslcacert</span>=<span class="string">/etc/pki/tls/certs/ca-bundle.crt</span></span><br><span class="line"><span class="attr">metadata_expire</span>=<span class="string">300</span></span><br><span class="line"><span class="attr">pkg_gpgcheck</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">autorefresh</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">type</span>=<span class="string">rpm-md</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[rabbitmq-el8-source]</span></span><br><span class="line"><span class="attr">name</span>=<span class="string">rabbitmq-el8-source</span></span><br><span class="line"><span class="attr">baseurl</span>=<span class="string">https://yum2.novemberain.com/rabbitmq/el/8/SRPMS</span></span><br><span class="line">        <span class="attr">https</span>:<span class="string">//yum1.novemberain.com/rabbitmq/el/8/SRPMS</span></span><br><span class="line">        <span class="attr">https</span>:<span class="string">//dl.cloudsmith.io/public/rabbitmq/rabbitmq-server/rpm/el/8/SRPMS</span></span><br><span class="line"><span class="attr">repo_gpgcheck</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">enabled</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">gpgkey</span>=<span class="string">https://github.com/rabbitmq/signing-keys/releases/download/3.0/cloudsmith.rabbitmq-server.9F4587F226208342.key</span></span><br><span class="line"><span class="attr">gpgcheck</span>=<span class="string">0</span></span><br><span class="line"><span class="attr">sslverify</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">sslcacert</span>=<span class="string">/etc/pki/tls/certs/ca-bundle.crt</span></span><br><span class="line"><span class="attr">metadata_expire</span>=<span class="string">300</span></span><br><span class="line"><span class="attr">pkg_gpgcheck</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">autorefresh</span>=<span class="string">1</span></span><br><span class="line"><span class="attr">type</span>=<span class="string">rpm-md</span></span><br></pre></td></tr></tbody></table></figure>



<h4><span id="geng-xin-yum-ku">③更新yum库</span></h4><p>–nobest表示所需安装包即使不是最佳选择也接受</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update -y --nobest</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="zheng-shi-an-zhuang-erlang">④正式安装Erlang</span></h4><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y erlang</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-an-zhuang-rabbitmq">3、安装RabbitMQ</span></h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">导入GPG密钥</span></span><br><span class="line">rpm --import 'https://github.com/rabbitmq/signing-keys/releases/download/3.0/rabbitmq-release-signing-key.asc'</span><br><span class="line">rpm --import 'https://github.com/rabbitmq/signing-keys/releases/download/3.0/cloudsmith.rabbitmq-erlang.E495BB49CC4BBE5B.key'</span><br><span class="line">rpm --import 'https://github.com/rabbitmq/signing-keys/releases/download/3.0/cloudsmith.rabbitmq-server.9F4587F226208342.key'</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载 RPM 包</span></span><br><span class="line">wget https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.13.0/rabbitmq-server-3.13.0-1.el8.noarch.rpm</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装</span></span><br><span class="line">rpm -ivh rabbitmq-server-3.13.0-1.el8.noarch.rpm</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-rabbitmq-ji-chu-pei-zhi">4、RabbitMQ基础配置</span></h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用管理界面插件</span></span><br><span class="line">rabbitmq-plugins enable rabbitmq_management</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动 RabbitMQ 服务：</span></span><br><span class="line">systemctl start rabbitmq-server</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将 RabbitMQ 服务设置为开机自动启动</span></span><br><span class="line">systemctl enable rabbitmq-server</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">新增登录账号密码</span></span><br><span class="line">rabbitmqctl add_user atguigu 123456</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置登录账号权限</span></span><br><span class="line">rabbitmqctl set_user_tags atguigu administrator</span><br><span class="line">rabbitmqctl set_permissions -p / atguigu ".*" ".*" ".*"</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置所有稳定功能 flag 启用</span></span><br><span class="line">rabbitmqctl enable_feature_flag all</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启RabbitMQ服务生效</span></span><br><span class="line">systemctl restart rabbitmq-server</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="5-shou-wei-gong-zuo">5、收尾工作</span></h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /etc/yum.repos.d/rabbitmq.repo</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="er-ke-long-vmware-xu-ni-ji">二、克隆VMWare虚拟机</span></h2><h3><span id="1-mu-biao">1、目标</span></h3><p>通过克隆操作，一共准备三台VMWare虚拟机</p>
<table>
<thead>
<tr>
<th>集群节点名称</th>
<th>虚拟机 IP 地址</th>
</tr>
</thead>
<tbody><tr>
<td>node01</td>
<td>192.168.200.100</td>
</tr>
<tr>
<td>node02</td>
<td>192.168.200.150</td>
</tr>
<tr>
<td>node03</td>
<td>192.168.200.200</td>
</tr>
</tbody></table>
<h3><span id="2-ke-long-xu-ni-ji">2、克隆虚拟机</span></h3><p><img src="/2024/09/26/mq-rabbitmq/image-20240325161211800-1727678806423187.png" alt="image-20240325161211800"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240325161318533-1727678806423188.png" alt="image-20240325161318533"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240325161345886-1727678806423190.png" alt="image-20240325161345886"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240325161409158-1727678806423191.png" alt="image-20240325161409158"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240325161446094-1727678806423192.png" alt="image-20240325161446094"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240325161456417-1727678806423193.png" alt="image-20240325161456417"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240325161513421-1727678806424194.png" alt="image-20240325161513421"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240325161659993-1727678806424195.png" alt="image-20240325161659993"></p>
<h3><span id="3-gei-xin-ji-she-zhi-ip-di-zhi">3、给新机设置 IP 地址</span></h3><p>在CentOS 7中，可以使用<code>nmcli</code>命令行工具修改IP地址。以下是具体步骤：</p>
<ol>
<li>查看网络连接信息：</li>
</ol>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli con show</span><br></pre></td></tr></tbody></table></figure>

<ol start="2">
<li>停止指定的网络连接（将<code>&lt;connection_name&gt;</code>替换为实际的网络连接名称）：</li>
</ol>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli con down &lt;connection_name&gt;</span><br></pre></td></tr></tbody></table></figure>

<ol start="3">
<li>修改IP地址（将<code>&lt;connection_name&gt;</code>替换为实际的网络连接名称，将<code>&lt;new_ip_address&gt;</code>替换为新的IP地址，将<code>&lt;subnet_mask&gt;</code>替换为子网掩码，将<code>&lt;gateway&gt;</code>替换为网关）：</li>
</ol>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">&lt;new_ip_address&gt;/&lt;subnet_mask&gt;这里是 CIDR 表示法</span></span><br><span class="line">nmcli con mod &lt;connection_name&gt; ipv4.addresses &lt;new_ip_address&gt;/&lt;subnet_mask&gt;</span><br><span class="line">nmcli con mod &lt;connection_name&gt; ipv4.gateway &lt;gateway&gt;</span><br><span class="line">nmcli con mod &lt;connection_name&gt; ipv4.method manual</span><br></pre></td></tr></tbody></table></figure>

<ol start="4">
<li>启动网络连接：</li>
</ol>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmcli con up &lt;connection_name&gt;</span><br></pre></td></tr></tbody></table></figure>

<ol start="5">
<li>验证新的IP地址是否生效：</li>
</ol>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip addr show</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-xiu-gai-zhu-ji-ming-cheng">4、修改主机名称</span></h3><p>主机名称会被RabbitMQ作为集群中的节点名称，后面会用到，所以需要设置一下。<br></p>
<p>修改方式如下：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hostname</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="5-bao-xian-cuo-shi">5、保险措施</span></h3><p>为了在后续操作过程中，万一遇到操作失误，友情建议拍摄快照。</p>
<h2><span id="san-ji-qun-jie-dian-bi-ci-fa-xian">三、集群节点彼此发现</span></h2><h3><span id="1-node01-she-zhi">1、node01设置</span></h3><h4><span id="she-zhi-ip-di-zhi-dao-zhu-ji-ming-cheng-de-ying-she">①设置 IP 地址到主机名称的映射</span></h4><p>修改文件/etc/hosts，追加如下内容：</p>
<figure class="highlight text"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.200.100 node01</span><br><span class="line">192.168.200.150 node02</span><br><span class="line">192.168.200.200 node03</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="cha-kan-dang-qian-rabbitmq-jie-dian-de-cookie-zhi-bing-ji-lu">②查看当前RabbitMQ节点的Cookie值并记录</span></h4><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]# cat /var/lib/rabbitmq/.erlang.cookie </span><br><span class="line">NOTUPTIZIJONXDWWQPOJ</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="chong-zhi-jie-dian-ying-yong">③重置节点应用</span></h4><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl reset</span><br><span class="line">rabbitmqctl start_app</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-node02-she-zhi">2、node02设置</span></h3><h4><span id="she-zhi-ip-di-zhi-dao-zhu-ji-ming-cheng-de-ying-she">①设置 IP 地址到主机名称的映射</span></h4><p>修改文件/etc/hosts，追加如下内容：</p>
<figure class="highlight text"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.200.100 node01</span><br><span class="line">192.168.200.150 node02</span><br><span class="line">192.168.200.200 node03</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="xiu-gai-dang-qian-rabbitmq-jie-dian-de-cookie-zhi">②修改当前RabbitMQ节点的Cookie值</span></h4><p>node02和node03都改成和node01一样：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /var/lib/rabbitmq/.erlang.cookie</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="chong-zhi-jie-dian-ying-yong-bing-jia-ru-ji-qun">③重置节点应用并加入集群</span></h4><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl reset</span><br><span class="line">rabbitmqctl join_cluster rabbit@node01</span><br><span class="line">rabbitmqctl start_app</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-node03-she-zhi">3、node03设置</span></h3><h4><span id="she-zhi-ip-di-zhi-dao-zhu-ji-ming-cheng-de-ying-she">①设置 IP 地址到主机名称的映射</span></h4><p>修改文件/etc/hosts，追加如下内容：</p>
<figure class="highlight text"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">192.168.200.100 node01</span><br><span class="line">192.168.200.150 node02</span><br><span class="line">192.168.200.200 node03</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="xiu-gai-dang-qian-rabbitmq-jie-dian-de-cookie-zhi">②修改当前RabbitMQ节点的Cookie值</span></h4><p>node02和node03都改成和node01一样：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /var/lib/rabbitmq/.erlang.cookie</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="chong-zhi-jie-dian-ying-yong-bing-jia-ru-ji-qun">③重置节点应用并加入集群</span></h4><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl reset</span><br><span class="line">rabbitmqctl join_cluster rabbit@node01</span><br><span class="line">rabbitmqctl start_app</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="cha-kan-ji-qun-zhuang-tai">④查看集群状态</span></h4><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl cluster_status</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2024/09/26/mq-rabbitmq/image-20240325214047841-1727678806424196.png" alt="image-20240325214047841"></p>
<h3><span id="4-fu-lu">4、附录</span></h3><p>如有需要踢出某个节点，则按下面操作执行：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">被踢出的节点：</span></span><br><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl reset</span><br><span class="line">rabbitmqctl start_app</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">节点1</span></span><br><span class="line">rabbitmqctl forget_cluster_node rabbit@node02</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="si-fu-zai-jun-heng-management-ui">四、负载均衡：Management UI</span></h2><h3><span id="1-shuo-ming">1、说明</span></h3><ul>
<li>其实访问任何一个RabbitMQ实例的管理界面都是对集群操作，所以配置负载均衡通过统一入口访问在我们学习期间就是锦上添花</li>
<li>先给管理界面做负载均衡，然后方便我们在管理界面上创建交换机、队列等操作</li>
</ul>
<h3><span id="2-an-zhuang-haproxy">2、安装HAProxy</span></h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install -y haproxy</span><br><span class="line">haproxy -v</span><br><span class="line">systemctl start haproxy</span><br><span class="line">systemctl enable haproxy</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2024/09/26/mq-rabbitmq/image-20231205145435058-1727678806424197.png" alt="image-20231205145435058"></p>
<h3><span id="3-xiu-gai-pei-zhi-wen-jian">3、修改配置文件</span></h3><p>配置文件位置：</p>
<blockquote>
<p>/etc/haproxy/haproxy.cfg</p>
</blockquote>
<p>在配置文件末尾增加如下内容：</p>
<blockquote>
<p>frontend rabbitmq_ui_frontend<br>bind 192.168.200.100:22222<br>mode http<br>default_backend rabbitmq_ui_backend</p>
<p>backend rabbitmq_ui_backend<br>mode http<br>balance roundrobin<br>option httpchk GET /<br>server rabbitmq_ui1 192.168.200.100:15672 check<br>server rabbitmq_ui2 192.168.200.150:15672 check<br>server rabbitmq_ui3 192.168.200.200:15672 check</p>
</blockquote>
<p>设置SELinux策略，允许HAProxy拥有权限连接任意端口：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setsebool -P haproxy_connect_any=1</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>SELinux是Linux系统中的安全模块，它可以限制进程的权限以提高系统的安全性。在某些情况下，SELinux可能会阻止HAProxy绑定指定的端口，这就需要通过设置域（domain）的安全策略来解决此问题。</p>
<p>通过执行<code>setsebool -P haproxy_connect_any=1</code>命令，您已经为HAProxy设置了一个布尔值，允许HAProxy连接到任意端口。这样，HAProxy就可以成功绑定指定的socket，并正常工作。</p>
</blockquote>
<p>重启HAProxy：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart haproxy</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-ce-shi-xiao-guo">4、测试效果</span></h3><p><img src="/2024/09/26/mq-rabbitmq/image-20231205203815753-1727678806424200.png" alt="image-20231205203815753"></p>
<h2><span id="wu-fu-zai-jun-heng-he-xin-gong-neng">五、负载均衡：核心功能</span></h2><h3><span id="1-zeng-jia-pei-zhi">1、增加配置</span></h3><blockquote>
<p>frontend rabbitmq_frontend<br>bind 192.168.200.100:11111<br>mode tcp<br>default_backend rabbitmq_backend</p>
<p>backend rabbitmq_backend<br>mode tcp<br>balance roundrobin<br>server rabbitmq1 192.168.200.100:5672 check<br>server rabbitmq2 192.168.200.150:5672 check<br>server rabbitmq3 192.168.200.200:5672 check</p>
</blockquote>
<h3><span id="2-chong-qi-haproxy-fu-wu">2、重启HAProxy服务：</span></h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart haproxy</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-ce-shi">3、测试</span></h3><h4><span id="chuang-jian-zu-jian">①创建组件</span></h4><ul>
<li>交换机：exchange.cluster.test</li>
<li>队列：queue.cluster.test</li>
<li>路由键：routing.key.cluster.test</li>
</ul>
<h4><span id="chuang-jian-sheng-chan-zhe-duan-cheng-xu">②创建生产者端程序</span></h4><h5><span id="1-pei-zhi-pom">[1]配置POM</span></h5><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h5><span id="2-zhu-qi-dong-lei">[2]主启动类</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQProducerMainType</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        SpringApplication.run(RabbitMQProducerMainType.class, args);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h5><span id="3-pei-zhi-yaml">[3]配置YAML</span></h5><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.200</span><span class="number">.100</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">11111</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">atguigu</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">CORRELATED</span> <span class="comment"># 交换机的确认</span></span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">true</span> <span class="comment"># 队列的确认</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.atguigu.mq.config.MQProducerAckConfig:</span> <span class="string">info</span></span><br></pre></td></tr></tbody></table></figure>



<h5><span id="4-pei-zhi-lei">[4]配置类</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.ReturnedMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CorrelationData;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MQProducerAckConfig</span> <span class="keyword">implements</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback, RabbitTemplate.ReturnsCallback{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> {</span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="built_in">this</span>);</span><br><span class="line">        rabbitTemplate.setReturnsCallback(<span class="built_in">this</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> ack, String cause)</span> {</span><br><span class="line">        <span class="keyword">if</span> (ack) {</span><br><span class="line">            log.info(<span class="string">"消息发送到交换机成功！数据："</span> + correlationData);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            log.info(<span class="string">"消息发送到交换机失败！数据："</span> + correlationData + <span class="string">" 原因："</span> + cause);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(ReturnedMessage returned)</span> {</span><br><span class="line">        log.info(<span class="string">"消息主体: "</span> + <span class="keyword">new</span> <span class="title class_">String</span>(returned.getMessage().getBody()));</span><br><span class="line">        log.info(<span class="string">"应答码: "</span> + returned.getReplyCode());</span><br><span class="line">        log.info(<span class="string">"描述："</span> + returned.getReplyText());</span><br><span class="line">        log.info(<span class="string">"消息使用的交换器 exchange : "</span> + returned.getExchange());</span><br><span class="line">        log.info(<span class="string">"消息使用的路由键 routing : "</span> + returned.getRoutingKey());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h5><span id="5-junit-ce-shi-lei">[5] Junit测试类</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQTest</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_CLUSTER_TEST</span> <span class="operator">=</span> <span class="string">"exchange.cluster.test"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY_CLUSTER_TEST</span> <span class="operator">=</span> <span class="string">"routing.key.cluster.test"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessage</span><span class="params">()</span> {</span><br><span class="line">        rabbitTemplate.convertAndSend(EXCHANGE_CLUSTER_TEST, ROUTING_KEY_CLUSTER_TEST, <span class="string">"message test cluster~~~"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p><img src="/2024/09/26/mq-rabbitmq/image-20231205221122749-1727678806424198.png" alt="image-20231205221122749"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231205212739539-1727678806424199.png" alt="image-20231205212739539"></p>
<h4><span id="chuang-jian-xiao-fei-duan-cheng-xu">③创建消费端程序</span></h4><h5><span id="1-pei-zhi-pom">[1]配置POM</span></h5><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h5><span id="2-zhu-qi-dong-lei">[2]主启动类</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQProducerMainType</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        SpringApplication.run(RabbitMQProducerMainType.class, args);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h5><span id="3-pei-zhi-yaml">[3]配置YAML</span></h5><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.200</span><span class="number">.100</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">11111</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">atguigu</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">manual</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.atguigu.mq.listener.MyProcessor:</span> <span class="string">info</span></span><br></pre></td></tr></tbody></table></figure>



<h5><span id="4-jian-ting-qi">[4]监听器</span></h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.mq.listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyProcessor</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = {"queue.cluster.test"})</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processNormalQueueMessage</span><span class="params">(String data, Message message, Channel channel)</span> </span><br><span class="line">        <span class="keyword">throws</span> IOException {</span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">"消费端："</span> + data);</span><br><span class="line"></span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<h5><span id="5-yun-xing-xiao-guo">[5]运行效果</span></h5><p><img src="/2024/09/26/mq-rabbitmq/image-20231205223533138-1727678806424203.png" alt="image-20231205223533138"></p>
<h2><span id="liu-jing-xiang-dui-lie">六、镜像队列</span></h2><h3><span id="1-ti-chu-wen-ti">1、提出问题</span></h3><p>现在我们创建过的队列，它是属于节点1的：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231205225033524-1727678806424201.png" alt="image-20231205225033524"></p>
<p>现在我们停掉节点1的rabbit应用：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止rabbit应用</span></span><br><span class="line">rabbitmqctl stop_app</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2024/09/26/mq-rabbitmq/image-20231205225933246-1727678806424202.png" alt="image-20231205225933246"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231205231152119-1727678806424204.png" alt="image-20231205231152119"></p>
<p>再次发送消息：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231205230041784-1727678806424205.png" alt="image-20231205230041784"></p>
<p>为了后续操作，再重新启动rabbit应用</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl start_app</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-chuang-jian-ce-lue-shi-dui-lie-jing-xiang-hua">2、创建策略使队列镜像化</span></h3><p><img src="/2024/09/26/mq-rabbitmq/image-20231206002833874-1727678806424206.png" alt="image-20231206002833874"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231206002859324-1727678806424207.png" alt="image-20231206002859324"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231206003534880-1727678806424208.png" alt="image-20231206003534880"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231206003556037-1727678806425210.png" alt="image-20231206003556037"></p>
<h3><span id="3-chuang-jian-xin-de-dui-lie">3、创建新的队列</span></h3><p><span style="color:blue;font-weight:bolder;">要求</span>：队列名称必须符合策略中指定的正则表达式</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231206004507667-1727678806424209.png" alt="image-20231206004507667"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231206004549707-1727678806425211.png" alt="image-20231206004549707"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231206004648018-1727678806427214.png" alt="image-20231206004648018"></p>
<p>绑定交换机：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231206013509788-1727678806425212.png" alt="image-20231206013509788"></p>
<h3><span id="4-ce-shi">4、测试</span></h3><p>节点1关闭rabbit应用</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231206012159111-1727678806425213.png" alt="image-20231206012159111"></p>
<p>然后就发现两个镜像队列自动分布到了节点2和节点3上：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231206012307700-1727678806427216.png" alt="image-20231206012307700"></p>
<p>调整Java代码中的组件名称：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_CLUSTER_TEST</span> <span class="operator">=</span> <span class="string">"exchange.cluster.test"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY_MIRROR_TEST</span> <span class="operator">=</span> <span class="string">"routing.key.mirror.test"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_MIRROR_TEST</span> <span class="operator">=</span> <span class="string">"mirror.queue.test"</span>;</span><br></pre></td></tr></tbody></table></figure>



<p><img src="/2024/09/26/mq-rabbitmq/image-20231206015533314-1727678806427215.png" alt="image-20231206015533314"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231206015618657-1727678806427217.png" alt="image-20231206015618657"></p>
<h1><span id="xvii-zhong-cai-dui-lie">ⅩⅦ.仲裁队列</span></h1><h2><span id="yi-chuang-jian-zhong-cai-dui-lie">一、创建仲裁队列</span></h2><blockquote>
<p><span style="color:blue;font-weight:bolder;">说明</span>：鉴于仲裁队列的功能，肯定是需要在前面集群的基础上操作！</p>
</blockquote>
<h3><span id="1-chuang-jian-jiao-huan-ji">1、创建交换机</span></h3><p>和仲裁队列绑定的交换机没有特殊，我们还是创建一个direct交换机即可</p>
<p>交换机名称：exchange.quorum.test</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231206164511238-1727679068418250.png" alt="image-20231206164511238"></p>
<h3><span id="2-chuang-jian-zhong-cai-dui-lie">2、创建仲裁队列</span></h3><p>队列名称：queue.quorum.test</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231206164838398-1727679068418249.png" alt="image-20231206164838398"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231206165113573-1727679068418251.png" alt="image-20231206165113573"></p>
<h3><span id="3-bang-ding-jiao-huan-ji">3、绑定交换机</span></h3><p>路由键：routing.key.quorum.test</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20231206164951831-1727679068418252.png" alt="image-20231206164951831"></p>
<h2><span id="er-ce-shi-zhong-cai-dui-lie">二、测试仲裁队列</span></h2><h3><span id="1-chang-gui-ce-shi">1、常规测试</span></h3><p>像使用经典队列一样发送消息、消费消息</p>
<h4><span id="sheng-chan-zhe-duan">①生产者端</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_QUORUM_TEST</span> <span class="operator">=</span> <span class="string">"exchange.quorum.test"</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY_QUORUM_TEST</span> <span class="operator">=</span> <span class="string">"routing.key.quorum.test"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSendMessageToQuorum</span><span class="params">()</span> {</span><br><span class="line">    rabbitTemplate.convertAndSend(EXCHANGE_QUORUM_TEST, ROUTING_KEY_QUORUM_TEST, <span class="string">"message test quorum ~~~"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p><img src="/2024/09/26/mq-rabbitmq/image-20231206170401658-1727679068418253.png" alt="image-20231206170401658"></p>
<h4><span id="xiao-fei-zhe-duan">②消费者端</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_QUORUM_TEST</span> <span class="operator">=</span> <span class="string">"queue.quorum.test"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = {QUEUE_QUORUM_TEST})</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">quorumMessageProcess</span><span class="params">(String data, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    log.info(<span class="string">"消费端："</span> + data);</span><br><span class="line">    channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p><img src="/2024/09/26/mq-rabbitmq/image-20231206170424609-1727679068418254.png" alt="image-20231206170424609"></p>
<h3><span id="2-gao-ke-yong-ce-shi">2、高可用测试</span></h3><h4><span id="ting-zhi-mou-ge-jie-dian-de-rabbit-ying-yong">①停止某个节点的rabbit应用</span></h4><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止rabbit应用</span></span><br><span class="line">rabbitmqctl stop_app</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="cha-kan-zhong-cai-dui-lie-dui-ying-de-jie-dian-qing-kuang">②查看仲裁队列对应的节点情况</span></h4><p><img src="/2024/09/26/mq-rabbitmq/image-20231206170906222-1727679068418255.png" alt="image-20231206170906222"></p>
<h4><span id="zai-ci-fa-song-xiao-xi">③再次发送消息</span></h4><p>收发消息仍然正常</p>
<h1><span id="xviii-stream-queue">ⅩⅧ.Stream Queue</span></h1><h2><span id="yi-qi-yong-cha-jian">一、启用插件</span></h2><blockquote>
<p><span style="color:blue;font-weight:bolder;">说明</span>：只有启用了Stream插件，才能使用流式队列的完整功能</p>
</blockquote>
<p>在集群每个节点中依次执行如下操作：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用Stream插件</span></span><br><span class="line">rabbitmq-plugins enable rabbitmq_stream</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启rabbit应用</span></span><br><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl start_app</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看插件状态</span></span><br><span class="line">rabbitmq-plugins list</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2024/09/26/mq-rabbitmq/image-20240326140914228-1727679141028263.png" alt="image-20240326140914228"></p>
<h2><span id="er-fu-zai-jun-heng">二、负载均衡</span></h2><p>在文件/etc/haproxy/haproxy.cfg末尾追加：</p>
<figure class="highlight text"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">frontend rabbitmq_stream_frontend</span><br><span class="line">bind 192.168.200.100:33333</span><br><span class="line">mode tcp</span><br><span class="line">default_backend rabbitmq_stream_backend</span><br><span class="line"></span><br><span class="line">backend rabbitmq_stream_backend</span><br><span class="line">mode tcp</span><br><span class="line">balance roundrobin</span><br><span class="line">server rabbitmq1 192.168.200.100:5552 check</span><br><span class="line">server rabbitmq2 192.168.200.150:5552 check</span><br><span class="line">server rabbitmq3 192.168.200.200:5552 check</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="san-java-dai-ma">三、Java代码</span></h2><h3><span id="1-yin-ru-yi-lai">1、引入依赖</span></h3><p>Stream 专属 Java 客户端官方网址：<a target="_blank" rel="noopener" href="https://github.com/rabbitmq/rabbitmq-stream-java-client">https://github.com/rabbitmq/rabbitmq-stream-java-client</a></p>
<br>

<p>Stream 专属 Java 客户端官方文档网址：<a target="_blank" rel="noopener" href="https://rabbitmq.github.io/rabbitmq-stream-java-client/stable/htmlsingle/">https://rabbitmq.github.io/rabbitmq-stream-java-client/stable/htmlsingle/</a></p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rabbitmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>stream-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.15.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.30<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>



<h3><span id="2-chuang-jian-stream">2、创建Stream</span></h3><blockquote>
<p> <span style="color:blue;font-weight:bolder;">说明</span>：不需要创建交换机</p>
</blockquote>
<h4><span id="dai-ma-fang-shi-chuang-jian">①代码方式创建</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Environment</span> <span class="variable">environment</span> <span class="operator">=</span> Environment.builder()</span><br><span class="line">        .host(<span class="string">"192.168.200.100"</span>)</span><br><span class="line">        .port(<span class="number">33333</span>)</span><br><span class="line">        .username(<span class="string">"atguigu"</span>)</span><br><span class="line">        .password(<span class="string">"123456"</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">environment.streamCreator().stream(<span class="string">"stream.atguigu.test2"</span>).create();</span><br><span class="line"></span><br><span class="line">environment.close();</span><br></pre></td></tr></tbody></table></figure>



<h4><span id="managementui-chuang-jian">②ManagementUI创建</span></h4><p><img src="/2024/09/26/mq-rabbitmq/image-20240326143811226-1727679141028264.png" alt="image-20240326143811226"></p>
<h3><span id="3-sheng-chan-zhe-duan-cheng-xu">3、生产者端程序</span></h3><h4><span id="nei-bu-ji-zhi-shuo-ming">①内部机制说明</span></h4><h5><span id="1-guan-fang-wen-dang">[1]官方文档</span></h5><blockquote>
<p>Internally, the <code>Environment</code> will query the broker to find out about the topology of the stream and will create or re-use a connection to publish to the leader node of the stream.</p>
</blockquote>
<p>翻译：</p>
<blockquote>
<p>在内部，Environment将查询broker以了解流的拓扑结构，并将创建或重用连接以发布到流的 leader 节点。</p>
</blockquote>
<h5><span id="2-jie-xi">[2]解析</span></h5><ul>
<li>在 Environment 中封装的连接信息仅负责连接到 broker</li>
<li>Producer 在构建对象时会访问 broker 拉取集群中 Leader 的连接信息</li>
<li>将来实际访问的是集群中的 Leader 节点</li>
<li>Leader 的连接信息格式是：节点名称:端口号</li>
</ul>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240326145157472-1727679141028265.png" alt="image-20240326145157472"></p>
<h5><span id="3-pei-zhi">[3]配置</span></h5><p>为了让本机的应用程序知道 Leader 节点名称对应的 IP 地址，我们需要在本地配置 hosts 文件，建立从节点名称到 IP 地址的映射关系</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240326145508656-1727679141028266.png" alt="image-20240326145508656"></p>
<h4><span id="shi-li-dai-ma">②示例代码</span></h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Environment</span> <span class="variable">environment</span> <span class="operator">=</span> Environment.builder()</span><br><span class="line">        .host(<span class="string">"192.168.200.100"</span>)</span><br><span class="line">        .port(<span class="number">33333</span>)</span><br><span class="line">        .username(<span class="string">"atguigu"</span>)</span><br><span class="line">        .password(<span class="string">"123456"</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line"><span class="type">Producer</span> <span class="variable">producer</span> <span class="operator">=</span> environment.producerBuilder()</span><br><span class="line">        .stream(<span class="string">"stream.atguigu.test"</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line"><span class="type">byte</span>[] messagePayload = <span class="string">"hello rabbit stream"</span>.getBytes(StandardCharsets.UTF_8);</span><br><span class="line"></span><br><span class="line"><span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">producer.send(</span><br><span class="line">        producer.messageBuilder().addData(messagePayload).build(),</span><br><span class="line">        confirmationStatus -&gt; {</span><br><span class="line">            <span class="keyword">if</span> (confirmationStatus.isConfirmed()) {</span><br><span class="line">                System.out.println(<span class="string">"[生产者端]the message made it to the broker"</span>);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                System.out.println(<span class="string">"[生产者端]the message did not make it to the broker"</span>);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            countDownLatch.countDown();</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">countDownLatch.await();</span><br><span class="line"></span><br><span class="line">producer.close();</span><br><span class="line"></span><br><span class="line">environment.close();</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-xiao-fei-duan-cheng-xu">4、消费端程序</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Environment</span> <span class="variable">environment</span> <span class="operator">=</span> Environment.builder()</span><br><span class="line">        .host(<span class="string">"192.168.200.100"</span>)</span><br><span class="line">        .port(<span class="number">33333</span>)</span><br><span class="line">        .username(<span class="string">"atguigu"</span>)</span><br><span class="line">        .password(<span class="string">"123456"</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">environment.consumerBuilder()</span><br><span class="line">        .stream(<span class="string">"stream.atguigu.test"</span>)</span><br><span class="line">        .name(<span class="string">"stream.atguigu.test.consumer"</span>)</span><br><span class="line">        .autoTrackingStrategy()</span><br><span class="line">        .builder()</span><br><span class="line">        .messageHandler((offset, message) -&gt; {</span><br><span class="line">            <span class="type">byte</span>[] bodyAsBinary = message.getBodyAsBinary();</span><br><span class="line">            <span class="type">String</span> <span class="variable">messageContent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bodyAsBinary);</span><br><span class="line">            System.out.println(<span class="string">"[消费者端]messageContent = "</span> + messageContent + <span class="string">" Offset="</span> + offset.offset());</span><br><span class="line">        })</span><br><span class="line">        .build();</span><br></pre></td></tr></tbody></table></figure>



<h2><span id="si-zhi-ding-pian-yi-liang-xiao-fei">四、指定偏移量消费</span></h2><h3><span id="1-pian-yi-liang">1、偏移量</span></h3><p><img src="/2024/09/26/mq-rabbitmq/%E5%9B%BE%E7%89%871-1727679141028267.png" alt="图片1"></p>
<h3><span id="2-guan-fang-wen-dang-shuo-ming">2、官方文档说明</span></h3><blockquote>
<p>The offset is the place in the stream where the consumer starts consuming from. The possible values for the offset parameter are the following:</p>
<ul>
<li>OffsetSpecification.<span style="color:blue;font-weight:bolder;">first()</span>: starting from the first available offset. If the stream has not been <a target="_blank" rel="noopener" href="https://rabbitmq.github.io/rabbitmq-stream-java-client/stable/htmlsingle/#limiting-the-size-of-a-stream">truncated</a>, this means the beginning of the stream (offset 0).</li>
<li>OffsetSpecification.<span style="color:blue;font-weight:bolder;">last()</span>: starting from the end of the stream and returning the last <a target="_blank" rel="noopener" href="https://rabbitmq.github.io/rabbitmq-stream-java-client/stable/htmlsingle/#chunk-definition">chunk</a> of messages immediately (if the stream is not empty).</li>
<li>OffsetSpecification.<span style="color:blue;font-weight:bolder;">next()</span>: starting from the next offset to be written. Contrary to <code>OffsetSpecification.last()</code>, consuming with <code>OffsetSpecification.next()</code> will not return anything if no-one is publishing to the stream. The broker will start sending messages to the consumer when messages are published to the stream.</li>
<li>OffsetSpecification.<span style="color:blue;font-weight:bolder;">offset(offset)</span>: starting from the specified offset. 0 means consuming from the beginning of the stream (first messages). The client can also specify any number, for example the offset where it left off in a previous incarnation of the application.</li>
<li>OffsetSpecification.<span style="color:blue;font-weight:bolder;">timestamp(timestamp)</span>: starting from the messages stored after the specified timestamp. Note consumers can receive messages published a bit before the specified timestamp. Application code can filter out those messages if necessary.</li>
</ul>
</blockquote>
<h3><span id="3-zhi-ding-offset-xiao-fei">3、指定Offset消费</span></h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Environment</span> <span class="variable">environment</span> <span class="operator">=</span> Environment.builder()</span><br><span class="line">        .host(<span class="string">"192.168.200.100"</span>)</span><br><span class="line">        .port(<span class="number">33333</span>)</span><br><span class="line">        .username(<span class="string">"atguigu"</span>)</span><br><span class="line">        .password(<span class="string">"123456"</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line"><span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Consumer</span> <span class="variable">consumer</span> <span class="operator">=</span> environment.consumerBuilder()</span><br><span class="line">        .stream(<span class="string">"stream.atguigu.test"</span>)</span><br><span class="line">        .offset(OffsetSpecification.first())</span><br><span class="line">        .messageHandler((offset, message) -&gt; {</span><br><span class="line">            <span class="type">byte</span>[] bodyAsBinary = message.getBodyAsBinary();</span><br><span class="line">            <span class="type">String</span> <span class="variable">messageContent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bodyAsBinary);</span><br><span class="line">            System.out.println(<span class="string">"[消费者端]messageContent = "</span> + messageContent);</span><br><span class="line">            countDownLatch.countDown();</span><br><span class="line">        })</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">countDownLatch.await();</span><br><span class="line"></span><br><span class="line">consumer.close();</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="4-dui-bi">4、对比</span></h3><ul>
<li>autoTrackingStrategy 方式：始终监听Stream中的新消息（狗狗看家，忠于职守）</li>
<li>指定偏移量方式：针对指定偏移量的消息消费之后就停止（狗狗叼飞盘，叼回来就完）</li>
</ul>
<h1><span id="xix-federation-cha-jian">ⅩⅨ.Federation插件</span></h1><h2><span id="yi-jian-jie">一、简介</span></h2><p>Federation插件的设计目标是使RabbitMQ在不同的Broker节点之间进行消息传递而无须建立集群。</p>
<p>它可以在不同的管理域中的Broker或集群间传递消息，这些管理域可能设置了不同的用户和vhost，也可能运行在不同版本的RabbitMQ和Erlang上。Federation基于AMQP 0-9-1协议在不同的Broker之间进行通信，并且设计成能够容忍不稳定的网络连接情况。</p>
<h2><span id="er-federation-jiao-huan-ji">二、Federation交换机</span></h2><h3><span id="1-zong-ti-shuo-ming">1、总体说明</span></h3><ul>
<li>各节点操作：启用联邦插件</li>
<li>下游操作：<ul>
<li>添加上游连接端点</li>
<li>创建控制策略</li>
</ul>
</li>
</ul>
<h3><span id="2-zhun-bei-gong-zuo">2、准备工作</span></h3><p>为了执行相关测试，我们使用Docker创建两个RabbitMQ实例。</p>
<p><span style="color:blue;"><strong>特别提示</strong></span>：由于Federation机制的最大特点就是跨集群同步数据，所以这两个Docker容器中的RabbitMQ实例不加入集群！！！是两个<span style="color:blue;"><strong>独立的broker实例</strong></span>。</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">--name rabbitmq-shenzhen \</span><br><span class="line">-p 51000:5672 \</span><br><span class="line">-p 52000:15672 \</span><br><span class="line">-v rabbitmq-plugin:/plugins \</span><br><span class="line">-e RABBITMQ_DEFAULT_USER=guest \</span><br><span class="line">-e RABBITMQ_DEFAULT_PASS=123456 \</span><br><span class="line">rabbitmq:3.13-management</span><br><span class="line"></span><br><span class="line">docker run -d \</span><br><span class="line">--name rabbitmq-shanghai \</span><br><span class="line">-p 61000:5672 \</span><br><span class="line">-p 62000:15672 \</span><br><span class="line">-v rabbitmq-plugin:/plugins \</span><br><span class="line">-e RABBITMQ_DEFAULT_USER=guest \</span><br><span class="line">-e RABBITMQ_DEFAULT_PASS=123456 \</span><br><span class="line">rabbitmq:3.13-management</span><br></pre></td></tr></tbody></table></figure>



<h3><span id="3-qi-yong-lian-bang-cha-jian">3、启用联邦插件</span></h3><p>在上游、下游节点中都需要开启。</p>
<p>Docker容器中的RabbitMQ已经开启了rabbitmq_federation，还需要开启rabbitmq_federation_management</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins enable rabbitmq_federation</span><br><span class="line">rabbitmq-plugins enable rabbitmq_federation_management</span><br></pre></td></tr></tbody></table></figure>

<p>rabbitmq_federation_management插件启用后会在Management UI的Admin选项卡下看到：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240425152627455-1727679244887273.png" alt="image-20240425152627455"></p>
<h3><span id="4-tian-jia-shang-you-lian-jie-duan-dian">4、添加上游连接端点</span></h3><p>在下游节点填写上游节点的连接信息：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240425164430500-1727679244887275.png" alt="image-20240425164430500"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240425170737126-1727679244887276.png" alt="image-20240425170737126"></p>
<h3><span id="5-chuang-jian-kong-zhi-ce-lue">5、创建控制策略</span></h3><p><img src="/2024/09/26/mq-rabbitmq/image-20240425164648385-1727679244887274.png" alt="image-20240425164648385"></p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240425165531899-1727679244887279.png" alt="image-20240425165531899"></p>
<h3><span id="6-ce-shi">6、测试</span></h3><h4><span id="ce-shi-ji-hua">①测试计划</span></h4><p><span style="color:blue;"><strong>特别提示</strong></span>：</p>
<ul>
<li>普通交换机和联邦交换机名称要一致</li>
<li>交换机名称要能够和策略正则表达式匹配上</li>
<li>发送消息时，两边使用的路由键也要一致</li>
<li>队列名称不要求一致</li>
</ul>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240425170044297-1727679244887278.png" alt="image-20240425170044297"></p>
<h4><span id="chuang-jian-zu-jian">②创建组件</span></h4><table>
<thead>
<tr>
<th>所在机房</th>
<th>交换机名称</th>
<th>路由键</th>
<th>队列名称</th>
</tr>
</thead>
<tbody><tr>
<td>深圳机房（上游）</td>
<td>federated.exchange.demo</td>
<td>routing.key.demo.test</td>
<td>queue.normal.shenzhen</td>
</tr>
<tr>
<td>上海机房（下游）</td>
<td>federated.exchange.demo</td>
<td>routing.key.demo.test</td>
<td>queue.normal.shanghai</td>
</tr>
</tbody></table>
<p>创建组件后可以查看一下联邦状态，连接成功的联邦状态如下：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240425170652201-1727679244887277.png" alt="image-20240425170652201"></p>
<h4><span id="fa-bu-xiao-xi-zhi-xing-ce-shi">③发布消息执行测试</span></h4><p>在上游节点向交换机发布消息：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240425171228928-1727679244887280.png" alt="image-20240425171228928"></p>
<p>看到下游节点接收到了消息：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240425171308430-1727679244887281.png" alt="image-20240425171308430"></p>
<h2><span id="san-federation-dui-lie">三、Federation队列</span></h2><h3><span id="1-zong-ti-shuo-ming">1、总体说明</span></h3><p>Federation队列和Federation交换机的最核心区别就是：</p>
<ul>
<li>Federation Police作用在交换机上，就是Federation交换机</li>
<li>Federation Police作用在队列上，就是Federation队列</li>
</ul>
<h3><span id="2-chuang-jian-kong-zhi-ce-lue">2、创建控制策略</span></h3><p><img src="/2024/09/26/mq-rabbitmq/image-20240425171911774-1727679244887282.png" alt="image-20240425171911774"></p>
<h3><span id="3-ce-shi">3、测试</span></h3><h4><span id="ce-shi-ji-hua">①测试计划</span></h4><p>上游节点和下游节点中队列名称是相同的，只是下游队列中的节点附加了联邦策略而已</p>
<table>
<thead>
<tr>
<th>所在机房</th>
<th>交换机</th>
<th>路由键</th>
<th>队列</th>
</tr>
</thead>
<tbody><tr>
<td>深圳机房（上游）</td>
<td>exchange.normal.shenzhen</td>
<td>routing.key.normal.shenzhen</td>
<td>fed.queue.demo</td>
</tr>
<tr>
<td>上海机房（下游）</td>
<td>——</td>
<td>——</td>
<td>fed.queue.demo</td>
</tr>
</tbody></table>
<h4><span id="chuang-jian-zu-jian">②创建组件</span></h4><p>上游节点都是常规操作，此处省略。重点需要关注的是下游节点的联邦队列创建时需要指定相关参数：</p>
<p>创建组件后可以查看一下联邦状态，连接成功的联邦状态如下：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240425172528528-1727679244887283.png" alt="image-20240425172528528"></p>
<h4><span id="zhi-xing-ce-shi">③执行测试</span></h4><p>在上游节点向交换机发布消息：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240425172625339-1727679244887284.png" alt="image-20240425172625339"></p>
<p>但此时发现下游节点中联邦队列并没有接收到消息，这是为什么呢？这里就体现出了联邦队列和联邦交换机工作逻辑的区别。</p>
<p>对联邦队列来说，如果没有监听联邦队列的消费端程序，它是不会到上游去拉取消息的！</p>
<p>如果有消费端监听联邦队列，那么首先消费联邦队列自身的消息；如果联邦队列为空，<span style="color:blue;"><strong>这时候才</strong></span>会到上游队列节点中拉取消息。</p>
<p>所以现在的测试效果需要消费端程序配合才能看到：</p>
<p><img src="/2024/09/26/mq-rabbitmq/image-20240425182437573.png" alt="image-20240425182437573"></p>
<h1><span id="xx-shovel">ⅩⅩ.Shovel</span></h1><h2><span id="yi-qi-yong-shovel-cha-jian">一、启用Shovel插件</span></h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins enable rabbitmq_shovel</span><br><span class="line">rabbitmq-plugins enable rabbitmq_shovel_management</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/2024/09/26/mq-rabbitmq/image-20240425184237327-1727679389503297.png" alt="image-20240425184237327"></p>
<h2><span id="er-pei-zhi-shovel">二、配置Shovel</span></h2><p><img src="/2024/09/26/mq-rabbitmq/image-20240425185107197-1727679389503299.png" alt="image-20240425185107197"></p>
<h2><span id="san-ce-shi">三、测试</span></h2><h3><span id="1-ce-shi-ji-hua">1、测试计划</span></h3><table>
<thead>
<tr>
<th>节点</th>
<th>交换机</th>
<th>路由键</th>
<th>队列</th>
</tr>
</thead>
<tbody><tr>
<td>深圳节点</td>
<td>exchange.shovel.test</td>
<td>exchange.shovel.test</td>
<td>queue.shovel.demo.shenzhen</td>
</tr>
<tr>
<td>上海节点</td>
<td>——</td>
<td>——</td>
<td>queue.shovel.demo.shanghai</td>
</tr>
</tbody></table>
<h3><span id="2-ce-shi-xiao-guo">2、测试效果</span></h3><h4><span id="fa-bu-xiao-xi">①发布消息</span></h4><p><img src="/2024/09/26/mq-rabbitmq/image-20240425185349525-1727679389503300.png" alt="image-20240425185349525"></p>
<h4><span id="yuan-jie-dian">②源节点</span></h4><p><img src="/2024/09/26/mq-rabbitmq/image-20240425185519801-1727679389503298.png" alt="image-20240425185519801"></p>
<h4><span id="mu-biao-jie-dian">③目标节点</span></h4><p><img src="/2024/09/26/mq-rabbitmq/image-20240425185729887-1727679389503301.png" alt="image-20240425185729887"></p>

        </div>



    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        
            <script src='https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js'></script>
            <script>
                if (window.mermaid) {
                    mermaid.initialize({
                        startOnLoad: true,
                        theme: 'neural',
                    });
                }
            </script>
        
        <span>© zoe | <a href="https://hexo.io" target="_blank"></a>  <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank"></a>
              
                <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



<span class="site-uv">

👤

 <i class="busuanzi-value" id="busuanzi_value_site_uv"></i>

</span>&nbsp;





<span class="site-pv">

 | 👁️

 <i class="busuanzi-value" id="busuanzi_value_site_pv"></i>

</span>


  
               
        </span>
    </div>
</footer>

    </div>

    <!-- 搜索功能 -->
    <!-- Chic/layout.ejs -->
    <div id="u-search">
        <div class="modal">
            <div class="modal-header">
                <div class="container">
                    <form id="u-search-modal-form" class="u-search-modal-form">
                        <button type="submit" class="form-submit-btn">
                            <img src="/image/search.png" class="search-btn-img" />
                        </button>
                        <input placeholder="搜索文章。。。" class="form-input" onchange="inputChange(event)" id="modal-form-input">
                    </form>
                    <a class="modal-close">x</a>
                </div>
                <div class="search-loading">
                    <div class="search-loading-bar"></div>
                </div>
            </div>
            <div class="modal-body">
                <!-- <ul class="modal-results">
                    <li class="result-item">
                        <a class="result-item-detail">
                            <span class="title">页面配置</span>
                            <span class="content">
                                网址，例如： front-matter---layout: postdate: <b mark></b>
                                7-07-05title: [转]如何搭建基于Hexo的独立博客categories: [Dev, Hexo]tags: - Hexoauthor: name: xaoxuu avatar: https://cdn.jsdelivr.......
                            </span>
                        </a>
                    </li>
                </ul> -->
            </div>
        </div>
        <div class="modal-overlay"></div>
    </div>


</body>



</html>


